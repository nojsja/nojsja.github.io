<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="GicLYNNqJJ-XBSPlE8Pz-ZwGf2ElS_d_VRcEsQServ4"><meta name="google-site-verification" content="rn4dOdASKHwgOgBKFwN8nAB0OlnuC_pNB8qLDnMyPpc"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="baidu-site-verification" content="code-W4A0ktcwoi"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="nojsja 个人博客"><meta name="keyword" content=""><link rel="shortcut icon" href="img/favicon.ico"><link href="fonts/fontawesome-webfont.woff2?v=4.3.0" rel="preload" as="font" crossorigin><link href="https://www.google-analytics.com" rel="preconnect" crossorigin><link href="http://busuanzi.ibruce.info" rel="preconnect" crossorigin><link href="http://nojsja.gitee.io" rel="preconnect" crossorigin><title>Shadowsocks 跨平台客户端开发日记 - nojsja | Blog</title><link rel="canonical" href="https://nojsja.github.io/blogs/2021/10/04/5384287.html/"><link href="https://cdn.usebootstrap.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/dusign-light.css"><link rel="stylesheet" href="/css/github-markdown.min.css"><style>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media (max-width:767px){.markdown-body{padding:15px}}</style><link rel="stylesheet" href="/css/widget.css"><link rel="stylesheet" href="/css/fonts.googleapis.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><script>function async(e,t,a,n){var c=document.head||document.getElementsByTagName("head")[0]||document.documentElement,d=document,r=a||"script",s=d.createElement(r),l=d.getElementsByTagName(r)[0];switch(n=["async","defer"].includes(n)?n:!!n,r){case"script":s.src=e,n&&(s[n]=!0);break;case"link":s.type="text/css",s.href=e,s.rel="stylesheet";break;default:s.src=e}t&&(s.readyState?s.onreadystatechange=function(e){"loaded"!=s.readyState&&"complete"!=s.readyState||(s.onreadystatechange=null,t(null,e)())}:s.onload=function(e){t(null,e)}),l.parentNode.insertBefore(s,c.firstChild)}</script><script>function sendXMLHttpRequest(e){var t=e.url,n=(e.method||"get").toUpperCase(),s=e.callback,a=!("async"in e)||!!e.async,c=null;t&&((c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).open(n,t,a),c.onreadystatechange=function(){4===this.readyState&&(s&&s(this.responseText),c.onreadystatechange=null)},c.send(null))}</script><script>var fnDebounce=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void(t=Date.now()):t=Date.now()}},fnThrottle=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void 0:t=Date.now()}}</script><script>"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype?"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}}):sendXMLHttpRequest({url:"js/intersection-observer.js",async:!1,method:"get",callback:function(txt){eval(txt)}})</script><script src="/js/buttons.js" async defer></script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="nojsja" type="application/atom+xml">
</head><body><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(https://nojsja.gitee.io/static-resources/images/hexo/article_header/article_header.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#shadowsocks" title="shadowsocks">shadowsocks</a> <a class="tag" href="/tags/#electron" title="electron">electron</a> <a class="tag" href="/tags/#ssr" title="ssr">ssr</a></div><h1>Shadowsocks 跨平台客户端开发日记</h1><h2 class="subheading">Shadowsocks crossplatform desktop app dev diary</h2><span class="meta"><span class="post-description"><i class="fa fa-user" aria-hidden="true"></i> nojsja </span><span class="post-description"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-04</span></span><div class="blank_box"></div><span class="meta">字数：<span class="post-count">9.9k</span>丨 阅读时间：<span class="post-count">45</span> 分钟</span><div class="blank_box"></div></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">nojsja</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li><li><a href="/archive/">时间轴</a></li><li><a href="/categories/">目录</a></li><li><a href="/tags/">标签</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout((function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")}),400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><style>.table-responsive{border:none!important}</style><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container markdown-body"><p><a target="_blank" rel="noopener" href="https://nojsja.gitee.io/blogs/2021/10/04/5384287.html/">&gt;&gt;&gt; 博客原文</a></p><h2 id="Preface">Preface</h2><blockquote><p>前言</p></blockquote><p>最近闲逛 github 时看到一个 <code>shadowsocks-electron</code> 项目，该工具支持 Linux / Mac 平台，是用来连接 shadowsocks 服务器的 proxy✈️，程序员应该大多都用过，各个平台也都有适配客户端。原作者使用 <code>Typescript/Electron</code> 把功能开发了一部分就没有维护了，只支持了基本的：添加、修改、连接、删除 proxy 和设置功能，开机自启也只适配了 Mac。</p><p>由于最近在学习 <code>Typescript</code> 语言苦于没有实践机会，加之我自己的 Ubuntu20.04 操作系统运行 <code>electron-ssr</code> 老有问题(可以使用很久没有维护已经下架官方软件源的<code>Shadowsocks-QT</code>进行替代🤣)，所以萌生了自己接盘进行开发的想法，然后就是 fork -&gt; clone -&gt; dev(day after day) -&gt; compile -&gt; push 一顿操作。</p><blockquote><p>github仓库：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja/shadowsocks-electron">shadowsocks-electron</a></p></blockquote><h2 id="Prevew">Prevew</h2><blockquote><p>预览</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/main.png" alt="main"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/settings.png" alt="settings"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/add_server.png" alt="add_server"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/server_config.png" alt="server_config"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/share.png" alt="share"></p><h2 id="Contents">Contents</h2><blockquote><p>目录</p></blockquote><ul><li><a href="#preface">Preface</a></li><li><a href="#prevew">Prevew</a></li><li><a href="#contents">Contents</a></li><li><a href="#tools--technology">Tools &amp; Technology</a><ul><li><a href="#1-%E4%BD%8E%E9%85%8D%E7%BD%AE%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83react-app-rewired">1. 低配置快速启动前端开发环境：react-app-rewired</a></li><li><a href="#2-%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%94%B9%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AFnodemon">2. 代码更改自动重启：nodemon</a></li><li><a href="#3-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96redux-persistredux-persist-electron-storage">3. 数据持久化：redux-persist/redux-persist-electron-storage</a></li><li><a href="#4-%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85electron-builder">4. 项目打包：electron-builder</a></li><li><a href="#5-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86winston">5. 客户端运行日志管理：winston</a></li></ul></li><li><a href="#core-functions">Core Functions</a><ul><li><a href="#1-%E8%A7%A3%E6%9E%90-shadowsocks-%E4%B8%93%E7%94%A8%E5%8A%A0%E5%AF%86%E9%93%BE%E6%8E%A5">1. 解析 Shadowsocks 专用加密链接</a></li><li><a href="#2-%E5%B0%86%E5%B7%B2%E6%9C%89%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%9B%BE%E7%89%87%E8%BF%9B%E8%A1%8C%E5%88%86%E4%BA%AB">2. 将已有的服务器配置生成二维码图片进行分享</a></li><li><a href="#3-%E8%AF%BB%E5%8F%96%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AF%BC%E5%85%A5-shadowsocks-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE">3. 读取二维码导入 Shadowsocks 服务器配置</a></li><li><a href="#4-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B-shadowsocks-libev-%E5%BA%93%E7%9A%84%E4%BE%9D%E8%B5%96%E5%A4%84%E7%90%86">4. 多平台功能适配之 <code>shadowsocks-libev</code> 库的依赖处理</a></li><li><a href="#5-electron-%E8%B0%83%E7%94%A8-shadowsocks-libev-%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8">5. Electron 调用 <code>shadowsocks-libev</code> 库连接服务器</a></li><li><a href="#6-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy-%E5%92%8C-pac-%E6%9C%8D%E5%8A%A1">6. 多平台功能适配之设置系统 proxy 和 pac 服务</a><ul><li><a href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy">设置系统 proxy</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-pac-%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80">设置系统 pac 文件地址</a></li></ul></li><li><a href="#7-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E5%BA%94%E7%94%A8%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8">7. 多平台功能适配之应用开机自启动</a></li><li><a href="#8-%E4%BD%BF%E7%94%A8-electron-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%99%A8%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E6%95%88%E7%8E%87">8. 使用 Electron 进程管理器提高开发调试效率</a></li></ul></li><li><a href="#others">Others</a><ul><li><a href="#1-mac-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9C%9F%E6%98%AF%E9%9A%BE%E8%A3%85">1. Mac 虚拟机真是难装</a></li><li><a href="#2-mac-brew-%E5%9C%A8%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F">2. Mac brew 在国内环境的安装方式</a></li><li><a href="#3-nodejs-childprocess-%E6%89%A7%E8%A1%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91">3. Node.js child_process 执行二进制文件的一些坑</a></li><li><a href="#4-%E6%80%8E%E6%A0%B7%E4%B8%BA%E6%9C%AA%E9%80%82%E9%85%8D-typescript-%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85%E7%BC%96%E5%86%99-types-%E5%A3%B0%E6%98%8E">4. 怎样为未适配 Typescript 的第三方包编写 @types 声明</a></li><li><a href="#5-%E6%84%9F%E8%B0%A2%E4%BD%9C%E4%B8%BA-ui-%E8%AE%BE%E8%AE%A1%E5%B8%88%E7%9A%84-gf-%E5%80%BE%E6%83%85%E6%94%AF%E6%8C%81">5. 感谢作为 UI 设计师的 GF 倾情支持</a></li><li><a href="#6-%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB">6. 延伸阅读</a></li></ul></li><li><a href="#final">Final</a></li></ul><h2 id="Tools-Technology">Tools &amp; Technology</h2><blockquote><p>工具和技术</p></blockquote><p>项目基于 <code>Typescript@3.8.3</code> / <code>React@16.13.1</code> / <code>MaterialUI@4.9.8</code> / <code>Electron@13.4.0</code></p><h3 id="1-低配置快速启动前端开发环境：react-app-rewired">1. 低配置快速启动前端开发环境：react-app-rewired</h3><p>此工具可以在不 ‘eject’ 也不创建额外 react-scripts 的情况下修改 create-react-app 内置的 webpack 配置，然后你将拥有 create-react-app 的一切特性，且可以根据你的需要去配置 webpack 的 plugins, loaders 等。</p><p>通过 npm 安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install react-app-rewired --save-dev</span><br></pre></td></tr></table></figure><p>根目录中创建一个 config-overrides.js 参考官方说明进行配置，注意 npm 上也有很多基于 <code>react-app-rewired</code> 的专用插件用于分离解决各个原子化功能，可以自行探索哦。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="keyword">override</span>,</span><br><span class="line">  useBabelRc,</span><br><span class="line">  removeModuleScopePlugin,</span><br><span class="line">  babelInclude,</span><br><span class="line">  setWebpackTarget</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;customize-cra&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> rewireSvgReactLoader = <span class="built_in">require</span>(<span class="string">&#x27;react-app-rewire-svg-react-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">webpack</span>: <span class="title function_">override</span>(</span><br><span class="line">    <span class="comment">// bab el</span></span><br><span class="line">    <span class="title function_">useBabelRc</span>(),</span><br><span class="line">    <span class="comment">// svg loader</span></span><br><span class="line">    <span class="function">(<span class="params">config, env</span>) =&gt;</span> &#123;</span><br><span class="line">      config = <span class="title function_">rewireSvgReactLoader</span>(config, env);</span><br><span class="line">      <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">removeModuleScopePlugin</span>(),</span><br><span class="line">    <span class="title function_">babelInclude</span>([path.<span class="title function_">resolve</span>(<span class="string">&quot;renderer&quot;</span>)]),</span><br><span class="line">    <span class="comment">// render target</span></span><br><span class="line">    <span class="title function_">setWebpackTarget</span>(<span class="string">&quot;electron-renderer&quot;</span>)</span><br><span class="line">  ),</span><br><span class="line">  <span class="attr">paths</span>: <span class="keyword">function</span>(<span class="params">paths, env</span>) &#123;</span><br><span class="line">    paths.<span class="property">appIndexJs</span> = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;renderer/index.tsx&quot;</span>);</span><br><span class="line">    paths.<span class="property">appSrc</span> = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;renderer&quot;</span>);</span><br><span class="line">    paths.<span class="property">appTypeDeclarations</span> = path.<span class="title function_">resolve</span>(</span><br><span class="line">      __dirname,</span><br><span class="line">      <span class="string">&quot;renderer/react-app-env.d.ts&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> paths;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-代码更改自动重启：nodemon">2. 代码更改自动重启：nodemon</h3><p>在开发 Node.js 项目时我经常用它来监听文件更改然后自动重启应用，Electron 应用中也可以使用。在 <code>package.json</code> 中配置相关的字段然后让 <code>nodemon</code> 监听主进程代码并进行 Typescript 实时编译和 Electron 主进程重启。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks-electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;start:main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nodemon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nodemonConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;watch&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;main&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ignore&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;main/types/**/*&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ts,json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yarn build:main &amp;&amp; electron .&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-数据持久化：redux-persist-redux-persist-electron-storage">3. 数据持久化：redux-persist/redux-persist-electron-storage</h3><p>Electron 应用常常涉及一些持久化数据的功能，比如在 <code>shadowsocks-electron</code> 中的服务器配置读写、日志保存和用户设置保存等。之前在开发一个类似百度网盘的文件上传功能时，需要保存文件上传记录，当时选用了 <code>lowdb</code> 进行支持，它是一种 JSON 文件数据库，提供类似数据库的功能但是使用 JSON 字符串进行明文存储。这种存储方式性能自然很一般，不过已经能满足至多保存 5000 条上传记录的需求了。</p><p>由于类似 <code>lowdb</code> 这种工具只能在 Electron 主进程端进行操作，因为 UI 渲染进程和主进程的数据同步操作就会显得格外冗余。</p><p>为了简化数据交互并能达到持久化存储的目的，可以选用 <code>redux-persist</code> 为解决方案。引入之后它可以和 Redux 状态管理库无缝配合，无需手动触发多余的数据存取操作。我们只需要在前端代码中关注 Reducer 和 Action 的编写即可，所有的持久化操作都是透明不可见的。</p><p><code>redux-persist</code> 底层依赖了 Electron 渲染进程原生的 <code>remote</code> 远程调用进行实现，前端 store 中的数据最终会被存放到 Electron 进程运行路径下的某个文件里，应用开启的时候这些数据又会从文件中读取到 store中。</p><p>不过正是由于 <code>redux-persist</code> 采用了 <code>remote</code> 远程调用这种通信方式，导致我的应用不能使用最新发布的 Electron 版本，转而使用支持 <code>remote</code> API 的 13.4.0 版本。我看了一下它的 github 仓库，README 中说现在是无人维护的状态，希望有开源爱好者用爱发电自行维护。其实要去解决的话也有办法，虽然 Electron 官方移除了这个 API，但是可以通过安装第三方包 <code>@electron/remote/main</code> 来支持。</p><p>废话不多说，以下是 <code>redux-persist</code> 的简单配置使用：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* store.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Store</span> <span class="keyword">from</span> <span class="string">&#x27;electron-store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; persistReducer, persistStore, <span class="title class_">PersistConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;redux-persist&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> autoMergeLevel2 <span class="keyword">from</span> <span class="string">&quot;redux-persist/lib/stateReconciler/autoMergeLevel2&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> createElectronStorage <span class="keyword">from</span> <span class="string">&quot;redux-persist-electron-storage&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">&quot;./reducers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RootState</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../types&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">persistConfig</span>: <span class="title class_">PersistConfig</span>&lt;<span class="title class_">RootState</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">storage</span>: <span class="title function_">createElectronStorage</span>(&#123;</span><br><span class="line">    <span class="attr">electronStore</span>: <span class="keyword">new</span> <span class="title class_">Store</span>()</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">stateReconciler</span>: autoMergeLevel2,</span><br><span class="line">  <span class="attr">blacklist</span>: [<span class="string">&quot;status&quot;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> persistedReducer = <span class="title function_">persistReducer</span>(persistConfig, rootReducer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = <span class="title function_">createStore</span>(</span><br><span class="line">  persistedReducer,</span><br><span class="line">  <span class="title function_">compose</span>(</span><br><span class="line">    <span class="title function_">applyMiddleware</span>(thunk),</span><br><span class="line">    (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">devToolsExtension</span> ? (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">devToolsExtension</span>() : <span class="function">(<span class="params">f: <span class="built_in">any</span></span>) =&gt;</span> f</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> persistor = <span class="title function_">persistStore</span>(store <span class="keyword">as</span> <span class="built_in">any</span>);</span><br></pre></td></tr></table></figure><p>在 <code>App.tsx</code> 中引入：</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; store, persistor &#125; <span class="keyword">from</span> <span class="string">&quot;./redux/store&quot;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;store&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">PersistGate</span> <span class="attr">loading</span>=<span class="string">&#123;</span>&lt;<span class="attr">Loading</span> /&gt;</span>&#125; persistor=&#123;persistor&#125;&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">ThemeProvider</span> <span class="attr">theme</span>=<span class="string">&#123;darkMode</span> ? <span class="attr">darkTheme</span> <span class="attr">:</span> <span class="attr">mainTheme</span>&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.root&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">AppNav</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">main</span> <span class="attr">className</span>=<span class="string">&#123;styles.content&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.toolbar&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/home&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                      <span class="tag">&lt;<span class="name">HomePage</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    ...</span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">ThemeProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">PersistGate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-项目打包：electron-builder">4. 项目打包：electron-builder</h3><p>一直用这个打包 Electron 应用，挺好用的工具，支持多平台(win / darwin / linux…)、多架构(arm64 / amd / aarch64…)、多包格式(zip / exe / deb / AppImage / dmg / pkg / snap / nsis…)，甚至是应用打包更新等功能支持，总之非常强大。</p><p>官方文档还算是写的简介明了，这里给个 DOC 地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.electron.build/">electron-builder</a>。</p><p>可以将 <code>electron-builder</code> 的配置一同写入 <code>package.json</code> 文件中，不过为了配置分离化易于管理也可单独编写 <code>electron-builder.json</code> 配置文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">/* 基础公用配置 */</span></span><br><span class="line">  <span class="attr">&quot;appId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.robertying.shadowsocks-electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;productName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Shadowsocks Electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;asar&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;copyright&quot;</span><span class="punctuation">:</span> <span class="string">&quot;© 2020 nojsja&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 显式声明需要打包的静态文件等</span></span><br><span class="line">    <span class="string">&quot;assets/**/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;bin/**/*&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extraFiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 显式生成需要排除的文件</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bin/$&#123;os&#125;/$&#123;arch&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;!.gitignore&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">/* mac 平台打包配置 */</span></span><br><span class="line">  <span class="attr">&quot;mac&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 目标打包格式</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dmg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x64&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      ...</span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assets/icon.icns&quot;</span><span class="punctuation">,</span> <span class="comment">// 应用图标</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public.app-category.utilities&quot;</span><span class="punctuation">,</span> <span class="comment">// 应用类别</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">/* linux 平台打包配置 */</span></span><br><span class="line">  <span class="attr">&quot;linux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assets/icon.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;AppImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;deb&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Network&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;executableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks-electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deb&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 对应 linux.target.deb 的独立配置</span></span><br><span class="line">    <span class="attr">&quot;depends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 声明 deb 安装包的软件依赖</span></span><br><span class="line">      <span class="string">&quot;gconf2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;gconf-service&quot;</span><span class="punctuation">,</span> <span class="string">&quot;libnotify4&quot;</span><span class="punctuation">,</span> <span class="string">&quot;libappindicator1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;libxtst6&quot;</span><span class="punctuation">,</span> <span class="string">&quot;libnss3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;shadowsocks-libev&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;publish&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>需要<strong>额外注意</strong>：</p><ul><li><p>Mac 平台需要使用 <code>icns</code> 格式的图标，Win 需要 <code>ico</code> 格式的图标，Linux 只要 <code>png</code> 格式即可。如果格式不对或是文件损坏可能导致打包报错，这里提供一个 <code>png</code> 转 <code>icns</code> 的工具<a target="_blank" rel="noopener external nofollow noreferrer" href="https://anyconv.com/png-to-icns-converter/">网站</a>。</p></li><li><p>第一次打包时 npm 会自动下载打包环境，国内网络你懂得，很可能一直卡着下载失败，这里提供一个解决方案，其中版本号 <code>13.4.0</code> 可以改为你的项目中正在使用的版本号：</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for china developers</span></span><br><span class="line">$: npm config <span class="built_in">set</span> electron_custom_dir <span class="string">&quot;13.4.0&quot;</span></span><br><span class="line">$: npm config <span class="built_in">set</span> electron_mirror http://npm.taobao.org/mirrors/electron/</span><br></pre></td></tr></table></figure><h3 id="5-客户端运行日志管理：winston">5. 客户端运行日志管理：winston</h3><p>日志功能通常是一个完整的应用程序必不可少的模块，可以用于生产环境记录错误和告警，以便开发者在收到用户反馈时进行日志分析定位问题。</p><p>winston 被设计为一个简单且通用的日志库，支持多种传输器。 传输器本质上是日志的存储设备，每个 winston 日志实例都可以在不同级别配置多个传输器。 比如：将错误日志持久化存储在的远程位置（如数据库），另外把所有运行日志都输出到控制台或本地文件。</p><p>这里配合 winston 插件 <code>winston-daily-rotate-file</code> 使用，它可以更细粒度地进行日志分割、日志存储文件名自定义、日志压缩、过期日志清除等功能：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> winston, &#123; format &#125; <span class="keyword">from</span> <span class="string">&quot;winston&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> open <span class="keyword">from</span> <span class="string">&quot;open&quot;</span>;</span><br><span class="line"><span class="keyword">import</span>  <span class="title class_">DailyRotateFile</span> <span class="keyword">from</span> <span class="string">&#x27;winston-daily-rotate-file&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; combine, simple, colorize &#125; = format;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logDir = app.<span class="title function_">getPath</span>(<span class="string">&quot;logs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timestamp = <span class="title function_">format</span>(<span class="function">(<span class="params">info, opts</span>) =&gt;</span> &#123;</span><br><span class="line">  info.<span class="property">message</span> = <span class="string">`<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString()&#125;</span> - <span class="subst">$&#123;info.message&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> info;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">dailyTransport</span>: <span class="title class_">DailyRotateFile</span> = <span class="keyword">new</span> <span class="title class_">DailyRotateFile</span>(&#123;</span><br><span class="line">  <span class="attr">filename</span>: path.<span class="title function_">resolve</span>(logDir, <span class="string">&#x27;shadowsocks-electron-%DATE%.log&#x27;</span>), <span class="comment">// 日志文件名格式</span></span><br><span class="line">  <span class="attr">datePattern</span>: <span class="string">&#x27;YYYY-MM-DD&#x27;</span>, <span class="comment">// 日期格式</span></span><br><span class="line">  <span class="attr">zippedArchive</span>: <span class="literal">false</span>, <span class="comment">// 启用压缩</span></span><br><span class="line">  <span class="attr">maxSize</span>: <span class="string">&#x27;10m&#x27;</span>, <span class="comment">// 单个日志文件最大容量</span></span><br><span class="line">  <span class="attr">maxFiles</span>: <span class="string">&#x27;30d&#x27;</span> <span class="comment">// 日志过期时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = winston.<span class="title function_">createLogger</span>(&#123;</span><br><span class="line">  <span class="attr">level</span>: <span class="string">&quot;info&quot;</span>,</span><br><span class="line">  <span class="attr">transports</span>: [</span><br><span class="line">    dailyTransport</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>) &#123;</span><br><span class="line">  logger.<span class="title function_">add</span>(</span><br><span class="line">    <span class="keyword">new</span> winston.<span class="property">transports</span>.<span class="title class_">Console</span>(&#123;</span><br><span class="line">      <span class="attr">format</span>: <span class="title function_">combine</span>(<span class="title function_">colorize</span>(), <span class="title function_">timestamp</span>(), <span class="title function_">simple</span>())</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> logger;</span><br></pre></td></tr></table></figure><h2 id="Core-Functions">Core Functions</h2><blockquote><p>关键功能解析</p></blockquote><h3 id="1-解析-Shadowsocks-专用加密链接">1. 解析 Shadowsocks 专用加密链接</h3><p>客户端支持将 shadowsocks 加密链接如<code>ss://cmM0LW1kNTp4TTBtY09kOVFubjVAY240Lm15ZGFya2Nsb3VkLmluZm86MTI2MDA</code> 解析为服务器配置。解析 ss 链接其实并不复杂，ss 后面的字符串都是 <code>base64</code> 编码，使用 Base64 解码成正常格式 <code>ss://method:password@server:port</code> 之后使用正则匹配提取各个关键字段即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Base64</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;js-base64&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="title function_">parseSSContent</span>(<span class="attr">uri</span>: string): <span class="title class_">Proxy</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// Try legacy</span></span><br><span class="line">    <span class="keyword">let</span> legacyRegex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`^(<span class="subst">$&#123;ProxyURI.base64Pattern&#125;</span>)(#(.+))?$`</span>, <span class="string">&quot;gi&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> match = legacyRegex.<span class="title function_">exec</span>(uri)</span><br><span class="line">    <span class="keyword">if</span> (match &amp;&amp; match.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">ProxyScheme</span>.<span class="property">SS</span>);</span><br><span class="line">      proxy.<span class="property">type</span> = <span class="string">&#x27;ss&#x27;</span>;</span><br><span class="line">      proxy.<span class="property">remark</span> = match[<span class="number">3</span>];</span><br><span class="line">      <span class="keyword">let</span> core = <span class="title class_">Base64</span>.<span class="title function_">decode</span>(match[<span class="number">1</span>]);</span><br><span class="line">      <span class="comment">// No &quot;$&quot; at the end is due to ShadowsocksX-NG compatibility issue</span></span><br><span class="line">      <span class="comment">// ShadowsocksX-NG will append a remark like &quot;?remark=xxxxx&quot;</span></span><br><span class="line">      <span class="keyword">let</span> mainRegex = <span class="regexp">/^(.+?):(.+)@(.+?):(\d+)/gi</span></span><br><span class="line">      <span class="keyword">let</span> coreComps = mainRegex.<span class="title function_">exec</span>(core);</span><br><span class="line">      <span class="keyword">if</span> (coreComps &amp;&amp; coreComps[<span class="number">1</span>] &amp;&amp; coreComps[<span class="number">2</span>] &amp;&amp; coreComps[<span class="number">3</span>] &amp;&amp; coreComps[<span class="number">4</span>]) &#123;</span><br><span class="line">        proxy.<span class="property">host</span> = coreComps[<span class="number">3</span>];</span><br><span class="line">        proxy.<span class="property">port</span> = <span class="title class_">Number</span>(coreComps[<span class="number">4</span>]);</span><br><span class="line">        proxy.<span class="property">authscheme</span> = coreComps[<span class="number">1</span>].<span class="title function_">toLowerCase</span>();</span><br><span class="line">        proxy.<span class="property">password</span> = coreComps[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-将已有的服务器配置生成二维码图片进行分享">2. 将已有的服务器配置生成二维码图片进行分享</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/share.png" alt="share"></p><p>上一步解析成功后可以得到服务器配置，实例数据如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cn2.mydarkcloud.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;serverHost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cn2.mydarkcloud.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;serverPort&quot;</span><span class="punctuation">:</span> <span class="number">12322</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xM0mcOd9Qn33&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;encryptMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rc4-md5&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ss&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>要做二维码分享功能的话需要将配置信息组装成正常格式 <code>ss://method:password@server:port</code>，然后编码成 <code>Base64</code> 加密链接：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Base64</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;js-base64&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="title function_">generateSS</span>(<span class="attr">host</span>: string, <span class="attr">port</span>: number, <span class="attr">method</span>: string, <span class="attr">password</span>: string, remark?: string, <span class="attr">isSIP002</span>: boolean = <span class="literal">true</span>): string &#123;</span><br><span class="line">    <span class="keyword">let</span> rawURI = method.<span class="title function_">toLowerCase</span>() + <span class="string">&quot;:&quot;</span> + password + <span class="string">&quot;@&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">    <span class="keyword">let</span> uri = <span class="title class_">ProxyScheme</span>.<span class="property">SS</span> + <span class="title class_">Base64</span>.<span class="title function_">encode</span>(rawURI);</span><br><span class="line">    <span class="keyword">if</span> (remark) &#123;</span><br><span class="line">      uri += <span class="string">&quot;#&quot;</span> + remark;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>得到加密链接后，使用 <code>qrcode</code> 库将其输出成前端可直接展示的 <code>dataURL</code> 数据格式，然后界面上直接赋值给 <code>img</code> 标签的 <code>src</code> 属性即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">QRCode</span> <span class="keyword">from</span> <span class="string">&#x27;qrcode&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> result = &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">result</span>: &#123;</span><br><span class="line">    <span class="attr">dataUrl</span>: <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    msg: &#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">QRCode</span>.<span class="title function_">toDataURL</span>(url, <span class="keyword">function</span> (<span class="params">err, _dataURL</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    result.<span class="property">result</span>.<span class="property">dataUrl</span> = _dataURL;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result.<span class="property">code</span> = <span class="number">500</span>;</span><br><span class="line">    result.<span class="property">result</span>.<span class="property">msg</span> = err.<span class="title function_">toString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">resolve</span>(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-读取二维码导入-Shadowsocks-服务器配置">3. 读取二维码导入 Shadowsocks 服务器配置</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/add_server.gif" alt="add_server"></p><p>扫描屏幕二维码导入功能实现起来稍复杂些。</p><p>第一步：先使用 Electron 自带 <code>desktopCapture</code> API 获取桌面截图文件：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; desktopCapturer &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/* 获取桌面截图 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getScreenCapturedResources</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Electron</span>.<span class="property">DesktopCapturerSource</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> desktopCapturer.<span class="title function_">getSources</span>(&#123;</span><br><span class="line">    <span class="attr">types</span>: [<span class="string">&#x27;screen&#x27;</span>],</span><br><span class="line">    <span class="attr">thumbnailSize</span>: &#123;</span><br><span class="line">      <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">width</span> * <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span>,</span><br><span class="line">      <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">height</span> * <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二步：将截图数据转换成 bitmap 位图格式(存储像素点颜色和透明度的数组[r,g,b,a …])，然后使用 <code>jsqr</code> 库解析位图中的二维码信息，最终会得到二维码位于屏幕中的坐标、宽度和文本值等信息：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 解析位图数据 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getQrCodeFromScreenResources = (callback?: <span class="function">(<span class="params">added: <span class="built_in">boolean</span></span>) =&gt;</span> <span class="built_in">void</span>): <span class="title class_">ThunkAction</span>&lt;<span class="built_in">void</span>, <span class="title class_">RootState</span>, <span class="built_in">unknown</span>, <span class="title class_">AnyAction</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">getScreenCapturedResources</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">resources: Electron.DesktopCapturerSource[]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 可能有多个屏幕资源</span></span><br><span class="line">      <span class="keyword">if</span> (resources &amp;&amp; resources.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">qrs</span>: &#123;<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>, <span class="attr">width</span>: <span class="built_in">number</span>, <span class="attr">height</span>: <span class="built_in">number</span>&#125;[] = [];</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">values</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line">        resources.<span class="title function_">forEach</span>(<span class="function"><span class="params">resource</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> size = resource.<span class="property">thumbnail</span>.<span class="title function_">getSize</span>();</span><br><span class="line">          <span class="comment">// 使用截图的位图信息进行解析</span></span><br><span class="line">          <span class="keyword">const</span> capturedData = <span class="title function_">jsqr</span>(resource.<span class="property">thumbnail</span>.<span class="title function_">getBitmap</span>() <span class="keyword">as</span> <span class="built_in">any</span>, size.<span class="property">width</span>, size.<span class="property">height</span>);</span><br><span class="line">          <span class="keyword">if</span> (capturedData &amp;&amp; capturedData.<span class="property">data</span>) &#123;</span><br><span class="line">            values.<span class="title function_">push</span>(capturedData.<span class="property">data</span>);</span><br><span class="line">            <span class="comment">// 保存多个二维码的坐标、宽高和文本值信息</span></span><br><span class="line">            qrs.<span class="title function_">push</span>(&#123;</span><br><span class="line">              <span class="attr">x</span>: capturedData.<span class="property">location</span>.<span class="property">topLeftCorner</span>.<span class="property">x</span>,</span><br><span class="line">              <span class="attr">y</span>: capturedData.<span class="property">location</span>.<span class="property">topLeftCorner</span>.<span class="property">y</span>,</span><br><span class="line">              <span class="attr">width</span>: capturedData.<span class="property">location</span>.<span class="property">topRightCorner</span>.<span class="property">x</span> - capturedData.<span class="property">location</span>.<span class="property">topLeftCorner</span>.<span class="property">x</span>,</span><br><span class="line">              <span class="attr">height</span>: capturedData.<span class="property">location</span>.<span class="property">bottomLeftCorner</span>.<span class="property">y</span> - capturedData.<span class="property">location</span>.<span class="property">topLeftCorner</span>.<span class="property">y</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 保存 qrs 二维码数据并发送数据到主进程进行其它操作</span></span><br><span class="line">        ...</span><br><span class="line">        callback &amp;&amp; <span class="title function_">callback</span>(!!qrs.<span class="property">length</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        callback &amp;&amp; <span class="title function_">callback</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>第三步：发送二维码数据到主进程，主进程根据坐标和宽高信息生成办透明的全屏窗口(截图遮罩层)，并在透明窗口加载的 js 文件中根据二维码坐标信息用 <code>canvas</code> 绘制高亮捕获区域：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------ 主进程中创建透明窗口 ------ */</span></span><br><span class="line"><span class="keyword">import</span> &#123; app, <span class="title class_">BrowserWindow</span> screen &#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> screenSize = screen.<span class="title function_">getPrimaryDisplay</span>().<span class="property">workAreaSize</span>;</span><br><span class="line"><span class="keyword">const</span> twin = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">    <span class="attr">width</span>: screenSize.<span class="property">width</span>,</span><br><span class="line">    <span class="attr">height</span>: screenSize.<span class="property">height</span>,</span><br><span class="line">    <span class="attr">transparent</span>: <span class="literal">true</span>, <span class="comment">// 透明</span></span><br><span class="line">    <span class="attr">alwaysOnTop</span>: <span class="literal">true</span>, <span class="comment">// 置顶</span></span><br><span class="line">    <span class="attr">fullscreen</span>: <span class="literal">true</span>, <span class="comment">// 全屏</span></span><br><span class="line">    <span class="attr">frame</span>: <span class="literal">false</span>, <span class="comment">// 无边框</span></span><br><span class="line">    <span class="attr">titleBarStyle</span>: <span class="string">&#x27;hidden&#x27;</span>, <span class="comment">// 隐藏标题栏</span></span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br><span class="line">twin.<span class="title function_">loadURL</span>(<span class="string">&#x27;path/to/html&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------ 渲染进程中绘制高亮二维码区域 ------ */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> screenWidth = <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">availWidth</span> * <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span>;</span><br><span class="line"><span class="keyword">const</span> screenHeight = <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">availHeight</span> * <span class="variable language_">window</span>.<span class="property">devicePixelRatio</span>;</span><br><span class="line"><span class="keyword">const</span> $drawer = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#drawer&#x27;</span>);</span><br><span class="line">$drawer.<span class="property">width</span> = screenWidth;</span><br><span class="line">$drawer.<span class="property">height</span> = screenHeight;</span><br><span class="line"><span class="keyword">if</span> (!drawer) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ctx = drawer.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;x, y, width, height&#125; = p;</span><br><span class="line"><span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">  <span class="comment">// 全屏填充半透明背景色</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(0, 0, 0, .3)&#x27;</span>;</span><br><span class="line">  ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, drawer.<span class="property">width</span>, drawer.<span class="property">height</span>);</span><br><span class="line">  <span class="comment">// 高亮二维码捕获区域</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(255, 0, 0, .4)&#x27;</span>;</span><br><span class="line">  ctx.<span class="title function_">fillRect</span>(x, y, width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-多平台功能适配之-shadowsocks-libev-库的依赖处理">4. 多平台功能适配之 <code>shadowsocks-libev</code> 库的依赖处理</h3><p>本桌面应用主要使用 <code>shadowsocks-libev</code> 跨平台库进行 proxy 的管理。</p><ul><li><p>Ubuntu20.04 <strong>deb</strong> 构建方式中：由于依赖库可以直接从官方 <code>apt</code> 软件源中安装，因此不用在应用内部提供二进制可执行文件，只需在 <code>electron-builder.json</code> 中声明 <code>deb</code> 字段的依赖项目即可，用户安装 deb 安装包的时候会自动从软件源商店下载对应的依赖，参考上文 <code>electron-builder.json</code> 说明。</p></li><li><p>Ubuntu20.04 <strong>AppImage</strong> 构建方式中：需要将用到的 <code>ss-local</code> 命令的二进制执行文件集成到包内，并在执行命令时提供明确的二进制文件绝对地址，如：<code>/path/to/ss-local</code>。</p></li><li><p>Mac <strong>dmg / zip</strong> 构建方式中：Mac 中虽然也能通过包管理器 <code>brew</code> 来安装：<code>brew install shadowsocks-libev</code>，但是考虑到 <code>brew</code> 本身并不属于 Mac 操作系统开封即用的应用，可能有些用户 Mac 机没有安装，并且国内网络环境你懂得，普通用户安装它可能会网络错误。因此构建包中默认集成了 <code>shadowsocks-libev</code> 库中需要用到的 <code>ss-local</code> 二进制文件，详见项目路径：<code>/bin/darwin/x64/ss-local</code>。</p></li></ul><p>以下是程序运行时获取 <code>ss-local</code> 可执行文件地址的多平台兼容处理代码作为参考：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 搜索系统环境变量中配置的目录，生成目标可执行文件的绝对路径 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBinPath = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> fullpath = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="keyword">const</span> paths = (process.<span class="property">env</span>.<span class="property">PATH</span> <span class="keyword">as</span> <span class="built_in">string</span>).<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">name: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fullpath.<span class="title function_">get</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> fullpath.<span class="title function_">get</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fs.<span class="title function_">existsSync</span>(path.<span class="title function_">join</span>(paths[i], name))) &#123;</span><br><span class="line">        fullpath.<span class="title function_">set</span>(name, path.<span class="title function_">join</span>(paths[i], name));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullpath.<span class="title function_">get</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取 ss-local 执行文件地址 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getSSLocalBinPath</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span> (os.<span class="title function_">platform</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">      <span class="comment">// 从系统环境变量中匹配路径</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getBinPath</span>(<span class="string">&#x27;ss-local&#x27;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;darwin&#x27;</span>:</span><br><span class="line">      <span class="comment">// 使用手动集成的 ss-local 文件</span></span><br><span class="line">      <span class="keyword">return</span> path.<span class="title function_">join</span>(app.<span class="title function_">getAppPath</span>(), <span class="string">`bin/darwin/x64/ss-local`</span>);</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getBinPath</span>(<span class="string">&#x27;ss-local&#x27;</span>) ?? <span class="string">&#x27;ss-local&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-Electron-调用-shadowsocks-libev-库连接服务器">5. Electron 调用 <code>shadowsocks-libev</code> 库连接服务器</h3><p>上一步说明了使用 <code>ss-local</code> 命令之前所做的兼容处理，现在需要使用 <code>ss-local</code> 命令 (shadowsocks 客户端) 来连接我们的服务器了。Electron 执行命令首先想到的是什么？没错就是 Node.js 的 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://nodejs.cn/api/child_process.html"><code>child_process</code></a> 模块，它提供了多种方式用于 Node.js 主进程开启子进程执行系统命令和可执行文件：</p><ul><li><strong>spawn</strong>：child_process.spawn() 方法使用给定的 command 和 args 中的命令行参数衍生新进程。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ls = <span class="title function_">spawn</span>(<span class="string">&#x27;ls&#x27;</span>, [<span class="string">&#x27;-lh&#x27;</span>, <span class="string">&#x27;/usr&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">ls.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ls.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`stderr: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ls.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`child process exited with code <span class="subst">$&#123;code&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>exec</strong>: 衍生 shell，然后在该 shell 中执行 command，缓冲任何生成的输出。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="title function_">exec</span>(<span class="string">&#x27;cat *.js missing_file | wc -l&#x27;</span>, <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`exec error: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`stderr: <span class="subst">$&#123;stderr&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>execFile</strong>：类似于 exec()，但是默认情况下它会直接衍生命令而不先衍生shell。exec() 和 execFile() 之间区别的重要性可能因平台而异，在 Unix 类型的操作系统上，execFile() 可以更高效，因为默认情况下不会衍生 shell。但是在 Windows 上， .bat 和 .cmd 文件在没有终端的情况下不能自行执行，因此无法使用 execFile() 启动。当在 Windows 上运行时，要调用 .bat 和 .cmd 文件，可以使用设置了 shell 选项的 child_process.spawn()、child_process.exec() 或衍生 cmd.exe 并将 .bat 或 .cmd 文件作为参数传入（也就是 shell 选项和 child_process.exec() 所做的）。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; execFile &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> child = <span class="title function_">execFile</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;--version&#x27;</span>], <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(stdout);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>fork</strong>：child_process.fork() 方法是 child_process.spawn() 的特例，专门用于衍生新的 Node.js 进程。 与 child_process.spawn() 一样，返回 ChildProcess 对象。 返回的 ChildProcess 将有额外的内置通信通道，允许消息在父进程和子进程之间来回传递。注意创建个每个子进程都有自己的内存，具有自己的 V8 实例，由于需要额外的资源分配，不建议衍生大量子 Node.js 进程。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">argv</span>[<span class="number">2</span>] === <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello from <span class="subst">$&#123;process.argv[<span class="number">2</span>]&#125;</span>!`</span>);</span><br><span class="line">  &#125;, <span class="number">1_000</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">  <span class="keyword">const</span> &#123; signal &#125; = controller;</span><br><span class="line">  <span class="keyword">const</span> child = <span class="title function_">fork</span>(__filename, [<span class="string">&#x27;child&#x27;</span>], &#123; signal &#125;);</span><br><span class="line">  child.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果控制器中止，则这将在 err 为 AbortError 的情况下被调用</span></span><br><span class="line">  &#125;);</span><br><span class="line">  controller.<span class="title function_">abort</span>(); <span class="comment">// 停止子进程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此项目中使用 <code>spawn</code> 方式创建子进程来执行 <code>ss-local</code> 命令连接服务器：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> spawnClient = <span class="keyword">async</span> (<span class="attr">config</span>: <span class="title class_">Config</span>, <span class="attr">settings</span>: <span class="title class_">Settings</span>) : <span class="title class_">Promise</span>&lt;&#123;<span class="attr">code</span>: <span class="built_in">number</span>, <span class="attr">result</span>: <span class="built_in">any</span>&#125;&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> sslocalPath = <span class="title function_">getSSLocalBinPath</span>();</span><br><span class="line">  <span class="keyword">const</span> args = [</span><br><span class="line">    <span class="string">&quot;-s&quot;</span>,</span><br><span class="line">    config.<span class="property">serverHost</span>,</span><br><span class="line">    <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">    config.<span class="property">serverPort</span>.<span class="title function_">toString</span>(),</span><br><span class="line">    <span class="string">&quot;-l&quot;</span>,</span><br><span class="line">    settings.<span class="property">localPort</span>.<span class="title function_">toString</span>(),</span><br><span class="line">    <span class="string">&quot;-k&quot;</span>,</span><br><span class="line">    config.<span class="property">password</span>,</span><br><span class="line">    <span class="string">&quot;-m&quot;</span>,</span><br><span class="line">    config.<span class="property">encryptMethod</span>,</span><br><span class="line">    config.<span class="property">udp</span> ? <span class="string">&quot;-u&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">fastOpen</span> ? <span class="string">&quot;--fast-open&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">noDelay</span> ? <span class="string">&quot;--no-delay&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">plugin</span> ? <span class="string">&quot;--plugin&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">plugin</span> ?? <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">pluginOpts</span> ? <span class="string">&quot;--plugin-opts&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.<span class="property">pluginOpts</span> ?? <span class="string">&quot;&quot;</span>,</span><br><span class="line">    settings.<span class="property">verbose</span> ? <span class="string">&quot;-v&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">    (config.<span class="property">timeout</span> ?? <span class="string">&quot;60&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`check port <span class="subst">$&#123;settings.localPort&#125;</span> usage...`</span>);</span><br><span class="line">    ssLocal = <span class="title function_">spawn</span>(</span><br><span class="line">      sslocalPath,</span><br><span class="line">      args.<span class="title function_">filter</span>(<span class="function"><span class="params">arg</span> =&gt;</span> arg !== <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ssLocal.<span class="property">stdout</span>?.<span class="title function_">once</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">&quot;Started ss-local&quot;</span>);</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">&quot;Set proxy on&quot;</span>);</span><br><span class="line">          ...</span><br><span class="line">      connected = <span class="literal">true</span>;</span><br><span class="line">      mainWindow?.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&quot;connected&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">      <span class="title function_">resolve</span>(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="literal">null</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.<span class="property">stdout</span>?.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(data);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(err);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.<span class="title function_">on</span>(<span class="string">&quot;exit&quot;</span>, <span class="keyword">async</span> (code, signal) =&gt; &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`Exited ss-local with code <span class="subst">$&#123;code&#125;</span> or signal <span class="subst">$&#123;signal&#125;</span>`</span>);</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">&quot;Set proxy off&quot;</span>);</span><br><span class="line">      ...</span><br><span class="line">      connected = <span class="literal">false</span>;</span><br><span class="line">      <span class="title class_">MessageChannel</span>.<span class="title function_">sendTo</span>(mainWindow?.<span class="property">id</span> || <span class="number">1</span>, <span class="string">&#x27;connected&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line">      ssLocal = <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-多平台功能适配之设置系统-proxy-和-pac-服务">6. 多平台功能适配之设置系统 proxy 和 pac 服务</h3><p>客户端中可以切换<strong>全局 proxy</strong> 和 <strong>pac 模式</strong>，全局即系统上运行的应用程序都走 proxy 流量。而 pac 则是一种更加智能化的模式，通过配置 pac 文件的地址(http / fs 协议)，实现系统流量按照 pac 中声明的规则进行智能化分流处理，只将我们不能直接访问的域名通过 proxy 转发。</p><ul><li>如果你正在使用 Ubuntu 操作系统的话可以依次打开：<code>设置 - 网络 - 网络DaiLi(拼音手动和谐)</code>，里面可以选择：<code>自动 / 手动 / 禁用</code> 三种模式，其中<strong>自动</strong>即为 pac 模式，我们可以填入在线或本地pac文件的地址，例如：<code>http://localhost:1090/proxy.pac</code>，然后系统就会智能化分配流量了；<strong>手动</strong>就是全局 proxy，里面可以配置各种 proxy 的地址(http / https / socks / ftp)，如：<code>socks5://127.0.0.1:1080</code>；<strong>禁用</strong>不用多说就是禁止系统 proxy，直接根据访问目标走 dns 系统查询到的 IP 地址。</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/system_proxy.png" alt="system_proxy"></p><ul><li>如果你正在使用 Mac 操作系统的话其实也大同小异，可以从：<code>系统偏好设置 - 网络 - 高级 - DaiLi(拼音手动和谐)</code> 处找到相关设置。</li></ul><p>客户端实现的功能就是避免用户进行上述的繁琐的设置操作，在界面通过功能按钮一键切换即可。</p><h4 id="设置系统-proxy">设置系统 proxy</h4><p>客户端适配了Ubuntu 操作系统中最常用的 <code>Gnome</code> 桌面版本，原理是使用其自带的 <code>gsetting</code> 命令直接在命令行设置 proxy：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setGlobalProxy</span> = <span class="keyword">async</span> (<span class="params">host: <span class="built_in">string</span>, port: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 开启手动模式</span></span><br><span class="line">  <span class="keyword">const</span> manualSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">&quot;gsettings set org.gnome.system.proxy mode manual&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置主机名</span></span><br><span class="line">  <span class="keyword">const</span> hostSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy.socks host &#x27;<span class="subst">$&#123;host&#125;</span>&#x27;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置端口号</span></span><br><span class="line">  <span class="keyword">const</span> portSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy.socks port <span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置忽略的本地地址</span></span><br><span class="line">  <span class="keyword">const</span> bypassSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy ignore-hosts &quot;[&#x27;<span class="subst">$&#123;ignoredHosts&#125;</span>&#x27;]&quot;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    manualSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    hostSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    portSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    bypassSet.<span class="property">code</span> === <span class="number">0</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而对于 Mac 操作系统也有类似的操作命令 <code>networksetup</code>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setGlobalProxy</span> = <span class="keyword">async</span> (<span class="params">host: <span class="built_in">string</span>, port: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">await</span> <span class="title function_">listNetworkServices</span>();</span><br><span class="line">  <span class="keyword">if</span> (!services) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    services.<span class="title function_">map</span>(<span class="keyword">async</span> service =&gt; &#123;</span><br><span class="line">      <span class="comment">// 开启模式</span></span><br><span class="line">      <span class="keyword">const</span> autoSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">        <span class="string">`networksetup -setsocksfirewallproxystate &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; on`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置主机名和端口号</span></span><br><span class="line">      <span class="keyword">const</span> urlSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">        <span class="string">`networksetup -setsocksfirewallproxy &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;host&#125;</span>&#x27; <span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置忽略的本地地址</span></span><br><span class="line">      <span class="keyword">const</span> bypassSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">        <span class="string">`networksetup -setproxybypassdomains &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;ignoredHosts&#125;</span>&#x27;`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> autoSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp; urlSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp; bypassSet.<span class="property">code</span> === <span class="number">0</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> results.<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> i === <span class="literal">true</span>).<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="设置系统-pac-文件地址">设置系统 pac 文件地址</h4><p>原理都相同，都是使用命令生成 <code>pac</code> 文件，然后启动一个 <code>http</code> 服务器做静态托管，最后通过操作系统内置命令将 pac 文件地址设置好即可。</p><p>在 Ubuntu 系统中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setPacProxy</span> = <span class="keyword">async</span> (<span class="params">url: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 启动 pac 模式</span></span><br><span class="line">  <span class="keyword">const</span> autoSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">&quot;gsettings set org.gnome.system.proxy mode auto&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置 pac 地址</span></span><br><span class="line">  <span class="keyword">const</span> urlSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy autoconfig-url &#x27;<span class="subst">$&#123;url&#125;</span>&#x27;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> autoSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp; urlSet.<span class="property">code</span> === <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在 Mac 系统中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">listNetworkServices</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">execAsync</span>(<span class="string">&quot;networksetup -listallnetworkservices&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">code</span> === <span class="number">0</span> &amp;&amp; result.<span class="property">stdout</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> r = result.<span class="property">stdout</span>.<span class="title function_">split</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    r.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setPacProxy</span> = <span class="keyword">async</span> (<span class="params">url: <span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取所有网络服务</span></span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">await</span> <span class="title function_">listNetworkServices</span>();</span><br><span class="line">  <span class="keyword">if</span> (!services) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    services.<span class="title function_">map</span>(<span class="keyword">async</span> service =&gt; &#123;</span><br><span class="line">      <span class="comment">// 启动 pac 模式</span></span><br><span class="line">      <span class="keyword">const</span> autoSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">        <span class="string">`networksetup -setautoproxystate &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; on`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置 pac 地址</span></span><br><span class="line">      <span class="keyword">const</span> urlSet = <span class="keyword">await</span> <span class="title function_">execAsync</span>(</span><br><span class="line">        <span class="string">`networksetup -setautoproxyurl &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;url&#125;</span>&#x27;`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> autoSet.<span class="property">code</span> === <span class="number">0</span> &amp;&amp; urlSet.<span class="property">code</span> === <span class="number">0</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> results.<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> i === <span class="literal">true</span>).<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="7-多平台功能适配之应用开机自启动">7. 多平台功能适配之应用开机自启动</h3><p>原作者仅支持了 Mac 系统的开机自启，使用了 Electron 自带的平台专用 API - <code>setLoginItemSettings</code>，不过 API 仅支持 Mac：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 设置登录状态，默认是为 process.execPath 设置，可以使用默认值</span></span><br><span class="line">app.<span class="title function_">setLoginItemSettings</span>(&#123;</span><br><span class="line">    <span class="attr">openAtLogin</span>: params.<span class="property">openAtLogin</span>, <span class="comment">// 开机自启</span></span><br><span class="line">    <span class="attr">openAsHidden</span>: params.<span class="property">openAsHidden</span> <span class="comment">// 自动隐藏窗口</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Ubuntu 我还是用的比较熟悉的，毕业后一直用于工作和日常使用。加上之前也做过一个 Ubuntu 版本的类似电脑管家的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja/electronux">小桌面应用</a>，因此对 Gnome 桌面和 Electron 方面的交互有一定经验。Ubuntu 上面要想实现应用开机自启需要自己定制一个配置文件到 <code>~/.config/autostart/</code> 路径下，比如 <code>~/.config/autostart/shasowsocks-electron.desktop</code>：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/autostart.png" alt="autostart"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name=Shadowsocks Electron</span><br><span class="line">Exec=shadowsocks-electron</span><br><span class="line">Terminal=false</span><br><span class="line">Type=Application</span><br><span class="line">Icon=shadowsocks-electron</span><br><span class="line">StartupWMClass=Shadowsocks Electron</span><br><span class="line">Encoding=UTF-8</span><br><span class="line">Comment=Shadowsocks GUI with cross-platform desktop support</span><br><span class="line">Categories=Network</span><br><span class="line">Hidden=false</span><br></pre></td></tr></table></figure><p>需要重点关注的是以下字段：</p><ul><li>Exec：应用可执行文件路径或命令</li><li>Type：GUI应用应填写 Application</li><li>Hidden：禁用/启用状态</li></ul><p>在客户端中当用户开启了开机自启功能时，Node.js 就检查相应目录是否存在这个文件，不存在的话先使用 <code>fs.write</code> API 创建文件，并根据具体的开启/禁用状态更改 <strong>Hidden</strong> 字段即可：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setStartupOnBoot_linux</span> = (<span class="params">on: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> startupDir = <span class="string">`<span class="subst">$&#123;os.homedir()&#125;</span>/.config/autostart`</span>;</span><br><span class="line">  <span class="keyword">const</span> startupFile = <span class="string">&#x27;shadowsocks-electron.desktop&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> fileContent = [</span><br><span class="line">    <span class="string">&quot;[Desktop Entry]&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Name=Shadowsocks Electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Exec=shadowsocks-electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Terminal=false&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Type=Application&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Icon=shadowsocks-electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;StartupWMClass=Shadowsocks Electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Encoding=UTF-8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Comment=Shadowsocks GUI with cross-platform desktop support&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Categories=Network&quot;</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeFile</span>(</span><br><span class="line">      path.<span class="title function_">join</span>(startupDir, startupFile),</span><br><span class="line">      <span class="comment">// 新增一行 Hidden 字段描述</span></span><br><span class="line">      <span class="string">`<span class="subst">$&#123;fileContent.join(os.EOL)&#125;</span><span class="subst">$&#123;os.EOL&#125;</span>Hidden=<span class="subst">$&#123;on ? <span class="literal">false</span> : <span class="literal">true</span>&#125;</span>`</span>,</span><br><span class="line">      (<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="title function_">resolve</span>(path.<span class="title function_">join</span>(startupDir, startupFile));</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-使用-Electron-进程管理器提高开发调试效率">8. 使用 Electron 进程管理器提高开发调试效率</h3><p>上文在描述 <code>redux-persist</code> 数据持久化功能时提到过，Electron 框架最近的几个版本带来了一个破坏性修改，<code>remote</code> 远程调用被强制移除了。这样子 npm 上大量的依赖 remote API 的开源工具就会出现兼容性问题，除非开源作者将 <code>electron.remote</code> 更改为 <code>@electron/remote</code> 第三方外部包。</p><p>不过总有一些开源仓库不会被开源作者和社区一直维护，我之前在开发阶段一直用的调试工具 <code>devtron</code> 就是这个情况。工具可以在 <code>devtools</code> 控制台中开启一个面板查看 electron 的 <code>ipc</code> 通信记录，因为 Electron 本地应用不存在 http 请求，因此不会在网络请求面板中看到，所以需要这样一个工具查看主进程和渲染进程之间的消息记录以便追踪应用。</p><p><code>devtron</code> github 主页贴着项目不再维护，寻求热心的开源开发者继续维护的消息。<code>devtron</code> 最近的一次版本在我使用的 <code>electron@13.4.0</code> 上也直接歇菜了🤪。我遇到 <code>devtron</code> 报错打不开的情况后索性突发奇想将所有原生的 <code>ipc</code> 通信方式(on / once / send / sendTo / invoke / handle…) 使用我自己之前开发的进程管理工具 <code>electron-re</code> 替代，感兴趣的可以看看 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja/electron-re">github 仓库</a>。迁移到 <code>electron-re</code> 之后，我在项目中开了一个 <code>dev</code> 分支专门用于支持<code>ipc</code> 通信记录功能，其实适配工作量不大，写个UI界面，然后在原有的数据采集模块新增一点逻辑即可。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/process_manager.png" alt="process_manager"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/ipc.png" alt="ipc"></p><p>这里顺便打个广告🤏，<code>electron-re</code> 主要是作为一个进程管理器和 <code>ipc</code> 通信工具开发的，除了支持 Electron 应用中主进程、渲染进程、service 进程(<code>electron-re</code> 引入)、child 进程(<code>electron-re</code> 引入) 的资源占用情况动态统计功能，也提供了一个 ipc 通信工具 <code>MessageChannel</code>，它基于 electron 原生 ipc 通信开发。除此之外它还提供了一个简单实现的进程池工具 <code>ChildProcessPool</code> 和与之配套使用的 <code>ProcessHost</code> 消息工具。这次针对 <code>shadowsocks-electron</code> 和其他 Electron 应用开发的 ipc 通信记录面板功能就是在 <code>MessageChannel</code> 通信工具中通过新增通信记录上报逻辑来实现的。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/electron-re.png" alt="process_manager"></p><h2 id="Others">Others</h2><blockquote><p>开发过程中的其它提及</p></blockquote><h3 id="1-Mac-虚拟机真是难装">1. Mac 虚拟机真是难装</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/virtualbox_detail.png" alt="virtualbox_detail"></p><p>安装 Mac 虚拟机足足折磨了我一天多，实体机安装 Ubuntu 双系统 40 分钟就能解决的事儿，从下载 virtualbox 可用的 <code>MacOS 10.15</code> 开始，龟速百度网盘。安装 ISO 时很容易卡住或者报错，最后查了很多资料整理出以下步骤：</p><p>一台支持英特尔虚拟化技术的电脑 + <a target="_blank" rel="noopener external nofollow noreferrer" href="https://pan.baidu.com/s/1OeMhhKdXSbiqIPGluq3CAA">MacOS 10.15 镜像</a> (密码：3guu)</p><ul><li>1）VirtualBox虚拟机软件，版本号在 6.0 及以上即可。</li><li>2）启动虚拟机创建向导，选择类型 - <code>Mac OS X</code>，版本 -<code>Mac OS x64</code>。</li><li>3）其余什么内存、磁盘之类的按照自己需求大概配置一下，格外注意的是网络不要选择<code>桥接网卡</code>，选中默认的<code>NAT</code>网络模式，否则 Ubuntu20.04 操作系统下可能会在运行虚拟机的时候卡死宿主机。<code>NAT</code> 模式不能分配和宿主机同网段的独立 IP，因此如果要通过 SSH 访问虚拟机的话可以在虚拟机设置里面开启端口转发，比如我将宿主机端口 <code>2222</code> 映射到虚拟机内部 ssh 的默认端口 <code>22</code>，这样就可以在宿主机通过命令：<code>ssh -p 2222 nojsja@127.0.0.1</code> 来连接了。</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/virtualbox_nat.png" alt="virtualbox_nat"></p><ul><li>4）虚拟机创建好后注意在虚拟机设置中<code>存储</code>页面添加下载好的 ISO 光盘镜像作为开机引导。</li><li>5）以上步骤准备好后，有一个比较关键的操作，设置虚拟机相关配置，不然安装很可能出错：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行终端中依次执行以下命令，&quot;macOS&quot; 替换为自己虚拟机的名字</span></span><br><span class="line">$: VBoxManage modifyvm <span class="string">&quot;macOS&quot;</span> --cpuidset 00000001 000106e5 00100800 0098e3fd bfebfbff </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiSystemProduct&quot;</span> <span class="string">&quot;iMac11,3&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiSystemVersion&quot;</span> <span class="string">&quot;1.0&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiBoardProduct&quot;</span> <span class="string">&quot;Iloveapple&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/smc/0/Config/DeviceKey&quot;</span> <span class="string">&quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/smc/0/Config/GetKeyFromRealSMC&quot;</span> 1</span><br><span class="line">$: VBoxManage modifyvm <span class="string">&quot;macOS&quot;</span> --cpu-profile <span class="string">&quot;Intel Core i7-6700K&quot;</span></span><br></pre></td></tr></table></figure><ul><li>6）之后就比较常规了，开启虚拟机后，在“macOS Utilities”窗口的列表中，双击“Disk Utility”项，来启动磁盘助理，对磁盘进行分区。将需要使用的虚拟安装硬盘格式化为 “Mac OS Extended(Journaled)”或“APFS”即可。</li><li>7）其余流程跟着引导走即可，最后安装完了重启之后，别忘了在虚拟机<code>存储</code>里卸载 ISO 引导光盘，否则会开机一直进入安装界面。</li></ul><h3 id="2-Mac-brew-在国内环境的安装方式">2. Mac brew 在国内环境的安装方式</h3><p>Mac 安装好后，需要使用 <code>brew</code> 包管理器安装 <code>shadowsocks-libev</code>，官方提供的脚本在国内网络环境下会安装失败，建议使用国内开发者编写的版本：</p><ol><li><p>官方脚本：<code>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</code></p></li><li><p>国内开发者编写的脚本：<code>/bin/zsh -c &quot;$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)&quot;</code></p></li></ol><h3 id="3-Node-js-child-process-执行二进制文件的一些坑">3. Node.js child_process 执行二进制文件的一些坑</h3><p>客户端中 MacOS 平台需要执行 <code>shadowsocks-libev</code> 库中提供的命令连接服务器如：<code>sslocal -s host -p port -l localPort -k password -m method ...</code>，上文中提到针对 MacOS 的兼容方式是在构建包中提供 <code>ss-local</code> 二进制文件，以避免让用户手动执行 <code>brew install shadowsocks-libev</code> 来安装依赖库。</p><p>这里有个坑就是开发者为用户提供 <code>ss-local</code> 后，默认这个二进制文件是放在应用安装目录的，但是你不知道用户操作系统中你的客户端软件会被具体安装到哪里，极可能是系统相关目录。系统相关目录中的文件 Electron 默认是不能执行的，也不能通过 Node.js 提供的 <code>fs.chmod</code> 方式手动为可执行文件授予执行权限。</p><p>这个问题之前开发 Ubuntu 桌面管家的时候遇到过，都是 Unix 系的操作系统，Mac 这边也会出现这个问题。解决方案就是将客户端需要用到的 bin 二进制文件在应用启动的时候拷贝到用户数据目录，这个目录下的文件用户拥有完全控制权，可以使用 Node.js 提供的 <code>fs.chmod</code> API让二进制文件可执行。具体实现如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------ utils.ts ------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * checkEnvFiles [检查环境文件是否存在]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> <span class="variable">nojsja</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; param [desc]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> checkEnvFiles = (<span class="attr">args</span>: &#123;<span class="attr">_path</span>: <span class="built_in">string</span>, <span class="attr">isDir</span>: <span class="built_in">boolean</span>, exec?: <span class="function">() =&gt;</span> <span class="built_in">void</span>&#125;[]): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> check = <span class="keyword">function</span> (<span class="params">params: &#123;_path: <span class="built_in">string</span>, isDir: <span class="built_in">boolean</span>, exec?: () =&gt; <span class="built_in">void</span>&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(params.<span class="property">_path</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (params.<span class="property">isDir</span>) &#123;</span><br><span class="line">        fs.<span class="title function_">mkdirSync</span>(params.<span class="property">_path</span>);</span><br><span class="line">        params.<span class="property">exec</span> &amp;&amp; params.<span class="title function_">exec</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fs.<span class="title function_">closeSync</span>(fs.<span class="title function_">openSync</span>(params.<span class="property">_path</span>, <span class="string">&#x27;w&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  args.<span class="title function_">forEach</span>(check);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 同步复制目录、子目录，及其中的文件</span></span><br><span class="line"><span class="comment"> * @param src &#123;String&#125; 要复制的目录</span></span><br><span class="line"><span class="comment"> * @param dist &#123;String&#125; 复制到目标目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">copyDir</span> = (<span class="params">src: <span class="built_in">string</span>, dist: <span class="built_in">string</span>, callback?: (params: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> paths, stat;</span><br><span class="line">  <span class="keyword">if</span>(!fs.<span class="title function_">existsSync</span>(dist)) &#123;</span><br><span class="line">    fs.<span class="title function_">mkdirSync</span>(dist);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">_copy</span>(src, dist);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_copy</span>(<span class="params">src: <span class="built_in">string</span>, dist: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    paths = fs.<span class="title function_">readdirSync</span>(src);</span><br><span class="line">    paths.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">_path</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> _src = path.<span class="title function_">join</span>(src, _path);</span><br><span class="line">        <span class="keyword">let</span> _dist = path.<span class="title function_">join</span>(dist, _path);</span><br><span class="line">        stat = fs.<span class="title function_">statSync</span>(_src);</span><br><span class="line">        <span class="comment">// 判断是文件还是目录</span></span><br><span class="line">        <span class="keyword">if</span>(stat.<span class="title function_">isFile</span>()) &#123;</span><br><span class="line">          fs.<span class="title function_">writeFileSync</span>(_dist, fs.<span class="title function_">readFileSync</span>(_src));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(stat.<span class="title function_">isDirectory</span>()) &#123;</span><br><span class="line">          <span class="comment">// 当是目录是，递归复制</span></span><br><span class="line">          <span class="title function_">copyDir</span>(_src, _dist, callback)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [fsChmod 对文件和文件夹递归授予权限]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[String]</span>&#125; dir   [文件夹]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[int]</span>&#125; opstr [八进制数字，例如0o711]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">chmod</span> = (<span class="params">target: <span class="built_in">string</span>, opstr: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.<span class="title function_">statSync</span>(target).<span class="title function_">isDirectory</span>()) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = fs.<span class="title function_">readdirSync</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (files.<span class="property">length</span>) &#123;</span><br><span class="line">      files.<span class="title function_">forEach</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        fs.<span class="title function_">chmod</span>(path.<span class="title function_">join</span>(target, file), opstr);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target &amp;&amp; !target.<span class="title function_">includes</span>(<span class="string">&#x27;.gitignore&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`fs.chmod =&gt; <span class="subst">$&#123;target&#125;</span> with <span class="subst">$&#123;opstr&#125;</span>`</span>);</span><br><span class="line">      fs.<span class="title function_">chmodSync</span>(target, opstr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------ 主进程 index.ts ------ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户数据目录中的文件拥有完全控制权</span></span><br><span class="line"><span class="keyword">const</span> appDataPath = path.<span class="title function_">join</span>(app.<span class="title function_">getPath</span>(<span class="string">&#x27;appData&#x27;</span>), packageName);</span><br><span class="line"><span class="keyword">const</span> pathRuntime = (<span class="variable language_">global</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">pathRuntime</span> = path.<span class="title function_">join</span>(appDataPath, <span class="string">&#x27;runtime/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查文件完整性</span></span><br><span class="line"><span class="title function_">checkEnvFiles</span>(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">_path</span>: appDataPath, <span class="attr">isDir</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">_path</span>: pathRuntime, <span class="attr">isDir</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">_path</span>: path.<span class="title function_">join</span>(pathRuntime, <span class="string">&#x27;bin&#x27;</span>), <span class="attr">isDir</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">exec</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">copyDir</span>(path.<span class="title function_">join</span>(app.<span class="title function_">getAppPath</span>(), <span class="string">&#x27;bin&#x27;</span>), path.<span class="title function_">join</span>(pathRuntime, <span class="string">&#x27;bin&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 授权</span></span><br><span class="line"><span class="title function_">chmod</span>(path.<span class="title function_">join</span>(pathRuntime, <span class="string">&#x27;bin&#x27;</span>), <span class="number">0o711</span>);</span><br></pre></td></tr></table></figure><h3 id="4-怎样为未适配-Typescript-的第三方包编写-types-声明">4. 怎样为未适配 Typescript 的第三方包编写 @types 声明</h3><p>上文提到引入了 <code>electron-re</code> 进程管理工具用于 ipc 消息追踪，不过之前开发 <code>electron-re</code> 时并未适配 Typescript 环境，仍然是 <code>commonJs</code> 规范，不过 TS 里引入第三方包只要存在类型声明文件即可。方法一是编写 <code>@types/electron-re</code> 单独发包支持，另一种就是直接在 <code>electron-re</code> 项目下声明即可，自己的仓库可以选择第二种。</p><p>在项目根目录中创建声明文件 <code>types/index.d.ts</code>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> electronReModule &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> electronRe &#123;</span><br><span class="line">    <span class="title class_">MessageChannel</span>: &#123;</span><br><span class="line">      <span class="attr">invoke</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, channel: <span class="built_in">string</span>, args: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">      <span class="attr">handle</span>: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, promiseFunc: (event, args: &#123; action: <span class="built_in">string</span>, params: <span class="built_in">any</span> &#125;) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">unknown</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">send</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, channel: <span class="built_in">string</span>, args: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">sendTo</span>: <span class="function">(<span class="params">id: <span class="built_in">number</span>, channel: <span class="built_in">string</span>, args: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">on</span>: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, func: () =&gt; <span class="built_in">void</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">once</span>: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, func: () =&gt; <span class="built_in">void</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">registry</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, id: <span class="built_in">number</span>, pid: <span class="built_in">number</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">BrowserService</span>: &#123;</span><br><span class="line">      <span class="attr">openDevTools</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">connected</span>: <span class="function">(<span class="params">callback?: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">ChildProcessPool</span>: &#123;</span><br><span class="line">      <span class="attr">send</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, params: <span class="built_in">unknown</span>, givenId: <span class="built_in">number</span></span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">      <span class="attr">sendToAll</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, params: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">kill</span>: <span class="function">(<span class="params">id?: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">setMaxInstanceLimit</span>: <span class="function">(<span class="params">count: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">ProcessHost</span>: &#123;</span><br><span class="line">      <span class="attr">registry</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, processor: () =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">unregistry</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">disconnect</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">exit</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title class_">ProcessManager</span>: &#123;</span><br><span class="line">      <span class="attr">pipe</span>: <span class="function">(<span class="params">pinstance: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">listen</span>: <span class="function">(<span class="params">pids: <span class="built_in">number</span>[], mark: <span class="built_in">string</span>, url?: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">unlisten</span>: <span class="function">(<span class="params">pids: <span class="built_in">number</span>[]</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">openDevTools</span>: <span class="function">(<span class="params">pid: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">killProcess</span>: <span class="function">(<span class="params">pid: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">setIntervalTime</span>: <span class="function">(<span class="params">time: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">openWindow</span>: <span class="function">(<span class="params">env: <span class="string">&#x27;prod&#x27;</span> | <span class="string">&#x27;dev&#x27;</span> | <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">ere</span>: electronReModule.<span class="property">electronRe</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> = ere;</span><br></pre></td></tr></table></figure><p>然后在 <code>package.json</code> 中声明相关字段引入 types 文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./types/index.d.ts&quot;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>注意：<code>commonJs</code> 规范和 <code>ES module</code> 规范的包声明写法略有不同，这里再给出一个 <code>ES module</code> 规范声明文件示例(与 <code>electron-re</code> 无关)：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ReturnTreeData</span> &#123;</span><br><span class="line">  <span class="attr">depth</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">isInEdit</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">nameEditable</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">nodeDeletable</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">nodeName</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">nodeValue</span>: <span class="title class_">ReturnTreeData</span>[]</span><br><span class="line">  <span class="attr">valueEditable</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TreeStateTypes</span> &#123;</span><br><span class="line">  <span class="attr">treeData</span>: <span class="title class_">ReturnTreeData</span>[];</span><br><span class="line">  <span class="attr">expandedKeys</span>: <span class="built_in">string</span>[];</span><br><span class="line">  <span class="attr">enableYaml</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">maxLevel</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">lang</span>: <span class="string">&#x27;zh_CN&#x27;</span> | <span class="string">&#x27;en_US&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TreePropsDataTypes</span> &#123;</span><br><span class="line">  <span class="attr">nodeName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">string</span>; <span class="comment">// unique id, required</span></span><br><span class="line">  nameEditable ?: <span class="built_in">boolean</span>; <span class="comment">// is level editable (name), default true</span></span><br><span class="line">  valueEditable ?: <span class="built_in">boolean</span>; <span class="comment">// is level editable (value), default true</span></span><br><span class="line">  nodeDeletable ?: <span class="built_in">boolean</span>; <span class="comment">// is level deletable, default true</span></span><br><span class="line">  nodeValue : <span class="title class_">TreePropsDataTypes</span>[] | <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TreePropsTypes</span> &#123;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">TreePropsDataTypes</span>[];</span><br><span class="line">  <span class="attr">maxLevel</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">enableYaml</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">lang</span>: <span class="string">&#x27;en_US&#x27;</span> | <span class="string">&#x27;zh_CN&#x27;</span>;</span><br><span class="line">  <span class="attr">onDataChange</span>: <span class="function">(<span class="params">params: ReturnTreeData[]</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;editable-tree-antd&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">EditableTree</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;<span class="title class_">TreePropsTypes</span>, <span class="title class_">TreeStateTypes</span>&gt; &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-感谢作为-UI-设计师的-GF-倾情支持">5. 感谢作为 UI 设计师的 GF 倾情支持</h3><p><code>shadowsocks-electron</code> 客户端的图标是 GF 工作之余帮忙处理的，好看的渐变色小飞机图标！</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/logo.png" alt="logo"></p><h3 id="6-延伸阅读">6. 延伸阅读</h3><ul><li><a target="_blank" rel="noopener" href="https://nojsja.gitee.io/blogs/2020/12/08/6d582478.html/">Electron / Node 多进程工具开发日记 ❤️ nojsja/blogs</a></li><li><a target="_blank" rel="noopener" href="https://nojsja.gitee.io/blogs/2020/12/18/927d467e.html/">Electron 多进程工具开发日记2：进程管理UI ❤️ nojsja/blogs</a></li><li><a target="_blank" rel="noopener" href="https://nojsja.gitee.io/blogs/2020/08/16/1597e5d6.html/">基于Electron 的 smb 客户端文件上传优化探索 ❤️ nojsja/blogs</a></li><li><a target="_blank" rel="noopener" href="https://nojsja.gitee.io/blogs/2019/06/12/81770652.html/">Ubuntu18 踩坑记录 - nojsja/blogs ❤️ nojsja/blogs</a></li></ul><h2 id="Final">Final</h2><blockquote><p>结语</p></blockquote><p>这是完整做过的第四个 Electron 项目了，第一个是 Ubuntu 电脑管家，第二个是公司项目：一个类似百度网盘采用 SMB 协议支持的文件管理器，第三个是 <code>electron-re</code> 进程管理工具，最后一个就是这次的 <code>shadowsocks-electron</code> 跨平台 proxy 工具了。</p><p>客户端目前已经发布了 <code>v1.0.0</code> 版本，支持 <strong>Mac</strong> 和 <strong>Ubuntu</strong> x64 平台，主要测试环境是：<strong>Ubuntu20.04 amd64</strong> 和 <strong>MacOS catalina x64</strong>。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/release.png" alt="release"></p><p>后期会持续支持，喜欢的话可以去 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja/shadowsocks-electron">github 仓库</a> star ⭐ ！</p><p>近期有这些想完善的功能：</p><ul><li>考虑支持 HTTP Proxy。</li><li>考虑支持 SSR 服务器连接。</li><li>修复二维码导入功能中遮罩层窗口内部二维码高亮区域位置不准确的问题(由系统状态栏导致)，并适配多屏幕。</li><li>很想支持服务器延迟检测和连接速度测试功能，感觉会很炫。</li><li><code>v2ray</code> 的话其实已经以插件的形式支持了，不过目前没有详细测试过这一功能，考虑如有必要后面会直接支持解析 <code>v2ray</code> 加密链接。</li></ul><p>暂时只考虑为 <strong>Mac/Ubuntu</strong> 适配，<strong>Win</strong> 平台的话工具很多，Shadowsocks 官方也有一直在维护的客户端，用起来都很舒服。</p><p>总之学到了新东西，最折磨人的地方其实是折腾 Mac 虚拟机，踩了很多坑，以后我还是继续用我的 <strong>Ubuntu/Win</strong> 双系统吧 ~ 😂</p><span class="meta" id="headerViewCountWrapper"><span id="<Your/Path/Name>" class="leancloud_visitors" data-flag-title="Your Article Title"><em class="post-meta-item-text">⇸⇸ 阅读量：</em> <i class="leancloud-visitors-count">[ loading ]</i>⇷⇷</span></span><script>document.querySelector("#headerViewCountWrapper > .leancloud_visitors").id=decodeURIComponent(window.location.pathname)</script><hr style="margin-top:5px"><ul class="pager"><li class="previous"><a href="/2021/11/29/adb1f235.html/" data-toggle="tooltip" data-placement="top" title="记一次 React hooks 组件开发和优化记录">&larr; Previous Post</a></li><li class="next"><a href="/2021/07/08/671354ab.html/" data-toggle="tooltip" data-placement="top" title="taro小程序开发笔记">Next Post &rarr;</a></li></ul><style type="text/css">.aplayer-container{text-align:center}.lds-roller-loading{display:inline-block;position:relative;width:80px;height:80px}.lds-roller-loading div{animation:lds-roller 1.2s cubic-bezier(.5,0,.5,1) infinite;transform-origin:40px 40px}.lds-roller-loading div:after{content:" ";display:block;position:absolute;width:7px;height:7px;border-radius:50%;background:#ff59ac;margin:-4px 0 0 -4px}.lds-roller-loading div:nth-child(1){animation-delay:-36ms}.lds-roller-loading div:nth-child(1):after{top:63px;left:63px}.lds-roller-loading div:nth-child(2){animation-delay:-72ms}.lds-roller-loading div:nth-child(2):after{top:68px;left:56px}.lds-roller-loading div:nth-child(3){animation-delay:-108ms}.lds-roller-loading div:nth-child(3):after{top:71px;left:48px}.lds-roller-loading div:nth-child(4){animation-delay:-144ms}.lds-roller-loading div:nth-child(4):after{top:72px;left:40px}.lds-roller-loading div:nth-child(5){animation-delay:-.18s}.lds-roller-loading div:nth-child(5):after{top:71px;left:32px}.lds-roller-loading div:nth-child(6){animation-delay:-216ms}.lds-roller-loading div:nth-child(6):after{top:68px;left:24px}.lds-roller-loading div:nth-child(7){animation-delay:-252ms}.lds-roller-loading div:nth-child(7):after{top:63px;left:17px}.lds-roller-loading div:nth-child(8){animation-delay:-288ms}.lds-roller-loading div:nth-child(8):after{top:56px;left:12px}@keyframes lds-roller{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.aplayer .aplayer-pic .aplayer-pause svg{top:0;left:0}.aplayer .aplayer-pic .aplayer-play svg{top:0;left:2px}</style><div class="aplayer-container"><div id="aplayer" class="lds-roller-loading" lazy-css-href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css" lazy-js-src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><script>(function(){var e,t=document.querySelector("#aplayer"),s=function(s,i){var r=[];s&&r.push(s),i&&r.push(i),r.forEach((function(s){async(s,(function(){/^.*.js$/.test(s)&&function(){e&&e.disconnect(),t.className="",t.innerHTML="";new APlayer({container:document.getElementById("aplayer"),theme:"#e9e9e9",audio:[{name:"存在信号",artist:"AcuticNotes",url:"http://nojsja.gitee.io/static-resources/audio/life-signal.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/life-signal.jpg"},{name:"遺サレタ場所／斜光",artist:"岡部啓一",url:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.jpg"}]})}()}),/^.*.css$/.test(s)?"link":"script")}))};if(window.IntersectionObserver)(e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var i=t.target.getAttribute("lazy-css-href"),r=t.target.getAttribute("lazy-js-src");s(i,r)}}))}))).observe(t);else{var i=t.getAttribute("lazy-css-href"),r=t.getAttribute("lazy-js-src");s(i,r)}}).bind(window)()</script><hr><div id="vcomments"></div><script>(function(){function e(){async("js/Valine.min.js",(function(){new Valine({el:"#vcomments",appId:"wUKKBx8BRzGaNfhgdg2UKtub-MdYXbMMI",appKey:"MAwYM4KlW5YJ3q06qwnUScBr",visitor:!0})}))}if(window.IntersectionObserver){var n=new IntersectionObserver((function(i){i.forEach((function(i){i.isIntersecting&&(n.unobserve(i.target),n.disconnect(),e())}))}));n.observe(document.querySelector("#headerViewCountWrapper"))}else e()}).bind(window)()</script></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Preface"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Preface</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Prevew"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Prevew</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Contents"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Contents</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Tools-Technology"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Tools &amp; Technology</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-%E4%BD%8E%E9%85%8D%E7%BD%AE%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%9Areact-app-rewired"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">1. 低配置快速启动前端开发环境：react-app-rewired</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%94%B9%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF%EF%BC%9Anodemon"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">2. 代码更改自动重启：nodemon</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%9Aredux-persist-redux-persist-electron-storage"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">3. 数据持久化：redux-persist&#x2F;redux-persist-electron-storage</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%EF%BC%9Aelectron-builder"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">4. 项目打包：electron-builder</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%EF%BC%9Awinston"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">5. 客户端运行日志管理：winston</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Core-Functions"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">Core Functions</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-%E8%A7%A3%E6%9E%90-Shadowsocks-%E4%B8%93%E7%94%A8%E5%8A%A0%E5%AF%86%E9%93%BE%E6%8E%A5"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">1. 解析 Shadowsocks 专用加密链接</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-%E5%B0%86%E5%B7%B2%E6%9C%89%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%9B%BE%E7%89%87%E8%BF%9B%E8%A1%8C%E5%88%86%E4%BA%AB"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">2. 将已有的服务器配置生成二维码图片进行分享</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-%E8%AF%BB%E5%8F%96%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AF%BC%E5%85%A5-Shadowsocks-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">3. 读取二维码导入 Shadowsocks 服务器配置</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B-shadowsocks-libev-%E5%BA%93%E7%9A%84%E4%BE%9D%E8%B5%96%E5%A4%84%E7%90%86"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">4. 多平台功能适配之 shadowsocks-libev 库的依赖处理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-Electron-%E8%B0%83%E7%94%A8-shadowsocks-libev-%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-nav-number">5.5.</span> <span class="toc-nav-text">5. Electron 调用 shadowsocks-libev 库连接服务器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy-%E5%92%8C-pac-%E6%9C%8D%E5%8A%A1"><span class="toc-nav-number">5.6.</span> <span class="toc-nav-text">6. 多平台功能适配之设置系统 proxy 和 pac 服务</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy"><span class="toc-nav-number">5.6.1.</span> <span class="toc-nav-text">设置系统 proxy</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-pac-%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80"><span class="toc-nav-number">5.6.2.</span> <span class="toc-nav-text">设置系统 pac 文件地址</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#7-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E5%BA%94%E7%94%A8%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-nav-number">5.7.</span> <span class="toc-nav-text">7. 多平台功能适配之应用开机自启动</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#8-%E4%BD%BF%E7%94%A8-Electron-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%99%A8%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E6%95%88%E7%8E%87"><span class="toc-nav-number">5.8.</span> <span class="toc-nav-text">8. 使用 Electron 进程管理器提高开发调试效率</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Others"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">Others</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-Mac-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9C%9F%E6%98%AF%E9%9A%BE%E8%A3%85"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">1. Mac 虚拟机真是难装</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-Mac-brew-%E5%9C%A8%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">2. Mac brew 在国内环境的安装方式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#3-Node-js-child-process-%E6%89%A7%E8%A1%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">3. Node.js child_process 执行二进制文件的一些坑</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-%E6%80%8E%E6%A0%B7%E4%B8%BA%E6%9C%AA%E9%80%82%E9%85%8D-Typescript-%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85%E7%BC%96%E5%86%99-types-%E5%A3%B0%E6%98%8E"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">4. 怎样为未适配 Typescript 的第三方包编写 @types 声明</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#5-%E6%84%9F%E8%B0%A2%E4%BD%9C%E4%B8%BA-UI-%E8%AE%BE%E8%AE%A1%E5%B8%88%E7%9A%84-GF-%E5%80%BE%E6%83%85%E6%94%AF%E6%8C%81"><span class="toc-nav-number">6.5.</span> <span class="toc-nav-text">5. 感谢作为 UI 设计师的 GF 倾情支持</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="toc-nav-number">6.6.</span> <span class="toc-nav-text">6. 延伸阅读</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Final"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">Final</span></a></li></ol></div></aside></div></div></article><script>async("https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js",(function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")}))</script><script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="js/anchor.nojsja.js"></script><style>#websiteModal .modal-body{display:flex;align-items:center;justify-content:center;margin:auto;text-align:center;width:100%;height:100%}#websiteModal .modal-body img{max-width:100%;height:auto}</style><script>$(document).ready((function(){$(document).on("click","img",(function(o){if($(this).hasClass("click-disable"))o&&o.stopPropagation();else{o&&o.stopPropagation();var a=$(this).clone();$("#websiteModal").modal("show"),a.addClass("click-disable"),$("#websiteModal .modal-body").html(a)}})).on("click",".modal-body",(function(){$("#websiteModal").modal("hide")}))}))</script><div class="modal fade" id="websiteModal" tabindex="-1" role="dialog" aria-labelledby="websiteModalTitle" aria-hidden="true"><div class="modal-body"></div></div><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; nojsja 2022</p></div></div></div></footer><script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.usebootstrap.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/widgets.js"></script><script>async("https://nojsja.gitee.io/static-resources/libs/fastclick/1.0.6/fastclick.min.js",(function(){var t=document.querySelector("nav");t&&FastClick.attach(t)}))</script><script type="text/javascript">var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;searchFunc(path,"local-search-input","local-search-result")</script><script src="/js/busuanzi.pure.mini.js" defer async></script><a id="rocket" href="#top"></a><script type="text/javascript" src="js/totop.js" async></script><script>(function(){function t(t){return document.querySelectorAll(t)}if(window.hexoLoadingImages=window.hexoLoadingImages||{},window.IntersectionObserver){var e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var n=new Image,o="_img_"+Math.random();window.hexoLoadingImages[o]=n,n.onload=function(){t.target.src=t.target.getAttribute("data-src"),window.hexoLoadingImages[o]=null},n.onerror=function(){window.hexoLoadingImages[o]=null},t.target.src=t.target.getAttribute("data-loading"),n.src=t.target.getAttribute("data-src")}}))}));t("img[lazyload]").forEach((function(t){e.observe(t)}))}else t("img[lazyload]").forEach((function(t){t.src=t.getAttribute("data-src")}))}).bind(window)()</script></body></html>