<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Electron 进程管理工具开发日记3：进程池负载均衡、智能启停</title>
      <link href="/blogs/2021/12/22/1deae768.html/"/>
      <url>/blogs/2021/12/22/1deae768.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>文中实现的部分工具方法正处于早期/测试阶段，仍在持续优化中，仅供参考…</p></blockquote><blockquote><p>在 Ubuntu20.04 上进行开发/测试，可用于 Electron 项目，测试版本：Electron@8.2.0 / 9.3.5</p></blockquote><h3 id="Contents">Contents</h3><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">├── Contents (you are here!)</span><br><span class="line">│</span><br><span class="line">├── I. 前言</span><br><span class="line">├── II. 架构图</span><br><span class="line">│</span><br><span class="line">├── III.electron-re 可以用来做什么？</span><br><span class="line">│   ├── 1) 用于 Electron 应用</span><br><span class="line">│   └── 2) 用于 Electron/Nodejs 应用</span><br><span class="line">│</span><br><span class="line">├── IV. UI 功能介绍</span><br><span class="line">│   ├── 主界面</span><br><span class="line">│   ├── 功能1：Kill 进程</span><br><span class="line">│   ├── 功能2：一键开启 DevTools</span><br><span class="line">│   ├── 功能3：查看进程日志</span><br><span class="line">│   ├── 功能4：查看进程 CPU/Memory 占用趋势</span><br><span class="line">│   └── 功能5：查看 MessageChannel 请求发送日志</span><br><span class="line">│</span><br><span class="line">├── V. 新特性：进程池负载均衡</span><br><span class="line">│   ├── 关于负载均衡</span><br><span class="line">│   ├── 负载均衡策略说明</span><br><span class="line">│   ├── 负载均衡策略的简易实现</span><br><span class="line">│   ├── 负载均衡器的实现</span><br><span class="line">│   └── 进程池配合 LoadBalancer 来实现负载均衡</span><br><span class="line">│</span><br><span class="line">├── VI. 新特性：子进程智能启停</span><br><span class="line">│   ├── 使进程休眠的各种方式</span><br><span class="line">│   ├── 生命周期 LifeCycle 的实现</span><br><span class="line">│   └── 进程互斥锁的雏形</span><br><span class="line">│</span><br><span class="line">├── VII. 存在的已知问题</span><br><span class="line">├── VIII. Next To Do</span><br><span class="line">│</span><br><span class="line">├── IX. 几个实际使用示例</span><br><span class="line">│   ├── 1) Service/MessageChannel 使用示例</span><br><span class="line">│   ├── 2) 一个实际用于生产项目的例子</span><br><span class="line">│   ├── 3) ChildProcessPool/ProcessHost 使用示例</span><br><span class="line">│   ├── 3) <span class="built_in">test</span> 测试目录示例</span><br><span class="line">│   └── 4) github README 说明</span><br><span class="line">│</span><br></pre></td></tr></table></figure><h3 id="I-前言">I. 前言</h3><hr><p>之前在做 Electron 应用开发的时候，写了个 Electron 进程管理工具 <a href="https://github.com/nojsja/electron-re">electron-re</a>，支持 Electron/Node 多进程管理、service 模拟、进程实时监控(UI功能)、Node.js 进程池等特性。已经发布为npm组件，可以直接安装(最新特性还没发布到线上，需要再进行测试)：</p><p><a href="https://github.com/nojsja/electron-re">&gt;&gt; github地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$: npm install electron-re --save</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$: yarn add electron-re</span><br></pre></td></tr></table></figure><p>本主题前面两篇文章：</p><ol><li><a href="https://nojsja.gitee.io/blogs/2020/12/08/6d582478.html/">《Electron/Node多进程工具开发日记》</a> 描述了<code>electron-re</code>的开发背景、针对的问题场景以及详细的使用方法。</li><li><a href="https://nojsja.gitee.io/blogs/2020/12/18/927d467e.html/">《Electron多进程工具开发日记2》</a> 介绍了新特性 “多进程管理 UI” 的开发和使用相关。UI 界面基于 <code>electron-re</code> 已有的 <code>BrowserService/MessageChannel</code> 和 <code>ChildProcessPool/ProcessHost</code> 基础架构驱动，使用 React17 / Babel7 开发。</li></ol><p>这篇文章主要是描述最近支持的进程池模块新特性 - “进程池负载均衡” 和 “子进程智能启停”，以及相关的基本实现原理。同时提出自己遇到的一些问题，以及对这些问题的思考、解决方案，对之后版本迭代的一些想法等等。</p><h3 id="II-electron-re架构图">II. electron-re架构图</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/electron-re_arch.png"  alt="archtecture"></p><ul><li><strong>Electron Core</strong>：Electron 应用的一系列核心功能，包含了应用的主进程、渲染进程、窗口等等(Electron 自带)。</li><li><strong>BrowserWindow</strong>：渲染窗口进程，一般用于UI渲染 (Electron 自带)。</li><li><strong>ProcessManager</strong>：进程管理器，负责进程占用资源采集、异步刷新UI、响应和发出各种进程管理信号，作为一个观察者对象给其它模块和UI提供服务 (electron-re 引入)。</li><li><strong>MessageChannel</strong>：适用于主进程、渲染进程、Service 进程的消息发送工具，基于原生 IPC 封装，主要服务于 BrowserService，也可替代原生的 IPC 通信方法 (electron-re 引入)。</li><li><strong>ChildProcess</strong>：由 <code>child_process.fork</code> 方法生成的子进程，不过以装饰器的方式为其添加了简单的进程休眠和唤醒逻辑 (electron-re 引入)。</li><li><strong>ProcessHost</strong>：配合进程池使用的工具，我称它为 “进程事务中心”，封装了 <code>process.send / process.on</code> 基本逻辑，提供了 Promise 的调用方式让 主进程/子进程 之间 IPC 消息通信更简单 (electron-re 引入)。</li><li><strong>LoadBalancer</strong>：服务于进程池的负载均衡器。</li><li><strong>LifeCycle</strong>：服务于进程池的生命周期。</li><li><strong>ChildProcessPool</strong>：基于 Node.js - <code>child_process.fork</code> 方法实现的进程池，内部管理多个 ChildProcess 实例对象，支持自定义负载均衡策略、子进程智能启停、子进程异常退出后自动重启等特性 (electron-re 引入)。</li><li><strong>BrowserService</strong>：基于 BrowserWindow 实现的 Service 进程，可以看成是一个运行在后台的隐藏渲染窗口进程，允许 Node 注入，不过仅支持 <code>CommonJs</code> 规范。</li></ul><h3 id="III-electron-re-可以用来做什么？">III. electron-re 可以用来做什么？</h3><hr><h4 id="1-用于Electron应用">1. 用于Electron应用</h4><ul><li><code>BrowserService</code></li><li><code>MessageChannel</code></li></ul><p>在 Electron 的一些“最佳实践”中，建议将占用cpu的代码放到渲染过程中而不是直接放在主过程中，这里先看下 chromium 的架构图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/chromium.jpg"  alt="archtecture"></p><p>每个渲染进程都有一个全局对象 RenderProcess，用来管理与父浏览器进程的通信，同时维护着一份全局状态。浏览器进程为每个渲染进程维护一个 RenderProcessHost 对象，用来管理浏览器状态和与渲染进程的通信。浏览器进程和渲染进程使用 Chromium 的 IPC 系统进行通信。在 chromium 中，页面渲染时，UI进程需要和 main process 不断的进行 IPC 同步，若此时 main process 忙，则 UIprocess 就会在 IPC 时阻塞。所以如果主进程持续进行消耗 CPU 时间的任务或阻塞同步 IO 的任务的话，就会在一定程度上阻塞，从而影响主进程和各个渲染进程之间的 IPC 通信，IPC 通信有延迟或是受阻，渲染进程窗口就会卡顿掉帧，严重的话甚至会卡住不动。</p><p>因此 <code>electron-re</code> 在 Electron 已有的 <code>Main Process</code> 主进程 和 <code>Renderer Process</code> 渲染进程逻辑的基础上独立出一个单独的 <code>Service</code> 概念。<code>Service</code>即不需要显示界面的后台进程，它不参与 UI 交互，单独为主进程或其它渲染进程提供服务，它的底层实现为一个允许 <code>node注入</code> 和 <code>remote调用</code> 的 <strong>隐藏渲染窗口进程</strong>。</p><p>这样就可以将代码中耗费 cpu 的操作(比如文件上传中维护一个数千个上传任务的队列)编写成一个单独的js文件，然后使用 <code>BrowserService</code> 构造函数以这个 js 文件的地址 <code>path</code> 为参数构造一个 <code>Service</code> 实例，从而将他们从主进程中分离。如果你说那这部分耗费 cpu 的操作直接放到渲染窗口进程可以嘛？这其实取决于项目自身的架构设计，以及对进程之间数据传输性能损耗和传输时间等各方面的权衡，创建一个 <code>Service</code> 的简单示例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> myServcie = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, path.join(__dirname, <span class="string">&#x27;path/to/app.service.js&#x27;</span>));</span><br></pre></td></tr></table></figure><p>如果使用了 <code>BrowserService</code> 的话，要想在主进程、渲染进程、service 进程之间相互发送消息就要使用 <code>electron-re</code> 提供的 <code>MessageChannel</code> 通信工具，它的接口设计跟 Electron 内建的<code>IPC</code>基本一致，底层也是基于原生的 <code>IPC</code> 异步通信原理来实现的，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ---- main.js ---- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="comment">// 主进程中向一个 service &#x27;app&#x27; 发送消息</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><h4 id="2-用于-Electron-Nodejs-应用">2. 用于 Electron/Nodejs 应用</h4><ul><li><code>ChildProcessPool</code></li><li><code>ProcessHost</code></li></ul><p>此外，如果要创建一些不依赖于 Electron 运行时的子进程（相关参考nodejs <code>child_process</code>），可以使用 <code>electron-re</code> 提供的专门为 nodejs 运行时编写的进程池 <code>ChildProcessPool</code> 。因为创建进程本身所需的开销很大，使用进程池来重复利用已经创建了的子进程，将多进程架构带来的性能效益最大化，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- 主进程中 --- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ChildProcessPool, LoadBalancer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pool = <span class="keyword">new</span> ChildProcessPool(&#123;</span><br><span class="line">  <span class="attr">path</span>: path.join(app.getAppPath(), <span class="string">&#x27;app/services/child.js&#x27;</span>), <span class="comment">// 子进程执行文件路径</span></span><br><span class="line">  <span class="attr">max</span>: <span class="number">3</span>, <span class="comment">// 最大进程数</span></span><br><span class="line">  <span class="attr">strategy</span>: LoadBalancer.ALGORITHM.WEIGHTS, <span class="comment">// 负载均衡策略 - 权重</span></span><br><span class="line">  <span class="attr">weights</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="comment">// 权重分配</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pool</span><br><span class="line">  .send(<span class="string">&#x27;sync-work&#x27;</span>, params)</span><br><span class="line">  .then(<span class="function"><span class="params">rsp</span> =&gt;</span> <span class="built_in">console</span>.log(rsp));</span><br></pre></td></tr></table></figure><p>一般情况下，在我们的子进程执行文件中，为了在主进程和子进程之间同步数据，可以使用 <code>process.send('channel', params)</code> 和 <code>process.on('channel', function)</code> 的方式实现(前提是进程以以 <code>fork</code> 方式创建或者手动开启了 <code>IPC</code> 通信)。但是这样在处理业务逻辑的同时也强迫我们去关注进程之间的通信，你需要知道子进程什么时候能处理完毕，然后再使用<code>process.send</code>再将数据返回主进程，使用方式繁琐。</p><p><code>electron-re</code> 引入了 <code>ProcessHost</code> 的概念，我称之为&quot;进程事务中心&quot;。实际使用时在子进程执行文件中只需要将各个任务函数通过 <code>ProcessHost.registry('task-name', function)</code> 注册成多个被监听的事务，然后配合进程池的 <code>ChildProcessPool.send('task-name', params)</code> 来触发子进程事务逻辑的调用即可，<code>ChildProcessPool.send()</code> 同时会返回一个 Promise 实例以便获取回调数据，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- 子进程中 --- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ProcessHost &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ProcessHost</span><br><span class="line">  .registry(<span class="string">&#x27;sync-work&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="string">&#x27;task-value&#x27;</span> &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;async-work&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(params.url);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h3 id="IV-UI-功能介绍">IV. UI 功能介绍</h3><hr><p>UI 功能基于 <code>electron-re</code> 基础架构开发，它通过异步 IPC 和主进程的 <code>ProcessManager</code> 进行通信，实时刷新进程状态。操作者可以通过 UI 手动 Kill 进程、查看进程 console 数据、查看进程数 CPU/Memory 占用趋势以及查看 <code>MessageChannel</code> 工具的请求发送记录。</p><h4 id="主界面">主界面</h4><blockquote><p>UI参考 electron-process-manager 设计</p></blockquote><p>预览图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/process-manager.main.png"  alt="process-manager.main.png"></p><p>主要功能如下：</p><ol><li><p>展示 Electron 应用中所有开启的进程，包括主进程、普通的渲染进程、Service 进程(electron-re 引入)、ChildProcessPool 创建的子进程(electron-re 引入)。</p></li><li><p>进程列表中显示各个进程进程号、进程标识、父进程号、内存占用大小、CPU 占用百分比等，所有进程标识分为：main(主进程)、service(服务进程)、renderer(渲染进程)、node(进程池子进程)，点击表格头可以针对对某项进行递增/递减排序。</p></li><li><p>选中某个进程后可以 Kill 此进程、查看进程控制台 Console 数据、查看1分钟内进程 CPU/Memory 占用趋势，如果此进程是渲染进程的话还可以通过 <code>DevTools</code> 按钮一键打开内置调试工具。</p></li><li><p>ChildProcessPool 创建的子进程暂不支持直接打开 DevTools 进行调试，不过由于创建子进程时添加了 <code>--inspect</code> 参数，可以使用 chrome 的 <code>chrome://inspect</code> 进行远程调试。</p></li><li><p>点击 <code>Signals</code> 按钮可以查看 <code>MessageChannel</code> 工具的请求发送日志，包括简单的请求参数、请求名、请求返回数据等。</p></li></ol><h4 id="功能：Kill-进程">功能：Kill 进程</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/kill.gif"  alt="kill.gif"></p><h4 id="功能：一键开启-DevTools">功能：一键开启 DevTools</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/devtools.gif"  alt="devtools.gif"></p><h4 id="功能：查看进程日志">功能：查看进程日志</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/console.gif"  alt="console.gif"></p><h4 id="功能：查看进程-CPU-Memory-占用趋势">功能：查看进程 CPU/Memory 占用趋势</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/trends.gif"  alt="trends.gif"></p><h4 id="功能：查看-MessageChannel-请求发送日志">功能：查看 MessageChannel 请求发送日志</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/signals.png"  alt="console.gif"></p><h3 id="V-新特性：进程池负载均衡">V. 新特性：进程池负载均衡</h3><hr><blockquote><p>简化的初版实现</p></blockquote><p><a href="https://github.com/nojsja/electron-re/blob/master/src/libs/LoadBalancer/algorithm/index.js">&gt;&gt; 代码地址</a></p><h4 id="➣-关于负载均衡">➣ 关于负载均衡</h4><p>“ 负载均衡，英文名称为 Load Balance，其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如 FTP 服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。<br>负载均衡构建在原有网络结构之上，它提供了一种透明且廉价有效的方法扩展服务器和网络设备的带宽、加强网络数据处理能力、增加吞吐量、提高网络的可用性和灵活性。” – 《百度百科》</p><h4 id="➣-负载均衡策略说明">➣ 负载均衡策略说明</h4><p>之前的实现中，进程池创建好后，当使用 pool 发送请求时，采用两种方式处理请求发送策略：</p><ol><li><p>默认使用轮询策略选择一个子进程处理请求，只能保证基本的请求平均分配。</p></li><li><p>另一种使用情况是通过手动指定发送请求时的额外参数 id：<code>pool.send(channel, params, id)</code>，这样子让 <code>id</code> 相同的请求发送到同一个子进程上。一个适用情景就是：第一次我们向某个子进程发送请求，该子进程处理请求后在其运行时内存空间中存储了一些处理结果，之后某个情况下需要将之前那次请求产生的处理结果再次拿回主进程，这时候就需要使用 <code>id</code> 来区分请求。</p></li></ol><p>新版本引入了一些负载均衡策略，包括：</p><ul><li><strong>POLLING</strong> - 轮询：子进程轮流处理请求</li><li><strong>WEIGHTS</strong> - 权重：子进程根据设置的权重来处理请求</li><li><strong>RANDOM</strong> - 随机：子进程随机处理请求</li><li><strong>SPECIFY</strong> - 指定：子进程根据指定的进程 id 处理请求</li><li><strong>WEIGHTS_POLLING</strong> - 权重轮询：权重轮询策略与轮询策略类似，但是权重轮询策略会根据权重来计算子进程的轮询次数，从而稳定每个子进程的平均处理请求数量。</li><li><strong>WEIGHTS_RANDOM</strong> - 权重随机：权重随机策略与随机策略类似，但是权重随机策略会根据权重来计算子进程的随机次数，从而稳定每个子进程的平均处理请求数量。</li><li><strong>MINIMUM_CONNECTION</strong> - 最小连接数：选择子进程上具有最小连接活动数量的子进程处理请求。</li><li><strong>WEIGHTS_MINIMUM_CONNECTION</strong> - 权重最小连接数：权重最小连接数策略与最小连接数策略类似，不过各个子进程被选中的概率由连接数和权重共同决定。</li></ul><h4 id="➣-负载均衡策略的简易实现">➣ 负载均衡策略的简易实现</h4><p>参数说明：</p><ul><li>tasks：任务数组，一个示例：<code>[&#123;id: 11101, weight: 2&#125;, &#123;id: 11102, weight: 1&#125;]</code>。</li><li>currentIndex: 目前所处的任务索引，默认为 0，每次调用时会自动加 1，超出任务数组长度时会自动取模。</li><li>context：主进程参数上下文，用于动态更新当前任务索引和权重索引。</li><li>weightIndex：权重索引，用于权重策略，默认为 0，每次调用时会自动加 1，超出权重总和时会自动取模。</li><li>weightTotal：权重总和，用于权重策略相关计算。</li><li>connectionsMap：各个进程活动连接数的映射，用于最小连接数策略相关计算。</li></ul><h5 id="1-轮询策略-POLLING">1. 轮询策略(POLLING)</h5><blockquote><p>原理：索引值递增，每次调用时会自动加 1，超出任务数组长度时会自动取模，保证平均调用。<br>时间复杂度 O(n) = 1</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* polling algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, currentIndex, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!tasks.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> task = tasks[currentIndex];</span><br><span class="line">  context.currentIndex ++;</span><br><span class="line">  context.currentIndex %= tasks.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> task || <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="2-权重策略-WEIGHTS">2. 权重策略(WEIGHTS)</h5><blockquote><p>原理：每个进程根据 (权重值 + (权重总和 * 随机因子)) 生成最终计算值，最终计算值中的最大值被命中。<br>时间复杂度 O(n) = n</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* weight algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, weightTotal, context</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!tasks.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> max = tasks[<span class="number">0</span>].weight, maxIndex = <span class="number">0</span>, sum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">    sum = (tasks[i].weight || <span class="number">0</span>) + <span class="built_in">Math</span>.random() * weightTotal;</span><br><span class="line">    <span class="keyword">if</span> (sum &gt;= max) &#123;</span><br><span class="line">      max = sum;</span><br><span class="line">      maxIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.weightIndex += <span class="number">1</span>;</span><br><span class="line">  context.weightIndex %= (weightTotal + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tasks[maxIndex];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="3-随机策略-RANDOM">3. 随机策略(RANDOM)</h5><blockquote><p>原理：随机函数在 [0, length) 中任意选取一个索引即可<br>时间复杂度 O(n) = 1</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* random algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> length = tasks.length;</span><br><span class="line">  <span class="keyword">const</span> target = tasks[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * length)];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target || <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="4-权重轮询策略-WEIGHTS-POLLING">4. 权重轮询策略(WEIGHTS_POLLING)</h5><blockquote><p>原理：类似轮询策略，不过轮询的区间为：[最小权重值, 权重总和]，根据各项权重累加值进行命中区间计算。每次调用时权重索引会自动加 1，超出权重总和时会自动取模。<br>时间复杂度 O(n) = n</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* weights polling */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, weightIndex, weightTotal, context</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!tasks.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> weight = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> task;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">    weight += tasks[i].weight || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (weight &gt;= weightIndex) &#123;</span><br><span class="line">      task = tasks[i];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.weightIndex += <span class="number">1</span>;</span><br><span class="line">  context.weightIndex %= (weightTotal + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> task;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="5-权重随机策略-WEIGHTS-RANDOM">5. 权重随机策略(WEIGHTS_RANDOM)</h5><blockquote><p>原理：由 (权重总和 * 随机因子) 产生计算值，将各项权重值与其相减，第一个不大于零的最终值即被命中。<br>时间复杂度 O(n) = n</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* weights random algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, weightTotal</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> task;</span><br><span class="line">  <span class="keyword">let</span> weight = <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random() * weightTotal);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">    weight -= tasks[i].weight || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (weight &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      task = tasks[i];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> task || <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="6-最小连接数策略-MINIMUM-CONNECTION">6. 最小连接数策略(MINIMUM_CONNECTION)</h5><blockquote><p>原理：直接选择当前连接数最小的项即可。<br>时间复杂度 O(n) = n</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* minimum connections algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, connectionsMap=&#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tasks.length &lt; <span class="number">2</span>) <span class="keyword">return</span> tasks[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> min = connectionsMap[tasks[<span class="number">0</span>].id];</span><br><span class="line">  <span class="keyword">let</span> minIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> con = connectionsMap[tasks[i].id] || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (con &lt;= min) &#123;</span><br><span class="line">      min = con;</span><br><span class="line">      minIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tasks[minIndex] || <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="7-权重最小连接数-WEIGHTS-MINIMUM-CONNECTION">7. 权重最小连接数(WEIGHTS_MINIMUM_CONNECTION)</h5><blockquote><p>原理：权重 + ( 随机因子 * 权重总和 ) + ( 连接数占比 * 权重总和 ) 三个因子，计算出最终值，根据最终值的大小进行比较，最小值所代表项即被命中。<br>时间复杂度 O(n) = n</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* weights minimum connections algorithm */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">tasks, weightTotal, connectionsMap, context</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!tasks.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> min = tasks[<span class="number">0</span>].weight, minIndex = <span class="number">0</span>, sum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> connectionsTotal = tasks.reduce(<span class="function">(<span class="params">total, cur</span>) =&gt;</span> &#123;</span><br><span class="line">    total += (connectionsMap[cur.id] || <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// algorithm: (weight + connections&#x27;weight) + random factor</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">    sum =</span><br><span class="line">      (tasks[i].weight || <span class="number">0</span>) + (<span class="built_in">Math</span>.random() * weightTotal) +</span><br><span class="line">      (( (connectionsMap[tasks[i].id] || <span class="number">0</span>) * weightTotal ) / connectionsTotal);</span><br><span class="line">    <span class="keyword">if</span> (sum &lt;= min) &#123;</span><br><span class="line">      min = sum;</span><br><span class="line">      minIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.weightIndex += <span class="number">1</span>;</span><br><span class="line">  context.weightIndex %= (weightTotal + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tasks[minIndex];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="➣-负载均衡器的实现">➣ 负载均衡器的实现</h4><p>代码都不复杂，有几点需要说明：</p><ol><li><strong>params</strong> 对象保存了用于各种策略计算的一些参数，比如权重索引、权重总和、连接数、CPU/Memory占用等等。</li><li><strong>scheduler</strong> 对象用于调用各种策略进行计算，<code>scheduler.calculate()</code> 会返回一个命中的进程 id。</li><li><strong>targets</strong> 即所有用于计算的目标进程，不过其中仅存放了目标进程 pid 和 其权重 weight：<code>[&#123;id: [pid], weight: [number]&#125;, ...]</code>。</li><li><strong>algorithm</strong> 为特定的负载均衡策略，默认值为轮询策略。</li><li><strong>ProcessManager.on(‘refresh’, this.refreshParams)</strong>，负载均衡器通过监听 <code>ProcessManager</code> 的 refresh 事件来定时更新各个进程的计算参数。<code>ProcessManager</code> 中有一个定时器，每隔一段时间就会采集一次各个被监听的进程的资源占用情况，并携带采集数据触发一次 refresh 事件。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CONSTS = <span class="built_in">require</span>(<span class="string">&quot;./consts&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> Scheduler = <span class="built_in">require</span>(<span class="string">&quot;./scheduler&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  RANDOM,</span><br><span class="line">  POLLING,</span><br><span class="line">  WEIGHTS,</span><br><span class="line">  SPECIFY,</span><br><span class="line">  WEIGHTS_RANDOM,</span><br><span class="line">  WEIGHTS_POLLING,</span><br><span class="line">  MINIMUM_CONNECTION,</span><br><span class="line">  WEIGHTS_MINIMUM_CONNECTION,</span><br><span class="line">&#125; = CONSTS;</span><br><span class="line"><span class="keyword">const</span> ProcessManager = <span class="built_in">require</span>(<span class="string">&#x27;../ProcessManager&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Load Balance Instance */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadBalancer</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;Object&#125;</span> </span>options [ options object ]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;Array &#125;</span> </span>options.targets [ targets for load balancing calculation: [&#123;id: 1, weight: 1&#125;, &#123;id: 2, weight: 2&#125;] ]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>options.algorithm [ strategies for load balancing calculation : RANDOM | POLLING | WEIGHTS | SPECIFY | WEIGHTS_RANDOM | WEIGHTS_POLLING | MINIMUM_CONNECTION | WEIGHTS_MINIMUM_CONNECTION]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.targets = options.targets;</span><br><span class="line">    <span class="built_in">this</span>.algorithm = options.algorithm || POLLING;</span><br><span class="line">    <span class="built_in">this</span>.params = &#123; <span class="comment">// data for algorithm</span></span><br><span class="line">      <span class="attr">currentIndex</span>: <span class="number">0</span>, <span class="comment">// index</span></span><br><span class="line">      <span class="attr">weightIndex</span>: <span class="number">0</span>, <span class="comment">// index for weight alogrithm</span></span><br><span class="line">      <span class="attr">weightTotal</span>: <span class="number">0</span>, <span class="comment">// total weight</span></span><br><span class="line">      <span class="attr">connectionsMap</span>: &#123;&#125;, <span class="comment">// connections of each target</span></span><br><span class="line">      <span class="attr">cpuOccupancyMap</span>: &#123;&#125;, <span class="comment">// cpu occupancy of each target</span></span><br><span class="line">      <span class="attr">memoryOccupancyMap</span>: &#123;&#125;, <span class="comment">// cpu occupancy of each target</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">this</span>.scheduler = <span class="keyword">new</span> Scheduler(<span class="built_in">this</span>.algorithm);</span><br><span class="line">    <span class="built_in">this</span>.memoParams = <span class="built_in">this</span>.memorizedParams();</span><br><span class="line">    <span class="built_in">this</span>.calculateWeightIndex();</span><br><span class="line">    ProcessManager.on(<span class="string">&#x27;refresh&#x27;</span>, <span class="built_in">this</span>.refreshParams);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* params formatter */</span></span><br><span class="line">  memorizedParams = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      [RANDOM]: <span class="function">() =&gt;</span> [],</span><br><span class="line">      [POLLING]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.currentIndex, <span class="built_in">this</span>.params],</span><br><span class="line">      [WEIGHTS]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.weightTotal, <span class="built_in">this</span>.params],</span><br><span class="line">      [SPECIFY]: <span class="function">(<span class="params">id</span>) =&gt;</span> [id],</span><br><span class="line">      [WEIGHTS_RANDOM]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.weightTotal],</span><br><span class="line">      [WEIGHTS_POLLING]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.weightIndex, <span class="built_in">this</span>.params.weightTotal, <span class="built_in">this</span>.params],</span><br><span class="line">      [MINIMUM_CONNECTION]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.connectionsMap],</span><br><span class="line">      [WEIGHTS_MINIMUM_CONNECTION]: <span class="function">() =&gt;</span> [<span class="built_in">this</span>.params.weightTotal, <span class="built_in">this</span>.params.connectionsMap, <span class="built_in">this</span>.params],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* refresh params data */</span></span><br><span class="line">  refreshParams = <span class="function">(<span class="params">pidMap</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* pick one task from queue */</span></span><br><span class="line">  pickOne = <span class="function">(<span class="params">...params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.scheduler.calculate(</span><br><span class="line">      <span class="built_in">this</span>.targets, <span class="built_in">this</span>.memoParams[<span class="built_in">this</span>.algorithm](...params)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* pick multi task from queue */</span></span><br><span class="line">  pickMulti = <span class="function">(<span class="params">count = <span class="number">1</span>, ...params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Array</span>(count).fill().map(</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="built_in">this</span>.pickOne(...params)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* calculate weight */</span></span><br><span class="line">  calculateWeightIndex = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.params.weightTotal = <span class="built_in">this</span>.targets.reduce(<span class="function">(<span class="params">total, cur</span>) =&gt;</span> total + (cur.weight || <span class="number">0</span>), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.params.weightIndex &gt; <span class="built_in">this</span>.params.weightTotal) &#123;</span><br><span class="line">      <span class="built_in">this</span>.params.weightIndex = <span class="built_in">this</span>.params.weightTotal;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* calculate index */</span></span><br><span class="line">  calculateIndex = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.params.currentIndex &gt;= <span class="built_in">this</span>.targets.length) &#123;</span><br><span class="line">      <span class="built_in">this</span>.params.currentIndex = (ths.params.currentIndex - <span class="number">1</span> &gt;= <span class="number">0</span>) ? (<span class="built_in">this</span>.params.currentIndex - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* clean data of a task or all task */</span></span><br><span class="line">  clean = <span class="function">(<span class="params">id</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* add a task */</span></span><br><span class="line">  add = <span class="function">(<span class="params">task</span>) =&gt;</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* remove target from queue */</span></span><br><span class="line">  del = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* wipe queue and data */</span></span><br><span class="line">  wipe = <span class="function">() =&gt;</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* update calculate params */</span></span><br><span class="line">  updateParams = <span class="function">(<span class="params">object</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(object).map(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> <span class="built_in">this</span>.params) &#123;</span><br><span class="line">        <span class="built_in">this</span>.params[key] = value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* reset targets */</span></span><br><span class="line">  setTargets = <span class="function">(<span class="params">targets</span>) =&gt;</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* change algorithm strategy */</span></span><br><span class="line">  setAlgorithm = <span class="function">(<span class="params">algorithm</span>) =&gt;</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(LoadBalancer, &#123; <span class="attr">ALGORITHM</span>: CONSTS &#125;);</span><br></pre></td></tr></table></figure><h4 id="➣-进程池配合-LoadBalancer-来实现负载均衡">➣ 进程池配合 LoadBalancer 来实现负载均衡</h4><p>有几点需要说明：</p><ol><li>当我们使用 <code>pool.send('channel', params)</code> 时，pool 内部 <code>getForkedFromPool()</code> 函数会被调用，函数从进程池中选择一个进程来执行任务，如果子进程数未达到最大设定数，则优先创建一个子进程来处理请求。</li><li>子进程 创建/销毁/退出 时需要同步更新 <code>LoadBalancer</code> 中监听的 <code>targets</code>，否则已被销毁的进程 pid 可能会在执行负载均衡策略计算后被返回。</li><li><code>ForkedProcess</code> 是一个装饰器类，封装了 <code>child_process.fork</code> 逻辑，为其增加了一些额外功能，如：进程睡眠、唤醒、绑定事件、发送请求等基本方法。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ForkedProcess = <span class="built_in">require</span>(<span class="string">&#x27;./ForkedProcess&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ProcessLifeCycle = <span class="built_in">require</span>(<span class="string">&#x27;../ProcessLifeCycle.class&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ProcessManager = <span class="built_in">require</span>(<span class="string">&#x27;../ProcessManager/index&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; defaultLifecycle &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../ProcessLifeCycle.class&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> LoadBalancer = <span class="built_in">require</span>(<span class="string">&#x27;../LoadBalancer&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> &#123; inspectStartIndex &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../conf/global.json&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getRandomString, removeForkedFromPool, convertForkedToMap, isValidValue &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; UPDATE_CONNECTIONS_SIGNAL &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../consts&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultStrategy = LoadBalancer.ALGORITHM.POLLING;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildProcessPool</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    path, max=<span class="number">6</span>, cwd, env=&#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">    weights=[], <span class="regexp">//</span> weights <span class="keyword">of</span> processes, the length is equal to max</span></span></span><br><span class="line"><span class="params"><span class="function">    strategy=defaultStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">    ...</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.cwd = cwd || _path.dirname(path);</span><br><span class="line">    <span class="built_in">this</span>.env = &#123;</span><br><span class="line">      ...process.env,</span><br><span class="line">      ...env</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">this</span>.callbacks = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.pidMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="built_in">this</span>.callbacksMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="built_in">this</span>.connectionsMap=&#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.forked = [];</span><br><span class="line">    <span class="built_in">this</span>.connectionsTimer = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.forkedMap = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.forkedPath = path;</span><br><span class="line">    <span class="built_in">this</span>.forkIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.maxInstance = max;</span><br><span class="line">    <span class="built_in">this</span>.weights = <span class="keyword">new</span> <span class="built_in">Array</span>(max).fill().map(</span><br><span class="line">      <span class="function">(<span class="params">_, i</span>) =&gt;</span> (isValidValue(weights[i]) ? weights[i] : <span class="number">1</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">this</span>.LB = <span class="keyword">new</span> LoadBalancer(&#123;</span><br><span class="line">      <span class="attr">algorithm</span>: strategy,</span><br><span class="line">      <span class="attr">targets</span>: [],</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.initEvents();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* -------------- internal -------------- */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* init events */</span></span><br><span class="line">  initEvents = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// process exit</span></span><br><span class="line">    <span class="built_in">this</span>.on(<span class="string">&#x27;forked_exit&#x27;</span>, <span class="function">(<span class="params">pid</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.onForkedDisconnect(pid);</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * onForkedCreate [triggered when a process instance created]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>pid [process pid]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  onForkedCreate = <span class="function">(<span class="params">forked</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pidsValue = <span class="built_in">this</span>.forked.map(<span class="function"><span class="params">f</span> =&gt;</span> f.pid);</span><br><span class="line">    <span class="keyword">const</span> length = <span class="built_in">this</span>.forked.length;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.LB.add(&#123;</span><br><span class="line">      <span class="attr">id</span>: forked.pid,</span><br><span class="line">      <span class="attr">weight</span>: <span class="built_in">this</span>.weights[length - <span class="number">1</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    ProcessManager.listen(pidsValue, <span class="string">&#x27;node&#x27;</span>, <span class="built_in">this</span>.forkedPath);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * onForkedDisconnect [triggered when a process instance disconnect]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>pid [process pid]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   onForkedDisconnect = <span class="function">(<span class="params">pid</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> length = <span class="built_in">this</span>.forked.length;</span><br><span class="line"></span><br><span class="line">    removeForkedFromPool(<span class="built_in">this</span>.forked, pid, <span class="built_in">this</span>.pidMap);</span><br><span class="line">    <span class="built_in">this</span>.LB.del(&#123;</span><br><span class="line">      <span class="attr">id</span>: pid,</span><br><span class="line">      <span class="attr">weight</span>: <span class="built_in">this</span>.weights[length - <span class="number">1</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    ProcessManager.unlisten([pid]);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Get a process instance from the pool */</span></span><br><span class="line">  getForkedFromPool = <span class="function">(<span class="params">id=<span class="string">&quot;default&quot;</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> forked;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.pidMap.get(id)) &#123;</span><br><span class="line">      <span class="comment">// create new process and put it into the pool</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.forked.length &lt; <span class="built_in">this</span>.maxInstance) &#123;</span><br><span class="line">        inspectStartIndex ++;</span><br><span class="line">        forked = <span class="keyword">new</span> ForkedProcess(</span><br><span class="line">          <span class="built_in">this</span>,</span><br><span class="line">          <span class="built_in">this</span>.forkedPath,</span><br><span class="line">          <span class="built_in">this</span>.env.NODE_ENV === <span class="string">&quot;development&quot;</span> ? [<span class="string">`--inspect=<span class="subst">$&#123;inspectStartIndex&#125;</span>`</span>] : [],</span><br><span class="line">          &#123; <span class="attr">cwd</span>: <span class="built_in">this</span>.cwd, <span class="attr">env</span>: &#123; ...this.env, id &#125;, <span class="attr">stdio</span>: <span class="string">&#x27;pipe&#x27;</span> &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">this</span>.forked.push(forked);</span><br><span class="line">        <span class="built_in">this</span>.onForkedCreate(forked);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get a process from the pool based on load balancing strategy</span></span><br><span class="line">        forked = <span class="built_in">this</span>.forkedMap[<span class="built_in">this</span>.LB.pickOne().id];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (id !== <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.pidMap.set(id, forked.pid);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// pick a special process from the pool</span></span><br><span class="line">      forked = <span class="built_in">this</span>.forkedMap[<span class="built_in">this</span>.pidMap.get(id)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!forked) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Get forked process from pool failed! the process pid: <span class="subst">$&#123;<span class="built_in">this</span>.pidMap.get(id)&#125;</span>.`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> forked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* -------------- caller -------------- */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * send [Send request to a process]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>taskName [task name - necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Any]&#125;</span> </span>params [data passed to process - necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>id [the unique id bound to a process instance - not necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;[Promise]&#125;</span> </span>[return a Promise instance]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  send = <span class="function">(<span class="params">taskName, params, givenId</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (givenId === <span class="string">&#x27;default&#x27;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;ChildProcessPool: Prohibit the use of this id value: [default] !&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> id = getRandomString();</span><br><span class="line">    <span class="keyword">const</span> forked = <span class="built_in">this</span>.getForkedFromPool(givenId);</span><br><span class="line">    <span class="built_in">this</span>.lifecycle.refresh([forked.pid]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.callbacks[id] = resolve;</span><br><span class="line">      forked.send(&#123;<span class="attr">action</span>: taskName, params, id &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ChildProcessPool;</span><br></pre></td></tr></table></figure><h3 id="VI-新特性：子进程智能启停">VI. 新特性：子进程智能启停</h3><hr><p>这个特性我也将其称为 <code>进程生命周期</code> (lifecycle)。</p><p>主要作用是：当子进程一段时间未被调用，则自动进入休眠状态，减少 CPU 占用 (减少内存占用很难)。进入休眠状态的时间可以和由创建者控制，默认为 10 min。当子进程进入休眠后，如果有新的请求到来并分发到该休眠的进程上，则会自动唤醒该进程并继续处理当前请求。一段时间闲置后，将会再次进入休眠状态。</p><h4 id="➣-使进程休眠的各种方式">➣ 使进程休眠的各种方式</h4><p>1）如果是让进程暂停的话，可以向进程发送 <code>SIGSTOP</code> 信号，发送 <code>SIGCONT</code> 信号可以恢复进程。</p><p>Node.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">process.kill([pid], <span class="string">&quot;SIGSTOP&quot;</span>);</span><br><span class="line">process.kill([pid], <span class="string">&quot;SIGCONT&quot;</span>);</span><br></pre></td></tr></table></figure><p>Unix System (Windows 暂未测试):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -STOP [pid]</span><br><span class="line"><span class="built_in">kill</span> -CONT [pid]</span><br></pre></td></tr></table></figure><p>2）Node.js 新的 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait">Atomic.wait</a> API 也可以做到编程控制。该方法会监听一个 Int32Array 对象的给定下标下的值，若值未发生改变，则一直等待(阻塞 event loop)，直到发生超时(由 ms 参数决定)。可以在主进程中操作这块共享数据，然后为子进程解除休眠锁定。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nil = <span class="keyword">new</span> <span class="built_in">Int32Array</span>(<span class="keyword">new</span> SharedArrayBuffer(<span class="number">4</span>));</span><br><span class="line"><span class="keyword">const</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">100000</span>).fill(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">&#125;, <span class="number">1e3</span>);</span><br><span class="line">Atomics.wait(nil, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">Number</span>(<span class="number">600e3</span>));</span><br></pre></td></tr></table></figure><h4 id="➣-生命周期-LifeCycle-的实现">➣ 生命周期 LifeCycle 的实现</h4><p>代码同样很简单，有几点需要说明：</p><ol><li><p>采用了 <code>标记清除法</code>，子进程触发请求时更新调用时间，同时使用定时器循环计算各个被监听子进程的 ( 当前时间 - 上次调用时间) 差值。如果有超过设定的时间的进程则发送 <code>sleep</code> 信号，同时携带所有进程 pid。</p></li><li><p>每个 <code>ChildProcessPool</code> 进程池实例都会拥有一个 <code>ProcessLifeCycle</code> 实例对象用于控制当前进程池中的进程的 休眠/唤醒。<code>ChildProcessPool</code> 会监听 <code>ProcessLifeCycle</code> 对象的 <code>sleep</code> 事件，拿到需要 sleep 的进程 pid 后调用 <code>ForkedProcess</code> 的 <code>sleep()</code> 方法使其睡眠。下个请求分发到该进程时，会自动唤醒该进程。</p></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultLifecycle = &#123;</span><br><span class="line">  <span class="attr">expect</span>: <span class="number">600e3</span>, <span class="comment">// default timeout 10 minutes</span></span><br><span class="line">  <span class="attr">internal</span>: <span class="number">30e3</span> <span class="comment">// default loop check interval 30 seconds</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessLifeCycle</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      expect=defaultLifecycle.expect,</span><br><span class="line">      internal=defaultLifecycle.internal</span><br><span class="line">    &#125; = options;</span><br><span class="line">    <span class="built_in">this</span>.timer = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.internal = internal;</span><br><span class="line">    <span class="built_in">this</span>.expect = expect;</span><br><span class="line">    <span class="built_in">this</span>.params = &#123;</span><br><span class="line">      <span class="attr">activities</span>: <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* task check loop */</span></span><br><span class="line">  taskLoop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.timer) <span class="keyword">return</span> <span class="built_in">console</span>.warn(<span class="string">&#x27;ProcessLifeCycle: the task loop is already running&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> sleepTasks = [];</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">      <span class="keyword">const</span> &#123; activities &#125; = <span class="built_in">this</span>.params;</span><br><span class="line">      ([...activities.entries()]).map(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (date - value &gt; <span class="built_in">this</span>.expect) &#123;</span><br><span class="line">          sleepTasks.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (sleepTasks.length) &#123;</span><br><span class="line">        <span class="comment">// this.unwatch(sleepTasks);</span></span><br><span class="line">        <span class="built_in">this</span>.emit(<span class="string">&#x27;sleep&#x27;</span>, sleepTasks);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="built_in">this</span>.internal);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* watch processes */</span></span><br><span class="line">  watch = <span class="function">(<span class="params">ids=[]</span>) =&gt;</span> &#123;</span><br><span class="line">    ids.forEach(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.params.activities.set(id, <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* unwatch processes */</span></span><br><span class="line">  unwatch = <span class="function">(<span class="params">ids=[]</span>) =&gt;</span> &#123;</span><br><span class="line">    ids.forEach(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.params.activities.delete(id);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* stop task check loop */</span></span><br><span class="line">  stop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="built_in">this</span>.timer);</span><br><span class="line">    <span class="built_in">this</span>.timer = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* start task check loop */</span></span><br><span class="line">  start = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.taskLoop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* refresh tasks */</span></span><br><span class="line">  refresh = <span class="function">(<span class="params">ids=[]</span>) =&gt;</span> &#123;</span><br><span class="line">    ids.forEach(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.params.activities.has(id)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.params.activities.set(id, <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">`The task with id <span class="subst">$&#123;id&#125;</span> is not being watched.`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(ProcessLifeCycle, &#123; defaultLifecycle &#125;);</span><br></pre></td></tr></table></figure><h4 id="➣-进程互斥锁的雏形">➣ 进程互斥锁的雏形</h4><p>之前看文章时看到关于 API - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/wait">Atomic.wait</a> 的一篇文章，Atomic 除了用于实现进程睡眠，也能基于它来理解进程互斥锁的实现原理。这里有个<a href="https://github.com/nojsja/electron-re/blob/master/src/libs/AsyncLock.js">基本雏形</a>可以作为参考，相关文档可以参阅 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Atomics">MDN</a>。</p><p>AsyncLock 对象需要在子进程中引入，创建 AsyncLock 的构造函数中有一个参数 <code>sab</code> 需要注意。这个参数是一个 <code>SharedArrayBuffer</code> 共享数据块，这个共享数据快需要在主进程创建，然后通过 IPC 通信发送到各个子进程，通常 IPC 通信会序列化一般的诸如 Object / Array 等数据，导致消息接受者和消息发送者拿到的不是同一个对象，但是经由 IPC 发送的 <code>SharedArrayBuffer</code> 对象却会指向同一个内存块。</p><p>在子进程中使用 <code>SharedArrayBuffer</code> 数据创建 AsyncLock 实例后，任意一个子进程对共享数据的修改都会导致其它进程内指向这块内存的 <code>SharedArrayBuffer</code> 数据内容变化，这就是我们使用它实现进程锁的基本要点。</p><p>先对 <code>Atomic</code> API 做个简单说明：</p><ul><li><strong>Atomics.compareExchange(typedArray, index, expectedValue, newValue)</strong>：Atomics.compareExchange() 静态方法会在数组的值与期望值相等的时候，将给定的替换值替换掉数组上的值，然后返回旧值。此原子操作保证在写上修改的值之前不会发生其他写操作。</li><li><strong>Atomics.waitAsync(typedArray, index, value[, timeout])</strong>：静态方法 Atomics.wait() 确保了一个在 Int32Array 数组中给定位置的值没有发生变化且仍然是给定的值时进程将会睡眠，直到被唤醒或超时。该方法返回一个字符串，值为&quot;ok&quot;, “not-equal”, 或 “timed-out” 之一。</li><li><strong>Atomics.notify(typedArray, index[, count])</strong>：静态方法 Atomics.notify() 唤醒指定数量的在等待队列中休眠的进程，不指定 count 时默认唤醒所有。</li></ul><p>AsyncLock 即异步锁，等待锁释放的时候不会阻塞主线程。主要关注 <code>executeAfterLocked()</code> 这个方法，调用该方法并传入回调函数，该回调函数会在锁被获取后执行，并且在执行完毕后自动释放锁。其中一步的关键就是 <code>tryGetLock()</code> 函数，它返回了一个 <code>Promise</code> 对象，因此我们等待锁释放的逻辑在微任务队列中执行而并不阻塞主线程。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@name <span class="variable">AsyncLock</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment">  *   Use it in child processes, mutex lock logic.</span></span><br><span class="line"><span class="comment">  *   First create SharedArrayBuffer in main process and transfer it to all child processes to control the lock.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncLock</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> INDEX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">static</span> UNLOCKED = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">static</span> LOCKED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">sab</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sab = sab; <span class="comment">// data like this: const sab = new SharedArrayBuffer(16);</span></span><br><span class="line">    <span class="built_in">this</span>.i32a = <span class="keyword">new</span> <span class="built_in">Int32Array</span>(sab);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">lock</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldValue = Atomics.compareExchange(</span><br><span class="line">        <span class="built_in">this</span>.i32a, AsyncLock.INDEX,</span><br><span class="line">        AsyncLock.UNLOCKED, <span class="comment">// old</span></span><br><span class="line">        AsyncLock.LOCKED <span class="comment">// new</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (oldValue == AsyncLock.UNLOCKED) &#123; <span class="comment">// success</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Atomics.wait( <span class="comment">// wait</span></span><br><span class="line">        <span class="built_in">this</span>.i32a,</span><br><span class="line">        AsyncLock.INDEX,</span><br><span class="line">        AsyncLock.LOCKED <span class="comment">// expect</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">unlock</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = Atomics.compareExchange(</span><br><span class="line">      <span class="built_in">this</span>.i32a, AsyncLock.INDEX,</span><br><span class="line">      AsyncLock.LOCKED,</span><br><span class="line">      AsyncLock.UNLOCKED</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (oldValue != AsyncLock.LOCKED) &#123; <span class="comment">// failed</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Tried to unlock while not holding the mutex&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Atomics.notify(<span class="built_in">this</span>.i32a, AsyncLock.INDEX, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * executeLocked [async function to acquired the lock and execute callback]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>callback [callback function]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">executeAfterLocked</span>(<span class="params">callback</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> tryGetLock = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldValue = Atomics.compareExchange(</span><br><span class="line">          <span class="built_in">this</span>.i32a,</span><br><span class="line">          AsyncLock.INDEX,</span><br><span class="line">          AsyncLock.UNLOCKED,</span><br><span class="line">          AsyncLock.LOCKED</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oldValue == AsyncLock.UNLOCKED) &#123; <span class="comment">// success if AsyncLock.UNLOCKED</span></span><br><span class="line">          callback();</span><br><span class="line">          <span class="built_in">this</span>.unlock();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> result = Atomics.waitAsync( <span class="comment">// wait when AsyncLock.LOCKED</span></span><br><span class="line">          <span class="built_in">this</span>.i32a,</span><br><span class="line">          AsyncLock.INDEX,</span><br><span class="line">          AsyncLock.LOCKED</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">await</span> result.value; <span class="comment">// return a Promise, will not block the main thread</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tryGetLock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="VII-存在的已知问题">VII. 存在的已知问题</h3><hr><ol><li><p>由于使用了 Electron 原生的 <code>remote</code> API，因此 <code>electron-re</code> 部分特性(Service 相关)不支持 Electron 14 以及以上版本(已经移除 remote)，正考虑近期使用第三方 <code>remote</code> 库进行替代兼容。</p></li><li><p>容错处理做的不够好，这一块会成为之后的重要优化点。</p></li><li><p>采集进程池中活动连接数时采用了&quot;调用计数&quot;的方式。这个处理方法不太好，准确性也不够高，但是目前还未想到更好的解决方法用于统计子进程中活跃的连接数。我觉得还是要从底层进行解决，比如：宏任务和微任务队列、V8 虚拟机、垃圾回收、Libuv 底层原理、Node 进程和线程原理…</p></li><li><p>暂时没在 windows 平台测试进程休眠功能，win 平台本身不支持进程信号，但是 Node 提供了模拟支持，但是具体表现还需测试。</p></li></ol><h3 id="VIII-Next-To-Do">VIII. Next To Do</h3><hr><ul class="contains-task-list"><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 让 Service 支持代码更新后自动重启</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 添加 ChildProcessPool 子进程调度逻辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 优化 ChildProcessPool 多进程console输出</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 添加可视化进程管理界面</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 增强 ChildProcessPool 进程池功能</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 增强 ProcessHost 事务中心功能</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 子进程之间互斥锁逻辑的实现</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 使用外部 remote 库以支持最新版本的 Electron</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> <strong>Kill Bugs</strong> 🐛</label></li></ul><h3 id="IX-几个实际使用示例">IX. 几个实际使用示例</h3><hr><ol><li><p><a href="https://github.com/nojsja/electronux">electronux</a> - 我的一个Electron项目，使用了 <code>BrowserService/MessageChannel</code>，并且附带了<code>ChildProcessPool/ProcessHost</code>使用demo。</p></li><li><p><a href="https://github.com/nojsja/shadowsocks-electron">shadowsocks-electron</a> - 我的另一个Electron 跨平台桌面应用项目，使用 <code>electron-re</code> 进行调试开发，并且在生产环境下可以打开 <code>ProcessManager</code> UI 用于 CPU/Memory 资源占用监控和请求日志查看。</p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">file-slice-upload</a> - 一个关于多文件分片并行上传的demo，使用了 <code>ChildProcessPool</code> and <code>ProcessHost</code>，基于 Electron@9.3.5开发。</p></li><li><p>也可直接查看 <code>index.test.js</code> 和 <code>test</code> 目录下的测试样例文件，包含了一些使用示例。</p></li><li><p>当然 github - <a href="https://github.com/nojsja/electron-re">README</a> 也有相关说明项。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> node </tag>
            
            <tag> electron </tag>
            
            <tag> process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次 React hooks 组件开发和优化记录</title>
      <link href="/blogs/2021/11/29/adb1f235.html/"/>
      <url>/blogs/2021/11/29/adb1f235.html/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Contents">一、Contents</h2><ul><li><a href="#%E4%B8%80contents">一、Contents</a></li><li><a href="#%E4%BA%8C%E5%89%8D%E8%A8%80">二、前言</a></li><li><a href="#%E4%B8%89%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0">三、组件功能描述</a><ul><li><a href="#1-%E6%9F%A5%E7%9C%8B%E6%A8%A1%E5%BC%8F">1. 查看模式</a></li><li><a href="#2-%E7%BC%96%E8%BE%91%E6%A8%A1%E5%BC%8F">2. 编辑模式</a></li></ul></li><li><a href="#%E5%9B%9B%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86antd-form-%E7%BB%84%E4%BB%B6%E7%9A%84-initialvalues-%E5%92%8C-resetfields">四、预备知识：Antd Form 组件的 initialValues 和 resetFields</a><ul><li><a href="#i-%E5%B8%B8%E8%A7%81%E7%9A%84-antd-form-%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">I. 常见的 Antd Form 组件使用示例</a></li><li><a href="#ii-initialvalues-%E4%B8%8D%E6%9B%B4%E6%96%B0%E7%9A%84%E6%83%85%E5%86%B5">II. initialValues 不更新的情况</a></li></ul></li><li><a href="#%E4%BA%94%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B">五、开发过程</a><ul><li><a href="#i-%E6%BA%90%E7%A0%81">I. 源码</a></li><li><a href="#ii-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">II. 实现思路</a><ul><li><a href="#1-%E4%BD%BF%E7%94%A8-antd-table-%E7%BB%84%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%95%B4%E4%BD%93%E6%B8%B2%E6%9F%93">1. 使用 Antd Table 组件进行整体渲染</a></li><li><a href="#2-%E4%BD%BF%E7%94%A8-antd-form-%E7%BB%84%E4%BB%B6%E7%9A%84%E6%A0%A1%E9%AA%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E9%AA%8C%E8%AF%81%E5%AD%97%E6%AE%B5">2. 使用 Antd Form 组件的校验功能实现实时验证字段</a></li><li><a href="#3-%E4%BD%BF%E7%94%A8-react-quill-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BB%84%E4%BB%B6%E5%B1%95%E7%A4%BA%E5%92%8C%E7%BC%96%E8%BE%91%E5%AF%8C%E6%96%87%E6%9C%AC">3. 使用 react-quill 富文本组件展示和编辑富文本</a></li><li><a href="#4-%E7%BC%96%E8%BE%91%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%9F%A5%E7%9C%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2%E5%A4%84%E7%90%86">4. 编辑模式和查看模式的状态切换处理</a></li><li><a href="#5-%E5%85%A8%E9%80%89%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86">5. 全选模式的处理</a></li></ul></li><li><a href="#iii-%E7%BB%84%E4%BB%B6%E4%BC%98%E5%8C%96%E7%82%B9">III. 组件优化点</a><ul><li><a href="#1-%E4%BD%BF%E7%94%A8-reactmemo-%E5%87%8F%E5%B0%91%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BB%84%E4%BB%B6%E7%9A%84%E6%97%A0%E7%94%A8%E6%B8%B2%E6%9F%93">1. 使用 React.memo 减少富文本组件的无用渲染</a></li><li><a href="#2-%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0%E5%8E%BB%E6%8A%96%E5%90%88%E7%90%86%E5%8C%96%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BB%84%E4%BB%B6%E8%BE%93%E5%85%A5%E6%97%B6%E7%9A%84-onchange-%E5%9B%9E%E8%B0%83">2. 使用函数去抖合理化富文本组件输入时的 onChange 回调</a></li></ul></li></ul></li><li><a href="#%E5%85%AD%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E">六、写在最后</a></li></ul><h2 id="二、前言">二、前言</h2><p>最近在使用 hooks 开发业务组件的过程中，发现了一些值得记录的点，写这篇文章的目的是记下一些问题的解决思路，方便以后复盘。</p><h2 id="三、组件功能描述">三、组件功能描述</h2><p>需要实现一个可编辑表格组件，表格内部由输入框和富文本框组成，表格支持编辑和查看两种模式。点击编辑进入编辑模式，编辑模式中点击取消返回查看模式，同时重置已经输入的数据为编辑前的数据。编辑模式中点击保存会保存当前输入的数据，并退出编辑模式。</p><h3 id="1-查看模式">1. 查看模式</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/react/react-hooks1.png"  alt="react-hooks1.png"></p><h3 id="2-编辑模式">2. 编辑模式</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/react/react-hooks2.png"  alt="react-hooks2.png"></p><h2 id="四、预备知识：Antd-Form-组件的-initialValues-和-resetFields">四、预备知识：Antd Form 组件的 initialValues 和 resetFields</h2><p>Antd 表单组件中可以使用 initialValues 来设置表单的初始值，resetFields 来重置表单某些字段或全部字段的值。但是初始值只在第一次渲染的时候生效，不过可以配合 resetFields 来进行重置，以下示例描述了这个工作方式。</p><h3 id="I-常见的-Antd-Form-组件使用示例">I. 常见的 Antd Form 组件使用示例</h3><p>代码使用 hooks 方式创建了一个简单的表单组件，组件挂载时请求接口获取数据更新组件内部 state，并把更新后的 state作为表单初始值填充。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Form,</span><br><span class="line">  Input</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FormDemo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> [form] = Form.useForm();</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = useState(&#123;</span><br><span class="line">    <span class="attr">attr1</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">attr2</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [01] 根据关键数据进行表单重置</span></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    form.resetFields();</span><br><span class="line">  &#125;, [data]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [02] 组件挂载后获取关键数据用于表单渲染</span></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    request(<span class="string">&#x27;/url&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.code === <span class="number">200</span>) &#123;</span><br><span class="line">        setData(res.data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [03] 格式化默认值</span></span><br><span class="line">  <span class="keyword">const</span> getInitialValues = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">a</span>: data.attr1,</span><br><span class="line">      <span class="attr">b</span>: data.attr2</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Form</span> <span class="attr">form</span>=<span class="string">&#123;form&#125;</span> <span class="attr">initialValues</span>=<span class="string">&#123;getInitialValues(data)&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">label</span>=<span class="string">&quot;属性1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">name</span>=<span class="string">&quot;a&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">rules</span>=<span class="string">&#123;[&#123;</span> <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">message:</span> &#x27;必填项&#x27; &#125;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">wrapperCol</span>=<span class="string">&#123;&#123;</span> <span class="attr">span:</span> <span class="attr">22</span> &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">labelCol</span>=<span class="string">&#123;&#123;</span> <span class="attr">span:</span> <span class="attr">2</span> &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">labelAlign</span>=<span class="string">&quot;right&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        &gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="II-initialValues-不更新的情况">II. initialValues 不更新的情况</h3><p>上诉代码中要有一个 [01]步骤，如果不执行这一步的话会发现在组件挂载后发送请求拿到数据更新内部 state 之后，Form 表单的 属性1 不会更新，仍然会使用刚开始的初始值 ''即空值。</p><p>其实 Form 组件的 initialValues 设计就是为了只使用最开始传入组件的默认初始值，后续如果初始值改变，并不会让组件重新渲染。只不过这里有个小技巧就是：Form 组件其实每次都能察觉到我们已经更新了初始值 initialValues，虽然不会实时更新，但是只要在合适的时机执行 form.resetFields() 就可以用最新的初始值重新初始化表单组件。</p><p>合适的时机比如：表单依赖的数据更新(可以使用上述 useEffect进行监听)、Modal 弹窗组件的显示/隐藏状态切换… 等等。</p><p>如果不使用这个小技巧，那么当我们需要重新设置默认值给表单时可以：</p><ul><li>先销毁表单组件，一个例子是弹窗 Modal 隐藏后卸载 Modal 组件，不过这样会可能引起弹窗隐藏过于生硬(不推荐)。</li><li>使用 form.setFieldsValue 强制更新表单各个字段的值，这种情况需要注意用户已经在表单中填入的默认值的处理。</li></ul><h2 id="五、开发过程">五、开发过程</h2><h3 id="I-源码">I. 源码</h3><ul><li><p><a href="https://github.com/nojsja/react-nojsja/tree/master/components/QuoteAddition">源码1：可编辑表格</a></p></li><li><p><a href="https://github.com/nojsja/react-nojsja/tree/master/components/QuillEditorWrapper">源码2：表格中的的富文本组件</a></p></li></ul><h3 id="II-实现思路">II. 实现思路</h3><blockquote><p>业务基于 Antd 开发</p></blockquote><p>组件内部使用 hooks - useState 存储两种状态，查看模式(edit)和编辑模式(view)。点击按钮时切换到相应状态，然后使用已保存的数据重新渲染表格。</p><h4 id="1-使用-Antd-Table-组件进行整体渲染">1. 使用 Antd Table 组件进行整体渲染</h4><p>表格的渲染分为表格自身的渲染和表格内容的渲染，这一点是基于 Antd 的 Table 组件自身的设计。不过由于我们引入了一些外部状态用于控制表格组件的展示状态比如：编辑状态、保存状态、全选状态，因此用于控制这些值的 state 更新时需要我们重新调用函数获取渲染参数并重新渲染表格。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; value, disabled &#125; = props;</span><br><span class="line">  <span class="comment">// 用于表格列中的数据渲染</span></span><br><span class="line">  <span class="keyword">const</span> [tableData, setTableData] = useState(value);</span><br><span class="line">  <span class="comment">// 用于表格列渲染</span></span><br><span class="line">  <span class="keyword">const</span> [columns, setColumns] = useState([]);</span><br><span class="line">  <span class="comment">// 用于控制表格组件的展示状态</span></span><br><span class="line">  <span class="keyword">const</span> [status, setStatus] = useState(<span class="string">&#x27;view&#x27;</span>);</span><br><span class="line">  <span class="comment">// 用于控制表格组件的全选状态</span></span><br><span class="line">  <span class="keyword">const</span> [allChecked, setAllChecked] = useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isEdit = status === <span class="string">&#x27;edit&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> isView = status === <span class="string">&#x27;view&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 状态改变时重新渲染表格列</span></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    setColumns(</span><br><span class="line">      getColumns(&#123;</span><br><span class="line">        <span class="attr">rows</span>: fullKeys,</span><br><span class="line">        onTableChange,</span><br><span class="line">        <span class="attr">setAllChecked</span>: setAllCheckedAction,</span><br><span class="line">        allChecked,</span><br><span class="line">        <span class="attr">disabled</span>: isView,</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;, [disabled, isView, allChecked]);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;props.className&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        &#123;!disabled &amp;&amp; (</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;status === &#x27;view&#x27; &amp;&amp; (</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">Button</span> <span class="attr">disabled</span>=<span class="string">&#123;disabled&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;setEdit&#125;</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                编辑</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">            &#123;status === &#x27;edit&#x27; &amp;&amp; (</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">className</span>=<span class="string">&#123;style[</span>&#x27;<span class="attr">margin__right__12</span>&#x27;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">disabled</span>=<span class="string">&#123;disabled&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">onClick</span>=<span class="string">&#123;saveEdit&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                &gt;</span></span></span><br><span class="line"><span class="xml">                  保存</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Button</span> <span class="attr">disabled</span>=<span class="string">&#123;disabled&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;cancelEdit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                  取消</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">        )&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">Form</span> <span class="attr">form</span>=<span class="string">&#123;form&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Table</span> <span class="attr">columns</span>=<span class="string">&#123;columns&#125;</span> <span class="attr">dataSource</span>=<span class="string">&#123;tableData&#125;</span> <span class="attr">pagination</span>=<span class="string">&#123;false&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-使用-Antd-Form-组件的校验功能实现实时验证字段">2. 使用 Antd Form 组件的校验功能实现实时验证字段</h4><p>因为要实现字段编辑实时校验功能，可以使用 Form 组件配合 Table 组件，Form.FormItem 自带字段验证功能：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/react/react-hooks3.png"  alt="react-hooks3.png"></p><p>因此在生成表格列的函数 getColumns 中需要使用 Form.FormItem 进行组件包裹，注意的是每个 Form.Item 都需要有唯一的 name 属性，否则不会触发字段验证功能：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 实时共享值</span></span><br><span class="line"><span class="keyword">import</span> &#123; computeValues &#125; <span class="keyword">from</span> <span class="string">&#x27;../index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> props =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; onTableChange, setAllChecked, allChecked, disabled, rows = keys &#125; = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> columns = &#123;</span><br><span class="line">    <span class="comment">/* 表格中一列数据声明示例 */</span></span><br><span class="line">    <span class="attr">insureFeeRate</span>: &#123;</span><br><span class="line">      <span class="comment">// 表格头</span></span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;费率&#x27;</span>,</span><br><span class="line">      <span class="attr">dataIndex</span>: <span class="string">&#x27;insureFeeRate&#x27;</span>,</span><br><span class="line">      <span class="attr">key</span>: <span class="string">&#x27;insureFeeRate&#x27;</span>,</span><br><span class="line">      <span class="comment">// 表格列数据</span></span><br><span class="line">      <span class="attr">render</span>: <span class="function">(<span class="params">value, data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          <span class="xml"><span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">name</span>=<span class="string">&#123;</span>`<span class="attr">insureFeeRate_</span>$&#123;<span class="attr">data.id</span>&#125;`&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            // 校验字段</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">rules</span>=<span class="string">&#123;[</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              (&#123; <span class="attr">getFieldValue</span> &#125;) =&gt;</span> (&#123;</span></span><br><span class="line"><span class="xml">                validator(rule, value) &#123;</span></span><br><span class="line"><span class="xml">                  const now = computeValues.value ? computeValues.value[data.id] : false;</span></span><br><span class="line"><span class="xml">                  console.log(&#x27;validator&#x27;);</span></span><br><span class="line"><span class="xml">                  if (now &amp;&amp; now.acceptInsurance) &#123;</span></span><br><span class="line"><span class="xml">                    if (!costRateReg.test(now.insureFeeRate)) &#123;</span></span><br><span class="line"><span class="xml">                      return Promise.reject(new Error(&#x27;承保费率值为十万分之一到1之间的数&#x27;));</span></span><br><span class="line"><span class="xml">                    &#125;</span></span><br><span class="line"><span class="xml">                  &#125;</span></span><br><span class="line"><span class="xml">                  return Promise.resolve();</span></span><br><span class="line"><span class="xml">                &#125;,</span></span><br><span class="line"><span class="xml">              &#125;),</span></span><br><span class="line"><span class="xml">            ]&#125;</span></span><br><span class="line"><span class="xml">          &gt;</span></span><br><span class="line"><span class="xml">            &#123;!disabled ? (</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">InputNumber</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">step</span>=<span class="string">&#123;0.01&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">disabled</span>=<span class="string">&#123;disabled&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">onChange</span>=<span class="string">&#123;value</span> =&gt;</span> onTableChange(&#x27;insureFeeRate&#x27;, value, data)&#125;</span></span><br><span class="line"><span class="xml">                defaultValue=&#123;value&#125;</span></span><br><span class="line"><span class="xml">              /&gt;</span></span><br><span class="line"><span class="xml">            ) : (</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;data.insureFeeRate&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">return</span> <span class="built_in">Object</span>.keys(columns).map(<span class="function"><span class="params">item</span> =&gt;</span> columns[item]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-使用-react-quill-富文本组件展示和编辑富文本">3. 使用 react-quill 富文本组件展示和编辑富文本</h4><p>react-quill 是富文本组件 quill 基于 react 封装的一个开源组件，支持 react 式声明调用。value 和 onChange 是这个组件的数据接收和数据回调外部接口。其实一般的 Form.Item 自定义组件也是这个原理，只要自定义组件中在合适的时机调用父级传入的 onChange 就能让自定义组件和表单组件按照预期工作。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useCallback &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> QuillEditor <span class="keyword">from</span> <span class="string">&#x27;react-quill&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;react-quill/dist/quill.snow.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Editor = React.memo(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">QuillEditor</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      &#123;<span class="attr">...</span>&#123;</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">...props</span>,</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">value:</span> <span class="attr">props.value.current</span> || &#x27;&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">onChange:</span> <span class="attr">value</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="xml">          props.onChange.current(value);</span></span><br><span class="line"><span class="xml">        &#125;,</span></span><br><span class="line"><span class="xml">      &#125;&#125;</span></span><br><span class="line"><span class="xml">    /&gt;</span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="4-编辑模式和查看模式的状态切换处理">4. 编辑模式和查看模式的状态切换处理</h4><p>由于编辑模式可以临时取消，取消后未保存的数据可以重置到编辑前的状态，可以使用 Form 组件实例的 resetFields 方式将表格组件状态重置即可。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="comment">// 取消编辑</span></span><br><span class="line">  <span class="keyword">const</span> cancelEdit = <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    setStatus(<span class="string">&#x27;view&#x27;</span>);</span><br><span class="line">    editValues.delete(id);</span><br><span class="line">    getComputeValues(editValues, id);</span><br><span class="line">    form.resetFields();</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>考虑到编辑中的表格输入组件无须追踪数据输入状态，只需要在最后保存的时候提交组件内部实时缓存的编辑数据即可，因此表格组件设计为非完全受控组件。体现就是编辑中的表格输入时 onChange 触发的值只会被保存到 React 组件外部一个对象中，这个对象的更新不会引发组件重复渲染。</p><p>注意看下面我们同时使用 export 关键字将这个对象导出，这样子设计后有一个方便之处就是我们在 getColumns (获取最新的表格列渲染数据) 中可以读取实时缓存的编辑数据，而不会陷入 React Hooks 组件的闭包陷进中，因为我们知道 Hooks 组件的每次渲染过程中各个声明的函数只会读取当前这次渲染的数据，这样可能引发延迟更新的问题。</p><p>同时为了在 getColumns 函数中不重复计算一些值，我使用 <code>getComputeValues(editValues, id)</code> 在 editValues 更新的时候手动生成一个计算值以供 getColumns 使用，它的具体使用可以查看 <code>5.全选模式的处理</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 组件外部的数据缓存</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> editValues = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> computeValues = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getComputeValues = <span class="function">(<span class="params">values, id</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (values.get(id) &amp;&amp; values.get(id).length) &#123;</span><br><span class="line">    computeValues.set(</span><br><span class="line">      id,</span><br><span class="line">      values.get(id).reduce(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</span><br><span class="line">        pre[cur.id] = cur;</span><br><span class="line">        <span class="keyword">return</span> pre;</span><br><span class="line">      &#125;, &#123;&#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    computeValues.delete(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 组件</span></span><br></pre></td></tr></table></figure><h4 id="5-全选模式的处理">5. 全选模式的处理</h4><p>全选模式即我们在编辑模式中选择全选可以全部选中表格中的某一列，由于之前提到表格内部组件并非处于完全受控模式中，因此当触发全选操作的时候，我们需要设置 allChecked 属性，然后使用 useEffect 监听 allChecked 属性的更新，触发表格列的重新渲染即可。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/react/react-hooks4.png"  alt="react-hooks4.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 编辑状态改变时重新渲染表格列表</span></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    setColumns(</span><br><span class="line">      getColumns(&#123;</span><br><span class="line">        <span class="attr">rows</span>: fullKeys,</span><br><span class="line">        onTableChange,</span><br><span class="line">        <span class="attr">setAllChecked</span>: setAllCheckedAction,</span><br><span class="line">        allChecked,</span><br><span class="line">        <span class="attr">disabled</span>: isView,</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;, [disabled, isView, allChecked]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择所有承保项</span></span><br><span class="line">  <span class="keyword">const</span> setAllCheckedAction = <span class="function"><span class="params">status</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (editValues.has(id)) &#123;</span><br><span class="line">      editValues.set(</span><br><span class="line">        id,</span><br><span class="line">        editValues.get(id).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          item.acceptInsurance = status;</span><br><span class="line">          <span class="keyword">return</span> item;</span><br><span class="line">        &#125;),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    setAllChecked(status);</span><br><span class="line">    getComputeValues(editValues, id);</span><br><span class="line">    <span class="keyword">if</span> (editValues.has(id)) &#123;</span><br><span class="line">      form.resetFields(editValues.get(id).map(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`acceptInsurance_<span class="subst">$&#123;item.id&#125;</span>`</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>值得注意的是，即使重新渲染了表格列仍然之前未被勾选的列仍然不会切换为勾选状态，这是 Form.Item 组件的 defaultValue 的渲染机制造成的，我们需要使用 <code>form.resetFields</code> 重置被勾选列的状态，然后 Form.Item 组件会使用最新的勾选状态重新初始化组件，现在组件状态就正常了。</p><h3 id="III-组件优化点">III. 组件优化点</h3><p>可编辑表格组件中有很多富文本组件作为多个单独的单元格进行渲染，如果不使用 React.memo 组件进行缓存优化的话，表格组件的多次更新会造成无用的富文本组件的重新创建和渲染，会造成无用的渲染，数据量过大时会存在性能问题。</p><p>因此这里我们使用自定义 React hooks 组件对原生的 react-quill 组件进行一层包裹，在组件内部通过 useRef、useCallback hooks 以及 React.memo 组件进行缓存优化，这样就可以避免每次渲染都重新创建富文本组件，从而提高性能。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/react/react-hooks1.png"  alt="react-hooks1.png"></p><p>整个组件实现代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useCallback &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> QuillEditor <span class="keyword">from</span> <span class="string">&#x27;react-quill&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;react-quill/dist/quill.snow.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; quillEmptyReg &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/validator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;@/pages/index.less&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; debounce &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editorModules = &#123;</span><br><span class="line">  <span class="attr">toolbar</span>: [</span><br><span class="line">    [&#123; <span class="attr">header</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="literal">false</span>] &#125;],</span><br><span class="line">    [<span class="string">&#x27;bold&#x27;</span>, <span class="string">&#x27;italic&#x27;</span>, <span class="string">&#x27;underline&#x27;</span>, <span class="string">&#x27;strike&#x27;</span>, <span class="string">&#x27;blockquote&#x27;</span>],</span><br><span class="line">    [&#123; <span class="attr">list</span>: <span class="string">&#x27;ordered&#x27;</span> &#125;, &#123; <span class="attr">list</span>: <span class="string">&#x27;bullet&#x27;</span> &#125;, &#123; <span class="attr">indent</span>: <span class="string">&#x27;-1&#x27;</span> &#125;, &#123; <span class="attr">indent</span>: <span class="string">&#x27;+1&#x27;</span> &#125;],</span><br><span class="line">    [&#123; <span class="attr">color</span>: [] &#125;, &#123; <span class="attr">background</span>: [] &#125;],</span><br><span class="line">    [<span class="string">&#x27;link&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;clean&#x27;</span>],</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Editor = React.memo(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Editor Render&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">QuillEditor</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      &#123;<span class="attr">...</span>&#123;</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">...props</span>,</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">value:</span> <span class="attr">props.value.current</span> || &#x27;&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">onChange:</span> <span class="attr">value</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="xml">          props.onChange.current(value);</span></span><br><span class="line"><span class="xml">        &#125;,</span></span><br><span class="line"><span class="xml">      &#125;&#125;</span></span><br><span class="line"><span class="xml">    /&gt;</span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; disabled, name, ...others &#125; = props;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用不可变对象同步 Editor.onChange 的正确指向</span></span><br><span class="line">  <span class="keyword">const</span> editorRef = React.useRef();</span><br><span class="line">  <span class="comment">// 使用不可变对象同步去抖函数内 onChange 的正确指向</span></span><br><span class="line">  <span class="keyword">const</span> fnRef = React.useRef();</span><br><span class="line">  <span class="comment">// 使用不可变对象不会触发编辑器组件的重复渲染</span></span><br><span class="line">  <span class="keyword">const</span> valueRef = React.useRef(props.value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 去抖函数用于快速输入字符时造成编辑器组件重渲染的卡顿优化</span></span><br><span class="line">  <span class="keyword">const</span> debounceChange = useCallback(debounce(<span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    fnRef.current(...args);</span><br><span class="line">  &#125;, <span class="number">300</span>), []);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于传入的编辑器文本变化时更新内部独立状态</span></span><br><span class="line">  useEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (props.value &amp;&amp; (props.value !== valueRef.current)) &#123;</span><br><span class="line">      valueRef.current = props.value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [props.value]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每次渲染时更新各个不可变对象的正确指向</span></span><br><span class="line">  fnRef.current = props.onChange;</span><br><span class="line">  editorRef.current = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = quillEmptyReg.test(value) ? <span class="string">&#x27;&#x27;</span> : value;</span><br><span class="line">    valueRef.current = data;</span><br><span class="line">    <span class="keyword">if</span> (props.onChange) &#123;</span><br><span class="line">      debounceChange(data, name)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Editor</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      &#123;<span class="attr">...others</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">theme</span>=<span class="string">&quot;snow&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">modules</span>=<span class="string">&#123;editorModules&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">value</span>=<span class="string">&#123;valueRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">className</span>=<span class="string">&#123;style[</span>&#x27;<span class="attr">editor__minheight__200</span>&#x27;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">      &#123;<span class="attr">...</span>(<span class="attr">disabled</span> ? &#123; <span class="attr">readOnly:</span> <span class="attr">true</span> &#125; <span class="attr">:</span> &#123; <span class="attr">readOnly:</span> <span class="attr">false</span> &#125;)&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">onChange</span>=<span class="string">&#123;editorRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    /&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-使用-React-memo-减少富文本组件的无用渲染">1. 使用 React.memo 减少富文本组件的无用渲染</h4><p>React.memo 包裹的组件会对每次传入的 props 做一次浅比较，如果 props 不变，则不会重新创建组件，这在优化富文本这种复杂组件中比较适合，如果是一些简单的展示组件反而不推荐使用 React.memo。</p><p>相对的使用了 React.memo 但是如果每次外层组件更新的时候我们没有保证不该变化的 props 属性不发生变化，这样子 React.memo 将毫无效果，甚至会造成负优化。</p><p>所谓的不该变化的 props 属性，这个组件中有这样几个属性可以认为是不该变化的：</p><p>1）onChange 回调执行函数</p><p>使用 useRef 生成不可变对象 editorRef 以替换原来的回调函数，每次只更新不可变函数的 current 属性用于指向最新的回调方法。位于 React.memo 包裹的内层富文本组件中使用 editorRef.current 来调用回调函数。</p><p>2）value 编辑器的内容字符</p><p>通常 value 属于一个受控属性，它的值的变化会触发组件的重新渲染。不过我们这个组件的实现中，Editor 组件无需采用完全受控的模式，因为在 Editor 组件中我们只关注输入时是否调用了外部的 onChange 函数来同步组件内部和外部值以保证数据一致，而无须将 Editor 的内部状态交由 props 传入的 value 控制，实际内部状态是由操作者的键盘作为输入源进行控制的。</p><p>如果不进行这个优化处理，组件在每次输入值的时候就会重新渲染自身，在界面上的表现就是如果一直按住某个按键不放，富文本输入框会暂时卡住，松手后，组件才会正常显示最终值。使用 useRef 优化传入值后，我们一直安装某个键，富文本输入框中的字符也会持续的将最新输入的字符显示到输入框中，而不会卡住。</p><p>3）editorModules 富文本静态配置对象</p><p>配置对象应该为一个静态不变对象，直接将其放入 React 组件外部，让组件在内层作用域借用作用域查找直接引用最外层的对象即可。</p><h4 id="2-使用函数去抖合理化富文本组件输入时的-onChange-回调">2. 使用函数去抖合理化富文本组件输入时的 onChange 回调</h4><p>想象用户在输入字符到富文本的过程中，短时间持续的输入字符会导致 onChange 事件在短时间内被多次触发。其实这是没有必要的，只需关注用户在短时间的快速输入之后，捕获最后富文本输入框中的字符内容然后调用 onChange 回调函数即可。这样即保证数据的一致性，也控制了组件合理的回调时机。</p><p>根据优化规则，可以简单的想到使用函数去抖和函数节流思想进行优化，这里使用函数去抖的思想，只采集在一段时间内持续输入的最终值。如果使用函数节流的话，效果是根据编程指定的时间间隔来触发回调函数，维持函数的触发频率，防止短时间内过度调用影响界面性能。</p><p>以下是函数去抖(debounce)和函数节流(throttle)的简单实现，具体使用的话可以参考上面的示例，示例中也使用了 useCallback 和 useRef 来防止 throttle 高阶函数的在每一次渲染时重复创建和绑定：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 节流函数 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> throttle = <span class="function">(<span class="params">fn, delay</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="keyword">return</span>;</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      fn.apply(<span class="built_in">this</span>, args);</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 去抖函数 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> debounce = <span class="function">(<span class="params">fn, delay</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    &#125;</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      fn.apply(<span class="built_in">this</span>, args);</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="六、写在最后">六、写在最后</h2><p>这个组件编写过程中还是学到了挺多，比如 ES module 中 export 的变量是可以在其它模块读取的，而 commonJs 中的表现是完全不同的，它采用的是值复制，并不会进行变量引用和共享。同时对 useRef、React.memo、useCallback 等的使用也更加深刻了。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
            <tag> hooks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shadowsocks 跨平台客户端开发日记</title>
      <link href="/blogs/2021/10/04/5384287.html/"/>
      <url>/blogs/2021/10/04/5384287.html/</url>
      
        <content type="html"><![CDATA[<p><a href="https://nojsja.gitee.io/blogs/2021/10/04/5384287.html/">&gt;&gt;&gt; 博客原文</a></p><h2 id="Preface">Preface</h2><blockquote><p>前言</p></blockquote><p>最近闲逛 github 时看到一个 <code>shadowsocks-electron</code> 项目，该工具支持 Linux / Mac 平台，是用来连接 shadowsocks 服务器的 proxy✈️，程序员应该大多都用过，各个平台也都有适配客户端。原作者使用 <code>Typescript/Electron</code> 把功能开发了一部分就没有维护了，只支持了基本的：添加、修改、连接、删除 proxy 和设置功能，开机自启也只适配了 Mac。</p><p>由于最近在学习 <code>Typescript</code> 语言苦于没有实践机会，加之我自己的 Ubuntu20.04 操作系统运行 <code>electron-ssr</code> 老有问题(可以使用很久没有维护已经下架官方软件源的<code>Shadowsocks-QT</code>进行替代🤣)，所以萌生了自己接盘进行开发的想法，然后就是 fork -&gt; clone -&gt; dev(day after day) -&gt; compile -&gt; push 一顿操作。</p><blockquote><p>github仓库：<a href="https://github.com/nojsja/shadowsocks-electron">shadowsocks-electron</a></p></blockquote><h2 id="Prevew">Prevew</h2><blockquote><p>预览</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/main.png"  alt="main"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/settings.png"  alt="settings"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/add_server.png"  alt="add_server"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/server_config.png"  alt="server_config"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/share.png"  alt="share"></p><h2 id="Contents">Contents</h2><blockquote><p>目录</p></blockquote><ul><li><a href="#preface">Preface</a></li><li><a href="#prevew">Prevew</a></li><li><a href="#contents">Contents</a></li><li><a href="#tools--technology">Tools &amp; Technology</a><ul><li><a href="#1-%E4%BD%8E%E9%85%8D%E7%BD%AE%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83react-app-rewired">1. 低配置快速启动前端开发环境：react-app-rewired</a></li><li><a href="#2-%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%94%B9%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AFnodemon">2. 代码更改自动重启：nodemon</a></li><li><a href="#3-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96redux-persistredux-persist-electron-storage">3. 数据持久化：redux-persist/redux-persist-electron-storage</a></li><li><a href="#4-%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85electron-builder">4. 项目打包：electron-builder</a></li><li><a href="#5-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86winston">5. 客户端运行日志管理：winston</a></li></ul></li><li><a href="#core-functions">Core Functions</a><ul><li><a href="#1-%E8%A7%A3%E6%9E%90-shadowsocks-%E4%B8%93%E7%94%A8%E5%8A%A0%E5%AF%86%E9%93%BE%E6%8E%A5">1. 解析 Shadowsocks 专用加密链接</a></li><li><a href="#2-%E5%B0%86%E5%B7%B2%E6%9C%89%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%9B%BE%E7%89%87%E8%BF%9B%E8%A1%8C%E5%88%86%E4%BA%AB">2. 将已有的服务器配置生成二维码图片进行分享</a></li><li><a href="#3-%E8%AF%BB%E5%8F%96%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AF%BC%E5%85%A5-shadowsocks-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE">3. 读取二维码导入 Shadowsocks 服务器配置</a></li><li><a href="#4-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B-shadowsocks-libev-%E5%BA%93%E7%9A%84%E4%BE%9D%E8%B5%96%E5%A4%84%E7%90%86">4. 多平台功能适配之 <code>shadowsocks-libev</code> 库的依赖处理</a></li><li><a href="#5-electron-%E8%B0%83%E7%94%A8-shadowsocks-libev-%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8">5. Electron 调用 <code>shadowsocks-libev</code> 库连接服务器</a></li><li><a href="#6-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy-%E5%92%8C-pac-%E6%9C%8D%E5%8A%A1">6. 多平台功能适配之设置系统 proxy 和 pac 服务</a><ul><li><a href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-proxy">设置系统 proxy</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F-pac-%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80">设置系统 pac 文件地址</a></li></ul></li><li><a href="#7-%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%8A%9F%E8%83%BD%E9%80%82%E9%85%8D%E4%B9%8B%E5%BA%94%E7%94%A8%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8">7. 多平台功能适配之应用开机自启动</a></li><li><a href="#8-%E4%BD%BF%E7%94%A8-electron-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%99%A8%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95%E6%95%88%E7%8E%87">8. 使用 Electron 进程管理器提高开发调试效率</a></li></ul></li><li><a href="#others">Others</a><ul><li><a href="#1-mac-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9C%9F%E6%98%AF%E9%9A%BE%E8%A3%85">1. Mac 虚拟机真是难装</a></li><li><a href="#2-mac-brew-%E5%9C%A8%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F">2. Mac brew 在国内环境的安装方式</a></li><li><a href="#3-nodejs-childprocess-%E6%89%A7%E8%A1%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91">3. Node.js child_process 执行二进制文件的一些坑</a></li><li><a href="#4-%E6%80%8E%E6%A0%B7%E4%B8%BA%E6%9C%AA%E9%80%82%E9%85%8D-typescript-%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85%E7%BC%96%E5%86%99-types-%E5%A3%B0%E6%98%8E">4. 怎样为未适配 Typescript 的第三方包编写 @types 声明</a></li><li><a href="#5-%E6%84%9F%E8%B0%A2%E4%BD%9C%E4%B8%BA-ui-%E8%AE%BE%E8%AE%A1%E5%B8%88%E7%9A%84-gf-%E5%80%BE%E6%83%85%E6%94%AF%E6%8C%81">5. 感谢作为 UI 设计师的 GF 倾情支持</a></li><li><a href="#6-%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB">6. 延伸阅读</a></li></ul></li><li><a href="#final">Final</a></li></ul><h2 id="Tools-Technology">Tools &amp; Technology</h2><blockquote><p>工具和技术</p></blockquote><p>项目基于 <code>Typescript@3.8.3</code> / <code>React@16.13.1</code> / <code>MaterialUI@4.9.8</code> / <code>Electron@13.4.0</code></p><h3 id="1-低配置快速启动前端开发环境：react-app-rewired">1. 低配置快速启动前端开发环境：react-app-rewired</h3><p>此工具可以在不 ‘eject’ 也不创建额外 react-scripts 的情况下修改 create-react-app 内置的 webpack 配置，然后你将拥有 create-react-app 的一切特性，且可以根据你的需要去配置 webpack 的 plugins, loaders 等。</p><p>通过 npm 安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install react-app-rewired --save-dev</span><br></pre></td></tr></table></figure><p>根目录中创建一个 config-overrides.js 参考官方说明进行配置，注意 npm 上也有很多基于 <code>react-app-rewired</code> 的专用插件用于分离解决各个原子化功能，可以自行探索哦。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  override,</span><br><span class="line">  useBabelRc,</span><br><span class="line">  removeModuleScopePlugin,</span><br><span class="line">  babelInclude,</span><br><span class="line">  setWebpackTarget</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;customize-cra&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> rewireSvgReactLoader = <span class="built_in">require</span>(<span class="string">&#x27;react-app-rewire-svg-react-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">webpack</span>: override(</span><br><span class="line">    <span class="comment">// bab el</span></span><br><span class="line">    useBabelRc(),</span><br><span class="line">    <span class="comment">// svg loader</span></span><br><span class="line">    <span class="function">(<span class="params">config, env</span>) =&gt;</span> &#123;</span><br><span class="line">      config = rewireSvgReactLoader(config, env);</span><br><span class="line">      <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    removeModuleScopePlugin(),</span><br><span class="line">    babelInclude([path.resolve(<span class="string">&quot;renderer&quot;</span>)]),</span><br><span class="line">    <span class="comment">// render target</span></span><br><span class="line">    setWebpackTarget(<span class="string">&quot;electron-renderer&quot;</span>)</span><br><span class="line">  ),</span><br><span class="line">  <span class="attr">paths</span>: <span class="function"><span class="keyword">function</span>(<span class="params">paths, env</span>) </span>&#123;</span><br><span class="line">    paths.appIndexJs = path.resolve(__dirname, <span class="string">&quot;renderer/index.tsx&quot;</span>);</span><br><span class="line">    paths.appSrc = path.resolve(__dirname, <span class="string">&quot;renderer&quot;</span>);</span><br><span class="line">    paths.appTypeDeclarations = path.resolve(</span><br><span class="line">      __dirname,</span><br><span class="line">      <span class="string">&quot;renderer/react-app-env.d.ts&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> paths;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-代码更改自动重启：nodemon">2. 代码更改自动重启：nodemon</h3><p>在开发 Node.js 项目时我经常用它来监听文件更改然后自动重启应用，Electron 应用中也可以使用。在 <code>package.json</code> 中配置相关的字段然后让 <code>nodemon</code> 监听主进程代码并进行 Typescript 实时编译和 Electron 主进程重启。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;shadowsocks-electron&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start:main&quot;</span>: <span class="string">&quot;nodemon&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;nodemonConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;watch&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;main&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;ignore&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;main/types/**/*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;ext&quot;</span>: <span class="string">&quot;ts,json&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;exec&quot;</span>: <span class="string">&quot;yarn build:main &amp;&amp; electron .&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-数据持久化：redux-persist-redux-persist-electron-storage">3. 数据持久化：redux-persist/redux-persist-electron-storage</h3><p>Electron 应用常常涉及一些持久化数据的功能，比如在 <code>shadowsocks-electron</code> 中的服务器配置读写、日志保存和用户设置保存等。之前在开发一个类似百度网盘的文件上传功能时，需要保存文件上传记录，当时选用了 <code>lowdb</code> 进行支持，它是一种 JSON 文件数据库，提供类似数据库的功能但是使用 JSON 字符串进行明文存储。这种存储方式性能自然很一般，不过已经能满足至多保存 5000 条上传记录的需求了。</p><p>由于类似 <code>lowdb</code> 这种工具只能在 Electron 主进程端进行操作，因为 UI 渲染进程和主进程的数据同步操作就会显得格外冗余。</p><p>为了简化数据交互并能达到持久化存储的目的，可以选用 <code>redux-persist</code> 为解决方案。引入之后它可以和 Redux 状态管理库无缝配合，无需手动触发多余的数据存取操作。我们只需要在前端代码中关注 Reducer 和 Action 的编写即可，所有的持久化操作都是透明不可见的。</p><p><code>redux-persist</code> 底层依赖了 Electron 渲染进程原生的 <code>remote</code> 远程调用进行实现，前端 store 中的数据最终会被存放到 Electron 进程运行路径下的某个文件里，应用开启的时候这些数据又会从文件中读取到 store中。</p><p>不过正是由于 <code>redux-persist</code> 采用了 <code>remote</code> 远程调用这种通信方式，导致我的应用不能使用最新发布的 Electron 版本，转而使用支持 <code>remote</code> API 的 13.4.0 版本。我看了一下它的 github 仓库，README 中说现在是无人维护的状态，希望有开源爱好者用爱发电自行维护。其实要去解决的话也有办法，虽然 Electron 官方移除了这个 API，但是可以通过安装第三方包 <code>@electron/remote/main</code> 来支持。</p><p>废话不多说，以下是 <code>redux-persist</code> 的简单配置使用：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* store.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Store <span class="keyword">from</span> <span class="string">&#x27;electron-store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; persistReducer, persistStore, PersistConfig &#125; <span class="keyword">from</span> <span class="string">&quot;redux-persist&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> autoMergeLevel2 <span class="keyword">from</span> <span class="string">&quot;redux-persist/lib/stateReconciler/autoMergeLevel2&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> createElectronStorage <span class="keyword">from</span> <span class="string">&quot;redux-persist-electron-storage&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">&quot;./reducers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RootState &#125; <span class="keyword">from</span> <span class="string">&quot;../types&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> persistConfig: PersistConfig&lt;RootState&gt; = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">storage</span>: createElectronStorage(&#123;</span><br><span class="line">    <span class="attr">electronStore</span>: <span class="keyword">new</span> Store()</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">stateReconciler</span>: autoMergeLevel2,</span><br><span class="line">  <span class="attr">blacklist</span>: [<span class="string">&quot;status&quot;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> persistedReducer = persistReducer(persistConfig, rootReducer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(</span><br><span class="line">  persistedReducer,</span><br><span class="line">  compose(</span><br><span class="line">    applyMiddleware(thunk),</span><br><span class="line">    (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).devToolsExtension ? (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).devToolsExtension() : <span class="function">(<span class="params">f: <span class="built_in">any</span></span>) =&gt;</span> f</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> persistor = persistStore(store <span class="keyword">as</span> <span class="built_in">any</span>);</span><br></pre></td></tr></table></figure><p>在 <code>App.tsx</code> 中引入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import &#123; store, persistor &#125; from &quot;./redux/store&quot;;</span><br><span class="line">...</span><br><span class="line">const App: React.FC = () =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  return (</span><br><span class="line">    &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;PersistGate loading=&#123;&lt;Loading /&gt;&#125; persistor=&#123;persistor&#125;&gt;</span><br><span class="line">          &lt;ThemeProvider theme=&#123;darkMode ? darkTheme : mainTheme&#125;&gt;</span><br><span class="line">            &lt;HashRouter&gt;</span><br><span class="line">              &lt;div className=&#123;styles.root&#125;&gt;</span><br><span class="line">                &lt;AppNav /&gt;</span><br><span class="line">                &lt;main className=&#123;styles.content&#125;&gt;</span><br><span class="line">                  &lt;div className=&#123;styles.toolbar&#125; /&gt;</span><br><span class="line">                  &lt;Switch&gt;</span><br><span class="line">                    &lt;Route path=&quot;/home&quot;&gt;</span><br><span class="line">                      &lt;HomePage /&gt;</span><br><span class="line">                    &lt;/Route&gt;</span><br><span class="line">                    ...</span><br><span class="line">                  &lt;/Switch&gt;</span><br><span class="line">                &lt;/main&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/HashRouter&gt;</span><br><span class="line">          &lt;/ThemeProvider&gt;</span><br><span class="line">        &lt;/PersistGate&gt;</span><br><span class="line">      &lt;/Provider&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-项目打包：electron-builder">4. 项目打包：electron-builder</h3><p>一直用这个打包 Electron 应用，挺好用的工具，支持多平台(win / darwin / linux…)、多架构(arm64 / amd / aarch64…)、多包格式(zip / exe / deb / AppImage / dmg / pkg / snap / nsis…)，甚至是应用打包更新等功能支持，总之非常强大。</p><p>官方文档还算是写的简介明了，这里给个 DOC 地址：<a href="https://www.electron.build/">electron-builder</a>。</p><p>可以将 <code>electron-builder</code> 的配置一同写入 <code>package.json</code> 文件中，不过为了配置分离化易于管理也可单独编写 <code>electron-builder.json</code> 配置文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* 基础公用配置 */</span></span><br><span class="line">  <span class="attr">&quot;appId&quot;</span>: <span class="string">&quot;io.robertying.shadowsocks-electron&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;productName&quot;</span>: <span class="string">&quot;Shadowsocks Electron&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;asar&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;copyright&quot;</span>: <span class="string">&quot;© 2020 nojsja&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;files&quot;</span>: [ <span class="comment">// 显式声明需要打包的静态文件等</span></span><br><span class="line">    <span class="string">&quot;assets/**/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;bin/**/*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;extraFiles&quot;</span>: [ <span class="comment">// 显式生成需要排除的文件</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;bin/$&#123;os&#125;/$&#123;arch&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;bin&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;!.gitignore&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">/* mac 平台打包配置 */</span></span><br><span class="line">  <span class="attr">&quot;mac&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: [ <span class="comment">// 目标打包格式</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;dmg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;arch&quot;</span>: <span class="string">&quot;x64&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      ...</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;assets/icon.icns&quot;</span>, <span class="comment">// 应用图标</span></span><br><span class="line">    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;public.app-category.utilities&quot;</span>, <span class="comment">// 应用类别</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/* linux 平台打包配置 */</span></span><br><span class="line">  <span class="attr">&quot;linux&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;assets/icon.png&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;AppImage&quot;</span>,</span><br><span class="line">      <span class="string">&quot;deb&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;Network&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;executableName&quot;</span>: <span class="string">&quot;shadowsocks-electron&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;deb&quot;</span>: &#123; <span class="comment">// 对应 linux.target.deb 的独立配置</span></span><br><span class="line">    <span class="attr">&quot;depends&quot;</span>: [ <span class="comment">// 声明 deb 安装包的软件依赖</span></span><br><span class="line">      <span class="string">&quot;gconf2&quot;</span>, <span class="string">&quot;gconf-service&quot;</span>, <span class="string">&quot;libnotify4&quot;</span>, <span class="string">&quot;libappindicator1&quot;</span>, <span class="string">&quot;libxtst6&quot;</span>, <span class="string">&quot;libnss3&quot;</span>,</span><br><span class="line">      <span class="string">&quot;shadowsocks-libev&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;publish&quot;</span>: [</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要<strong>额外注意</strong>：</p><ul><li><p>Mac 平台需要使用 <code>icns</code> 格式的图标，Win 需要 <code>ico</code> 格式的图标，Linux 只要 <code>png</code> 格式即可。如果格式不对或是文件损坏可能导致打包报错，这里提供一个 <code>png</code> 转 <code>icns</code> 的工具<a href="https://anyconv.com/png-to-icns-converter/">网站</a>。</p></li><li><p>第一次打包时 npm 会自动下载打包环境，国内网络你懂得，很可能一直卡着下载失败，这里提供一个解决方案，其中版本号 <code>13.4.0</code> 可以改为你的项目中正在使用的版本号：</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for china developers</span></span><br><span class="line">$: npm config <span class="built_in">set</span> electron_custom_dir <span class="string">&quot;13.4.0&quot;</span></span><br><span class="line">$: npm config <span class="built_in">set</span> electron_mirror http://npm.taobao.org/mirrors/electron/</span><br></pre></td></tr></table></figure><h3 id="5-客户端运行日志管理：winston">5. 客户端运行日志管理：winston</h3><p>日志功能通常是一个完整的应用程序必不可少的模块，可以用于生产环境记录错误和告警，以便开发者在收到用户反馈时进行日志分析定位问题。</p><p>winston 被设计为一个简单且通用的日志库，支持多种传输器。 传输器本质上是日志的存储设备，每个 winston 日志实例都可以在不同级别配置多个传输器。 比如：将错误日志持久化存储在的远程位置（如数据库），另外把所有运行日志都输出到控制台或本地文件。</p><p>这里配合 winston 插件 <code>winston-daily-rotate-file</code> 使用，它可以更细粒度地进行日志分割、日志存储文件名自定义、日志压缩、过期日志清除等功能：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> winston, &#123; format &#125; <span class="keyword">from</span> <span class="string">&quot;winston&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> open <span class="keyword">from</span> <span class="string">&quot;open&quot;</span>;</span><br><span class="line"><span class="keyword">import</span>  DailyRotateFile <span class="keyword">from</span> <span class="string">&#x27;winston-daily-rotate-file&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; combine, simple, colorize &#125; = format;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logDir = app.getPath(<span class="string">&quot;logs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timestamp = format(<span class="function">(<span class="params">info, opts</span>) =&gt;</span> &#123;</span><br><span class="line">  info.message = <span class="string">`<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString()&#125;</span> - <span class="subst">$&#123;info.message&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> info;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dailyTransport: DailyRotateFile = <span class="keyword">new</span> DailyRotateFile(&#123;</span><br><span class="line">  <span class="attr">filename</span>: path.resolve(logDir, <span class="string">&#x27;shadowsocks-electron-%DATE%.log&#x27;</span>), <span class="comment">// 日志文件名格式</span></span><br><span class="line">  <span class="attr">datePattern</span>: <span class="string">&#x27;YYYY-MM-DD&#x27;</span>, <span class="comment">// 日期格式</span></span><br><span class="line">  <span class="attr">zippedArchive</span>: <span class="literal">false</span>, <span class="comment">// 启用压缩</span></span><br><span class="line">  <span class="attr">maxSize</span>: <span class="string">&#x27;10m&#x27;</span>, <span class="comment">// 单个日志文件最大容量</span></span><br><span class="line">  <span class="attr">maxFiles</span>: <span class="string">&#x27;30d&#x27;</span> <span class="comment">// 日志过期时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = winston.createLogger(&#123;</span><br><span class="line">  <span class="attr">level</span>: <span class="string">&quot;info&quot;</span>,</span><br><span class="line">  <span class="attr">transports</span>: [</span><br><span class="line">    dailyTransport</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&quot;production&quot;</span>) &#123;</span><br><span class="line">  logger.add(</span><br><span class="line">    <span class="keyword">new</span> winston.transports.Console(&#123;</span><br><span class="line">      <span class="attr">format</span>: combine(colorize(), timestamp(), simple())</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> logger;</span><br></pre></td></tr></table></figure><h2 id="Core-Functions">Core Functions</h2><blockquote><p>关键功能解析</p></blockquote><h3 id="1-解析-Shadowsocks-专用加密链接">1. 解析 Shadowsocks 专用加密链接</h3><p>客户端支持将 shadowsocks 加密链接如<code>ss://cmM0LW1kNTp4TTBtY09kOVFubjVAY240Lm15ZGFya2Nsb3VkLmluZm86MTI2MDA</code> 解析为服务器配置。解析 ss 链接其实并不复杂，ss 后面的字符串都是 <code>base64</code> 编码，使用 Base64 解码成正常格式 <code>ss://method:password@server:port</code> 之后使用正则匹配提取各个关键字段即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Base64 &#125; <span class="keyword">from</span> <span class="string">&#x27;js-base64&#x27;</span>;</span><br><span class="line">...</span><br><span class="line">parseSSContent(uri: string): <span class="built_in">Proxy</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// Try legacy</span></span><br><span class="line">    <span class="keyword">let</span> legacyRegex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^(<span class="subst">$&#123;ProxyURI.base64Pattern&#125;</span>)(#(.+))?$`</span>, <span class="string">&quot;gi&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> match = legacyRegex.exec(uri)</span><br><span class="line">    <span class="keyword">if</span> (match &amp;&amp; match.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(ProxyScheme.SS);</span><br><span class="line">      proxy.type = <span class="string">&#x27;ss&#x27;</span>;</span><br><span class="line">      proxy.remark = match[<span class="number">3</span>];</span><br><span class="line">      <span class="keyword">let</span> core = Base64.decode(match[<span class="number">1</span>]);</span><br><span class="line">      <span class="comment">// No &quot;$&quot; at the end is due to ShadowsocksX-NG compatibility issue</span></span><br><span class="line">      <span class="comment">// ShadowsocksX-NG will append a remark like &quot;?remark=xxxxx&quot;</span></span><br><span class="line">      <span class="keyword">let</span> mainRegex = <span class="regexp">/^(.+?):(.+)@(.+?):(\d+)/gi</span></span><br><span class="line">      <span class="keyword">let</span> coreComps = mainRegex.exec(core);</span><br><span class="line">      <span class="keyword">if</span> (coreComps &amp;&amp; coreComps[<span class="number">1</span>] &amp;&amp; coreComps[<span class="number">2</span>] &amp;&amp; coreComps[<span class="number">3</span>] &amp;&amp; coreComps[<span class="number">4</span>]) &#123;</span><br><span class="line">        proxy.host = coreComps[<span class="number">3</span>];</span><br><span class="line">        proxy.port = <span class="built_in">Number</span>(coreComps[<span class="number">4</span>]);</span><br><span class="line">        proxy.authscheme = coreComps[<span class="number">1</span>].toLowerCase();</span><br><span class="line">        proxy.password = coreComps[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-将已有的服务器配置生成二维码图片进行分享">2. 将已有的服务器配置生成二维码图片进行分享</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/share.png"  alt="share"></p><p>上一步解析成功后可以得到服务器配置，实例数据如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     <span class="attr">&quot;remark&quot;</span>: <span class="string">&quot;cn2.mydarkcloud.com&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;serverHost&quot;</span>: <span class="string">&quot;cn2.mydarkcloud.com&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;serverPort&quot;</span>: <span class="number">12322</span>,</span><br><span class="line">     <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;xM0mcOd9Qn33&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;encryptMethod&quot;</span>: <span class="string">&quot;rc4-md5&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ss&quot;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>要做二维码分享功能的话需要将配置信息组装成正常格式 <code>ss://method:password@server:port</code>，然后编码成 <code>Base64</code> 加密链接：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Base64 &#125; <span class="keyword">from</span> <span class="string">&#x27;js-base64&#x27;</span>;</span><br><span class="line">...</span><br><span class="line">generateSS(host: string, <span class="attr">port</span>: number, <span class="attr">method</span>: string, <span class="attr">password</span>: string, remark?: string, <span class="attr">isSIP002</span>: boolean = <span class="literal">true</span>): string &#123;</span><br><span class="line">    <span class="keyword">let</span> rawURI = method.toLowerCase() + <span class="string">&quot;:&quot;</span> + password + <span class="string">&quot;@&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">    <span class="keyword">let</span> uri = ProxyScheme.SS + Base64.encode(rawURI);</span><br><span class="line">    <span class="keyword">if</span> (remark) &#123;</span><br><span class="line">      uri += <span class="string">&quot;#&quot;</span> + remark;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>得到加密链接后，使用 <code>qrcode</code> 库将其输出成前端可直接展示的 <code>dataURL</code> 数据格式，然后界面上直接赋值给 <code>img</code> 标签的 <code>src</code> 属性即可：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QRCode <span class="keyword">from</span> <span class="string">&#x27;qrcode&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> result = &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">result</span>: &#123;</span><br><span class="line">    <span class="attr">dataUrl</span>: <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    msg: &#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">QRCode.toDataURL(url, <span class="function"><span class="keyword">function</span> (<span class="params">err, _dataURL</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">    result.result.dataUrl = _dataURL;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result.code = <span class="number">500</span>;</span><br><span class="line">    result.result.msg = err.toString();</span><br><span class="line">  &#125;</span><br><span class="line">  resolve(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="3-读取二维码导入-Shadowsocks-服务器配置">3. 读取二维码导入 Shadowsocks 服务器配置</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/add_server.gif"  alt="add_server"></p><p>扫描屏幕二维码导入功能实现起来稍复杂些。</p><p>第一步：先使用 Electron 自带 <code>desktopCapture</code> API 获取桌面截图文件：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; desktopCapturer &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/* 获取桌面截图 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getScreenCapturedResources</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Electron</span>.<span class="title">DesktopCapturerSource</span>[]&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> desktopCapturer.getSources(&#123;</span><br><span class="line">    <span class="attr">types</span>: [<span class="string">&#x27;screen&#x27;</span>],</span><br><span class="line">    <span class="attr">thumbnailSize</span>: &#123;</span><br><span class="line">      <span class="attr">width</span>: <span class="built_in">window</span>.screen.width * <span class="built_in">window</span>.devicePixelRatio,</span><br><span class="line">      <span class="attr">height</span>: <span class="built_in">window</span>.screen.height * <span class="built_in">window</span>.devicePixelRatio</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二步：将截图数据转换成 bitmap 位图格式(存储像素点颜色和透明度的数组[r,g,b,a …])，然后使用 <code>jsqr</code> 库解析位图中的二维码信息，最终会得到二维码位于屏幕中的坐标、宽度和文本值等信息：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 解析位图数据 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getQrCodeFromScreenResources = (callback?: <span class="function">(<span class="params">added: <span class="built_in">boolean</span></span>) =&gt;</span> <span class="built_in">void</span>): ThunkAction&lt;<span class="built_in">void</span>, RootState, unknown, AnyAction&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    getScreenCapturedResources().then(<span class="function">(<span class="params">resources: Electron.DesktopCapturerSource[]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 可能有多个屏幕资源</span></span><br><span class="line">      <span class="keyword">if</span> (resources &amp;&amp; resources.length) &#123;</span><br><span class="line">        <span class="keyword">const</span> qrs: &#123;<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>, <span class="attr">width</span>: <span class="built_in">number</span>, <span class="attr">height</span>: <span class="built_in">number</span>&#125;[] = [];</span><br><span class="line">        <span class="keyword">const</span> values: <span class="built_in">string</span>[] = [];</span><br><span class="line">        resources.forEach(<span class="function"><span class="params">resource</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> size = resource.thumbnail.getSize();</span><br><span class="line">          <span class="comment">// 使用截图的位图信息进行解析</span></span><br><span class="line">          <span class="keyword">const</span> capturedData = jsqr(resource.thumbnail.getBitmap() <span class="keyword">as</span> <span class="built_in">any</span>, size.width, size.height);</span><br><span class="line">          <span class="keyword">if</span> (capturedData &amp;&amp; capturedData.data) &#123;</span><br><span class="line">            values.push(capturedData.data);</span><br><span class="line">            <span class="comment">// 保存多个二维码的坐标、宽高和文本值信息</span></span><br><span class="line">            qrs.push(&#123;</span><br><span class="line">              <span class="attr">x</span>: capturedData.location.topLeftCorner.x,</span><br><span class="line">              <span class="attr">y</span>: capturedData.location.topLeftCorner.y,</span><br><span class="line">              <span class="attr">width</span>: capturedData.location.topRightCorner.x - capturedData.location.topLeftCorner.x,</span><br><span class="line">              <span class="attr">height</span>: capturedData.location.bottomLeftCorner.y - capturedData.location.topLeftCorner.y,</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 保存 qrs 二维码数据并发送数据到主进程进行其它操作</span></span><br><span class="line">        ...</span><br><span class="line">        callback &amp;&amp; callback(!!qrs.length);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        callback &amp;&amp; callback(<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>第三步：发送二维码数据到主进程，主进程根据坐标和宽高信息生成办透明的全屏窗口(截图遮罩层)，并在透明窗口加载的 js 文件中根据二维码坐标信息用 <code>canvas</code> 绘制高亮捕获区域：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------ 主进程中创建透明窗口 ------ */</span></span><br><span class="line"><span class="keyword">import</span> &#123; app, BrowserWindow screen &#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> screenSize = screen.getPrimaryDisplay().workAreaSize;</span><br><span class="line"><span class="keyword">const</span> twin = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">    <span class="attr">width</span>: screenSize.width,</span><br><span class="line">    <span class="attr">height</span>: screenSize.height,</span><br><span class="line">    <span class="attr">transparent</span>: <span class="literal">true</span>, <span class="comment">// 透明</span></span><br><span class="line">    <span class="attr">alwaysOnTop</span>: <span class="literal">true</span>, <span class="comment">// 置顶</span></span><br><span class="line">    <span class="attr">fullscreen</span>: <span class="literal">true</span>, <span class="comment">// 全屏</span></span><br><span class="line">    <span class="attr">frame</span>: <span class="literal">false</span>, <span class="comment">// 无边框</span></span><br><span class="line">    <span class="attr">titleBarStyle</span>: <span class="string">&#x27;hidden&#x27;</span>, <span class="comment">// 隐藏标题栏</span></span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br><span class="line">twin.loadURL(<span class="string">&#x27;path/to/html&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------ 渲染进程中绘制高亮二维码区域 ------ */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> screenWidth = <span class="built_in">window</span>.screen.availWidth * <span class="built_in">window</span>.devicePixelRatio;</span><br><span class="line"><span class="keyword">const</span> screenHeight = <span class="built_in">window</span>.screen.availHeight * <span class="built_in">window</span>.devicePixelRatio;</span><br><span class="line"><span class="keyword">const</span> $drawer = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#drawer&#x27;</span>);</span><br><span class="line">$drawer.width = screenWidth;</span><br><span class="line">$drawer.height = screenHeight;</span><br><span class="line"><span class="keyword">if</span> (!drawer) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ctx = drawer.getContext(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;x, y, width, height&#125; = p;</span><br><span class="line"><span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">  <span class="comment">// 全屏填充半透明背景色</span></span><br><span class="line">  ctx.fillStyle = <span class="string">&#x27;rgba(0, 0, 0, .3)&#x27;</span>;</span><br><span class="line">  ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, drawer.width, drawer.height);</span><br><span class="line">  <span class="comment">// 高亮二维码捕获区域</span></span><br><span class="line">  ctx.fillStyle = <span class="string">&#x27;rgba(255, 0, 0, .4)&#x27;</span>;</span><br><span class="line">  ctx.fillRect(x, y, width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-多平台功能适配之-shadowsocks-libev-库的依赖处理">4. 多平台功能适配之 <code>shadowsocks-libev</code> 库的依赖处理</h3><p>本桌面应用主要使用 <code>shadowsocks-libev</code> 跨平台库进行 proxy 的管理。</p><ul><li><p>Ubuntu20.04 <strong>deb</strong> 构建方式中：由于依赖库可以直接从官方 <code>apt</code> 软件源中安装，因此不用在应用内部提供二进制可执行文件，只需在 <code>electron-builder.json</code> 中声明 <code>deb</code> 字段的依赖项目即可，用户安装 deb 安装包的时候会自动从软件源商店下载对应的依赖，参考上文 <code>electron-builder.json</code> 说明。</p></li><li><p>Ubuntu20.04 <strong>AppImage</strong> 构建方式中：需要将用到的 <code>ss-local</code> 命令的二进制执行文件集成到包内，并在执行命令时提供明确的二进制文件绝对地址，如：<code>/path/to/ss-local</code>。</p></li><li><p>Mac <strong>dmg / zip</strong> 构建方式中：Mac 中虽然也能通过包管理器 <code>brew</code> 来安装：<code>brew install shadowsocks-libev</code>，但是考虑到 <code>brew</code> 本身并不属于 Mac 操作系统开封即用的应用，可能有些用户 Mac 机没有安装，并且国内网络环境你懂得，普通用户安装它可能会网络错误。因此构建包中默认集成了 <code>shadowsocks-libev</code> 库中需要用到的 <code>ss-local</code> 二进制文件，详见项目路径：<code>/bin/darwin/x64/ss-local</code>。</p></li></ul><p>以下是程序运行时获取 <code>ss-local</code> 可执行文件地址的多平台兼容处理代码作为参考：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 搜索系统环境变量中配置的目录，生成目标可执行文件的绝对路径 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getBinPath = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fullpath = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  <span class="keyword">const</span> paths = (process.env.PATH <span class="keyword">as</span> <span class="built_in">string</span>).split(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">name: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fullpath.get(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> fullpath.get(name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fs.existsSync(path.join(paths[i], name))) &#123;</span><br><span class="line">        fullpath.set(name, path.join(paths[i], name));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullpath.get(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取 ss-local 执行文件地址 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getSSLocalBinPath = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (os.platform()) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">      <span class="comment">// 从系统环境变量中匹配路径</span></span><br><span class="line">      <span class="keyword">return</span> getBinPath(<span class="string">&#x27;ss-local&#x27;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;darwin&#x27;</span>:</span><br><span class="line">      <span class="comment">// 使用手动集成的 ss-local 文件</span></span><br><span class="line">      <span class="keyword">return</span> path.join(app.getAppPath(), <span class="string">`bin/darwin/x64/ss-local`</span>);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> getBinPath(<span class="string">&#x27;ss-local&#x27;</span>) ?? <span class="string">&#x27;ss-local&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-Electron-调用-shadowsocks-libev-库连接服务器">5. Electron 调用 <code>shadowsocks-libev</code> 库连接服务器</h3><p>上一步说明了使用 <code>ss-local</code> 命令之前所做的兼容处理，现在需要使用 <code>ss-local</code> 命令 (shadowsocks 客户端) 来连接我们的服务器了。Electron 执行命令首先想到的是什么？没错就是 Node.js 的 <a href="http://nodejs.cn/api/child_process.html"><code>child_process</code></a> 模块，它提供了多种方式用于 Node.js 主进程开启子进程执行系统命令和可执行文件：</p><ul><li><strong>spawn</strong>：child_process.spawn() 方法使用给定的 command 和 args 中的命令行参数衍生新进程。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ls = spawn(<span class="string">&#x27;ls&#x27;</span>, [<span class="string">&#x27;-lh&#x27;</span>, <span class="string">&#x27;/usr&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">ls.stdout.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ls.stderr.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">`stderr: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ls.on(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`child process exited with code <span class="subst">$&#123;code&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>exec</strong>: 衍生 shell，然后在该 shell 中执行 command，缓冲任何生成的输出。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line">exec(<span class="string">&#x27;cat *.js missing_file | wc -l&#x27;</span>, <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">`exec error: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">`stderr: <span class="subst">$&#123;stderr&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>execFile</strong>：类似于 exec()，但是默认情况下它会直接衍生命令而不先衍生shell。exec() 和 execFile() 之间区别的重要性可能因平台而异，在 Unix 类型的操作系统上，execFile() 可以更高效，因为默认情况下不会衍生 shell。但是在 Windows 上， .bat 和 .cmd 文件在没有终端的情况下不能自行执行，因此无法使用 execFile() 启动。当在 Windows 上运行时，要调用 .bat 和 .cmd 文件，可以使用设置了 shell 选项的 child_process.spawn()、child_process.exec() 或衍生 cmd.exe 并将 .bat 或 .cmd 文件作为参数传入（也就是 shell 选项和 child_process.exec() 所做的）。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; execFile &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> child = execFile(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;--version&#x27;</span>], <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(stdout);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong>fork</strong>：child_process.fork() 方法是 child_process.spawn() 的特例，专门用于衍生新的 Node.js 进程。 与 child_process.spawn() 一样，返回 ChildProcess 对象。 返回的 ChildProcess 将有额外的内置通信通道，允许消息在父进程和子进程之间来回传递。注意创建个每个子进程都有自己的内存，具有自己的 V8 实例，由于需要额外的资源分配，不建议衍生大量子 Node.js 进程。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.argv[<span class="number">2</span>] === <span class="string">&#x27;child&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hello from <span class="subst">$&#123;process.argv[<span class="number">2</span>]&#125;</span>!`</span>);</span><br><span class="line">  &#125;, <span class="number">1_000</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> AbortController();</span><br><span class="line">  <span class="keyword">const</span> &#123; signal &#125; = controller;</span><br><span class="line">  <span class="keyword">const</span> child = fork(__filename, [<span class="string">&#x27;child&#x27;</span>], &#123; signal &#125;);</span><br><span class="line">  child.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果控制器中止，则这将在 err 为 AbortError 的情况下被调用</span></span><br><span class="line">  &#125;);</span><br><span class="line">  controller.abort(); <span class="comment">// 停止子进程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此项目中使用 <code>spawn</code> 方式创建子进程来执行 <code>ss-local</code> 命令连接服务器：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> spawnClient = <span class="keyword">async</span> (config: Config, <span class="attr">settings</span>: Settings) : <span class="built_in">Promise</span>&lt;&#123;<span class="attr">code</span>: <span class="built_in">number</span>, <span class="attr">result</span>: <span class="built_in">any</span>&#125;&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> sslocalPath = getSSLocalBinPath();</span><br><span class="line">  <span class="keyword">const</span> args = [</span><br><span class="line">    <span class="string">&quot;-s&quot;</span>,</span><br><span class="line">    config.serverHost,</span><br><span class="line">    <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">    config.serverPort.toString(),</span><br><span class="line">    <span class="string">&quot;-l&quot;</span>,</span><br><span class="line">    settings.localPort.toString(),</span><br><span class="line">    <span class="string">&quot;-k&quot;</span>,</span><br><span class="line">    config.password,</span><br><span class="line">    <span class="string">&quot;-m&quot;</span>,</span><br><span class="line">    config.encryptMethod,</span><br><span class="line">    config.udp ? <span class="string">&quot;-u&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.fastOpen ? <span class="string">&quot;--fast-open&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.noDelay ? <span class="string">&quot;--no-delay&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.plugin ? <span class="string">&quot;--plugin&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.plugin ?? <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.pluginOpts ? <span class="string">&quot;--plugin-opts&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    config.pluginOpts ?? <span class="string">&quot;&quot;</span>,</span><br><span class="line">    settings.verbose ? <span class="string">&quot;-v&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">    (config.timeout ?? <span class="string">&quot;60&quot;</span>).toString()</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`check port <span class="subst">$&#123;settings.localPort&#125;</span> usage...`</span>);</span><br><span class="line">    ssLocal = spawn(</span><br><span class="line">      sslocalPath,</span><br><span class="line">      args.filter(<span class="function"><span class="params">arg</span> =&gt;</span> arg !== <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ssLocal.stdout?.once(<span class="string">&quot;data&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Started ss-local&quot;</span>);</span><br><span class="line">      logger.info(<span class="string">&quot;Set proxy on&quot;</span>);</span><br><span class="line">          ...</span><br><span class="line">      connected = <span class="literal">true</span>;</span><br><span class="line">      mainWindow?.webContents.send(<span class="string">&quot;connected&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">      resolve(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="literal">null</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.stdout?.on(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      logger.info(data);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      logger.error(err);</span><br><span class="line">    &#125;);</span><br><span class="line">    ssLocal.on(<span class="string">&quot;exit&quot;</span>, <span class="keyword">async</span> (code, signal) =&gt; &#123;</span><br><span class="line">      logger.info(<span class="string">`Exited ss-local with code <span class="subst">$&#123;code&#125;</span> or signal <span class="subst">$&#123;signal&#125;</span>`</span>);</span><br><span class="line">      logger.info(<span class="string">&quot;Set proxy off&quot;</span>);</span><br><span class="line">      ...</span><br><span class="line">      connected = <span class="literal">false</span>;</span><br><span class="line">      MessageChannel.sendTo(mainWindow?.id || <span class="number">1</span>, <span class="string">&#x27;connected&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line">      ssLocal = <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-多平台功能适配之设置系统-proxy-和-pac-服务">6. 多平台功能适配之设置系统 proxy 和 pac 服务</h3><p>客户端中可以切换<strong>全局 proxy</strong> 和 <strong>pac 模式</strong>，全局即系统上运行的应用程序都走 proxy 流量。而 pac 则是一种更加智能化的模式，通过配置 pac 文件的地址(http / fs 协议)，实现系统流量按照 pac 中声明的规则进行智能化分流处理，只将我们不能直接访问的域名通过 proxy 转发。</p><ul><li>如果你正在使用 Ubuntu 操作系统的话可以依次打开：<code>设置 - 网络 - 网络DaiLi(拼音手动和谐)</code>，里面可以选择：<code>自动 / 手动 / 禁用</code> 三种模式，其中<strong>自动</strong>即为 pac 模式，我们可以填入在线或本地pac文件的地址，例如：<code>http://localhost:1090/proxy.pac</code>，然后系统就会智能化分配流量了；<strong>手动</strong>就是全局 proxy，里面可以配置各种 proxy 的地址(http / https / socks / ftp)，如：<code>socks5://127.0.0.1:1080</code>；<strong>禁用</strong>不用多说就是禁止系统 proxy，直接根据访问目标走 dns 系统查询到的 IP 地址。</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/system_proxy.png"  alt="system_proxy"></p><ul><li>如果你正在使用 Mac 操作系统的话其实也大同小异，可以从：<code>系统偏好设置 - 网络 - 高级 - DaiLi(拼音手动和谐)</code> 处找到相关设置。</li></ul><p>客户端实现的功能就是避免用户进行上述的繁琐的设置操作，在界面通过功能按钮一键切换即可。</p><h4 id="设置系统-proxy">设置系统 proxy</h4><p>客户端适配了Ubuntu 操作系统中最常用的 <code>Gnome</code> 桌面版本，原理是使用其自带的 <code>gsetting</code> 命令直接在命令行设置 proxy：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setGlobalProxy = <span class="keyword">async</span> (host: <span class="built_in">string</span>, <span class="attr">port</span>: <span class="built_in">number</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 开启手动模式</span></span><br><span class="line">  <span class="keyword">const</span> manualSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">&quot;gsettings set org.gnome.system.proxy mode manual&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置主机名</span></span><br><span class="line">  <span class="keyword">const</span> hostSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy.socks host &#x27;<span class="subst">$&#123;host&#125;</span>&#x27;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置端口号</span></span><br><span class="line">  <span class="keyword">const</span> portSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy.socks port <span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置忽略的本地地址</span></span><br><span class="line">  <span class="keyword">const</span> bypassSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy ignore-hosts &quot;[&#x27;<span class="subst">$&#123;ignoredHosts&#125;</span>&#x27;]&quot;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    manualSet.code === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    hostSet.code === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    portSet.code === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    bypassSet.code === <span class="number">0</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而对于 Mac 操作系统也有类似的操作命令 <code>networksetup</code>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setGlobalProxy = <span class="keyword">async</span> (host: <span class="built_in">string</span>, <span class="attr">port</span>: <span class="built_in">number</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">await</span> listNetworkServices();</span><br><span class="line">  <span class="keyword">if</span> (!services) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    services.map(<span class="keyword">async</span> service =&gt; &#123;</span><br><span class="line">      <span class="comment">// 开启模式</span></span><br><span class="line">      <span class="keyword">const</span> autoSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">        <span class="string">`networksetup -setsocksfirewallproxystate &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; on`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置主机名和端口号</span></span><br><span class="line">      <span class="keyword">const</span> urlSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">        <span class="string">`networksetup -setsocksfirewallproxy &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;host&#125;</span>&#x27; <span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置忽略的本地地址</span></span><br><span class="line">      <span class="keyword">const</span> bypassSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">        <span class="string">`networksetup -setproxybypassdomains &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;ignoredHosts&#125;</span>&#x27;`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> autoSet.code === <span class="number">0</span> &amp;&amp; urlSet.code === <span class="number">0</span> &amp;&amp; bypassSet.code === <span class="number">0</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> results.filter(<span class="function"><span class="params">i</span> =&gt;</span> i === <span class="literal">true</span>).length &gt; <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="设置系统-pac-文件地址">设置系统 pac 文件地址</h4><p>原理都相同，都是使用命令生成 <code>pac</code> 文件，然后启动一个 <code>http</code> 服务器做静态托管，最后通过操作系统内置命令将 pac 文件地址设置好即可。</p><p>在 Ubuntu 系统中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setPacProxy = <span class="keyword">async</span> (url: <span class="built_in">string</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 启动 pac 模式</span></span><br><span class="line">  <span class="keyword">const</span> autoSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">&quot;gsettings set org.gnome.system.proxy mode auto&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 设置 pac 地址</span></span><br><span class="line">  <span class="keyword">const</span> urlSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">    <span class="string">`gsettings set org.gnome.system.proxy autoconfig-url &#x27;<span class="subst">$&#123;url&#125;</span>&#x27;`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> autoSet.code === <span class="number">0</span> &amp;&amp; urlSet.code === <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在 Mac 系统中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listNetworkServices = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> execAsync(<span class="string">&quot;networksetup -listallnetworkservices&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (result.code === <span class="number">0</span> &amp;&amp; result.stdout) &#123;</span><br><span class="line">    <span class="keyword">const</span> r = result.stdout.split(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    r.shift();</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setPacProxy = <span class="keyword">async</span> (url: <span class="built_in">string</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取所有网络服务</span></span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">await</span> listNetworkServices();</span><br><span class="line">  <span class="keyword">if</span> (!services) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    services.map(<span class="keyword">async</span> service =&gt; &#123;</span><br><span class="line">      <span class="comment">// 启动 pac 模式</span></span><br><span class="line">      <span class="keyword">const</span> autoSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">        <span class="string">`networksetup -setautoproxystate &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; on`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 设置 pac 地址</span></span><br><span class="line">      <span class="keyword">const</span> urlSet = <span class="keyword">await</span> execAsync(</span><br><span class="line">        <span class="string">`networksetup -setautoproxyurl &#x27;<span class="subst">$&#123;service&#125;</span>&#x27; &#x27;<span class="subst">$&#123;url&#125;</span>&#x27;`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> autoSet.code === <span class="number">0</span> &amp;&amp; urlSet.code === <span class="number">0</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> results.filter(<span class="function"><span class="params">i</span> =&gt;</span> i === <span class="literal">true</span>).length &gt; <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="7-多平台功能适配之应用开机自启动">7. 多平台功能适配之应用开机自启动</h3><p>原作者仅支持了 Mac 系统的开机自启，使用了 Electron 自带的平台专用 API - <code>setLoginItemSettings</code>，不过 API 仅支持 Mac：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 设置登录状态，默认是为 process.execPath 设置，可以使用默认值</span></span><br><span class="line">app.setLoginItemSettings(&#123;</span><br><span class="line">    <span class="attr">openAtLogin</span>: params.openAtLogin, <span class="comment">// 开机自启</span></span><br><span class="line">    <span class="attr">openAsHidden</span>: params.openAsHidden <span class="comment">// 自动隐藏窗口</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Ubuntu 我还是用的比较熟悉的，毕业后一直用于工作和日常使用。加上之前也做过一个 Ubuntu 版本的类似电脑管家的<a href="https://github.com/nojsja/electronux">小桌面应用</a>，因此对 Gnome 桌面和 Electron 方面的交互有一定经验。Ubuntu 上面要想实现应用开机自启需要自己定制一个配置文件到 <code>~/.config/autostart/</code> 路径下，比如 <code>~/.config/autostart/shasowsocks-electron.desktop</code>：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/autostart.png"  alt="autostart"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name=Shadowsocks Electron</span><br><span class="line">Exec=shadowsocks-electron</span><br><span class="line">Terminal=false</span><br><span class="line">Type=Application</span><br><span class="line">Icon=shadowsocks-electron</span><br><span class="line">StartupWMClass=Shadowsocks Electron</span><br><span class="line">Encoding=UTF-8</span><br><span class="line">Comment=Shadowsocks GUI with cross-platform desktop support</span><br><span class="line">Categories=Network</span><br><span class="line">Hidden=false</span><br></pre></td></tr></table></figure><p>需要重点关注的是以下字段：</p><ul><li>Exec：应用可执行文件路径或命令</li><li>Type：GUI应用应填写 Application</li><li>Hidden：禁用/启用状态</li></ul><p>在客户端中当用户开启了开机自启功能时，Node.js 就检查相应目录是否存在这个文件，不存在的话先使用 <code>fs.write</code> API 创建文件，并根据具体的开启/禁用状态更改 <strong>Hidden</strong> 字段即可：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setStartupOnBoot_linux = <span class="function">(<span class="params">on: <span class="built_in">boolean</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> startupDir = <span class="string">`<span class="subst">$&#123;os.homedir()&#125;</span>/.config/autostart`</span>;</span><br><span class="line">  <span class="keyword">const</span> startupFile = <span class="string">&#x27;shadowsocks-electron.desktop&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> fileContent = [</span><br><span class="line">    <span class="string">&quot;[Desktop Entry]&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Name=Shadowsocks Electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Exec=shadowsocks-electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Terminal=false&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Type=Application&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Icon=shadowsocks-electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;StartupWMClass=Shadowsocks Electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Encoding=UTF-8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Comment=Shadowsocks GUI with cross-platform desktop support&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Categories=Network&quot;</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    fs.writeFile(</span><br><span class="line">      path.join(startupDir, startupFile),</span><br><span class="line">      <span class="comment">// 新增一行 Hidden 字段描述</span></span><br><span class="line">      <span class="string">`<span class="subst">$&#123;fileContent.join(os.EOL)&#125;</span><span class="subst">$&#123;os.EOL&#125;</span>Hidden=<span class="subst">$&#123;on ? <span class="literal">false</span> : <span class="literal">true</span>&#125;</span>`</span>,</span><br><span class="line">      (<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) reject(err);</span><br><span class="line">        resolve(path.join(startupDir, startupFile));</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-使用-Electron-进程管理器提高开发调试效率">8. 使用 Electron 进程管理器提高开发调试效率</h3><p>上文在描述 <code>redux-persist</code> 数据持久化功能时提到过，Electron 框架最近的几个版本带来了一个破坏性修改，<code>remote</code> 远程调用被强制移除了。这样子 npm 上大量的依赖 remote API 的开源工具就会出现兼容性问题，除非开源作者将 <code>electron.remote</code> 更改为 <code>@electron/remote</code> 第三方外部包。</p><p>不过总有一些开源仓库不会被开源作者和社区一直维护，我之前在开发阶段一直用的调试工具 <code>devtron</code> 就是这个情况。工具可以在 <code>devtools</code> 控制台中开启一个面板查看 electron 的 <code>ipc</code> 通信记录，因为 Electron 本地应用不存在 http 请求，因此不会在网络请求面板中看到，所以需要这样一个工具查看主进程和渲染进程之间的消息记录以便追踪应用。</p><p><code>devtron</code> github 主页贴着项目不再维护，寻求热心的开源开发者继续维护的消息。<code>devtron</code> 最近的一次版本在我使用的 <code>electron@13.4.0</code> 上也直接歇菜了🤪。我遇到 <code>devtron</code> 报错打不开的情况后索性突发奇想将所有原生的 <code>ipc</code> 通信方式(on / once / send / sendTo / invoke / handle…) 使用我自己之前开发的进程管理工具 <code>electron-re</code> 替代，感兴趣的可以看看 <a href="https://github.com/nojsja/electron-re">github 仓库</a>。迁移到 <code>electron-re</code> 之后，我在项目中开了一个 <code>dev</code> 分支专门用于支持<code>ipc</code> 通信记录功能，其实适配工作量不大，写个UI界面，然后在原有的数据采集模块新增一点逻辑即可。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/process_manager.png"  alt="process_manager"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/ipc.png"  alt="ipc"></p><p>这里顺便打个广告🤏，<code>electron-re</code> 主要是作为一个进程管理器和 <code>ipc</code> 通信工具开发的，除了支持 Electron 应用中主进程、渲染进程、service 进程(<code>electron-re</code> 引入)、child 进程(<code>electron-re</code> 引入) 的资源占用情况动态统计功能，也提供了一个 ipc 通信工具 <code>MessageChannel</code>，它基于 electron 原生 ipc 通信开发。除此之外它还提供了一个简单实现的进程池工具 <code>ChildProcessPool</code> 和与之配套使用的 <code>ProcessHost</code> 消息工具。这次针对 <code>shadowsocks-electron</code> 和其他 Electron 应用开发的 ipc 通信记录面板功能就是在 <code>MessageChannel</code> 通信工具中通过新增通信记录上报逻辑来实现的。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/electron-re.png"  alt="process_manager"></p><h2 id="Others">Others</h2><blockquote><p>开发过程中的其它提及</p></blockquote><h3 id="1-Mac-虚拟机真是难装">1. Mac 虚拟机真是难装</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/virtualbox_detail.png"  alt="virtualbox_detail"></p><p>安装 Mac 虚拟机足足折磨了我一天多，实体机安装 Ubuntu 双系统 40 分钟就能解决的事儿，从下载 virtualbox 可用的 <code>MacOS 10.15</code> 开始，龟速百度网盘。安装 ISO 时很容易卡住或者报错，最后查了很多资料整理出以下步骤：</p><p>一台支持英特尔虚拟化技术的电脑 + <a href="https://pan.baidu.com/s/1OeMhhKdXSbiqIPGluq3CAA">MacOS 10.15 镜像</a> (密码：3guu)</p><ul><li>1）VirtualBox虚拟机软件，版本号在 6.0 及以上即可。</li><li>2）启动虚拟机创建向导，选择类型 - <code>Mac OS X</code>，版本 -<code>Mac OS x64</code>。</li><li>3）其余什么内存、磁盘之类的按照自己需求大概配置一下，格外注意的是网络不要选择<code>桥接网卡</code>，选中默认的<code>NAT</code>网络模式，否则 Ubuntu20.04 操作系统下可能会在运行虚拟机的时候卡死宿主机。<code>NAT</code> 模式不能分配和宿主机同网段的独立 IP，因此如果要通过 SSH 访问虚拟机的话可以在虚拟机设置里面开启端口转发，比如我将宿主机端口 <code>2222</code> 映射到虚拟机内部 ssh 的默认端口 <code>22</code>，这样就可以在宿主机通过命令：<code>ssh -p 2222 nojsja@127.0.0.1</code> 来连接了。</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/virtualbox_nat.png"  alt="virtualbox_nat"></p><ul><li>4）虚拟机创建好后注意在虚拟机设置中<code>存储</code>页面添加下载好的 ISO 光盘镜像作为开机引导。</li><li>5）以上步骤准备好后，有一个比较关键的操作，设置虚拟机相关配置，不然安装很可能出错：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行终端中依次执行以下命令，&quot;macOS&quot; 替换为自己虚拟机的名字</span></span><br><span class="line">$: VBoxManage modifyvm <span class="string">&quot;macOS&quot;</span> --cpuidset 00000001 000106e5 00100800 0098e3fd bfebfbff </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiSystemProduct&quot;</span> <span class="string">&quot;iMac11,3&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiSystemVersion&quot;</span> <span class="string">&quot;1.0&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/efi/0/Config/DmiBoardProduct&quot;</span> <span class="string">&quot;Iloveapple&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/smc/0/Config/DeviceKey&quot;</span> <span class="string">&quot;ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc&quot;</span> </span><br><span class="line">$: VBoxManage setextradata <span class="string">&quot;macOS&quot;</span> <span class="string">&quot;VBoxInternal/Devices/smc/0/Config/GetKeyFromRealSMC&quot;</span> 1</span><br><span class="line">$: VBoxManage modifyvm <span class="string">&quot;macOS&quot;</span> --cpu-profile <span class="string">&quot;Intel Core i7-6700K&quot;</span></span><br></pre></td></tr></table></figure><ul><li>6）之后就比较常规了，开启虚拟机后，在“macOS Utilities”窗口的列表中，双击“Disk Utility”项，来启动磁盘助理，对磁盘进行分区。将需要使用的虚拟安装硬盘格式化为 “Mac OS Extended(Journaled)”或“APFS”即可。</li><li>7）其余流程跟着引导走即可，最后安装完了重启之后，别忘了在虚拟机<code>存储</code>里卸载 ISO 引导光盘，否则会开机一直进入安装界面。</li></ul><h3 id="2-Mac-brew-在国内环境的安装方式">2. Mac brew 在国内环境的安装方式</h3><p>Mac 安装好后，需要使用 <code>brew</code> 包管理器安装 <code>shadowsocks-libev</code>，官方提供的脚本在国内网络环境下会安装失败，建议使用国内开发者编写的版本：</p><ol><li><p>官方脚本：<code>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</code></p></li><li><p>国内开发者编写的脚本：<code>/bin/zsh -c &quot;$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)&quot;</code></p></li></ol><h3 id="3-Node-js-child-process-执行二进制文件的一些坑">3. Node.js child_process 执行二进制文件的一些坑</h3><p>客户端中 MacOS 平台需要执行 <code>shadowsocks-libev</code> 库中提供的命令连接服务器如：<code>sslocal -s  host -p port -l localPort -k password -m method ...</code>，上文中提到针对 MacOS 的兼容方式是在构建包中提供 <code>ss-local</code> 二进制文件，以避免让用户手动执行 <code>brew install shadowsocks-libev</code> 来安装依赖库。</p><p>这里有个坑就是开发者为用户提供 <code>ss-local</code> 后，默认这个二进制文件是放在应用安装目录的，但是你不知道用户操作系统中你的客户端软件会被具体安装到哪里，极可能是系统相关目录。系统相关目录中的文件 Electron 默认是不能执行的，也不能通过 Node.js 提供的 <code>fs.chmod</code> 方式手动为可执行文件授予执行权限。</p><p>这个问题之前开发 Ubuntu 桌面管家的时候遇到过，都是 Unix 系的操作系统，Mac 这边也会出现这个问题。解决方案就是将客户端需要用到的 bin 二进制文件在应用启动的时候拷贝到用户数据目录，这个目录下的文件用户拥有完全控制权，可以使用 Node.js 提供的 <code>fs.chmod</code> API让二进制文件可执行。具体实现如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------ utils.ts ------ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * checkEnvFiles [检查环境文件是否存在]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;[type]&#125;</span> </span>param [desc]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> checkEnvFiles = (args: &#123;<span class="attr">_path</span>: <span class="built_in">string</span>, <span class="attr">isDir</span>: <span class="built_in">boolean</span>, exec?: <span class="function">() =&gt;</span> <span class="built_in">void</span>&#125;[]): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> check = <span class="function"><span class="keyword">function</span> (<span class="params">params: &#123;_path: <span class="built_in">string</span>, isDir: <span class="built_in">boolean</span>, exec?: () =&gt; <span class="built_in">void</span>&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!fs.existsSync(params._path)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (params.isDir) &#123;</span><br><span class="line">        fs.mkdirSync(params._path);</span><br><span class="line">        params.exec &amp;&amp; params.exec();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fs.closeSync(fs.openSync(params._path, <span class="string">&#x27;w&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  args.forEach(check);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 同步复制目录、子目录，及其中的文件</span></span><br><span class="line"><span class="comment"> * @param src &#123;String&#125; 要复制的目录</span></span><br><span class="line"><span class="comment"> * @param dist &#123;String&#125; 复制到目标目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> copyDir = <span class="function">(<span class="params">src: <span class="built_in">string</span>, dist: <span class="built_in">string</span>, callback?: (params: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> paths, stat;</span><br><span class="line">  <span class="keyword">if</span>(!fs.existsSync(dist)) &#123;</span><br><span class="line">    fs.mkdirSync(dist);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _copy(src, dist);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_copy</span>(<span class="params">src: <span class="built_in">string</span>, dist: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    paths = fs.readdirSync(src);</span><br><span class="line">    paths.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">_path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> _src = path.join(src, _path);</span><br><span class="line">        <span class="keyword">let</span> _dist = path.join(dist, _path);</span><br><span class="line">        stat = fs.statSync(_src);</span><br><span class="line">        <span class="comment">// 判断是文件还是目录</span></span><br><span class="line">        <span class="keyword">if</span>(stat.isFile()) &#123;</span><br><span class="line">          fs.writeFileSync(_dist, fs.readFileSync(_src));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(stat.isDirectory()) &#123;</span><br><span class="line">          <span class="comment">// 当是目录是，递归复制</span></span><br><span class="line">          copyDir(_src, _dist, callback)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [fsChmod 对文件和文件夹递归授予权限]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>dir   [文件夹]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[int]&#125;</span> </span>opstr [八进制数字，例如0o711]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> chmod = <span class="function">(<span class="params">target: <span class="built_in">string</span>, opstr: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.statSync(target).isDirectory()) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = fs.readdirSync(target);</span><br><span class="line">    <span class="keyword">if</span> (files.length) &#123;</span><br><span class="line">      files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        fs.chmod(path.join(target, file), opstr);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target &amp;&amp; !target.includes(<span class="string">&#x27;.gitignore&#x27;</span>)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`fs.chmod =&gt; <span class="subst">$&#123;target&#125;</span> with <span class="subst">$&#123;opstr&#125;</span>`</span>);</span><br><span class="line">      fs.chmodSync(target, opstr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------ 主进程 index.ts ------ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户数据目录中的文件拥有完全控制权</span></span><br><span class="line"><span class="keyword">const</span> appDataPath = path.join(app.getPath(<span class="string">&#x27;appData&#x27;</span>), packageName);</span><br><span class="line"><span class="keyword">const</span> pathRuntime = (<span class="built_in">global</span> <span class="keyword">as</span> <span class="built_in">any</span>).pathRuntime = path.join(appDataPath, <span class="string">&#x27;runtime/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查文件完整性</span></span><br><span class="line">checkEnvFiles(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">_path</span>: appDataPath, <span class="attr">isDir</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">_path</span>: pathRuntime, <span class="attr">isDir</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">_path</span>: path.join(pathRuntime, <span class="string">&#x27;bin&#x27;</span>), <span class="attr">isDir</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">exec</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        copyDir(path.join(app.getAppPath(), <span class="string">&#x27;bin&#x27;</span>), path.join(pathRuntime, <span class="string">&#x27;bin&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 授权</span></span><br><span class="line">chmod(path.join(pathRuntime, <span class="string">&#x27;bin&#x27;</span>), <span class="number">0o711</span>);</span><br></pre></td></tr></table></figure><h3 id="4-怎样为未适配-Typescript-的第三方包编写-types-声明">4. 怎样为未适配 Typescript 的第三方包编写 @types 声明</h3><p>上文提到引入了 <code>electron-re</code> 进程管理工具用于 ipc 消息追踪，不过之前开发 <code>electron-re</code> 时并未适配 Typescript 环境，仍然是 <code>commonJs</code> 规范，不过 TS 里引入第三方包只要存在类型声明文件即可。方法一是编写 <code>@types/electron-re</code> 单独发包支持，另一种就是直接在 <code>electron-re</code> 项目下声明即可，自己的仓库可以选择第二种。</p><p>在项目根目录中创建声明文件 <code>types/index.d.ts</code>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="built_in">module</span> electronReModule &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> electronRe &#123;</span><br><span class="line">    <span class="attr">MessageChannel</span>: &#123;</span><br><span class="line">      <span class="attr">invoke</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, channel: <span class="built_in">string</span>, args: unknown</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">      handle: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, promiseFunc: (event, args: &#123; action: <span class="built_in">string</span>, params: <span class="built_in">any</span> &#125;) =&gt; <span class="built_in">Promise</span>&lt;unknown&gt;</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">send</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, channel: <span class="built_in">string</span>, args: unknown</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">sendTo</span>: <span class="function">(<span class="params">id: <span class="built_in">number</span>, channel: <span class="built_in">string</span>, args: unknown</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">on</span>: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, func: () =&gt; <span class="built_in">void</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">once</span>: <span class="function">(<span class="params">channel: <span class="built_in">string</span>, func: () =&gt; <span class="built_in">void</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">registry</span>: <span class="function">(<span class="params">name: <span class="built_in">string</span>, id: <span class="built_in">number</span>, pid: <span class="built_in">number</span></span>)  =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="attr">BrowserService</span>: &#123;</span><br><span class="line">      <span class="attr">openDevTools</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">connected</span>: <span class="function">(<span class="params">callback?: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="attr">ChildProcessPool</span>: &#123;</span><br><span class="line">      <span class="attr">send</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, params: unknown, givenId: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">      sendToAll: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, params: unknown</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">kill</span>: <span class="function">(<span class="params">id?: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">setMaxInstanceLimit</span>: <span class="function">(<span class="params">count: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="attr">ProcessHost</span>: &#123;</span><br><span class="line">      <span class="attr">registry</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span>, processor: () =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">unregistry</span>: <span class="function">(<span class="params">taskName: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">disconnect</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">exit</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="attr">ProcessManager</span>: &#123;</span><br><span class="line">      <span class="attr">pipe</span>: <span class="function">(<span class="params">pinstance: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">listen</span>: <span class="function">(<span class="params">pids: <span class="built_in">number</span>[], mark: <span class="built_in">string</span>, url?: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">unlisten</span>: <span class="function">(<span class="params">pids: <span class="built_in">number</span>[]</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">openDevTools</span>: <span class="function">(<span class="params">pid: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">killProcess</span>: <span class="function">(<span class="params">pid: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">setIntervalTime</span>: <span class="function">(<span class="params">time: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">      <span class="attr">openWindow</span>: <span class="function">(<span class="params">env: <span class="string">&#x27;prod&#x27;</span> | <span class="string">&#x27;dev&#x27;</span> | <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> ere: electronReModule.electronRe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> = ere;</span><br></pre></td></tr></table></figure><p>然后在 <code>package.json</code> 中声明相关字段引入 types 文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;types&quot;</span>: <span class="string">&quot;./types/index.d.ts&quot;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：<code>commonJs</code> 规范和 <code>ES module</code> 规范的包声明写法略有不同，这里再给出一个 <code>ES module</code> 规范声明文件示例(与 <code>electron-re</code> 无关)：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ReturnTreeData &#123;</span><br><span class="line">  <span class="attr">depth</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">isInEdit</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">key</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">nameEditable</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">nodeDeletable</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">nodeName</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">nodeValue</span>: ReturnTreeData[]</span><br><span class="line">  <span class="attr">valueEditable</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> TreeStateTypes &#123;</span><br><span class="line">  <span class="attr">treeData</span>: ReturnTreeData[];</span><br><span class="line">  expandedKeys: <span class="built_in">string</span>[];</span><br><span class="line">  enableYaml: <span class="built_in">boolean</span>;</span><br><span class="line">  maxLevel: <span class="built_in">number</span>;</span><br><span class="line">  lang: <span class="string">&#x27;zh_CN&#x27;</span> | <span class="string">&#x27;en_US&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> TreePropsDataTypes &#123;</span><br><span class="line">  <span class="attr">nodeName</span>: <span class="built_in">string</span>;</span><br><span class="line">  id: <span class="built_in">string</span>; <span class="comment">// unique id, required</span></span><br><span class="line">  nameEditable ?: <span class="built_in">boolean</span>; <span class="comment">// is level editable (name), default true</span></span><br><span class="line">  valueEditable ?: <span class="built_in">boolean</span>; <span class="comment">// is level editable (value), default true</span></span><br><span class="line">  nodeDeletable ?: <span class="built_in">boolean</span>; <span class="comment">// is level deletable, default true</span></span><br><span class="line">  nodeValue : TreePropsDataTypes[] | <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> TreePropsTypes &#123;</span><br><span class="line">  <span class="attr">data</span>: TreePropsDataTypes[];</span><br><span class="line">  maxLevel: <span class="built_in">number</span>;</span><br><span class="line">  enableYaml: <span class="built_in">boolean</span>;</span><br><span class="line">  lang: <span class="string">&#x27;en_US&#x27;</span> | <span class="string">&#x27;zh_CN&#x27;</span>;</span><br><span class="line">  onDataChange: <span class="function">(<span class="params">params: ReturnTreeData[]</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="built_in">module</span> <span class="string">&#x27;editable-tree-antd&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">EditableTree</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">TreePropsTypes</span>, <span class="title">TreeStateTypes</span>&gt; </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-感谢作为-UI-设计师的-GF-倾情支持">5. 感谢作为 UI 设计师的 GF 倾情支持</h3><p><code>shadowsocks-electron</code> 客户端的图标是 GF 工作之余帮忙处理的，好看的渐变色小飞机图标！</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/logo.png"  alt="logo"></p><h3 id="6-延伸阅读">6. 延伸阅读</h3><ul><li><a href="https://nojsja.gitee.io/blogs/2020/12/08/6d582478.html/">Electron / Node 多进程工具开发日记 ❤️ nojsja/blogs</a></li><li><a href="https://nojsja.gitee.io/blogs/2020/12/18/927d467e.html/">Electron 多进程工具开发日记2：进程管理UI ❤️ nojsja/blogs</a></li><li><a href="https://nojsja.gitee.io/blogs/2020/08/16/1597e5d6.html/">基于Electron 的 smb 客户端文件上传优化探索 ❤️ nojsja/blogs</a></li><li><a href="https://nojsja.gitee.io/blogs/2019/06/12/81770652.html/">Ubuntu18 踩坑记录 - nojsja/blogs ❤️ nojsja/blogs</a></li></ul><h2 id="Final">Final</h2><blockquote><p>结语</p></blockquote><p>这是完整做过的第四个 Electron 项目了，第一个是 Ubuntu 电脑管家，第二个是公司项目：一个类似百度网盘采用 SMB 协议支持的文件管理器，第三个是 <code>electron-re</code> 进程管理工具，最后一个就是这次的 <code>shadowsocks-electron</code> 跨平台 proxy 工具了。</p><p>客户端目前已经发布了 <code>v1.0.0</code> 版本，支持 <strong>Mac</strong> 和 <strong>Ubuntu</strong> x64 平台，主要测试环境是：<strong>Ubuntu20.04 amd64</strong> 和 <strong>MacOS catalina x64</strong>。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/shadowsocks/release.png"  alt="release"></p><p>后期会持续支持，喜欢的话可以去 <a href="https://github.com/nojsja/shadowsocks-electron">github 仓库</a> star ⭐ ！</p><p>近期有这些想完善的功能：</p><ul><li>考虑支持 HTTP Proxy。</li><li>考虑支持 SSR 服务器连接。</li><li>修复二维码导入功能中遮罩层窗口内部二维码高亮区域位置不准确的问题(由系统状态栏导致)，并适配多屏幕。</li><li>很想支持服务器延迟检测和连接速度测试功能，感觉会很炫。</li><li><code>v2ray</code> 的话其实已经以插件的形式支持了，不过目前没有详细测试过这一功能，考虑如有必要后面会直接支持解析 <code>v2ray</code> 加密链接。</li></ul><p>暂时只考虑为 <strong>Mac/Ubuntu</strong> 适配，<strong>Win</strong> 平台的话工具很多，Shadowsocks 官方也有一直在维护的客户端，用起来都很舒服。</p><p>总之学到了新东西，最折磨人的地方其实是折腾 Mac 虚拟机，踩了很多坑，以后我还是继续用我的 <strong>Ubuntu/Win</strong> 双系统吧 ~ 😂</p>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shadowsocks </tag>
            
            <tag> electron </tag>
            
            <tag> crossplatform </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>taro小程序开发笔记</title>
      <link href="/blogs/2021/07/08/671354ab.html/"/>
      <url>/blogs/2021/07/08/671354ab.html/</url>
      
        <content type="html"><![CDATA[<h2 id="Contents">Contents</h2><ul><li><a href="#contents">Contents</a></li><li><a href="#%E5%89%8D%E8%A8%80">## 前言</a></li><li><a href="#%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3">## 微信小程序开发相关</a><ul><li><a href="#i-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%83%8F%E7%B4%A0%E5%8D%95%E4%BD%8Drpx">I. 微信小程序像素单位rpx</a></li><li><a href="#ii-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%BC%E8%88%AA%E5%A4%B4%E9%80%82%E9%85%8D%E8%83%B6%E5%9B%8A%E6%8C%89%E9%92%AE%E9%AB%98%E5%BA%A6">II. 微信小程序自定义导航头适配胶囊按钮高度</a></li><li><a href="#iii-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%9D%A1%E9%80%82%E9%85%8D-iphonex">III. 微信小程序底部导航条适配 Iphonex</a><ul><li><a href="#1-%E5%8E%9F%E7%94%9F%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%80%82%E9%85%8D">1. 原生小程序适配</a></li><li><a href="#2-%E5%86%85%E5%B5%8C-h5-%E9%80%82%E9%85%8D">2. 内嵌 H5 适配</a></li></ul></li><li><a href="#iv-h5%E9%A1%B5%E9%9D%A2%E5%94%A4%E8%B5%B7%E6%8C%87%E5%AE%9A%E7%9A%84%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%B9%B6%E6%89%93%E5%BC%80%E7%89%B9%E5%AE%9A%E9%A1%B5%E9%9D%A2">IV. H5页面唤起指定的小程序并打开特定页面</a></li><li><a href="#v-%E5%AE%9E%E7%8E%B0%E5%B0%86%E4%BB%BB%E6%84%8F-dom-%E5%85%83%E7%B4%A0%E5%86%85%E9%83%A8-innertext-%E5%A4%8D%E5%88%B6%E5%88%B0%E5%89%AA%E8%B4%B4%E6%9D%BF">V. 实现将任意 dom 元素内部 innerText 复制到剪贴板</a></li></ul></li></ul><h2 id="前言">前言</h2><hr><p>最近新接触了小程序开发领域，在工作中使用 <code>Taro</code> 进行微信小程序相关开发，一如既往，踩坑记录也要留下。</p><p>Taro 是一个开放式跨端跨框架解决方案，支持使用 <code>React/Vue/Nerv</code> 等框架来开发 <strong>微信 / 京东 / 百度 / 支付宝 / 字节跳动 / QQ 小程序 / H5 / RN</strong> 等应用。<br>现如今市面上端的形态多种多样，Web、React Native、微信小程序等各种端大行其道。当业务要求同时在不同的端都要求有所表现的时候，针对不同的端去编写多套代码的成本显然非常高，这时候只编写一套代码就能够适配到多端的能力就显得极为需要。</p><h2 id="微信小程序开发相关">微信小程序开发相关</h2><hr><h3 id="I-微信小程序像素单位rpx">I. 微信小程序像素单位rpx</h3><p>Taro 默认以 750px 作为换算尺寸标准，如果设计稿不是以 750px 为标准，则需要在项目配置 config/index.js 中进行设置让微信正确将 rpx 转换为实际屏幕物理像素。例如设计稿尺寸是 640px，则需要修改项目配置 config/index.js 中的 designWidth 配置为 640，如果设计稿是 375px，不在以上三种之中，那么你需要把 designWidth 配置为 375，同时在 DEVICE_RATIO 中添加换算规则如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="attr">projectName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">designWidth</span>: <span class="number">750</span>, <span class="comment">// 设定标准设计稿尺寸</span></span><br><span class="line">  <span class="attr">deviceRatio</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;375&#x27;</span>: <span class="number">2</span> / <span class="number">1</span>, <span class="comment">// 设计稿375px - 转换规则</span></span><br><span class="line">    <span class="string">&#x27;640&#x27;</span>: <span class="number">2.34</span> / <span class="number">2</span>, <span class="comment">// 设计稿640px - 转换规则</span></span><br><span class="line">    <span class="string">&#x27;750&#x27;</span>: <span class="number">1</span>, <span class="comment">// 设计稿750px - 转换规则</span></span><br><span class="line">    <span class="string">&#x27;828&#x27;</span>: <span class="number">1.81</span> / <span class="number">2</span> <span class="comment">// 设计稿828px - 转换规则</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mini</span>: &#123;</span><br><span class="line">    <span class="attr">postcss</span>: &#123;</span><br><span class="line">      <span class="attr">pxtransform</span>: &#123; <span class="comment">// 设置自动转换规则</span></span><br><span class="line">        <span class="attr">enable</span>: <span class="literal">true</span>, <span class="comment">// 是否启用</span></span><br><span class="line">        <span class="attr">config</span>: &#123;</span><br><span class="line">          <span class="attr">onePxTransform</span>: <span class="literal">true</span>, <span class="comment">// 设置 1px 是否需要被转换</span></span><br><span class="line">          <span class="attr">unitPrecision</span>: <span class="number">5</span>, <span class="comment">// REM 单位允许的小数位。</span></span><br><span class="line">          <span class="attr">propList</span>: [<span class="string">&#x27;*&#x27;</span>], <span class="comment">// 允许转换的属性。</span></span><br><span class="line">          <span class="attr">selectorBlackList</span>: [], <span class="comment">// 黑名单里的选择器将会被忽略。</span></span><br><span class="line">          <span class="attr">replace</span>: <span class="literal">true</span>, <span class="comment">// 直接替换而不是追加一条进行覆盖。</span></span><br><span class="line">          <span class="attr">mediaQuery</span>: <span class="literal">false</span>, <span class="comment">// 允许媒体查询里的 px 单位转换</span></span><br><span class="line">          <span class="attr">minPixelValue</span>: <span class="number">0</span>, <span class="comment">// 设置一个可被转换的最小 px 值</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure><p>rpx 即 responsive pixel，可以根据屏幕宽度进行自适应的像素单位，比如规定屏幕宽为 750rpx。以 iPhone6 为例，屏幕宽度为 375px，共有 750 个物理像素，则 750rpx = 375px = 750 物理像素，1rpx = 0.5px = 1 物理像素。</p><p>小程序中默认配置会将所有的 px 单位转换为 rpx，有大写字母的 Px 或 PX 则会被忽略，可以自己在配置中设置自动转换规则(config.mini.postcss.pxtransform)。</p><h3 id="II-微信小程序自定义导航头适配胶囊按钮高度">II. 微信小程序自定义导航头适配胶囊按钮高度</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/mini/iphonex2.png"  alt="iphonex2.png"></p><p>如果某个小程序页面需要自定义导航头部的话，就需要启用相应页面的自定义导航头功能，可以在相关的 <code>page.config</code> 里面配置，比如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">navigationBarTitleText</span>: <span class="string">&#x27;首页&#x27;</span>,</span><br><span class="line">  <span class="attr">navigationBarTextStyle</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">  <span class="attr">navigationStyle</span>: <span class="string">&#x27;custom&#x27;</span>, <span class="comment">// 启用自定义导航</span></span><br><span class="line">  <span class="attr">navigationBarBackgroundColor</span>: <span class="string">&#x27;#2F66FE&#x27;</span>,</span><br><span class="line">  <span class="attr">enableShareAppMessage</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>1）原理：根据系统API - <code>getMenuButtonBoundingClientRect</code> 获取小程序右上角胶囊按钮的位置和宽高信息：</p><blockquote><p>导航头垂直居中的情况下，导航头高度即为：<code>bottom - height / 2</code>(胶囊按钮底部位置 - 胶囊按钮高度的一半)</p></blockquote><ul><li>bottom[number]下边界坐标，单位：px</li><li>height[number]高度，单位：px</li><li>left[number]左边界坐标，单位：px</li><li>right[number]右边界坐标，单位：px</li><li>top[number]上边界坐标，单位：px</li><li>width[number]宽度，单位：px</li></ul><p>2）自定义导航头部源代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Taro <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; View, Image, Text, Button &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义头部导航栏 - fixed 布局 / 无底色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">XbHeader</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">navHeight</span>: <span class="string">&#x27;48rpx&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    <span class="built_in">this</span>.setNavSize();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* 设置导航栏高度 */</span></span><br><span class="line">  setNavSize = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> sysinfo = Taro.getSystemInfoSync();</span><br><span class="line">    <span class="keyword">const</span> &#123; top, height, bottom &#125; = Taro.getMenuButtonBoundingClientRect();</span><br><span class="line">    <span class="keyword">const</span> navHeight = bottom - height / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意不能使用 rpx，API获取到的是 css 像素</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">navHeight</span>: <span class="string">`<span class="subst">$&#123;navHeight&#125;</span>px`</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; navHeight, statusHeight &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;xb-header&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">top:</span> <span class="attr">navHeight</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;iconfont icon-xiebaojia&#x27;</span>&gt;</span><span class="symbol">&amp;#xe67d;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;title&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;title-text&#x27;</span>&gt;</span>纳斯达克上市<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;title-text&#x27;</span>&gt;</span>全国保险经纪牌照<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="III-微信小程序底部导航条适配-Iphonex">III. 微信小程序底部导航条适配 Iphonex</h3><h4 id="1-原生小程序适配">1. 原生小程序适配</h4><p>&gt;  底部导航条页面结构(fixed定位到屏幕底部)：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">View</span></span></span><br><span class="line"><span class="tag">  <span class="attr">className</span>=<span class="string">&#x27;member-identify-footer&#x27;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&#123;&#123;paddingBottom:</span> <span class="attr">utils.isIphoneX</span>() ? <span class="attr">utils.getScreenContentRect</span>()<span class="attr">.padding</span> <span class="attr">:</span> &#x27;<span class="attr">10rpx</span>&#x27; &#125;&#125;</span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;footer-item-wrapper&#x27;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.goBack&#125;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;item-icon&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;item-title&#x27;</span>&gt;</span>&#123; routerAction[from].text &#125;<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;footer-item-wrapper&#x27;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.importAction&#125;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;item-icon&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;item-title&#x27;</span>&gt;</span>导入信息正确人员<span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&gt;  原理：通过API获取屏幕尺寸参数和屏幕安全区域参数，利用 getScreenContentRect 函数得到计算值：</p><ul><li>安全内容区域顶部坐标 <code>top</code>：可用于其它元素进行顶部位置定位</li><li>安全内容区域底部坐标 <code>bottom</code>：可用于其它元素进行底部位置定位</li><li>底部非安全内容区域内容高度 <code>padding</code>：可用于其它元素进行位置定位</li></ul><p>&gt;  屏幕安全内容区域计算函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __getScreenContentRect [根据顶部和底部安全位置，计算屏幕内容区域位置]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>_systemInfo [可以提供已有的 Taro.getSystemInfoSync 信息]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>_menuInfo [可以提供已有的 Taro.getMenuButtonBoundingClientRect 信息]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>_footerHeight [底部导航栏的高度]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Object&#125;</span> </span>安全内容区域的 top/bottom</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getScreenContentRect = <span class="function">(<span class="params">_footerHeight=<span class="string">&#x27;85rpx&#x27;</span>, _systemInfo=<span class="literal">null</span>, _menuInfo=<span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> systemInfo = _systemInfo || Taro.getSystemInfoSync();</span><br><span class="line">  <span class="keyword">const</span> menuInfo = _menuInfo || Taro.getMenuButtonBoundingClientRect();</span><br><span class="line">  <span class="keyword">const</span> &#123; screenHeight, safeArea &#125; = systemInfo</span><br><span class="line">  <span class="keyword">const</span> &#123; bottom &#125; = safeArea;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 安全内容区域顶部坐标(加10px是为了防止区域完全重合)</span></span><br><span class="line">    <span class="attr">top</span>: <span class="string">`<span class="subst">$&#123;menuInfo.bottom + <span class="number">10</span>&#125;</span>px`</span>,</span><br><span class="line">    <span class="comment">// 安全内容区域底部坐标</span></span><br><span class="line">    <span class="attr">bottom</span>: <span class="string">`calc(<span class="subst">$&#123;screenHeight - bottom&#125;</span>px + 10rpx + <span class="subst">$&#123;_footerHeight&#125;</span>)`</span>,</span><br><span class="line">    <span class="comment">// 底部非安全内容区域内容高度</span></span><br><span class="line">    <span class="attr">padding</span>: <span class="string">`calc(<span class="subst">$&#123;screenHeight - bottom&#125;</span>px + 10rpx)`</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;****</span><br></pre></td></tr></table></figure><p>&gt; 示意图：</p><p>位置标识图1：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/mini/iphonex2.png"  alt="iphonex2.png"></p><p>真机标识图2：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/mini/iphonex1.png"  alt="iphonex1.png"></p><h4 id="2-内嵌-H5-适配">2. 内嵌 H5 适配</h4><p>&gt; js 简易判断是否是 iphonex 以上的机型：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIphonex</span>(<span class="params"></span>) </span>&#123;  <span class="comment">// X XS, XS Max, XR</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="built_in">window</span> &amp;&amp;</span><br><span class="line">    navigator.userAgent.indexOf(<span class="string">&#x27;iPhone&#x27;</span>) &gt; -<span class="number">1</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// window.screen.height &gt;= 812 &amp;&amp;</span></span><br><span class="line">    <span class="built_in">window</span>.screen.height &gt;= <span class="number">724</span> &amp;&amp;</span><br><span class="line">    <span class="built_in">window</span>.devicePixelRatio &gt;= <span class="number">2</span></span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>&gt; 如果是 iphonex 机型则添加相应的适配类名：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isIphonex = T.check.isIphonex();</span><br><span class="line">    $(<span class="string">&#x27;div[data-action=iphonex]&#x27;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isIphonex) &#123;</span><br><span class="line">        $(<span class="built_in">this</span>).addClass(<span class="string">&#x27;iphonex&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="built_in">this</span>).removeClass(<span class="string">&#x27;iphonex&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>&gt; 样式表：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.page-footer</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: rem(<span class="number">10px</span>) rem(<span class="number">48px</span>) rem(<span class="number">10px</span>); <span class="comment">// 默认不做iphonex适配</span></span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 特殊处理样式写入一个类里面</span></span><br><span class="line">  &amp;<span class="selector-class">.iphonex</span> &#123;</span><br><span class="line">    <span class="attribute">padding-bottom</span>: rem(<span class="number">88px</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IV-H5页面唤起指定的小程序并打开特定页面">IV. H5页面唤起指定的小程序并打开特定页面</h3><p><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/url-scheme/urlscheme.generate.html#method-http">&gt;&gt;&gt; 官方文档链接</a></p><ol><li><p>原理：使用官方的 scheme url 生成接口生成系统可识别的小程序链接，类似于：<code>weixin://dl/business/?t=DQftHzg06Tj</code></p></li><li><p>Node.js (Express) 端生成 url 示例代码：</p></li></ol><blockquote><p>值得注意的是前端不能将 path 路径参数使用 <code>encodeURIComponent</code> 进行特殊字符编码，否则微信接口不能识别。最后网页端拿到后直接：<code>location.href = [url]</code> 就可以在网页唤醒微信指定页面了。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> miniApps = &#123;</span><br><span class="line">  <span class="attr">appId</span>: <span class="string">&quot;小程序id&quot;</span>,</span><br><span class="line">  <span class="attr">appSecret</span>: <span class="string">&quot;小程序秘钥&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取小程序 URL Schema 链接 */</span></span><br><span class="line">router.post(<span class="regexp">/^(?:\/m)?\/get\/wechatUrlSchema\/?$/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 01 - 获取小程序的accessToken</span></span><br><span class="line">  <span class="keyword">let</span> url =</span><br><span class="line">    <span class="string">&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&quot;</span> +</span><br><span class="line">    miniApps.appId +</span><br><span class="line">    <span class="string">&quot;&amp;secret=&quot;</span> +</span><br><span class="line">    miniApps.appSecret;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    path = <span class="string">&#x27;&#x27;</span>, <span class="comment">// 小程序路径</span></span><br><span class="line">    query = <span class="string">&#x27;&#x27;</span> <span class="comment">// 小程序路径query参数</span></span><br><span class="line">  &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  request.get(&#123; <span class="attr">url</span>: url &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, httpResponse, body</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!err &amp;&amp; httpResponse.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">      <span class="keyword">const</span> access_token = data.access_token;</span><br><span class="line">      <span class="comment">// 02 - 获取小程序的 scheme url</span></span><br><span class="line">      url =</span><br><span class="line">        <span class="string">&quot;https://api.weixin.qq.com/wxa/generatescheme?access_token=&quot;</span> + access_token;</span><br><span class="line">  </span><br><span class="line">      request</span><br><span class="line">        .post(&#123;</span><br><span class="line">          <span class="attr">url</span>: url,</span><br><span class="line">          <span class="attr">json</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">body</span>: &#123;</span><br><span class="line">            <span class="attr">is_expire</span>: <span class="literal">true</span>, <span class="comment">// 控制是否过期</span></span><br><span class="line">            <span class="attr">expire_type</span>: <span class="number">1</span>, <span class="comment">// 过期类型</span></span><br><span class="line">            <span class="attr">expire_interval</span>: <span class="number">1</span>, <span class="comment">// 剩余1天过期</span></span><br><span class="line">            <span class="attr">jump_wxa</span>: &#123;</span><br><span class="line">              <span class="attr">path</span>: path, <span class="comment">// 打开的指定页面</span></span><br><span class="line">              <span class="attr">query</span>: query <span class="comment">// 指定页面 url 携带的查询参数</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response, body</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">            res.json(body);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.json(&#123;</span><br><span class="line">              <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">code</span>: response.statusCode,</span><br><span class="line">              <span class="attr">msg</span>: error || <span class="string">&#x27;获取小程序码失败&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.json(&#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">code</span>: httpResponse.statusCode,</span><br><span class="line">        <span class="attr">msg</span>: err || <span class="string">&#x27;获取小程序密钥失败&#x27;</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="V-实现将任意-dom-元素内部-innerText-复制到剪贴板">V. 实现将任意 dom 元素内部 innerText 复制到剪贴板</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * copyElementText [复制一个dom元素的文本内容-innerText]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">huize20156646</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Element&#125;</span> </span>$elem [原生dom元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;String&#125;</span> </span>[复制的字符串，使用了 textarea 复制，因此支持换行符]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">copyElementText</span>(<span class="params">$elem</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> input = <span class="built_in">document</span>.createElement(<span class="string">&#x27;textarea&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> issuccess = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    input.setAttribute(<span class="string">&#x27;readonly&#x27;</span>, <span class="string">&#x27;readonly&#x27;</span>);</span><br><span class="line">    input.setAttribute(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;text&#x27;</span>);</span><br><span class="line">    input.value = $elem.innerText;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(input);</span><br><span class="line">    input.select();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.execCommand &amp;&amp; <span class="built_in">document</span>.execCommand(<span class="string">&#x27;copy&#x27;</span>)) &#123;</span><br><span class="line">      <span class="built_in">document</span>.execCommand(<span class="string">&#x27;copy&#x27;</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">      issuccess = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(input);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> issuccess;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Taro </category>
          
      </categories>
      
      
        <tags>
            
            <tag> taro </tag>
            
            <tag> mini </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo个人网站优化探索</title>
      <link href="/blogs/2021/05/04/48105820.html/"/>
      <url>/blogs/2021/05/04/48105820.html/</url>
      
        <content type="html"><![CDATA[<h2 id="Contents">Contents</h2><hr><ul><li><a href="#contents">## Contents</a></li><li><a href="#%E5%89%8D%E8%A8%80">## 前言</a><ul><li><a href="#1-hexo-%E6%98%AF%E4%BB%80%E4%B9%88">1. hexo 是什么？</a></li><li><a href="#2-%E4%BD%95%E4%B8%BA%E4%BC%98%E5%8C%96">2. 何为优化？</a></li></ul></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8C%87%E6%A0%87">## 性能优化指标</a><ul><li><a href="#1-%E6%95%B4%E4%BD%93%E8%BF%90%E8%A1%8C%E6%80%A7%E8%83%BD">1. 整体运行性能</a></li><li><a href="#2-%E7%BD%91%E7%AB%99%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7">2. 网站可访问性</a></li><li><a href="#3-%E7%BD%91%E7%AB%99%E6%98%AF%E5%90%A6%E5%BA%94%E7%94%A8%E4%BA%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E7%AD%96%E7%95%A5">3. 网站是否应用了最佳实践策略</a><ul><li><a href="#1-%E4%BD%BF%E7%94%A8-target%22blank%22-%E7%9A%84-a-%E9%93%BE%E6%8E%A5%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E5%A3%B0%E6%98%8E-rel%22noopener-noreferrer%22-%E5%AD%98%E5%9C%A8%E5%AE%89%E5%85%A8%E9%A3%8E%E9%99%A9">&gt; 1) 使用 <code>target=&quot;_blank&quot;</code> 的 <code>&lt;a&gt;</code> 链接如果没有声明 <code>rel=&quot;noopener noreferrer&quot;</code> 存在安全风险。</a></li><li><a href="#2-%E6%A3%80%E6%9F%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AB%AF%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%98%AF%E5%90%A6%E6%9C%89%E5%91%8A%E8%AD%A6%E5%92%8C%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E9%80%9A%E8%BF%87%E6%8C%87%E7%A4%BA%E5%AE%9A%E4%BD%8D%E9%97%AE%E9%A2%98%E5%B9%B6%E8%A7%A3%E5%86%B3">&gt; 2) 检查浏览器端控制台是否有告警和错误提示，通过指示定位问题并解决。</a></li><li><a href="#3-http-%E5%92%8C-https-%E5%8D%8F%E8%AE%AE%E5%9C%B0%E5%9D%80%E4%B8%8D%E6%B7%B7%E7%94%A8">&gt; 3) http 和 https 协议地址不混用</a></li><li><a href="#4-%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-appcache">&gt; 4) 避免使用 AppCache</a></li><li><a href="#5-%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-documentwrite">&gt; 5) 避免使用 document.write()</a></li><li><a href="#6-%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-mutation-events">&gt; 6) 避免使用 mutation events</a></li><li><a href="#7-%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-web-sql">&gt; 7) 避免使用 Web SQL</a></li><li><a href="#8-%E9%81%BF%E5%85%8D%E5%8A%A0%E8%BD%BD%E8%BF%87%E4%BA%8E%E5%BA%9E%E5%A4%A7%E7%9A%84-dom-%E6%A0%91">&gt; 8) 避免加载过于庞大的 DOM 树</a></li><li><a href="#9-%E5%85%81%E8%AE%B8%E7%94%A8%E6%88%B7%E7%B2%98%E8%B4%B4%E5%AF%86%E7%A0%81">&gt; 9) 允许用户粘贴密码</a></li></ul></li><li><a href="#4-%E7%BD%91%E7%AB%99%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BC%98%E5%8C%96seo">4. 网站搜索引擎优化SEO</a></li></ul></li><li><a href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7-lighthouse">## 性能测试工具 lighthouse</a></li><li><a href="#%E5%9F%BA%E4%BA%8E-hexo-%E6%A1%86%E6%9E%B6%E7%9A%84%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96">## 基于 hexo 框架的网站优化</a><ul><li><a href="#1-%E4%BC%98%E5%8C%96%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%97%B4">1. 优化资源加载时间</a><ul><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-deferasync-%E5%BC%82%E6%AD%A5%E4%B8%8B%E8%BD%BD-script-%E8%84%9A%E6%9C%AC%E8%B5%84%E6%BA%90">➣ 使用 defer/async 异步下载 script 脚本资源</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-async-%E5%87%BD%E6%95%B0%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E5%A4%96%E9%83%A8%E8%B5%84%E6%BA%90">➣ 使用 async 函数异步加载外部资源</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8-onfocus-%E4%BA%8B%E4%BB%B6%E5%BB%B6%E8%BF%9F%E5%A4%96%E9%83%A8%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD">➣ 使用浏览器 onfocus 事件延迟外部资源加载</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-preloadprefetchpreconnect-%E8%BF%9B%E8%A1%8C%E9%A2%84%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96">➣ 使用 preload/prefetch/preconnect 进行预加载优化</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-hexo-%E6%8F%92%E4%BB%B6%E5%8E%8B%E7%BC%A9%E4%BB%A3%E7%A0%81%E6%96%87%E4%BB%B6%E5%92%8C%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6">➣ 使用 hexo 插件压缩代码文件和图片文件</a></li><li><a href="#%E2%9E%A3-%E7%BC%96%E5%86%99-hexo-img-lazyload-%E6%8F%92%E4%BB%B6%E5%A2%9E%E5%8A%A0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD%E7%89%B9%E6%80%A7">➣ 编写 hexo-img-lazyload 插件增加图片懒加载特性</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-intersectionobserver-api-%E6%87%92%E5%8A%A0%E8%BD%BD%E5%85%B6%E5%AE%83%E8%B5%84%E6%BA%90">➣ 使用 IntersectionObserver API 懒加载其它资源</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-cdn-%E5%8A%A0%E8%BD%BD%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96%E8%84%9A%E6%9C%AC">➣ 使用 CDN 加载外部依赖脚本</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-aplayer-%E6%9B%BF%E4%BB%A3-iframe-%E5%8A%A0%E8%BD%BD%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90">➣ 使用 Aplayer 替代 iframe 加载网易云音乐</a></li></ul></li><li><a href="#2-%E4%BC%98%E5%8C%96%E7%95%8C%E9%9D%A2%E8%BF%90%E8%A1%8C%E6%80%A7%E8%83%BD">2. 优化界面运行性能</a><ul><li><a href="#%E2%9E%A3-%E4%BC%98%E5%8C%96%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%9B%9E%E6%B5%81%E5%92%8C%E9%87%8D%E7%BB%98%E6%83%85%E5%86%B5">➣ 优化页面的回流和重绘情况</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8%E8%8A%82%E6%B5%81%E5%92%8C%E5%8E%BB%E6%8A%96%E6%80%9D%E6%83%B3%E4%BC%98%E5%8C%96%E6%BB%9A%E5%8A%A8%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC">➣ 使用节流和去抖思想优化滚动事件监听</a></li><li><a href="#%E2%9E%A3-intersectionobserver-api-%E7%9A%84-polyfill-%E5%85%BC%E5%AE%B9%E7%AD%96%E7%95%A5">➣ IntersectionObserver API 的 polyfill 兼容策略</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-intersectionobserver-%E6%9B%BF%E4%BB%A3%E5%8E%9F%E7%94%9F-onscroll-%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC">➣ 使用 IntersectionObserver 替代原生 onscroll 事件监听</a></li></ul></li><li><a href="#3-%E7%BD%91%E7%AB%99%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">3. 网站最佳实践</a><ul><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-hexo-abbrlink-%E6%8F%92%E4%BB%B6%E7%94%9F%E6%88%90%E6%96%87%E7%AB%A0%E9%93%BE%E6%8E%A5">➣ 使用 hexo-abbrlink 插件生成文章链接</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-hexo-filter-nofollow-%E8%A7%84%E9%81%BF%E5%AE%89%E5%85%A8%E9%A3%8E%E9%99%A9">➣ 使用 hexo-filter-nofollow 规避安全风险</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-hexo-deployer-git-%E5%92%8C-github-workflow-%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2">➣ 使用 hexo-deployer-git 和 github workflow 进行自动化部署</a></li></ul></li><li><a href="#4-%E7%BD%91%E7%AB%99seo%E4%BC%98%E5%8C%96">4. 网站SEO优化</a><ul><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8-hexo-generator-sitemap-%E6%8F%92%E4%BB%B6%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E7%BD%91%E7%AB%99%E5%9C%B0%E5%9B%BE">➣ 使用 hexo-generator-sitemap 插件自动生成网站地图</a></li><li><a href="#%E2%9E%A3-%E5%90%91-google-search-console-%E6%8F%90%E4%BA%A4%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99%E5%9C%B0%E5%9B%BE">➣ 向 Google Search Console 提交个人网站地图</a></li></ul></li></ul></li><li><a href="#%E5%8F%82%E8%80%83">## 参考</a></li><li><a href="#%E7%BB%93%E8%AF%AD">## 结语</a></li></ul><h2 id="前言">前言</h2><hr><h3 id="1-hexo-是什么？">1. hexo 是什么？</h3><p>hexo 是一个为了不依赖于后端进行界面实时数据查询展示而设计的网站开发工具。比如之前曾使用 Node.js 作为后台开发过一个博客网站，自己实现后台逻辑的话需要考虑数据库存储、前后端交互、后端 Server 部署啥的。整个流程比较繁杂，在初期可以作为前端开发者个人建站学习的一种方式。hexo 简化了这一流程，它将数据存储和数据获取这两方面都通过编译构建然后本地化集成到前端静态资源里。一个例子就是博客网站通常需要翻页功能来获取博客文章，传统开发方式下，获取下一页这个操作由前端脚本发起，并由后端 Server 处理请求并返回，但是使用 hexo 之后这整个过程都是在本地一次完成的，hexo 将所有静态资源在本地建立了索引。</p><p>使用 hexo 通常写手只需要关注 markdown 格式文章的编写，其余的网站编译、构建和发布的流程都可以交由框架进行处理，所有的网站内容均会被打包成静态的 html/css/js 文件。hexo 支持自定义插件，也有一个插件社区，如果写手同时具备前端能力的话也可以发布自己的插件到社区里进行开源共享。</p><h3 id="2-何为优化？">2. 何为优化？</h3><p>我们通常所讲的性能高低可能侧重于对网站运行速度快慢的评估，其包括静态资源及脚本获取的速度和网站UI界面是否运行流畅。其实广义上的优化应包括：网站性能优化、网站可访性优化、网站SEO优化、网站最佳实践等。</p><h2 id="性能优化指标">性能优化指标</h2><hr><h3 id="1-整体运行性能">1. 整体运行性能</h3><ul><li><p><strong>FCP</strong> (First Contentful Paint)：从用户开始发起网站请求到浏览器第一次开始渲染网站数据的所用时长。其中提及的第一次开始渲染的网站数据包含网页的文字、图片、HTML DOM 结构等，而不包含位于 iframe 中的网页数据。该指标通常用于衡量本地和服务器首次建立网络通讯的速度。</p></li><li><p><strong>TTI</strong> (Time To Interactive)：从用户开始导航至网站到页面变为完全可交互所花费的时间。网站可交互的衡量标准就是：网站展示了实际可用的内容、界面上可见元素的网页事件已经被成功绑定(比如点击、拖动等事件)、用户和页面交互的反馈时间低于 50 ms。</p></li><li><p><strong>SI</strong> (Speed Index)：衡量页面加载过程中内容可视化显示的速度。通俗来讲就是网站界面元素的绘制和呈现速度，如果使用 lighthouse 测量工具的话它会捕获浏览器中处于加载中的页面的多个图片帧，然后计算帧之间的视觉渲染进度。</p></li><li><p><strong>TBT</strong> (Total Blocking Time)：衡量从页面首次开始渲染(FCP)之后到页面实际可交互(TTI)的时间。通常我们访问一个网站时网站整体呈现后，有一段较短的时间我们不能和界面进行交互，比如鼠标点击、键盘按键等，这段时间浏览器在进行脚本及样式的加载和执行。</p></li><li><p><strong>LCP</strong> (Largest Contentful Paint)：测量视口中最大的内容元素何绘制到屏幕<br>所需的时间。通常包含这个元素的下载、解析和渲染整个过程。</p></li><li><p><strong>CLS</strong> (Cumulative Layout Shift)：一个衡量网站加载时整体布局抖动情况的数值指标。如果一个网站在加载过程中用户界面多次抖动和闪烁的话会可能引起用户的轻度不适，因此应该尽量减少网站的重排和重绘次数。</p></li></ul><h3 id="2-网站可访问性">2. 网站可访问性</h3><ul><li>网页背景色和网站文字前景的对比度不能太低，否则会影响用户阅读。</li><li>网页链接标签 <code>&lt;a&gt;</code> 最好包含对链接的描述信息，比如：<code>&lt;a href=&quot;https://github.com/nojsja&quot;&gt;[描述- nojsja 的 github 个人界面]&lt;/a&gt;</code>。</li><li>html 元素存在 <code>lang</code> 属性指定当前语言环境。</li><li>正确的 html 语义化标签能让键盘和读屏器正常工作，通常一个网页的结构可以用语义化标签描述为：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;skip-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#maincontent&quot;</span>&gt;</span>Skip to main<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Page title<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://google.com&quot;</span>&gt;</span>Nav link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span>header<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span> <span class="attr">id</span>=<span class="string">&quot;maincontent&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Section heading<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>text info<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Sub-section heading<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>texgt info<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span>&gt;</span>footer<span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>界面元素的 id 唯一性。</li><li>img 标签的 <code>alt</code> 属性声明。它指定了替代文本，用于在图像无法显示或者用户禁用图像显示时，代替图像显示在浏览器中的内容。</li><li>form 元素内部声明 <code>label</code> 标签以让读屏器正确工作。</li><li>iframe 元素声明 <code>title</code> 属性来描述其内部内容以便于读屏器工作。</li><li>aria 无障碍属性和标签的使用，相关参考 <a href="https://developers.google.com/web/fundamentals/accessibility/semantics-aria/aria-labels-and-relationships">&gt;&gt; aria reference</a></li><li>input[type=image]、object 标签添加 <code>alt</code> 属性声明：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;image&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Sign in&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./sign-in-button.png&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">alt</span>=<span class="string">&quot;report.pdf type=&quot;</span><span class="attr">application</span>/<span class="attr">pdf</span>&quot; <span class="attr">data</span>=<span class="string">&quot;/report.pdf&quot;</span>&gt;</span></span><br><span class="line">Annual report.</span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>需要使用 tab 按键聚焦特性的元素可以声明 <code>tabindex</code> 属性，当我们按 tab 键时焦点会依次切换。并且根据键盘序列导航的顺序，值为 0 、非法值、或者没有 tabindex 值的元素应该放置在 tabindex 值为正值的元素后面：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) tabindex=负值 (通常是tabindex=“-1”)，表示元素是可聚焦的，但是不能通过键盘导航来访问到该元素，用JS做页面小组件内部键盘导航的时候非常有用。</span><br><span class="line">2) tabindex=&quot;0&quot; ，表示元素是可聚焦的，并且可以通过键盘导航来聚焦到该元素，它的相对顺序是当前处于的DOM结构来决定的。</span><br><span class="line">3) tabindex=正值，表示元素是可聚焦的，并且可以通过键盘导航来访问到该元素；它的相对顺序按照tabindex 的数值递增而滞后获焦。如果多个元素拥有相同的 tabindex，它们的相对顺序按照他们在当前DOM中的先后顺序决定。</span><br></pre></td></tr></table></figure><ul><li>table 元素中正确使用 <code>th</code> 和 <code>scope</code> 让行表头和列表头与其数据域一一对应：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">caption</span>&gt;</span>My marathon training log<span class="tag">&lt;/<span class="name">caption</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Week<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Total miles<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Longest run<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>14<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>5<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>16<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>6<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>video 元素指定 <code>track</code>文本字幕资源以方便听障人士使用(需要有字幕资源文件)：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;marathonFinishLine.mp4&quot;</span> <span class="attr">type</span>=<span class="string">&quot;video/mp4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">track</span> <span class="attr">src</span>=<span class="string">&quot;captions_en.vtt&quot;</span> <span class="attr">kind</span>=<span class="string">&quot;captions&quot;</span> <span class="attr">srclang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">label</span>=<span class="string">&quot;english_captions&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">track</span> <span class="attr">src</span>=<span class="string">&quot;audio_desc_en.vtt&quot;</span> <span class="attr">kind</span>=<span class="string">&quot;descriptions&quot;</span> <span class="attr">srclang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">label</span>=<span class="string">&quot;english_description&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">track</span> <span class="attr">src</span>=<span class="string">&quot;captions_es.vtt&quot;</span> <span class="attr">kind</span>=<span class="string">&quot;captions&quot;</span> <span class="attr">srclang</span>=<span class="string">&quot;es&quot;</span> <span class="attr">label</span>=<span class="string">&quot;spanish_captions&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">track</span> <span class="attr">src</span>=<span class="string">&quot;audio_desc_es.vtt&quot;</span> <span class="attr">kind</span>=<span class="string">&quot;descriptions&quot;</span> <span class="attr">srclang</span>=<span class="string">&quot;es&quot;</span> <span class="attr">label</span>=<span class="string">&quot;spanish_description&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>li 列表标签放在容器组件 <code>ul</code> 或 <code>ol</code> 中使用。</li><li>heading 标签严格按照升序声明，配合 <code>section</code> 或其它元素(例如p标签)正确反映界面内容结构：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Page title<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Section Heading<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Sub-section Heading<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>使用 <code>&lt;meta charset=&quot;UTF-8&quot;&gt;</code> 指定网站字符集编码。</li><li>img 元素引用的图片资源长宽比应该和 img 当前应用的长宽比相同，不然可能造成图片扭曲。</li><li>添加 <code>&lt;!DOCTYPE html&gt;</code> 以防止浏览界面渲染异常。</li></ul><h3 id="3-网站是否应用了最佳实践策略">3. 网站是否应用了最佳实践策略</h3><h4 id="1-使用-target-blank-的-a-链接如果没有声明-rel-noopener-noreferrer-存在安全风险。">&gt; 1) 使用 <code>target=&quot;_blank&quot;</code> 的 <code>&lt;a&gt;</code> 链接如果没有声明 <code>rel=&quot;noopener noreferrer&quot;</code> 存在安全风险。</h4><p>当页面链接至使用 target=“_blank” 的另一个页面时，新页面将与旧页面在同一个进程上运行。如果新页面正在执行开销极大的 JavaScript，旧页面性能可能会受影响。并且新的页面可以通过 <code>window.opener</code> 访问旧的窗口对象，比如它可以使用 <code>window.opener.location = url</code> 将旧页面导航至不同的网址。</p><h4 id="2-检查浏览器端控制台是否有告警和错误提示，通过指示定位问题并解决。">&gt; 2) 检查浏览器端控制台是否有告警和错误提示，通过指示定位问题并解决。</h4><h4 id="3-http-和-https-协议地址不混用">&gt; 3) http 和 https 协议地址不混用</h4><p>浏览器已经逐渐开始禁止不用协议资源的混用，比如使用 http 协议的 web 服务器加载 https 协议开头的资源，因此可能出现以下几种情况：</p><ul><li>加载了混合内容，但会出现警告；</li><li>不加载混合内容，直接会显示空白内容；</li><li>在加载混合内容之前，会出现类似是否“显示”，或存在不安全风险而被“阻止”的提示！</li></ul><p>应该考虑以下方式进行优化：</p><ul><li>将站点加载的部分协议混用外部资源放入自己的服务器进行托管；</li><li>对于部署了 https 的网站，在网页声明 <code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot;  content=&quot;upgrade-insecure-requests&quot;</code>将 http 请求转换成 https 请求；</li><li>对于部署了 https 的网站，在服务器端添加请求首部：<code>header(&quot;Content-Security-Policy: upgrade-insecure-requests&quot;)</code>也可以达到一样的效果;</li><li>对于同时支持 http 和 https 访问的网站，考虑使用相对协议，而不直接明文指定协议：<code>&lt;script src=&quot;//path/to/js&quot;&gt;</code>，浏览器发送请求时会根据当前页面协议进行动态切换。</li><li>类同于使用相对协议，使用相对URL也能达到目的，不过增加了资源之间的耦合度：<code>&lt;script src=&quot;./path/to/js&quot;&gt;&lt;/script&gt;</code></li></ul><h4 id="4-避免使用-AppCache">&gt; 4) 避免使用 AppCache</h4><p>AppCache已被废弃 考虑使用service worker的Cache API，</p><h4 id="5-避免使用-document-write">&gt; 5) 避免使用 document.write()</h4><p>对于网速较慢（2G、3G或较慢的WLAN）的用户，外部脚本通过document.write()动态注入会使页面内容的显示延迟数十秒。</p><h4 id="6-避免使用-mutation-events">&gt; 6) 避免使用 mutation events</h4><p>以下mutation events会损害性能，在DOM事件规范中已经弃用：</p><ul><li>DOMAttrModified</li><li>DOMAttributeNameChanged</li><li>DOMCharacterDataModified</li><li>DOMElementNameChanged</li><li>DOMNodeInserted</li><li>DOMNodeInsertedIntoDocument</li><li>DOMNodeRemoved</li><li>DOMNodeRemovedFromDocument</li><li>DOMSubtreeModified</li></ul><p>建议使用 MutationObserver 替代</p><h4 id="7-避免使用-Web-SQL">&gt; 7) 避免使用 Web SQL</h4><p>建议替换为IndexedDB</p><h4 id="8-避免加载过于庞大的-DOM-树">&gt; 8) 避免加载过于庞大的 DOM 树</h4><p>大型的DOM树会以多种方式降低页面性能：</p><ul><li>网络效率和负载性能，如果你的服务器发送一个大的DOM树，你可能会运送大量不必要的字节。这也可能会减慢页面加载时间，因为浏览器可能会解析许多没有显示在屏幕上的节点。</li><li>运行时性能。当用户和脚本与页面交互时，浏览器必须不断重新计算节点的位置和样式。一个大的DOM树与复杂的样式规则相结合可能会严重减慢渲染速度。</li><li>内存性能。如果使用通用查询选择器（例如，document.querySelectorAll(‘li’) 您可能会无意中将引用存储到大量的节点），这可能会压倒用户设备的内存功能。</li></ul><p>一个最佳的DOM树：</p><ul><li>总共少于1500个节点。</li><li>最大深度为32个节点。</li><li>没有超过60个子节点的父节点。</li><li>一般来说，只需要在需要时寻找创建DOM节点的方法，并在不再需要时将其销毁。</li></ul><h4 id="9-允许用户粘贴密码">&gt; 9) 允许用户粘贴密码</h4><p>密码粘贴提高了安全性，因为它使用户能够使用密码管理器。密码管理员通常为用户生成强密码，安全地存储密码，然后在用户需要登录时自动将其粘贴到密码字段中。<br>删除阻止用户粘贴到密码字段的代码。使用事件断点中的Clipboard paste来打断点，可以快速找到阻止粘贴密码的代码。比如下列这种阻止粘贴密码的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;input&#x27;</span>);</span><br><span class="line">input.addEventListener(<span class="string">&#x27;paste&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="4-网站搜索引擎优化SEO">4. 网站搜索引擎优化SEO</h3><ul><li>添加视口声明 <code>&lt;meta name=&quot;viewport&quot;&gt;</code> 并指定 with 和 device-width 来优化移动端显示。</li><li>document 添加 <code>title</code> 属性以让读屏器和搜索引擎正确识别网站内容。</li><li>添加 <code>meta</code> desctiption 标签来描述网站内容 <code>&lt;meta name=&quot;description&quot; content=&quot;Put your description here.&quot;&gt;</code>。</li><li>为链接标签添加描述文本 <code>&lt;a href=&quot;videos.html&quot;&gt;basketball videos&lt;/a&gt;</code>，以清楚传达这个超链接的指向内容。</li><li>使用正确的 href 链接地址以让搜索引擎正确跟踪实际网址，以下是反例：<code>&lt;a onclick=&quot;goto('https://example.com')&quot;&gt;</code></li><li>不要使用 meta 标签来禁用搜索引擎爬虫爬取你的网页，以下是反例：<code>&lt;meta name=&quot;robots&quot; content=&quot;noindex&quot;/&gt;</code>，相对的可以特殊的排除一些爬虫爬取：<code>&lt;meta name=&quot;AdsBot-Google&quot; content=&quot;noindex&quot;/&gt;</code>。</li><li>image 图片元素中使用具有明确意图和含义的 alt 属性文字来说明图片信息，并且避免使用一些非特定指代词比如： <code>&quot;chart&quot;, &quot;image&quot;, &quot;diagram&quot;</code>(图表、图片)。</li><li>不要使用插件来显示您的内容，即避免使用 <code>embed</code>、<code>object</code>、<code>applet</code>等标签来引入资源。</li><li>正确放置 <code>robots.txt</code> 到网站根目录下，它描述了此网站中的哪些内容是不应被搜索引擎的获取的，哪些是可以被获取的。通常一些后台文件（如css、js）和用户隐私的文件不用被搜索引擎抓取，另外有些文件频繁被蜘蛛抓取，但是这些文件又是不重要的，那么可以用robots.txt进行屏蔽。<br>一个实例：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Allow: /</span><br><span class="line">Disallow: /wp-admin/</span><br><span class="line">Disallow: /wp-includes/</span><br><span class="line">Disallow: /wp-content/plugins/</span><br><span class="line">Disallow: /?r=*</span><br></pre></td></tr></table></figure><ul><li>向搜索引擎提交网站地图 sitemap.xml，xml格式的文本就是专门拿来给电脑进行阅读的语，而 sitemap.xml就是搜寻引擎利用这个规范，让网站主可以使用它来制作一个包含了网站内所有网页的目录档案，提供给搜寻引擎的爬虫阅读。就像是一个地图一样，让搜寻引擎可以知道网站内到底有些什么网页。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>https://nojsja.github.io/blogs/2019/10/26/63567fa4.html/<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2021-04-29T10:02:04.853Z<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>https://nojsja.github.io/blogs/2020/03/26/7507699.html/<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2021-04-29T10:01:30.661Z<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="性能测试工具-lighthouse">性能测试工具 lighthouse</h2><hr><p>以上提到的性能监测指标通过 lighthouse 网站性能监测工具可以自动化分析和生成性能测试结果数据，较新版本的 <code>chrome</code> 和 采用 <code>chromium</code> 架构的 <code>edge</code> 浏览器都已经自带了，较低版本的 <code>chrome</code> 浏览器可以通过在商店搜索插件安装。安装后使用 F12 打开控制台，切换到 <code>lighthouse</code> 一栏即可直接使用了：</p><p>如图，可以自行决定勾选测试项目和针对测试平台(桌面/移动端)，最后点击生成报告即可开始运行自动化测试任务，并在测试完成后打开一个分析结果页面：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/lighthouse.png"  alt="lighthouse"></p><p>结果界面：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/lighthouse-test.png"  alt="lighthouse-test"></p><p>至此我们就能对网站的整体性能进行一些评估了，上图中的<code>Performance</code>、<code>Accessibility</code>、<code>Best Practices</code>、和 <code>SEO</code> 依次对应上文我们提及的网站整体性能、网站可访问性、网站最佳实践、搜索引擎SEO优化等指标。我们可以点击每一个具体项目来查看测试工具给出的优化建议：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/lighthouse-test-detail.png"  alt=""></p><p>测试结果很大程度上取决于你的 http 静态资源服务器的资源加载速度，比如在不使用代理的情况下，使用 github pages 服务来托管静态资源会比使用国内的 gitee pages 托管服务稍慢，而且可能出现部分资源加载失败的问题。因此国内用户可以使用 gitee pages 来替代 github pages，不过 gitee 非付费用户没有代码自动构建部署功能，需要使用下文提到的 <code>github action</code> 来进行自动化登录并触发构建和部署。</p><p><strong>注意：</strong> 某些浏览器上安装的插件会影响测试结果，因为插件可能会发起请求加载其它脚本啥的。这种情况下可以直接使用 npm 包管理器全局安装 <code>npm install -g lighthouse</code>，然后使用命令行启动测试流程：<code>lighthouse https://nojsja.gitee.io/blogs --view --preset=desktop --output-path='/home/nojsja/Desktop/lighthouse.html'</code>。最终会根据指定的地址生成一个可直接浏览器测试结果网页文件 <code>lighthouse.html</code>，可以直接打开进行性能排查。</p><h2 id="基于-hexo-框架的网站优化">基于 hexo 框架的网站优化</h2><hr><p>之前写的一篇文章 <a href="https://nojsja.gitee.io/blogs/2021/02/07/9acea179.html/">《前端性能优化技巧详解(1)》</a>，详细的描述了前端性能优化的一些方面，这篇文章不会再罗列每一点，只会对博客中实际应用的优化手段进行说明，大致被划分成这几个方面：</p><ol><li>优化资源加载时间</li><li>优化界面运行性能</li><li>网站最佳实践</li><li>网站 SEO 优化</li></ol><h3 id="1-优化资源加载时间">1. 优化资源加载时间</h3><p>常见的加载时间优化方式包含以下：</p><ul><li>提高网页资源并行加载能力</li><li>延迟加载不必要的外部资源</li><li>减少碎片化的外部资源请求，小文件做合并</li><li>增加网站带宽</li></ul><h4 id="➣-使用-defer-async-异步下载-script-脚本资源">➣ 使用 defer/async 异步下载 script 脚本资源</h4><p>HTML在解析时遇到声明的<code>&lt;script&gt;</code>脚本会立即下载和执行，往往会延迟界面剩余部分的解析，造成界面白屏的情况。比较古老的优化方式之一就是将脚本放到HTML文档末尾，这样子解决了白屏的问题，可是在DOM文档结构复杂冗长时，也会造成一定的界面脚本下载和执行延迟，script标签新属性async和defer可以解决此类问题：</p><ul><li>defer脚本：声明 defer 属性的外部<code>&lt;script&gt;</code>脚本下载时不会阻塞HTML的解析和渲染，并且会在HTML渲染完成并且可实际操作之后开始执行(<code>DOMContentLoaded</code>事件被触发之前)，各个脚本解析执行顺序对应声明时的位置顺序，执行完成后会触发页面<code>DOMContentLoaded</code>事件。</li><li>async脚本：声明 async 属性的外部<code>&lt;script&gt;</code>脚本下载时不会阻塞HTML的解析和渲染，各个脚本的下载和执行完全独立，下载完成后即开始执行，所以执行顺序不固定，与DOMContentLoaded事件的触发没有关联性。</li></ul><p>在我的博客网站中有使用 <code>Bootstrap</code> 外部依赖的样式和js脚本，但是需要确保他们的声明顺序在靠前的位置，因为使用异步技术之后，内联同步执行的其它<code>&lt;script&gt;</code>脚本的执行顺序就不能保证了，因此不能使用 <code>defer/async</code> 属性进行优化。</p><p>通常 <code>async/defer</code> 会用于优化一些独立的子组件依赖脚本的加载，比如用于博客文章中的导航条跳转的脚本，它的执行顺序完全不收到其它部分的制约，因此可以独立出来使用 <code>async</code> 属性进行优化。但是需要确保该脚本作用的 <code>导航条</code> DOM元素声明位于脚本引入位置之前，以防止出现脚本执行时 DOM 元素还未渲染的状态，引起脚本错误。</p><h4 id="➣-使用-async-函数异步加载外部资源">➣ 使用 async 函数异步加载外部资源</h4><p>以下 async 函数作用就是根据传入的 url 创建 <code>link/script</code> 标签并添加到 <code>&lt;head&gt;</code>  标签中以动态加载外部资源，并且在存在回调函数时监听资源加载情况，加载完毕后再执行回调函数。值得注意的是本方法与直接通过<code>script</code> 声明依赖资源的不同之处在于不会阻塞界面，脚本的下载和执行都是异步的。</p><p>博客中常用于在某个特殊的情况下利用编程方法动态载入外部依赖库，并在回调函数内进行外部库的初始化。例如我的博客使用了一个音乐播放器组件，在网页可视区域滚动到包含这个组件的尚未初始化的 DOM 元素时，就是用 <code>async</code> 来请求服务器的 js 脚本资源，加载完成后在回调函数里初始化这个音乐播放器。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * async [异步脚本加载]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>u [资源地址]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>c [回调函数]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>tag [加载资源类型 link | script]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Boolean&#125;</span> </span>async [加载 script 资源时是否需要声明 async 属性]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async</span>(<span class="params">u, c, tag, <span class="keyword">async</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> head = <span class="built_in">document</span>.head ||</span><br><span class="line">      <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>] ||</span><br><span class="line">      <span class="built_in">document</span>.documentElement;</span><br><span class="line">    <span class="keyword">var</span> d = <span class="built_in">document</span>, t = tag || <span class="string">&#x27;script&#x27;</span>,</span><br><span class="line">      o = d.createElement(t),</span><br><span class="line">      s = d.getElementsByTagName(t)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">async</span> = [<span class="string">&#x27;async&#x27;</span>, <span class="string">&#x27;defer&#x27;</span>].includes(<span class="keyword">async</span>) ? <span class="keyword">async</span> : !!<span class="keyword">async</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span>(t) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;script&#x27;</span>:</span><br><span class="line">        o.src = u;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">async</span>) o[<span class="keyword">async</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;link&#x27;</span>:</span><br><span class="line">        o.type = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        o.href = u;</span><br><span class="line">        o.rel = <span class="string">&quot;stylesheet&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        o.src = u;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* callback */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c) &#123; </span><br><span class="line">      <span class="keyword">if</span> (o.readyState) &#123;<span class="comment">//IE</span></span><br><span class="line">        o.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (o.readyState == <span class="string">&quot;loaded&quot;</span></span><br><span class="line">            || o.readyState == <span class="string">&quot;complete&quot;</span>) &#123;</span><br><span class="line">            o.onreadystatechange = <span class="literal">null</span>;</span><br><span class="line">            c(<span class="literal">null</span>, e)();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;<span class="comment">//其他浏览器</span></span><br><span class="line">        o.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">          c(<span class="literal">null</span>, e);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s.parentNode.insertBefore(o, head.firstChild);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="➣-使用浏览器-onfocus-事件延迟外部资源加载">➣ 使用浏览器 onfocus 事件延迟外部资源加载</h4><p>通过用户和界面交互触发一些事件后，满足了外部资源加载的条件，再触发外部资源的加载，也属于延迟加载的一种优化。</p><p>例如我的博客中右侧导航条区域有个搜索框可以搜索博客文章，本身这个搜索是通过查找本地预先生成的一个资源索引静态XML文件来实现的。文章和内容较多这个这个XML文件就会变得庞大，如果在网页首次加载时就下载它一定会造成网页带宽和网络请求数量的占用。因此考虑在用户点击搜索框将焦点集中到上面时再触发XML的异步下载，同时为了不影响使用体验，可以在加载过程中设置 loading 效果以指示用户延迟操作。</p><h4 id="➣-使用-preload-prefetch-preconnect-进行预加载优化">➣ 使用 preload/prefetch/preconnect 进行预加载优化</h4><ul><li>preload 用来预加载当前页面所需的资源，如图像，CSS，JavaScript 和字体文件，它的加载优先级比 prefetch 更高，同时也要注意 preload 并不会阻塞 window 的 onload 事件。博客中有使用它来预加载 css 中引用的字体：<code>&lt;link href=&quot;/blogs/fonts/fontawesome-webfont.woff2?v=4.3.0&quot; rel=preload as=&quot;font&quot;&gt;</code>，针对不同的资源类型需要添加不同的 <code>as</code> 标记信息，如果是跨域加载的话注意添加 <code>crossorigin</code> 属性声明。</li><li>prefetch 是一个低优先级的资源提示，一旦一个页面加载完毕就会开始下载其他的预加载资源，并且将他们存储在浏览器的缓存中。其中 prefretch 又包含：<code>link、DNS 和 prerendering</code> 三中类型的预加载请求。link prefetch 比如：<code>&lt;link rel=&quot;prefetch&quot; href=&quot;/path/to/pic.png&quot;&gt;</code> 允许浏览器获取资源并将他们存储在缓存中；DNS prefetch 允许浏览器在用户浏览页面时在后台运行 DNS prerender 和 prefetch 非常相似，它们都优化了下一页资源的未来请求，区别是 prerender 在后台渲染了整个页面，因此应该小心使用，可能会造成网络带宽的浪费。</li><li>preconnect 允许浏览器在一个 HTTP 请求正式发给服务器前预先执行一些操作，这包括 DNS 解析，TLS 协商，TCP 握手，这消除了往返延迟并为用户节省了时间。比如博客中：不算子统计库的网页预连接 <code>&lt;link href=&quot;http://busuanzi.ibruce.info&quot; rel=&quot;preconnect&quot; crossorigin&gt;</code>。</li></ul><h4 id="➣-使用-hexo-插件压缩代码文件和图片文件">➣ 使用 hexo 插件压缩代码文件和图片文件</h4><p>压缩静态资源也是一种节省网络带宽，提高请求响应速度的方式。通常采用工程化的方式进行配置，而不用手动对每张图片进行压缩。我的博客中使用了 hexo 的一款压缩插件 <a href="https://github.com/chenzhutian/hexo-all-minifier">Hexo-all-minifier</a>，通过压缩 HTML、CSS、JS 和图片来优化博客访问速度。</p><p>安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-all-minifier --save</span><br></pre></td></tr></table></figure><p>在 <code>config.yml</code> 配置文件中启用：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---- 代码和资源压缩</span></span><br><span class="line"><span class="attr">html_minifier:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">css_minifier:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.min.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">js_minifier:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mangle:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">compress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.min.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image_minifier:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">interlaced:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">multipass:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">optimizationLevel:</span> <span class="number">2</span> <span class="comment"># 压缩等级</span></span><br><span class="line">  <span class="attr">pngquant:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">progressive:</span> <span class="literal">true</span> <span class="comment"># 是否启用渐进式图片压缩</span></span><br></pre></td></tr></table></figure><p>资源的压缩比较消耗性能和时间，可以考虑在开发环境下不启用这些插件以加快开发环境启动。比如单独指定一个 <code>_config.dev.yml</code> 然后把上述插件全部关闭即可，参考 <code>package.json</code> 中的脚本字段声明：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;prestart&quot;</span>: <span class="string">&quot;hexo clean --config config.dev.yml; hexo generate --config config.dev.yml&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;prestart:prod&quot;</span>: <span class="string">&quot;hexo clean; hexo generate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;predeploy&quot;</span>: <span class="string">&quot;hexo clean; hexo generate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;hexo generate --config config.dev.yml; hexo server --config config.dev.yml&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start:prod&quot;</span>: <span class="string">&quot;hexo generate --config config.dev.yml; hexo server&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;performance:prod&quot;</span>: <span class="string">&quot;lighthouse https://nojsja.gitee.io/blogs --view --preset=desktop --output-path=&#x27;/home/nojsja/Desktop/lighthouse.html&#x27;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;performance&quot;</span>: <span class="string">&quot;lighthouse http://localhost:4000/blogs --view --preset=desktop --output-path=&#x27;/home/nojsja/Desktop/lighthouse.html&#x27;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span>: <span class="string">&quot;hexo deploy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-编写-hexo-img-lazyload-插件增加图片懒加载特性">➣ 编写 hexo-img-lazyload 插件增加图片懒加载特性</h4><p>在进行博客优化的时候为了学习 hexo 自己的插件系统，使用 <code>IntersectionObserver API</code> 来编写了一个图片懒加载插件：<a href="https://www.npmjs.com/package/hexo-img-lazyload">hexo-img-lazyload</a>，可以通过 npm 命令进行安装：<code>npm i hexo-img-lazyload</code>。</p><p>效果预览：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/lazyloading.png"  alt="hexo-immg-lazyload"></p><p>插件主要原理就是监听博客构建流程的钩子事件，拿到构建好的代码字符串，然后代码中原生的图片声明比如：<code>&lt;img src=&quot;path/to/xx.jpg&quot;&gt;</code>通过正则全局匹配并替换为：<code>&lt;img src=&quot;path/to/loading&quot; data-src=&quot;path/to/xx.jpg&quot;&gt;</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lazyProcessor</span>(<span class="params">content, replacement</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> content.replace(<span class="regexp">/&lt;img(.*?)src=&quot;(.*?)&quot;(.*?)&gt;/gi</span>, <span class="function"><span class="keyword">function</span> (<span class="params">str, p1, p2, p3</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/data-loaded/gi</span>.test(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/no-lazy/gi</span>.test(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`&lt;img <span class="subst">$&#123;p1&#125;</span> src=&quot;<span class="subst">$&#123;emptyStr&#125;</span>&quot; lazyload data-loading=&quot;<span class="subst">$&#123;replacement&#125;</span>&quot; data-src=&quot;<span class="subst">$&#123;p2&#125;</span>&quot; <span class="subst">$&#123;p3&#125;</span>&gt;`</span>;</span><br><span class="line">    &#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>替换之后还需要使用 hexo 的代码注入功能将我们自己编写的代码注入到每个构建好的界面中。</p><p>hexo 代码注入：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* registry scroll listener */</span></span><br><span class="line">hexo.extend.injector.register(<span class="string">&#x27;body_end&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> script = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;observerStr&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/script&gt;`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> script;</span><br><span class="line">&#125;, injectionType)</span><br></pre></td></tr></table></figure><p>被注入的用于监听待加载图片元素是否进入可视区域以进行动态加载的部分代码，使用了 <code>IntersectionObserver API</code> 而不是 <code>window.onscroll</code> 事件的方式，前者具有更好的性能，由浏览器统一监听所有元素位置信息更改并分发滚动事件结果：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* avoid garbage collection */</span></span><br><span class="line">  <span class="built_in">window</span>.hexoLoadingImages = <span class="built_in">window</span>.hexoLoadingImages || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.querySelectorAll(selector);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* registry listener */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.IntersectionObserver) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> observer = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span> (<span class="params">entries</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      entries.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">entry</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// in view port</span></span><br><span class="line">        <span class="keyword">if</span> (entry.isIntersecting) &#123;</span><br><span class="line">          observer.unobserve(entry.target);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// proxy image</span></span><br><span class="line">          <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">          <span class="keyword">var</span> imgId = <span class="string">&quot;_img_&quot;</span> + <span class="built_in">Math</span>.random();</span><br><span class="line">          <span class="built_in">window</span>.hexoLoadingImages[imgId] = img;</span><br><span class="line"></span><br><span class="line">          img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            entry.target.src = entry.target.getAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">            <span class="built_in">window</span>.hexoLoadingImages[imgId] = <span class="literal">null</span>;</span><br><span class="line">          &#125;;</span><br><span class="line">          img.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">window</span>.hexoLoadingImages[imgId] = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          entry.target.src = entry.target.getAttribute(<span class="string">&#x27;data-loading&#x27;</span>);</span><br><span class="line">          img.src = entry.target.getAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    query(<span class="string">&#x27;img[lazyload]&#x27;</span>).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">      observer.observe(item);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">/* fallback */</span></span><br><span class="line">    query(<span class="string">&#x27;img[lazyload]&#x27;</span>).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">img</span>) </span>&#123;</span><br><span class="line">      img.src = img.getAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;).bind(<span class="built_in">window</span>)();</span><br></pre></td></tr></table></figure><h4 id="➣-使用-IntersectionObserver-API-懒加载其它资源">➣ 使用 IntersectionObserver API 懒加载其它资源</h4><p><code>IntersectionObserver API</code>由于性能更好已经在我的博客中作为一种主要的资源懒加载方式，我还使用它来优化博客评论组件 <a href="https://valine.js.org/">Valine</a> 的加载。一般评论组件都位于博客文章的最下方，因此刚载入文章页面时完全没有必要进行评论组件的资源加载，可以考虑使用 <code>IntersectionObserver</code> 监听评论组件是否进入视口，进入后再使用 <code>async</code> 异步脚本下载并回调执行评论系统初始化。</p><p>另一方面每篇文章底部的音乐播放器 <a href="https://aplayer.js.org/#/">Aplayer</a> 也使用了类似的加载策略，可以说优化效果屡试不爽！</p><h4 id="➣-使用-CDN-加载外部依赖脚本">➣ 使用 CDN 加载外部依赖脚本</h4><p>CDN 即内容分发网络。CDN 服务商将静态资源缓存到遍布全国的高性能加速节点上，当用户访问相应的业务资源时，CDN系统能够实时地根据网络流量和各节点的连接负载状况、到用户的距离和响应时间 等综合信息将用户的请求重新导向离用户最近的服务节点上，使内容能够传输的更快，更加稳定。可以提升首次请求的响应能力。</p><p>博客中一些公用外部库比如 <code>Bootstrap</code> 和 <code>jQuery</code> 都是使用的外部 CDN 资源地址，一方面可以减小当前主站的网页带宽消耗，另一方面 CDN 也能提供一些资源下载加速。</p><h4 id="➣-使用-Aplayer-替代-iframe-加载网易云音乐">➣ 使用 Aplayer 替代 iframe 加载网易云音乐</h4><p>博客之前的版本会在文章界面的底部嵌入一个网易云音乐自己的播放器，这个播放器其实是一个 iframe 像这样：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;0&quot;</span> <span class="attr">width</span>=<span class="string">330</span> <span class="attr">height</span>=<span class="string">86</span> <span class="attr">src</span>=<span class="string">&quot;//music.163.com/outchain/player?type=2&amp;id=781246&amp;auto=1&amp;height=66&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>iframe 加载的时候会加载一堆东西，虽然可以通过 <code>lazy</code> 属性来进行懒加载，不过iframe 也有很多缺点：</p><ul><li>iframe会阻塞主页面的onload事件</li><li>iframe和主页面共享HTTP连接池，而浏览器对相同域的连接有限制，所以会影响页面的并行加载</li><li>iframe不利于网页布局</li><li>iframe对移动端不友好</li><li>iframe的反复重新加载可能导致一些浏览器的内存泄露</li><li>iframe中的数据传输复杂</li><li>iframe不利于SEO</li></ul><p>新版本将 iframe 播放器换成了 <code>Aplayer</code> 并且把自己喜欢的一个歌曲列表上传到了另一个 gitee pages 仓库 进行静态托管，可以通过以下方式在博客底部加载一个自定义歌曲列表：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ap = <span class="keyword">new</span> APlayer(&#123;</span><br><span class="line">  <span class="attr">container</span>: <span class="built_in">document</span>.getElementById(<span class="string">&#x27;aplayer&#x27;</span>),</span><br><span class="line">  <span class="attr">theme</span>: <span class="string">&#x27;#e9e9e9&#x27;</span>,</span><br><span class="line">  <span class="attr">audio</span>: [&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;存在信号&#x27;</span>,</span><br><span class="line">    <span class="attr">artist</span>: <span class="string">&#x27;AcuticNotes&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://nojsja.gitee.io/static-resources/audio/life-signal.mp3&#x27;</span>,</span><br><span class="line">    <span class="attr">cover</span>: <span class="string">&#x27;https://nojsja.gitee.io/static-resources/audio/life-signal.jpg&#x27;</span></span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;遺サレタ場所／斜光&#x27;</span>,</span><br><span class="line">    <span class="attr">artist</span>: <span class="string">&#x27;岡部啓一&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.mp3&#x27;</span>,</span><br><span class="line">    <span class="attr">cover</span>: <span class="string">&#x27;https://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.jpg&#x27;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>预览图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/aplayer.png"  alt="aplayer"></p><h3 id="2-优化界面运行性能">2. 优化界面运行性能</h3><h4 id="➣-优化页面的回流和重绘情况">➣ 优化页面的回流和重绘情况</h4><p><strong>1）概念</strong></p><p>回流(重排，reflow)和重绘(repaint)是浏览器渲染网页必不可少的一个过程，回流主要HTML渲染过程中元素空间位置和大小改变引起的 DOM 树重新渲染，而重绘是由于节点的样式属性发生改变，并不会影响空间布局。从性能而言回流的性能消耗大，而且容易产生级联效应，即一个正常 DOM 树的流布局中，一个元素发生回流后，该元素位置之后的元素全部都会发生回流并重新渲染，重绘相对性能消耗更小。</p><p><strong>2）怎样有效判断界面的回流和重绘情况？</strong></p><p>其实一般基于 chromium 架构浏览器都附带一个网页开发工具 Devtools，但可以说绝大多数前端开发者都没有认真了解过这个工具的具体用途，只是把它用作简单的 log调试、网页请求追踪和样式调试这些基础功能。回流和重绘也是可以通过它来进行可视化度量的：F12打开 Devtools，找到右上角三个点的折叠按钮依次打开 -&gt; More Tools(更多工具) -&gt; Rendering (渲染) - 勾选前两项 <code>Paint Flashing</code> (高亮重绘区域) 和 <code>Layout Shift Regions</code> (高亮回流区域)，现在重新回到你打开的页面进行操作，操作过程中发生了回流的区域会变成蓝色，发生了重绘的区域会变成绿色，持续时间不长，注意观察。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/devtools-layout-paint.png"  alt="Devtools"></p><p>Repaint:</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/repaint.png"  alt="Repaint"></p><p>Reflow:</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/reflow.png"  alt="Reflow"></p><p>除了用于可视化界面回流/重绘的情况，Devtools 还有其他一些很实用的功能，比如：<code>Coverage Tools</code> 可以用于分析界面上引入的外部 <code>css/js</code> 脚本内容的使用覆盖率，就是说我们能通过这个工具衡量引入的外部文件的使用情况，使用频次较低的外部资源可以考虑内联或是直接手写实现，提升引入外部资源的<code>性价比</code>。</p><h4 id="➣-使用节流和去抖思想优化滚动事件监听">➣ 使用节流和去抖思想优化滚动事件监听</h4><p>在面对一些需要进行调用控制的函数高频触发场景时，可能有人会对何时使用节流何时使用去抖产生疑问。这里通过一个特性进行简单区分：如果你需要保留短时间内高频触发的最后一次结果时，那么使用去抖函数，如果你需要对函数的调用次数进行限制，以最佳的调用间隔时间保持函数的持续调用而不关心是否是最后一次调用结果时，请使用节流函数。</p><p>比如 echarts 图常常需要在窗口 resize 之后重新使用数据渲染，但是直接监听 resize 事件可能导致短时间内渲染函数被触发多次。我们可以使用函数去抖的思想，监听 resize 事件后在监听器函数里获取参数再使用参数调用事先初始化好了的 throttle 函数，保证 resize 过程结束后能触发一次实际的 echarts 重渲染即可。</p><p>这里给出节流函数和去抖函数的简单实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * fnDebounce [去抖函数]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>fn [需要被包裹的原始函数逻辑]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Numberl&#125;</span> </span>timeout [延迟时间]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;Function&#125;</span> </span>[高阶函数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">var</span> fnDebounce = <span class="function"><span class="keyword">function</span>(<span class="params">fn, timeout</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> time = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!time) <span class="keyword">return</span> time = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Date</span>.now() - time &gt;= timeout) &#123;</span><br><span class="line">      time = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> fn.apply(<span class="built_in">this</span>, [].slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      time = <span class="built_in">Date</span>.now();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * fnThrottle [节流函数]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>fn [需要被包裹的原始函数逻辑]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;Numberl&#125;</span> </span>timeout [延迟时间]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;Function&#125;</span> </span>[高阶函数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">var</span> fnThrottle = <span class="function"><span class="keyword">function</span>(<span class="params">fn, timeout</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> time = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!time) <span class="keyword">return</span> time = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">Date</span>.now() - time) &gt;= timeout) &#123;</span><br><span class="line">      time = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> fn.apply(<span class="built_in">this</span>, [].slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>博客中文章右侧的内容导航栏会根据滚动条位置自动切换 <code>fixed</code> 布局和一般流布局，这么做是为了让导航栏在阅读文章过程中也能正常呈现，不会被隐藏到顶部：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 限150ms才能触发一次滚动检测 */</span></span><br><span class="line">(<span class="built_in">window</span>).on(<span class="string">&#x27;scroll&#x27;</span>, fnThrottle(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> rectbase = $$tocBar.getBoundingClientRect();</span><br><span class="line">    <span class="keyword">if</span> (rectbase.top &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      $toc.css(<span class="string">&#x27;left&#x27;</span>, left);</span><br><span class="line">      (!$toc.hasClass(<span class="string">&#x27;toc-fixed&#x27;</span>)) &amp;&amp; $toc.addClass(<span class="string">&#x27;toc-fixed&#x27;</span>);</span><br><span class="line">      $toc.hasClass(<span class="string">&#x27;toc-normal&#x27;</span>) &amp;&amp; $toc.removeClass(<span class="string">&#x27;toc-normal&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $toc.css(<span class="string">&#x27;left&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      $toc.hasClass(<span class="string">&#x27;toc-fixed&#x27;</span>) &amp;&amp; $toc.removeClass(<span class="string">&#x27;toc-fixed&#x27;</span>);</span><br><span class="line">      (!$toc.hasClass(<span class="string">&#x27;toc-normal&#x27;</span>)) &amp;&amp; $toc.addClass(<span class="string">&#x27;toc-normal&#x27;</span>);</span><br><span class="line">      ($$toc.scrollTop &gt; <span class="number">0</span>) &amp;&amp; ($$toc.scrollTop = <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">150</span>));</span><br></pre></td></tr></table></figure><h4 id="➣-IntersectionObserver-API-的-polyfill-兼容策略">➣ IntersectionObserver API 的 polyfill 兼容策略</h4><p>文章中提到 <code>IntersectionObserver API</code> 已经用于博客中各个界面组件的懒加载功能，它的性能更好、功能也更加全面。但是网页开发中我们通常会考虑各个 API 的兼容性，这里可以通过 <a href="https://caniuse.com/?search=IntersectionObserver">Can I Use</a> 这个兼容性报告网站进行查看，从下图可知这个 API 的兼容情况还是可以的，桌面端很多较高版本浏览器均已支持：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/caniuse.png"  alt="caniuse"></p><p>因此为了解决个别低版本浏览器的兼容性问题，这里采用了一种比较极端的处理方式。常规情况下我们需要引入外部 <code>[xxx].polyfill.js</code> (xxx为相应的 API) 来为低版本浏览器添加相应功能，但是对于高版本浏览器自身已经支持了这个 API，却要重复下载 polyfill 库，造成网页请求数和带宽资源的浪费。因此我这里不采用这种方式，因为这个 API 大部分浏览器已经支持，我们默认不使用 <code>&lt;script&gt;</code> 标签引入 polyfill.js 而是通过脚本判断当前浏览器是否支持此 API，如果不支持的话再使用<code>同步XHR请求</code>远程 下载<a href="https://github.com/w3c/IntersectionObserver">polyfill</a> 文件，下载后使用 <code>eval(...)</code> 的方式执行整个脚本。使用同步方式会阻塞当前 js 执行线程，请谨慎使用，此处是为了保证 <code>IntersectionObserver</code> 以高优先级方式被注入到网页中，不然可能引发一些使用了此 API 脚本错误。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 此脚本被放置在靠近页面首部某个位置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">if</span> (<span class="string">&#x27;IntersectionObserver&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span> &amp;&amp;</span></span><br><span class="line"><span class="javascript">    <span class="string">&#x27;IntersectionObserverEntry&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span> &amp;&amp;</span></span><br><span class="line"><span class="javascript">    <span class="string">&#x27;intersectionRatio&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span>.IntersectionObserverEntry.prototype) &#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (!(<span class="string">&#x27;isIntersecting&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span>.IntersectionObserverEntry.prototype)) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">Object</span>.defineProperty(<span class="built_in">window</span>.IntersectionObserverEntry.prototype,</span></span><br><span class="line"><span class="javascript">        <span class="string">&#x27;isIntersecting&#x27;</span>, &#123;</span></span><br><span class="line"><span class="javascript">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> <span class="built_in">this</span>.intersectionRatio &gt; <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">      &#125;);</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">  &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="comment">/* load polyfill sync */</span></span></span><br><span class="line"><span class="javascript">    sendXMLHttpRequest(&#123;</span></span><br><span class="line"><span class="javascript">      <span class="attr">url</span>: <span class="string">&#x27;/blogs/js/intersection-observer.js&#x27;</span>,</span></span><br><span class="line"><span class="javascript">      <span class="attr">async</span>: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">      <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="javascript">      <span class="attr">callback</span>: <span class="function"><span class="keyword">function</span>(<span class="params">txt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">eval</span>(txt);</span></span><br><span class="line"><span class="javascript">      &#125;</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript">  &#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="➣-使用-IntersectionObserver-替代原生-onscroll-事件监听">➣ 使用 IntersectionObserver 替代原生 onscroll 事件监听</h4><p><code>IntersectionObserver</code> 通常用于界面中的一些相交检测场景：</p><ul><li>图片懒加载 – 当图片滚动到可见时才进行加载</li><li>内容无限滚动 – 用户滚动到接近滚动容器底部时直接加载更多数据，而无需用户操作翻页，给用户一种网页可以无限滚动的错觉</li><li>检测广告的曝光情况——为了计算广告收益，需要知道广告元素的曝光情况</li><li>在用户看见某个区域时执行任务、播放视频</li></ul><p>以内容无限滚动为例，古老的相交检测方案就是使用 scroll 事件监听滚动容器，在监听器函数中获取滚动元素的几何属性判断元素是否已经滚动到底部。我们知道scrollTop等属性的获取和设置都会导致页面回流，并且如果界面需要绑定多个监听函数到scroll事件进行类似操作的时候，页面性能会大打折扣：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 滚动监听 */</span></span><br><span class="line">onScroll = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; </span><br><span class="line">    scrollTop, scrollHeight, clientHeight</span><br><span class="line">  &#125; = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#target&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 已经滚动到底部 */</span></span><br><span class="line">  <span class="comment">// scrollTop(向上滚动的高度)；clientHeight(容器可视总高度)；scrollHeight(容器的总内容长度)</span></span><br><span class="line">  <span class="keyword">if</span> (scrollTop + clientHeight === scrollHeight) &#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里以一个简单实现的图片懒加载功能来介绍下它的使用方式，详细使用可以查看博客：<a href="https://nojsja.gitee.io/blogs/2021/02/07/9acea179.html/">《前端性能优化技巧详解(1)》</a>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">lazyload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> imagesToLoad = <span class="built_in">document</span>.querySelectorAll(<span class="string">&#x27;image[data-src]&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadImage</span>(<span class="params">image</span>) </span>&#123;</span><br><span class="line">    image.src = image.getAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">    image.addEventListener(<span class="string">&#x27;load&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      image.removeAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> intersectionObserver = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span>(<span class="params">items, observer</span>) </span>&#123;</span><br><span class="line">    items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">      <span class="comment">/* 所有属性：</span></span><br><span class="line"><span class="comment">        item.boundingClientRect - 目标元素的几何边界信息</span></span><br><span class="line"><span class="comment">        item.intersectionRatio - 相交比 intersectionRect/boundingClientRect</span></span><br><span class="line"><span class="comment">        item.intersectionRect -  描述根和目标元素的相交区域</span></span><br><span class="line"><span class="comment">        item.isIntersecting - true(相交开始)，false(相交结束)</span></span><br><span class="line"><span class="comment">        item.rootBounds - 描述根元素</span></span><br><span class="line"><span class="comment">        item.target - 目标元素</span></span><br><span class="line"><span class="comment">        item.time - 时间原点(网页在窗口加载完成时的时间点)到交叉被触发的时间的时间戳</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (item.isIntersecting) &#123;</span><br><span class="line">        loadImage(item.target);</span><br><span class="line">        observer.unobserve(item.target);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  imagesToLoad.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">image</span>) </span>&#123;</span><br><span class="line">    intersectionObserver.observe(image);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h3 id="3-网站最佳实践">3. 网站最佳实践</h3><h4 id="➣-使用-hexo-abbrlink-插件生成文章链接">➣ 使用 hexo-abbrlink 插件生成文章链接</h4><p>hexo 框架生成的博客地址默认是 <code>:year/:month/:day/:title</code> 这种格式的，也就是 <code>/年/月/日/标题</code>。当博客标题为中文时，生成的url链接中也出现中文，中文路径对于搜索引擎优化不友好。复制后的链接会被编码，非常不利于阅读，也不简洁。</p><p>使用 <a href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a> 可以解决这个问题，安装插件：<code>npm install hexo-abbrlink --save</code>，在 <code>_config.yml</code> 中添加配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:abbrlink.html/</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc32</span>  <span class="comment"># 算法：crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span>    <span class="comment"># 进制：dec(default) and hex</span></span><br></pre></td></tr></table></figure><p>之后生成的博客文章就会变成这种：<code>https://post.zz173.com/posts/8ddf18fb.html/</code>，即使更新了文章标题，文章的链接也不会改变。</p><h4 id="➣-使用-hexo-filter-nofollow-规避安全风险">➣ 使用 hexo-filter-nofollow 规避安全风险</h4><p><a href="https://github.com/hexojs/hexo-filter-nofollow">hexo-filter-nofollow</a> 插件会为所有 <code>&lt;a&gt;</code> 链接添加属性 <code>rel=&quot;noopener external nofollow noreferrer&quot;</code>。</p><p>网站内部有大量的外链会影响网站的权重,不利于SEO。</p><ul><li><code>nofollow</code>：是 Google、Yahoo 和微软公司前几年一起提出的一个属性，链接加上这个属性后就不会被计算权值。nofollow 告诉爬虫无需追踪目标页，为了对抗 blogspam(博客垃圾留言信息)，Google推荐使用nofollow，告诉搜索引擎爬虫无需抓取目标页，同时告诉搜索引擎无需将的当前页的Pagerank传递到目标页。但是如果你是通过 sitemap 直接提交该页面，爬虫还是会爬取，这里的nofollow只是当前页对目标页的一种态度，并不代表其他页对目标页的态度。</li><li><code>noreferrer</code> 和 <code>noopener</code>：当 <code>&lt;a&gt;</code> 标签使用 <code>target=&quot;_blank&quot;</code> 属性链接到另一个页面时，新页面将与您的页面在同一个进程上运行。如果新页面正在执行开销极大的 JavaScript，旧页面性能可能会受影响。并且新页面可以通过 <code>window.opener</code> 拿到旧页面窗口对象执行任意操作，具有极大的安全隐患。使用 <code>noopener</code> (兼容属性 <code>noreferrer</code>) 之后，新打开的页面就不能拿到旧页面窗口对象了。</li><li><code>external</code>：告诉搜素引擎，这是非本站的链接，这个作用相当于 <code>target=“_blank”</code>，减少外部链接的 SEO 权重影响。</li></ul><h4 id="➣-使用-hexo-deployer-git-和-github-workflow-进行自动化部署">➣ 使用 hexo-deployer-git 和 github workflow 进行自动化部署</h4><p>静态资源打包生成完成后，我需要将其提交到对应的 <code>github pages</code> 或 <code>gitee pages</code> 仓库中，当需要部署多个仓库时，手动操作效率非常低。因此这里采用 <code>hexo-deployer-git</code> 插件进行自动化部署，可以向下面一样声明需要部署的仓库信息，如果有多个仓库直接声明多个 <code>deploy</code> 字段即可：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">https://github.com/nojsja/blogs</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">ignore_hidden:</span></span><br><span class="line">    <span class="attr">public:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">update</span></span><br></pre></td></tr></table></figure><p>值得说明的是，非付费用户 <code>gitee pages</code> 仓库不支持提交后自动部署。因此我采用的方案是只声明一个 <code>deploy</code> 部署仓库指向 <code>github pages</code> 仓库，然后再通过 github 仓库自带的 <code>github workflow</code> 服务配合 <a href="https://github.com/yanglbme/gitee-pages-action">gitee-pages-action</a> 这个脚本实现的 gitee 自动部署。它的原理就是使用 github 自动化工作流将 github 仓库的代码同步到 gitee 仓库中去，然后通过读取我们配置的 gitee 账户信息自动执行登录 gitee 账户并调用网页的手动部署接口，实现整个自动化部署流程。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/github-workflow.png"  alt="github-workflow"></p><h3 id="4-网站SEO优化">4. 网站SEO优化</h3><h4 id="➣-使用-hexo-generator-sitemap-插件自动生成网站地图">➣ 使用 hexo-generator-sitemap 插件自动生成网站地图</h4><p>站点地图是什么：</p><ul><li>站点地图描述了一个网站的结构。它可以是一个任意形式的文档，用作网页设计的设计工具，也可以是列出网站中所有页面的一个网页，通常采用分级形式。这有助于访问者以及搜索引擎的机器人找到网站中的页面。</li><li>一些开发者认为网站索引是组织网页的一种更合适的方式，但是网站索引通常是A-Z索引，只提供访问特定内容的入口，而一个网站地图为整个站点提供了一般的自顶向下的视图。</li><li>网站地图让所有页面可被找到来增强搜索引擎优化的效果。</li></ul><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: npm install hexo-generator-sitemap --save</span><br></pre></td></tr></table></figure><p>配置文件<code>_config.yml</code>中添加相关字段：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sitemap</span></span><br><span class="line"><span class="attr">sitemap:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">sitemap.xml</span></span><br><span class="line"><span class="comment"># page url</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://nojsja.github.io/blogs</span> </span><br></pre></td></tr></table></figure><p>之后运行 <code>hexo generate</code> 之后就可以自动生成网站地图 <code>sitemap.xml</code> 了，接下来需要到 <code>Google Search Console</code> 记录自己的站点并提交相应的站点文件。</p><h4 id="➣-向-Google-Search-Console-提交个人网站地图">➣ 向 Google Search Console 提交个人网站地图</h4><ul><li>登录 <a href="https://search.google.com/search-console">Google Search Console</a></li><li>添加自己的网站信息<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/search-console.png"  alt="Search Console"></li><li>可以通过几种方法验证所有权<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/search-console2.png"  alt="Search Console"></li><li>提交插件生成的 <code>sitemap.xml</code><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/optimization/sitemap.png"  alt="sitemap.xml"></li></ul><p><code>Google Search Console</code> 还能看到自己网站的点击情况、关键词索引情况等，非常方便。</p><h2 id="参考">参考</h2><hr><ol><li><a href="https://juejin.cn/post/6844903561927589895#heading-29">Lighthouse与Google的移动端最佳实践</a></li><li><a href="https://web.dev/">Google web.dev</a></li></ol><h2 id="结语">结语</h2><hr><p>学习前端性能优化的方方面面，一方面是对我们核心基础知识的考察，另一方面也能为我们遇到的一些实际问题提供处理思路，是每个前端人进阶的的必经之路。</p><p>以上就是本篇文章的所有内容，后续有需要还会继续更新…</p>]]></content>
      
      
      <categories>
          
          <category> Performance </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> performance </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021金三银四前端面试笔记</title>
      <link href="/blogs/2021/04/24/4f89505c.html/"/>
      <url>/blogs/2021/04/24/4f89505c.html/</url>
      
        <content type="html"><![CDATA[<h3 id="Contents">Contents</h3><hr><blockquote><p>部分内容从网络和官网收集</p></blockquote><ul><li><a href="#contents">### Contents</a></li><li><a href="#%E9%9D%A2%E8%AF%95%E9%98%B6%E6%AE%B5%E5%88%86%E6%9E%90">### 面试阶段分析</a></li><li><a href="#%E4%B8%AA%E4%BA%BA%E4%BB%8B%E7%BB%8D">### 个人介绍</a><ul><li><a href="#%E2%9E%A3-%E9%87%8D%E7%82%B9">➣ 重点</a></li><li><a href="#%E2%9E%A3-%E6%8F%8F%E8%BF%B0%E5%9C%A8%E4%B8%8A%E4%B8%80%E5%AE%B6%E5%85%AC%E5%8F%B8%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%BB%8F%E5%8E%86">➣ 描述在上一家公司的工作经历</a></li><li><a href="#%E2%9E%A3-%E8%8C%83%E4%BE%8B">➣ 范例</a></li><li><a href="#%E2%9E%A3-%E9%A1%B9%E7%9B%AE%E7%BB%8F%E5%8E%86%E4%BB%8B%E7%BB%8D">➣ 项目经历介绍</a></li></ul></li><li><a href="#i-%E8%A6%81%E7%82%B9htmlcss">### I. 要点：HTML/CSS</a><ul><li><a href="#%E2%9E%A3-position%E5%90%84%E4%B8%AA%E5%B1%9E%E6%80%A7%E7%9A%84%E4%BD%9C%E7%94%A8">➣ position各个属性的作用</a></li><li><a href="#%E2%9E%A3-display%E5%90%84%E4%B8%AA%E5%B1%9E%E6%80%A7%E4%BD%9C%E7%94%A8">➣ display各个属性作用</a><ul><li><a href="#1-%E5%A4%96%E9%83%A8%E6%98%BE%E7%A4%BA">1. 外部显示</a></li><li><a href="#2-%E5%86%85%E9%83%A8%E6%98%BE%E7%A4%BA">2. 内部显示</a></li><li><a href="#3-%E5%86%85%E9%83%A8%E8%A1%A8%E7%8E%B0">3. 内部表现</a></li></ul></li><li><a href="#%E2%9E%A3-bfc%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8">➣ BFC及其应用</a></li><li><a href="#%E2%9E%A3-%E6%80%8E%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%AE%9A%E5%AE%BD%E9%AB%98%E7%9A%84div%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD">➣ 怎样实现一个不定宽高的div水平垂直居中</a></li><li><a href="#%E2%9E%A3-box-sizing%E6%98%AF%E4%BB%80%E4%B9%88">➣ box-sizing是什么</a></li><li><a href="#%E2%9E%A3-grid%E5%B8%83%E5%B1%80">➣ grid布局</a><ul><li><a href="#1-%E5%AE%B9%E5%99%A8%E5%85%83%E7%B4%A0">1. 容器元素</a></li><li><a href="#2-%E5%AD%90%E5%85%83%E7%B4%A0">2. 子元素</a></li></ul></li><li><a href="#%E2%9E%A3-flex%E5%B8%83%E5%B1%80">➣ flex布局</a><ul><li><a href="#1-%E5%AE%B9%E5%99%A8%E5%85%83%E7%B4%A0-1">1. 容器元素</a></li><li><a href="#2-%E5%AD%90%E5%85%83%E7%B4%A0-1">2. 子元素</a></li></ul></li><li><a href="#%E2%9E%A3-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9B%9E%E6%B5%81%E5%92%8C%E9%87%8D%E7%BB%98">➣ 浏览器回流和重绘</a></li><li><a href="#%E2%9E%A3-%E4%B8%A4%E5%88%97%E5%B8%83%E5%B1%80%E5%AE%9E%E7%8E%B0">➣ 两列布局实现</a></li><li><a href="#%E2%9E%A3-1px%E9%97%AE%E9%A2%98">➣ 1px问题</a></li><li><a href="#%E2%9E%A3-%E6%B5%AE%E5%8A%A8%E5%B8%83%E5%B1%80%E7%9B%B8%E5%85%B3">➣ 浮动布局相关</a></li><li><a href="#%E2%9E%A3-%E4%BD%8D%E5%9B%BE%E5%92%8C%E7%9F%A2%E9%87%8F%E5%9B%BE%E7%9A%84%E5%8C%BA%E5%88%AB">➣ 位图和矢量图的区别</a></li><li><a href="#%E2%9E%A3-opacity-0visibility-hiddendisplay-none-%E7%9A%84%E5%BC%82%E5%90%8C">➣ opacity: 0、visibility: hidden、display: none 的异同</a></li><li><a href="#%E2%9E%A3-%E5%A4%9A%E7%AB%AF%E9%80%82%E9%85%8D">➣ 多端适配</a><ul><li><a href="#1-%E5%85%B3%E4%BA%8E%E8%A7%86%E5%8F%A3">1. 关于视口</a></li><li><a href="#2-%E5%85%B3%E4%BA%8E%E5%A4%9A%E5%80%8D%E5%9B%BE">2. 关于多倍图</a></li></ul></li></ul></li><li><a href="#ii-%E8%A6%81%E7%82%B9javascript">### II. 要点：Javascript</a><ul><li><a href="#%E2%9E%A3-mapweakmapsetweakset%E5%8C%BA%E5%88%AB">➣ Map/WeakMap/Set/WeakSet区别</a><ul><li><a href="#1-set">1. Set</a></li><li><a href="#2-weakset">2. WeakSet</a></li><li><a href="#3-map">3. Map</a></li><li><a href="#4-weakmap">4. WeakMap</a></li></ul></li><li><a href="#%E2%9E%A3-js%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%88%A4%E6%96%AD">➣ js类型的判断</a></li><li><a href="#%E2%9E%A3-%E5%AE%9E%E7%8E%B0call%E5%92%8Capply">➣ 实现Call和Apply</a></li><li><a href="#%E2%9E%A3-%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1new%E6%93%8D%E4%BD%9C">➣ 实现对象new操作</a></li><li><a href="#js%E5%AE%9E%E7%8E%B0bind%E5%87%BD%E6%95%B0">Js实现bind函数</a></li><li><a href="#%E2%9E%A3-%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E6%89%81%E5%B9%B3%E5%8C%96">➣ 二维数组扁平化</a></li><li><a href="#%E2%9E%A3-js%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E6%95%B0%E6%98%AF%E4%B8%8D%E6%98%AF2%E7%9A%84n%E6%AC%A1%E5%B9%82">➣ Js如何判断一个数是不是2的N次幂</a></li><li><a href="#%E2%9E%A3-js%E5%AE%9E%E7%8E%B0%E7%BB%A7%E6%89%BF">➣ Js实现继承</a></li><li><a href="#%E2%9E%A3-%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D">➣ 手写深拷贝和浅拷贝</a></li><li><a href="#%E2%9E%A3-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">➣ 基本数据类型和引用数据类型</a></li><li><a href="#%E2%9E%A3-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E4%B8%8A%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%8E%9F%E5%9E%8B%E5%B1%9E%E6%80%A7%E8%BF%98%E6%98%AF%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7%E5%91%A2">➣ 如何判断对象上的属性是原型属性还是实例属性呢？</a></li><li><a href="#%E2%9E%A3-es6%E6%96%B0%E5%A2%9E%E7%89%B9%E6%80%A7">➣ ES6新增特性</a></li><li><a href="#%E2%9E%A3-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%82%B9%E5%87%BB%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98">➣ 移动端点击穿透问题</a></li><li><a href="#%E2%9E%A3-%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E5%92%8C%E6%80%9D%E8%B7%AF">➣ 图片懒加载具体实现方案和思路</a></li><li><a href="#%E2%9E%A3-%E5%87%BD%E6%95%B0%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81%E5%AE%9E%E7%8E%B0">➣ 函数防抖和节流实现</a></li><li><a href="#%E2%9E%A3-%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8A%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%BF%9B%E7%A8%8B">➣ 浏览器上的线程和进程</a><ul><li><a href="#1-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8C%85%E5%90%AB%E4%B8%8B%E9%9D%A2%E5%87%A0%E7%A7%8D%E8%BF%9B%E7%A8%8B">1. 浏览器包含下面几种进程：</a></li><li><a href="#2-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E8%BF%9B%E7%A8%8B%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%85%E6%8B%AC%E4%BB%A5%E4%B8%8B%E7%BA%BF%E7%A8%8B">2. 浏览器渲染进程是多线程的，包括以下线程：</a></li></ul></li><li><a href="#%E2%9E%A3-js%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%AE%8F%E4%BB%BB%E5%8A%A1%E5%BE%AE%E4%BB%BB%E5%8A%A1">➣ Js事件循环(宏任务、微任务)</a></li><li><a href="#%E2%9E%A3-%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0-settimeout">➣ 模拟实现 setTimeout</a></li><li><a href="#%E2%9E%A3-%E4%BB%8E%E8%BE%93%E5%85%A5url%E5%88%B0%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88">➣ 从输入URL到页面渲染完成发生了什么</a></li><li><a href="#%E2%9E%A3-tcp%E5%8D%8F%E8%AE%AE%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">➣ tcp协议三次握手和四次挥手</a><ul><li><a href="#1-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%AE%B2%E8%A7%A3">1. 三次握手讲解</a></li></ul></li><li><a href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88http%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8D%E6%98%AF%E4%B8%A4%E6%AC%A1%E6%88%96%E5%9B%9B%E6%AC%A1">2. 为什么http建立连接需要三次握手，不是两次或四次?</a></li><li><a href="#3-tcp%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B">3. TCP关闭连接过程</a></li><li><a href="#4-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">4. 为什么要四次挥手？</a></li><li><a href="#%E2%9E%A3-%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%93%AA%E4%BA%9B%E4%BA%8B%E4%BB%B6">➣ 页面加载会触发哪些事件</a></li><li><a href="#%E2%9E%A3-documentready%E5%92%8Cwindowonload%E7%9A%84%E5%8C%BA%E5%88%AB">➣ document.ready和window.onload的区别</a></li><li><a href="#%E2%9E%A3-%E9%97%AD%E5%8C%85closure">➣ 闭包Closure</a></li><li><a href="#%E2%9E%A3-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%9A%84%E4%BD%93%E7%8E%B0">➣ 函数式编程思想的体现</a></li><li><a href="#%E2%9E%A3-%E5%87%BD%E6%95%B0%E6%9F%AF%E9%87%8C%E5%8C%96add123--6">➣ 函数柯里化：add(1)(2)(3) == 6</a></li><li><a href="#%E2%9E%A3-%E5%87%BD%E6%95%B0%E6%9F%AF%E9%87%8C%E5%8C%962curry%E5%87%BD%E6%95%B0">➣ 函数柯里化2：curry函数</a></li><li><a href="#%E2%9E%A3-vue%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">➣ vue双向绑定实现原理</a></li><li><a href="#%E2%9E%A3-vue20%E4%B8%8Evue30%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9Aproxy%E5%AE%9E%E7%8E%B0">➣ Vue2.0与Vue3.0双向绑定，proxy实现</a></li><li><a href="#%E2%9E%A3-%E5%89%8D%E7%AB%AF%E9%94%99%E8%AF%AF%E7%9B%91%E6%8E%A7%E6%96%B9%E6%B3%95">➣ 前端错误监控方法</a></li><li><a href="#%E2%9E%A3-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F%E5%92%8C%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E5%8C%BA%E5%88%AB">➣ 发布订阅模式和观察者模式区别</a></li><li><a href="#%E2%9E%A3-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAeventemitter%E7%B1%BB%E6%94%AF%E6%8C%81%E4%BA%8B%E4%BB%B6%E7%9A%84onoffemitoncesetmaxlisteners">➣ 实现一个EventEmitter类，支持事件的on,off,emit,once,setMaxListeners。</a></li><li><a href="#%E2%9E%A3-%E5%AE%9E%E7%8E%B0ajax%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%E6%8E%A7%E5%88%B6">➣ 实现ajax并发请求控制</a></li><li><a href="#%E2%9E%A3-%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F">➣ 如何自己实现一个单点登录系统</a></li><li><a href="#%E2%9E%A3-%E4%BD%BF%E7%94%A8es5%E5%AE%9E%E7%8E%B0promise">➣ 使用ES5实现Promise</a></li></ul></li><li><a href="#iii-%E8%A6%81%E7%82%B9react">### III. 要点：React</a><ul><li><a href="#%E2%9E%A3-react-%E4%B8%AD-setstate-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E6%98%AF%E5%BC%82%E6%AD%A5%E7%9A%84">➣ React 中 setState 什么时候是同步的，什么时候是异步的？</a></li><li><a href="#%E2%9E%A3-react%E4%B8%AD%E7%88%B6%E7%BB%84%E4%BB%B6%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%E5%AD%90%E7%BB%84%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95">➣ React中父组件如何调用子组件的方法？</a></li><li><a href="#%E2%9E%A3-%E4%B8%BA%E4%BB%80%E4%B9%88-react-%E5%85%83%E7%B4%A0%E6%9C%89%E4%B8%80%E4%B8%AA-typeof-%E5%B1%9E%E6%80%A7">➣ 为什么 React 元素有一个 $$typeof 属性？</a></li><li><a href="#%E2%9E%A3-hooks-%E4%BC%98%E7%BC%BA%E7%82%B9">➣ hooks 优缺点？</a></li><li><a href="#%E2%9E%A3-hooks-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E6%94%BE%E5%9C%A8%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E9%87%8C">➣ hooks 为什么不能放在条件判断里？</a></li><li><a href="#%E2%9E%A3-react-fiber%E5%8E%9F%E7%90%86%E5%92%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3">➣ React-Fiber原理和生命周期使用详解</a></li><li><a href="#%E2%9E%A3-react%E8%99%9A%E6%8B%9Fdom%E4%BB%A5%E5%8F%8Adiff%E7%AE%97%E6%B3%95">➣ React虚拟dom以及diff算法</a></li><li><a href="#%E2%9E%A3-babel%E5%8E%9F%E7%90%86">➣ Babel原理</a></li><li><a href="#%E2%9E%A3-react-setstate%E5%8E%9F%E7%90%86">➣ React SetState原理</a></li><li><a href="#%E2%9E%A3-react-router%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">➣ React Router实现原理</a></li></ul></li><li><a href="#iv-%E8%A6%81%E7%82%B9nodejs">### IV. 要点：Node.js</a><ul><li><a href="#%E2%9E%A3-nodejs%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">➣ Node.js的模块加载机制</a></li><li><a href="#%E2%9E%A3-nodejs%E7%9A%84%E4%BC%98%E5%8A%BF%E5%92%8C%E5%8A%A3%E5%8A%BF">➣ Node.js的优势和劣势</a></li><li><a href="#%E2%9E%A3-nodejs%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%96%B9%E6%B3%95%E5%BC%82%E5%90%8C">➣ Node.js创建子进程方法异同</a></li><li><a href="#%E2%9E%A3-nodejs%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%8F%82%E6%95%B0stdio%E7%9A%84%E7%90%86%E8%A7%A3">➣ Node.js创建子进程参数<code>stdio</code>的理解</a></li><li><a href="#%E2%9E%A3-nodejs%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">➣ Nodejs使用场景</a></li><li><a href="#%E2%9E%A3-nodejs-%E4%B8%AD%E7%9A%84-stream-%E5%92%8C-buffer-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">➣ Nodejs 中的 Stream 和 Buffer 有什么区别?</a></li><li><a href="#%E2%9E%A3-nodejs%E6%B5%81%E7%9A%84%E6%A6%82%E5%BF%B5">➣ Node.js流的概念</a><ul><li><a href="#%E6%B5%81%E7%9A%84%E7%B1%BB%E5%9E%8B">流的类型</a></li><li><a href="#%E6%B5%81%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA">流的缓冲区</a></li><li><a href="#%E5%8F%AF%E5%86%99%E6%B5%81">可写流</a></li><li><a href="#%E5%8F%AF%E8%AF%BB%E6%B5%81">可读流</a></li><li><a href="#%E5%8F%AF%E8%AF%BB%E5%8F%AF%E5%86%99%E5%8F%8C%E5%90%91%E6%B5%81">可读可写双向流</a></li><li><a href="#%E8%BD%AC%E6%8D%A2%E6%B5%81">转换流</a></li></ul></li><li><a href="#%E2%9E%A3-nodejs%E5%92%8Cwebpack%E5%AF%B9%E6%A8%A1%E5%9D%97%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E5%A4%84%E7%90%86">➣ Node.js和Webpack对模块循环依赖的处理</a><ul><li><a href="#nodejs%E7%9A%84%E5%A4%84%E7%90%86">Node.js的处理</a></li><li><a href="#webpack%E7%9A%84%E5%A4%84%E7%90%86">Webpack的处理</a></li></ul></li><li><a href="#%E2%9E%A3-webpack%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86require%E5%92%8Cimport%E8%AF%AD%E6%B3%95%E6%B7%B7%E7%94%A8%E7%9A%84">➣ Webpack怎么处理require和import语法混用的</a></li><li><a href="#%E2%9E%A3-%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97%E5%8C%96%E5%8E%86%E7%A8%8B">➣ 前端模块化历程</a><ul><li><a href="#1-iife---%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0">1. IIFE - 立即执行函数</a></li><li><a href="#2-amd---requirejs">2. AMD - requireJs</a></li><li><a href="#3-cmd---seajs">3. CMD - seaJs</a></li><li><a href="#4-commonjs---nodejs%E6%A8%A1%E5%9D%97%E8%A7%84%E8%8C%83">4. commonJs - Node.js模块规范</a></li><li><a href="#5-es-module---%E6%B5%8F%E8%A7%88%E5%99%A8%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F">5. ES Module - 浏览器模块系统</a></li></ul></li><li><a href="#%E2%9E%A3-%E8%B0%88%E8%B0%88node%E5%AD%90%E8%BF%9B%E7%A8%8Bchildprocess%E5%92%8C%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">➣ 谈谈node子进程child_process和实际使用场景</a></li><li><a href="#%E2%9E%A3-node%E6%98%AFio%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BD%93%E7%8E%B0%E5%9C%A8%E5%93%AA%E9%87%8C">➣ node是IO密集型体现在哪里</a></li></ul></li><li><a href="#v-%E8%A6%81%E7%82%B9%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">### V. 要点：设计模式</a></li><li><a href="#vi-%E8%A6%81%E7%82%B9%E5%89%8D%E7%AB%AF%E5%B7%A5%E5%85%B7">### VI. 要点：前端工具</a><ul><li><a href="#%E2%9E%A3-webpackrollup%E4%B8%80%E4%BA%9B%E5%8C%BA%E5%88%AB">➣ webpack/rollup一些区别</a></li><li><a href="#%E2%9E%A3-ts%E8%87%AA%E5%B7%B1%E7%9A%84%E7%9C%8B%E6%B3%95%E5%92%8C%E5%BA%94%E7%94%A8">➣ ts自己的看法，和应用</a></li><li><a href="#%E2%9E%A3-webpack-loader%E5%92%8Cplugin%E5%8C%BA%E5%88%AB">➣ webpack loader和plugin区别</a></li><li><a href="#vii-%E8%A6%81%E7%82%B9%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96%E6%96%B9%E9%9D%A2">VII. 要点：前端工程化方面</a><ul><li><a href="#%E2%9E%A3-%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99">➣ 前端组件设计原则</a></li><li><a href="#%E2%9E%A3-%E5%89%8D%E7%AB%AF%E5%85%BC%E5%AE%B9">➣ 前端兼容</a><ul><li><a href="#1-%E5%A4%9A%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">1. 多屏幕自适应</a></li><li><a href="#2-%E5%85%BC%E5%AE%B9%E7%AD%96%E7%95%A5">2. 兼容策略</a></li><li><a href="#3-%E5%B8%B8%E8%A7%81%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95">3. 常见浏览器兼容处理方法</a></li><li><a href="#3-%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%85%BC%E5%AE%B9%E6%96%B9%E6%B3%95babel">3. 工程化兼容方法：babel</a></li><li><a href="#4-%E5%B7%A5%E5%85%B7%E5%85%BC%E5%AE%B9%E6%96%B9%E6%B3%95css%E5%89%8D%E7%BC%80">4. 工具兼容方法：css前缀</a></li></ul></li></ul></li></ul></li><li><a href="#viii-%E8%A6%81%E7%82%B9%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">### VIII. 要点：前端性能优化</a><ul><li><a href="#%E2%9E%A3-%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E5%A4%A7%E9%87%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%92%8C%E6%B8%B2%E6%9F%93">➣ 前端如何优化大量数据的加载和渲染</a></li><li><a href="#%E2%9E%A3-webpack%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E9%9D%A2">➣ webpack性能优化方面</a></li><li><a href="#%E2%9E%A3-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E9%9D%A2">➣ 服务器性能优化方面</a></li><li><a href="#%E2%9E%A3-%E5%BC%B1%E7%BD%91%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%A1%B5%E9%9D%A2%E9%A6%96%E5%B1%8F%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%8A%A0%E8%BD%BD">➣ 弱网环境下页面首屏如何快速加载</a></li></ul></li><li><a href="#ix-%E8%A6%81%E7%82%B9%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%92%8C%E7%BD%91%E7%BB%9C">### IX. 要点：操作系统和网络</a><ul><li><a href="#%E2%9E%A3-%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BD%91%E9%A1%B5%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%A6%82%E4%BD%95%E9%98%B2%E8%8C%83">➣ 常见的网页攻击方式，如何防范</a><ul><li><a href="#1-xss%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBcross-site-scripting">1. XSS：跨站脚本攻击(Cross-site scripting)</a></li><li><a href="#2-xsrf%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0cross-site-request-forgery">2. XSRF：跨站请求伪造(Cross-site request forgery)</a></li></ul></li><li><a href="#%E2%9E%A3-%E8%B7%A8%E5%9F%9F%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8">➣ 跨域的基本概念和解决方法，在项目中的实际应用</a></li><li><a href="#%E2%9E%A3-%E5%BC%BA%E7%BC%93%E5%AD%98%E5%92%8C%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98%E7%BC%93%E5%AD%98%E7%9A%84%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E7%94%A8%E5%9C%A8%E9%A1%B5%E9%9D%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8A">➣ 强缓存和协商缓存，缓存的应用，如何用在页面性能优化上</a></li><li><a href="#%E7%88%AC%E8%99%AB%E6%96%B9%E9%9D%A2%E9%97%AE%E9%A2%98%E5%8F%8D%E7%88%AC%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%92%88%E5%AF%B9%E5%8F%8D%E7%88%AC%E7%9A%84%E5%AE%9E%E7%8E%B0ip%E4%BB%A3%E7%90%86%E7%AD%89">爬虫方面问题，反爬如何实现，针对反爬的实现(IP代理等）</a></li><li><a href="#%E2%9E%A3-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E5%8C%BA%E5%88%AB">➣ 进程和线程区别</a></li><li><a href="#%E2%9E%A3-cpu%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95">➣ cpu调度算法</a></li><li><a href="#%E2%9E%A3-2%E5%8F%B0%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%BA%95%E5%B1%82%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1-socket-io%E9%80%9A%E4%BF%A1%E5%AE%9E%E7%8E%B0">➣ 2台计算机底层之间如何通信 socket IO通信实现</a></li><li><a href="#%E2%9E%A3-cookie%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AD%97%E6%AE%B5">➣ cookie中常见的字段</a></li><li><a href="#%E2%9E%A3-%E8%B7%A8%E5%9F%9F%E5%92%8C%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5">➣ 跨域和同源策略</a></li><li><a href="#%E2%9E%A3-http%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E7%9A%84%E5%93%8D%E5%BA%94%E5%A4%B4%E5%92%8C%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%9C%89%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8">➣ http中一些常见的响应头和请求头，有什么应用</a></li><li><a href="#%E2%9E%A3-%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%E5%92%8C%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%E5%8C%BA%E5%88%AB">➣ 简单请求和非简单请求区别</a></li><li><a href="#%E2%9E%A3-http20-http30%E4%BD%9C%E4%BA%86%E5%93%AA%E4%BA%9B%E4%BC%98%E5%8C%96">➣ http2.0 http3.0作了哪些优化</a></li><li><a href="#%E2%9E%A3-https%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B">➣ https建立连接过程</a></li><li><a href="#%E2%9E%A3-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%B8%ADhttp%E5%9C%B0%E5%9D%80%E5%9C%A87%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%B8%AD%E5%A6%82%E4%BD%95%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%90%91%E4%B8%8B%E8%A7%A3%E6%9E%90%E4%BB%8E%E5%BA%94%E7%94%A8%E5%B1%82%E5%88%B0%E6%9C%80%E5%BA%95%E5%B1%82%E7%9A%84%E7%89%A9%E7%90%86%E5%B1%82%E6%AF%8F%E4%B8%80%E5%B1%82%E5%A4%84%E7%90%86%E7%9A%84%E4%BA%8B%E6%83%85">➣ 计算机网络中，http地址，在7层协议中，如何一步步向下解析，从应用层到最底层的物理层，每一层处理的事情</a></li></ul></li><li><a href="#%EF%BD%98-%E4%BA%A7%E5%93%81%E9%A1%B9%E7%9B%AE%E5%92%8C%E5%B7%A5%E7%A8%8B%E5%8C%96">### Ｘ. 产品、项目和工程化</a><ul><li><a href="#%E2%9E%A3-%E9%A1%B9%E7%9B%AE%E6%80%8E%E4%B9%88%E5%A4%8D%E7%9B%98">➣ 项目怎么复盘？</a></li></ul></li><li><a href="#xi-%E8%A6%81%E7%82%B9leetcode%E7%AE%97%E6%B3%95%E5%88%B7%E9%A2%98">### XI. 要点：Leetcode算法刷题</a><ul><li><a href="#%E2%9E%A3-%E8%80%83%E5%AF%9F%E9%87%8D%E7%82%B9">➣ 考察重点</a></li><li><a href="#%E2%9E%A3-%E6%8E%A8%E8%8D%90%E4%BD%9C%E8%80%85%E5%92%8C%E8%B5%84%E6%BA%90">➣ 推荐作者和资源</a></li></ul></li></ul><h3 id="面试阶段分析">面试阶段分析</h3><hr><ol><li>一面主要是针对基础知识，面试官会根据你的简历对各个知识点进行考察，需要有扎实的基础，提升对基础知识的熟悉度。</li><li>二面面试官会考察你知识掌握的深入程度，会根据你的个人项目，深挖其中的技术点。比如如果项目中用了React的话可能问你React diff算法、React性能优化等等，所以需要对个人项目所涉及到的技术点有深入研究和理解。</li><li>三面四面也会根据你的项目对你提问，需要熟知自己项目的闪光点以及一些尚待优化之处。除此之外面试官可能会出一些实际生产环境下的场景题，考察你的思维逻辑、技术积累和应变能力。</li></ol><h3 id="个人介绍">个人介绍</h3><hr><h4 id="➣-重点">➣ 重点</h4><ol><li>我最突出的技能是什么<br>例如：Js的多维运用</li><li>我在哪方面的知识掌握是最全面的<br>例如：前端工程化</li><li>我性格上最大的优势是什么<br>例如：对技术的热情和对问题孜孜不倦的深挖实践</li><li>我最擅长的事情是什么<br>例如：擅长从工作中分析总结，制定对某类问题的解决方法，编写效率工具</li><li>我有哪些成就和贡献<br>…</li></ol><h4 id="➣-描述在上一家公司的工作经历">➣ 描述在上一家公司的工作经历</h4><p>     在前一个公司，我们使用React/Mobx/Node.js/Electron等技术，我主要负责一个存储集群产品的前端开发迭代、中间层维护和通用打包脚本编写这些。也曾担任过一个SMB客户端产品主要开发工作，负责项目搭建、架构优化以及多文件分片上传模块编写。</p><h4 id="➣-范例">➣ 范例</h4><p>     面试官，你好，我叫xx，毕业于xx大学xx专业，三年工作经验。在前一个公司主要负责一个存储集群产品的前端开发、中间层维护和通用打包脚本编写这些，也担任过一个SMB客户端产品主要开发工作，负责项目搭建、架构优化以及多文件分片上传模块编写。<br>自己比较擅长从日常工作中分析总结，制定对某类问题的解决方法，编写效率工具。<br>在技术方面比较熟悉React/Node开发，对前端客户端技术Electron也有涉猎，平时会更新技术博客和Github。</p><h4 id="➣-项目经历介绍">➣ 项目经历介绍</h4><ol><li><p>公司项目(列举重点)</p><ul><li>超融合项目的共同构建 - nodejs中间层搭建、项目初始化流程的界面实现、新老界面通信工具编写：之前的老项目使用 php/jquery 技术栈，因为老项目和重构项目需要一起对外出货，所以我们团队考虑将老项目页面和基于react技术的重构项目页面使用iframe组合起来，老项目内嵌在iframe内，并且通过设置cookie 的作用域为根层级实现登录信息cookie共享。即使共享了cookie，新老界面也需要一定的通信机制进行状态同步和通知接口调用等等，我们使用了iframe的<code>postMessage</code>API进行通信，我着手编写了这个通信工具，在老界面监听window的<code>message</code>事件，并判断其是否来自加载当前iframe页面的父页面，如果是的话就提取出其携带的数据data和操作action执行一些操作，比如：设置当前界面的cookie信息、请求父页面切换路由、请求父页面登出、请求父页面发送通知等等。</li><li>前端迭代子项目 - 对象存储AWS服务管理：主要功能是基于Ceph的S3对象存储服务的用户管理、桶管理、桶详情设置等。我主要负责前期预研、原生S3接口的请求发送工具编写、对象存储桶管理和桶设置编写等。其中node中间层的接口请求工具需要使用用户的ak/sk信息进行URL签名，进行前台和后端json/xml数据的相互转换以及请求返回错误处理和请求头hash字段自动添加等。界面方面除了桶管理部分的桶创建、列举功能，还参与了桶详情中桶的配额、权限、生命周期、写保护等功能的编写。</li><li>前端迭代子项目 - 对象存储数据湖：集成之前对象存储服务的部分桶功能，能够列举所有监听的桶，桶详情新增了为桶设置元数据模板数据树功能，同时后端接入了ES数据库进行单个集群内已经监听的桶内的的对象数据进行条件搜索，数据搜索详情界面同时也能打开单个数据对象进行预览、下载、权限设置、模板元数据设置、标签设置等等。</li><li>Electron客户端项目 - 集群SMB共享客户端：SMB服务是集群提供的一个文件共享服务，客户端主要功能是添加多个远端集群节点、用户能够登录某个集群、列举集群的所有共享文件夹并查看每一级的文件和目录、能够设置文件和目录等的访问权限、删除文件、上传多个文件和文件夹到某一层级的目录、上传任务列表的显示等等。我主要负责Electron项目的搭建和架构设计、打包流程实现和优化、多文件上传任务管理模块的整体实现、登录流程的实现以及其它模块的Electron代码编写等。</li><li>前端项目的RPM打包：我们所有的代码不需要线上部署，运行在本地集群内，前后端所有模块最终都会被打包成多个RPM包，并集成为一个Linux ISO镜像，服务器集群运行CentOS操作系统，安装好这个ISO镜像后基础环境就搭建好了。我负责的打包流程可以描述为：先将前端项目使用webpack打包成静态文件后将其上传到gitlab仓库，然后登录Linux虚拟机进入打包脚本目录运行一个一键打包命令比如：<code>bash dbuilder-v3 --webpath /root/github/dview --version 1.0.1 --release 1002 --target arm64 --alias feature01</code>即可进行打包。一键打包脚本由我编写，主要负责git仓库的拉取更新、将所需的中间层代码和前端dist静态文件复制到特定的打包目录、使用脚本传入的参数对rpm包<code>spec</code>打包配置文件进行动态配置、显示打包流程信息、以及将最后打包好的rpm文件放入一个特殊的目录等等，运行命令后所有操作按序自动完成。</li></ul></li><li><p>个人项目(列举亮点项目)</p><ul><li><a href="https://github.com/nojsja/electronux">electronux</a> 一个基于Electron客户端技术，使用React、Node、Mobx、Shell脚本等技术开发的Linux电脑管家，可以实现Ubuntu系统下一些自用软件的一键安装和卸载、开机自启应用定制、垃圾清理、系统信息查看等功能。这Electron技术的早期实践项目，亮点是Node.js执行Shell外部脚本和调用子进程运行操作系统命令的实践，实现了根据Node.js子进程中命令执行情况来为用户自动输入密码的功能，原理是监听子进程输出流的错误信息，当错误信息中包含某个自定义的特殊字符串时，说明当前执行的命令正在请求用户输入密码，我们将内存中存入的密码信息以输入流的形式写入子进程即可触发子进程中命令的密码自动填充。</li><li><a href="https://github.com/nojsja/electron-re">electron-re</a> 一个用于Electron项目中的多进程创建、管理和监控的工具，已经发布到NPM仓库。Electron中通常不能把过度占用CPU的代码放入主进程，因此<code>electron-re</code>实现了一个不显示界面的Service进程类用于创建一个或多个Service实例从而将占用CPU的代码放入其中，并且<code>electron-re</code>提供了一个公用工具<code>MessageChannel</code>用于子进程、主进程、Service进程之间的通信；除此之外<code>electron-re</code>中简单实现了一个不依赖于Electron运行时的子进程池类<code>ChildProcessPool</code>和子进程中使用的进程事务中心<code>ProcessHost</code>，前者用于创建一个子进程池实例来负责多个子进程的创建和协调，后者可以简化子进程和进程池实例的数据传输过程。工具还提供了一个进程状态UI管理界面，可以用于展示Electron子进程、Electron主进程、进程池子进程的进程号、进程标识、CPU/Memory占用趋势，也可用于Electron子进程的devtools工具快速开启、进程的一键Kill等功能。</li><li><a href="https://github.com/nojsja/react-nojsja/tree/master/components/EditableTree">EditableTree</a> 一个基于Antd开发的可编辑树组件，已经发布到NPM仓库，可实现树形数据的各个层级增删查改、yaml数据转化为多个树节点、树深度限制、自定义树层级是否可编辑、可删除等功能。开发这个组件的目的主要是为了弥补Antd中树组件不可任意编辑的问题，以满足业务需求。</li></ul></li></ol><h3 id="I-要点：HTML-CSS">I. 要点：HTML/CSS</h3><hr><h4 id="➣-position各个属性的作用">➣ position各个属性的作用</h4><ul><li><strong>static(默认值)</strong>：浏览器会按照源码的顺序，决定每个元素的位置，这称为&quot;正常的页面流&quot;。</li><li><strong>relative</strong>：表示元素相对于默认位置（即static时的位置）进行偏移，即定位基点是元素的默认位置。需要搭配top、bottom、left、right这四个属性一起使用，用来指定偏移的方向和距离，例如<code>top: 20px;</code>表示<code>元素从默认位置向下偏移20px</code>。</li><li><strong>fixed</strong>：表示元素相对于视口（viewport，浏览器窗口）进行偏移，即定位基点是浏览器窗口。这会导致元素的位置不随页面滚动而变化，好像固定在网页上一样。例如<code>top:0</code>表示元素在视口顶部。</li><li><strong>absolute</strong>：absolute表示，相对于上级元素（一般是父元素）进行偏移，即定位基点是父元素。不过定位基点（一般是父元素）不能是static定位，否则定位基点就会变成整个网页的根元素html，另外，absolute定位也必须搭配top、bottom、left、right这四个属性一起使用。</li><li><strong>sticky</strong>：sticky跟前面四个属性值都不一样，它会产生动态效果，很像relative和fixed的结合：一些时候是relative定位（定位基点是自身默认位置），另一些时候自动变成fixed定位（定位基点是视口），需要搭配<code>top、bottom、left、right</code>使用。它的具体规则是，当页面滚动，父元素开始脱离视口时（即部分不可见），只要与sticky元素的距离达到生效门槛，relative定位自动切换为fixed定位；等到父元素完全脱离视口时（即完全不可见），fixed定位自动切换回relative定位。</li></ul><h4 id="➣-display各个属性作用">➣ display各个属性作用</h4><p>     display属性可以设置元素的内部和外部显示类型，元素的外部显示类型将决定该元素在流式布局中的表现，例如块级或内联元素，元素的内部显示类型可以控制其子元素的布局，例如grid或flex。目前所有浏览器都支持display属性，但是对于属性值的兼容性仍需注意。</p><h5 id="1-外部显示">1. 外部显示</h5><p>     这些值指定了元素的外部显示类型，实际上就是其在流式布局中的角色，即在流式布局中的表现。</p><ul><li><p>display: <strong>none</strong><br>display: none;是CSS1规范，无兼容性问题，该属性值表示此元素不会被显示，依照词义是真正隐藏元素，使用这个属性，被隐藏的元素不占据任何空间，用户交互操作例如点击事件都不会生效，读屏软件也不会读到元素的内容，这个元素的任何子元素也会同时被隐藏。当使用该属性将元素从显示状态切换为隐藏状态时，元素不占据原本的空间，会触发浏览器的重绘与回流。为这个属性添加过渡动画是无效的，他的任何不同状态值之间的切换总是会立即生效。这种方式产生的效果就像元素完全不存在，但在DOM中依然可以访问到这个元素，也可以通过DOM来操作它。</p></li><li><p>display: <strong>block</strong><br>display: block;是CSS1规范，无兼容性问题，该属性值表示此元素将显示为块级元素，此元素前后会带有换行符，元素独占一行，封闭后自动换行，默认宽度为100%，可以指定宽度和高度，内外边距对于四个方向有效。</p></li><li><p>display: <strong>inline</strong><br>display: inline;是CSS1规范，无兼容性问题，该属性值表示此元素会被显示为内联元素，元素会生成一个或多个内联元素框，这些框不会在自身之前或之后产生换行符，在正常流中，如果有空间，则下一个元素将在同一行上，元素排在一行，封闭后不会自动换行，不能指定高度与宽度，可以使用line-height来指定行高，外边距对于水平方向有效，垂直方向无效，内边距对于水平方向和垂直方向正常有效，对其他元素无任何影响。</p></li><li><p>display: <strong>inline-block</strong><br>display: inline-block;是CSS2规范，无兼容性问题，该属性值表示此元素将显示为内联块元素，该元素生成一个块元素框，该框将随周围的内容一起流动，就好像它是单个内联框一样，与被替换的元素非常相似，它等效于内联流根inline flow-root，可以指定宽度和高度，内外边距对于四个方向有效元素排在一行，但是在回车后会有空白缝隙。</p></li><li><p>display: <strong>run-in</strong><br>display: run-in;是CSS2规范，绝大部分浏览器都不兼容，目前这是个实验性属性值，不应该用作生产环境，该属性值表示此元素会根据上下文决定对象是内联对象还是块级对象，如果它后一个元素是block那么它会变成inline并和后一个元素并排，如果它后一个元素是inline那么它会变成block。</p></li></ul><h5 id="2-内部显示">2. 内部显示</h5><p>     这些关键字指定了元素的内部显示类型，它们定义了该元素内部内容的布局方式，需要假定该元素为非替换元素。</p><ul><li><p>display: <strong>flow-root</strong><br>display: flow-root;是CSS3规范，兼容性一般，该属性值表示此元素会生成一个块元素盒子，该元素盒子可建立一个新的块格式化上下文BFC，定义格式化根所在的位置。</p></li><li><p>display: <strong>table</strong><br>display: table;是CSS2规范，兼容性良好，该属性值表示此元素会作为块级表格来显示，类似<code>&lt;table&gt;</code>，表格前后带有换行符。</p></li><li><p>display: <strong>flex</strong><br>display: flex;是CSS3规范，目前主流浏览器都已支持，是布局的首选方案，该属性值表示此元素会作为弹性盒子显示，在外部表现为block，内部作为弹性盒子使用，弹性布局可以为盒状模型提供最大的灵活性。在兼容移动端浏览器的方案上，有可能需要使用display:-webkit-box;，也就是内核前缀-box，同样都是弹性盒子，由于各阶段草案命名的原因，其命名从box更改为flex，flex是新的规范属性，此外flex并不能完全替代box，使用这两种方式在实际布局中会存在差异。</p></li><li><p>display: <strong>grid</strong><br>display: grid;是CSS3规范，目前主流浏览器都已支持，该属性值表示将元素分为一个个网格，然后利用这些网格组合做出各种各样的布局。Grid布局与Flex布局有一定的相似性，都可以指定容器内部多个成员的位置。不同之处在于，Flex布局是轴线布局，只能指定成员针对轴线的位置，可以看作是一维布局。Grid布局则是将容器划分成行和列，产生单元格，然后指定成员所在的单元格，可以看作是二维布局。</p></li><li><p>display: <strong>inline-table</strong><br>display: inline-table;是CSS2规范，兼容性良好，该属性值与display: table;在元素内部表现相同，在元素外部显示表现为inline。</p></li><li><p>display: <strong>inline-flex</strong><br>display: inline-flex;是CSS3规范，目前主流浏览器都已支持，该属性值与display: flex;在元素内部表现相同，在元素外部显示表现为inline。</p></li><li><p>display: <strong>inline-grid</strong><br>display: inline-grid;是CSS3规范，目前主流浏览器都已支持，该属性值与display: grid;在元素内部表现相同，在元素外部显示表现为inline。</p></li><li><p>display: <strong>list-item</strong><br>display: list-item;是CSS1规范，无兼容性问题，该属性值表示将元素的外部显示类型变为block盒模型，并将内部显示类型变为多个list-item inline盒模型。</p></li></ul><h5 id="3-内部表现">3. 内部表现</h5><p>     table布局模型有着相对复杂的内部结构，因此它们的子元素可能扮演着不同的角色，这一类关键字就是用来定义这些内部显示类型，并且只有在这些特定的布局模型中才有意义。</p><ul><li><p>display: <strong>table-row-group</strong><br>display: table-row-group;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个或多个行的分组来显示，类似于<code>&lt;tbody&gt;</code>。</p></li><li><p>display: <strong>table-header-group</strong><br>display: table-header-group;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个或多个行的分组来显示，类似于<code>&lt;thead&gt;</code>。</p></li><li><p>display: <strong>table-footer-group</strong><br>display: table-footer-group;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个或多个行的分组来显示，类似于<code>&lt;tfoot&gt;</code>。</p></li><li><p>display: <strong>table-row</strong><br>display: table-row;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个表格行显示，类似于<code>&lt;tr&gt;</code>。</p></li><li><p>display: <strong>table-column-group</strong><br>display: table-column-group;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个或多个列的分组来显示，类似于<code>&lt;colgroup&gt;</code>。</p></li><li><p>display: <strong>table-column</strong><br>display: table-column;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个单元格列显示，类似于<code>&lt;col&gt;</code>。</p></li><li><p>display: <strong>table-cell</strong><br>display: table-cell;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个表格单元格显示，类似于<code>&lt;td&gt;和&lt;th&gt;</code>。</p></li><li><p>display: <strong>table-caption</strong><br>display: table-caption;是CSS2规范，兼容性良好，该属性值表示此元素会作为一个表格标题显示，类似于<code>&lt;caption&gt;</code>。</p></li></ul><h4 id="➣-BFC及其应用">➣ BFC及其应用</h4><ol><li><p>BFC 就是块级格式上下文，是页面盒模型布局中的一种 CSS 渲染模式，<br>相当于一个独立的容器，里面的元素和外部的元素相互不影响。创建 BFC 的方式有：</p><ul><li>html 根元素</li><li>float 浮动</li><li>overflow 为 hidden、auto、scroll</li><li>position值为fixed、absolute、sticky</li><li>display 为Table布局、Flex布局、inline-block、Grid布局</li></ul></li><li><p>BFC 主要的作用是：</p><ul><li>清除浮动（不会和浮动元素重叠）</li><li>防止同一 BFC 容器中的相邻元素间的外边距重叠问题</li><li>多列布局</li></ul></li><li><p>BFC 表现</p><ul><li>内部的Box会在垂直方向上一个接一个放置</li><li>Box垂直方向的距离由margin决定，属于同一个BFC的两个相邻Box的margin会发生重叠</li><li>每个元素的 margin box 的左边，与包含块 border box 的左边相接触</li><li>BFC的区域不会与float box重叠</li><li>BFC是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素</li><li>BFC可以正确包含浮动元素，计算BFC的高度时，浮动元素也会参与计算</li></ul></li></ol><h4 id="➣-怎样实现一个不定宽高的div水平垂直居中">➣ 怎样实现一个不定宽高的div水平垂直居中</h4><ul><li>只需要在父盒子设置：<code>display: flex; justify-content: center;align-items: center;</code></li><li>使用 CSS3 transform，父盒子设置: <code>display:relative Div 设置: transform: translate(-50%，-50%);position: absolute;top: 50%;left: 50%;</code></li><li>使用 display:table-cell 方法，父盒子设置:<code>display:table-cell; text-align:center;vertical-align:middle;</code>，Div 设置: <code>display:inline-block;vertical-align:middle;</code>。</li></ul><h4 id="➣-box-sizing是什么">➣ box-sizing是什么</h4><p>设置CSS盒模型为标准模型或IE模型。标准模型的宽度只包括content，二IE模型包括border和padding。</p><p>box-sizing属性可以为三个值之一：</p><ul><li>content-box，默认值，只计算内容的宽度，border和padding不计算入width之内</li><li>padding-box，padding计算入宽度内</li><li>border-box，border和padding计算入宽度之内</li></ul><h4 id="➣-grid布局">➣ grid布局</h4><p>     讲到布局，我们就会想到 flex 布局，甚至有人认为竟然有 flex 布局了，似乎没有必要去了解 Grid 布局。但 flex 布局和 Grid 布局有实质的区别，那就是 flex 布局是一维布局，Grid 布局是二维布局。flex 布局一次只能处理一个维度上的元素布局，一行或者一列。Grid 布局是将容器划分成了“行”和“列”，产生了一个个的网格，我们可以将网格元素放在与这些行和列相关的位置上，从而达到我们布局的目的。</p><h5 id="1-容器元素">1. 容器元素</h5><ul><li>需要设置：<code>display: grid;</code></li><li><strong>grid-template-columns</strong>：属性定义每一列的列宽。比如<code>100px 100px 100px</code>指定三列，列宽100px，也可使用百分比单位；搭配<code>repeat</code>函数可以简化书写：<code>repeat(3, 33.33%);</code>。repeat重复某种模式也是可以的，比如：<code>repeat(2, 100px 20px 80px)</code>；如果要实现不固定列数，自动填充的话使用<code>auto-fill</code>即可，会根据列宽和容器动态宽度自动进行计算：<code>repeat(auto-fill, 100px)</code>；为了方便表示列宽度之间的比例关系，可以使用fr关键字，比如两列的宽度分别为1fr和2fr，就表示后者是前者的两倍，分别占1/3和2/3，<code>grid-template-columns: 1fr 2fr</code>。fr和px可混用，<code>150px 1fr 2fr</code>；使用auto关键字表示由浏览器自己决定长度：<code>grid-template-columns: 100px auto 100px;</code>。</li><li><strong>grid-template-rows</strong>：属性定义每一行的行高，用法同上。</li><li><strong>grid-gap</strong>：grid-row-gap和grid-columns-gap的合并简写形式，表示行间距和列间距，只写一个值表示两个值相同。</li><li><strong>grid-template-areas</strong>：网格布局允许指定&quot;区域&quot;（area），一个区域由单个或多个单元格组成，下面代码先划分出9个单元格，然后将其定名为a到i的九个区域，分别对应这九个单元格。：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: grid;</span><br><span class="line">  grid-template-<span class="attribute">columns</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">  grid-template-rows: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">  grid-template-areas: <span class="string">&#x27;a b c&#x27;</span></span><br><span class="line">                       <span class="string">&#x27;d e f&#x27;</span></span><br><span class="line">                       <span class="string">&#x27;g h i&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>grid-auto-flow</strong>：划分网格以后，容器的子元素会按照顺序，自动放置在每一个网格。默认的放置顺序是&quot;先行后列&quot;，即先填满第一行，再开始放入第二行。这个顺序由grid-auto-flow属性决定，默认值是row，即&quot;先行后列&quot;。也可以将它设成column，变成&quot;先列后行&quot;。还可以设成<code>row dense</code>和<code>column dense</code>，这两个值主要用于，某些项目指定位置以后，剩下的项目尽可能紧密填满，尽量不出现空格。</li><li><strong>justify-items</strong>: 属性设置单元格中内容的水平位置（左中右）：<code>start | end | center | stretch(拉伸);</code>。</li><li><strong>align-items</strong>: 属性设置单元格内容的垂直位置（上中下）：<code>start | end | center | stretch;</code>。</li><li><strong>justify-content</strong>：属性指定整个内容区域在容器里面的水平位置（左中右）：<code>start | end | center | stretch | space-around(item间隔均分) | space-between | space-evenly(边框和item完全平均分布);</code>。</li><li><strong>align-content</strong>：属性指定整个内容区域的垂直位置（上中下）：<code>start | end | center | stretch | space-around(item间隔均分) | space-between | space-evenly(边框和item完全平均分布);</code>。</li></ul><h5 id="2-子元素">2. 子元素</h5><ul><li><strong>grid-area</strong>：属性指定项目放在哪一个区域，与<code>grid-template-area</code>搭配使用：<code>grid-area: e;</code>。</li><li><strong>justify-self</strong>：属性设置单元格内容的水平位置（左中右），跟justify-items属性的用法完全一致，但只作用于单个项目：<code>start | end | center | stretch;</code>。</li><li><strong>align-self</strong>：属性设置单元格内容的垂直位置（上中下），跟align-items属性的用法完全一致，也是只作用于单个项目：<code>start | end | center | stretch;</code>。</li></ul><h4 id="➣-flex布局">➣ flex布局</h4><h5 id="1-容器元素-2">1. 容器元素</h5><ul><li>需要设置：<code>display: flex;</code></li><li>flex-direction：属性决定主轴的方向（即项目的排列方向）： <code>row(默认) | row-reverse | column | column-reverse</code>。</li><li>flex-wrap：决定items在一条轴线排不下时如何换行，<code>nowrap | wrap | wrap-reverse(换行，第一行在下方)</code></li><li>flex-flow：flex-direction + flex-wrap 简写形式。</li><li>justify-content：items在主轴上的对齐方式：<code>flex-start | flex-end | center | space-between | space-around(元素间隔均匀)</code>。</li><li>align-items：定义items在交叉轴上如何对齐：<code>flex-start | flex-end | center | baseline(第一行文本基线) | stretch(拉伸)</code>。</li><li>align-content：定义了多根主轴线的对齐方式，如果项目只有一根轴线，该属性不起作用：<code>flex-start | flex-end | center | space-between | space-around | stretch</code>。</li></ul><h5 id="2-子元素-2">2. 子元素</h5><ul><li>order：定义item的排列顺序，数值越小，排列越靠前，默认为0。</li><li>flex-grow：定义item的放大比例，默认为0，即如果存在剩余空间，也不放大。</li><li>flex-shrink：定义了item的缩小比例，默认为1，即如果空间不足，该项目将缩小。</li><li>flex-basis：属性定义了在分配多余空间之前，item占据的主轴空间（main size）。根据这个属性，计算主轴是否有多余空间。它的默认值为auto，即项目的本来大小。</li><li>flex：属性是flex-grow, flex-shrink 和 flex-basis的简写，默认值为<code>0 1 auto</code>。该属性有两个快捷值：auto (<code>1 1 auto</code>) 和 none (<code>0 0 auto</code>)。</li><li>align-self：align-self属性允许单个item有与其他item不一样的对齐方式，可覆盖align-items属性。默认值为auto，表示继承父元素的align-items属性，如果没有父元素，则等同于stretch。</li></ul><h4 id="➣-浏览器回流和重绘">➣ 浏览器回流和重绘</h4><p>     从上面这个图上，我们可以看到，浏览器渲染过程如下：</p><ul><li>解析HTML，生成DOM树，解析CSS，生成CSSOM树</li><li>将DOM树和CSSOM树结合，生成渲染树(Render Tree)</li><li>Layout(回流):根据生成的渲染树，进行回流(Layout)，得到节点的几何信息（位置，大小）</li><li>Painting(重绘):根据渲染树以及回流得到的几何信息，得到节点的绝对像素</li><li>Display:将像素发送给GPU，展示在页面上。</li></ul><h4 id="➣-两列布局实现">➣ 两列布局实现</h4><ol><li>使用float浮动元素同时设置元素宽度为100/列数 %</li><li>使用inline-block实现方式同1</li><li>使用css属性column-count实现</li><li>使用flex布局、grid布局</li></ol><h4 id="➣-1px问题">➣ 1px问题</h4><ol><li>涉及到css像素比 device pixel/css pixel = devicePixelRatio(DPR)</li><li>解决方法一<br>伪元素设置height模拟边框：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.setBorderAll&#123;</span><br><span class="line">   <span class="attr">position</span>: relative;</span><br><span class="line">     &amp;:after&#123;</span><br><span class="line">         <span class="attr">content</span>:<span class="string">&quot; &quot;</span>;</span><br><span class="line">         position:absolute;</span><br><span class="line">         top: <span class="number">0</span>;</span><br><span class="line">         left: <span class="number">0</span>;</span><br><span class="line">         width: <span class="number">200</span>%;</span><br><span class="line">         height: <span class="number">200</span>%;</span><br><span class="line">         transform: scale(<span class="number">0.5</span>);</span><br><span class="line">         transform-origin: left top;</span><br><span class="line">         box-sizing: border-box;</span><br><span class="line">         border: 1px solid #E5E5E5;</span><br><span class="line">         border-radius: 4px;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>解决方法二<br>设置盒子阴影：</li></ol><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">box-shadow</span>: <span class="number">0</span>  -<span class="number">1px</span> <span class="number">1px</span> -<span class="number">1px</span> <span class="number">#e5e5e5</span>,   //上边线</span><br><span class="line">          <span class="number">1px</span>  <span class="number">0</span>  <span class="number">1px</span> -<span class="number">1px</span> <span class="number">#e5e5e5</span>,   //右边线</span><br><span class="line">          <span class="number">0</span>  <span class="number">1px</span>  <span class="number">1px</span> -<span class="number">1px</span> <span class="number">#e5e5e5</span>,   //下边线</span><br><span class="line">          -<span class="number">1px</span> <span class="number">0</span>  <span class="number">1px</span> -<span class="number">1px</span> <span class="number">#e5e5e5</span>;   //左边线</span><br></pre></td></tr></table></figure><h4 id="➣-浮动布局相关">➣ 浮动布局相关</h4><ol><li>清除浮动的属性<br>浮动元素尾部那个不跟随浮动的元素设置<code>clear:both</code></li><li>撑起浮动容器元素的方法一<br>在浮动元素的最后插入一个声明了<code>clear:both</code>的块级元素</li><li>撑起浮动容器元素的方法二<br>在浮动容器元素后使用伪元素：</li></ol><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span>:after &#123;</span><br><span class="line">  content: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">clear</span>: both;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>撑起浮动容器元素的方法三<br>利用BFC特性，设置浮动容器元素的<code>overflow</code>为scroll、auto、hidden</li></ol><h4 id="➣-位图和矢量图的区别">➣ 位图和矢量图的区别</h4><ol><li>位图也叫像素图，每个点可以用二进制描述颜色和亮度信息，色彩表现丰富，占用空间大，缩放失真</li><li>矢量图使用计算机指令绘制而成，由点线面构成，色彩不丰富，占用空间小，缩放不失真</li></ol><h4 id="➣-opacity-0、visibility-hidden、display-none-的异同">➣ opacity: 0、visibility: hidden、display: none 的异同</h4><p>     这几个属性它们都能让元素不可见</p><ul><li><p>结构： display:none: 会让元素完全从渲染树中消失，渲染的时候不占据任何空间, 不能点击， visibility: hidden:不会让元素从渲染树消失，渲染元素继续占据空间，只是内容不可见，不能点击 opacity: 0: 不会让元素从渲染树消失，渲染元素继续占据空间，只是内容不可见，可以点击</p></li><li><p>继承： display: none和opacity: 0：是非继承属性，子孙节点消失由于元素从渲染树消失造成，通过修改子孙节点属性无法显示。 visibility: hidden：是继承属性，子孙节点消失由于继承了hidden，通过设置visibility: visible;可以让子孙节点显式。</p></li><li><p>性能： displa:none : 修改元素会造成文档回流,读屏器不会读取，性能消耗较大；visibility:hidden: 修改元素只会造成本元素的重绘, 性能消耗较少，读屏器能读取；；opacity: 0 ： 修改元素会造成重绘，性能消耗较少，读屏器能读取。</p></li></ul><h4 id="➣-多端适配">➣ 多端适配</h4><h5 id="1-关于视口">1. 关于视口</h5><p>移动端浏览器通常宽度是 240px~640px，而大多数为 PC 端设计的网站宽度至少为 800px，如果仍以浏览器窗口作为视口的话，网站内容在手机上看起来会非常窄。</p><p>因此，引入了布局视口、视觉视口和理想视口三个概念，使得移动端中的视口与浏览器宽度不再相关联。</p><ul><li>1）布局视口（layout viewport）</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/layout_viewport.png"  alt=""></p><p>一般移动设备的浏览器都默认设置了一个 viewport 元标签，定义一个虚拟的布局视口（layout viewport），用于解决早期的页面在手机上显示的问题。iOS, Android 基本都将这个视口分辨率设置为 980px，所以 PC 上的网页基本能在手机上呈现，只不过元素看上去很小，一般默认可以通过手动缩放网页。</p><p>布局视口的宽度/高度可以通过 <code>document.documentElement.clientWidth / Height</code> 获取。布局视口使视口与移动端浏览器屏幕宽度完全独立开。CSS 布局将会根据它来进行计算，并被它约束。</p><ul><li>2）视觉视口（visual viewport）</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/visual_viewport.png"  alt=""></p><p>视觉视口是用户当前看到的区域，用户可以通过缩放操作视觉视口，同时不会影响布局视口。</p><p>视觉视口和缩放比例的关系为：<code>当前缩放值 = 理想视口宽度 / 视觉视口宽度</code>。所以，当用户放大时，视觉视口将会变小，一个CSS 像素将显示更多的物理像素。</p><ul><li>3）理想视口（ideal viewport）</li></ul><p>布局视口的默认宽度并不是一个理想的宽度，于是 Apple 和其他浏览器厂商引入了理想视口的概念，它对设备而言是最理想的布局视口尺寸。显示在理想视口中的网站具有最理想的宽度，用户无需进行缩放。</p><p>理想视口的值其实就是屏幕分辨率的值，它对应的像素叫做设备逻辑像素（device independent pixel, dip）。dip 和设备的物理像素无关，一个 dip 在任意像素密度的设备屏幕上都占据相同的空间。如果用户没有进行缩放，那么一个 CSS 像素就等于一个 dip。</p><p>用下面的方法可以使布局视口与理想视口的宽度一致：<code>&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;</code></p><ul><li><p>4）注意：</p><ul><li><p>viewport 标签只对移动端浏览器有效，对 PC 端浏览器是无效的</p></li><li><p>当缩放比例为 100% 时，dip 宽度 = CSS 像素宽度 = 理想视口的宽度 = 布局视口的宽度</p></li><li><p>单独设置 initial-scale 或 width 都会有兼容性问题，所以设置布局视口为理想视口的最佳方法是同时设置这两个属性</p></li><li><p>即使设置了 user-scalable = no，在 Android Chrome 浏览器中也可以强制启用手动缩放</p></li></ul></li></ul><h5 id="2-关于多倍图">2. 关于多倍图</h5><p>MacBook Pro 视网膜屏（Retina）显示器硬件像素是 2880px 1800px。当设置屏幕分辨率为 1920px 1200px 的时候，理想视口的宽度值是 1920px， 那么 dip 的宽度值就是 1920px。其与理想视口宽度的比值为1.5（2880/1920），这个比值叫做设备像素比：<code>逻辑像素宽度 * dpr = 物理像素宽度</code>。</p><p>设备像素比可以通过 window.devicePixelRatio 来获取，或者使用 CSS 中的 device-pixel-ratio。</p><p>下面是常见的设备像素比：</p><ul><li>普通密度桌面显示屏：devicePixelRatio = 1</li><li>高密度桌面显示屏(Mac Retina)：devicePixelRatio = 2</li><li>主流手机显示屏：devicePixelRatio = 2 or 3</li></ul><p>对于一张 100px * 100px 的图片，通过 CSS 设置其宽高：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在普通显示屏的电脑中打开是正常的，但假设在手机或 Retina 屏中打开，按照逻辑分辨率来渲染，他们的 devicePixelRatio = 2，那么就相当于拿 4 个物理像素来描绘 1 个电子像素。这等于拿一个2倍的放大镜去看图片，图片就会变得模糊。这时，就需要使用 @2x 甚至 @3x 图来避免图片的失真。</p><h3 id="II-要点：Javascript">II. 要点：Javascript</h3><hr><h4 id="➣-Map-WeakMap-Set-WeakSet区别">➣ Map/WeakMap/Set/WeakSet区别</h4><h5 id="1-Set">1. Set</h5><ul><li>成员唯一、无序且不重复，可以为对象或基本类型</li><li>属性：size</li><li>[value, value]，键值与键名是一致的（或者说只有键值，没有键名）</li><li>操作方法：</li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(value)：新增，相当于 array里的push</span><br><span class="line"><span class="keyword">delete</span>(value)：存在即删除集合中value</span><br><span class="line">has(value)：判断集合中是否存在 value</span><br><span class="line">clear()：清空集合</span><br></pre></td></tr></table></figure><ul><li>可以遍历：</li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keys()：返回一个包含集合中所有键的迭代器</span><br><span class="line">values()：返回一个包含集合中所有值得迭代器</span><br><span class="line">entries()：返回一个包含<span class="built_in">Set</span>对象中所有元素得键值对迭代器</span><br><span class="line">forEach(<span class="function">(<span class="params">v, k</span>) =&gt;</span> (), thisArg)：用于对集合成员执行callbackFn操作，如果提供了 thisArg 参数，回调中的<span class="built_in">this</span>会是这个参数，没有返回值</span><br></pre></td></tr></table></figure><h5 id="2-WeakSet">2. WeakSet</h5><ul><li>成员都是对象</li><li>成员都是弱引用，可以被垃圾回收机制回收，可以用来保存DOM节点，不容易造成内存泄漏</li><li>不能遍历，方法有add、delete、has</li></ul><h5 id="3-Map">3. Map</h5><ul><li>本质上是键值对的集合，类似集合</li><li>可以遍历，方法很多可以跟各种数据格式转换</li><li>属性：size</li><li>操作方法：</li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set(key, value)：向字典中添加新元素</span><br><span class="line">get(key)：通过键查找特定的数值并返回</span><br><span class="line">has(key)：判断字典中是否存在键key</span><br><span class="line"><span class="keyword">delete</span>(key)：通过键 key 从字典中移除对应的数据</span><br><span class="line">clear()：将这个字典中的所有元素删除</span><br></pre></td></tr></table></figure><ul><li>遍历方法：</li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Keys()：将字典中包含的所有键名以迭代器形式返回</span><br><span class="line">values()：将字典中包含的所有数值以迭代器形式返回</span><br><span class="line">entries()：返回所有成员的迭代器</span><br><span class="line">forEach(<span class="function">(<span class="params">v, k, map</span>) =&gt;</span> ())：遍历字典的所有成员</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="4-WeakMap">4. WeakMap</h5><ul><li>只接受对象作为键名（null除外），不接受其他类型的值作为键名</li><li>键名是弱引用，键值可以是任意的，键名所指向的对象可以被垃圾回收，此时键名是无效的</li><li>不能遍历，方法有get、set、has、delete</li></ul><h4 id="➣-js类型的判断">➣ js类型的判断</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">基础类型：string/boolean/number/null/undefined/symbol</span></span><br><span class="line"><span class="comment">引用类型：function/object(date|regexp|obj)/array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTypeOf</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (data !== data) <span class="keyword">return</span> <span class="string">&#x27;nan&#x27;</span>;</span><br><span class="line">  <span class="keyword">switch</span>(<span class="built_in">Object</span>.prototype.toString.call(data)) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[object Null]&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[object Array]&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;array&#x27;</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[object Object]&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[object RegExp]&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;regexp&#x27;</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[object Date]&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;date&#x27;</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">typeof</span> data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-实现Call和Apply">➣ 实现Call和Apply</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.myCall = <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args, result, symbol;</span><br><span class="line"></span><br><span class="line">  context = <span class="built_in">Object</span>(context) || <span class="built_in">window</span>;</span><br><span class="line">  args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">  symbol = <span class="built_in">Symbol</span>(<span class="string">&#x27;myCall&#x27;</span>);</span><br><span class="line">  context[symbol] = <span class="built_in">this</span>;</span><br><span class="line">  <span class="comment">// 如果不使用扩展运算符的话可以将args[i]转换成逗号分隔的字符串</span></span><br><span class="line">  <span class="comment">// 然后通过eval(&#x27;context.fn(&#x27;+ argstr +&#x27;)&#x27;)获取结果</span></span><br><span class="line">  result = context[symbol](...args);</span><br><span class="line">  <span class="keyword">delete</span> context[symbol];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Function</span>.prototype.myApply = <span class="function"><span class="keyword">function</span>(<span class="params">context, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result, symbol;</span><br><span class="line"></span><br><span class="line">  args = args || [];</span><br><span class="line">  context = <span class="built_in">Object</span>(context) || <span class="built_in">window</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(args <span class="keyword">instanceof</span> <span class="built_in">Array</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;The args of apply must be an array.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  symbol = <span class="built_in">Symbol</span>(<span class="string">&#x27;myApply&#x27;</span>);</span><br><span class="line">  context[symbol] = <span class="built_in">this</span>;</span><br><span class="line">  result = context[symbol](...args);</span><br><span class="line">  <span class="keyword">delete</span> context[symbol];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="➣-实现对象new操作">➣ 实现对象new操作</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">New</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.toString.call(func) !== <span class="string">&#x27;[object Function]&#x27;</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;params of theNew must be a function!&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> empty, args, res;</span><br><span class="line"></span><br><span class="line">  empty = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">  args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  res = func.apply(empty, args);</span><br><span class="line">  empty.__proto__ = func.prototype;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res || empty;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Js实现bind函数">Js实现bind函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.myBind = <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> that.apply(context, args.concat(<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-二维数组扁平化">➣ 二维数组扁平化</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> array.reduce(<span class="function">(<span class="params">total, current</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> total.concat(current);</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">array, res=[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(array[i])) &#123;</span><br><span class="line">      flat(array[i], res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.push(array[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(array[i])) &#123;</span><br><span class="line">      res.push(...array[i]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.push(array[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="built_in">JSON</span>.stringify(array);</span><br><span class="line">  str = str.replace(<span class="regexp">/[\[\]]/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(<span class="string">`[<span class="subst">$&#123;str&#125;</span>]`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(flat([[<span class="number">1</span>,<span class="number">2</span>], [<span class="number">2</span>,<span class="number">3</span>], <span class="number">4</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="➣-Js如何判断一个数是不是2的N次幂">➣ Js如何判断一个数是不是2的N次幂</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check2n</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(num) || num &lt; <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (num !== <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (num &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (num % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        num = num / <span class="number">2</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-Js实现继承">➣ Js实现继承</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Inherit</span> (<span class="params">parent, child</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Empty</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">  Empty.prototype = parent.prototype;</span><br><span class="line">  <span class="keyword">var</span> empty = <span class="keyword">new</span> Empty();</span><br><span class="line">  empty.constructor = child;</span><br><span class="line">  child.prototype = empty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params">parent</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.p_attr = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Parent.prototype.p_print = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">this</span>.p_attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child</span>(<span class="params">attr</span>) </span>&#123;</span><br><span class="line">  Parent.call(<span class="built_in">this</span>, <span class="string">&#x27;parent&#x27;</span>);</span><br><span class="line">  <span class="built_in">this</span>.c_attr = attr;</span><br><span class="line">  <span class="built_in">this</span>.print = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.c_attr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Inherit(Parent, Child);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child(<span class="string">&#x27;child&#x27;</span>);</span><br><span class="line"></span><br><span class="line">child.print();</span><br><span class="line">child.p_print();</span><br></pre></td></tr></table></figure><h4 id="➣-手写深拷贝和浅拷贝">➣ 手写深拷贝和浅拷贝</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 深拷贝 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepClone</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> isObjType = <span class="function">(<span class="params">obj, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(obj) === <span class="string">`[object <span class="subst">$&#123;type&#125;</span>]`</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> _clone = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (target !== target) <span class="keyword">return</span> <span class="literal">NaN</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span> target;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对正则对象做特殊处理</span></span><br><span class="line">    <span class="keyword">if</span> (isObjType(target, <span class="string">&#x27;RegExp&#x27;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">RegExp</span>(target.source, target.flags);</span><br><span class="line">    <span class="comment">// 对Date对象做特殊处理</span></span><br><span class="line">    <span class="keyword">if</span> (isObjType(target, <span class="string">&#x27;Date&#x27;</span>)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(target.getTime());</span><br><span class="line"></span><br><span class="line">    base = isObjType(target, <span class="string">&#x27;Array&#x27;</span>) ? [] : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理循环引用</span></span><br><span class="line">    <span class="keyword">if</span> (map.has(target))</span><br><span class="line">      <span class="keyword">return</span> map.get(target);</span><br><span class="line">    map.set(target, base);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> target) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(target, i)) &#123;</span><br><span class="line">        base[i] = _clone(target[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> base;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _clone(data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 浅拷贝 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shallowClone</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> base;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!data || !(<span class="keyword">typeof</span> data === <span class="string">&#x27;object&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    base = <span class="built_in">Object</span>.prototype.toString.call(data) === <span class="string">&#x27;[object Array]&#x27;</span> ? [] : &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> attr <span class="keyword">in</span> data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(data, attr)) &#123;</span><br><span class="line">      base[attr] = data[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="➣-基本数据类型和引用数据类型">➣ 基本数据类型和引用数据类型</h4><ol><li>基本数据类型：String/Boolean/Number/Null/Undefined/Symbol/BigInt(ES2020)</li><li>引用数据类型：Function/Object/Array</li></ol><h4 id="➣-如何判断对象上的属性是原型属性还是实例属性呢？">➣ 如何判断对象上的属性是原型属性还是实例属性呢？</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 实例属性 */</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, attr);</span><br><span class="line"><span class="comment">/* 原型属性 */</span></span><br><span class="line">(attr <span class="keyword">in</span> obj) &amp;&amp; !<span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, attr);</span><br></pre></td></tr></table></figure><h4 id="➣-ES6新增特性">➣ ES6新增特性</h4><ol><li>Promise</li><li>let/const/块级作用域</li><li>Arrow Function、函数默认参数、数组、对象、函数返回值的解构</li><li>Map/WeakMap/Set/WeakSet</li><li>ES6 Class</li><li>字符串方法扩展repeat/trim/includes/startsWith/endsWith/padStart/padEnd</li><li>数组方法扩展find/findIndex/fill/includes</li><li>Array.from将类数组和实现了迭代器的对象转换成数组</li><li>Array.of将一个或多个值转换成数组</li></ol><h4 id="➣-移动端点击穿透问题">➣ 移动端点击穿透问题</h4><ol><li>问题来源<br>移动浏览器提供一个特殊的功能：双击(double tap)放大，300ms的延迟就来自这里，用户碰触页面之后，需要等待一段时间来判断是不是双击动作，而不是立即响应单击（click），等待的这段时间大约是300ms。为了消除延迟，我们使用touch start / touch end 事件来模拟click事件，这便是造成点击穿透问题的原因，想象一个场景：mask蒙层有个绑定touch start事件的关闭按钮，点击之后蒙层消失，之后300ms后点击位置触发click事件，导致mask下面的元素被误触。</li><li>问题解决<br>1）界面统一使用touch事件替代click事件<br>2）界面只click事件(会造成300ms延迟)<br>3）mask隐藏后，给按钮下面元素添上<code>pointer-events: none</code>(会造成元素短时间无法响应)<br>4）使用外部框架<code>fastclick</code>解决</li></ol><h4 id="➣-图片懒加载具体实现方案和思路">➣ 图片懒加载具体实现方案和思路</h4><p>使用监听器IntersectionObserver来监听界面滚动，当被监听元素处于视口可见区域时，设置图片元素的src为真实的地址。如果不使用这个API的话需要手动监听页面滚动然后通过计算img元素的<code>offsetTop &lt; document.documentElement.clientHeight + (document.documentElement.scrollTop || document.body.scrollTop)</code> 来判断元素进入视区实现，并注意配合防抖函数进行优化。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">lazyLoad</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> imageToLazy = <span class="built_in">document</span>.querySelectorAll(<span class="string">&#x27;img[data-src]&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> loadImage = <span class="function"><span class="keyword">function</span> (<span class="params">image</span>) </span>&#123;</span><br><span class="line">        image.setAttribute(<span class="string">&#x27;src&#x27;</span>, image.getAttribute(<span class="string">&#x27;data-src&#x27;</span>));</span><br><span class="line">        image.addEventListener(<span class="string">&#x27;load&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            image.removeAttribute(<span class="string">&quot;data-src&quot;</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> intersectionObserver = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span>(<span class="params">items, observer</span>) </span>&#123;</span><br><span class="line">        items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(item.isIntersecting) &#123;</span><br><span class="line">                loadImage(item.target);</span><br><span class="line">                observer.unobserve(item.target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    imageToLazy.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">image</span>)</span>&#123;</span><br><span class="line">        intersectionObserver.observe(image);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h4 id="➣-函数防抖和节流实现">➣ 函数防抖和节流实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 去抖 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">fn, time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> timer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;, time);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 节流 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> canRun = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (canRun) &#123;</span><br><span class="line">      canRun = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        canRun = <span class="literal">true</span>;</span><br><span class="line">      &#125;, time)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-浏览器上的线程和进程">➣ 浏览器上的线程和进程</h4><h5 id="1-浏览器包含下面几种进程：">1. 浏览器包含下面几种进程：</h5><ul><li>Browser 进程：浏览器的主进程（负责协调、主控），只有一个。</li><li>第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建。</li><li>GPU 进程：最多一个，用于 3D 绘制等。</li><li>浏览器渲染进程（浏览器内核）（Renderer 进程，内部是多线程的）：默认每个 Tab 页面一个进程，互不影响。</li></ul><h5 id="2-浏览器渲染进程是多线程的，包括以下线程：">2. 浏览器渲染进程是多线程的，包括以下线程：</h5><ul><li><p>GUI 渲染线程<br>负责渲染浏览器界面，解析 HTML，CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。<br>当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行<br>GUI 渲染线程与 JS 引擎线程是互斥的，当 JS 引擎执行时 GUI 线程会被挂起（相当于被冻结了），GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即被执行。</p></li><li><p>JS 引擎线程<br>也称为 JS 内核，负责处理 Javascript 脚本程序。（例如 V8 引擎）<br>JS 引擎线程负责解析 Javascript 脚本，运行代码。<br>JS 引擎一直等待着任务队列中任务的到来，然后加以处理，一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程在运行 JS 程序<br>同样注意，GUI 渲染线程与 JS 引擎线程是互斥的，所以如果 JS 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。</p></li><li><p>事件触发线程<br>归属于浏览器而不是 JS 引擎，用来控制事件循环（可以理解，JS 引擎自己都忙不过来，需要浏览器另开线程协助）<br>当 JS 引擎执行代码块如 setTimeOut 时（也可来自浏览器内核的其他线程, 如鼠标点击、AJAX 异步请求等），会将对应任务添加到事件线程中<br>当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JS 引擎的处理<br>注意，由于 JS 的单线程关系，所以这些待处理队列中的事件都得排队等待 JS 引擎处理（当 JS 引擎空闲时才会去执行）</p></li><li><p>定时触发器线程<br>传说中的 setInterval 与 setTimeout 所在线程<br>浏览器定时计数器并不是由 JavaScript 引擎计数的, （因为 JavaScript 引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确）<br>因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行）<br>注意，W3C 在 HTML 标准中规定，规定要求 setTimeout 中低于 4ms 的时间间隔算为 4ms。</p></li><li><p>异步 http 请求线程<br>在 XMLHttpRequest 在连接后是通过浏览器新开一个线程请求<br>将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。再由 JavaScript 引擎执行。</p></li></ul><p>从输入 URL 到页面渲染完成发生了什么</p><h4 id="➣-Js事件循环-宏任务、微任务">➣ Js事件循环(宏任务、微任务)</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/EventLoop.png"  alt=""></p><p>     每次执行栈执行的代码就是一个宏任务（包括每次从事件队列中获取一个事件回调并放到执行栈中执行）<br>再检测本次循环中是否寻在微任务，存在的话就依次从微任务的任务队列中读取执行完所有的微任务，再读取宏任务的任务队列中的任务执行，再执行所有的微任务，如此循环。JS 的执行顺序就是每次事件循环中的宏任务-微任务。</p><ul><li>第一次事件循环，整段代码作为宏任务进入主线程执行</li><li>同步代码被直接推到执行栈执行，遇到异步代码就挂起交由其他线程执行(执行完会往事件队列塞回调)</li><li>同步代码执行完，读取微任务队列，若有执行所有微任务，微任务清空</li><li>页面渲染</li><li>从事件队列面里取一个宏任务塞入执行栈执行<br>如此反复</li></ul><p><strong>一个参考题目：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  resolve(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">6</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出结果：<code>124536</code>，注意main主进程代码第一次执行时被看做宏任务。</p><h4 id="➣-模拟实现-setTimeout">➣ 模拟实现 setTimeout</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="built_in">setTimeout</span> = <span class="function">(<span class="params">fn, timeout, ...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 初始当前时间</span></span><br><span class="line">  <span class="keyword">const</span> start = +<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">let</span> timer, now;</span><br><span class="line">  <span class="keyword">const</span> loop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    timer = <span class="built_in">window</span>.requestAnimationFrame(loop);</span><br><span class="line">    <span class="comment">// 再次运行时获取当前时间</span></span><br><span class="line">    now = +<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="comment">// 当前运行时间 - 初始当前时间 &gt;= 等待时间 ===&gt;&gt; 跳出</span></span><br><span class="line">    <span class="keyword">if</span> (now - start &gt;= timeout) &#123;</span><br><span class="line">      fn.apply(<span class="built_in">this</span>, args);</span><br><span class="line">      <span class="built_in">window</span>.cancelAnimationFrame(timer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">window</span>.requestAnimationFrame(loop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-从输入URL到页面渲染完成发生了什么">➣ 从输入URL到页面渲染完成发生了什么</h4><ul><li>用户输入url ，通过DNS解析成请求目的IP地址</li><li>浏览器与服务器建立连接（tcp 协议、三次握手），服务端处理请求返回html代码块</li><li>浏览器拿到返回的html，解析 html 成 dom 树、解析 css 成 cssobj</li><li>dom 树、cssobj 结合成 render 树</li><li>JS 根据 render 树进行计算、布局、重绘</li><li>GPU 合成，输出到屏幕</li></ul><h4 id="➣-tcp协议三次握手和四次挥手">➣ tcp协议三次握手和四次挥手</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/tcp.png"  alt=""></p><h5 id="1-三次握手讲解">1. 三次握手讲解</h5><ul><li>客户端发送位码为syn＝1,随机产生seq确认号到服务器，服务器由SYN=1知道客户端要求建立联机（客户端：我要连接你）</li><li>服务器收到请求后要确认联机信息，向A发送ack number=(客户端的seq+1),syn=1,ack=1,随机产生seq=7654321的包（服务器：好的，你来连吧）</li><li>客户端收到后检查ack number是否正确，即第一次发送的seq number+1,以及位码ack是否为1，若正确，客户端会再发送ack number=(服务器的seq+1),ack=1，服务器收到后确认seq值与ack=1则连接建立成功。（客户端：好的，我来了）</li></ul><h4 id="2-为什么http建立连接需要三次握手，不是两次或四次">2. 为什么http建立连接需要三次握手，不是两次或四次?</h4><p>答：三次握手之所以是三次是保证client和server均让对方知道自己的接收和发送能力没问题而保证的最小次数，两次不安全，四次浪费资源。</p><h4 id="3-TCP关闭连接过程">3. TCP关闭连接过程</h4><ul><li>Client向Server发送FIN包，表示Client主动要关闭连接，然后进入FIN_WAIT_1状态，等待Server返回ACK包。此后Client不能再向Server发送数据，但能读取数据。</li><li>Server收到FIN包后向Client发送ACK包，然后进入CLOSE_WAIT状态，此后Server不能再读取数据，但可以继续向Client发送数据。</li><li>Client收到Server返回的ACK包后进入FIN_WAIT_2状态，等待Server发送FIN包。</li><li>Server完成数据的发送后，将FIN包发送给Client，然后进入LAST_ACK状态，等待Client返回ACK包，此后Server既不能读取数据，也不能发送数据。</li><li>Client收到FIN包后向Server发送ACK包，然后进入TIME_WAIT状态，接着等待足够长的时间（2MSL）以确保Server接收到ACK包，最后回到CLOSED状态，释放网络资源。</li><li>Server收到Client返回的ACK包后便回到CLOSED状态，释放网络资源。</li></ul><h4 id="4-为什么要四次挥手？">4. 为什么要四次挥手？</h4><p>     TCP是全双工信道，何为全双工就是客户端与服务端建立两条通道，通道1:客户端的输出连接服务端的输入；通道2:客户端的输入连接服务端的输出。两个通道可以同时工作：客户端向服务端发送信号的同时服务端也可以向客户端发送信号。所以关闭双通道的时候就是这样：</p><ul><li>客户端：我要关闭输入通道了。 服务端：好的，你关闭吧，我这边也关闭这个通道。</li><li>服务端：我也要关闭输入通道了。 客户端：好的你关闭吧，我也把这个通道关闭。</li></ul><h4 id="➣-页面加载会触发哪些事件">➣ 页面加载会触发哪些事件</h4><ol><li>document readystatechange事件<br>readyState 属性描述了文档的加载状态，在整个加载过程中document.readyState会不断变化，每次变化都会触发readystatechange事件。事件使用<code>document.onreadystatechange</code>进行监听。<br>readyState 有以下状态：<br><em>1）loading - document仍在加载。</em><br><em>2）interactive - 文档结构已经完成加载，文档已被解析并且可以交互，但是诸如图像，样式表和脚本之类的外部资源仍在加载</em><br><em>3）complete - 文档和所有外部资源已完成加载。</em></li><li>document DOMContentLoaded事件<br>DOM树渲染完成时触发DOMContentLoaded事件，此时可能外部资源还在加载，事件同于jQuery中的ready事件和<code>readyState == 'interactive'</code>阶段。事件使用<code>document.addEventListener('DOMContentLoaded', function)</code>监听。</li><li>window load事件<br>所有的资源全部加载完成会触发window的load事件。事件使用<code>window.onload=function</code>进行监听。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="built_in">document</span>.readyState) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;loading&quot;</span>:</span><br><span class="line">    <span class="comment">// 表示文档还在加载中，即处于“正在加载”状态。</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;interactive&quot;</span>:</span><br><span class="line">    <span class="comment">// 文档已经结束了“正在加载”状态，DOM元素可以被访问</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;complete&quot;</span>:</span><br><span class="line">    <span class="comment">// 页面所有内容都已被完全加载.</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 模拟 原生DOMContentLoaded 和 jquery ready 事件 */</span></span><br><span class="line"><span class="built_in">document</span>.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">&quot;interactive&quot;</span>) &#123;</span><br><span class="line">    initApplication();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 模拟 window.onload 事件 */</span></span><br><span class="line"><span class="built_in">document</span>.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">&quot;complete&quot;</span>) &#123;</span><br><span class="line">    initApplication();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-document-ready和window-onload的区别">➣ document.ready和window.onload的区别</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ready事件在DOM结构绘制完成之后就会执行，这样能确保就算有大量的媒体文件没加载出来，JS代码一样可以执行。</span><br><span class="line">load事件必须等到网页中所有内容全部加载完毕之后才被执行，如果一个网页中有大量的图片的话，则就会出现这种情况：网页文档已经呈现出来，但由于网页数据还没有完全加载完毕，导致load事件不能够即时被触发。</span><br></pre></td></tr></table></figure><h4 id="➣-闭包Closure">➣ 闭包Closure</h4><ol><li>执行上下文<br>函数每次执行，都会生成一个执行上下文内部对象(可理解为函数作用域)，这个上下文对象会保存函数中所有的变量值和该函数内部定义的函数的引用。函数每次执行时对应的执行上下文都是独一无二的，正常情况下函数执行完毕执行上下文就会被销毁。</li><li>内部作用域的外部引用导致作用域内变量垃圾回收不执行<br>当一个函数内部作用域(注意不是单纯的变量引用)被其外层作用域引用时，函数执行完之后，其执行上下文不会被销毁，我们还能沿着作用域链访问到某个被引用的内部变量。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外层作用域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">counterCreator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 内层作用域1</span></span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 内层作用域2，引用作用域1的变量index</span></span><br><span class="line">    <span class="keyword">return</span> index ++;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外层作用域通过作用域链保存了内层作用域1的变量引用</span></span><br><span class="line"><span class="keyword">var</span> counterA = counterCreator();</span><br><span class="line"><span class="comment">// index变量不会被垃圾回收</span></span><br><span class="line">counterA();     <span class="comment">// 1</span></span><br><span class="line">counterA();     <span class="comment">// 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="➣-函数式编程思想的体现">➣ 函数式编程思想的体现</h4><h4 id="➣-函数柯里化：add-1-2-3-6">➣ 函数柯里化：add(1)(2)(3) == 6</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sumLogic</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">    sum += num;</span><br><span class="line">    <span class="keyword">return</span> sumLogic;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sumLogic.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sumLogic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-函数柯里化2：curry函数">➣ 函数柯里化2：curry函数</h4><ol><li>实现效果：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b + c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> curriedSum = curry(sum);</span><br><span class="line"></span><br><span class="line">alert( curriedSum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) ); <span class="comment">// 6，仍然可以被正常调用</span></span><br><span class="line">alert( curriedSum(<span class="number">1</span>)(<span class="number">2</span>,<span class="number">3</span>) ); <span class="comment">// 6，对第一个参数的柯里化</span></span><br><span class="line">alert( curriedSum(<span class="number">1</span>)(<span class="number">2</span>)(<span class="number">3</span>) ); <span class="comment">// 6，全柯里化</span></span><br></pre></td></tr></table></figure><ol start="2"><li>实现curry函数</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curry</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">core</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> (args.length &gt;= func.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> func.apply(<span class="built_in">this</span>, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> core.apply(<span class="built_in">this</span>, args.concat(<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>)));</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-vue双向绑定实现原理">➣ vue双向绑定实现原理</h4><h4 id="➣-Vue2-0与Vue3-0双向绑定，proxy实现">➣ Vue2.0与Vue3.0双向绑定，proxy实现</h4><h4 id="➣-前端错误监控方法">➣ 前端错误监控方法</h4><h4 id="➣-发布订阅模式和观察者模式区别">➣ 发布订阅模式和观察者模式区别</h4><ul><li>在观察者模式中，观察者是知道Subject的，Subject一直保持对观察者进行记录。然而，在发布订阅模式中，发布者和订阅者不知道对方的存在。它们只有通过消息代理进行通信。</li><li>在发布订阅模式中，组件是松散耦合的，正好和观察者模式相反。</li><li>可以理解为观察者模式没中间商赚差价，发布订阅模式，有中间商赚差价。</li><li>观察者模式大多数时候是同步的，比如当事件触发，Subject就会去调用观察者的方法。而发布-订阅模式大多数时候是异步的（使用消息队列）。</li><li>观察者模式需要在单个应用程序地址空间中实现，而发布-订阅更像交叉应用模式。</li></ul><h4 id="➣-实现一个EventEmitter类，支持事件的on-off-emit-once-setMaxListeners。">➣ 实现一个EventEmitter类，支持事件的on,off,emit,once,setMaxListeners。</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EventEmitter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.maxListeners = <span class="number">100</span>;</span><br><span class="line">  <span class="built_in">this</span>.listeners = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventEmitter.prototype.setMaxListeners = <span class="function"><span class="keyword">function</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> num !== <span class="string">&#x27;number&#x27;</span> || !<span class="built_in">Number</span>.isInteger(num) || num &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;setMaxListeners: param num must be a positive integer!&#x27;</span>);</span><br><span class="line">  <span class="built_in">this</span>.maxListeners = num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventEmitter.prototype.on = <span class="function"><span class="keyword">function</span>(<span class="params">type, func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!type || !func <span class="keyword">instanceof</span> <span class="built_in">Function</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.listeners[type]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.listeners[type].length === <span class="built_in">this</span>.maxListeners) </span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">&#x27;The max listeners limitation: &#x27;</span>, <span class="built_in">this</span>.maxListeners);</span><br><span class="line">    <span class="built_in">this</span>.listeners[type].push(func);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.listeners[type] = [func];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventEmitter.prototype.once = <span class="function"><span class="keyword">function</span>(<span class="params">type, func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!type || !func <span class="keyword">instanceof</span> <span class="built_in">Function</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    func(...args);</span><br><span class="line">    that.off(type, callback);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">this</span>.on(type, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventEmitter.prototype.off = <span class="function"><span class="keyword">function</span>(<span class="params">type, func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!type || !func) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.listeners[type]) &#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="built_in">this</span>.listeners[type].indexOf(func);</span><br><span class="line">    (index !== -<span class="number">1</span>) &amp;&amp; <span class="built_in">this</span>.listeners[type].splice(index, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventEmitter.prototype.emit = <span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">  (<span class="built_in">this</span>.listeners[type] || []).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    fn(...args);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-实现ajax并发请求控制">➣ 实现ajax并发请求控制</h4><p>简化版：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * multiAjaxRequest [批量并发异步请求]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Array]&#125;</span> </span>urls [所有待请求接口地址]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Array]&#125;</span> </span>maxNum [最大并发数量]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">multiAjaxRequest</span>(<span class="params">urls=[], maxNum=<span class="number">0</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> length = urls.length;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="built_in">Array</span>(length).fill(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendRequest</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;send&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> ajax = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    ajax.open(<span class="string">&#x27;POST&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">    ajax.send();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      ajax.onreadystatechange(<span class="function">(<span class="params">ev</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ajax.readyState === <span class="number">4</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ajax.status === <span class="number">200</span>) &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="attr">result</span>: ajax.responseText</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: ajax.status,</span><br><span class="line">              <span class="attr">result</span>: ajax.responseText</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> current = index++;</span><br><span class="line">      <span class="keyword">const</span> url = urls[current];</span><br><span class="line">      <span class="built_in">console</span>.log(current);</span><br><span class="line">      </span><br><span class="line">      sendRequest(url)</span><br><span class="line">      .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        result[current] = res.code === <span class="number">200</span> ? res.result : <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (current &gt;= length - <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (urls.includes(<span class="literal">false</span>)) <span class="keyword">return</span> reject(result);</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span>(index &lt; maxNum) &#123;</span><br><span class="line">      <span class="keyword">if</span> (urls[i]) &#123;</span><br><span class="line">        next();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="➣-如何自己实现一个单点登录系统">➣ 如何自己实现一个单点登录系统</h4><h4 id="➣-使用ES5实现Promise">➣ 使用ES5实现Promise</h4><p><a href="https://github.com/nojsja/promise-nojsja">链接-&gt; 使用ES5实现ES6 Promise API</a></p><h3 id="III-要点：React">III. 要点：React</h3><hr><h4 id="➣-React-中-setState-什么时候是同步的，什么时候是异步的？">➣ React 中 setState 什么时候是同步的，什么时候是异步的？</h4><p>react为了解决跨平台，兼容性和性能问题，自己封装了一套事件机制，代理了原生的事件。</p><ul><li>setState 只在合成事件和钩子函数中是“异步”的，在原生事件和 setTimeout 中都是同步的。</li><li>setState的“异步”并不是说内部由异步代码实现，其实本身执行的过程和代码都是同步的，只是合成事件和钩子函数的调用顺序在更新之前，导致在合成事件和钩子函数中没法立马拿到更新后的值，形式了所谓的“异步”，当然可以通过第二个参数 setState(partialState, callback) 中的callback拿到更新后的结果。</li><li>setState 的批量更新优化也是建立在“异步”（合成事件、钩子函数）之上的，在原生事件和setTimeout 中不会批量更新，在“异步”中如果对同一个值进行多次 setState ， setState 的批量更新策略会对其进行覆盖，取最后一次的执行，如果是同时 setState 多个不同的值，在更新时会对其进行合并批量更新。</li></ul><h4 id="➣-React中父组件如何调用子组件的方法？">➣ React中父组件如何调用子组件的方法？</h4><p>使用createRef()，然后在父组件中使用ref调用子组件实例的方法。</p><h4 id="➣-为什么-React-元素有一个-typeof-属性？">➣ 为什么 React 元素有一个 $$typeof 属性？</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span> &#123;</span><br><span class="line">  <span class="attr">$$typeof</span>: <span class="built_in">Symbol</span>(react.element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目的是为了防止 XSS 攻击。因为 Synbol 无法被序列化，所以 React 可以通过有没有 $$typeof 属性来断出当前的 element 对象是从数据库来的还是自己生成的。</p><p>如果没有 $$typeof 这个属性，react 会拒绝处理该元素。</p><p>在 React 的古老版本中，下面的写法会出现 XSS 攻击：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务端允许用户存储 JSON</span></span><br><span class="line"><span class="keyword">let</span> expectedTextButGotJSON = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">dangerouslySetInnerHTML</span>: &#123;</span><br><span class="line">      <span class="attr">__html</span>: <span class="string">&#x27;/* 把你想的搁着 */&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> message = &#123; <span class="attr">text</span>: expectedTextButGotJSON &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 0.13 中有风险</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">  &#123;message.text&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="➣-hooks-优缺点？">➣ hooks 优缺点？</h4><p><strong>优点：</strong></p><ol><li>代码可读性更强，模板代码更少，原本同一块功能的代码逻辑被拆分在了不同的生命周期函数中，容易使开发者不利于维护和迭代，通过 React Hooks 可以将功能代码聚合，方便阅读维护。</li><li>传统Class组件需要学习ES6原生API，不利于初学者快速上手。</li><li>更加扁平化，传统组件利用 <code>renderProps</code>(传入一个可渲染函数作为props) 和 高阶组件 ( <strong>组件组合包裹</strong> 和 <strong>反向继承</strong>) 的方式实现逻辑复用和职责添加，容易形成&quot;嵌套地狱&quot;。</li><li>不用处理 this 的指向的问题。</li></ol><p><strong>缺点：</strong></p><ol><li>复杂的组件逻辑，hooks的方式代码可读性更差。</li><li>不利于异步操作。</li><li>还无法实现 getSnapshotBeforeUpdate 和 componentDidCatch 这两个在类组件中的生命周期函数。</li><li>容易陷入闭包问题，导致读取到旧值，解决方式使用局部变量 或 useRef</li></ol><h4 id="➣-hooks-为什么不能放在条件判断里？">➣ hooks 为什么不能放在条件判断里？</h4><p>以 setState 为例，在 react 内部，每个组件(Fiber)的 hooks 都是以链表的形式存在 memorizedState 属性中：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/hooks.png"  alt=""></p><p>update 阶段，每次调用 useState，链表就会执行 next 向后移动一步。如果将 useState 写在条件判断中，假设条件判断不成立，没有执行里面的 useState 方法，会导致接下来所有的 useState 的取值出现偏移，从而导致异常发生。</p><h4 id="➣-React-Fiber原理和生命周期使用详解">➣ React-Fiber原理和生命周期使用详解</h4><p><a href="https://nojsja.gitee.io/blogs/2021/01/25/%E7%90%86%E8%A7%A3React%EF%BC%9AFiber%E6%9E%B6%E6%9E%84%E5%92%8C%E6%96%B0%E6%97%A7%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">&gt;&gt; 文章链接</a></p><h4 id="➣-React虚拟dom以及diff算法">➣ React虚拟dom以及diff算法</h4><p>传统 diff 算法的时间复杂度是 O(n^3)，这在前端 render 中是不可接受的。为了降低时间复杂度，react 的 diff 算法做了一些妥协，放弃了最优解，最终将时间复杂度降低到了 O(n)。</p><p>那么 react diff 算法做了哪些妥协呢？，参考如下：</p><p>1、tree diff：只对比同一层的 dom 节点，忽略 dom 节点的跨层级移动</p><p>如下图，react 只会对相同颜色方框内的 DOM 节点进行比较，即同一个父节点下的所有子节点。当发现节点不存在时，则该节点及其子节点会被完全删除掉，不会用于进一步的比较。</p><p>这样只需要对树进行一次遍历，便能完成整个 DOM 树的比较。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/diff1.png"  alt=""></p><p>这就意味着，如果 dom 节点发生了跨层级移动，react 会删除旧的节点，生成新的节点，而不会复用。</p><p>2、component diff：如果不是同一类型的组件，会删除旧的组件，创建新的组件</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/diff2.png"  alt=""></p><p>3、element diff：对于同一层级的一组子节点，需要通过唯一 id 进行来区分</p><p>如果没有 id 来进行区分，一旦有插入动作，会导致插入位置之后的列表全部重新渲染。这也是为什么渲染列表时为什么要使用唯一的 key。</p><h4 id="➣-Babel原理">➣ Babel原理</h4><p>babel的转译过程分为三个阶段：parsing、transforming、generating，以ES6代码转译为ES5代码为例，babel转译的具体过程如下：</p><ul><li>ES6 代码输入</li><li><code>babylon</code> 进行解析得到 AST</li><li>plugin 用 <code>babel-traverse</code> 对 AST 树进行遍历转译，得到新的AST树</li><li>用 <code>babel-generator</code> 通过 AST 树生成 ES5 代码</li></ul><h4 id="➣-React-SetState原理">➣ React SetState原理</h4><ol><li>在 setState 的时候，React 会为当前节点创建一个 updateQueue 的更新列队。</li><li>然后会触发 reconciliation 过程，在这个过程中，会使用名为 Fiber 的调度算法，开始生成新的 Fiber 树， Fiber 算法的最大特点是可以做到异步可中断的执行。</li><li>然后 React Scheduler 会根据优先级高低，先执行优先级高的节点，具体是执行 doWork 方法。</li><li>在 doWork 方法中，React 会执行一遍 updateQueue 中的方法，以获得新的节点。然后对比新旧节点，为老节点打上 更新、插入、替换 等 Tag。</li><li>当前节点 doWork 完成后，会执行 performUnitOfWork 方法获得新节点，然后再重复上面的过程。</li><li>当所有节点都 doWork 完成后，会触发 commitRoot 方法，React 进入 commit 阶段。</li><li>在 commit 阶段中，React 会根据前面为各个节点打的 Tag，一次性更新整个 dom 元素。</li></ol><h4 id="➣-React-Router实现原理">➣ React Router实现原理</h4><h3 id="IV-要点：Node-js">IV. 要点：Node.js</h3><hr><h4 id="➣-Node-js的模块加载机制">➣ Node.js的模块加载机制</h4><p>分为内置模块、外部扩展模块和自定义模块</p><p>大致步骤：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/node-module.jpg"  alt=""></p><ol><li>先计算模块路径</li></ol><p>     将我们的相对路径和使用path方法生成的路径转换成一个绝对路径，无需转换的路径保留原始名字(比如内置模块和npm模块)。</p><ol start="2"><li>如果模块在缓存里面，取出缓存</li></ol><p>     原生模块的缓存和其它模块的缓存区域不同，模块一经加载即会被缓存，下次加载时会直接从缓存中获取。</p><ol start="3"><li>查找模块</li></ol><p>     内置原生模块会直接从node目录的libs目录下搜索；外部扩展模块即通过npm安装的模块，node会先从当前node_modules目录查找，然后是上层各个node_modules目录下查找，直到根目录；自定义模块我们一般会使用相对路径和绝对路径进行查找，如果没有扩展名node会依次按照[‘.js’, ‘.node’, ‘.json’]进行匹配，自定义模块多为开发者根据commonJs规范编写的代码模块。</p><ol start="4"><li>加载模块</li></ol><p>根据查找模块获取到的文件绝对路径定位到文件之后，node同步加载模块然后编译执行，将编译和执行之后的结果缓存到内存中，注意不同于浏览器仅仅缓存文件。</p><ol start="5"><li>输出模块的exports属性即可</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require 其实内部调用 Module._load 方法</span></span><br><span class="line">Module._load = <span class="function"><span class="keyword">function</span>(<span class="params">request, parent, isMain</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//  计算绝对路径</span></span><br><span class="line">  <span class="keyword">var</span> filename = Module._resolveFilename(request, parent);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  第一步：如果有缓存，取出缓存</span></span><br><span class="line">  <span class="keyword">var</span> cachedModule = Module._cache[filename];</span><br><span class="line">  <span class="keyword">if</span> (cachedModule) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第二步：是否为内置模块</span></span><br><span class="line">  <span class="keyword">if</span> (NativeModule.exists(filename)) &#123;</span><br><span class="line">    <span class="keyword">return</span> NativeModule.require(filename);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/********************************这里注意了**************************/</span></span><br><span class="line">  <span class="comment">// 第三步：生成模块实例，存入缓存</span></span><br><span class="line">  <span class="comment">// 这里的Module就是我们上面的1.1定义的Module</span></span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(filename, parent);</span><br><span class="line">  Module._cache[filename] = <span class="built_in">module</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/********************************这里注意了**************************/</span></span><br><span class="line">  <span class="comment">// 第四步：加载模块</span></span><br><span class="line">  <span class="comment">// 下面的module.load实际上是Module原型上有一个方法叫Module.prototype.load</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>.load(filename);</span><br><span class="line">    hadException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hadException) &#123;</span><br><span class="line">      <span class="keyword">delete</span> Module._cache[filename];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第五步：输出模块的exports属性</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="➣-Node-js的优势和劣势">➣ Node.js的优势和劣势</h4><p><strong>优势：</strong> 处理I/O密集的任务，主要在于Node利用事件循环的处理能力，而不是启动一个线程为每一个请求服务，不用处理线程间的切换，资源占用极少。</p><p><strong>劣势：</strong> 处理CPU密集型的任务，由于JS单线程的原因，如果有长时间运行的计算，将会导致CPU时间片得不到释放，使得后续的I/O任务无法发起。因此应该考虑适当调整和分解大型运算任务为多个小任务，使得运算能够适时释放，充分利用CPU，又不阻塞I/O调用的发起。</p><h4 id="➣-Node-js创建子进程方法异同">➣ Node.js创建子进程方法异同</h4><p>child_process 模块提供了衍生子进程的能力。 此功能主要由 child_process.spawn() 函数提供。</p><p>默认情况下， stdin、 stdout 和 stderr 的管道会在父 Node.js 进程和衍生的子进程之间建立。 这些管道具有有限的（且平台特定的）容量。 如果子进程写入 stdout 时超出该限制且没有捕获输出，则子进程会阻塞并等待管道缓冲区接受更多的数据。 这与 shell 中的管道的行为相同。 如果不消费输出，则使用 { stdio: ‘ignore’ } 选项。</p><p>如果 options 对象中有 options.env.PATH 环境变量，则使用它来执行命令查找。 否则，则使用 process.env.PATH。</p><p>在 Windows 上，环境变量不区分大小写。 Node.js 按字典顺序对 env 的键进行排序，并使用不区分大小写的第一个键。 只有第一个（按字典顺序）条目会被传给子流程。 当传给 env 选项的对象具有多个相同键名的变量时（例如 PATH 和 Path），在 Windows 上可能会出现问题。</p><p>child_process.spawn() 方法会异步地衍生子进程，且不阻塞 Node.js 事件循环。 child_process.spawnSync() 函数则以同步的方式提供了等效的功能，但会阻塞事件循环直到衍生的进程退出或被终止。对于某些用例，例如自动化的 shell 脚本，同步的方法可能更方便。 但是在大多数情况下，同步的方法会对性能产生重大的影响，因为会暂停事件循环直到衍生的进程完成。</p><p>为方便起见， child_process 模块提供了 child_process.spawn() 和 child_process.spawnSync() 的一些同步和异步的替代方法。 这些替代方法中的每一个都是基于 child_process.spawn() 或 child_process.spawnSync() 实现的：</p><ul><li><p><code>child_process.exec(command[, options][, callback])</code>: 衍生 shell 并且在 shell 中运行命令，当完成时则将 stdout 和 stderr 传给回调函数。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/exec_options.png"  alt=""></p></li><li><p><code>child_process.execFile(file[, args][, options][, callback])</code>: 类似于 exec()，但是默认情况下它会直接衍生命令而不先衍生shell。exec() 和 execFile() 之间区别的重要性可能因平台而异，在 Unix 类型的操作系统上，execFile() 可以更高效，因为默认情况下不会衍生 shell。但是在 Windows 上， .bat 和 .cmd 文件在没有终端的情况下不能自行执行，因此无法使用 execFile() 启动。当在 Windows 上运行时，要调用 .bat 和 .cmd 文件，可以使用设置了 shell 选项的 child_process.spawn()、child_process.exec() 或衍生 cmd.exe 并将 .bat 或 .cmd 文件作为参数传入（也就是 shell 选项和 child_process.exec() 所做的）</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/execFile_options.png"  alt=""></p></li><li><p><code>child_process.fork(modulePath[, args][, options])</code>: 衍生新的 Node.js 进程，并调用指定的模块，该模块已建立了 IPC 通信通道，可以在父进程与子进程之间发送消息。记住，衍生的 Node.js 子进程独立于父进程，但两者之间建立的 IPC 通信通道除外。 每个进程都有自己的内存，带有自己的 V8 实例。 由于需要额外的资源分配，因此不建议衍生大量的 Node.js 子进程。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/fork_options.png"  alt=""></p></li><li><p><code>child_process.spawn(command[, args][, options])</code>：方法使用给定的 command 衍生新的进程，并传入 args 中的命令行参数，如果省略 args，则其默认为空数组。如果参数 options 选项 shell 为 true，则在 shell 中运行 command，在 Unix 上使用 ‘/bin/sh’，在 Windows 上使用 process.env.ComSpec。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/spawn_options.png"  alt=""></p></li></ul><h4 id="➣-Node-js创建子进程参数stdio的理解">➣ Node.js创建子进程参数<code>stdio</code>的理解</h4><p>options.stdio 选项用于配置在父进程和子进程之间建立的管道。 默认情况下，子进程的 stdin、 stdout 和 stderr 会被重定向到 ChildProcess 对象上相应的 subprocess.stdin、subprocess.stdout 和 subprocess.stderr 流。 这相当于将 options.stdio 设置为 [‘pipe’, ‘pipe’, ‘pipe’]。</p><p>为方便起见， options.stdio 可以是以下字符串之一：</p><ul><li>‘pipe’：相当于 [‘pipe’, ‘pipe’, ‘pipe’]（默认值）。</li><li>‘ignore’：相当于 [‘ignore’, ‘ignore’, ‘ignore’]。</li><li>‘inherit’：相当于 [‘inherit’, ‘inherit’, ‘inherit’] 或 [0, 1, 2] 或 [process.stdin, process.stdout, process.stderr]。</li></ul><p>否则， options.stdio 的值需是数组（其中每个索引对应于子进程中的文件描述符）。 文件描述符 0、1 和 2 分别对应于 stdin、stdout 和 stderr。 其他的文件描述符可以被指定用于在父进程和子进程之间创建其他的管道。 值可以是以下之一：</p><ol><li><p><strong>‘pipe’</strong>：在子进程和父进程之间创建管道。 管道的父端作为 child_process 对象上的 subprocess.stdio[fd] 属性暴露给父进程。 为文件描述符 0、1 和 2 创建的管道也可分别作为 subprocess.stdin、subprocess.stdout 和 subprocess.stderr 使用。</p></li><li><p><strong>‘ipc’</strong>：创建 IPC 通道，用于在父进程和子进程之间传递消息或文件描述符。 一个 ChildProcess 最多可以有一个 IPC stdio 文件描述符。 设置此选项会启用 subprocess.send() 方法。 如果子进程是 Node.js 进程，则 IPC 通道的存在将会启用 process.send() 和 process.disconnect() 方法、以及子进程内的 ‘disconnect’ 和 ‘message’ 事件。以 process.send() 以外的任何方式访问 IPC 通道的文件描述符、或者在不是 Node.js 实例的子进程中使用 IPC 通道，都是不支持的。</p></li><li><p><strong>‘ignore’</strong>：指示 Node.js 忽略子进程中的文件描述符。 虽然 Node.js 将会始终为其衍生的进程打开文件描述符 0、1 和 2，但将文件描述符设置为 ‘ignore’ 可以使 Node.js 打开 /dev/null 并将其附加到子进程的文件描述符。</p></li><li><p><strong>‘inherit’</strong>：将相应的 stdio 流传给父进程或从父进程传入。 在前三个位置中，这分别相当于 process.stdin、 process.stdout 和 process.stderr。 在任何其他位置中，则相当于 ‘ignore’。</p></li><li><p><strong><code>&lt;Stream&gt;</code></strong> 对象：与子进程共享指向 tty、文件、 socket 或管道的可读或可写流。 流的底层文件描述符在子进程中会被复制到与 stdio 数组中的索引对应的文件描述符。 该流必须具有底层的描述符（文件流直到触发 ‘open’ 事件才有）。</p></li><li><p><strong>正整数</strong>：整数值会被解释为当前在父进程中打开的文件描述符。 它与子进程共享，类似于共享 <code>&lt;Stream&gt;</code>对象的方式。 在 Windows 上不支持传入 socket。</p></li><li><p><strong>null 或 undefined</strong>：使用默认值。 对于 stdio 的文件描述符 0、1 和 2（换句话说，stdin、stdout 和 stderr），将会创建管道。 对于文件描述符 3 及更大的值，则默认为 ‘ignore’。</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子进程使用父进程的 stdio。</span></span><br><span class="line">spawn(<span class="string">&#x27;prg&#x27;</span>, [], &#123; <span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 衍生的子进程只共享 stderr。</span></span><br><span class="line">spawn(<span class="string">&#x27;prg&#x27;</span>, [], &#123; <span class="attr">stdio</span>: [<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;pipe&#x27;</span>, process.stderr] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开一个额外的 fd=4，与呈现启动式界面的程序进行交互。</span></span><br><span class="line">spawn(<span class="string">&#x27;prg&#x27;</span>, [], &#123; <span class="attr">stdio</span>: [<span class="string">&#x27;pipe&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&#x27;pipe&#x27;</span>] &#125;);</span><br></pre></td></tr></table></figure><p>当在父进程和子进程之间建立 IPC 通道，并且子进程是 Node.js 进程时，则子进程启动时不会指向 IPC 通道（使用 unref()），直到子进程为 ‘disconnect’ 事件或 ‘message’ 事件注册了事件句柄。 这使得子进程可以正常退出而不需要通过开放的 IPC 通道保持打开该进程。</p><p>在类 Unix 操作系统上，child_process.spawn() 方法在将事件循环与子进程解耦之前会同步地执行内存操作。 具有大内存占用的应用程序可能会发现频繁的 child_process.spawn() 调用成为瓶颈。 详见 V8 问题 7381。</p><h4 id="➣-Nodejs使用场景">➣ Nodejs使用场景</h4><p>Nodejs 是单线程，非阻塞 I/O，事件驱动，不适用于CPU密集运算的任务。它的特点决定了它适合做一些大量 I/O 的东西，比如，聊天室，表单提交等不需要大量计算的功能。做一些微信后端开发，或者做消息系统等。可以整个项目用， 也可以根据它的特点在某个模块使用，比如 socketio，打造一个消息系统等。</p><h4 id="➣-Nodejs-中的-Stream-和-Buffer-有什么区别">➣ Nodejs 中的 Stream 和 Buffer 有什么区别?</h4><p>Buffer：为数据缓冲对象，是一个类似数组结构的对象，可以通过指定开始写入的位置及写入的数据长度，往其中写入二进制数据。Stream：是对 buffer 对象的高级封装，其操作的底层还是 buffer 对象， stream 可以设置为可读、可写，或者即可读也可写，在 nodejs 中继承了 EventEmitter 接口，可以监听读入、写入的过程。具体实现有文件流，httpresponse 等。</p><h4 id="➣-Node-js流的概念">➣ Node.js流的概念</h4><p>流（stream）是 Node.js 中处理流式数据的抽象接口。 Node.js 提供了多种流对象。 例如，HTTP 服务器的请求和 process.stdout 都是流的实例。流可以是可读的、可写的、或者可读可写的，所有的流都是 EventEmitter 的实例。</p><h5 id="流的类型">流的类型</h5><p>Node.js 中有四种基本的流类型：</p><ul><li>Writable - 可写入数据的流（例如 fs.createWriteStream()）。</li><li>Readable - 可读取数据的流（例如 fs.createReadStream()）。</li><li>Duplex - 可读又可写的流（例如 net.Socket）。</li><li>Transform - 在读写过程中可以修改或转换数据的 Duplex 流（例如 zlib.createDeflate()）。</li></ul><h5 id="流的缓冲区">流的缓冲区</h5><p>可写流和可读流都会在内部的缓冲器中存储数据，可以分别使用的 writable.writableBuffer 或 readable.readableBuffer 来获取。</p><p>可缓冲的数据大小取决于传入流构造函数的 highWaterMark 选项。 对于普通的流， highWaterMark 指定了字节的总数。 对于对象模式的流， highWaterMark 指定了对象的总数。</p><p>当调用 stream.push(chunk) 时，数据会被缓冲在可读流中。 如果流的消费者没有调用 stream.read()，则数据会保留在内部队列中直到被消费。</p><p>一旦内部的可读缓冲的总大小达到 highWaterMark 指定的阈值时，流会暂时停止从底层资源读取数据，直到当前缓冲的数据被消费 （也就是说，流会停止调用内部的用于填充可读缓冲的 readable._read()）。</p><p>当调用 writable.write(chunk) 时，数据会被缓冲在可写流中。 当内部的可写缓冲的总大小小于 highWaterMark 设置的阈值时，调用 writable.write() 会返回 true。 一旦内部缓冲的大小达到或超过 highWaterMark 时，则会返回 false。</p><p>stream API 的主要目标，特别是 stream.pipe()，是为了限制数据的缓冲到可接受的程度，也就是读写速度不一致的源头与目的地不会压垮内存。</p><p>因为 Duplex 和 Transform 都是可读又可写的，所以它们各自维护着两个相互独立的内部缓冲器用于读取和写入， 这使得它们在维护数据流时，读取和写入两边可以各自独立地运作。 例如，net.Socket 实例是 Duplex 流，它的可读端可以消费从 socket 接收的数据，而可写端则可以将数据写入到 socket。 因为数据写入到 socket 的速度可能比接收数据的速度快或者慢，所以读写两端应该独立地进行操作（或缓冲）。</p><h5 id="可写流">可写流</h5><p>可写流是对数据要被写入的目的地的一种抽象。</p><p>常见的可写流包括：</p><ul><li>客户端的 HTTP 请求</li><li>服务器的 HTTP 响应</li><li>fs 的写入流</li><li>zlib 流</li><li>crypto 流</li><li>TCP socket</li><li>子进程 stdin</li><li>process.stdout、process.stderr</li></ul><p>使用示例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myStream = getWritableStreamSomehow();</span><br><span class="line">myStream.write(<span class="string">&#x27;一些数据&#x27;</span>);</span><br><span class="line">myStream.write(<span class="string">&#x27;更多数据&#x27;</span>);</span><br><span class="line">myStream.end(<span class="string">&#x27;完成写入数据&#x27;</span>);</span><br></pre></td></tr></table></figure><p>常见事件：</p><ul><li>close: 当流或其底层资源（比如文件描述符）被关闭时触发。 表明不会再触发其他事件，也不会再发生操作。</li><li>drain: 如果调用 stream.write(chunk) 返回 false，则当可以继续写入数据到流时会触发 ‘drain’ 事件。</li><li>error: 如果在写入或管道数据时发生错误，则会触发 ‘error’ 事件，在 ‘error’ 之后，除 ‘close’ 事件外，不应再触发其他事件。</li><li>调用 stream.end() 且缓冲数据都已传给底层系统之后触发。</li><li>pipe: 可写流被<code>stream.pipe()</code>连接</li></ul><p>常见方法：</p><ul><li>writable.end([chunk[, encoding]][, callback]): 调用 writable.end() 表明已没有数据要被写入可写流。 可选的 chunk 和 encoding 参数可以在关闭流之前再写入一块数据。 如果传入了 callback 函数，则会做为监听器添加到 ‘finish’ 事件和 ‘error’ 事件。</li><li>writable.write(chunk[, encoding][, callback]): writable.write() 写入数据到流，并在数据被完全处理之后调用 callback。 如果发生错误，则 callback 可能被调用也可能不被调用。 为了可靠地检测错误，可以为 ‘error’ 事件添加监听器。 callback 会在触发 ‘error’ 之前被异步地调用。在接收了 chunk 后，如果内部的缓冲小于创建流时配置的 highWaterMark，则返回 true 。 如果返回 false ，则应该停止向流写入数据，直到 ‘drain’ 事件被触发。</li></ul><h5 id="可读流">可读流</h5><p>可读流运作于两种模式之一：流动模式（flowing）或暂停模式（paused）。 这些模式与对象模式分开。 无论是否处于流动模式或暂停模式，可读流都可以处于对象模式：</p><ul><li>在流动模式中，数据自动从底层系统读取，并通过 EventEmitter 接口的事件尽可能快地被提供给应用程序。</li><li>在暂停模式中，必须显式调用 stream.read() 读取数据块。</li></ul><p>所有可读流都开始于暂停模式，可以通过以下方式切换到流动模式：</p><ul><li>添加 ‘data’ 事件句柄。</li><li>调用 stream.resume() 方法。</li><li>调用 stream.pipe() 方法将数据发送到可写流。</li></ul><p>可读流可以通过以下方式切换回暂停模式：</p><ul><li>如果没有管道目标，则调用 stream.pause()。</li><li>如果有管道目标，则移除所有管道目标。调用 stream.unpipe() 可以移除多个管道目标。</li></ul><p>只有提供了消费或忽略数据的机制后，可读流才会产生数据。 如果消费的机制被禁用或移除，则可读流会停止产生数据。</p><p>为了向后兼容，移除 ‘data’ 事件句柄不会自动地暂停流。 如果有管道目标，一旦目标变为 drain 状态并请求接收数据时，则调用 stream.pause() 也不能保证流会保持暂停模式。</p><p>如果可读流切换到流动模式，且没有可用的消费者来处理数据，则数据将会丢失。 例如，当调用 readable.resume() 时，没有监听 ‘data’ 事件或 ‘data’ 事件句柄已移除。</p><p>添加 ‘readable’ 事件句柄会使流自动停止流动，并通过 readable.read() 消费数据。 如果 ‘readable’ 事件句柄被移除，且存在 ‘data’ 事件句柄，则流会再次开始流动。</p><p>常见事件：</p><ul><li>close: 当流或其底层资源（比如文件描述符）被关闭时触发 ‘close’ 事件。 该事件表明不会再触发其他事件，也不会再发生操作。</li><li>data: 当流将数据块传送给消费者后触发。 当调用 readable.pipe()， readable.resume() 或绑定监听器到 ‘data’ 事件时，流会转换到流动模式。 当调用 readable.read() 且有数据块返回时，也会触发 ‘data’ 事件。</li><li>end: ‘end’ 事件只有在数据被完全消费掉后才会触发。 要想触发该事件，可以将流转换到流动模式，或反复调用 stream.read() 直到数据被消费完。</li><li>error: ‘error’ 事件可能随时由 Readable 实现触发。 通常，如果底层的流由于底层内部的故障而无法生成数据，或者流的实现尝试推送无效的数据块，则可能会发生这种情况。</li><li>pause: 当调用 stream.pause() 并且 readsFlowing 不为 false 时，就会触发 ‘pause’ 事件。</li><li>readable: 当有数据可从流中读取时，就会触发 ‘readable’ 事件。 在某些情况下，为 ‘readable’ 事件附加监听器将会导致将一些数据读入内部缓冲区。</li><li>resume: 当调用 stream.resume() 并且 readsFlowing 不为 true 时，将会触发 ‘resume’ 事件。</li></ul><p>常见方法:</p><ul><li>readable.pause:  方法使流动模式的流停止触发 ‘data’ 事件，并切换出流动模式。 任何可用的数据都会保留在内部缓存中。</li><li>readable.resume:  方法将被暂停的可读流恢复触发 ‘data’ 事件，并将流切换到流动模式。</li><li>readable.read([size]): 从内部缓冲拉取并返回数据。 如果没有可读的数据，则返回 null。 默认情况下， readable.read() 返回的数据是 Buffer 对象，除非使用 readable.setEncoding() 指定字符编码或流处于对象模式。如果没有指定 size 参数，则返回内部缓冲中的所有数据。</li><li>readable.setEncoding(encoding): 方法为从可读流读取的数据设置字符编码。默认情况下没有设置字符编码，流数据返回的是 Buffer 对象。 如果设置了字符编码，则流数据返回指定编码的字符串。 例如，调用 readable.setEncoding(‘utf-8’) 会将数据解析为 UTF-8 数据，并返回字符串。</li></ul><h5 id="可读可写双向流">可读可写双向流</h5><p>双工流（Duplex）是同时实现了 Readable 和 Writable 接口的流。</p><p>Duplex 流的例子包括：</p><ul><li>TCP socket</li><li>zlib 流</li><li>crypto 流</li></ul><h5 id="转换流">转换流</h5><p>转换流（Transform）是一种 Duplex 流，但它的输出与输入是相关联的。 与 Duplex 流一样， Transform 流也同时实现了 Readable 和 Writable 接口。</p><p>Transform 流的例子包括：</p><ul><li>zlib 流</li><li>crypto 流</li></ul><h4 id="➣-Node-js和Webpack对模块循环依赖的处理">➣ Node.js和Webpack对模块循环依赖的处理</h4><p>举例，A和B相互依赖，我们运行A.js：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A.js:</span></span><br><span class="line"><span class="keyword">let</span> b = <span class="built_in">require</span>(<span class="string">&#x27;./B&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="attr">A</span>: <span class="string">&#x27;this is a Object&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;A: before log b&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;A: after log b&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// B.js:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./A&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="attr">B</span>: <span class="string">&#x27;this is b Object&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;B: before log a&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;B: after log a&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Node-js的处理">Node.js的处理</h5><ol><li>工作方式</li></ol><p>     Node.js具有两个特性：运行时加载和缓存已加载模块。为了避免无限循环的模块依赖，在 Node.js 运行 A.js 之后，它就被缓存了，但需要注意的是，此时缓存的仅仅是一个未完工的 A.js（an unfinished copy of the a.js）。所以在 B.js require A.js 时，得到的仅仅是缓存中一个未完工的 A.js，具体来说，它并没有明确被导出的具体内容（A.js 尾端）。所以 B.js 中输出的 a 是一个空对象。之后，B.js 顺利执行完，回到 A.js 的 require 语句之后，继续执行完成。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="built_in">module</span>.exports.a = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="built_in">require</span>(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b)</span><br><span class="line"><span class="built_in">module</span>.exports.a = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="built_in">module</span>.exports.b = <span class="number">11</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br><span class="line"><span class="built_in">module</span>.exports.b = <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br></pre></td></tr></table></figure><p>执行过程：</p><ul><li>执行 node main.js -&gt; 第一行 require(a.js)，（node 执行也可以理解为调用了require方法，我们省略require(main.js)内容）</li><li>进入 require(a)方法： 判断缓存（无） -&gt; 初始化一个 module -&gt; 将 module 加入缓存 -&gt; 执行模块 a.js 内容，（需要注意 是先加入缓存， 后执行模块内容）</li><li>a.js： 第一行导出 a = 1 -&gt; 第二行 require(b.js)（a 只执行了第一行）</li><li>进入 require(b) 内 同 1 -&gt; 执行模块 b.js 内容</li><li>b.js： 第一行 b = 11 -&gt; 第二行 require(a.js)</li><li>require(a) 此时 a.js 是第二次调用 require -&gt; 判断缓存（有）-&gt; cachedModule.exports -&gt; 回到 b.js（因为js对象引用问题 此时的 cachedModule.exports = { a: 1 }）</li><li>b.js：第三行 输出 { a: 1 } -&gt; 第四行 修改 b = 22 -&gt; 执行完毕回到 a.js</li><li>a.js：第二行 require 完毕 获取到 b -&gt; 第三行 输出 { b: 22 } -&gt; 第四行 导出 a = 2 -&gt; 执行完毕回到 main.js</li><li>main.js：获取 a -&gt; 第二行 输出 { a: 2 } -&gt; 执行完毕</li></ul><ol start="2"><li>解决方案</li></ol><p>     想要解决这个问题有一个很简明的方法，那就是在循环依赖的每个模块中先导出自身，然后再导入其他模块（对于本文的举例来说，实际只需改动 A.js，先使用module.exports导出，然后再require B.js）。</p><h5 id="Webpack的处理">Webpack的处理</h5><ol><li>工作方式</li></ol><p>     ES Modules 模块输出的是值的引用，输出接口动态绑定，在编译时执行。</p><p>     webpack的头部启动代码中，通过闭包中的installedModules对象，将模块名或者id作为对象的key来缓存各个模块的export的值，通过判断installedModules上是否缓存了对应模块的key来判断是否已经加载了模块。</p><ol start="2"><li>解决方案</li></ol><ul><li>1）webpack尚未解决循环依赖问题，可以使用 circular-dependency-plugin 插件进行循依赖检测，减少debug时间。</li><li>2）打破文件间的依赖关系的闭环</li><li>3）依赖关系闭环的情况下，将变量改为function导出，利用function的变量提升机制</li></ul><h4 id="➣-Webpack怎么处理require和import语法混用的">➣ Webpack怎么处理require和import语法混用的</h4><p>对于es6规范和commonJs规范来说，经过babel编译以后，都会转化成commonJs规范，然后在此基础上，用__esModule区分了是属于es6模块还是commonJs模块。并切为了保证es6规范用import导入值的正确性和统一性，babel还做了一些策略去处理这两者之前的差异。</p><h4 id="➣-前端模块化历程">➣ 前端模块化历程</h4><p>模块化主要是用来抽离公共代码，隔离作用域，避免变量冲突等。</p><h5 id="1-IIFE-立即执行函数">1. IIFE - 立即执行函数</h5><p>使用自执行函数来编写模块化，特点：在一个单独的函数作用域中执行代码，避免变量冲突。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">data</span>:[]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-AMD-requireJs">2. AMD - requireJs</h5><p>模块依赖需要提前声明好，不支持动态设置依赖</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">&#x27;./index.js&#x27;</span>,<span class="function"><span class="keyword">function</span>(<span class="params">code</span>)</span>&#123;</span><br><span class="line"><span class="comment">// code 就是index.js 返回的内容</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="3-CMD-seaJs">3. CMD - seaJs</h5><p>支持动态依赖设置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">require</span>, <span class="built_in">exports</span>, <span class="built_in">module</span></span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">var</span> indexCode = <span class="built_in">require</span>(<span class="string">&#x27;./index.js&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="4-commonJs-Node-js模块规范">4. commonJs - Node.js模块规范</h5><p>     属于动态导入规范，可以在条件语句中导入其它模块，特点: require、module.exports、exports。commonJs 一般用在服务端或者Node用来同步加载模块，它对于模块的依赖发生在代码运行阶段，不适合在浏览器端做异步加载。exports实际上是一个对module.exports的引用，不能给exports赋值，否则会断开与module.exports的连接：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params"></span>) </span>&#123;<span class="comment">/* 方法 */</span>&#125;</span><br><span class="line">  <span class="comment">// 等同于</span></span><br><span class="line"><span class="built_in">module</span>.exports.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params"></span>) </span>&#123;<span class="comment">/* 方法 */</span>&#125;</span><br></pre></td></tr></table></figure><h5 id="5-ES-Module-浏览器模块系统">5. ES Module - 浏览器模块系统</h5><p>     属于静态导入规范，import、export ES6模块化不是对象，import会在JavaScript引擎静态分析，在编译时就引入模块代码，而并非在代码运行时加载，因此也不适合异步加载。</p><p>静态的语法意味着可以在编译时确定导入和导出，更加快速的查找依赖，可以使用lint工具对模块依赖进行检查，可以对导入导出加上类型信息进行静态的类型检查</p><p><strong>ESModule的优势：</strong></p><ul><li>死代码检测和排除。我们可以用静态分析工具检测出哪些模块没有被调用过。比如，在引入工具类库时，工程中往往只用到了其中一部分组件或接口，但有可能会将其代码完整地加载进来。未被调用到的模块代码永远不会被执行，也就成为了死代码。通过静态分析可以在打包时去掉这些未曾使用过的模块，以减小打包资源体积。</li><li>模块变量类型检查。JavaScript属于动态类型语言，不会在代码执行前检查类型错误（比如对一个字符串类型的值进行函数调用）。ES6 Module的静态模块结构有助于确保模块之间传递的值或接口类型是正确的。</li><li>编译器优化。在commonJs等动态模块系统中，无论采用哪种方式，本质上导入的都是一个对象，而ES6 Module支持直接导入变量，减少了引用层级，程序效率更高。</li></ul><p><strong>ESModule导出的值是引用的例子：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// es6 module 中基本类型也按引用传递</span></span><br><span class="line"><span class="comment">// foo.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  a++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; a, count &#125; <span class="keyword">from</span> <span class="string">&#x27;./foo&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(a) <span class="comment">//1</span></span><br><span class="line">count()</span><br><span class="line"><span class="built_in">console</span>.log(a) <span class="comment">//2</span></span><br></pre></td></tr></table></figure><p><strong>ESModule和commonJs差异：</strong></p><ul><li>commonJs模块导入后是一个值的拷贝，一旦输出之后，无论模块内部怎么变化，都无法影响之前的引用；而ESModule导入后是一个引用值的动态映射，并且这个映射是只读的。</li><li>ESModule 是引擎会在遇到import后生成一个引用链接，在脚本真正执行时才会根据这个引用链接去模块里面取值，模块内部的原始值变了import加载的模块也会变。</li><li>commonJs运行时加载，ESModule编译阶段引用。commonJs在引入时是加载整个模块，生成一个对象，然后再从这个生成的对象上读取方法和属性。</li><li>ESModule 不是对象，而是通过export暴露出要输出的代码块，在import时使用静态命令的方法引用指定的输出代码块，并在import语句处执行这个要输出的代码，而不是直接加载整个模块。</li></ul><h4 id="➣-谈谈node子进程child-process和实际使用场景">➣ 谈谈node子进程child_process和实际使用场景</h4><h4 id="➣-node是IO密集型体现在哪里">➣ node是IO密集型体现在哪里</h4><h3 id="V-要点：设计模式">V. 要点：设计模式</h3><hr><ol><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#1-the-strategy-pattern%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">策略模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#2-the-observer-pattern%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">观察者模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#3-the-flyweight-pattern%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F">享元模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#4-the-decorator-pattern%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F">装饰者模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#5-the-proxy-pattern%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F">代理模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#6-the-state-pattern%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F">状态模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#7-the-responsibility-chain-pattern%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">责任链模式</a></p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/design-patterns#7-the-responsibility-chain-pattern%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">模板方法模式</a></p></li></ol><h3 id="VI-要点：前端工具">VI. 要点：前端工具</h3><hr><h4 id="➣-webpack-rollup一些区别">➣ webpack/rollup一些区别</h4><ul><li>webpack 不支持导出 es6 module 规范，rollup 支持导出 es6 module</li><li>webpack 打包后代码很多冗余无法直接看，rollup 打包后的代码简洁，可读，像源码</li><li>webpack 可以进行代码分割，静态资源处理，HRM，rollup 专注于 es module，tree-shaking更加强大的，精简</li></ul><h4 id="➣-ts自己的看法，和应用">➣ ts自己的看法，和应用</h4><h4 id="➣-webpack-loader和plugin区别">➣ webpack loader和plugin区别</h4><ol><li>loader，它是一个转换器，将A文件进行编译成B文件，比如：将A.less转换为A.css，单纯的文件转换过程。</li><li>plugin是一个扩展器，它丰富了webpack本身，针对是loader结束后，webpack打包的整个过程，它并不直接操作文件，而是基于事件机制工作，会监听webpack打包过程中的某些节点，执行广泛的任务</li></ol><h3 id="VII-要点：前端工程化方面">VII. 要点：前端工程化方面</h3><h4 id="➣-前端组件设计原则">➣ 前端组件设计原则</h4><h4 id="➣-前端兼容">➣ 前端兼容</h4><h5 id="1-多屏幕自适应">1. 多屏幕自适应</h5><p>&gt; 背景：</p><p>在不同的屏幕分辨率，浏览器页面展示差异很大。特别是屏幕分辨率较小时，容易发生布局错乱。为了解决这个问题，响应式UI框架应运而生。</p><p>&gt; 关于浏览器视口：<br><a href="https://segmentfault.com/a/1190000016595303#">浏览器视口</a></p><p>&gt; 移动设备优先和非移动设备移动优先：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 大于等于某个像素-优先兼容移动端，选择兼容更大的屏幕 */</span></span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span> : <span class="number">768px</span>) &#123;...&#125;</span><br><span class="line"><span class="comment">/* 小于等于某个像素-优先兼容桌面端，选择兼容更小的屏幕 */</span></span><br><span class="line"><span class="keyword">@media</span> <span class="keyword">only</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span> : <span class="number">768px</span>) &#123;...&#125;</span><br></pre></td></tr></table></figure><p>&gt; 主流分辨率：</p><ul><li><p>主流桌面屏幕分辨率宽度集中在1280~1920，高度集中在720~1080；</p></li><li><p>主流平板屏幕分辨率宽度集中在962~1280，高度集中在601~800。</p></li><li><p>主流移动屏幕分辨率宽度集中在360~414，高度集中在640~896。</p></li></ul><p>&gt; 典型分辨率：</p><ul><li><p>典型的桌面屏幕分辨率：1920x1080</p></li><li><p>典型的便携屏幕分辨率：1366x768</p></li><li><p>典型的平板屏幕分辨率：768x1024</p></li><li><p>典型的移动屏幕分辨率：360x640</p></li></ul><p>&gt; Bootstrap定义（参考系是逻辑分辨率）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;=1400px ----- xxl 超超大屏设备 桌面屏幕</span><br><span class="line"></span><br><span class="line">&gt;=1200px ----- xl 超大屏设备 便携屏幕</span><br><span class="line"></span><br><span class="line">&gt;=992px ----- lg 大屏设备 竖屏桌面屏幕、横屏平板屏幕</span><br><span class="line"></span><br><span class="line">&gt;=768px ----- md 中屏设备 竖屏平板屏幕</span><br><span class="line"></span><br><span class="line">&gt;=576px ----- sm 小屏设备 横屏移动屏幕</span><br><span class="line"></span><br><span class="line">&lt;576px ----- xs 超小屏设备 竖屏移动屏幕</span><br></pre></td></tr></table></figure><blockquote><p>注：Bootstrap5新增xxl，Bootstrap3中的lg&gt;=1200px，无576px档。</p></blockquote><p>&gt; 设备像素比：</p><p>     手机屏幕尺寸过小，使用原始分辨率会使得页面显示过小，因此使用了逻辑分辨率，用倍数放大的方法来保证兼容性。比如iOS app的UI资源区分@1x、@2x和@3x，这就是指原始分辨率对逻辑分辨率的倍数，被称为设备像素比DPR。所以大部分人的手机分辨率都是1080x1920，在分类中却被归为了360x640。这个分辨率和CSS中的PX是一致的。</p><p>&gt; 一些较新的自适应API：</p><h5 id="2-兼容策略">2. 兼容策略</h5><p>&gt; 浏览器兼容策略：</p><p>国内XP用户还有3.29%，XP用户既升级不了IE9，也无法安装新版本Chrome和Firefox 。而IE用户还有 5.65%，考虑到Windows用户为87%，所以IE9+的份额应该要少于5.65%-3.29%*87%=2.79%。也就是说IE8以下的用户要多于IE8以上的用户。所以支持单独支持IE9+ 浏览器没有实际意义，要么支持IE6，要么不支持IE，。</p><p>&gt; 兼容IE的建议：</p><ul><li><p>建议不做任何兼容，IE6~11直接显示升级浏览器按钮。</p></li><li><p>如果一定要兼容，后端返回IE专用页面，至少兼容IE8。</p></li></ul><p>&gt; 屏幕分辨率兼容策略：</p><p>     屏幕分辨率最少要考虑兼容便携屏幕和移动屏幕两种。可以参考去哪儿网的做法，把内容分成三类：移动端主菜单与导航栏；主要内容；扩展内容。屏幕分辨率高于480，显示主要内容、扩展内容。屏幕分辨率低于480，显示移动端主菜单与导航栏、主要内容。</p><p>     如果你的应用是管理软件，则最好考虑兼容桌面屏幕、便携屏幕和移动屏幕三种。Bootstrap5新增了超超大屏幕，则就是基于这种考虑。这时候，可以加入侧边栏自动隐藏/打开，主要内容用Flex方式组织，可以在页面中并排显示多页（类似于Word的页面视图）。</p><p>&gt; 跨平台兼容策略：</p><p>     大型网站，手机网站与桌面网站是不同的入口，因此不存在兼容，是两个单独的应用程序。对于流量较小的网站，平台的兼容策略主要是应用响应式框架，加上移动端主菜单与导航栏即可，其次可以选用跨平台框架来实现在不同平台的差异化体验。没有这些框架对于Web网站来说不造成大的体验下降。而如果需要开发混合移动、桌面应用，则需要认真考虑这些框架，毕竟用户对本地应用的体验期待要高很多。</p><h5 id="3-常见浏览器兼容处理方法">3. 常见浏览器兼容处理方法</h5><p>&gt; 一些常用的浏览器兼容框架：</p><p>在前端发展的初期，大多数开发最关注的问题就是浏览器兼容问题，迫切需要兼容所有浏览器的JS和CSS框架。这阶段除了横空出世的jQuery，还有一些其它方面的兼容框架。</p><ul><li><p>normalize.css：让不同的浏览器在渲染网页元素的时候形式更统一。</p></li><li><p>html5shiv.js：IE6~IE8识别HTML5标签，并且可以添加CSS样式。</p></li><li><p>respond.js：使IE6~IE8浏览器支持媒体查询。</p></li></ul><p>&gt;  常见的兼容写法：</p><ul><li>XHR请求创建的兼容写法(惰性载入)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createXHR</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(<span class="keyword">typeof</span> XMLHttpRequest != <span class="string">&quot;undefined&quot;</span>)&#123;<span class="comment">//XMLHttpRequest</span></span><br><span class="line">       createXHR = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> ActiveXObject!=<span class="string">&quot;undefined&quot;</span>)&#123;<span class="comment">//IE ActiveXObject</span></span><br><span class="line">       createXHR = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">arguments</span>.callee.activeXString!=<span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line">               <span class="keyword">var</span> versions=[<span class="string">&quot;MSXML2.XMLHttp.6.0&quot;</span>, <span class="string">&quot;MSXML2.XMLHttp.3.0&quot;</span>, <span class="string">&quot;MSXML2.XMLHttp&quot;</span>],<span class="comment">//IE</span></span><br><span class="line">                   i,len;</span><br><span class="line">                <span class="keyword">for</span>(i=<span class="number">0</span>,len=versions.length;i&lt;len;i++)&#123;</span><br><span class="line">                   <span class="keyword">try</span>&#123;</span><br><span class="line">                       <span class="keyword">new</span> ActiveXObject(versions[i]);</span><br><span class="line">                       <span class="built_in">arguments</span>.callee.activeXString=version[i];</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;<span class="keyword">catch</span>(ex)&#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="built_in">arguments</span>.callee.activeXString);</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       createXHR = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> createXHR();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>事件监听器的兼容写法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> eventUtil=&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">addEventHandler</span>: <span class="function"><span class="keyword">function</span> (<span class="params">obj, eventName, handler</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">document</span>.attachEvent) &#123;<span class="comment">//IE</span></span><br><span class="line">          obj.attachEvent(<span class="string">&quot;on&quot;</span> + eventName, handler);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.addEventListener) &#123;<span class="comment">//DOM2级</span></span><br><span class="line">          obj.addEventListener(eventName, handler, <span class="literal">false</span>);<span class="comment">//false- 默认。事件句柄在冒泡阶段执行</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;<span class="comment">//DOM0级</span></span><br><span class="line">          obj[<span class="string">&#x27;on&#x27;</span>+eventName]=handler;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">removeEventHandler</span>:<span class="function"><span class="keyword">function</span>(<span class="params">obj, eventName, handler</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">document</span>.attachEvent) &#123;<span class="comment">//IE</span></span><br><span class="line">          obj.detachEvent(<span class="string">&quot;on&quot;</span> + eventName, handler);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.addEventListener) &#123;<span class="comment">//DOM2级</span></span><br><span class="line">          obj.removeEventListener(eventName, handler, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;<span class="comment">//DOM0级</span></span><br><span class="line">          obj[<span class="string">&#x27;on&#x27;</span>+eventName]=<span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//获取event对象的引用，取到事件的所有信息，确保随时能使用event；</span></span><br><span class="line">  <span class="attr">getEvent</span>: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> ev = e || <span class="built_in">window</span>.event;</span><br><span class="line">      <span class="keyword">if</span> (!ev) &#123;</span><br><span class="line">          <span class="keyword">var</span> c = <span class="built_in">this</span>.getEvent.caller;</span><br><span class="line">          <span class="keyword">while</span> (c) &#123;</span><br><span class="line">              ev = c.arguments[<span class="number">0</span>];</span><br><span class="line">              <span class="keyword">if</span> (ev &amp;&amp; Event == ev.constructor) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              c = c.caller;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> ev;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//事件类型</span></span><br><span class="line">  <span class="attr">getType</span>: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> e.type;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//调用事件的元素</span></span><br><span class="line">  <span class="attr">getElement</span>: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> e.target|| e.srcElement;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//阻止默认事件</span></span><br><span class="line">  <span class="attr">preventDefault</span>: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      e = <span class="built_in">this</span>.getEvent(e);</span><br><span class="line">      <span class="keyword">if</span>(e.preventDefault)&#123;</span><br><span class="line">          e.preventDefault();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> e.returnValue=<span class="literal">false</span>;<span class="comment">//IE</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//阻止冒泡</span></span><br><span class="line">  <span class="attr">stopPropagation</span>:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(e.stopPropagation)&#123;</span><br><span class="line">        e.stopPropagation();</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        e.cancelBubble=<span class="literal">true</span>;<span class="comment">//IE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//键盘事件键盘的编号</span></span><br><span class="line">  <span class="attr">getCharCode</span>:<span class="function"><span class="keyword">function</span> (<span class="params">e</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> e.charCode==<span class="string">&quot;number&quot;</span>) <span class="keyword">return</span> e.charCode;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">return</span> e.keyCode;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//获取剪贴板的文本</span></span><br><span class="line">  <span class="attr">getClipbordText</span>:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> clipboardData=(e.clipboardData||<span class="built_in">window</span>.clipboardData);</span><br><span class="line">      <span class="keyword">return</span> clipboardData.getData(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//设置剪贴板文本</span></span><br><span class="line">  <span class="attr">setClipboardText</span>:<span class="function"><span class="keyword">function</span>(<span class="params">e,value</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(e.clipboardData)&#123;</span><br><span class="line">          <span class="keyword">return</span> e.clipboardData.setData(<span class="string">&quot;text/plain&quot;</span>,value);</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.clipboardData)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">window</span>.clipboardData.setData(<span class="string">&quot;text&quot;</span>,value);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>浏览器事件对象的兼容</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getActivatedObject</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> obj;</span><br><span class="line">   <span class="keyword">if</span> (!e) &#123;</span><br><span class="line">       <span class="comment">// early version of IE</span></span><br><span class="line">       obj = <span class="built_in">window</span>.event.srcElement;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.srcElement) &#123;</span><br><span class="line">       <span class="comment">// IE 7 or later</span></span><br><span class="line">       obj = e.srcElement;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// DOM Level 2 browser</span></span><br><span class="line">       obj = e.target;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> obj;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>requestAnimationFrame兼容写法</li><li>获取页面视口大小的兼容写法 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pageWidth=<span class="built_in">window</span>.innerWidth,</span><br><span class="line">pageHeight=<span class="built_in">window</span>.innerHeight;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> pageHeight!=<span class="string">&quot;number&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">document</span>.compatMode==<span class="string">&quot;CSS1Compat&quot;</span>)&#123;<span class="comment">//标准模式</span></span><br><span class="line">        pageHeight=<span class="built_in">window</span>.documentElement.clientHeight;</span><br><span class="line">        pageWidth=<span class="built_in">window</span>.documentElement.clientWidth;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">//BackCompat</span></span><br><span class="line">        pageHeight=<span class="built_in">window</span>.body.clientHeight;</span><br><span class="line">        pageWidth=<span class="built_in">window</span>.body.clientWidth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>获取CSS样式 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStyle</span>(<span class="params">obj,attr</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(obj.currentStyle) &#123;<span class="comment">//IE 浏览器</span></span><br><span class="line">       <span class="keyword">return</span> obj.currentStyle[attr];</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;<span class="comment">//Firefox浏览器</span></span><br><span class="line">       <span class="keyword">return</span> getComputedStyle(obj,<span class="literal">false</span>)[attr];</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="3-工程化兼容方法：babel">3. 工程化兼容方法：babel</h5><p>     babel默认只转换一些我们最新的ES语法，比如：箭头函数、Class等，一些新的API方法，比如：Generator、Iterator、Set、Map、Proxy、Reflect、Symbol、Promise、Object.assgin、Array.from 等都不会做转换，可以使用 babel polyfill 插件制定兼容方案。</p><p>&gt; 1) 使用 <code>babel-plugin-transform-xxx</code> 内联定向兼容一些API方法：</p><p>比如使用 <code>babel-plugin-transform-object-assign</code> 插件单独兼容<code>Object.assign</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i babel-plugin-transform-object-assign</span><br><span class="line"></span><br><span class="line"><span class="comment"># in .babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [<span class="string">&quot;latest&quot;</span>],</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [<span class="string">&quot;transform-object-assign&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码会被转化为如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _extends = <span class="built_in">Object</span>.assign || <span class="function"><span class="keyword">function</span> (<span class="params">target</span>) </span>&#123; <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123; <span class="keyword">var</span> source = <span class="built_in">arguments</span>[i]; <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> source) &#123; <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(source, key)) &#123; target[key] = source[key]; &#125; &#125; &#125; <span class="keyword">return</span> target; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="built_in">exports</span>.foo = <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _extends(a, b);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>缺点是</strong>：该插件可能在每个代码块中重复插入polyfill处理，造成重复的不必要引入</p><p>&gt; 2) 使用 <code>babel-plugin-transform-runtime</code> 进行模块级自动兼容：</p><p>plugin-transform 的引用是 module 级别的，意味着在多个 module 使用时会重复的引用，但是不会污染全局变量。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npm i -D babel-plugin-transform-runtime</span><br><span class="line">npm i babel-runtime</span><br><span class="line"></span><br><span class="line"># .babelrc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [<span class="string">&quot;latest&quot;</span>],</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [<span class="string">&quot;transform-runtime&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>缺点是：</strong> 只会兼容原型方法，实例对象上的方法无效，比如<code>var a = &#123;&#125;; a.assgin()</code>没法被正确转换。</p><p>&gt; 3) 源码引入<code>babel-polyfill</code>来进行全局兼容：</p><p>babel 提供了通过改变全局来兼容 es2015 所有方法的 babel-polyfill，安装 babel-polyfill 后你只需要在 main.js加一句 import引入它即可，如果使用了 webpack 也可以直接在 entry 中添加 babel-polyfill 的入口。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;babel-polyfill&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>缺点：</strong> 会污染全局变量，并且增加了引入文件体积，未使用的API polyfill也会被引入，可以将其抽离成一个 common module，放在项目的静态dll库中，或者抽成一个文件放在 cdn 上。</p><p>&gt; 4) 使用 <a href="http://polyfill.io">polyfill.io</a> 针对使用者浏览器版本进行定向兼容：</p><p>以上兼容方法都会忽略较新版本浏览器的兼容情况，可能将用户浏览器已经兼容的API都给引入覆盖了，<code>polyfill.io</code>提供一种更加智能化的方式：不同的浏览器下请求 <a href="https://cdn.polyfill.io/v2/polyfill.js">https://cdn.polyfill.io/v2/polyfill.js</a> 这个文件，服务器会判断浏览器 UA 返回不同的 polyfill 文件，你所要做的仅仅是在页面上使用<code>script</code>标签引入这个文件。</p><p>并且 <code>polyfill.io</code> 不旦提供了 cdn 的服务，也开源了自己的实现方案 <a href="https://github.com/Financial-Times/polyfill-service">polyfill-service</a>，用户可以根据实际项目情况自行选择。</p><p><strong>缺点：</strong> <a href="http://polyfill.io">polyfill.io</a> 面对复杂的浏览器UA可能识别不准确，面对这种情况时需要有替补解决方案。</p><h5 id="4-工具兼容方法：css前缀">4. 工具兼容方法：css前缀</h5><p>     有时候为了兼容一些较新的css 语法，比如：<code>display: flex</code>，我们需要针对各个浏览器添加很多前缀声明：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: -webkit-box;</span><br><span class="line">  <span class="attribute">display</span>: -ms-flexbox;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>手动进行适配兼容肯定是个很大的工作量，可以使用 vscode 插件 <code>Autoprefixer </code>进行自动添加，它会根据<a href="https://caniuse.com/">Can I Use</a>网站统计的浏览器兼容版本进行自动前缀添加。注意使用<code>v2.2.0</code>版本，最新的版本会无效，安装好之后需要去 vscode config.json 里进行配置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;autoprefixer.browsers&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;last 5 versions&quot;</span>,</span><br><span class="line">        <span class="string">&quot;&gt; 5%&quot;</span></span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="VIII-要点：前端性能优化">VIII. 要点：前端性能优化</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/frontend-optimization.png"  alt=""></p><p>     前端性能优化是个很大的概念，涉及HTTP协议、浏览器渲染原理、操作系统和网络、前端工程化和Js底层原理等各个方面。通过建立思维导图可以让我们很好的将各个优化方面组织和联系起来。<br>     按照优化原理的不同则可以将其分为<code>网络层面优化</code>和<code>渲染层面</code>的优化，网络层面的优化更多体现在资源加载时的优化，而渲染层的优化更多体现在运行时优化。<br>     例如优化浏览器缓存策略以减少HTTP请求传输量、图片和其它静态资源的压缩、服务器端启用Gzip压缩、使用CDN、图片懒加载、延迟脚本Defer和异步脚本Async等属于网络层面的优化。另一方面，减少页面的回流和重绘、使用React.Fragment减少界面dom层级、使用骨架屏、函数节流和去抖、React长列表组件优化、通过事件冒泡机制实现事件委托等就属于渲染层面的优化。</p><p><a href="https://nojsja.gitee.io/blogs/2021/02/07/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97-1/"> &gt;&gt; 文章链接</a></p><h4 id="➣-前端如何优化大量数据的加载和渲染">➣ 前端如何优化大量数据的加载和渲染</h4><ol><li>如果有使用Node.js中间层的话，可以利用服务器的多核渲染能力进行同构JS服务端渲染。</li><li>界面使用虚拟列表技术，动态显示部分数据。</li><li>使用懒加载技术，每次只加载部分数据，配合加载动画提升用户体验。</li><li>使用分页组件，用户自由选择需要加载的部分。</li><li>如果在一次性请求大量数据并需要进行数据处理的话，可以使用 web-worker 线程单独处理然后返回给主线程使用，否则主线程大量的计算可能影响界面流畅度。</li><li>使用 websocket 进行异步加载而不是 ajax 同步请求获取数据。</li></ol><h4 id="➣-webpack性能优化方面">➣ webpack性能优化方面</h4><h4 id="➣-服务器性能优化方面">➣ 服务器性能优化方面</h4><h4 id="➣-弱网环境下页面首屏如何快速加载">➣ 弱网环境下页面首屏如何快速加载</h4><p>方案：</p><ol><li>缓存的使用</li><li>SSR使用</li><li>骨架屏使用</li></ol><h3 id="IX-要点：操作系统和网络">IX. 要点：操作系统和网络</h3><hr><h4 id="➣-常见的网页攻击方式，如何防范">➣ 常见的网页攻击方式，如何防范</h4><h5 id="1-XSS：跨站脚本攻击-Cross-site-scripting">1. XSS：跨站脚本攻击(Cross-site scripting)</h5><p>     它允许使用者恶将代码恶意注入到网页上，属于代码注入的一种攻击方式，常通过HTML和Javascript进行注入攻击成功后，攻击者可能获取网站更高的操作权限、私密网页信息、会话和cookie等各种内容。</p><p>1）常用的XSS攻击手段和目的有：</p><ul><li>盗用cookie，获取敏感信息。</li><li>利用植入Flash，通过crossdomain权限设置进一步获取更高权限；或者利用Java等得到类似的操作。</li><li>利用iframe、frame、XMLHttpRequest或上述Flash等方式，以（被攻击）用户-的身份执行一些管理动作，或执行一些一般的如发微博、加好友、发私信等操作。</li><li>利用可被攻击的域受到其他域信任的特点，以受信任来源的身份请求一些平时不允许的操作，如进行不当的投票活动。</li><li>在访问量极大的一些页面上的XSS可以攻击一些小型网站，实现DoS攻击的效果。</li></ul><p>2）防范手段：</p><ul><li>将使用者所提供的内容进行过滤，许多语言都有提供对HTML的过滤：</li></ul><blockquote><p>PHP的htmlentities()或是htmlspecialchars()；Python的cgi.escape()；<br>ASP的Server.HTMLEncode()；ASP.NET的Server.HtmlEncode()或功能更强的Microsoft Anti-Cross Site Scripting Library 页面存档备份，存于互联网档案馆；Java的xssprotect (Open Source Library) 页面存档备份，存于互联网档案馆；Node.js的node-validator。</p></blockquote><ul><li>很多时候可以使用HTTP头指定内容的类型，使得输出的内容避免被作为HTML解析。如在PH</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   header(<span class="string">&#x27;Content-Type: text/javascript; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="2-XSRF：跨站请求伪造-Cross-site-request-forgery">2. XSRF：跨站请求伪造(Cross-site request forgery)</h5><p>     攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己曾经认证过的网站并运行一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。由于浏览器曾经认证过，所以被访问的网站会认为是真正的用户操作而去运行。</p><p>1）攻击示例：</p><ul><li>假如一家银行用以运行转账操作的URL地址如下： <a href="https://bank.example.com/withdraw?account=AccoutName&amp;amount=1000&amp;for=PayeeName%EF%BC%8C">https://bank.example.com/withdraw?account=AccoutName&amp;amount=1000&amp;for=PayeeName，</a><br>那么，一个恶意攻击者可以在另一个网站上放置如下代码：<code>&lt;img src=&quot;https://bank.example.com/withdraw?account=Alice&amp;amount=1000&amp;for=Badman&quot; /&gt;</code>。如果有账户名为Alice的用户访问了恶意站点，而她之前刚访问过银行不久，登录信息尚未过期，那么她就会损失1000资金。</li></ul><p>2）防范措施：</p><ul><li>令牌同步模式<br>     令牌同步模式（英语：Synchronizer token pattern，简称STP）。原理是：当用户发送请求时，服务器端应用将令牌（英语：token，一个保密且唯一的值）嵌入HTML表格，并发送给客户端。客户端提交HTML表格时候，会将令牌发送到服务端，令牌的验证是由服务端实行的。令牌可以通过任何方式生成，只要确保随机性和唯一性。这样确保攻击者发送请求时候，由于没有该令牌而无法通过验证。<br>     STP能在HTML下运作顺利，但会导致服务端的复杂度升高，复杂度源于令牌的生成和验证。因为令牌是唯一且随机，如果每个表格都使用一个唯一的令牌，那么当页面过多时，服务器由于生产令牌而导致的负担也会增加。而使用session会话等级的令牌代替的话，服务器的负担将没有那么重。<br>Django框架默认带有STP功能：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">渲染后的效果如下：</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrfmiddlewaretoken&quot;</span> <span class="attr">value</span>=<span class="string">&quot;KbyUmhTLMpYj7CD2di7JKP1P3qmLlkPt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>检查Referer字段<br>     HTTP头中有一个Referer字段，这个字段用以标明请求来源于哪个地址。在处理敏感数据请求时，通常来说，Referer字段应和请求的地址位于同一域名下。以上文银行操作为例，Referer字段地址通常应该是转账按钮所在的网页地址，应该也位于bank.example.com之下。而如果是CSRF攻击传来的请求，Referer字段会是包含恶意网址的地址，不会位于bank.example.com之下，这时候服务器就能识别出恶意的访问。<br>这种办法简单易行，工作量低，仅需要在关键访问处增加一步校验。但这种办法也有其局限性，因其完全依赖浏览器发送正确的Referer字段。虽然http协议对此字段的内容有明确的规定，但并无法保证来访的浏览器的具体实现，亦无法保证浏览器没有安全漏洞影响到此字段。并且也存在攻击者攻击某些浏览器，篡改其Referer字段的可能。</p></li><li><p>添加校验token<br>     由于CSRF的本质在于攻击者欺骗用户去访问自己设置的地址，所以如果要求在访问敏感数据请求时，要求用户浏览器提供不保存在cookie中，并且攻击者无法伪造的数据作为校验，那么攻击者就无法再运行CSRF攻击。这种数据通常是窗体中的一个数据项。服务器将其生成并附加在窗体中，其内容是一个伪随机数。当客户端通过窗体提交请求时，这个伪随机数也一并提交上去以供校验。正常的访问时，客户端浏览器能够正确得到并传回这个伪随机数，而通过CSRF传来的欺骗性攻击中，攻击者无从事先得知这个伪随机数的值，服务端就会因为校验token的值为空或者错误，拒绝这个可疑请求。</p></li></ul><h4 id="➣-跨域的基本概念和解决方法，在项目中的实际应用">➣ 跨域的基本概念和解决方法，在项目中的实际应用</h4><h4 id="➣-强缓存和协商缓存，缓存的应用，如何用在页面性能优化上">➣ 强缓存和协商缓存，缓存的应用，如何用在页面性能优化上</h4><p>     通过网络获取内容既速度缓慢又开销巨大。较大的响应需要在客户端与服务器之间进行多次往返通信，这会延迟浏览器获得和处理内容的时间，还会增加访问者的流量费用。因此，缓存并重复利用之前获取的资源的能力成为性能优化的一个关键方面。</p><p><a href="https://nojsja.gitee.io/blogs/2021/01/29/%E5%89%8D%E7%AB%AF123%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/">&gt;&gt; 文章链接</a></p><h4 id="爬虫方面问题，反爬如何实现，针对反爬的实现-IP代理等）">爬虫方面问题，反爬如何实现，针对反爬的实现(IP代理等）</h4><h4 id="➣-进程和线程区别">➣ 进程和线程区别</h4><p>     进程是资源分配的最小单位，线程是CPU调度的最小单位。</p><p>     做个简单的比喻：进程=火车，线程=车厢线程在进程下行进（单纯的车厢无法运行）</p><ul><li>一个进程可以包含多个线程（一辆火车可以有多个车厢）</li><li>不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘）</li><li>同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易）</li><li>进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源）</li><li>进程间不会相互影响，一个线程挂掉将导致整个进程挂掉（一列火车不会影响到另外一列火车，但是如果一列火车上中间的一节车厢着火了，将影响到所有车厢）</li><li>进程可以拓展到多机，进程最多适合多核（不同火车可以开在多个轨道上，同一火车的车厢不能在行进的不同的轨道上）</li><li>进程使用的内存地址可以上锁，即一个线程使用某些共享内存时，其他线程必须等它结束，才能使用这一块内存。（比如火车上的洗手间）－“互斥锁”</li><li>进程使用的内存地址可以限定使用量（比如火车上的餐厅，最多只允许多少人进入，如果满了需要在门口等，等有人出来了才能进去）－“信号量”</li></ul><h4 id="➣-cpu调度算法">➣ cpu调度算法</h4><h4 id="➣-2台计算机底层之间如何通信-socket-IO通信实现">➣ 2台计算机底层之间如何通信 socket IO通信实现</h4><h4 id="➣-cookie中常见的字段">➣ cookie中常见的字段</h4><h4 id="➣-跨域和同源策略">➣ 跨域和同源策略</h4><p>     跨域是指一个域下的文档或脚本试图去请求另一个域下的资源，这里跨域是广义的，包括：</p><ol><li>资源跳转： a链接、重定向、表单提交</li><li>资源嵌入： <code>&lt;link&gt;、&lt;script&gt;、&lt;img&gt;、&lt;frame&gt;</code>等dom标签，还有样式中<code>background:url()、@font-face()</code>等外链地址</li><li>脚本请求： js发起的ajax请求、dom和js对象的跨域操作等</li></ol><p>     同源策略/SOP（Same origin policy）是一种约束，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到XSS、CSFR等攻击。所谓同源是指当前访问页和目标请求页的&quot;协议+域名+端口&quot;三者相同，即便两个不同的域名指向同一个ip地址，也非同源。</p><p>&gt; <strong>同源策略限制以下几种行为：</strong></p><ol><li>Cookie、LocalStorage 和 IndexDB 无法读取</li><li>DOM 和 Js对象无法获得</li><li>AJAX 请求不能发送</li></ol><p>&gt; <strong>跨域解决方案：</strong></p><ol><li>通过jsonp跨域</li></ol><p>     通常为了减轻web服务器的负载，我们把js、css，img等静态资源分离到另一台独立域名的服务器上，在html页面中再通过相应的标签从不同域名下加载静态资源，而被浏览器允许，基于此原理，我们可以通过动态创建script，再请求一个带参网址实现跨域通信。</p><p>     浏览器端：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">   script.type = <span class="string">&#x27;text/javascript&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 传参一个回调函数名给后端，方便后端返回时执行这个在前端定义的回调函数 */</span></span><br><span class="line">   script.src = <span class="string">&#x27;http://www.domain2.com:8080/login?user=admin&amp;callback=handleCallback&#x27;</span>;</span><br><span class="line">   <span class="built_in">document</span>.head.appendChild(script);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 回调执行函数 */</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">handleCallback</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">       alert(<span class="built_in">JSON</span>.stringify(res));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* jquery ajax 跨域 */</span></span><br><span class="line">   $.ajax(&#123;</span><br><span class="line">     <span class="attr">url</span>: <span class="string">&#x27;http://www.domain2.com:8080/login&#x27;</span>,</span><br><span class="line">     <span class="attr">type</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">     <span class="attr">dataType</span>: <span class="string">&#x27;jsonp&#x27;</span>,  <span class="comment">// 请求方式为jsonp</span></span><br><span class="line">     <span class="attr">jsonpCallback</span>: <span class="string">&quot;handleCallback&quot;</span>,    <span class="comment">// 自定义回调函数名</span></span><br><span class="line">     <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>     Node中间层：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer();</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">&#x27;request&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> params = qs.parse(req.url.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">var</span> fn = params.callback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jsonp返回设置</span></span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/javascript&#x27;</span> &#125;);</span><br><span class="line">    res.write(fn + <span class="string">&#x27;(&#x27;</span> + <span class="built_in">JSON</span>.stringify(params) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="string">&#x27;8080&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Server is running at port 8080...&#x27;</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>postMessage跨域</li></ol><p>     postMessage是HTML5 XMLHttpRequest Level 2中的API，且是为数不多可以跨域操作的window属性之一，它可用于解决以下方面的问题：</p><ul><li>页面和其打开的新窗口的数据传递</li><li>多窗口之间消息传递</li><li>页面与嵌套的iframe消息传递</li></ul><p>     用法：postMessage(data,origin)方法接受两个参数：</p><ul><li>1）data： html5规范支持任意基本类型或可复制的对象，但部分浏览器只支持字符串，所以传参时最好用JSON.stringify()序列化。</li><li>2）origin： 协议+主机+端口号，也可以设置为&quot;*“，表示可以传递给任意窗口，如果要指定和当前窗口同源的话设置为”/&quot;。</li></ul><p>1.）a.html：(<a href="http://www.domain1.com/a.html">http://www.domain1.com/a.html</a>)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">&quot;iframe&quot;</span> src=<span class="string">&quot;http://www.domain2.com/b.html&quot;</span> style=<span class="string">&quot;display:none;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">       </span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">var</span> iframe = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;iframe&#x27;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    iframe.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> data = &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            <span class="attr">name</span>: <span class="string">&#x27;aym&#x27;</span></span></span></span><br><span class="line"><span class="javascript"><span class="xml">        &#125;;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="comment">// 向domain2传送跨域数据</span></span></span></span><br><span class="line"><span class="javascript"><span class="xml">        iframe.contentWindow.postMessage(<span class="built_in">JSON</span>.stringify(data), <span class="string">&#x27;http://www.domain2.com&#x27;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;;</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="comment">// 接受domain2返回数据</span></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        alert(<span class="string">&#x27;data from domain2 ---&gt; &#x27;</span> + e.data);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;, <span class="literal">false</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>2.）b.html：(<a href="http://www.domain2.com/b.html">http://www.domain2.com/b.html</a>)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 接收domain1的数据</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">&#x27;data from domain1 ---&gt; &#x27;</span> + e.data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(e.data);</span><br><span class="line">        <span class="keyword">if</span> (data) &#123;</span><br><span class="line">            data.number = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理后再发回domain1</span></span><br><span class="line">            <span class="built_in">window</span>.parent.postMessage(<span class="built_in">JSON</span>.stringify(data), <span class="string">&#x27;http://www.domain1.com&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><ol start="3"><li>跨域资源共享（CORS</li></ol><p>     普通跨域请求：只服务端设置Access-Control-Allow-Origin即可，前端无须设置，若要带cookie请求：前后端都需要设置。</p><p>     需注意的是：由于同源策略的限制，所读取的cookie为跨域请求接口所在域的cookie，而非当前页。</p><p>     目前，所有浏览器都支持该功能(IE8+：IE8/9需要使用XDomainRequest对象来支持CORS）)，CORS也已经成为主流的跨域解决方案。</p><ol start="4"><li>nginx代理跨域</li><li>nodejs中间件代理跨域</li><li>WebSocket协议跨域</li></ol><h4 id="➣-http中一些常见的响应头和请求头，有什么应用">➣ http中一些常见的响应头和请求头，有什么应用</h4><h4 id="➣-简单请求和非简单请求区别">➣ 简单请求和非简单请求区别</h4><h4 id="➣-http2-0-http3-0作了哪些优化">➣ http2.0 http3.0作了哪些优化</h4><h4 id="➣-https建立连接过程">➣ https建立连接过程</h4><h4 id="➣-计算机网络中，http地址，在7层协议中，如何一步步向下解析，从应用层到最底层的物理层，每一层处理的事情">➣ 计算机网络中，http地址，在7层协议中，如何一步步向下解析，从应用层到最底层的物理层，每一层处理的事情</h4><h3 id="X-产品、项目和工程化">Ｘ. 产品、项目和工程化</h3><hr><h4 id="➣-项目怎么复盘？">➣ 项目怎么复盘？</h4><p>     通俗地讲，就是对你所做事情的反思，可以是优点也可以是缺点。笔者进行复盘的出发点，一方面是想在一个项目中，有什么东西可以沉淀下来，下次做事情的时候可以直接用；二是这次有哪些地方做得不够好的地方下次有更大的进步空间。朝着这两个方向去提高自己。</p><p>     在项目结束一个星期左右的时候开始第一次的复盘比较合适。这个时候因为刚做完项目，很多实操的做法和过程都是清晰的，方便自己回忆起来。而且这个时候，头脑也会自动处于一种整理的状态，一般手上的活也不会很多，效率是最高的时候。</p><p><code>复盘</code>-最普遍也是最通用的做法：回顾目标 -&gt; 评估结果 —&gt; 分析原因 —&gt; 总结经验：</p><ol><li>回顾目标</li></ol><ul><li>1）当初行动的意图是什么？</li><li>2）事件想要达到的目标是什么？</li><li>3）预先制定的计划是什么？</li><li>4）事先设想要发生的事情是什么？</li></ul><ol start="2"><li>评估结果</li></ol><ul><li>1）实际发生了什么事？</li><li>2）在什么情况下，是怎么发生的？</li><li>3）与目标相比，哪些地方做得好？哪些未达预期？</li></ul><ol start="3"><li>分析原因</li></ol><ul><li>1）实际情况与预期有无差异？</li><li>2）如果实际情况与预期有差异，那么，为什么会出现这些差异？是由哪些因素造成？根本原因是什么？</li><li>3）如果实际情况与预期无差异，那么，成功的关键因素是什么？</li></ul><ol start="4"><li>总结经验</li></ol><ul><li>1）我们从过程中学到了什么新东西？</li><li>2）如果有人进行同样的行动，我会给他什么建议？</li><li>3）接下来我们该做什么？哪些是可以直接行动的？哪些是其他层级才能处理的？是否要向上级呈报？</li></ul><h3 id="XI-要点：Leetcode算法刷题">XI. 要点：Leetcode算法刷题</h3><hr><h4 id="➣-考察重点">➣ 考察重点</h4><ol><li>各种算法考察概率</li></ol><blockquote><p>统计不是绝对的，请理性看待</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/leetcode_key.png"  alt=""></p><ol start="2"><li>公司考察频率</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/leetcode_value.jpeg"  alt=""></p><ol start="3"><li>leetcode高频考题</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E6%95%B0%E7%BB%84.png"  alt=""></p><ul><li><p>2）哈希表<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E5%93%88%E5%B8%8C%E8%A1%A8.png"  alt=""></p></li><li><p>3）二分查找<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE.png"  alt=""></p></li><li><p>4）回溯<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E5%9B%9E%E6%BA%AF.png"  alt=""></p></li><li><p>5）字符串<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E5%AD%97%E7%AC%A6%E4%B8%B2.png"  alt=""></p></li><li><p>6）贪心<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E8%B4%AA%E5%BF%83.png"  alt=""></p></li><li><p>7）动态规划<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/dp.png"  alt=""></p></li><li><p>8）位运算<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E4%BD%8D%E8%BF%90%E7%AE%97.png"  alt=""></p></li><li><p>9）数学<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E6%95%B0%E5%AD%A6.png"  alt=""></p></li><li><p>10）广度优先<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E5%B9%BF%E5%BA%A6%E4%BC%98%E5%85%88.png"  alt=""></p></li><li><p>11）二分查找<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE.png"  alt=""></p></li><li><p>12）深度优先<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88.png"  alt=""></p></li><li><p>12）二叉树<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/interview/%E4%BA%8C%E5%8F%89%E6%A0%91.png"  alt=""></p></li></ul><h4 id="➣-推荐作者和资源">➣ 推荐作者和资源</h4><ol><li><p><a href="https://leetcode-solution-leetcode-pp.gitbook.io/leetcode-solution/thinkings">力扣加加算法题解</a></p></li><li><p><a href="https://labuladong.gitee.io/algo/">labuladong 的算法小抄</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
            <tag> 面试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端性能优化技巧详解(1)</title>
      <link href="/blogs/2021/02/07/9acea179.html/"/>
      <url>/blogs/2021/02/07/9acea179.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>此文主要描述 html / css / js / react 即时渲染和网络加载优化方面的知识，webpack常用优化方法和HTTP Server等优化请关注《 前端性能优化技巧详解(2) 》</p></blockquote><blockquote><p>如果之后发现有其它要点值得梳理，会继续更新本文…</p></blockquote><h3 id="目录">目录</h3><ul><li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li><li><a href="#%E2%9E%A3-htmlcss-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E9%9D%A2">➣ HTML/CSS 性能优化方面</a><ul><li><a href="#1-%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9D%A2">1. 网络层面</a><ul><li><a href="#1%E6%8A%BD%E7%A6%BB%E5%86%85%E8%81%94%E6%A0%B7%E5%BC%8F%E5%86%85%E8%81%94%E8%84%9A%E6%9C%AC">1）抽离内联样式内联脚本</a></li><li><a href="#2defer%E8%84%9A%E6%9C%AC%E5%92%8Casync%E8%84%9A%E6%9C%AC">2）defer脚本和async脚本</a></li><li><a href="#3%E5%8E%8B%E7%BC%A9htmlcss%E4%BB%A3%E7%A0%81%E8%B5%84%E6%BA%90">3）压缩HTML/CSS代码资源</a></li><li><a href="#4%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87%E9%9F%B3%E8%A7%86%E9%A2%91%E7%AD%89%E5%A4%9A%E5%AA%92%E4%BD%93%E8%B5%84%E6%BA%90">4）压缩图片/音视频等多媒体资源</a></li><li><a href="#5%E4%BD%BF%E7%94%A8%E9%9B%AA%E7%A2%A7%E5%9B%BE">5）使用雪碧图</a></li><li><a href="#6%E9%81%BF%E5%85%8D%E7%A9%BA%E7%9A%84-src-%E5%92%8C-href-%E5%80%BC">6）避免空的 src 和 href 值</a></li><li><a href="#7%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8import%E6%9D%A5%E5%BC%95%E5%85%A5css">7）避免使用<code>@import</code>来引入css</a></li><li><a href="#8%E4%BD%BF%E7%94%A8-cdn-%E6%9C%8D%E5%8A%A1%E6%9D%A5%E5%AD%98%E6%94%BE%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90">8）使用 CDN 服务来存放静态资源</a></li><li><a href="#9%E4%BD%BF%E7%94%A8-svg-%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%92%8C-base64-%E5%9B%BE%E7%89%87">9）使用 SVG 矢量图和 base64 图片</a></li><li><a href="#10-%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98">10) 使用缓存</a></li></ul></li><li><a href="#2-%E6%B8%B2%E6%9F%93%E5%B1%82%E9%9D%A2">2. 渲染层面</a><ul><li><a href="#1%E5%87%8F%E5%B0%91%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%9B%9E%E6%B5%81%E5%92%8C%E9%87%8D%E7%BB%98">1）减少页面的回流和重绘</a></li><li><a href="#2%E5%87%8F%E5%B0%91dom%E7%BB%93%E6%9E%84%E7%9A%84%E5%B1%82%E7%BA%A7">2）减少DOM结构的层级</a></li><li><a href="#3%E5%B0%BD%E9%87%8F%E4%B8%8D%E4%BD%BF%E7%94%A8table%E5%B8%83%E5%B1%80%E5%92%8Ciframe%E5%86%85%E8%81%94%E7%BD%91%E9%A1%B5">3）尽量不使用<code>table</code>布局和<code>iframe</code>内联网页</a></li><li><a href="#4flex%E5%B8%83%E5%B1%80%E7%9A%84%E6%80%A7%E8%83%BD%E6%AF%94inline-block%E5%92%8Cfloat%E5%B8%83%E5%B1%80%E9%83%BD%E8%A6%81%E5%A5%BD">4）flex布局的性能比<code>inline-block</code>和<code>float</code>布局都要好</a></li><li><a href="#5css%E9%80%89%E6%8B%A9%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E7%AD%96%E7%95%A5">5）CSS选择器的使用策略</a></li><li><a href="#6css%E7%9A%84%E4%B9%A6%E5%86%99%E9%A1%BA%E5%BA%8F%E4%B9%9F%E4%BC%9A%E5%AF%B9%E5%85%B6%E8%A7%A3%E6%9E%90%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%80%A0%E6%88%90%E5%BD%B1%E5%93%8D">6）css的书写顺序也会对其解析渲染性能造成影响</a></li></ul></li></ul></li><li><a href="#%E2%9E%A3-javascript-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E9%9D%A2">➣ Javascript 性能优化方面</a><ul><li><a href="#1-%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9D%A2-1">1. 网络层面</a><ul><li><a href="#1%E5%8E%8B%E7%BC%A9js%E4%BB%A3%E7%A0%81%E8%B5%84%E6%BA%90">1）压缩JS代码资源</a></li></ul></li><li><a href="#2-%E6%B8%B2%E6%9F%93%E5%B1%82%E9%9D%A2-1">2. 渲染层面</a><ul><li><a href="#1%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0%E8%8A%82%E6%B5%81%E5%92%8C%E5%87%BD%E6%95%B0%E5%8E%BB%E6%8A%96%E5%A4%84%E7%90%86%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%E7%9A%84%E9%AB%98%E9%A2%91%E8%A7%A6%E5%8F%91%E8%B0%83%E7%94%A8">1）使用函数节流和函数去抖处理一些函数的高频触发调用</a></li><li><a href="#2js%E5%AE%9E%E7%8E%B0%E5%8A%A8%E7%94%BB%E6%97%B6%E4%BD%BF%E7%94%A8requestanimationframe%E6%9B%BF%E4%BB%A3%E5%AE%9A%E6%97%B6%E5%99%A8">2）Js实现动画时使用<code>requestAnimationFrame</code>替代定时器</a></li><li><a href="#3%E4%BD%BF%E7%94%A8intersectionobserverapi%E6%9D%A5%E6%9B%BF%E4%BB%A3scroll%E4%BA%8B%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%85%83%E7%B4%A0%E7%9B%B8%E4%BA%A4%E6%A3%80%E6%B5%8B">3）使用<code>IntersectionObserver</code>API来替代<code>scroll</code>事件实现元素相交检测</a></li><li><a href="#4%E4%BD%BF%E7%94%A8web-workers%E5%9C%A8%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8Ccpu%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BB%BB%E5%8A%A1">4）使用<code>Web-Workers</code>在后台运行CPU密集型任务</a></li><li><a href="#5%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98">5）使用事件委托</a></li><li><a href="#6%E4%B8%80%E4%BA%9B%E7%BC%96%E7%A0%81%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE">6）一些编码方面的优化建议</a></li></ul></li></ul></li><li><a href="#%E2%9E%A3-react-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E9%9D%A2">➣ React 性能优化方面</a><ul><li><a href="#1-%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9D%A2-2">1. 网络层面</a><ul><li><a href="#1react-jsxjs%E6%96%87%E4%BB%B6%E5%8E%8B%E7%BC%A9">1）React jsx/js文件压缩</a></li><li><a href="#2%E4%BD%BF%E7%94%A8reactlazy%E5%92%8Creactsuspense%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2%E5%92%8C%E6%87%92%E5%8A%A0%E8%BD%BD">2）使用<code>React.lazy</code>和<code>React.Suspense</code>实现代码分割和懒加载</a></li><li><a href="#3%E4%BD%BF%E7%94%A8reactfragment%E6%9D%A5%E9%81%BF%E5%85%8D%E9%9D%9E%E5%BF%85%E8%A6%81dom%E5%B1%82%E7%BA%A7%E7%9A%84%E5%BC%95%E5%85%A5">3）使用<code>React.Fragment</code>来避免非必要DOM层级的引入</a></li></ul></li><li><a href="#2-%E6%B8%B2%E6%9F%93%E5%B1%82%E9%9D%A2-2">2. 渲染层面</a><ul><li><a href="#1%E4%BD%BF%E7%94%A8shouldcomponentupdate%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E6%B8%B2%E6%9F%93">1）使用<code>shouldComponentUpdate</code>避免不必要渲染</a></li><li><a href="#2%E4%BD%BF%E7%94%A8purecomponnet%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%B1%95%E7%A4%BA%E7%BB%84%E4%BB%B6%E7%9A%84%E8%87%AA%E5%8A%A8%E6%B5%85%E6%AF%94%E8%BE%83">2）使用<code>PureComponnet</code>实现简单展示组件的自动浅比较</a></li><li><a href="#3%E4%BD%BF%E7%94%A8reactmemo%E7%BC%93%E5%AD%98%E5%92%8C%E5%A4%8D%E7%94%A8%E7%BB%84%E4%BB%B6%E7%9A%84%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C">3）使用<code>React.memo</code>缓存和复用组件的渲染结果</a></li><li><a href="#4%E4%BD%BF%E7%94%A8context%E6%9D%A5%E5%85%B1%E4%BA%AB%E5%85%A8%E5%B1%80%E6%95%B0%E6%8D%AE">4）使用Context来共享全局数据</a></li><li><a href="#5%E4%BC%98%E5%8C%96%E7%BB%84%E4%BB%B6%E5%88%86%E5%89%B2%E7%AD%96%E7%95%A5%E6%9D%A5%E5%A4%84%E7%90%86%E9%95%BF%E5%88%97%E8%A1%A8%E7%BB%84%E4%BB%B6%E7%9A%84%E6%B8%B2%E6%9F%93">5）优化组件分割策略来处理长列表组件的渲染</a></li><li><a href="#6%E6%AD%A3%E7%A1%AE%E7%90%86%E8%A7%A3%E7%BB%84%E4%BB%B6-key-%E7%9A%84%E4%BD%BF%E7%94%A8%E7%AD%96%E7%95%A5">6）正确理解组件 key 的使用策略</a></li><li><a href="#7%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B8%B2%E6%9F%93%E6%8A%80%E6%9C%AF%E6%9D%A5%E4%BC%98%E5%8C%96%E8%B6%85%E9%95%BF%E5%88%97%E8%A1%A8%E7%BB%84%E4%BB%B6">7）使用虚拟化渲染技术来优化超长列表组件</a></li></ul></li></ul></li><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><p>&gt;  思维导图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/optimization//frontend-optimization.png"  alt=""></p><p>     前端性能优化是个很大的概念，涉及HTTP协议、浏览器渲染原理、操作系统和网络、前端工程化和Js底层原理等各个方面。通过建立思维导图可以让我们很好的将各个优化方面组织和联系起来。</p><p>     按照优化原理的不同则可以将其分为<code>网络层面优化</code>和<code>渲染层面</code>的优化，网络层面的优化更多体现在资源加载时的优化，而渲染层的优化更多体现在运行时优化。</p><p>     例如优化浏览器缓存策略以减少HTTP请求传输量、图片和其它静态资源的压缩、服务器端启用Gzip压缩、使用CDN、图片懒加载、延迟脚本Defer和异步脚本Async等属于网络层面的优化。另一方面，减少页面的回流和重绘、使用React.Fragment减少界面dom层级、使用骨架屏、函数节流和去抖、React长列表组件优化、通过事件冒泡机制实现事件委托等就属于渲染层面的优化。</p><h3 id="➣-HTML-CSS-性能优化方面">➣ HTML/CSS 性能优化方面</h3><h4 id="1-网络层面">1. 网络层面</h4><h5 id="1）抽离内联样式内联脚本">1）抽离内联样式内联脚本</h5><ul><li>内联资源不利于浏览器缓存，造成重复的资源请求</li><li>内联资源会造成HTML臃肿，不利于HTTP传输</li><li>内联资源的下载和解析可能会阻塞导致界面渲染，导致界面白屏</li><li>内联资源不好管理和维护</li></ul><h5 id="2）defer脚本和async脚本">2）defer脚本和async脚本</h5><p>     HTML在解析时遇到声明的<code>&lt;script&gt;</code>脚本会立即下载和执行，往往会延迟界面剩余部分的解析，造成界面白屏的情况。比较古老的优化方式之一就是将脚本放到HTML文档末尾，这样子解决了白屏的问题，可是在DOM文档结构复杂冗长时，也会造成一定的界面脚本下载和执行延迟，script标签新属性<code>async</code>和<code>defer</code>可以解决此类问题：</p>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;path/to/target.js&quot;</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;path/to/target.js&quot;</span> <span class="attr">async</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>defer脚本<br>     延迟脚本-声明<code>defer</code>属性的外部<code>&lt;script&gt;</code>脚本下载时不会阻塞HTML的解析和渲染，并且会在HTML渲染完成并且可实际操作之后开始执行(<code>DOMContentLoaded</code>事件被触发之前)，各个脚本解析执行顺序对应声明时的位置顺序，执行完成后会触发页面<code>DOMContentLoaded</code>事件。</li><li>async脚本<br>     异步脚本-声明<code>async</code>属性的外部<code>&lt;script&gt;</code>脚本下载时不会阻塞HTML的解析和渲染，各个脚本的下载和执行完全独立，下载完成后即开始执行，所以执行顺序不固定，与<code>DOMContentLoaded</code>事件的触发没有关联性。</li><li>动态脚本加载技术<br>     在脚本执行时动态运行<code>loadScript</code>函数可以实现类似延迟脚本和异步脚本的效果：<code>isDefer</code>为真值时脚本的执行顺序为脚本位置顺序，为假值时效果同于异步脚本。</li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">src, isDefer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">  script.src = src;</span><br><span class="line">  script.async = !isDefer;</span><br><span class="line">  <span class="built_in">document</span>.body.append(script);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3）压缩HTML-CSS代码资源">3）压缩HTML/CSS代码资源</h5><p>     代码资源中存在很多无用的空格和符号等，去除他们带来的效益是可观的，另一方面压缩资源也能起到源代码保护的作用。现代前端工程化框架一般继承了此类压缩功能，比如webpack框架的<code>html-loader</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  module: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: /\.html$/i,</span><br><span class="line">        loader: &#x27;html-loader&#x27;,</span><br><span class="line">        options: &#123;</span><br><span class="line">          minimize: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="4）压缩图片-音视频等多媒体资源">4）压缩图片/音视频等多媒体资源</h5><p>     其实网页带宽往往被图片等资源大量占用，压缩他们能带来超出预期的优化效益。现代前端工程化框架一般继承了此类压缩插件，如<code>imagemin-webpack-plugin</code>插件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ImageminPlugin <span class="keyword">from</span> <span class="string">&#x27;imagemin-webpack-plugin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 确保该插件在任何添加图片的插件之后</span></span><br><span class="line">    <span class="keyword">new</span> ImageminPlugin(&#123;</span><br><span class="line">      <span class="attr">disable</span>: process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>, <span class="comment">// 开发模式禁用</span></span><br><span class="line">      <span class="attr">pngquant</span>: &#123;</span><br><span class="line">        <span class="attr">quality</span>: <span class="string">&#x27;95-100&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5）使用雪碧图">5）使用雪碧图</h5><p>     使用雪碧图本质上优化了HTTP请求的数量，将众多图片拼贴为一张作为背景图片引用，然后我们给一个元素设置固定大小，让它的背景图片位置进行变化，只截取大图一部分进行显示，就好像显示出了不同的图片，这就是雪碧图的原理。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/optimization/sprite.png"  alt=""></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;sprite.png&quot;</span>);</span><br><span class="line">  <span class="attribute">background-position</span>: -<span class="number">60px</span> <span class="number">0px</span>;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">48px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">48px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6）避免空的-src-和-href-值">6）避免空的 src 和 href 值</h5><p>     当link标签的href属性为空、script标签的src属性为空的时候，浏览器渲染的时候会把当前页面的URL作为它们的属性值，从而把页面的内容加载进来作为它们的值。</p><h5 id="7）避免使用-import来引入css">7）避免使用<code>@import</code>来引入css</h5><p>     这种语法会阻止多个css文件的并行下载，被<code>@import</code>引入的css文件会在引入它的css文件下载并渲染好之后才开始下载渲染自身。并且<code>@import</code>引入的css文件的下载顺序会被打乱，排列在<code>@import</code>之后的JS文件会先于<code>@import</code>下载。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* css file */</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">&#x27;custom.css&#x27;</span>;</span><br></pre></td></tr></table></figure><h5 id="8）使用-CDN-服务来存放静态资源">8）使用 CDN 服务来存放静态资源</h5><p>     CDN 即内容分发网络。CDN 服务商将静态资源缓存到遍布全国的高性能加速节点上，当用户访问相应的业务资源时，CDN系统能够实时地根据网络流量和各节点的连接负载状况、到用户的距离和响应时间 等综合信息将用户的请求重新导向离用户最近的服务节点上，使内容能够传输的更快，更加稳定。可以提升首次请求的响应能力。</p><p>CDN 的核心点有两个：</p><ul><li>缓存：把资源 copy 一份到 CDN 服务器上这个过程。</li><li>回源：CDN节点 发现自己没有这个资源（一般是缓存的数据过期了），转头向根服务器（或者它的上层服务器）去要这个资源的过程。</li></ul><p>CDN 的优点：</p><ul><li>突破单域名文件加载并发请求限制</li><li>减少服务器本身的流量消耗</li><li>更快的资源加载速度</li><li>CDN内置版本控制，可以通过版本号加载指定版本的静态资源</li><li>提供静态资源使用情况分析功能</li><li>提供安全服务有效防止网站被攻击</li></ul><h5 id="9）使用-SVG-矢量图和-base64-图片">9）使用 SVG 矢量图和 base64 图片</h5><p>&gt; SVG图优点：</p><ul><li>任意放缩：用户可以任意缩放图像显示，而不会破坏图像的清晰度、细节等。</li><li>较小文件：总体来讲，SVG文件比那些GIF和JPEG格式的文件要小很多，因而下载也很快。</li><li>超强显示效果：SVG图像在屏幕上总是边缘清晰，它的清晰度适合任何屏幕分辨力和打印分辨力。</li></ul><p>&gt; base64图片:</p><ul><li>base64 图片不会触发网络请求，因为图片被硬编码到代码中。</li><li>一些复用性不高的小图片可以转成base64，webpack中可以使用 url-loader 进行自动转换。</li></ul><h5 id="10-使用缓存">10) 使用缓存</h5><p>     除了使用浏览器强缓存、协商缓存等(可以参考<a href="https://nojsja.gitee.io/blogs/2021/01/29/%E5%89%8D%E7%AB%AF123%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/">这篇文章</a>)进行一些静态资源的缓存，合理利用localStorage、sessionStorage、indexedDb、web SQL等缓存技术也很重要，浏览器本地存储可以存放一些非实时性的、不常更改的数据，只在必要的时候通过http请求获取最新的数据以减少后端的访问压力。</p><p>     cookie作为一种与后端通信息息相关的数据存储方式，每次我们发送请求时浏览器都会在请求 header 中自动携带上，所以非必要数据尽量不要存放在cookie中，以减轻http请求的传输负载。</p><h4 id="2-渲染层面">2. 渲染层面</h4><h5 id="1）减少页面的回流和重绘">1）减少页面的回流和重绘</h5><ul><li>使用CSS3属性<code>transform</code>来实现元素位移</li><li>让动画效果应用到<code>position: fixed/absolute</code>的元素上，原理是让其脱离文档流</li><li>向界面插入大量dom节点时先将dom元素添加到虚拟dom操作节点<code>DocumentFragment</code>上，最后再将虚拟节点实际添加到界面上。</li><li>避免直接使用JS操作dom元素的style样式，可以使用class一次性改变dom样式类。</li><li>将会引起页面回流、重绘的操作尽量放到DOM树的后面，减少级联反应。</li><li>使用CSS3动画Animation来实现一些复杂元素的动画效果，原理是利用了硬件加速</li><li>重复读取一些容易引起回流的元素属性时注意使用变量缓存</li></ul>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 几何属性相关 --&gt;</span></span><br><span class="line">elem.offsetLeft, elem.offsetTop, elem.offsetWidth, elem.offsetHeight, elem.offsetParent</span><br><span class="line">elem.clientLeft, elem.clientTop, elem.clientWidth, elem.clientHeight elem.getClientRects(), elem.getBoundingClientRect()</span><br><span class="line"><span class="comment">&lt;!-- 滚动相关 --&gt;</span></span><br><span class="line">elem.scrollBy(), elem.scrollTo()</span><br><span class="line">elem.scrollIntoView(), elem.scrollIntoViewIfNeeded()</span><br><span class="line">elem.scrollWidth, elem.scrollHeight</span><br><span class="line">elem.scrollLeft, elem.scrollTop 除了读取，设置也会触发</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="2）减少DOM结构的层级">2）减少DOM结构的层级</h5><h5 id="3）尽量不使用table布局和iframe内联网页">3）尽量不使用<code>table</code>布局和<code>iframe</code>内联网页</h5>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* table布局 */</span></span><br><span class="line">table布局不灵活，不利于css样式定制</span><br><span class="line">table布局渲染性能较低，可能触发多次重绘</span><br><span class="line">table布局不利于html语义化</span><br><span class="line"></span><br><span class="line"><span class="comment">/* iframe */</span></span><br><span class="line">iframe会阻塞主页面的onload事件</span><br><span class="line">iframe和主页面共享HTTP连接池，而浏览器对相同域的连接有限制，所以会影响页面的并行加载</span><br><span class="line">iframe不利于网页布局</span><br><span class="line">iframe对移动端不友好</span><br><span class="line">iframe的反复重新加载可能导致一些浏览器的内存泄露</span><br><span class="line">iframe中的数据传输复杂</span><br><span class="line">iframe不利于SEO</span><br></pre></td></tr></table></figure><h5 id="4）flex布局的性能比inline-block和float布局都要好">4）flex布局的性能比<code>inline-block</code>和<code>float</code>布局都要好</h5><h5 id="5）CSS选择器的使用策略">5）CSS选择器的使用策略</h5><p>     浏览器是从选择器的右边到左边读取，选择器最右边的部分被称为关键选择器，与CSS选择器规则的效率相关。</p><p><strong>效率排序如下：</strong><br>内联样式 &gt; ID 选择器 &gt; 类选择器 = 属性选择器 = 伪类选择器 &gt; 标签选择器 = 伪元素选择器</p><p><strong>要点：</strong></p><ul><li>关键选择器避免使用通用选择器*，其查询开销较大</li><li>使用ID/Class选择器时尽量使其独立，因为无用的上层规则(标签、类名)只会增加查找时间，ID/Class已经具有单独筛选元素的能力</li><li>避免使用子选择器，尤其是将其与标签、通配符组合使用，性能开销较大</li><li>利用CSS元素属性继承的特性，是多个元素复用多一种规则</li><li>移除无匹配样式，否则会造成无用的样式解析和匹配，同时增大CSS文件体积</li></ul><h5 id="6）css的书写顺序也会对其解析渲染性能造成影响">6）css的书写顺序也会对其解析渲染性能造成影响</h5><p>     浏览器从上到下开始解析一段css规则，将容易造成回流、重绘的属性放在上部可以让渲染引擎更高效地工作，可以按照下列顺序来进行书写，使用编辑器的<code>csslint</code>插件可以辅助完成这一过程：</p><ul><li>定位属性</li></ul>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">position</span>  <span class="attribute">display</span>  <span class="attribute">float</span>  <span class="attribute">left</span>  <span class="attribute">top</span>  <span class="attribute">right</span>  <span class="attribute">bottom</span> </span><br><span class="line"><span class="attribute">overflow</span>  <span class="attribute">clear</span>  <span class="attribute">z-index</span></span><br></pre></td></tr></table></figure><ul><li>几何属性</li></ul>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>  <span class="attribute">height</span>  <span class="attribute">padding</span>  <span class="attribute">border</span>  <span class="attribute">margin</span>   <span class="attribute">background</span></span><br></pre></td></tr></table></figure><ul><li>文字样式</li></ul>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">font-family</span>   <span class="attribute">font-size</span>   <span class="attribute">font-style</span>   <span class="attribute">font-weight</span>   <span class="attribute">font</span>-varient  <span class="attribute">color</span></span><br></pre></td></tr></table></figure><ul><li>文本属性</li></ul>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">text-align</span>   <span class="attribute">vertical-align</span>   text-wrap   <span class="attribute">text-transform</span>   <span class="attribute">text-indent</span>    <span class="attribute">text-decoration</span>   <span class="attribute">letter-spacing</span>    <span class="attribute">word-spacing</span>    <span class="attribute">white-space</span>   <span class="attribute">text-overflow</span></span><br></pre></td></tr></table></figure><ul><li>CSS3中新增属性</li></ul>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">content</span>   <span class="attribute">box-shadow</span>   <span class="attribute">border-radius</span>  <span class="attribute">transform</span></span><br></pre></td></tr></table></figure><h3 id="➣-Javascript-性能优化方面">➣ Javascript 性能优化方面</h3><h4 id="1-网络层面-2">1. 网络层面</h4><h5 id="1）压缩JS代码资源">1）压缩JS代码资源</h5><p>     代码资源中存在很多无用的空格和符号等，去除他们带来的效益是可观的，另一方面压缩资源也能起到源代码保护的作用。现代前端工程化框架一般继承了此类压缩插件，比如webpack框架的<code>uglifyjs</code>插件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">&#x27;uglifyjs-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [<span class="keyword">new</span> UglifyJsPlugin()],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-渲染层面-2">2. 渲染层面</h4><h5 id="1）使用函数节流和函数去抖处理一些函数的高频触发调用">1）使用函数节流和函数去抖处理一些函数的高频触发调用</h5><p>     在面对一些需要进行调用控制的函数高频触发场景时，可能有人会对何时使用节流何时使用去抖产生疑问。这里通过一个特性进行简单区分：如果你需要保留短时间内高频触发的最后一次结果时，那么使用去抖函数，如果你需要对函数的调用次数进行限制，以最佳的调用间隔时间保持函数的持续调用而不关心是否是最后一次调用结果时，请使用节流函数。</p><p>     比如echarts图常常需要在窗口resize之后重新使用数据渲染，但是直接监听resize事件可能导致短时间内渲染函数被触发多次。我们可以使用函数去抖的思想，监听resize事件后在监听器函数里获取参数再使用参数调用事先初始化好了的throttle函数，保证resize过程结束后能触发一次实际的echarts重渲染即可。</p><ul><li>节流<code>throttle</code></li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> canRun = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (canRun) &#123;</span><br><span class="line">      canRun = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        canRun = <span class="literal">true</span>;</span><br><span class="line">      &#125;, time);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>去抖<code>debounce</code></li></ul>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">fn, time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> timer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;, time);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2）Js实现动画时使用requestAnimationFrame替代定时器">2）Js实现动画时使用<code>requestAnimationFrame</code>替代定时器</h5><p>     <code>window.requestAnimationFrame()</code>告诉浏览器你希望执行一个动画，并且要求浏览器在下次重绘之前(每帧之前)调用指定的回调函数更新动画。该方法需要传入一个回调函数作为参数，该回调函数会在浏览器下一次重绘之前执行。</p><p>     设置的回调函数在被调用时会被传入触发的时间戳，在同一个帧中的多个回调函数，它们每一个都会接受到一个相同的时间戳，即使在计算上一个回调函数的工作负载期间已经消耗了一些时间，我们可以记录前后时间戳差值来控制元素动画的速度和启停。</p><p>     如果换用过定时器<code>setTimeout/setInterval</code>来控制帧动画的话，一般我们采用60帧进行动画绘制，所以设置的定时时间就应该是<code>1000 / 60 = 17ms</code>。不过由于定时器本身只是把回调函数放入了<code>宏任务队列</code>，其精确度受到主进程代码执行栈影响，可能导致帧动画的回调函数在浏览器的一次渲染过程中才被触发(理想情况是渲染前调用回调函数获得计算值，渲染时执行计算值绘制)，因此本应在当前帧呈现的绘制效果被延迟到了下一帧，产生丢帧卡顿的情况。</p><p>     这里让我们使用<code>requestAnimationFrame</code>来实现一个<a href="https://github.com/nojsja/javascript-learning/blob/master/js-animation/animation.js">动画处理类</a>作为例子，使用方式如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anime = <span class="keyword">new</span> Animation();</span><br><span class="line">anime.setTarget(<span class="string">&#x27;#animationTarget&#x27;</span>);</span><br><span class="line"><span class="comment">// 右下角移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: <span class="number">50</span>, <span class="attr">y</span>: <span class="number">50</span>, <span class="attr">duration</span>: <span class="number">1000</span>, <span class="attr">func</span>: <span class="string">&#x27;easeIn&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// 右上角移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: -<span class="number">50</span>, <span class="attr">y</span>: -<span class="number">50</span>, <span class="attr">duration</span>: <span class="number">500</span>, <span class="attr">func</span>: <span class="string">&#x27;linear&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><p>预览图：<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/optimization/animation.gif"  alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [tween 缓动算法]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[Number]&#125;</span>  </span>time [动画已经消耗的时间]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span>  </span>start [目标开始的位置]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span>  </span>distance [目标开始位置和结束位置的距离]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[Number]&#125;</span>  </span>duration [动画总持续时间]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> tween = &#123;</span><br><span class="line">  <span class="attr">linear</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance*time/duration + start; &#125;,</span><br><span class="line">  <span class="attr">easeIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration ) * time + start; &#125;,</span><br><span class="line">  <span class="attr">strongEaseIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time, start, distance, duration</span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration ) * time * time * time * time + start; &#125;,</span><br><span class="line">  <span class="attr">strongEaseOut</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time, start, distance, duration</span>) </span>&#123; <span class="keyword">return</span> distance * ( ( time = time / duration - <span class="number">1</span>) * time * time * time * time + <span class="number">1</span> ) + start; &#125;,</span><br><span class="line">  <span class="attr">sinEaseIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration) * time * time + start; &#125;,</span><br><span class="line">  <span class="attr">sinEaseOut</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time,start,distance,duration</span>)</span>&#123; <span class="keyword">return</span> distance * ( ( time = time / duration - <span class="number">1</span>) * time * time + <span class="number">1</span> ) + start; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 动画控制类 ------------------- */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 初始化处理元素 ------------------- */</span></span><br><span class="line">Animation.prototype.setTarget = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.querySelector(selector);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (element) &#123;</span><br><span class="line">    <span class="comment">// element.style.position = &#x27;relative&#x27;;</span></span><br><span class="line">    <span class="built_in">this</span>.store[selector] = &#123;</span><br><span class="line">      <span class="attr">selector</span>: selector,</span><br><span class="line">      <span class="attr">element</span>: <span class="built_in">document</span>.querySelector(selector),</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;pending&#x27;</span>,</span><br><span class="line">      <span class="attr">queue</span>: [],</span><br><span class="line">      <span class="attr">timeStart</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">positionStart</span>: &#123; <span class="attr">x</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">y</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">      <span class="attr">positionEnd</span>: &#123; <span class="attr">x</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">y</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [start 开始动画]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>selector [选择器]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>func     [缓动动画]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.start = <span class="function"><span class="keyword">function</span> (<span class="params">selector, func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="built_in">this</span>.store[selector];</span><br><span class="line">  target.status = <span class="string">&#x27;running&#x27;</span>;</span><br><span class="line">  <span class="comment">// 帧调用函数</span></span><br><span class="line">  that.update(&#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;, selector);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [update 更新位置]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>selector [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.update =  <span class="function"><span class="keyword">function</span> (<span class="params">position, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="built_in">this</span>.store[selector],</span><br><span class="line">    that = <span class="built_in">this</span>,</span><br><span class="line">    timeUsed,</span><br><span class="line">    positionX, positionY;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!target || !target.queue.length) &#123;</span><br><span class="line">    target.status = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reset position</span></span><br><span class="line">  target.element.style.left = position.x + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  target.element.style.top = position.y + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// position</span></span><br><span class="line">  target.positionStart = &#123; <span class="attr">x</span>: position.x, <span class="attr">y</span>: position.y &#125;;</span><br><span class="line">  target.positionEnd = &#123; <span class="attr">x</span>: position.x + target.queue[<span class="number">0</span>].x, <span class="attr">y</span>: position.y + target.queue[<span class="number">0</span>].y &#125;;</span><br><span class="line">  <span class="comment">// time</span></span><br><span class="line">  target.timeStart = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归调用</span></span><br><span class="line">  <span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span> (<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target.timeStart === <span class="literal">null</span>) target.timeStart = time; <span class="comment">// 动画开始时间</span></span><br><span class="line">    timeUsed = time - target.timeStart;</span><br><span class="line">    <span class="comment">// 当前动画完成</span></span><br><span class="line">    <span class="keyword">if</span> (timeUsed &gt;= target.queue[<span class="number">0</span>].duration) &#123;</span><br><span class="line">      target.queue.shift();</span><br><span class="line">      that.step(target.element, target.positionEnd.x, target.positionEnd.y);</span><br><span class="line">      target.status = <span class="string">&#x27;running&#x27;</span>;</span><br><span class="line">      <span class="comment">// var position = target.element.getBoundingClientRect();</span></span><br><span class="line">      <span class="keyword">var</span> position = &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="built_in">parseInt</span>(target.element.style.left),</span><br><span class="line">        <span class="attr">y</span>: <span class="built_in">parseInt</span>(target.element.style.top),</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// 下一个动画</span></span><br><span class="line">      that.update(position, selector);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    positionX = target.queue[<span class="number">0</span>].func(</span><br><span class="line">      timeUsed,</span><br><span class="line">      target.positionStart.x,</span><br><span class="line">      target.positionEnd.x - target.positionStart.x,</span><br><span class="line">      target.queue[<span class="number">0</span>].duration,</span><br><span class="line">    );</span><br><span class="line">    positionY = target.queue[<span class="number">0</span>].func(</span><br><span class="line">      timeUsed,</span><br><span class="line">      target.positionStart.y,</span><br><span class="line">      target.positionEnd.y - target.positionStart.y,</span><br><span class="line">      target.queue[<span class="number">0</span>].duration,</span><br><span class="line">    );</span><br><span class="line">    that.step(target.element, positionX, positionY);</span><br><span class="line"></span><br><span class="line">    requestAnimationFrame(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  requestAnimationFrame(callback);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [step dom操作]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[DOM]&#125;</span> </span>element [dom 元素]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Number]&#125;</span> </span>x        [x坐标]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Number]&#125;</span> </span>y        [y坐标]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.step = <span class="function"><span class="keyword">function</span> (<span class="params">element, x, y</span>) </span>&#123;</span><br><span class="line">  element.style.left = x + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  element.style.top = y + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [push 加入动画队列]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>selector [dom选择器]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>conf     [位置数据]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.push = <span class="function"><span class="keyword">function</span> (<span class="params">selector, conf</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.push(&#123;</span><br><span class="line">      <span class="attr">x</span>: conf.x,</span><br><span class="line">      <span class="attr">y</span>: conf.y,</span><br><span class="line">      <span class="attr">duration</span>: conf.duration || <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">func</span>: tween[conf.func] || tween[<span class="string">&#x27;linear&#x27;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 动画出队列 ------------------- */</span></span><br><span class="line">Animation.prototype.pop = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.pop();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 清空动画队列 ------------------- */</span></span><br><span class="line">Animation.prototype.clear = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.length = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="3）使用IntersectionObserverAPI来替代scroll事件实现元素相交检测">3）使用<code>IntersectionObserver</code>API来替代<code>scroll</code>事件实现元素相交检测</h5><p>以下是一些需要用到相交检测的场景：</p><ul><li>图片懒加载 – 当图片滚动到可见时才进行加载</li><li>内容无限滚动 – 用户滚动到接近滚动容器底部时直接加载更多数据，而无需用户操作翻页，给用户一种网页可以无限滚动的错觉</li><li>检测广告的曝光情况——为了计算广告收益，需要知道广告元素的曝光情况</li><li>在用户看见某个区域时执行任务、播放视频</li></ul><p>     以内容无限滚动为例，古老的相交检测方案就是使用<code>scroll</code>事件监听滚动容器，在监听器函数中获取滚动元素的几何属性判断元素是否已经滚动到底部。我们知道<code>scrollTop</code>等属性的获取和设置都会导致页面回流，并且如果界面需要绑定多个监听函数到<code>scroll</code>事件进行类似操作的时候，页面性能会大打折扣：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 滚动监听 */</span></span><br><span class="line">  onScroll = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; </span><br><span class="line">      scrollTop, scrollHeight, clientHeight</span><br><span class="line">    &#125; = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#target&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 已经滚动到底部 */</span></span><br><span class="line">    <span class="comment">// scrollTop(向上滚动的高度)；clientHeight(容器可视总高度)；scrollHeight(容器的总内容长度)</span></span><br><span class="line">    <span class="keyword">if</span> (scrollTop + clientHeight === scrollHeight) &#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>     因此在处理相交检测的问题时我们应该在考虑兼容性的情况下尽可能使用<code>IntersectionObserver</code> API，浏览器会自行优化多个元素的相交管理。IntersectionObserver API 允许你配置一个回调函数，当以下情况发生时会被调用：</p><ul><li>每当目标(target)元素与设备视窗或者其他指定元素发生交集的时候执行。设备视窗或者其他元素我们称它为根元素或根(root)。</li><li>Observer第一次监听目标元素的时候</li></ul><p>     创建一个 IntersectionObserver对象，并传入相应参数和回调用函数，该回调函数将会在目标(target)元素和根(root)元素的交集大小超过阈值(threshold)规定的大小时候被执行：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="attr">root</span>: <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#scrollArea&#x27;</span>),</span><br><span class="line">    <span class="attr">rootMargin</span>: <span class="string">&#x27;0px&#x27;</span>, <span class="comment">// 指定根(root)元素的外边距</span></span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">1.0</span>, <span class="comment">// 表示子元素完全和容器元素相交</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> IntersectionObserver(callback, options);</span><br><span class="line">observer.observe(<span class="built_in">document</span>.querySelector(<span class="string">&#x27;#scrollTarget&#x27;</span>));</span><br></pre></td></tr></table></figure><p>     <strong>配置项1：</strong> 通常需要关注文档最接近的可滚动祖先元素的交集更改，如果元素不是可滚动元素的后代，则默认为设备视窗。如果要观察相对于根(root)元素的交集，请指定根(root)元素为null。</p><p>     <strong>配置项2：</strong> 目标(target)元素与根(root)元素之间的交叉度是交叉比(intersection ratio)。这是目标(target)元素相对于根(root)的交集百分比的表示，它的取值在0.0和1.0之间。</p><p>     <strong>配置项3：</strong> 根(root)元素的外边距。类似于 CSS 中的  margin 属性，比如 “10px 20px 30px 40px” (top, right, bottom, left)。如果有指定root参数，则rootMargin也可以使用百分比来取值。该属性值是用作root元素和target发生交集时候的计算交集的区域范围，使用该属性可以控制root元素每一边的收缩或者扩张。默认值为0。</p><p>这里我们再以一个实际案例来进行展示，即图片懒加载方案：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">lazyload</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> imagesToLoad = <span class="built_in">document</span>.querySelectorAll(<span class="string">&#x27;image[data-src]&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadImage</span>(<span class="params">image</span>) </span>&#123;</span><br><span class="line">    image.src = image.getAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">    image.addEventListener(<span class="string">&#x27;load&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      image.removeAttribute(<span class="string">&#x27;data-src&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> intersectionObserver = <span class="keyword">new</span> IntersectionObserver(<span class="function"><span class="keyword">function</span>(<span class="params">items, observer</span>) </span>&#123;</span><br><span class="line">    items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">      <span class="comment">/* 所有属性：</span></span><br><span class="line"><span class="comment">        item.boundingClientRect - 目标元素的几何边界信息</span></span><br><span class="line"><span class="comment">        item.intersectionRatio - 相交比 intersectionRect/boundingClientRect</span></span><br><span class="line"><span class="comment">        item.intersectionRect -  描述根和目标元素的相交区域</span></span><br><span class="line"><span class="comment">        item.isIntersecting - true(相交开始)，false(相交结束)</span></span><br><span class="line"><span class="comment">        item.rootBounds - 描述根元素</span></span><br><span class="line"><span class="comment">        item.target - 目标元素</span></span><br><span class="line"><span class="comment">        item.time - 时间原点(网页在窗口加载完成时的时间点)到交叉被触发的时间的时间戳</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (item.isIntersecting) &#123;</span><br><span class="line">        loadImage(item.target);</span><br><span class="line">        observer.unobserve(item.target);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  imagesToLoad.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">image</span>) </span>&#123;</span><br><span class="line">    intersectionObserver.observe(image);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h5 id="4）使用Web-Workers在后台运行CPU密集型任务">4）使用<code>Web-Workers</code>在后台运行CPU密集型任务</h5><p>     Web Worker 允许你在后台线程中运行脚本。如果你有一些高强度的任务，可以将它们分配给 Web Worker，这些 WebWorker 可以在不干扰用户界面的情况下运行它们。创建后，Web Worker 可以将消息发布到该代码指定的事件处理程序来与 JavaScript 代码通信，反之亦然。</p><p>     一个简单的专用worker示例，我们在主进程代码中创建一个worker实例，然后向实例发送一个数字，worker接受到消息后拿到数字进行一次<code>斐波那契函数</code>运算，并发送运算结果给主线程：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* -------------- main.js -------------- */</span></span><br><span class="line"><span class="keyword">var</span> myWorker = <span class="keyword">new</span> Worker(<span class="string">&quot;fibonacci.js&quot;</span>);</span><br><span class="line">worker.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;The result of fibonacci.js: &#x27;</span>, e.data);</span><br><span class="line">&#125;;</span><br><span class="line">worker.postMessage(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- fibonacci.js -------------- */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n &gt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> fibonacci(n - <span class="number">2</span>) + fibonacci(n - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  self.postMessage(fibonacci(<span class="built_in">Number</span>(e.data)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&gt; Worker的常见类型</p><ul><li><strong>专用Worker：</strong> 一个专用worker仅仅能被生成它的脚本所使用。</li><li><strong>共享Worker：</strong> 一个共享worker可以被多个脚本使用——即使这些脚本正在被不同的window、iframe或者worker访问。</li><li><strong>Service Workers：</strong> 一般作为web应用程序、浏览器和网络（如果可用）之前的代理服务器。它们旨在（除开其他方面）创建有效的离线体验，拦截网络请求，以及根据网络是否可用采取合适的行动并更新驻留在服务器上的资源。他们还将允许访问推送通知和后台同步API。</li><li><strong>Chrome Workers：</strong> 一种仅适用于firefox的worker。如果您正在开发附加组件，希望在扩展程序中使用worker且有在你的worker中访问  js-ctypes 的权限，你可以使用Chrome Workers。</li><li><strong>Audio Workers：</strong> 音频worker使得在web worker上下文中直接完成脚本化音频处理成为可能。</li></ul><p>&gt; Worker中可以使用的函数和接口</p><p>     你可以在web worker中使用大多数的标准javascript特性，包括：</p><ul><li>Navigator</li><li>Location(只读)</li><li>XMLHttpRequest</li><li>Array, Date, Math, and String</li><li>setTimeout/setInterval</li><li>Cache &amp; IndexedDB</li></ul><p>&gt; 关于线程安全</p><p>     Worker接口会生成真正的操作系统级别的线程，然而，对于 web worker 来说，与其他线程的通信点会被很小心的控制，这意味着你很难引起并发问题。你没有办法去访问非线程安全的组件或者是 DOM，此外你还需要通过序列化对象来与线程交互特定的数据。所以你要是不费点劲儿，还真搞不出错误来。</p><p>&gt; 内容安全策略</p><p>     有别于创建它的document对象，worker有它自己的执行上下文。因此普遍来说，worker并不受限于创建它的document（或者父级worker）的内容安全策略。举个例子，假设一个document有如下头部声明：<code>Content-Security-Policy: script-src 'self'</code>，这个声明有一部分作用在于禁止脚本代码使用eval()方法。然而，如果脚本代码创建了一个worker，在worker中却是可以使用eval()的。</p><p>     为了给worker指定内容安全策略，必须为发送worker代码的请求本身加上一个<code>内容安全策略</code>。有一个例外情况，即worker脚本的使用dataURL或者blob创建的话，worker会继承创建它的document或者worker的内容安全策略。</p><p>&gt; 一些使用场景</p><ul><li>在一些不采用<code>websockets</code>架构的应用中使用传统的轮询方式定时获取接口数据以供前端脚本实现一些界面和数据自动更新功能</li><li>光线追踪：光线追踪是一种通过将光线追踪为像素来生成图像的渲染技术。光线追踪使用CPU密集型数学计算来模拟光线路径。这个想法是模拟反射，折射，材质等一些效果。所有这些计算逻辑都可以添加到Web Worker中以避免阻塞UI线程。</li><li>加密：由于对个人和敏感数据的监管日益严格，端到端加密越来越受欢迎。加密可能是一件非常耗时的事情，特别是如果有很多数据必须经常加密（例如在将数据发送到服务器之前）。这是一个非常好的场景，可以使用Web Worker。</li><li>预取数据：为了优化您的网站或Web应用程序并缩短数据加载时间，您可以利用Web Workers预先加载和存储一些数据，以便稍后在需要时使用它。</li><li>PWA进式Web应用程序：这种应用程序中即使网络连接不稳定，它们也必须快速加载。这意味着数据必须存储在本地浏览器中，这是IndexDB或类似的API进场的地方。为了在不阻塞UI线程的情况下使用，工作必须在Web Workers中完成。</li></ul><h5 id="5）使用事件委托">5）使用事件委托</h5><p>     事件委托就是把一个元素响应事件（click、keydown…）的函数委托到另一个元素。一般来讲，会把一个或者一组元素的事件委托到它的父层或者更外层元素上，真正绑定事件的是外层元素，当事件响应到需要绑定的元素上时，会通过事件冒泡机制从而触发它的外层元素的绑定事件上，然后在外层元素上去执行函数。<a href="https://zhuanlan.zhihu.com/p/26536815">=&gt; 一篇不错的参考文章</a></p><p>     其实我们熟悉的 React 框架也并不是将 click 事件直接绑定在 dom 上面，而是采用事件冒泡的形式冒泡到 document 上面，这个思路借鉴了事件委托机制。而更老一点的jQuery也是允许我们直接使用它提供的API来进行事件委托：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;.parent&#x27;</span>).on(<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;click event on tag a&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&gt;  关于事件冒泡机制：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/optimization/event-pop.jpg"  alt="event-pop"></p><p>&gt;  事件模型的<strong>三个阶段</strong>：</p><ul><li>捕获阶段：在事件冒泡的模型中，捕获阶段不会响应任何事件</li><li>目标阶段：目标阶段就是指事件响应到触发事件的最底层元素上</li><li>冒泡阶段：冒泡阶段就是事件的触发响应会从最底层目标一层层地向外到最外层（根节点），事件代理即是利用<br>件冒泡的机制把里层所需要响应的事件绑定到外层</li></ul><p>&gt; 事件委托的<strong>优点</strong>：</p><ul><li>减少内存消耗，提升性能<br>我们不需要再为每个列表元素都绑定一个事件，只需要将事件函数绑定到父级<code>ul</code>组件：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul id=&quot;list&quot;&gt;</span><br><span class="line">  &lt;li&gt;item 1&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;item 2&lt;/li&gt;</span><br><span class="line">  &lt;li&gt;item 3&lt;/li&gt;</span><br><span class="line">  ......</span><br><span class="line">  &lt;li&gt;item n&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><ul><li>动态绑定事件<br>     比如上述的例子中列表项就几个，我们给每个列表项都绑定了事件。在很多时候，我们需要通过 AJAX 或者用户操作动态的增加或者去除列表项元素，那么在每一次改变的时候都需要重新给新增的元素绑定事件，给即将删去的元素解绑事件。</li></ul><p>     如果用了事件委托就没有这种麻烦了，因为事件是绑定在父层的，和目标元素的增减是没有关系的，执行到目标元素是在真正响应执行事件函数的过程中去匹配的。所以使用事件在动态绑定事件的情况下是可以减少很多重复工作的。</p><p>&gt; 使用<code>Element.matchesSelector</code> API简单实现事件委托：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Element.prototype.matches) &#123;</span><br><span class="line">  Element.prototype.matches =</span><br><span class="line">    Element.prototype.matchesSelector ||</span><br><span class="line">    Element.prototype.mozMatchesSelector ||</span><br><span class="line">    Element.prototype.msMatchesSelector ||</span><br><span class="line">    Element.prototype.oMatchesSelector ||</span><br><span class="line">    Element.prototype.webkitMatchesSelector ||</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> matches = (<span class="built_in">this</span>.document || <span class="built_in">this</span>.ownerDocument).querySelectorAll(s),</span><br><span class="line">        i = matches.length;</span><br><span class="line">      <span class="keyword">while</span> (--i &gt;= <span class="number">0</span> &amp;&amp; matches.item(i) !== <span class="built_in">this</span>) &#123;&#125;</span><br><span class="line">      <span class="keyword">return</span> i &gt; -<span class="number">1</span>;            </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>).addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 兼容性处理</span></span><br><span class="line">  <span class="keyword">var</span> event = e || <span class="built_in">window</span>.event;</span><br><span class="line">  <span class="keyword">var</span> target = event.target || event.srcElement;</span><br><span class="line">  <span class="keyword">if</span> (target.matches(<span class="string">&#x27;li.class-1&#x27;</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;the content is: &#x27;</span>, target.innerHTML);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>&gt;  事件委托的<strong>局限性</strong>：</p><ul><li>比如 focus、blur 之类的事件本身没有事件冒泡机制，所以无法委托。</li><li>mousemove、mouseout 这样的事件，虽然有事件冒泡，但是只能不断通过位置去计算定位，对性能消耗高，因此也是不适合于事件委托的。</li></ul><h5 id="6）一些编码方面的优化建议">6）一些编码方面的优化建议</h5><ul><li>长列表数据的遍历使用<code>for</code>循环替代<code>forEach</code>。</li></ul><p>     for循环能通过关键字<code>break</code>实现循环中断，forEach首先性能不如for，其次在处理一些需要条件断开的循环时比较麻烦(可以包裹try catch，然后throw error断开)。如果是数组类型的数据遍历的话，也可以使用<code>array.every(item =&gt; &#123; if (...) return false; else do something; &#125;)</code>来实现条件断开。</p><ul><li>尽量不要在全局作用域声明过多变量</li></ul><p>     全局变量存在于全局上下文，全局上下文是作用域链的顶端，当通过作用域链进行变量查找的时候，会延长查找时间。全局执行上下文会一直存在于上下文执行栈，直到程序推出，这样会影响GC垃圾回收。如果局部作用域中定义了同名变量，会遮蔽或者污染全局。</p><p>     可以使用单例模式来封装一系列逻辑(运用了闭包的原理)，并通过一个公用的变量名暴露给作用域中的其它模块使用，同时也提高了代码的内聚性：</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="keyword">const</span> workData = &#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workA</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workB</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workC</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="keyword">const</span> work = (<span class="function"><span class="keyword">function</span> (<span class="params">initParams</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> workData = &#123;&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">workA</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">workB</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">workC</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">doWorkA</span>: workA,</span><br><span class="line">    <span class="attr">doWorkB</span>: workB,</span><br><span class="line">    <span class="attr">doWorkC</span>: workC,</span><br><span class="line">    <span class="attr">workSeries</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.doWorkB();</span><br><span class="line">      <span class="built_in">this</span>.doWorkC();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)(initParams);</span><br><span class="line"></span><br><span class="line">work.doWorkA();</span><br><span class="line">work.workSeries();</span><br></pre></td></tr></table></figure><ul><li>使用<code>switch</code>和<code>map</code>的方式处理需要大量逻辑判断的情况</li></ul><p>     连续的<code>if</code>判断中在到达目标条件之前需要经过多个条件判断，而map和switch方式都能够通过条件直接找到对应的处理逻辑。</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="keyword">if</span> (condition === <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (condition === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="keyword">switch</span> (condition) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">    <span class="comment">// do something ...</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">    <span class="comment">// do something ...</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">default</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> conditionMap = &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something */</span> &#125;,</span><br><span class="line">  <span class="attr">b</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* do something */</span> &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line">conditionMap[condition]();</span><br></pre></td></tr></table></figure><ul><li>定义构造函数时使用原型声明对象的公用方法</li></ul><p>     我们在<code>new</code>一个对象时，js所做的就是创建一个空对象，并把此对象作为构造函数的context来执行(参考call调用逻辑)，执行后空对象上就被复制了构造函数的的属性和方法，然后js会把构造函数的原型绑定到对象的<code>__proto__</code>属性上，最后构造函数将对象返回给我们使用。</p><p>     从以上可以看出，如果我们直接把一些function逻辑写入构造函数的话，在对象创建的时候每个function都会在新对象上被创建一次，消耗额外的资源，且违反了程序复用原则。建议将function放入构造函数的原型，那么对象就能通过原型链查找来使用这个方法，而不是在对象自身上重新复制一个一模一样的逻辑。</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Structure</span>(<span class="params">attr</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.attr = attr;</span><br><span class="line">  <span class="built_in">this</span>.getAttr = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.attr;</span><br><span class="line">  &#125;).bind(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Structure(<span class="string">&#x27;obj1&#x27;</span>);</span><br><span class="line">obj.getAttr(); <span class="comment">// from obj itself</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Structure</span>(<span class="params">attr</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.attr = attr;</span><br><span class="line">&#125;</span><br><span class="line">Structure.prototype.getAttr = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.attr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Structure(<span class="string">&#x27;obj1&#x27;</span>);</span><br><span class="line">obj.getAttr(); <span class="comment">// from obj prototype chain</span></span><br></pre></td></tr></table></figure><h3 id="➣-React-性能优化方面">➣ React 性能优化方面</h3><h4 id="1-网络层面-3">1. 网络层面</h4><h5 id="1）React-jsx-js文件压缩">1）React jsx/js文件压缩</h5><h5 id="2）使用React-lazy和React-Suspense实现代码分割和懒加载">2）使用<code>React.lazy</code>和<code>React.Suspense</code>实现代码分割和懒加载</h5><p>     React开发的应用通常会借用<code>webpack</code>这类项目打包器将编写的各个模块代码和引入的依赖库的代码打包成一个单独的JS文件，有些未做CSS样式分离优化的项目甚至连样式表都和JS文件打包在一起，然后在页面加载的HTML文件中需要下载了这一整个JS文件后之后才能进去到页面构建阶段。对于中小型项目还好，简单的首屏优化就能将资源压缩到足够小，但是一些大型项目可能存在很多子项目，如果不对代码做分割然后按子项目模块加载的话，在首屏我们浏览器需要下载整个项目的依赖文件，导致加载时间过长。</p><p>     使用<code>React.lazy</code>可以分割子项目代码并根据当前页面路由来动态加载页面依赖文件，尽管并没有减少应用整体的代码体积，但你可以避免加载用户永远不需要的代码，并在初始加载的时候减少所需加载的代码量。</p><p>注意：搭配<code>Babel</code>进行代码编译时需要安装额外的babel插件以提供动态加载功能：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;presets&quot;</span>: [...],</span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;dynamic-import-webpack&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>React.lazy 函数能让你像渲染常规组件一样处理动态引入的组件：<br>它接受一个函数，这个函数需要动态调用 import()。它必须返回一个 Promise，该 Promise 需要 resolve 一个 defalut export 的 React 组件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 使用前 */</span></span><br><span class="line"><span class="keyword">import</span> OtherComponent <span class="keyword">from</span> <span class="string">&#x27;./OtherComponent&#x27;</span>;</span><br><span class="line"><span class="comment">/* 使用后，代码将会在组件首次渲染时，自动导入包含 OtherComponent 组件的包 */</span></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./OtherComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- OtherComponent.js -------------- */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>other<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>) &#125;;</span><br></pre></td></tr></table></figure></li><li><p>使用 React.Suspense 提供一个组件加载时的占位组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OtherComponent = React.lazy(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./OtherComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mainComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">OtherComponent</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">AnotherComponent</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用异常捕获组件避免模块加载失败时让整个应用崩溃</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* -------------- mainComponent.js -------------- */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">MyErrorBoundary</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">OtherComponent</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">MyErrorBoundary</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- ErrorBoundary.js -------------- */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123; <span class="attr">hasError</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromError</span>(<span class="params">error</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 更新 state 使下一次渲染能够显示降级后的 UI</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">hasError</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidCatch</span>(<span class="params">error, errorInfo</span>)</span> &#123;</span><br><span class="line">    logErrorToMyService(error, errorInfo); <span class="comment">// 可以选择将错误日志上报给服务器</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.state.hasError)</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Something went wrong.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>; <span class="comment">// 你可以自定义降级后的 UI 并渲染</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.props.children; <span class="comment">// 正常渲染子组件</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>代码分割搭配 React-Router 同样适用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Suspense, lazy &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserRouter <span class="keyword">as</span> Router, Route, Switch &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = lazy(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./routes/Home&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">() =&gt;</span> (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">exact</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Home&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul><h5 id="3）使用React-Fragment来避免非必要DOM层级的引入">3）使用<code>React.Fragment</code>来避免非必要DOM层级的引入</h5><p>     React通常要求我们在编写一个组件时返回单个container组件包裹的DOM结构，而不允许直接返回多个未包裹的子组件，如果不使用Fragment就必须额外添加一层DOM节点，比如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>额外添加的<code>div</code>增加了无用的DOM层级，且会造成<code>table</code>组件无法正确渲染(tr/td之间多了一层div)。<br>使用Fragment后最终所有<code>td</code>标签都会被直接添加到上层的<code>tr</code>标签下，同时也不会产生多余层级：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-渲染层面-3">2. 渲染层面</h4><h5 id="1）使用shouldComponentUpdate避免不必要渲染">1）使用<code>shouldComponentUpdate</code>避免不必要渲染</h5><p>     当一个React组件内部state或外部传入props更新时，会触发组件的重新渲染，开发者可以在<code>shouldComponentUpdate</code>生命周期中通过对比传入的即将被更新的state和props来决定组件是否要重新渲染，函数默认返回true，即触发渲染：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterButton</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;<span class="attr">count</span>: <span class="number">1</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="built_in">this</span>.props.color !== nextProps.color ||</span><br><span class="line">      <span class="built_in">this</span>.state.count !== nextState.count</span><br><span class="line">    ) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">color</span>=<span class="string">&#123;this.props.color&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.setState(state =&gt; (&#123;count: state.count + 1&#125;))&#125;&gt;</span></span><br><span class="line"><span class="xml">        Count: &#123;this.state.count&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>     <strong>适用情况：</strong> 当前组件的props/state并没有发生改变，但是由于其父组件的重新渲染，导致当前组件也被迫进入了重新渲染阶段。这时候为组件添加<code>shouldComponentUpdate</code>生命周期函数进行数据比较就显得尤为重要了，特别是当组件的DOM结构复杂、嵌套层次很深，重新渲染的性能消耗昂贵的时候。</p><p>     <strong>滥用情况：</strong> 并非所有组件都需要被添加此生命周期用于数据比较，因为比较这一过程本身也是需要消耗性能的，如果一个组件的state/props本来就会经常更新，那么这个组件久无需使用<code>scp</code>进行优化</p><p>     <strong>深比较函数：</strong> 有时候一个组件所需的数据结构很复杂，比如用于展示当前目录层级的资源树组件，其依赖的数据采用树形结构，树形组件一般采用递归的渲染方式，组件的渲染更新操作昂贵。因此我们可以考虑在这类组件的<code>scp</code>生命周期中使用深比较函数来对更新前后的属性数据进行一次递归比较，以判断当前资源树组件是否需要进行更新：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [deepComparison 深比较]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>data [any]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;[type]&#125;</span>      </span>[boolean]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepComparison</span>(<span class="params">data1, data2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; hasOwnProperty &#125; = <span class="built_in">Object</span>.prototype;</span><br><span class="line">  <span class="keyword">const</span> &#123; toString &#125; = <span class="built_in">Object</span>.prototype;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取变量类型</span></span><br><span class="line">  <span class="keyword">const</span> getType = <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d === <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (d !== d) <span class="keyword">return</span> <span class="string">&#x27;nan&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> d === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (toString.call(d) === <span class="string">&#x27;[object Date]&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;date&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (toString.call(d) === <span class="string">&#x27;[object RegExp]&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;regexp&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">typeof</span> d).toLowerCase();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基本类型比较</span></span><br><span class="line">  <span class="keyword">const</span> is = <span class="function">(<span class="params">d1, d2, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;nan&#x27;</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;date&#x27;</span> || type === <span class="string">&#x27;regexp&#x27;</span>) <span class="keyword">return</span> d1.toString() === d2.toString();</span><br><span class="line">    <span class="keyword">return</span> (d1 === d2);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归比较</span></span><br><span class="line">  <span class="keyword">const</span> compare = <span class="function">(<span class="params">d1, d2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> type1 = getType(d1);</span><br><span class="line">    <span class="keyword">var</span> type2 = getType(d2);</span><br><span class="line">    <span class="keyword">var</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type1 !== type2) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type1 === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> keys1 = <span class="built_in">Object</span>.keys(d1);</span><br><span class="line">      <span class="keyword">var</span> keys2 = <span class="built_in">Object</span>.keys(d2);</span><br><span class="line">      <span class="keyword">if</span> (keys1.length !== keys2.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys1.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        index = keys2.indexOf(keys1[i]);</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          (index === -<span class="number">1</span>) ||</span><br><span class="line">          !compare(d1[keys1[i]], d2[keys2[index]])) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> is(d1, d2, type1);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> compare(data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>     <strong>最佳实践：</strong> 深比较函数其实消耗的性能很大，特别是当数据层级很深的时候，函数的递归需要创建和销毁多个执行上下文，可能数据比较本身所消耗的性能就多于一次渲染了。因此大部分情况下使用<code>immutable</code>不可变数据结构(对象每次更新都返回一个全新的对象，对象的引用发生变化) + <code>shallowEqual</code>做浅比较是比较理想的选择。</p><h5 id="2）使用PureComponnet实现简单展示组件的自动浅比较">2）使用<code>PureComponnet</code>实现简单展示组件的自动浅比较</h5><p>     上文提到<code>scu</code>生命周期中我们可以通过自定义prop/state比较函数来来控制组件是否需要重新渲染，最后得出了<code>immutable</code>不可变数据+shallowEqual是最佳实践。其实React已经给我们提供了一种自带浅比较函数的组件类型即<code>React.PureComponnet</code>，它适用于一些数据类型简单的展示组件，当我们给这些React组件传入相同的 props 和 state时，render() 函数会渲染相同的内容，那么在这些情况下使用 React.PureComponent 可提高性能：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleCounter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">PureComponnet</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.setState(&#123; count: (this.state.count+1) &#125;)&#125;</span></span><br><span class="line"><span class="xml">        style=&#123;&#123;color: this.props.color&#125;&#125;</span></span><br><span class="line"><span class="xml">      &gt;count:$&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>     <strong>适用情况</strong> 和 <strong>滥用情况</strong> 与<code>scp</code>生命周期大致相同，不过需要额外注意：</p><ul><li>React.PureComponent仅作对象的浅层比较，如果对象中包含复杂的数据结构，则有可能因为无法检查深层的差别，产生错误的比对结果。</li><li>我们可以仅仅在props 和 state 较为简单时，才使用 React.PureComponent。</li><li>另一种处理方式就是在深层数据结构发生变化时调用 forceUpdate() 来确保组件被正确地更新。</li><li>当然也可以使用<a href="https://immutable-js.github.io/immutable-js/"> immutable.js </a>框架来处理数据结构，可以加快不可变对象加速嵌套数据的比较。一种简单的处理方式是在state数据需要更新时我们手动进行对象引用的更新：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleDisplay</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">list</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  insertItem = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="comment">/* bad - 组件不会更新 */</span></span><br><span class="line">    list.push(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; list &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* good - 重新更新list变量的引用 */</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">list</span>: [...list, <span class="string">&#x27;c&#x27;</span>] &#125;);</span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">list</span>: a.concat(<span class="string">&#x27;c&#x27;</span>) &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.insertItem&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123; this.state.list.join(&#x27;/&#x27;) &#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3）使用React-memo缓存和复用组件的渲染结果">3）使用<code>React.memo</code>缓存和复用组件的渲染结果</h5><p>     <code>React.memo()</code>为高阶组组件，如果组件在相同 props 的情况下渲染相同的结果(state的更新依然会导致重新渲染)，那么你可以通过将其包装在 React.memo 中调用，以此通过记忆组件渲染结果的方式来提高组件的性能表现。这意味着在这种情况下，React 将跳过渲染组件的操作并直接复用最近一次渲染的结果。</p><p>     默认情况下其只会对复杂对象做浅层对比，如果你想要控制对比过程，那么请将自定义的比较函数通过第二个参数传入来实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* 使用 props 渲染 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">areEqual</span>(<span class="params">prevProps, nextProps</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  如果把 nextProps 与 prevProps 的比较结果一致则返回 true，</span></span><br><span class="line"><span class="comment">  否则返回 false，这一点与shoudComponentUpdate表现相反，且areEqual</span></span><br><span class="line"><span class="comment">  中无法对组件内部state进行比较</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo(MyComponent, areEqual);</span><br></pre></td></tr></table></figure><p>&gt;  <strong>不建议</strong>使用<code>React.memo()</code>的情况：</p><ul><li>如果组件经常接收不同的属性props对象来更新的话，那么缓存上一次渲染结果这一过程毫无意义，且增加了额外的性能支出。</li><li>此方法仅作为性能优化的方式而存在，不要依赖它来“阻止”渲染，因为这会产生 bug。</li></ul><p>&gt;  <strong>建议</strong>使用<code>React.memo()</code>的情况：</p><ul><li>一个组件经常会以相同的props更新，比如父组件的其它部分更新导致的当前子组件非必要渲染</li><li>常常用于将函数组件转变为具有<code>memorized</code>缓存特性的组件，组件内部可以使用<code>useState</code>hook进行内部状态管理，对组件的自更新没有影响。</li><li>如果一个组件包含大量复杂的<code>dom</code>结构，重新渲染的性能消耗较大的话可以考虑使用<code>React.memo</code>包裹，避免很多不必要的渲染情况，在props不变的情况下让react能直接复用上次的渲染结果。</li></ul><h5 id="4）使用Context来共享全局数据">4）使用Context来共享全局数据</h5><p>     Context 设计目的是为了共享那些对于一个组件树而言是“全局”的数据，例如当前认证的用户、主题或首选语言，使用 context, 我们可以避免通过中间元素来逐级传递 props。举个例子，在下面的代码中，我们通过一个 “theme” 属性手动调整一个按钮组件的样式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* -------------- context.js -------------- */</span></span><br><span class="line"><span class="keyword">const</span> theme = &#123;</span><br><span class="line">  <span class="attr">light</span>: &#123; <span class="attr">color</span>: <span class="string">&#x27;black&#x27;</span>, <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span> &#125;,</span><br><span class="line">  <span class="attr">dark</span>: &#123; <span class="attr">color</span>: <span class="string">&#x27;white&#x27;</span>, <span class="attr">backgroundColor</span>: <span class="string">&#x27;black&#x27;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为当前的 theme 创建一个 context（“light”为默认值）。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">const</span> ThemeContext = React.createContext(theme.light);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- App.js -------------- */</span></span><br><span class="line"><span class="comment">// Context 可以让我们无须明确地传遍每一个组件，就能将值深入传递进组件树。</span></span><br><span class="line"><span class="keyword">const</span> ThemeContext = <span class="built_in">require</span>(<span class="string">&#x27;./context.js&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 使用一个 Provider 来将当前的 theme 传递给以下的组件树。</span></span><br><span class="line">    <span class="comment">// 无论多深，任何组件都能读取这个值。</span></span><br><span class="line">    <span class="comment">// 在这个例子中，我们将 “dark” 作为当前的值传递下去，当Provider不指定当前值时</span></span><br><span class="line">    <span class="comment">// createContext中传入的默认值会生效</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Toolbar</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- Toolbar.js -------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间的组件再也不必指明往下传递 theme 了。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Toolbar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">ThemedButton</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- ThemedButton.js -------------- */</span></span><br><span class="line"><span class="keyword">const</span> ThemeContext = <span class="built_in">require</span>(<span class="string">&#x27;./context.js&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemedButton</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 指定 contextType 读取当前的 theme context。</span></span><br><span class="line">  <span class="comment">// React 会往上找到最近的 theme Provider，然后使用它的值。</span></span><br><span class="line">  <span class="comment">// 在这个例子中，当前的 theme 值为 “dark”。</span></span><br><span class="line">  <span class="keyword">static</span> contextType = ThemeContext;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">theme</span>=<span class="string">&#123;this.context&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>     对于不需要订阅context更新来重新渲染界面的情况，上面的代码示例已经足够应付，如果想要接收动态变化的context值来响应式更新界面，则需要使用<code>Context.Consumer</code>API，它内部包裹一个返回dom组件的function函数，传递给函数的 value 值等价于组件树上方离这个 context 最近的 Provider 提供的 value 值。如果没有对应的 Provider，value 参数等同于传递给 createContext() 的 默认值：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">MyContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123; value =&gt; <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;value&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>/* 基于 context 值进行渲染*/ &#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">MyContext.Consumer</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong> Context 主要应用场景在于很多不同层级的组件需要访问同样一些的数据。请谨慎使用，因为这会使得组件的复用性变差。</p><h5 id="5）优化组件分割策略来处理长列表组件的渲染">5）优化组件分割策略来处理长列表组件的渲染</h5><p>     有时候我们需要渲染一些拥有很多子组件的的列表组件，比如一个展示当前目录下有哪些文件的<code>FileList</code>组件，它包含很多子组件<code>FileListItem</code>，如下。想象我们在使用 input 组件获取输入值更新 state 得时候，同时也不可避免的触发了同一个render函数下<code>FileListItem</code>组件的重新渲染，即使从父级传入的 files 数组未发生任任何改变：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onChange = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">value</span>: e.target.value &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;this.state.value&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.onChange&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          &#123;</span></span><br><span class="line"><span class="xml">            this.props.files.map((file) =&gt; &#123;</span></span><br><span class="line"><span class="xml">              return <span class="tag">&lt;<span class="name">FileListItem</span> <span class="attr">key</span>=<span class="string">&#123;file.name&#125;</span> <span class="attr">name</span>=<span class="string">&#123;file.name&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">            &#125;)</span></span><br><span class="line"><span class="xml">          &#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>     这时候我们就可以考虑在设计组件结构时将 <code>files.map()</code>这部分的逻辑完全抽离到一个完整的子组件内，否则前面提到的<code>shouldComponentUpdate</code>、<code>PureComponent</code>、<code>memo</code>等优化方法都将无法施展。我们无法直接在<code>FileList</code>组件内针对 files 数组未改变的情况下做任何优化，因为 input 组件的每次状态更新都会让 <code>FileList</code> 组件的每一个部分都重新渲染一遍，优化的组件结构如下：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* -------------- FileList.js -------------- */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">value</span>: <span class="literal">null</span> &#125;</span><br><span class="line"></span><br><span class="line">  onChange = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">value</span>: e.target.value &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;this.state.value&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.onChange&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">FileListItemContainer</span> <span class="attr">files</span>=<span class="string">&#123;this.props.files&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* -------------- FileListItemContainer.js -------------- */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo(<span class="function"><span class="keyword">function</span>(<span class="params">&#123; files &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123;</span></span><br><span class="line"><span class="xml">        files.map((file) =&gt; &#123;</span></span><br><span class="line"><span class="xml">          return <span class="tag">&lt;<span class="name">FileListItem</span> <span class="attr">key</span>=<span class="string">&#123;file.name&#125;</span> <span class="attr">name</span>=<span class="string">&#123;file.name&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">        &#125;);</span></span><br><span class="line"><span class="xml">      &#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="6）正确理解组件-key-的使用策略">6）正确理解组件 key 的使用策略</h5><p>     在 React 中，UI 界面的构建是由当前虚拟DOM树状态决定的。前后两个状态就对应两套界面，产生不同的状态之后，然后由 React 通过时间复杂度为O(n)的 dom diff 算法来比较两个界面的区别，最后由React选择性的来更新真实DOM。</p><p>     要想理解 React组件 key 的设计理念我们得先简单了解一下React进行DOM树 diff 的过程，我们都知道Js脚本直接操作网页DOM元素时会造成重绘和回流等<code>低效渲染</code>，因此React的DOM树 diff 过程针对的是更新前后两颗虚拟的DOM树，虚拟DOM树并不是真实的DOM节点，而是一种描述页面DOM元素结构的树形数据结构，每个虚拟树节点存储了一个DOM元素的属性和样式等信息。React 需要基于这两棵树之间的差别来判断如何有效率的更新 UI 以保证当前 UI 与最新的树保持同步。为了提高树diff的效率，于是 React 在以下两个假设的基础之上提出了一套复杂度为 O(n) 的启发式算法：</p><ul><li>i. 两个不同类型的元素会产生出不同的树(比如 img 和 span 被看做完全不同的两个节点)</li><li>ii. 开发者可以通过 key 属性来暗示哪些子元素在不同的渲染下能保持稳定</li></ul><p>     如果两次渲染同一位置的某个元素的类型改变，例如从 span 变成了 image，那么不用多说这个组件和其子组件都会先被卸载，同时触发卸载前组件的生命周期<code>componentWillUnmount</code>，然后将新的DOM节点渲染添加到页面上，新的组件实例将执行 <code>componentWillMount</code>、<code>componentDidMount</code> 等周期方法，所有跟之前的树所关联的 state 也会被销毁。</p><p>     如果两次渲染组件的类型未改变，React 将更新该组件实例的 props 以跟最新的元素保持一致，并且调用该实例的 <code>componentWillReceiveProps</code>、<code>componentWillUpdate</code> 以及 <code>componentDidUpdate</code> 方法。下一步，React 会调用 <code>render()</code>方法并比较其子节点产生的差异。</p><p>想象我们在子元素列表末尾新增元素时：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>first<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>second<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"><span class="comment">/* 插入third */</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>first<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>second<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>third<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>React 会先匹配到两颗虚拟DOM树对应的 <code>first</code>节点，然后匹配到两棵树的 <code>second</code> 节点，最后发现在<code>second</code>之后出现了一个全新的节点，dom渲染时就会插入第三个元素 <code>&lt;li&gt;third&lt;/li&gt;</code> 到<code>second</code>之后，其更新开销会比较小。</p><p>     但是也有一种比较坏的情况，当我们将<code>third</code>节点插入到列表头时，React在 diff 过程中发现所有子节点都发生了变化(整体位置发生了相对改变)，React 不会意识到应该保留<code>first</code>和<code>second</code>，而是会重建每一个子元素，这种情况会带来性能问题：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>first<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>second<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"><span class="comment">/* 插入third */</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>third<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>first<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>second<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>     为了解决以上问题，React 支持 <code>key</code> 属性。当子元素拥有 key 时，React 使用 key 来匹配原有树上的子元素以及最新树上的子元素，相当于每个子节点都有了ID，因此能够游刃有余的判断哪些节点需要重建，而哪些节点只需要进行简单的位置移动即可。比如上个例子中React根据组件的Key就能识别我们只需要新建<code>third</code>节点并将它插入到first节点之前就能满足要求，而不需要将列表元素都重建一遍。</p><p>&gt; 对组件key的 <strong>误解 和 乱用：</strong></p><ul><li>页面中的所有组件key都不能重复 =&gt; 错！我们只需要保证同一列表层级的组件key不重复即可，当有重复key时可能会导致React在多次渲染时结果错乱。</li><li>使用<code>Math.random()</code>函数来随机产生key值 =&gt; 大错特错！这样子做了之后，每次渲染key值都会变化，会引起所有使用了key的组件都会被卸载重建一次，性能优化效果为负。</li><li>key值只能用于列表组件 =&gt; 错！我们可以给任意一个组件添加key值，比如我们想让某个组件在props/state完全没改变的情况下触发其重建更新，那么就可以给予它两个阶段不同的key值。一个例子是用于重置Antd Form表单状态，让其在某些特殊情况下以之前的默认值重新挂载(触发表单更改后其默认值无法恢复)。</li></ul><h5 id="7）使用虚拟化渲染技术来优化超长列表组件">7）使用虚拟化渲染技术来优化超长列表组件</h5><p>     有时候项目中要求我们在不使用分页的情况下渲染一个超长的列表组件，比如一个文件上传列表里面的每个文件上传任务，我们同时添加成千上万个上传任务，然后并行上传几个，操作者同时也能通过列表的上下滚动来查看每个上传任务的状态。这种变态数量级的界面元素展示+本就不简单的上传流程控制，必然导致我们的界面会有一定程度的卡顿。</p><p>     一个解决方案就是可以采用懒加载技术来实现当滚动到任务列表底部时加载其余的一小部分任务列表元素，这样虽然解决了初次渲染时耗费时间过长的问题，不过随着滚动到底部加载的任务条目越来越多，界面的渲染负载也会越来越大。这种情况下采用虚拟化滚动技术来进行优化就显得很有必要了。</p><p>     虚拟列表是一种根据滚动容器元素的可视区域高度来渲染长列表数据中某一个部分数据的技术。这里需要简单了解一下其原理，如果要直接使用的话可以考虑这两个热门的虚拟滚动库 <a href="https://react-window.now.sh/">react-window</a> 和 <a href="https://bvaughn.github.io/react-virtualized/">react-virtualized</a>。</p><p>&gt; 首先清楚虚拟化滚动技术中的几个<strong>关键元素</strong>：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/optimization/vitual-scroll.png"  alt="vitual-scroll"></p><ul><li>i. 滚动容器元素：一般情况下，滚动容器元素是 window 对象。然而，我们可以通过布局的方式，在某个页面中任意指定一个或者多个滚动容器元素。只要某个元素能在内部产生横向或者纵向的滚动，那这个元素就是滚动容器元素。</li><li>ii. 可滚动区域：滚动容器元素的内部内容区域。假设有 100 条数据，每个列表项的高度是 50，那么可滚动的区域的高度就是 100 * 50。可滚动区域当前的具体高度值一般可以通过(滚动容器)元素的 scrollHeight 属性获取。用户可以通过滚动来改变列表在可视区域的显示部分。</li><li>iii. 可视区域：滚动容器元素的视觉可见区域。如果容器元素是 window 对象，可视区域就是浏览器的视口大小(即视觉视口)；如果容器元素是某个 div 元素，其高度是 300，右侧有纵向滚动条可以滚动，那么视觉可见的区域就是可视区域。</li></ul><p>&gt; 如何在只渲染少量可视元素的情况下，还能让滚动条的长度和位置显示正确呢：</p><ul><li>i. 首先明确滚动容器内容的总高度=<code>列表元素高度 * 列表元素总个数</code>，容器可视高度固定，通过设置css <code>overflow: scroll</code> 就能显示滚动条。</li><li>ii. 滚动容器的可视高度固定，那么可视区域能显示的列表元素个数=<code>容器可视高度/列表元素高度</code>，这些少量的元素不足以撑起容器元素的进行滚动，滚动容器滚动条高度仍然会为0。因此我们通过设置容器元素<code>paddingTop+paddingBottom</code>(startOffset+endOffset)来让容器元素内容总高度正确显示，这里<code>padding+可视高度=容器内容总高度</code>。</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">paddingTop:</span> `$&#123;<span class="attr">startOffset</span>&#125;<span class="attr">px</span>`,</span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">paddingBottom:</span> `$&#123;<span class="attr">endOffset</span>&#125;<span class="attr">px</span>`</span></span></span><br><span class="line"><span class="tag"><span class="xml">      &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">className</span>=<span class="string">&#x27;wrapper&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    &gt;</span></span></span><br><span class="line"><span class="xml">      &#123; /* render list */ &#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>iii. 容器能正确显示滚动高度了，那么如何让我们在滚动的时候能知道应该显示哪些元素呢？一个巧妙的方法就是根据当前滚动条的<code>scrollTop</code>(滚动容器的固有属性：表示能够向上滚动的高度值，可以直接获取)计算首个应该渲染的元素的索引<code>startIndex</code>以及最后需要渲染的元素的索引<code>endIndex</code>，然后再根据两个索引分别计算 paddingTop 和 paddingBottom 即可：<ul><li>startIndex = Math.ceil(scrollTop / 滚动容器元素总高度)</li><li>可视元素个数 = 可视区域高度 / 滚动元素高度</li><li>endIndex = startIndex + 可视区域元素个数</li><li>当前渲染元素renderItems = data.slice(startIndex, endIndex)</li><li>paddingTop = startIndex * 滚动元素高度</li><li>paddingBottom = (this.data.length - this.endIndex - 1) * 滚动元素高度</li></ul></li></ul><p>     以上为虚拟化滚动简化的描述模型，实际实现时还要考虑：缓存已经加载的列表元素的位置信息、列表元素的高度是否可变、增加缓冲元素来减少白屏情况(缓冲元素就是预加载的几个接近视口可显示元素的上下部分其它元素)、容器元素resize后的处理等。处理情况还是比较复杂，使用成熟的库处理而不是自己造轮子是比较好的方案，不过个中原理还是要理解。</p><h3 id="结语">结语</h3><p>     学习前端性能优化的方方面面，一方面是对我们核心基础知识的考察，另一方面也能为我们遇到的一些实际问题提供处理思路，是每个前端人进阶的的必经之路。</p><p>以上就是本篇文章的所有内容，后续有需要还会继续更新…</p>]]></content>
      
      
      <categories>
          
          <category> Performance </category>
          
          <category> Javascript </category>
          
          <category> HTML </category>
          
          <category> CSS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> css </tag>
            
            <tag> javascript </tag>
            
            <tag> performance </tag>
            
            <tag> html </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端123：浏览器缓存的工作方式</title>
      <link href="/blogs/2021/01/29/fec67cee.html/"/>
      <url>/blogs/2021/01/29/fec67cee.html/</url>
      
        <content type="html"><![CDATA[<p><a href="https://nojsja.gitee.io/blogs/2021/01/29/%E5%89%8D%E7%AB%AF123%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/">&gt;&gt; 博客原文 </a></p><h3 id="浏览器缓存的工作流程">浏览器缓存的工作流程</h3><hr><p>     通过网络获取内容既速度缓慢又开销巨大。较大的响应需要在客户端与服务器之间进行多次往返通信，这会延迟浏览器获得和处理内容的时间，还会增加访问者的流量费用。因此，缓存并重复利用之前获取的资源的能力成为性能优化的一个关键方面。</p><p>     这里先看张大家最熟悉的Devtools网络图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/http/network.png"  alt=""></p><p>图中青色、绿色和橙色圈出的部分分别是来自内存(memory缓存)、磁盘(disk缓存)和Http请求拿到的数据(非缓存)，还有一种返回码304的请求也是从缓存(memory/disk)中获取数据。304跟memory/disk缓存的区别是：在浏览器判断资源已经过期的情况下会去服务器查询资源是否更新，如果资源没更新则返回304码，浏览器收到304码就会更新资源的过期时间并直接从之前disk/memory缓存中拿到当前资源，换言之如果资源没过期，那么浏览器就会跳过向服务器校验资源这一步并直接去拿memory/disk缓存获取。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/http/http_cache2.png"  alt=""></p><p>大致流程如下：</p><ul><li><p>1）首先检查是否存在 Service Worker Cache，没命中或不存在则进行下一步</p></li><li><p>2）检查内存中是否存在资源，存在的话直接加载(from memory - 200)。</p></li><li><p>3）如果内存没有，择取从硬盘获取，存在且没过期的话直接加载(from disk - 200)，过期了直接向服务器发送请求获取资源。如果资源没更新，服务器返回304，浏览器从硬盘缓存中获取资源，并更新<code>过期时间/Etag/Last-Modified</code>。如果资源更新了则获取最新的资源，并通过HTTP请求将资源返回，重新缓存资源并更新<code>过期时间/Etag/Last-Modified</code>。</p></li><li><p>4）如果硬盘也没有，那么会向后端发送HTTP网络请求。</p></li><li><p>5）加载到的资源缓存到硬盘和内存，并更新资源的<code>过期时间/Etag/Last-Modified</code>。</p></li></ul><p>     <code>Service Worker Cache</code>具有较高的优先级，数据控制更为复杂，操作自由度最高；<code>Memory Cache</code>更多的强调了一种缓存存储方式和浏览器内存缓存策略；<code>HTTP Cache</code>相对于<code>Memory Cache</code>根据存储方式的不同也能叫做<code>Disk Cache</code>，它依赖于整个HTTP缓存校验流程(强缓存和协商缓存)，并通过校验来最终确定何时从缓存读取，何时从服务器更新资源；Push Cache资料较少，应用得不多，暂时只做介绍。</p><h3 id="Service-Worker-Cache-优先级最高">Service-Worker Cache(优先级最高)</h3><hr><p>     Service Worker 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能。使用 Service Worker 的话，传输协议必须为 HTTPS。因为 Service Worker 中涉及到请求拦截，所以必须使用 HTTPS 协议来保障安全。Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</p><p>     Service Worker 实现缓存功能一般分为三个步骤：首先需要先注册 Service Worker，然后监听到 install 事件以后就可以缓存需要的文件，那么在下次用户访问的时候就可以通过拦截请求的方式查询是否存在缓存，存在缓存的话就可以直接读取缓存文件，否则就去请求数据。</p><p>     当 Service Worker 没有命中缓存的时候，我们需要去调用 fetch 函数获取数据。也就是说，如果我们没有在 Service Worker 命中缓存的话，会根据缓存查找优先级去查找数据。但是不管我们是从 Memory Cache 中还是从网络请求中获取的数据，浏览器都会显示我们是从 Service Worker 中获取的内容。</p><h3 id="Memory-Cache-优先级次之">Memory Cache(优先级次之)</h3><hr><p>     Memory Cache 也就是内存中的缓存，主要包含的是当前中页面中已经获取到的资源，例如页面上已经下载的样式、脚本、图片等。读取内存中的数据肯定比磁盘快，内存缓存虽然读取高效，可是缓存持续性很短，会随着进程的释放而释放。 一旦我们关闭 Tab 页面，内存中的缓存也就被释放了。内存缓存在缓存资源时并不关心返回资源的HTTP响应头部 Cache-Control 是什么值，换句话说这是一种强依赖于浏览器本地内存管理策略的缓存方式，各个浏览器对内存缓存的处理方式也略有区别。</p><p>     Memory Cache遵循这些策略：</p><ul><li>对于大文件来说，大概率是不存储在内存中的，反之优先</li><li>当前系统内存使用率高的话，文件优先存储进硬盘</li></ul><h3 id="HTTP-Cache-优先级次之">* HTTP Cache(优先级次之)</h3><hr><p>     HTTP缓存根据工作方式分为<code>强缓存</code>和<code>协商缓存</code>，浏览器首先会判断<code>强缓存</code>是否命中，命中失败才会尝试进行<code>协商缓存</code>。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/http/http_cache.png"  alt=""></p><p>1）强缓存</p><ul><li><p>&gt; HTTP 1.0时代 - expires<br>     我们通过浏览器获取服务器远程资源时，服务器通过http请求response headers返回一个<code>expires</code>时间戳字段(上图中蓝色部分)，例如<code>expires: Wed, 13 Oct 2021 22:15:05 GMT</code>，表明这个资源的过期时间为格林威治时间<code>2021年10月13日 周三 22:15:05</code>(北京时间+8h=格林威治时间)，浏览器判断当前时间在资源过期时间之前的话，就会从缓存中去读取资源(如果缓存中存在的话)，否则会重新向服务器发送请求。<br>     expires的工作机制要求客户端时间与服务器时间误差较小，否则缓存更新策略可能在短时间不生效。</p></li><li><p>&gt; HTTP 1.1时代 - cache-control<br>     <code>cache-control: max-age</code>方式也是通过服务器返回资源时携带的response headers中的相应字段实现的，比如：<code>cache-control: max-age=31536000</code>，表明资源距浏览器接收到此资源后的31536000秒后过期。与<code>expires</code>返回的时间戳方式不同，cache-control为了避免时间误差，直接返回一个时间长度，浏览器可以根据一个本地时间差值进行精确判断。<br><code>cache-control</code>其它相关字段还有：<br>     <strong>i.</strong> <strong>public/private</strong>：在依赖各种代理的大型架构中，我们不得不考虑代理服务器的缓存问题，public 与 private 用来控制代理服务缓存是否能缓存资源。如果我们为资源设置了 public，那么它既可以被浏览器缓存，也可以被代理服务器缓存；如果我们设置了 private，则该资源只能被浏览器缓存。private 为默认值，不过在只设置s-maxage的情况下，代理缓存也能生效。<br>     <strong>ii.</strong> <strong>s-maxage</strong>：针对于代理服务器的缓存问题，此字段用于表示 cache 服务器上（比如 cache CDN）的缓存的有效时间的，只对 public 缓存有效，<code>cache-control: max-age=3600, s-maxage=31536000</code>。<br>     <strong>iii.</strong> <strong>no-cache</strong>：为资源设置了 no-cache 后，每一次发起请求都不会再去询问浏览器的缓存情况，而是直接向服务端去确认该资源是否过期，直接进行<code>协商缓存</code>。<br>     <strong>iv.</strong> <strong>no-store</strong>：不使用任何缓存策略，每次请求都直接从服务器获取，并在浏览器客户端不进行资源缓存。</p></li><li><p>&gt; cache-control 和 expires 并存<br>     cache-control的优先级更高，当cache-control与 expires同时出现时，以cache-control为准，不过考虑向下兼容性可以选择同时使用两种缓存策略。</p></li></ul><p>2）协商缓存</p><p>     协商缓存依赖于服务端与浏览器之间的通信，在第一次获取资源时浏览器会存储HTTP请求的response headers字段：Last-Modified / Etag，当强缓存未命中的时候，它的值作为浏览器和服务器通信时携带的标志位用于判断资源是否过期，如果服务器判断资源过期的话就会重新下载资源，并更新相应标志位。如果判断资源未更新的话，会返回304状态码，浏览器就会复用客户端缓存资源。</p><ul><li><p>&gt; Last-Modified 和 If-Modified-Since 方式<br>     <code>Last-Modified</code>为随服务器端HTTP响应头部返回的时间戳标志，表示一个资源最近一次被更新的时间，客户端请求资源时添加上request headers字段<code>If-Modified-Since</code>(值与Last-Modified相同)用于服务器做校验判断资源是否更新，<code>Last-Modified: Wed, 13 Jan 2021 15:34:55 GMT</code>。<br>使用 Last-Modified 存在一些弊端：<br>     <strong>i. 命中失误1：</strong> 当我们更新了服务器的某个资源文件，但其实际内容并未发生变化，其相应的资源更新时间戳会改变，浏览器端在服务端文件并未发生改变的情况下，仅仅通过时间戳这种判断方式也会导致资源被完全重新下载。<br>     <strong>ii. 命中失误2：</strong> If-Modified-Since 只能检查到以秒为最小计量单位的时间差，感知不到1s以内的文件改动的情况，这会导致一些浏览器缓存更新不及时的情况。</p></li><li><p>&gt; Etag 和 If-None-Match 方式<br>     <code>Etag</code>就是为了弥补<code>Last-Modified</code>的弊端而产生的新的协商缓存方式。Etag为随服务器端HTTP请求头部返回的资源唯一标志，例如：<code>ETag: W/&quot;2a3b-1602480f459&quot;</code>，它根据资源内容而生成，可以精确感知资源的变动情况，即使多次更新，只要内容不变，Etag值也是不会变化的。浏览器下一次请求此资源时，request headers里就会带上一个值相同的名为<code>if-None-Match</code>的字段用于服务器对此资源做对比，<code>If-None-Match: W/&quot;2a3b-1602480f459&quot;</code>。</p></li><li><p>&gt; <code>Etag</code>在感知文件变化上比<code>Last-Modified</code>更加准确，优先级也更高，不过<code>Etag</code>的生成会消耗掉部分服务器的性能，它可以作为一种辅助协商缓存方式与前者相互配合使用。当<code>Etag</code>和<code>Last-Modified</code>同时存在时，以<code>Etag</code>为准。</p></li></ul><h3 id="Push-Cache-优先级最低">Push Cache(优先级最低)</h3><hr><p>Push Cache 是指 HTTP2 在 server push 阶段存在的缓存：</p><ul><li>Push Cache 是缓存的最后一道防线。浏览器只有在 Memory Cache、HTTP Cache 和 Service Worker Cache 均未命中的情况下才会去询问 Push Cache。</li><li>Push Cache 是一种存在于会话阶段的缓存，当 session 终止时，缓存也随之释放。</li><li>不同的页面只要共享了同一个 HTTP2 连接，那么它们就可以共享同一个 Push Cache。</li></ul>]]></content>
      
      
      <categories>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解React：Fiber架构和新旧生命周期</title>
      <link href="/blogs/2021/01/25/a33739d5.html/"/>
      <url>/blogs/2021/01/25/a33739d5.html/</url>
      
        <content type="html"><![CDATA[<h3 id="➣-React-Fiber原理">➣ React Fiber原理</h3><hr><h4 id="React架构">React架构</h4><ul><li>1）Virtual DOM 层，描述页面长什么样</li><li>2）Reconciler 层，负责调用组件生命周期方法，进行Diff运算等</li><li>3）Renderer 层，根据不同的平台，渲染出相应的页面，如 ReactDOM 和 ReactNative</li></ul><h4 id="React15遗留问题">React15遗留问题</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/react/StackReconciler.jpg"  alt="StackReconciler"></p><ul><li>1）浏览器的整体渲染是多线程的，包括GUI渲染线程、JS引擎线程、事件触发线程、定时触发器线程和异步http请求线程。页面绘制和JS运算是互斥的线程，两者不能同时进行。</li><li>2）React15使用JS的函数调用栈(Stack Reconciler)递归渲染界面，因此在处理DOM元素过多的复杂页面的频繁更新时，大量同步进行的任务(树diff和页面render)会导致界面更新阻塞、事件响应延迟、动画卡顿等，因此React团队在16版本重写了React Reconciler架构。</li></ul><h4 id="React16问题解决">React16问题解决</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/react/FiberReconciler.jpg"  alt="FiberReconciler"></p><ul><li>1）<code>Fiber Reconciler</code>架构可以允许同步阻塞的任务拆分成多个小任务，每个任务占用一小段时间片，任务执行完成后判断有无空闲时间，有则继续执行下一个任务，否则将控制权交由浏览器以让浏览器去处理更高优先级的任务，等下次拿到时间片后，其它子任务继续执行。整个流程类似CPU调度逻辑，底层是使用了浏览器API<code>requestIdleCallback</code>。</li><li>2）为了实现整个Diff和Render的流程可中断和恢复，单纯的VirtualDom Tree不再满足需求，React16引入了采用单链表结构的Fiber树，如下图所示。</li><li>3）FiberReconciler架构将更新流程划分成了两个阶段：1.diff(由多个diff任务组成，任务时间片消耗完后被可被中断，中断后由requestIdleCallback再次唤醒) =&gt; 2.commit(diff完毕后拿到fiber tree更新结果触发DOM渲染，不可被中断)。左边灰色部分的树即为一颗fiber树，右边的workInProgress为中间态，它是在diff过程中自顶向下构建的树形结构，可用于断点恢复，所有工作单元都更新完成之后，生成的workInProgress树会成为新的fiber tree。</li><li>4）fiber tree中每个节点即一个工作单元，跟之前的VirtualDom树类似，表示一个虚拟DOM节点。workInProgress tree的每个fiber node都保存着diff过程中产生的effect list，它用来存放diff结果，并且底层的树节点会依次向上层merge effect list，以收集所有diff结果。注意的是如果某些节点并未更新，workInProgress tree会直接复用原fiber tree的节点(链表操作)，而有数据更新的节点会被打上tag标签。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;FiberNode&gt; : &#123;</span><br><span class="line">    stateNode,    <span class="comment">// 节点实例</span></span><br><span class="line">    child,        <span class="comment">// 子节点</span></span><br><span class="line">    sibling,      <span class="comment">// 兄弟节点</span></span><br><span class="line">    <span class="keyword">return</span>,       <span class="comment">// 父节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/react/FiberTree.png"  alt="FiberTree"></p><h3 id="➣-React新旧生命周期">➣ React新旧生命周期</h3><hr><h4 id="React16-3之前的生命周期">React16.3之前的生命周期</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/react/react-lifecycle-old.png"  alt=""></p><ol><li><p>componentWillMount()<br>此生命周期函数会在在组件挂载之前被调用，整个生命周期中只被触发一次。开发者通常用来进行一些数据的预请求操作，以减少请求发起时间，建议的替代方案是考虑放入constructor构造函数中，或者componentDidMount后；另一种情况是在在使用了外部状态管理库时，如Mobx，可以用于重置Mobx Store中的的已保存数据，替代方案是使用生命周期componentWilUnmount在组件卸载时自动执行数据清理。</p></li><li><p>componentDidMount()<br>此生命周期函数在组件被挂载之后被调用，整个生命周期中只触发一次。开发者同样可以用来进行一些数据请求的操作；除此之外也可用于添加事件订阅(需要在componentWillUnmount中取消事件订阅)；因为函数触发时dom元素已经渲染完毕，第三种使用情况是处理一些界面更新的副作用，比如使用默认数据来初始化一个echarts组件，然后在componentDidUpdate后进行echarts组件的数据更新。</p></li><li><p>componentWillReceiveProps(nextProps, nexState)<br>此生命周期发生在组件挂载之后的组件更新阶段。最常见于在一个依赖于prop属性进行组件内部state更新的非完全受控组件中，非完全受控组件即组件内部维护state更新，同时又在某个特殊条件下会采用外部传入的props来更新内部state，注意不要直接将props完全复制到state，否则应该使用完全受控组件<code>Function Component</code>，一个例子如下：</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">email</span>: <span class="built_in">this</span>.props.email &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span> <span class="attr">value</span>=<span class="string">&#123;this.state.email&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function"><span class="params">e</span> =&gt;</span> his.setState(&#123; <span class="attr">email</span>: e.target.value &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextProps.userID !== <span class="built_in">this</span>.props.userID) &#123;</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123; <span class="attr">email</span>: nextProps.email &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>shouldComponentUpdate(nextProps)<br>此生命周期发生在组件挂载之后的组件更新阶段。<br>值得注意的是子组件更新不一定是由于props或state改变引起的，也可能是父组件的其它部分更改导致父组件重渲染而使得当前子组件在props/state未改变的情况下重新渲染一次。<br>函数被调用时会被传入即将更新的<code>nextProps</code>和<code>nextState</code>对象，开发者可以通过对比前后两个props对象上与界面渲染相关的属性是否改变，再决定是否允许这次更新(return <code>true</code>表示允许执行更新，否则忽略更新，默认为<code>true</code>)。常搭配对象深比较函数用于减少界面无用渲染次数，优化性能。在一些只需要简单浅比较props变化的场景下，并且相同的state和props会渲染出相同的内容时，建议使用<code>React.PureComponnet</code>替代，在props更新时React会自动帮你进行一次浅比较，以减少不必要渲染。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">email</span>: <span class="built_in">this</span>.props.email &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span> <span class="attr">value</span>=<span class="string">&#123;this.state.email&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function"><span class="params">e</span> =&gt;</span> his.setState(&#123; <span class="attr">email</span>: e.target.value &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextProps.userID === <span class="built_in">this</span>.props.userID &amp;&amp;</span><br><span class="line">      nextState.email == <span class="built_in">this</span>.state.email</span><br><span class="line">    ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>componenetWillUpdate(newProps, newState)<br>此生命周期发生在组件挂载之后的更新阶段。当组件收到新的props或state，并且<code>shouldComponentUpdate</code>返回允许更新时，会在渲染之前调此方法，不可以在此生命周期执行<code>setState</code>。在此生命周期中开发者可以在界面实际渲染更新之前拿到最新的<code>nextProps</code>和<code>nextState</code>，从而执行一些副作用：比如触发一个事件、根据最新的props缓存一些计算数据到组件内、平滑界面元素动画等：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要搭配css属性transition使用</span></span><br><span class="line"><span class="attr">componentWillUpdate</span> : <span class="function"><span class="keyword">function</span>(<span class="params">newProps,newState</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(!newState.show)</span><br><span class="line">     $(ReactDOM.findDOMNode(<span class="built_in">this</span>.refs.elem)).css(&#123;<span class="string">&#x27;opacity&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;);</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     $(ReactDOM.findDOMNode(<span class="built_in">this</span>.refs.elem)).css(&#123;<span class="string">&#x27;opacity&#x27;</span>:<span class="string">&#x27;0&#x27;</span>&#125;);;</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">componentDidUpdate</span> : <span class="function"><span class="keyword">function</span>(<span class="params">oldProps,oldState</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(<span class="built_in">this</span>.state.show)</span><br><span class="line">     $(ReactDOM.findDOMNode(<span class="built_in">this</span>.refs.elem)).css(&#123;<span class="string">&#x27;opacity&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;);</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     $(ReactDOM.findDOMNode(<span class="built_in">this</span>.refs.elem)).css(&#123;<span class="string">&#x27;opacity&#x27;</span>:<span class="string">&#x27;0&#x27;</span>&#125;);;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>componenetDidUpdate(prevProps, prevState)<br>此生命周期发生在组件挂载之后的更新阶段，组件初次挂载不会触发。当组件的props和state改变引起界面渲染更新后，此函数会被调用，不可以在此生命周期执行<code>setState</code>。我们使用它用来执行一些副作用：比如条件式触发必要的网络请求来更新本地数据、使用render后的最新数据来调用一些外部库的执行(例子：定时器请求接口数据动态绘制echarts折线图)：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.echartsElement = echarts.init(<span class="built_in">this</span>.refs.echart);</span><br><span class="line">  <span class="built_in">this</span>.echartsElement.setOption(<span class="built_in">this</span>.props.defaultData);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; treeData &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">  <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">  optionData.series[<span class="number">0</span>].data = [treeData];</span><br><span class="line">  <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>componentWillUnmount()<br>此生命周期发生在组件卸载之前，组件生命周期中只会触发一次。开发者可以在此函数中执行一些数据清理重置、取消页面组件的事件订阅等。</li></ol><h4 id="React16-3之后的生命周期">React16.3之后的生命周期</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/react/react-lifecycle.png"  alt=""></p><p>React16.3之后React的<code>Reconciler</code>架构被重写(Reconciler用于处理生命周期钩子函数和DOM DIFF)，之前版本采用函数调用栈递归同步渲染机制即Stack Reconciler，dom的diff阶段不能被打断，所以不利于动画执行和事件响应。React团队使用Fiber Reconciler架构之后，diff阶段根据虚拟DOM节点拆分成包含多个工作任务单元(FiberNode)的Fiber树(以链表实现)，实现了Fiber任务单元之间的任意切换和任务之间的打断及恢复等等。Fiber架构下的异步渲染导致了<code>componentWillMount</code>、<code>componentWillReceiveProps</code>、<code>componentWillUpdate</code>三个生命周期在实际渲染之前可能会被调用多次，产生不可预料的调用结果，因此这三个不安全生命周期函数不建议被使用。取而代之的是使用全新的两个生命周期函数：<code>getDerivedStateFromProps</code>和<code>getSnapshotBeforeUpdate</code>。</p><ol><li><strong>getDerivedStateFromProps(nextProps, currentState)</strong></li></ol><ul><li>1）定义<br>此生命周期发生在组件初始化挂载和组件更新阶段，开发者可以用它来替代之前的<code>componentWillReceiveProps</code>生命周期，可用于根据props变化来动态设置组件内部state。<br>函数为static静态函数，因此我们无法使用<code>this</code>直接访问组件实例，也无法使用<code>this.setState</code>直接对state进行更改，以此可以看出React团队想通过React框架的API式约束来尽量减少开发者的API滥用。函数调用时会被传入即将更新的props和当前组件的state数据作为参数，我们可以通过对比处理props然后返回一个对象来触发的组件state更新，如果返回null则不更新任何内容。</li><li>2）滥用场景一：直接复制props到state上面<br>这会导致父层级重新渲染时，SimpleInput组件的state都会被重置为父组件重新传入的props，不管props是否发生了改变。如果你说使用<code>shouldComponentUpdate</code>搭配着避免这种情况可以吗？代码层面上可以，不过可能导致后期<code>shouldComponentUpdate</code>函数的数据来源混乱，任何一个prop的改变都会导致重新渲染和不正确的状态重置，维护一个可靠的<code>shouldComponentUpdate</code>会更难。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">attr</span>: <span class="string">&#x27;&#x27;</span>  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; attr: e.target.value &#125;)&#125; value=&#123;this.state.attr&#125; /&gt;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">nextProps, currentState</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 这会覆盖所有组件内的state更新！</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">attr</span>: nextProps.attr &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>3）使用场景： 在props变化后选择性修改state</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">attr</span>: <span class="string">&#x27;&#x27;</span>  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; attr: e.target.value &#125;)&#125; value=&#123;this.state.attr&#125; /&gt;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">nextProps, currentState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextProps.attr !== currentState.attr) <span class="keyword">return</span> &#123; <span class="attr">attr</span>: nextProps.attr &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可能导致的bug：在需要重置SimpleInput组件的情况下，由于<code>props.attr</code>未改变，导致组件无法正确重置状态，表现就是input输入框组件的值还是上次遗留的输入。</p><ul><li>4）优化的使用场景一：使用完全可控的组件<br>完全可控的组件即没有内部状态的功能组件，其状态的改变完全受父级props控制，这种方式需要将原本位于组件内的state和改变state的逻辑方法抽离到父级。适用于一些简单的场景，不过如果父级存在太多的子级状态管理逻辑也会使逻辑冗余复杂化。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SimpleInput</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;props.onChange&#125;</span> <span class="attr">value</span>=<span class="string">&#123;props.attr&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>5）优化的使用场景二：使用有key值的非可控的组件<br>如果我们想让组件拥有自己的状态管理逻辑，但是在适当的条件下我们又可以控制组件以新的默认值重新初始化，这里有几种方法参考：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  1. 设置一个唯一值传入作为组件重新初始化的标志</span></span><br><span class="line"><span class="comment">     通过对比属性手动让组件重新初始化</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">attr</span>: <span class="built_in">this</span>.props.attr, id=<span class="string">&quot;&quot;</span>  &#125;; <span class="comment">// 初始化默认值</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; attr: e.target.value &#125;)&#125; value=&#123;this.state.attr&#125; /&gt;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">getDerivedStateFromProps</span>(<span class="params">nextProps, currentState</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextProps.id !== currentState.id)</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">attr</span>: nextProps.attr, <span class="attr">id</span>: nextProps.id &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  2. 设置一个唯一值作为组件的key值</span></span><br><span class="line"><span class="comment">     key值改变后组件会以默认值重新初始化</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">attr</span>: <span class="built_in">this</span>.props.attr  &#125;; <span class="comment">// 初始化默认值</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; attr: e.target.value &#125;)&#125; value=&#123;this.state.attr&#125; /&gt;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;SimpleInput</span><br><span class="line">  attr=&#123;<span class="built_in">this</span>.props.attr&#125;</span><br><span class="line">  key=&#123;<span class="built_in">this</span>.props.id&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  3. 提供一个外部调用函数以供父级直接调用以重置组件状态</span></span><br><span class="line"><span class="comment">     父级通过refs来访问组件实例，拿到组件的内部方法进行调用</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleInput</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">attr</span>: <span class="built_in">this</span>.props.attr  &#125;; <span class="comment">// 初始化默认值</span></span><br><span class="line"></span><br><span class="line">  resetState = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">attr</span>: value &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; attr: e.target.value &#125;)&#125; value=&#123;this.state.attr&#125; /&gt;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;SimpleInput</span><br><span class="line">  attr=&#123;<span class="built_in">this</span>.props.attr&#125;</span><br><span class="line">  ref=&#123;<span class="built_in">this</span>.simpleInput&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li><p>componentDidMount()<br>…</p></li><li><p>shouldComponentUpdate(nextProps, nexState)<br>…</p></li><li><p><strong>getSnapshotBeforeUpdate(prevProps, prevState)</strong><br>此生命周期发生在组件初始化挂载和组件更新阶段，界面实际render之前。开发者可以拿到组件更新前的<code>prevProps</code>和<code>prevState</code>，同时也能获取到dom渲染之前的状态(比如元素宽高、滚动条长度和位置等等)。此函数的返回值会被作为<code>componentWillUpdate</code>周期函数的第三个参数传入，通过搭配<code>componentDidUpdate</code>可以完全替代之前<code>componentWillUpdate</code>部分的逻辑，见以下示例。</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScrollingList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.listRef = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getSnapshotBeforeUpdate</span>(<span class="params">prevProps, prevState</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 判断是否在list中添加新的items </span></span><br><span class="line">    <span class="comment">// 捕获滚动​​位置以便我们稍后调整滚动位置。</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps.list.length &lt; <span class="built_in">this</span>.props.list.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> list = <span class="built_in">this</span>.listRef.current;</span><br><span class="line">      <span class="keyword">return</span> list.scrollHeight - list.scrollTop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params">prevProps, prevState, snapshot</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 调整滚动位置使得这些新items不会将旧的items推出视图</span></span><br><span class="line">    <span class="comment">// snapshot是getSnapshotBeforeUpdate的返回值）</span></span><br><span class="line">    <span class="keyword">if</span> (snapshot !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> list = <span class="built_in">this</span>.listRef.current;</span><br><span class="line">      list.scrollTop = list.scrollHeight - snapshot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.listRef&#125;</span>&gt;</span>&#123;/* ...list items... */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><p><strong>componenetDidUpdate(prevProps, prevState, shot)</strong><br>此生命周期新增特性：<code>getSnapshotBeforeUpdate</code>的返回值作为此函数执行时传入的第三个参数。</p></li><li><p>componenetWillUnmount<br>…</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron多进程工具开发日记2：进程管理UI</title>
      <link href="/blogs/2020/12/18/927d467e.html/"/>
      <url>/blogs/2020/12/18/927d467e.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>文中实现的部分工具方法正处于早期/测试阶段，仍在持续优化中，仅供参考…</p></blockquote><blockquote><p>在Ubuntu20.04上进行开发/测试，可直接用于Electron项目，测试版本：Electron@8.2.0 / 9.3.5</p></blockquote><h3 id="Contents">Contents</h3><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">├── Contents (you are here!)</span><br><span class="line">│</span><br><span class="line">├── I. 前言</span><br><span class="line">├── II. 架构图</span><br><span class="line">│</span><br><span class="line">├── III.electron-re 可以用来做什么？</span><br><span class="line">│   ├── 1) 用于Electron应用</span><br><span class="line">│   └── 2) 用于Electron/Nodejs应用</span><br><span class="line">│</span><br><span class="line">├── IV.UI功能介绍</span><br><span class="line">│   ├── 主界面</span><br><span class="line">│   ├── 功能1：Kill进程</span><br><span class="line">│   ├── 功能2：一键开启DevTools</span><br><span class="line">│   ├── 功能3：查看进程日志</span><br><span class="line">│   └── 功能4：查看进程CPU/Memory占用趋势</span><br><span class="line">│</span><br><span class="line">├── V. 使用&amp;原理</span><br><span class="line">│   ├── 引入</span><br><span class="line">│   ├── 怎样捕获进程资源占用？</span><br><span class="line">│   ├── 怎样在主进程和UI之间共享数据？</span><br><span class="line">│   └── 怎样在UI窗口中绘制折线图？</span><br><span class="line">│</span><br><span class="line">├── VI. 存在的已知问题</span><br><span class="line">│</span><br><span class="line">├── VII. Next To Do</span><br><span class="line">│</span><br><span class="line">├── VIII. 几个实际使用示例</span><br><span class="line">│   ├── 1) Service/MessageChannel示例</span><br><span class="line">│   ├── 2) ChildProcessPool/ProcessHost示例</span><br><span class="line">│   └── 3) <span class="built_in">test</span>测试目录示例</span><br></pre></td></tr></table></figure><h3 id="I-前言">I. 前言</h3><hr><p>最近在做一个多文件分片并行上传模块的时候(基于Electron和React)，遇到了一些性能问题，主要体现在：前端同时添加大量文件(1000-10000)并行上传时(文件同时上传数默认为6)，在不做懒加载优化的情况下，引起了整个应用窗口的卡顿。所以针对Electron/Nodejs多进程这方面做了一些学习，尝试使用多进程架构对上传流程进行优化。</p><p>同时也编写了一个方便进行Electron/Node多进程管理和调用的工具<a href="https://github.com/nojsja/electron-re">electron-re</a>，已经发布为npm组件，可以直接安装：</p><p><a href="https://github.com/nojsja/electron-re">&gt;&gt; github地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$: npm install electron-re --save</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$: yarn add electron-re</span><br></pre></td></tr></table></figure><p>前文<a href="/blogs/2020/12/08/6d582478.html/">《Electron/Node多进程工具开发日记》</a>描述了<code>electron-re</code>的开发背景、针对的问题场景以及详细的使用方法，这篇文章不会对它的基础使用做过多说明，主要介绍新特性<code>多进程管理UI</code>的开发和使用相关。UI界面基于<code>electron-re</code>已有的<code>BrowserService/MessageChannel</code>和<code>ChildProcessPool/ProcessHost</code>基础架构驱动，使用React17 / Babel7开发，主界面：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/process-manager.main.png"  alt="process-manager.main.png"></p><h3 id="II-electron-re架构图">II. electron-re架构图</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/electron-re.png"  alt="archtecture"></p><h3 id="III-electron-re-可以用来做什么？">III. electron-re 可以用来做什么？</h3><hr><h4 id="1-用于Electron应用">1. 用于Electron应用</h4><ul><li><code>BrowserService</code></li><li><code>MessageChannel</code></li></ul><p>在Electron的一些“最佳实践”中，建议将占用cpu的代码放到渲染过程中而不是直接放在主过程中，这里先看下chromium的架构图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/chromium.jpg"  alt="archtecture"></p><p>每个渲染进程都有一个全局对象RenderProcess，用来管理与父浏览器进程的通信，同时维护着一份全局状态。浏览器进程为每个渲染进程维护一个RenderProcessHost对象，用来管理浏览器状态和与渲染进程的通信。浏览器进程和渲染进程使用Chromium的IPC系统进行通信。在chromium中，页面渲染时，UI进程需要和main process不断的进行IPC同步，若此时main process忙，则UIprocess就会在IPC时阻塞。所以如果主进程持续进行消耗CPU时间的任务或阻塞同步IO的任务的话，就会在一定程度上阻塞，从而影响主进程和各个渲染进程之间的IPC通信，IPC通信有延迟或是受阻，渲染进程窗口就会卡顿掉帧，严重的话甚至会卡住不动。</p><p>因此<code>electron-re</code>在Electron已有的<code>Main Process</code>主进程和<code>Renderer Process</code>渲染进程逻辑的基础上独立出一个单独的<code>Service</code>概念。<code>Service</code>即不需要显示界面的后台进程，它不参与UI交互，单独为主进程或其它渲染进程提供服务，它的底层实现为一个允许<code>node注入</code>和<code>remote调用</code>的渲染窗口进程。</p><p>这样就可以将代码中耗费cpu的操作(比如文件上传中维护一个数千个上传任务的队列)编写成一个单独的js文件，然后使用<code>BrowserService</code>构造函数以这个js文件的地址<code>path</code>为参数构造一个<code>Service</code>实例，从而将他们从主进程中分离。如果你说那这部分耗费cpu的操作直接放到渲染窗口进程可以嘛？这其实取决于项目自身的架构设计，以及对进程之间数据传输性能损耗和传输时间等各方面的权衡，创建一个<code>Service</code>的简单示例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> myServcie = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, path.join(__dirname, <span class="string">&#x27;path/to/app.service.js&#x27;</span>));</span><br></pre></td></tr></table></figure><p>如果使用了<code>BrowserService</code>的话，要想在主进程、渲染进程、service进程之间任意发送消息就要使用<code>electron-re</code>提供的<code>MessageChannel</code>通信工具，它的接口设计跟Electron内建的<code>ipc</code>基本一致，也是基于<code>ipc</code>通信原理来实现的，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ---- main.js ---- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="comment">// 主进程中向一个service-app发送消息</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><h4 id="2-用于Electron-Nodejs应用">2. 用于Electron/Nodejs应用</h4><ul><li><code>ChildProcessPool</code></li><li><code>ProcessHost</code></li></ul><p>此外，如果要创建一些不依赖于Electron运行时的子进程（相关参考nodejs <code>child_process</code>），可以使用<code>electron-re</code>提供的专门为nodejs运行时编写的进程池<code>ChildProcessPool</code>类。因为创建进程本身所需的开销很大，使用进程池来重复利用已经创建了的子进程，将多进程架构带来的性能效益最大化，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ChildProcessPool &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="built_in">global</span>.ipcUploadProcess = <span class="keyword">new</span> ChildProcessPool(&#123;</span><br><span class="line">  <span class="attr">path</span>: path.join(app.getAppPath(), <span class="string">&#x27;app/services/child/upload.js&#x27;</span>), <span class="attr">max</span>: <span class="number">6</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>一般情况下，在我们的子进程执行文件中(创建子进程时path参数指定的脚本)，如要想在主进程和子进程之间同步数据，可以使用<code>process.send('channel', params)</code>和<code>process.on('channel', function)</code>来实现(前提是进程以以<code>fork</code>方式创建或者手动开启了<code>ipc</code>通信)。但是这样在处理业务逻辑的同时也强迫我们去关注进程之间的通信，你需要知道子进程什么时候能处理完毕，然后再使用<code>process.send</code>再将数据返回主进程，使用方式繁琐。</p><p><code>electron-re</code>引入了<code>ProcessHost</code>的概念，我称之为&quot;进程事务中心&quot;。实际使用时在子进程执行文件中只需要将各个任务函数通过<code>ProcessHost.registry('task-name', function)</code>注册成多个被监听的事务，然后配合进程池的<code>ChildProcessPool.send('task-name', params)</code>来触发子进程事务逻辑的调用即可，<code>ChildProcessPool.send()</code>同时会返回一个Promise实例以便获取回调数据，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- 主进程中 --- */</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">global</span>.ipcUploadProcess</span><br><span class="line">  .send(<span class="string">&#x27;task1&#x27;</span>, params)</span><br><span class="line">  .then(<span class="function"><span class="params">rsp</span> =&gt;</span> <span class="built_in">console</span>.log(rsp));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- 子进程中 --- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ProcessHost &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line">ProcessHost</span><br><span class="line">  .registry(<span class="string">&#x27;task1&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="string">&#x27;task-value&#x27;</span> &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;init-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(url);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h3 id="IV-UI功能介绍">IV. UI功能介绍</h3><hr><blockquote><p>II 描述了electron-re的主要功能，基于这些功能来实现多进程监控UI面板</p></blockquote><h4 id="主界面">主界面</h4><blockquote><p>UI参考<code>electron-process-manager</code>设计</p></blockquote><p>预览图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/process-manager.main.png"  alt="process-manager.main.png"></p><p>主要功能如下：</p><ol><li><p>展示Electron应用中所有开启的进程，包括主进程、普通的渲染进程、Service进程(由electron-re引入)、ChildProcessPool创建的子进程(由electron-re引入)。</p></li><li><p>进程列表中显示各个进程进程号、进程标识、父进程号、内存占用大小、CPU占用百分比等，所有进程标识分为：main(主进程)、service(服务进程)、renderer(渲染进程)、node(进程池子进程)，点击表格头可以针对对某项进行递增/递减排序。</p></li><li><p>选中某个进程后可以Kill此进程、查看进程控制台Console数据、查看1分钟内进程CPU/内存占用趋势，如果此进程是渲染进程的话还可以通过<code>DevTools</code>按钮一键打开内置调试工具。</p></li><li><p>ChildProcessPool创建的子进程暂不支持直接打开DevTools进行调试，不过由于创建子进程时添加了<code>--inspect</code>参数，可以使用chrome的<code>chrome://inspect</code>进行远程调试。</p></li></ol><h4 id="功能1：Kill进程">功能1：Kill进程</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/kill.gif"  alt="kill.gif"></p><h4 id="功能2：一键开启DevTools">功能2：一键开启DevTools</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/devtools.gif"  alt="devtools.gif"></p><h4 id="功能3：查看进程日志">功能3：查看进程日志</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/console.gif"  alt="console.gif"></p><h4 id="功能3：查看进程CPU-Memory占用趋势">功能3：查看进程CPU/Memory占用趋势</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/trends.gif"  alt="trends.gif"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="http://nojsja.gitee.io/static-resources/images/electron-re/trends2.gif"  alt="trends2.gif"></p><h3 id="V-使用-原理">V. 使用&amp;原理</h3><hr><h4 id="引入">引入</h4><ol><li>在Electron主进程入口文件中引入：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  MessageChannel, <span class="comment">// must required in main.js even if you don&#x27;t use it</span></span><br><span class="line">  ProcessManager</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>开启进程管理窗口UI</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProcessManager.openWindow();</span><br></pre></td></tr></table></figure><h4 id="怎样捕获进程资源占用？">怎样捕获进程资源占用？</h4><p>1.使用ProcessManager监听多个进程号</p><ul><li>1）在Electron窗口创建事件中将窗口进程id放入ProcessManager监听列表</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/index.js --- */</span></span><br><span class="line">...</span><br><span class="line">app.on(<span class="string">&#x27;web-contents-created&#x27;</span>, <span class="function">(<span class="params">event, webContents</span>) =&gt;</span> &#123;</span><br><span class="line">  webContents.once(<span class="string">&#x27;did-finish-load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pid = webContents.getOSProcessId();</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="built_in">exports</span>.ProcessManager.processWindow &amp;&amp;</span><br><span class="line">      <span class="built_in">exports</span>.ProcessManager.processWindow.webContents.getOSProcessId() === pid</span><br><span class="line">    ) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exports</span>.ProcessManager.listen(pid, <span class="string">&#x27;renderer&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    webContents.once(<span class="string">&#x27;closed&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">exports</span>.ProcessManager.unlisten(<span class="built_in">this</span>.pid);</span><br><span class="line">    &#125;.bind(&#123; pid &#125;));</span><br><span class="line">      ...</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>2）在进程池fork子进程时将进程id放入监听列表</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/libs/ChildProcessPool.class.js --- */</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> &#123; fork &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildProcessPool</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; path, max=<span class="number">6</span>, cwd, env &#125;</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.event = <span class="keyword">new</span> EventEmitter();</span><br><span class="line">    <span class="built_in">this</span>.event.on(<span class="string">&#x27;fork&#x27;</span>, <span class="function">(<span class="params">pids</span>) =&gt;</span> &#123;</span><br><span class="line">      ProcessManager.listen(pids, <span class="string">&#x27;node&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.event.on(<span class="string">&#x27;unfork&#x27;</span>, <span class="function">(<span class="params">pids</span>) =&gt;</span> &#123;</span><br><span class="line">      ProcessManager.unlisten(pids);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Get a process instance from the pool */</span></span><br><span class="line">  <span class="function"><span class="title">getForkedFromPool</span>(<span class="params">id=<span class="string">&quot;default&quot;</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> forked;</span><br><span class="line">    ...</span><br><span class="line">    forked = fork(<span class="built_in">this</span>.forkedPath, ...);</span><br><span class="line">    <span class="built_in">this</span>.event.emit(<span class="string">&#x27;fork&#x27;</span>, <span class="built_in">this</span>.forked.map(<span class="function"><span class="params">fork</span> =&gt;</span> fork.pid));</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> forked;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>3）在Service进程注册时监听进程id<br><code>BrowserService</code>进程创建时会向主进程<code>MessageChannel</code>发送<code>registry</code>请求来全局注册一个Service服务，此时将进程id放入监听列表即可：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/index.js --- */</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">exports</span>.MessageChannel.event.on(<span class="string">&#x27;registry&#x27;</span>, <span class="function">(<span class="params">&#123;pid&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">exports</span>.ProcessManager.listen(pid, <span class="string">&#x27;service&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br><span class="line"><span class="built_in">exports</span>.MessageChannel.event.on(<span class="string">&#x27;unregistry&#x27;</span>, <span class="function">(<span class="params">&#123;pid&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">exports</span>.ProcessManager.unlisten(pid)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>2.使用兼容多平台的<code>pidusage</code>库每秒采集一次进程的负载数据：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/libs/ProcessManager.class.js --- */</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> pidusage = <span class="built_in">require</span>(<span class="string">&#x27;pidusage&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessManager</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.pidList = [process.pid];</span><br><span class="line">    <span class="built_in">this</span>.typeMap = &#123;</span><br><span class="line">      [process.pid]: <span class="string">&#x27;main&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* -------------- internal -------------- */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置外部库采集并发送到UI进程 */</span></span><br><span class="line">  refreshList = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.pidList.length) &#123;</span><br><span class="line">        pidusage(<span class="built_in">this</span>.pidList, <span class="function">(<span class="params">err, records</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`ProcessManager: refreshList -&gt; <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.processWindow.webContents.send(<span class="string">&#x27;process:update-list&#x27;</span>, &#123; records, <span class="attr">types</span>: <span class="built_in">this</span>.typeMap &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve([]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置定时器进行采集 */</span></span><br><span class="line">  <span class="function"><span class="title">setTimer</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.status === <span class="string">&#x27;started&#x27;</span>) <span class="keyword">return</span> <span class="built_in">console</span>.warn(<span class="string">&#x27;ProcessManager: the timer is already started!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> interval = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="built_in">this</span>.refreshList()</span><br><span class="line">        interval(<span class="built_in">this</span>.time)</span><br><span class="line">      &#125;, <span class="built_in">this</span>.time)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.status = <span class="string">&#x27;started&#x27;</span>;</span><br><span class="line">    interval()</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>3.监听进程输出来采集进程日志</p><blockquote><p>进程池创建的子进程可以通过监听<code>stdout</code>标准输出流来进行日志采集；Electron渲染窗口进程则可以通过监听<code>ipc</code>通信事件<code>console-message</code>来进行采集；</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/libs/ProcessManager.class.js --- */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessManager</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* pipe to process.stdout */</span></span><br><span class="line">  <span class="function"><span class="title">pipe</span>(<span class="params">pinstance</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pinstance.stdout) &#123;</span><br><span class="line">      pinstance.stdout.on(</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">        <span class="function">(<span class="params">trunk</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.stdout(pinstance.pid, trunk);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- src/index.js --- */</span></span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;web-contents-created&#x27;</span>, <span class="function">(<span class="params">event, webContents</span>) =&gt;</span> &#123;</span><br><span class="line">    webContents.once(<span class="string">&#x27;did-finish-load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> pid = webContents.getOSProcessId();</span><br><span class="line">      ...</span><br><span class="line">      webContents.on(<span class="string">&#x27;console-message&#x27;</span>, <span class="function">(<span class="params">e, level, msg, line, sourceid</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">exports</span>.ProcessManager.stdout(pid, msg);</span><br><span class="line">      &#125;);</span><br><span class="line">      ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h4 id="怎样在主进程和UI之间共享数据？">怎样在主进程和UI之间共享数据？</h4><blockquote><p>基于Electron原生<code>ipc</code>异步通信</p></blockquote><p>1.使用ProcessManager向UI渲染窗口发送日志数据</p><blockquote><p>每秒采集到的所有进程的console数据会被临时缓存到数组中，默认1秒钟向UI进程发送一次数据，然后清空临时数组。</p></blockquote><p>在这里需要注意的是ChildProcessPool中的子进程是通过Node.js的<code>child_process.fork()</code>方法创建的，此方法会衍生shell，且创建子进程时参数<code>stdio</code>会被指定为’pipe’，指明在子进程和父进程之间创建一个管道，从而让父进程中可以直接监听子进程对象上的 <code>stdout.on('data')</code>事件来拿到子进程的标准输出流。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/libs/ProcessManager.class.js --- */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessManager</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* pipe to process.stdout */</span></span><br><span class="line">  <span class="function"><span class="title">pipe</span>(<span class="params">pinstance</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pinstance.stdout) &#123;</span><br><span class="line">      pinstance.stdout.on(</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">        <span class="function">(<span class="params">trunk</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.stdout(pinstance.pid, trunk);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* send stdout to ui-processor */</span></span><br><span class="line">  <span class="function"><span class="title">stdout</span>(<span class="params">pid, data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.processWindow) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.callSymbol) &#123;</span><br><span class="line">        <span class="built_in">this</span>.callSymbol = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.processWindow.webContents.send(<span class="string">&#x27;process:stdout&#x27;</span>, <span class="built_in">this</span>.logs);</span><br><span class="line">          <span class="built_in">this</span>.logs = [];</span><br><span class="line">          <span class="built_in">this</span>.callSymbol = <span class="literal">false</span>;</span><br><span class="line">        &#125;, <span class="built_in">this</span>.time);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logs.push(&#123; <span class="attr">pid</span>: pid, <span class="attr">data</span>: <span class="built_in">String</span>.prototype.trim.call(data) &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.使用ProcessManager向UI渲染窗口发送进程负载信息</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- src/libs/ProcessManager.class.js --- */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessManager</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置外部库采集并发送到UI进程 */</span></span><br><span class="line">  refreshList = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.pidList.length) &#123;</span><br><span class="line">        pidusage(<span class="built_in">this</span>.pidList, <span class="function">(<span class="params">err, records</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`ProcessManager: refreshList -&gt; <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.processWindow.webContents.send(<span class="string">&#x27;process:update-list&#x27;</span>, &#123; records, <span class="attr">types</span>: <span class="built_in">this</span>.typeMap &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve([]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.UI窗口拿到数据后处理并临时存储</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ipcRenderer, remote &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  ipcRenderer.on(<span class="string">&#x27;process:update-list&#x27;</span>, <span class="function">(<span class="params">event, &#123; records, types &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;update:list&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; history &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> pid <span class="keyword">in</span> records) &#123;</span><br><span class="line">      history[pid] = history[pid] || &#123; <span class="attr">memory</span>: [], <span class="attr">cpu</span>: [] &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!records[pid]) <span class="keyword">continue</span>;</span><br><span class="line">      history[pid].memory.push(records[pid].memory);</span><br><span class="line">      history[pid].cpu.push(records[pid].cpu);</span><br><span class="line">      <span class="comment">// 存储最近的60条进程负载数据</span></span><br><span class="line">      history[pid].memory = history[pid].memory.slice(-<span class="number">60</span>); </span><br><span class="line">      history[pid].cpu = history[pid].cpu.slice(-<span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">processes</span>: records,</span><br><span class="line">      history,</span><br><span class="line">      types</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ipcRenderer.on(<span class="string">&#x27;process:stdout&#x27;</span>, <span class="function">(<span class="params">event, dataArray</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;process:stdout&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; logs &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    dataArray.forEach(<span class="function">(<span class="params">&#123; pid, data &#125;</span>)=&gt;</span> &#123;</span><br><span class="line">      logs[pid] = logs[pid] || [];</span><br><span class="line">      logs[pid].unshift(<span class="string">`[<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()&#125;</span>]: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 存储最近的1000个日志输出</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(logs).forEach(<span class="function"><span class="params">pid</span> =&gt;</span> &#123;</span><br><span class="line">      logs[pid].slice(<span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; logs &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h4 id="怎样在UI窗口中绘制折线图">怎样在UI窗口中绘制折线图</h4><p>1.注意使用React.PureComponent，会自动在属性更新进行浅比较，以减少不必要的渲染</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* *************** ProcessTrends *************** */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessTrends</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; visible, memory, cpu &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">      <span class="built_in">this</span>.uiDrawer.draw();</span><br><span class="line">      <span class="built_in">this</span>.dataDrawer.draw(cpu, memory);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">process-trends-container</span> $&#123;!<span class="attr">visible</span> ? &#x27;<span class="attr">hidden</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">progressive-show</span>&#x27; &#125;`&#125;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&quot;text-button small&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleCloseTrends&#125;</span>&gt;</span>X<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;trends-drawer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">canvas</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">width</span>=<span class="string">&#123;document.body.clientWidth</span> * <span class="attr">window.devicePixelRatio</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">height</span>=<span class="string">&#123;document.body.clientHeight</span> * <span class="attr">window.devicePixelRatio</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">id</span>=<span class="string">&quot;trendsUI&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          /&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">canvas</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">width</span>=<span class="string">&#123;document.body.clientWidth</span> * <span class="attr">window.devicePixelRatio</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">height</span>=<span class="string">&#123;document.body.clientHeight</span> * <span class="attr">window.devicePixelRatio</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">id</span>=<span class="string">&quot;trendsData&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.使用两个Canvas画布分别绘制坐标轴和折线线段</p><blockquote><p>设置两个画布相互重叠以尽可能保证静态的坐标轴不会被重复绘制，我们需要在组件挂载后初始化一个坐标轴绘制对象<code>uiDrawer</code>和一个数据折线绘制对象<code>dataDrawer</code></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.uiDrawer = <span class="keyword">new</span> UI_Drawer(<span class="string">&#x27;#trendsUI&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">xPoints</span>: <span class="number">60</span>,</span><br><span class="line">      <span class="attr">yPoints</span>: <span class="number">100</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.dataDrawer = <span class="keyword">new</span> Data_Drawer(<span class="string">&#x27;#trendsData&#x27;</span>);</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeDebouncer);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>以下是Canvas相关的基础绘制命令：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.canvas = <span class="built_in">document</span>.querySelector(selector);</span><br><span class="line"><span class="built_in">this</span>.ctx =  <span class="built_in">this</span>.canvas.getContext(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line"><span class="built_in">this</span>.ctx.strokeStyle = lineColor; <span class="comment">// 设置线段颜色</span></span><br><span class="line"><span class="built_in">this</span>.ctx.beginPath(); <span class="comment">// 创建一个新的路径</span></span><br><span class="line"><span class="built_in">this</span>.ctx.moveTo(x, y); <span class="comment">// 移动到初始坐标点(不进行绘制)</span></span><br><span class="line"><span class="built_in">this</span>.ctx.lineTo(<span class="built_in">Math</span>.floor(x), <span class="built_in">Math</span>.floor(y)); <span class="comment">// 描述从上一个坐标点到(x, y)的一条直线</span></span><br><span class="line"><span class="built_in">this</span>.ctx.stroke(); <span class="comment">// 开始绘制</span></span><br></pre></td></tr></table></figure><p>绘制类的源代码可以查看这里<a href="https://github.com/nojsja/electron-re/blob/master/src/ui/app/views/processManager/ProcessDrawer.js">Drawer</a>，大概原理是：设置Canvas画布宽度width和高度height铺满窗口，设定横纵坐标轴到边缘的padding值为30，Canvas坐标原点[0,0]为绘制区域左上角顶点。这里以绘制折线图纵轴坐标为例，纵轴表示CPU占用0%-100%或内存占用0-1GB，我们可以将纵轴划分为100个基础单位，但是纵轴坐标点不用为100个，可以设置为10个方便查看，所以每个坐标点就可以表示为<code>[0, (height-padding) - ((height-(2*padding)) / index) * 100 ]</code>，index依次等于0,10,20,30…90，其中<code>(height-padding)</code>为最下面那个坐标点位置，<code>(height-(2*padding))</code>为整个纵轴的长度。</p><h3 id="VI-存在的已知问题">VI. 存在的已知问题</h3><hr><ol><li><p>生产环境下ChildProcessPool未按预期工作<br>Electron生产环境下，如果app被安装到系统目录，那么ChildProcessPool不能按照预期工作，解决办法有：将app安装到用户目录或者把进程池用于创建子进程的脚本(通过<code>path</code>参数指定)单独放到Electron用户数据目录下(Ubuntu20.04上是<code>~/.config/[appname]</code>)。</p></li><li><p>UI界面未监听主进程Console数据<br>主进程暂未支持此功能，正在寻找解决方案。</p></li></ol><h3 id="VII-Next-To-Do">VII. Next To Do</h3><hr><ul class="contains-task-list"><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 让Service支持代码更新后自动重启</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 添加ChildProcessPool子进程调度逻辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 优化ChildProcessPool多进程console输出</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 添加可视化进程管理界面</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 增强ChildProcessPool进程池功能</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 增强ProcessHost事务中心功能</label></li></ul><h3 id="VIII-几个实际使用示例">VIII. 几个实际使用示例</h3><hr><ol><li><p><a href="https://github.com/nojsja/electronux">electronux</a> - 我的一个Electron项目，使用了 <code>BrowserService/MessageChannel</code>，并且附带了<code>ChildProcessPool/ProcessHost</code>使用demo。</p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">file-slice-upload</a> - 一个关于多文件分片并行上传的demo，使用了 <code>ChildProcessPool</code> and <code>ProcessHost</code>，基于 Electron@9.3.5开发。</p></li><li><p>也查看 <code>test</code> 目录下的测试样例文件，包含了完整的细节使用。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> node </tag>
            
            <tag> electron </tag>
            
            <tag> process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron/Node多进程工具开发日记</title>
      <link href="/blogs/2020/12/08/6d582478.html/"/>
      <url>/blogs/2020/12/08/6d582478.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>文中实现的部分工具方法正处于早期/测试阶段，仍在持续优化中，仅供参考…</p></blockquote><h3 id="Contents">Contents</h3><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">├── Contents (you are here!)</span><br><span class="line">│</span><br><span class="line">├── I. 前言</span><br><span class="line">├── II. 架构图</span><br><span class="line">│</span><br><span class="line">├── III. electron-re 可以用来做什么？</span><br><span class="line">│   ├── 1) 用于Electron应用</span><br><span class="line">│   └── 2) 用于Electron/Nodejs应用</span><br><span class="line">│</span><br><span class="line">├── IV. 说明1：Service/MessageChannel</span><br><span class="line">│   ├── Service的创建</span><br><span class="line">│   ├── Service的自动刷新</span><br><span class="line">│   ├── MessageChannel的引入</span><br><span class="line">│   ├── MessageChannel提供的方法</span><br><span class="line">│   └── 对比MessageChannel和原生ipc通信的使用</span><br><span class="line">│       ├── 1) 使用remote远程调用(原生)</span><br><span class="line">│       ├── 2) 使用ipc信号通信(原生)</span><br><span class="line">│       └── 3) 使用MessageChannel进行多向通信(扩展)</span><br><span class="line">│</span><br><span class="line">├── V. 说明2：ChildProcessPool/ProcessHost</span><br><span class="line">│   ├── 进程池的创建</span><br><span class="line">│   ├── 进程池的实例方法</span><br><span class="line">│   ├── 子进程事务中心</span><br><span class="line">│   └── 进程池和子进程事务中心的配合使用</span><br><span class="line">│       ├── 1) 主进程中使用进程池向子进程发送请求</span><br><span class="line">│       └── 2) 子进程中用事务中心处理消息</span><br><span class="line">│</span><br><span class="line">├── VI. Next To Do</span><br><span class="line">│</span><br><span class="line">├── VII. 几个实际使用示例</span><br><span class="line">│   ├── 1) Service/MessageChannel示例</span><br><span class="line">│   ├── 2) ChildProcessPool/ProcessHost示例</span><br><span class="line">│   └── 3) <span class="built_in">test</span>测试目录示例</span><br></pre></td></tr></table></figure><h3 id="I-前言">I. 前言</h3><hr><p>最近在做一个多文件分片并行上传模块的时候(基于Electron和React)，遇到了一些性能问题，主要体现在：前端同时添加大量文件(1000-10000)并行上传时(文件同时上传数默认为6)，在不做懒加载优化的情况下，引起了整个应用窗口的卡顿。所以针对Electron/Nodejs多进程这方面做了一些学习，尝试使用多进程架构对上传流程进行优化。</p><p>同时也编写了一个方便进行Electron/Node多进程管理和调用的工具<a href="https://github.com/nojsja/electron-re">electron-re</a>，已经发布为npm组件，可以直接安装：</p><p><a href="https://github.com/nojsja/electron-re">&gt;&gt; github地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$: npm install electron-re --save</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$: yarn add electron-re</span><br></pre></td></tr></table></figure><p>如果感兴趣是怎么一步一步解决性能问题的话可以查看这篇文章：<a href="https://nojsja.gitee.io/blogs/2020/08/16/%E5%9F%BA%E4%BA%8EElectron%E7%9A%84smb%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%BC%98%E5%8C%96%E6%8E%A2%E7%B4%A2/">《基于Electron的smb客户端文件上传优化探索》</a>。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_upload_now.jpg"  alt="RhinoDisk"></p><p>下面来讲讲主角=&gt; <strong>electron-re</strong></p><h3 id="II-electron-re架构图">II. electron-re架构图</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./electron-re.png"  alt="archtecture"></p><h3 id="III-electron-re-可以用来做什么？">III. electron-re 可以用来做什么？</h3><hr><h4 id="1-用于Electron应用">1. 用于Electron应用</h4><ul><li><code>BrowserService</code></li><li><code>MessageChannel</code></li></ul><p>在Electron的一些“最佳实践”中，建议将占用cpu的代码放到渲染过程中而不是直接放在主过程中，这里先看下chromium的架构图：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="chromium.jpg"  alt="chromium.jpg"></p><p>每个渲染进程都有一个全局对象RenderProcess，用来管理与父浏览器进程的通信，同时维护着一份全局状态。浏览器进程为每个渲染进程维护一个RenderProcessHost对象，用来管理浏览器状态和与渲染进程的通信。浏览器进程和渲染进程使用Chromium的IPC系统进行通信。在chromium中，页面渲染时，UI进程需要和main process不断的进行IPC同步，若此时main process忙，则UIprocess就会在IPC时阻塞。所以如果主进程持续进行消耗CPU时间的任务或阻塞同步IO的任务的话，就会在一定程度上阻塞，从而影响主进程和各个渲染进程之间的IPC通信，IPC通信有延迟或是受阻，渲染进程窗口就会卡顿掉帧，严重的话甚至会卡住不动。</p><p>因此<code>electron-re</code>在Electron已有的<code>Main Process</code>主进程和<code>Renderer Process</code>渲染进程逻辑的基础上独立出一个单独的<code>Service</code>概念。<code>Service</code>即不需要显示界面的后台进程，它不参与UI交互，单独为主进程或其它渲染进程提供服务，它的底层实现为一个允许<code>node注入</code>和<code>remote调用</code>的渲染窗口进程。</p><p>这样就可以将代码中耗费cpu的操作(比如文件上传中维护一个数千个上传任务的队列)编写成一个单独的js文件，然后使用<code>BrowserService</code>构造函数以这个js文件的地址<code>path</code>为参数构造一个<code>Service</code>实例，从而将他们从主进程中分离。如果你说那这部分耗费cpu的操作直接放到渲染窗口进程可以嘛？这其实取决于项目自身的架构设计，以及对进程之间数据传输性能损耗和传输时间等各方面的权衡，创建一个<code>Service</code>的简单示例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> myServcie = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, path.join(__dirname, <span class="string">&#x27;path/to/app.service.js&#x27;</span>));</span><br></pre></td></tr></table></figure><p>如果使用了<code>BrowserService</code>的话，要想在主进程、渲染进程、service进程之间任意发送消息就要使用<code>electron-re</code>提供的<code>MessageChannel</code>通信工具，它的接口设计跟Electron内建的<code>ipc</code>基本一致，也是基于<code>ipc</code>通信原理来实现的，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ---- main.js ---- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserService &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="comment">// 主进程中向一个service-app发送消息</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><h4 id="2-用于Electron-Nodejs应用">2. 用于Electron/Nodejs应用</h4><ul><li><code>ChildProcessPool</code></li><li><code>ProcessHost</code></li></ul><p>此外，如果要创建一些不依赖于Electron运行时的子进程（相关参考nodejs <code>child_process</code>），可以使用<code>electron-re</code>提供的专门为nodejs运行时编写的进程池<code>ChildProcessPool</code>类。因为创建进程本身所需的开销很大，使用进程池来重复利用已经创建了的子进程，将多进程架构带来的性能效益最大化，简单实例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ChildProcessPool &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="built_in">global</span>.ipcUploadProcess = <span class="keyword">new</span> ChildProcessPool(&#123;</span><br><span class="line">  <span class="attr">path</span>: path.join(app.getAppPath(), <span class="string">&#x27;app/services/child/upload.js&#x27;</span>), <span class="attr">max</span>: <span class="number">6</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>一般情况下，在我们的子进程执行文件中(创建子进程时path参数指定的脚本)，如要想在主进程和子进程之间同步数据，可以使用<code>process.send('channel', params)</code>和<code>process.on('channel', function)</code>来实现。但是这样在处理业务逻辑的同时也强迫我们去关注进程之间的通信，你需要知道子进程什么时候能处理完毕，然后再使用<code>process.send</code>再将数据返回主进程，使用方式繁琐。</p><p><code>electron-re</code>引入了<code>ProcessHost</code>的概念，我将它称之为&quot;进程事务中心&quot;。实际使用时在子进程执行文件中只需要将各个任务函数通过<code>ProcessHost.registry('task-name', function)</code>注册成多个被监听的事务，然后配合进程池的<code>ChildProcessPool.send('task-name', params)</code>来触发子进程的事务逻辑的调用即可，<code>ChildProcessPool.send()</code>同时会返回一个Promise实例以便获取回调数据，简单示例如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- 主进程中 --- */</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">global</span>.ipcUploadProcess.send(<span class="string">&#x27;task1&#x27;</span>, params);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- 子进程中 --- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ProcessHost &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line">ProcessHost</span><br><span class="line">    .registry(<span class="string">&#x27;task1&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="string">&#x27;task-value&#x27;</span> &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">    .registry(<span class="string">&#x27;init-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> fetch(url);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="IV-Service-MessageChannel">IV. Service/MessageChannel</h3><hr><p>用于Electron应用中 - Service进程分离/进程间通信</p><h4 id="BrowserService的创建">BrowserService的创建</h4><blockquote><p>需要等待app触发<code>ready</code>事件后才能开始创建Service，创建后如果立即向Service发送请求可能接收不到，需要调用<code>service.connected()</code>异步方法来等待Service准备完成，支持Promise写法。</p></blockquote><p>Electron主进程main.js文件中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* --- in electron main.js entry --- */</span></span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  BrowserService,</span><br><span class="line">  MessageChannel <span class="comment">// must required in main.js even if you don&#x27;t use it</span></span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> isInDev = process.env.NODE_ENV === <span class="string">&#x27;dev&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// after app is ready in main process</span></span><br><span class="line">app.whenReady().then(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> myService = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;path/to/app.service.js&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> myService2 = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;path/to/app2.service.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> myService.connected();</span><br><span class="line">    <span class="keyword">await</span> myService2.connected();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// open devtools in dev mode for debugging</span></span><br><span class="line">    <span class="keyword">if</span> (isInDev) myService.openDevTools();</span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="BrowserService的自动刷新">BrowserService的自动刷新</h4><blockquote><p>支持Service代码文件更新后自动刷新Service，简单设置两个配置项即可。</p></blockquote><p>1.需要声明当前运行环境为开发环境<br>2.创建Service时禁用web安全策略</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myService = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;path/to/app.service.js&#x27;</span>, &#123;</span><br><span class="line">  ...options,</span><br><span class="line">  <span class="comment">// 设置开发模式</span></span><br><span class="line">  <span class="attr">dev</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 关闭安全策略</span></span><br><span class="line">  <span class="attr">webPreferences</span>: &#123; <span class="attr">webSecurity</span>: <span class="literal">false</span> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="MessageChannel的引入">MessageChannel的引入</h4><blockquote><p>注意必须在main.js中引入，引入后会自动进行初始化。</p></blockquote><p>MessageChannel在<code>主进程/Service/渲染进程窗口</code>中的使用方式基本一致，具体请参考下文&quot;对比MessageChannel和原生ipc通信的使用&quot;。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  BrowserService,</span><br><span class="line">  MessageChannel <span class="comment">// must required in main.js even if you don&#x27;t use it</span></span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="MessageChannel提供的方法">MessageChannel提供的方法</h4><p>1.公共方法，适用于 - 主进程/渲染进程/Service</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 向一个Service发送请求 */</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;service-name&#x27;</span>, channel, params);</span><br><span class="line"><span class="comment">/* 向一个Servcie发送请求，并取得Promise实例 */</span></span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;service-name&#x27;</span>, channel, params);</span><br><span class="line"><span class="comment">/* 根据windowId/webContentsId，向渲染进程发送请求 */</span></span><br><span class="line">MessageChannel.sendTo(<span class="string">&#x27;windowId/webContentsId&#x27;</span>, channel, params);</span><br><span class="line"><span class="comment">/* 监听一个信号 */</span></span><br><span class="line">MessageChannel.on(channel, func);</span><br><span class="line"><span class="comment">/* 监听一次信号 */</span></span><br><span class="line">MessageChannel.once(channel, func);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.仅适用于 - 渲染进程/Service</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 向主进程发送消息 */</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;main&#x27;</span>, channel, params);</span><br><span class="line"><span class="comment">/* 向主进程发送消息，并取得Promise实例 */</span></span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;main&#x27;</span>, channel, params);</span><br></pre></td></tr></table></figure><p>3.仅适用于 - 主进程/Service</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  监听一个信号，调用处理函数，</span></span><br><span class="line"><span class="comment">  可以在处理函数中返回一个异步的Promise实例或直接返回数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">MessageChannel.handle(channel, processorFunc);</span><br></pre></td></tr></table></figure><h4 id="对比MessageChannel和原生ipc通信的使用">对比MessageChannel和原生ipc通信的使用</h4><blockquote><p>1/2 - 原生方法，3 - 扩展方法</p></blockquote><p>1.使用remote远程调用</p><p>remote模块为渲染进程和主进程通信提供了一种简单方法，使用remote模块, 你可以调用main进程对象的方法, 而不必显式发送进程间消息。示例如下，代码通过remote远程调用主进程的BrowserWindows创建了一个渲染进程，并加载了一个网页地址：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 渲染进程中(web端代码) */</span></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>).remote</span><br><span class="line"><span class="keyword">let</span> win = <span class="keyword">new</span> BrowserWindow(&#123; <span class="attr">width</span>: <span class="number">800</span>, <span class="attr">height</span>: <span class="number">600</span> &#125;)</span><br><span class="line">win.loadURL(<span class="string">&#x27;https://github.com&#x27;</span>)</span><br></pre></td></tr></table></figure><p>注意：remote底层是基于ipc的同步进程通信(同步=阻塞页面)，都知道Node.js的最大特性就是异步调用，非阻塞IO，因此remote调用不适用于主进程和渲染进程频繁通信以及耗时请求的情况，否则会引起严重的程序性能问题。</p><p>2.使用ipc信号通信</p><p>基于事件触发的ipc双向信号通信，渲染进程中的ipcRenderer可以监听一个事件通道，也能向主进程或其它渲染进程直接发送消息(需要知道其它渲染进程的webContentsId)，同理主进程中的ipcMain也能监听某个事件通道和向任意一个渲染进程发送消息。<br>Electron进程之间通信最常用的一系列方法，但是在向其它子进程发送消息之前需要知道目标进程的<code>webContentsId</code>或者能够直接拿到目标进程的实例，使用方式不太灵活。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 主进程 */</span></span><br><span class="line">ipcMain.on(channel, listener) <span class="comment">// 监听信道 - 异步触发</span></span><br><span class="line">ipcMain.once(channel, listener) <span class="comment">// 监听一次信道，监听器触发后即删除 - 异步触发</span></span><br><span class="line">ipcMain.handle(channel, listener) <span class="comment">// 为渲染进程的invoke函数设置对应信道的监听器</span></span><br><span class="line">ipcMain.handleOnce(channel, listener) <span class="comment">// 为渲染进程的invoke函数设置对应信道的监听器，触发后即删除监听</span></span><br><span class="line">browserWindow.webContents.send(channel, args); <span class="comment">// 显式地向某个渲染进程发送信息 - 异步触发</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 渲染进程 */</span></span><br><span class="line">ipcRenderer.on(channel, listener); <span class="comment">// 监听信道 - 异步触发</span></span><br><span class="line">ipcRenderer.once(channel, listener); <span class="comment">// 监听一次信道，监听器触发后即删除 - 异步触发</span></span><br><span class="line">ipcRenderer.sendSync(channel, args); <span class="comment">// 向主进程一个信道发送信息 - 同步触发</span></span><br><span class="line">ipcRenderer.invoke(channel, args); <span class="comment">// 向主进程一个信道发送信息 - 返回Promise对象等待触发</span></span><br><span class="line">ipcRenderer.sendTo(webContentsId, channel, ...args); <span class="comment">// 向某个渲染进程发送消息 - 异步触发</span></span><br><span class="line">ipcRenderer.sendToHost(channel, ...args) <span class="comment">// 向host页面的webview发送消息 - 异步触发</span></span><br></pre></td></tr></table></figure><p>3.使用MessageChannel进行多向通信</p><ul><li>1）main process - 主进程中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  BrowserService,</span><br><span class="line">  MessageChannel <span class="comment">// must required in main.js even if you don&#x27;t use it</span></span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> isInDev = process.env.NODE_ENV === <span class="string">&#x27;dev&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// after app is ready in main process</span></span><br><span class="line">app.whenReady().then(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> myService = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;path/to/app.service.js&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> myService2 = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;path/to/app2.service.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> myService.connected();</span><br><span class="line">    <span class="keyword">await</span> myService2.connected();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// open devtools in dev mode for debugging</span></span><br><span class="line">    <span class="keyword">if</span> (isInDev) myService.openDevTools();</span><br><span class="line">    MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span> &#125;);</span><br><span class="line">    MessageChannel.invoke(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel2&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test2&#x27;</span> &#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">    &#125;);</span><br><span class="line">    MessageChannel.on(<span class="string">&#x27;channel3&#x27;</span>, <span class="function">(<span class="params">event, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    MessageChannel.handle(<span class="string">&#x27;channel4&#x27;</span>, <span class="function">(<span class="params">event, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">res</span>: <span class="string">&#x27;channel4-res&#x27;</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>2）app.service.js - 在一个service中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; MessageChannel &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line">MessageChannel.on(<span class="string">&#x27;channel1&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">MessageChannel.handle(<span class="string">&#x27;channel2&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">response</span>: <span class="string">&#x27;channel2-response&#x27;</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel3&#x27;</span> &#125;).then(<span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel4&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel4&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><ul><li>3）app2.service.js - 在另一个service中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MessageChannel.handle(<span class="string">&#x27;channel3&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">response</span>: <span class="string">&#x27;channel3-response&#x27;</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line">MessageChannel.once(<span class="string">&#x27;channel4&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line">MessageChannel.send(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel3&#x27;</span> &#125;);</span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel4&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel4&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><ul><li>4）renderer process window - 在一个渲染窗口中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; MessageChannel &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span>&#125;);</span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test2&#x27;</span> &#125;);</span><br><span class="line">MessageChannel.send(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test3&#x27;</span> &#125;);</span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel4&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test4&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><h3 id="V-ChildProcessPool-ProcessHost">V. ChildProcessPool/ProcessHost</h3><hr><p>用于Electron和Nodejs应用中 - Node.js进程池/子进程事务中心</p><h4 id="进程池的创建">进程池的创建</h4><p>进程池基于nodejs的<code>child_process</code>模块，使用<code>fork</code>方式创建并管理多个独立的子进程。</p><p>创建进程池时提供<code>最大子进程实例个数</code>、<code>子进程执行文件路径</code>等参数即可，进程池会自动接管进程的创建和调用。外部可以通过进程池向某个子进程发送请求，而在进程池内部其实就是按照顺序依次将已经创建的多个子进程中的某一个返回给外部调用即可，从而避免了其中某个进程被过度使用。</p><p>子进程是通过懒加载方式创建的，也就是说如果只创建进程池而不对进程池发起请求调用的话，进程池将不会创建任何子进程实例。</p><p>1.参数说明</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|—— path 参数为可执行文件路径</span><br><span class="line">|—— max 指明进程池创建的最大子进程实例数量</span><br><span class="line">|—— env 为传递给子进程的环境变量</span><br></pre></td></tr></table></figure><p>2.主进程中引入进程池类，并创建进程池实例</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* main.js */</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> &#123; ChildProcessPool &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processPool = <span class="keyword">new</span> ChildProcessPool(&#123;</span><br><span class="line">  <span class="attr">path</span>: path.join(app.getAppPath(), <span class="string">&#x27;app/services/child/upload.js&#x27;</span>),</span><br><span class="line">  <span class="attr">max</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">env</span>: &#123; <span class="attr">lang</span>: <span class="built_in">global</span>.lang &#125;</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="进程池的实例方法">进程池的实例方法</h4><blockquote><p>注意task-name即一个子进程注册的任务名，指向子进程的某个函数，具体请查看下面子进程事务中心的说明</p></blockquote><p><strong>1.processPool.send(‘task-name’, params, id)</strong></p><p>向某个子进程发送消息，如果请求参数指定了id则表明需要使用之前与此id建立过映射的某个进程(id将在send调用之后自动绑定)，并期望拿到此进程的回应结果。</p><p>id的使用情况比如：我第一次调用进程池在一个子进程里设置了一些数据(子进程之间数据不共享)，第二次时想拿到之前设置的那个数据，这时候只要保持两次<code>send()</code>请求携带的id一致即可，否则将不能保证两次请求发送给了同一个子进程。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * send [Send request to a process]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>taskName [task name - necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Any]&#125;</span> </span>params [data passed to process - necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>id [the unique id bound to a process instance - not necessary]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;[Promise]&#125;</span> </span>[return a Promise instance]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="title">send</span>(<span class="params">taskName, params, givenId</span>)</span> &#123;...&#125;</span><br></pre></td></tr></table></figure><p><strong>2.processPool.sendToAll(‘task-name’, params)</strong></p><p>向进程池中的所有进程发送信号，并期望拿到所有进程返回的结果，返回的数据为一个数组。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* sendToAll [Send requests to all processes]</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>taskName [task name - necessary]</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param  <span class="type">&#123;[Any]&#125;</span> </span>params [data passed to process - necessary]</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return <span class="type">&#123;[Promise]&#125;</span> </span>[return a Promise instance]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="title">sendToAll</span>(<span class="params">taskName, params</span>)</span> &#123;...&#125;</span><br></pre></td></tr></table></figure><p><strong>3.processPool.disconnect(id)</strong></p><p>销毁进程池的子进程，如果不指定<code>id</code>调用的话就会销毁所有子进程，指定<code>id</code>参数可以单独销毁与此<code>id</code>值绑定过的某个子进程，销毁后再次调用进程池发送请求时会自动创建新的子进程。</p><p>需要注意的是<code>id</code>绑定操作是在<code>processPool.send('task-name', params, id)</code>方法调用后自动进行的。</p><p><strong>4.processPool.setMaxInstanceLimit(number)</strong></p><p>除了在创建进程池时使用<code>max</code>参数指定最大子进程实例个数，也能调用进程池的此方法来动态设置需要创建的子进程实例个数。</p><h4 id="子进程事务中心">子进程事务中心</h4><blockquote><p><code>ProcessHost</code> - 子进程事务中心，需要和ChildProcessPool协同工作，用来分离子进程通信逻辑和业务逻辑，优化子进程代码结构。</p></blockquote><p>主要功能是使用api诸如 - <code>ProcessHost.registry(taskName, func)</code>来注册多种<code>任务</code>，然后在主进程中可以直接使用进程池向某个<code>任务</code>发送请求并取得<code>Promise</code>对象以拿到进程回调返回的数据，从而避免在我们的子进程执行文件中编写代码时过度关注进程之间数据的通信。<br>如果不使用<code>进程事务管理中心</code>的话我们就需要使用<code>process.send</code>来向一个进程发送消息并在另一个进程中使用<code>process.on('message', processor)</code>处理消息。需要注意的是如果注册的<code>task</code>任务是异步的则需要返回一个Promise对象而不是直接<code>return</code>数据，实例方法如下：</p><ul><li>1）registry用于子进程向事务中心注册自己的任务(支持链式调用)</li><li>2）unregistry用于取消任务注册(支持链式调用)</li></ul><p>使用说明：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* in child process */</span></span><br><span class="line"><span class="keyword">const</span> &#123; ProcessHost &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line">ProcessHost</span><br><span class="line">  .registry(<span class="string">&#x27;test1&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;test2&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(url);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">ProcessHost</span><br><span class="line">  .unregistry(<span class="string">&#x27;test1&#x27;</span>)</span><br><span class="line">  .unregistry(<span class="string">&#x27;test2&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="进程池和子进程事务中心的配合使用">进程池和子进程事务中心的配合使用</h4><p>示例：文件分片上传中，主进程中使用进程池来发送<code>初始化分片上传</code>请求，子进程拿到请求信号处理业务然后返回</p><p><strong><a href="http://1.in">1.in</a> main processs - 主进程中</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * init [初始化上传]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>host [主机名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>username [用户名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>file [文件描述对象]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>abspath [绝对路径]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>sharename [共享名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>fragsize [分片大小]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>prefix [目标上传地址前缀]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"> <span class="function"><span class="title">init</span>(<span class="params">&#123; username, host, file, abspath, sharename, fragsize, prefix = <span class="string">&#x27;&#x27;</span> &#125;</span>)</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> date = <span class="built_in">Date</span>.now();</span><br><span class="line">   <span class="keyword">const</span> uploadId = getStringMd5(date + file.name + file.type + file.size);</span><br><span class="line">   <span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.getUploadPrepath</span><br><span class="line">       .then(<span class="function">(<span class="params">pre</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">/* 看这里看这里！look here! */</span></span><br><span class="line">         <span class="keyword">return</span> processPool.send(</span><br><span class="line">           <span class="comment">/* 进程事务名 */</span></span><br><span class="line">           <span class="string">&#x27;init-works&#x27;</span>,</span><br><span class="line">           <span class="comment">/* 携带的参数 */</span></span><br><span class="line">           &#123;</span><br><span class="line">             username, host, sharename, pre, prefix,</span><br><span class="line">             <span class="attr">size</span>: file.size, <span class="attr">name</span>: file.name, abspath, fragsize</span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="comment">/* 指定一个进程调用id */</span></span><br><span class="line">           uploadId</span><br><span class="line">         )</span><br><span class="line">       &#125;)</span><br><span class="line">     .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">       resolve(&#123;</span><br><span class="line">         <span class="attr">code</span>: rsp.error ? <span class="number">600</span> : <span class="number">200</span>,</span><br><span class="line">         <span class="attr">result</span>: rsp.result,</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">       resolve(&#123;</span><br><span class="line">         <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">         <span class="attr">result</span>: err.toString()</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>2.child.js (in child process)中使用事务管理中心处理消息</strong></p><blockquote><p>child.js即为创建进程池时传入的<code>path</code>参数所在的nodejs脚本代码，在此脚本中我们注册多个任务来处理从进程池发送过来的消息</p></blockquote><p>其中：<br>&gt; uploadStore - 主要用于在内存中维护整个文件上传列表，对上传任务列表进行增删查改操作(cpu耗时操作)<br>&gt; fileBlock - 利用FS API操作文件，比如打开某个文件的文件描述符、根据描述符和分片索引值读取一个文件的某一段Buffer数据、关闭文件描述符等等。虽然都是异步IO读写，对性能影响不大，不过为了整合整个上传处理流程也将其一同纳入子进程中管理。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./child.utils&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; readFileBlock, uploadRecordStore, unlink &#125; = utils;</span><br><span class="line"><span class="keyword">const</span> &#123; ProcessHost &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// read a file block from a path</span></span><br><span class="line"><span class="keyword">const</span> fileBlock = readFileBlock();</span><br><span class="line"><span class="comment">// maintain a shards upload queue</span></span><br><span class="line"><span class="keyword">const</span> uploadStore = uploadRecordStore();</span><br><span class="line"></span><br><span class="line"><span class="built_in">global</span>.lang = process.env.lang;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* *************** registry all tasks *************** */</span></span><br><span class="line"></span><br><span class="line">ProcessHost</span><br><span class="line">  .registry(<span class="string">&#x27;init-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> initWorks(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;upload-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uploadWorks(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/* *************** upload logic *************** */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 上传初始化工作 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWorks</span>(<span class="params">&#123;username, host, sharename, pre, prefix, name, abspath, size, fragsize &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> remotePath = path.join(pre, prefix, name);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">reso</span>) =&gt;</span> fsPromise.unlink(remotePath).then(reso).catch(reso))</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> dirs = utils.getFileDirs([path.join(prefix, name)]);</span><br><span class="line">      <span class="keyword">return</span> utils.mkdirs(pre, dirs);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> fileBlock.open(abspath, size))</span><br><span class="line">    .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRecord = &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;;</span><br><span class="line">        uploadStore.set(newRecord);</span><br><span class="line">        <span class="keyword">return</span> newRecord;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(rsp.result);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">   .then(resolve)</span><br><span class="line">   .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    reject(error.toString());</span><br><span class="line">   &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 上传分片 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uplaodWorks</span>(<span class="params"></span>)</span>&#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="VI-Next-To-Do">VI. Next To Do</h3><hr><ul class="contains-task-list"><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 让Service支持代码更新后自动重启</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 添加ChildProcessPool子进程调度逻辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 优化ChildProcessPool多进程console输出</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 添加可视化进程管理界面</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 增强ChildProcessPool进程池功能</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox"type="checkbox"> 增强ProcessHost事务中心功能</label></li></ul><h3 id="VII-几个实际使用示例">VII. 几个实际使用示例</h3><hr><ol><li><p><a href="https://github.com/nojsja/electronux">electronux</a> - 我的一个Electron项目，使用了 <code>BrowserService</code> and <code>MessageChannel</code>。</p></li><li><p><a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">file-slice-upload</a> - 一个关于多文件分片并行上传的demo，使用了 <code>ChildProcessPool</code> and <code>ProcessHost</code>，基于 Electron@9.3.5。</p></li><li><p>查看 <code>test</code> 目录下的测试样例文件，包含了完整的细节使用。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> node </tag>
            
            <tag> electron </tag>
            
            <tag> process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode探险记：递归和栈</title>
      <link href="/blogs/2020/10/25/d9a748a2.html/"/>
      <url>/blogs/2020/10/25/d9a748a2.html/</url>
      
        <content type="html"><![CDATA[<h3 id="前言">前言</h3><hr><p>最近刷LeetCode，遇到一个题目感觉挺有意思：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">描述:</span><br><span class="line">  给定一个只包含 &#x27;(&#x27; 和 &#x27;)&#x27; 的字符串，找出最长的包含有效括号的子串的长度。</span><br><span class="line"></span><br><span class="line">  示例 1:</span><br><span class="line">    输入: &quot;(()&quot;</span><br><span class="line">    输出: 2</span><br><span class="line">    解释: 最长有效括号子串为 &quot;()&quot;</span><br><span class="line"></span><br><span class="line">  示例 2:</span><br><span class="line">    输入: &quot;)()())&quot;</span><br><span class="line">    输出: 4</span><br><span class="line">    解释: 最长有效括号子串为 &quot;()()&quot;</span><br></pre></td></tr></table></figure><p>题目中让求解一串字符中所有含<code>有效括号子串</code>的最大长度，所谓有效括号示例中没说明完全，其实还有一种情况就是<code>(())()</code>括号相互包含以及并列的情况。</p><p>刚开始看到题目也是有点蒙，因为似乎不能用一般的<code>穷解法</code>来进行抽象(穷解法最佳代表：冒泡排序和选择排序，23333)，俗话说的好，遇事不绝穷举法！(其实算法优化也可以看作是让计算机以更快的时间拿到所有符合规范的结果，广义上的穷举)，这可咋个搞？</p><p>最后使用了<code>递归</code>和<code>栈</code>两种方法来解决。</p><h3 id="解题思路1：递归">解题思路1：递归</h3><hr><h4 id="递归的概念">递归的概念</h4><p>一种便于理解的心理模型是认为递归定义对对象的定义是按照“先前定义的”同类对象来定义的。例如：你怎样才能移动100个箱子？答案：你首先移动一个箱子，并记下它移动到的位置，然后再去解决较小的问题：你怎样才能移动99个箱子？最终，你的问题将变为怎样移动一个箱子，而这时你已经知道该怎么做的。</p><p>斐波那契函数属于典型的递归问题：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">0</span> || n == <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> fn(n-<span class="number">1</span>) + fn(n-<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="题目分析">题目分析</h4><ol><li>求解所有包含有效括号子串时可以从最短有效括号&quot;()&quot;开始然后同时从左括号和右括号开始自底向上往两边匹配字符串，每一次匹配之后判断有没有相邻有效括号字串，如果有就合并两个子串</li><li>由于无法预知所有匹配情况，在每次子串向外扩张匹配和合并子串时，都需要进行再次判断，需要对所有可能的子问题进行递归处理求解</li></ol><h4 id="题解图示">题解图示</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="drawio-1.png"  alt="动态规划"></p><h4 id="题解算法">题解算法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">s</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;number&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">longestValidParentheses</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> matchArray = [];</span><br><span class="line">  <span class="keyword">var</span> done = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> maxLength = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取所有()的位置索引 */</span></span><br><span class="line">  <span class="keyword">for</span> (i; i &lt; s.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (s[i] === <span class="string">&#x27;(&#x27;</span> &amp;&amp; s[i + <span class="number">1</span>] === <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">      matchArray.push([i, i + <span class="number">1</span>]);</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 合并相邻有效括号数组 */</span></span><br><span class="line">  <span class="keyword">var</span> doConcat = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> find = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; matchArray.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (matchArray[i][matchArray[i].length - <span class="number">1</span>] + <span class="number">1</span> === matchArray[i + <span class="number">1</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">        find = <span class="literal">true</span>;</span><br><span class="line">        matchArray[i] = matchArray[i].concat(matchArray[i + <span class="number">1</span>]);</span><br><span class="line">        matchArray.splice(i + <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        i--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (find) doConcat();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(!done) &#123;</span><br><span class="line">    doConcat();</span><br><span class="line">    done = <span class="literal">true</span>;</span><br><span class="line">    matchArray.map(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 经匹配括号从内至外扩张合并新的有效括号</span></span><br><span class="line">      <span class="keyword">if</span> (s[item[<span class="number">0</span>] - <span class="number">1</span>] === <span class="string">&#x27;(&#x27;</span> &amp;&amp; s[item[item.length - <span class="number">1</span>] + <span class="number">1</span>] === <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">        item.unshift(item[<span class="number">0</span>] - <span class="number">1</span>);</span><br><span class="line">        item.push(item[item.length - <span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">        done = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      maxLength = <span class="built_in">Math</span>.max(item.length, maxLength);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> maxLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="解题思路2：栈和回溯">解题思路2：栈和回溯</h3><hr><h4 id="栈的概念">栈的概念</h4><p>堆栈的基本特点：</p><ul><li>先入后出，后入先出的数据结构。</li><li>除头尾节点之外，每个元素有一个前驱，一个后继。</li></ul><h4 id="题目分析-2">题目分析</h4><ol><li><p>确定限制条件<br>一个<code>有效括号</code>子串至少需要包含左括号和右括号两个字符’()'，且多个有效括号具有<code>包含关系</code>或<code>相邻关系</code></p></li><li><p>分析限制条件<br>分析条件，<code>相邻关系</code>很好判断，只要第<code>n</code>个括号和第<code>n+1</code>个括号能匹配就满足了，已经满足匹配的字符对可以从回溯范围中去掉(剪枝)。<code>包含关系</code>诸如’((()))‘这种，其实可以借助栈这种数据后入先出的存储结构，先存储连续的’(‘，当尝试访问的下一个字符与栈顶字符’('满足匹配关系时，将栈顶字符弹出，以便判断接下来的字符与栈顶字符的匹配情况。</p></li><li><p>减少查找路径<br>在左到右搜索整个字符串的过程中，我们需要存储已经搜索过的字符，因为无法预知接下来未遍历的字符的匹配情况。但我们是不是需要存储所有已经遍历过的字符呢？不是，只需要存储<code>接下来可能形成匹配结构</code>的已遍历字符，不具有形成可匹配字符可能性的字符会被过滤掉，比如如果第一个字符是’)'，那么之后无论出现哪种括号，都无法与这个字符形成有效匹配字符了，所以这个字符就需要过滤掉。</p></li><li><p>确定回溯范围<br>以上第2点提到的用于存储已经遍历过的字符存储结构即为回溯范围，且这个回溯范围动态变化。</p></li><li><p>确定回退点<br>向右搜索选择时如果下一个字符与栈顶字符存在有效括号匹配，那么表明我们已经找到另一个匹配情况但是还可能找到更多匹配情况，所以需要回退回到上一个点(下图中执行<code>stack2.pop()</code>)，回退时根据记录的字符索引计算当前已经<code>连续匹配</code>的有效括号字符的长度，最后记录有效括号字符长度的最大值即可。</p></li></ol><h4 id="题解图示-2">题解图示</h4><ul><li>stack1 – 栈1用于存储所有遍历过的并且存在匹配可能性的左括号(回溯范围)</li><li>stack2 – 栈2用于存储所有栈顶字符的’索引值-1’</li><li>红色方块 – 连续有效字符匹配中断的情况</li><li>绿色方块 – 向回溯范围中存入的各个可回溯点</li><li>蓝色方块 – 执行回溯</li><li>MAX – 有效括号字符长度的最大值</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="drawio-2.png"  alt="动态规划"></p><h4 id="题解算法-2">题解算法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">s</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;number&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">longestValidParentheses</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> indexArray = [-<span class="number">1</span>]; <span class="comment">//动态存储左括号索引值，</span></span><br><span class="line">  <span class="keyword">var</span> maxLength = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> stack = []; <span class="comment">// 栈存储已经遍历的左括号索引</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>; <span class="comment">// 头指针</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i; i &lt; s.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (s[i] === <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">      stack.push(i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (stack.length) &#123;</span><br><span class="line">        <span class="comment">// 括号匹配的情况从栈顶弹出</span></span><br><span class="line">        tmp = stack.pop();</span><br><span class="line">        <span class="comment">// 索引数组同步弹出(至少保留一个索引)</span></span><br><span class="line">        <span class="keyword">if</span> (indexArray.length &gt; <span class="number">1</span>) indexArray.pop();</span><br><span class="line">        <span class="comment">// 栈不为空，则将栈顶索引(尾指针)存入索引数组以便之后回溯计算最大字符串长度</span></span><br><span class="line">        <span class="keyword">if</span> (stack.length) indexArray.push(stack[stack.length - <span class="number">1</span>]);</span><br><span class="line">        maxLength = <span class="built_in">Math</span>.max(maxLength, i - indexArray[indexArray.length - <span class="number">1</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 首个匹配到的字符为&#x27;)&#x27;的非法情况，重置尾指针</span></span><br><span class="line">        indexArray = [i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> maxLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="结语">结语</h3><hr><p>本题中虽然栈的解法图示很长，但是相比递归解法，时间和内存消耗都更少，时间复杂度O(n)，空间复杂度为O(2n)。</p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于deepin-wine在Ubuntu20.04上安装新版微信</title>
      <link href="/blogs/2020/10/23/c1bb33c8.html/"/>
      <url>/blogs/2020/10/23/c1bb33c8.html/</url>
      
        <content type="html"><![CDATA[<h4 id="预览">预览</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="wechat3.0.png"  alt="wechat3.0"></p><blockquote><p>操作系统：ubuntu 20.04.1 LTS (Kernel: 5.4.0-47-generic )</p></blockquote><blockquote><p>支持微信(2.9.5+)以及3.0版本</p></blockquote><h4 id="运行deepin-wine-depends-sh安装依赖">运行<code>deepin-wine-depends.sh</code>安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mkdir /tmp/deepintemp</span><br><span class="line"><span class="built_in">cd</span> /tmp/deepintemp</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine/deepin-wine_2.18-19_all.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine/deepin-wine32_2.18-19_i386.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine/deepin-wine32-preloader_2.18-19_i386.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine-helper/deepin-wine-helper_1.2deepin8_i386.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine-plugin/deepin-wine-plugin_1.0deepin2_amd64.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine-plugin-virtual/deepin-wine-plugin-virtual_1.0deepin3_all.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine-uninstaller/deepin-wine-uninstaller_0.1deepin2_i386.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/u/udis86/udis86_1.72-2_i386.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine/deepin-fonts-wine_2.18-19_all.deb</span><br><span class="line">wget http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin-wine/deepin-libwine_2.18-19_i386.deb</span><br><span class="line">wget https://mirrors.aliyun.com/deepin/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_1.5.1-2_amd64.deb</span><br><span class="line">wget https://mirrors.aliyun.com/deepin/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_1.5.1-2_i386.deb</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;准备添加32位支持&#x27;</span></span><br><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;添加成功，准备刷新apt缓存信息...&#x27;</span></span><br><span class="line">sudo apt update</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;即将开始安装...&#x27;</span></span><br><span class="line">sudo dpkg -i *.deb</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;安装完成，正在自动安装依赖...&#x27;</span></span><br><span class="line">sudo apt install -fy</span><br><span class="line"></span><br><span class="line">rm -vfr /tmp/deepintemp</span><br></pre></td></tr></table></figure><h4 id="安装deepin-wine环境">安装deepin-wine环境</h4><p>下载 <a href="https://community-packages.deepin.com/deepin/pool/main/d/deepin-wine5/">https://community-packages.deepin.com/deepin/pool/main/d/deepin-wine5/</a> 里几个deb，并安装 (备用下载链接: <a href="https://pan.baidu.com/s/1aENeezzyRrxW_b5U5e0s8w">https://pan.baidu.com/s/1aENeezzyRrxW_b5U5e0s8w</a>  密码: t2cr)</p><h4 id="建立软链接">建立软链接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo ln -s  /usr/lib/i386-linux-gnu/deepin-wine5/wine* /usr/bin/ -f</span><br></pre></td></tr></table></figure><h4 id="建立32位的wine环境">建立32位的wine环境</h4><ul><li>创建WINEPREFIX</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: WINEARCH=win32 WINEPREFIX=~/.wine wine wineboot</span><br></pre></td></tr></table></figure><ul><li>安装winetricks图形工具安装<code>msls31 msxml6 riched20 riched30 ole32</code>等dll依赖，<code>msxml6</code>下载失败时亦可手动安装：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: wget -P /tmp https://download.microsoft.com/download/e/a/f/eafb8ee7-667d-4e30-bb39-4694b5b3006f/msxml6_x86.msi</span><br><span class="line">$: wine msiexec /i /tmp/msxml6_x86.msi</span><br></pre></td></tr></table></figure><h4 id="安装新版微信-2-9-5">安装新版微信 2.9.5+</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: wine WechatSetup.exe</span><br></pre></td></tr></table></figure><h4 id="解决字体问题">解决字体问题</h4><p>从 windows 中系统盘所在的位置 <code>C:\windows\Fonts</code> 中拷贝全部的字体，<br>将拷贝的字体数据放在 ubuntu 系统中 <code>~/.wine/drive_c/windows/Fonts 中</code>.</p><h4 id="配置wineconfig">配置wineconfig</h4><p>终端运行<code>winecfg</code>，选择<code>Windows 版本：Windows 7</code></p><h4 id="创建应用程序列表启动图标">创建应用程序列表启动图标</h4><ul><li>创建Wechat启动脚本<code>wechat</code>，内容如下：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">LC_ALL=zh_CN.UTF-8 wine /home/nojsja/.wine/drive_c/Program\ Files/Tencent/WeChat/WeChat.exe &gt; $&amp;</span><br></pre></td></tr></table></figure><ul><li><p>同文件夹放入<code>wechat.png</code>作为图标</p></li><li><p>使用<a href="https://github.com/nojsja/maintenance/blob/master/code/shell/desktop/application/makeIconLink">makeIconLink</a>脚本创建启动图标，使用帮助<code>bash makeIconLink --help</code>，相关命令如下：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo makeIconLink --directory /home/nojsja/software/wechat --icon wechat.png --target wechat</span><br></pre></td></tr></table></figure><p>微信安装后使用正常，能发图片(之前的方法装新版会有大图片发不出去，一直转圈的问题)、文件，阴影框也不见了，剪贴板也好用了(可直接粘贴图片、url)</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu20.04 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>32个手撕JS，彻底摆脱初级前端</title>
      <link href="/blogs/2020/09/25/cdafcd68.html/"/>
      <url>/blogs/2020/09/25/cdafcd68.html/</url>
      
        <content type="html"><![CDATA[<p><a href="https://juejin.im/post/6875152247714480136#heading-20">32个手撕JS，彻底摆脱初级前端（面试高频）</a></p><h1>32个手撕JS，彻底摆脱初级前端（面试高频）</h1><p>作为前端开发，JS是重中之重，最近结束了面试的高峰期，基本上offer也定下来了就等开奖，趁着这个时间总结下32个手撕JS问题，这些都是高频面试题，完全理解之后定能彻底摆脱初级前端。</p><p>关于源码都紧遵规范，都可跑通MDN示例，其余的大多会涉及一些关于JS的应用题和本人面试过程</p><h2 id="01-数组扁平化">01.数组扁平化</h2><p>数组扁平化是指将一个多维数组变为一个一维数组</p><pre><code> const arr = [1, [2, [3, [4, 5]]], 6]; // =&gt; [1, 2, 3, 4, 5, 6] 复制代码</code></pre><h3 id="方法一：使用flat">方法一：使用flat()</h3><pre><code> const res1 = arr.flat(Infinity); 复制代码</code></pre><h3 id="方法二：利用正则">方法二：利用正则</h3><pre><code> const res2 = JSON.stringify(arr).replace(/\[|\]/g, '').split(','); 复制代码</code></pre><p>但数据类型都会变为字符串</p><h3 id="方法三：正则改良版本">方法三：正则改良版本</h3><pre><code> const res3 = JSON.parse('[' + JSON.stringify(arr).replace(/\[|\]/g, '') + ']'); 复制代码</code></pre><h3 id="方法四：使用reduce">方法四：使用reduce</h3><pre><code> const flatten = arr =&gt; &#123;   return arr.reduce((pre, cur) =&gt; &#123;     return pre.concat(Array.isArray(cur) ? flatten(cur) : cur);   &#125;, []) &#125; const res4 = flatten(arr); 复制代码</code></pre><h3 id="方法五：函数递归">方法五：函数递归</h3><pre><code> const res5 = []; const fn = arr =&gt; &#123;   for (let i = 0; i &lt; arr.length; i++) &#123;     if (Array.isArray(arr[i])) &#123;       fn(arr[i]);     &#125; else &#123;       res5.push(arr[i]);     &#125;   &#125; &#125; fn(arr); 复制代码</code></pre><h2 id="02-数组去重">02.数组去重</h2><pre><code> const arr = [1, 1, '1', 17, true, true, false, false, 'true', 'a', &#123;&#125;, &#123;&#125;]; // =&gt; [1, '1', 17, true, false, 'true', 'a', &#123;&#125;, &#123;&#125;] 复制代码</code></pre><h3 id="方法一：利用Set">方法一：利用Set</h3><pre><code> const res1 = Array.from(new Set(arr)); 复制代码</code></pre><h3 id="方法二：两层for循环-splice">方法二：两层for循环+splice</h3><pre><code> const unique1 = arr =&gt; &#123;   let len = arr.length;   for (let i = 0; i &lt; len; i++) &#123;     for (let j = i + 1; j &lt; len; j++) &#123;       if (arr[i] === arr[j]) &#123;         arr.splice(j, 1);         // 每删除一个树，j--保证j的值经过自加后不变。同时，len--，减少循环次数提升性能         len--;         j--;       &#125;     &#125;   &#125;   return arr; &#125; 复制代码</code></pre><h3 id="方法三：利用indexOf">方法三：利用indexOf</h3><pre><code> const unique2 = arr =&gt; &#123;   const res = [];   for (let i = 0; i &lt; arr.length; i++) &#123;     if (res.indexOf(arr[i]) === -1) res.push(arr[i]);   &#125;   return res; &#125; 复制代码</code></pre><p>当然也可以用include、filter，思路大同小异。</p><h3 id="方法四：利用include">方法四：利用include</h3><pre><code> const unique3 = arr =&gt; &#123;   const res = [];   for (let i = 0; i &lt; arr.length; i++) &#123;     if (!res.includes(arr[i])) res.push(arr[i]);   &#125;   return res; &#125; 复制代码</code></pre><h3 id="方法五：利用filter">方法五：利用filter</h3><pre><code> const unique4 = arr =&gt; &#123;   return arr.filter((item, index) =&gt; &#123;     return arr.indexOf(item) === index;   &#125;); &#125; 复制代码</code></pre><h3 id="方法六：利用Map">方法六：利用Map</h3><pre><code> const unique5 = arr =&gt; &#123;   const map = new Map();   const res = [];   for (let i = 0; i &lt; arr.length; i++) &#123;     if (!map.has(arr[i])) &#123;       map.set(arr[i], true)       res.push(arr[i]);     &#125;   &#125;   return res; &#125; 复制代码</code></pre><h2 id="03-类数组转化为数组">03.类数组转化为数组</h2><p>类数组是具有<strong>length</strong>属性，但不具有数组原型上的方法。常见的类数组有<strong>arguments</strong>、DOM操作方法返回的结果。</p><h3 id="方法一：Array-from">方法一：Array.from</h3><pre><code> Array.from(document.querySelectorAll('div')) 复制代码</code></pre><h3 id="方法二：Array-prototype-slice-call">方法二：Array.prototype.slice.call()</h3><pre><code> Array.prototype.slice.call(document.querySelectorAll('div')) 复制代码</code></pre><h3 id="方法三：扩展运算符">方法三：扩展运算符</h3><pre><code> [...document.querySelectorAll('div')] 复制代码</code></pre><h3 id="方法四：利用concat">方法四：利用concat</h3><pre><code> Array.prototype.concat.apply([], document.querySelectorAll('div')); 复制代码</code></pre><h2 id="04-Array-prototype-filter">04.Array.prototype.filter()</h2><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/804ee51d522746c3b219548d038413c2~tplv-k3u1fbpfcp-zoom-1.image"  alt=""></p><pre><code> Array.prototype.filter = function(callback, thisArg) &#123;   if (this == undefined) &#123;     throw new TypeError('this is null or not undefined');   &#125;   if (typeof callback !== 'function') &#123;     throw new TypeError(callback + 'is not a function');   &#125;   const res = [];   // 让O成为回调函数的对象传递（强制转换对象）   const O = Object(this);   // &gt;&gt;&gt;0 保证len为number，且为正整数   const len = O.length &gt;&gt;&gt; 0;   for (let i = 0; i &lt; len; i++) &#123;     // 检查i是否在O的属性（会检查原型链）     if (i in O) &#123;       // 回调函数调用传参       if (callback.call(thisArg, O[i], i, O)) &#123;         res.push(O[i]);       &#125;     &#125;   &#125;   return res; &#125; 复制代码</code></pre><p>对于<code>&gt;&gt;&gt;0</code>有疑问的：<a href="https://zhuanlan.zhihu.com/p/100790268">解释&gt;&gt;&gt;0的作用</a></p><h2 id="05-Array-prototype-map">05.Array.prototype.map()</h2><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b099cf3e06bc4421abac4dc460a13c17~tplv-k3u1fbpfcp-zoom-1.image"  alt=""></p><pre><code> Array.prototype.map = function(callback, thisArg) &#123;   if (this == undefined) &#123;     throw new TypeError('this is null or not defined');   &#125;   if (typeof callback !== 'function') &#123;     throw new TypeError(callback + ' is not a function');   &#125;   const res = [];   // 同理   const O = Object(this);   const len = O.length &gt;&gt;&gt; 0;   for (let i = 0; i &lt; len; i++) &#123;     if (i in O) &#123;       // 调用回调函数并传入新数组       res[i] = callback.call(thisArg, O[i], i, this);     &#125;   &#125;   return res; &#125; 复制代码</code></pre><h2 id="06-Array-prototype-forEach">06.Array.prototype.forEach()</h2><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c3819fb0c404ae5a8f4cddc4e80731e~tplv-k3u1fbpfcp-zoom-1.image"  alt=""></p><p><code>forEach</code>跟map类似，唯一不同的是<code>forEach</code>是没有返回值的。</p><pre><code> Array.prototype.forEach = function(callback, thisArg) &#123;   if (this == null) &#123;     throw new TypeError('this is null or not defined');   &#125;   if (typeof callback !== &quot;function&quot;) &#123;     throw new TypeError(callback + ' is not a function');   &#125;   const O = Object(this);   const len = O.length &gt;&gt;&gt; 0;   let k = 0;   while (k &lt; len) &#123;     if (k in O) &#123;       callback.call(thisArg, O[k], k, O);     &#125;     k++;   &#125; &#125; 复制代码</code></pre><h2 id="07-Array-prototype-reduce">07.Array.prototype.reduce()</h2><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e51625eb9e2d47799ff39c5956139af7~tplv-k3u1fbpfcp-zoom-1.image"  alt=""></p><pre><code> Array.prototype.reduce = function(callback, initialValue) &#123;   if (this == undefined) &#123;     throw new TypeError('this is null or not defined');   &#125;   if (typeof callback !== 'function') &#123;     throw new TypeError(callbackfn + ' is not a function');   &#125;   const O = Object(this);   const len = this.length &gt;&gt;&gt; 0;   let accumulator = initialValue;   let k = 0;   // 如果第二个参数为undefined的情况下   // 则数组的第一个有效值作为累加器的初始值   if (accumulator === undefined) &#123;     while (k &lt; len &amp;&amp; !(k in O)) &#123;       k++;     &#125;     // 如果超出数组界限还没有找到累加器的初始值，则TypeError     if (k &gt;= len) &#123;       throw new TypeError('Reduce of empty array with no initial value');     &#125;     accumulator = O[k++];   &#125;   while (k &lt; len) &#123;     if (k in O) &#123;       accumulator = callback.call(undefined, accumulator, O[k], k, O);     &#125;     k++;   &#125;   return accumulator; &#125; 复制代码</code></pre><h2 id="08-Function-prototype-apply">08.Function.prototype.apply()</h2><p>第一个参数是绑定的this，默认为<code>window</code>，第二个参数是数组或类数组</p><pre><code> Function.prototype.apply = function(context = window, args) &#123;   if (typeof this !== 'function') &#123;     throw new TypeError('Type Error');   &#125;   const fn = Symbol('fn');   context[fn] = this;    const res = context[fn](...args);   delete context[fn];   return res; &#125; 复制代码</code></pre><h2 id="09-Function-prototype-call">09.Function.prototype.call</h2><p>于<code>call</code>唯一不同的是，<code>call()</code>方法接受的是一个参数列表</p><pre><code> Function.prototype.call = function(context = window, ...args) &#123;   if (typeof this !== 'function') &#123;     throw new TypeError('Type Error');   &#125;   const fn = Symbol('fn');   context[fn] = this;    const res = this[fn](...args);   delete this.fn;   return res; &#125; 复制代码</code></pre><h2 id="10-Function-prototype-bind">10.Function.prototype.bind</h2><pre><code> Function.prototype.bind = function(context, ...args) &#123;   if (typeof this !== 'function') &#123;     throw new Error(&quot;Type Error&quot;);   &#125;   // 保存this的值   var self = this;    return function F() &#123;     // 考虑new的情况     if(this instanceof F) &#123;       return new self(...args, ...arguments)     &#125;     return self.apply(context, [...args, ...arguments])   &#125; &#125; 复制代码</code></pre><h2 id="11-debounce（防抖）">11.debounce（防抖）</h2><p>触发高频时间后n秒内函数只会执行一次,如果n秒内高频时间再次触发,则重新计算时间。</p><pre><code> const debounce = (fn, time) =&gt; &#123;   let timeout = null;   return function() &#123;     clearTimeout(timeout)     timeout = setTimeout(() =&gt; &#123;       fn.apply(this, arguments);     &#125;, time);   &#125; &#125;; 复制代码</code></pre><p>防抖常应用于用户进行搜索输入节约请求资源，<code>window</code>触发<code>resize</code>事件时进行防抖只触发一次。</p><h2 id="12-throttle（节流）">12.throttle（节流）</h2><p>高频时间触发,但n秒内只会执行一次,所以节流会稀释函数的执行频率。</p><pre><code> const throttle = (fn, time) =&gt; &#123;   let flag = true;   return function() &#123;     if (!flag) return;     flag = false;     setTimeout(() =&gt; &#123;       fn.apply(this, arguments);       flag = true;     &#125;, time);   &#125; &#125; 复制代码</code></pre><p>节流常应用于鼠标不断点击触发、监听滚动事件。</p><h2 id="13-函数珂里化">13.函数珂里化</h2><blockquote><p>指的是将一个接受多个参数的函数 变为 接受一个参数返回一个函数的固定形式，这样便于再次调用，例如f(1)(2)</p></blockquote><p>经典面试题：实现<code>add(1)(2)(3)(4)=10;</code> 、 <code>add(1)(1,2,3)(2)=9;</code></p><pre><code> function add() &#123;   const _args = [...arguments];   function fn() &#123;     _args.push(...arguments);     return fn;   &#125;   fn.toString = function() &#123;     return _args.reduce((sum, cur) =&gt; sum + cur);   &#125;   return fn; &#125; 复制代码</code></pre><h2 id="14-模拟new操作">14.模拟new操作</h2><p>3个步骤：</p><ol><li><p>以<code>ctor.prototype</code>为原型创建一个对象。</p></li><li><p>执行构造函数并将this绑定到新创建的对象上。</p></li><li><p>判断构造函数执行返回的结果是否是引用数据类型，若是则返回构造函数执行的结果，否则返回创建的对象。</p><p>function newOperator(ctor, …args) {<br>if (typeof ctor !== ‘function’) {<br>throw new TypeError(‘Type Error’);<br>}<br>const obj = Object.create(ctor.prototype);<br>const res = ctor.apply(obj, args);</p><p>const isObject = typeof res === ‘object’ &amp;&amp; res !== null;<br>const isFunction = typeof res === ‘function’;<br>return isObject || isFunction ? res : obj;<br>}<br>复制代码</p></li></ol><h2 id="15-instanceof">15.instanceof</h2><p><code>instanceof</code>运算符用于检测构造函数的<code>prototype</code>属性是否出现在某个实例对象的原型链上。</p><pre><code> const myInstanceof = (left, right) =&gt; &#123;   // 基本数据类型都返回false   if (typeof left !== 'object' || left === null) return false;   let proto = Object.getPrototypeOf(left);   while (true) &#123;     if (proto === null) return false;     if (proto === right.prototype) return true;     proto = Object.getPrototypeOf(proto);   &#125; &#125; 复制代码</code></pre><h2 id="16-原型继承">16.原型继承</h2><p>这里只写寄生组合继承了，中间还有几个演变过来的继承但都有一些缺陷</p><pre><code> function Parent() &#123;   this.name = 'parent'; &#125; function Child() &#123;   Parent.call(this);   this.type = 'children'; &#125; Child.prototype = Object.create(Parent.prototype); Child.prototype.constructor = Child; 复制代码</code></pre><h2 id="17-Object-is"><a href="http://17.Object.is">17.Object.is</a></h2><p><code>Object.is</code>解决的主要是这两个问题：</p><pre><code> +0 === -0  // true NaN === NaN // false 复制代码 const is= (x, y) =&gt; &#123;   if (x === y) &#123;     // +0和-0应该不相等     return x !== 0 || y !== 0 || 1/x === 1/y;   &#125; else &#123;     return x !== x &amp;&amp; y !== y;   &#125; &#125; 复制代码</code></pre><h2 id="18-Object-assign">18.Object.assign</h2><p><code>Object.assign()</code>方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象（请注意这个操作是浅拷贝）</p><pre><code> Object.defineProperty(Object, 'assign', &#123;   value: function(target, ...args) &#123;     if (target == null) &#123;       return new TypeError('Cannot convert undefined or null to object');     &#125;          // 目标对象需要统一是引用数据类型，若不是会自动转换     const to = Object(target);      for (let i = 0; i &lt; args.length; i++) &#123;       // 每一个源对象       const nextSource = args[i];       if (nextSource !== null) &#123;         // 使用for...in和hasOwnProperty双重判断，确保只拿到本身的属性、方法（不包含继承的）         for (const nextKey in nextSource) &#123;           if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) &#123;             to[nextKey] = nextSource[nextKey];           &#125;         &#125;       &#125;     &#125;     return to;   &#125;,   // 不可枚举   enumerable: false,   writable: true,   configurable: true, &#125;) 复制代码</code></pre><h2 id="19-深拷贝">19.深拷贝</h2><p>递归的完整版本（考虑到了Symbol属性）：</p><pre><code> const cloneDeep1 = (target, hash = new WeakMap()) =&gt; &#123;   // 对于传入参数处理   if (typeof target !== 'object' || target === null) &#123;     return target;   &#125;   // 哈希表中存在直接返回   if (hash.has(target)) return hash.get(target);    const cloneTarget = Array.isArray(target) ? [] : &#123;&#125;;   hash.set(target, cloneTarget);    // 针对Symbol属性   const symKeys = Object.getOwnPropertySymbols(target);   if (symKeys.length) &#123;     symKeys.forEach(symKey =&gt; &#123;       if (typeof target[symKey] === 'object' &amp;&amp; target[symKey] !== null) &#123;         cloneTarget[symKey] = cloneDeep1(target[symKey]);       &#125; else &#123;         cloneTarget[symKey] = target[symKey];       &#125;     &#125;)   &#125;    for (const i in target) &#123;     if (Object.prototype.hasOwnProperty.call(target, i)) &#123;       cloneTarget[i] =         typeof target[i] === 'object' &amp;&amp; target[i] !== null         ? cloneDeep1(target[i], hash)         : target[i];     &#125;   &#125;   return cloneTarget; &#125; 复制代码</code></pre><h2 id="20-Promise">20.Promise</h2><p>实现思路：<a href="https://juejin.im/post/6860037916622913550">Promise源码实现</a></p><pre><code> const PENDING = 'PENDING';      // 进行中 const FULFILLED = 'FULFILLED';  // 已成功 const REJECTED = 'REJECTED';    // 已失败  class Promise &#123;   constructor(exector) &#123;     // 初始化状态     this.status = PENDING;     // 将成功、失败结果放在this上，便于then、catch访问     this.value = undefined;     this.reason = undefined;     // 成功态回调函数队列     this.onFulfilledCallbacks = [];     // 失败态回调函数队列     this.onRejectedCallbacks = [];      const resolve = value =&gt; &#123;       // 只有进行中状态才能更改状态       if (this.status === PENDING) &#123;         this.status = FULFILLED;         this.value = value;         // 成功态函数依次执行         this.onFulfilledCallbacks.forEach(fn =&gt; fn(this.value));       &#125;     &#125;     const reject = reason =&gt; &#123;       // 只有进行中状态才能更改状态       if (this.status === PENDING) &#123;         this.status = REJECTED;         this.reason = reason;         // 失败态函数依次执行         this.onRejectedCallbacks.forEach(fn =&gt; fn(this.reason))       &#125;     &#125;     try &#123;       // 立即执行executor       // 把内部的resolve和reject传入executor，用户可调用resolve和reject       exector(resolve, reject);     &#125; catch(e) &#123;       // executor执行出错，将错误内容reject抛出去       reject(e);     &#125;   &#125;   then(onFulfilled, onRejected) &#123;     onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value =&gt; value;     onRejected = typeof onRejected === 'function'? onRejected:       reason =&gt; &#123; throw new Error(reason instanceof Error ? reason.message:reason) &#125;     // 保存this     const self = this;     return new Promise((resolve, reject) =&gt; &#123;       if (self.status === PENDING) &#123;         self.onFulfilledCallbacks.push(() =&gt; &#123;           // try捕获错误           try &#123;             // 模拟微任务             setTimeout(() =&gt; &#123;               const result = onFulfilled(self.value);               // 分两种情况：               // 1. 回调函数返回值是Promise，执行then操作               // 2. 如果不是Promise，调用新Promise的resolve函数               result instanceof Promise ? result.then(resolve, reject) : resolve(result);             &#125;)           &#125; catch(e) &#123;             reject(e);           &#125;         &#125;);         self.onRejectedCallbacks.push(() =&gt; &#123;           // 以下同理           try &#123;             setTimeout(() =&gt; &#123;               const result = onRejected(self.reason);               // 不同点：此时是reject               result instanceof Promise ? result.then(resolve, reject) : reject(result);             &#125;)           &#125; catch(e) &#123;             reject(e);           &#125;         &#125;)       &#125; else if (self.status === FULFILLED) &#123;         try &#123;           setTimeout(() =&gt; &#123;             const result = onFulfilled(self.value);             result instanceof Promise ? result.then(resolve, reject) : resolve(result);           &#125;);         &#125; catch(e) &#123;           reject(e);         &#125;       &#125; else if (self.status === REJECTED)&#123;         try &#123;           setTimeout(() =&gt; &#123;             const result = onRejected(self.reason);             result instanceof Promise ? result.then(resolve, reject) : reject(result);           &#125;)         &#125; catch(e) &#123;           reject(e);         &#125;       &#125;     &#125;);   &#125;   catch(onRejected) &#123;     return this.then(null, onRejected);   &#125;   static resolve(value) &#123;     if (value instanceof Promise) &#123;       // 如果是Promise实例，直接返回       return value;     &#125; else &#123;       // 如果不是Promise实例，返回一个新的Promise对象，状态为FULFILLED       return new Promise((resolve, reject) =&gt; resolve(value));     &#125;   &#125;   static reject(reason) &#123;     return new Promise((resolve, reject) =&gt; &#123;       reject(reason);     &#125;)   &#125; &#125; 复制代码</code></pre><h2 id="21-Promise-all">21.Promise.all</h2><p><code>Promise.all</code>是支持链式调用的，本质上就是返回了一个Promise实例，通过<code>resolve</code>和<code>reject</code>来改变实例状态。</p><pre><code> Promise.myAll = function(promiseArr) &#123;   return new Promise((resolve, reject) =&gt; &#123;     const ans = [];     let index = 0;     for (let i = 0; i &lt; promiseArr.length; i++) &#123;       promiseArr[i]       .then(res =&gt; &#123;         ans[i] = res;         index++;         if (index === promiseArr.length) &#123;           resolve(ans);         &#125;       &#125;)       .catch(err =&gt; reject(err));     &#125;   &#125;) &#125; 复制代码</code></pre><h2 id="22-Promise-race">22.Promise.race</h2><pre><code> Promise.race = function(promiseArr) &#123;   return new Promise((resolve, reject) =&gt; &#123;     promiseArr.forEach(p =&gt; &#123;       // 如果不是Promise实例需要转化为Promise实例       Promise.resolve(p).then(         val =&gt; resolve(val),         err =&gt; reject(err),       )     &#125;)   &#125;) &#125; 复制代码</code></pre><h2 id="23-Promise并行限制">23.Promise并行限制</h2><p>就是实现有并行限制的Promise调度器问题。</p><p>详细实现思路：<a href="https://juejin.im/post/6854573217013563405">某条高频面试原题：实现有并行限制的Promise调度器</a></p><pre><code> class Scheduler &#123;   constructor() &#123;     this.queue = [];     this.maxCount = 2;     this.runCounts = 0;   &#125;   add(promiseCreator) &#123;     this.queue.push(promiseCreator);   &#125;   taskStart() &#123;     for (let i = 0; i &lt; this.maxCount; i++) &#123;       this.request();     &#125;   &#125;   request() &#123;     if (!this.queue || !this.queue.length || this.runCounts &gt;= this.maxCount) &#123;       return;     &#125;     this.runCounts++;      this.queue.shift()().then(() =&gt; &#123;       this.runCounts--;       this.request();     &#125;);   &#125; &#125;     const timeout = time =&gt; new Promise(resolve =&gt; &#123;   setTimeout(resolve, time); &#125;)    const scheduler = new Scheduler();    const addTask = (time,order) =&gt; &#123;   scheduler.add(() =&gt; timeout(time).then(()=&gt;console.log(order))) &#125;       addTask(1000, '1'); addTask(500, '2'); addTask(300, '3'); addTask(400, '4'); scheduler.taskStart() // 2 // 3 // 1 // 4 复制代码</code></pre><h2 id="24-JSONP">24.JSONP</h2><p>script标签不遵循同源协议，可以用来进行<strong>跨域请求</strong>，优点就是兼容性好但仅限于GET请求</p><pre><code> const jsonp = (&#123; url, params, callbackName &#125;) =&gt; &#123;   const generateUrl = () =&gt; &#123;     let dataSrc = '';     for (let key in params) &#123;       if (Object.prototype.hasOwnProperty.call(params, key)) &#123;         dataSrc += `$&#123;key&#125;=$&#123;params[key]&#125;&amp;`;       &#125;     &#125;     dataSrc += `callback=$&#123;callbackName&#125;`;     return `$&#123;url&#125;?$&#123;dataSrc&#125;`;   &#125;   return new Promise((resolve, reject) =&gt; &#123;     const scriptEle = document.createElement('script');     scriptEle.src = generateUrl();     document.body.appendChild(scriptEle);     window[callbackName] = data =&gt; &#123;       resolve(data);       document.removeChild(scriptEle);     &#125;   &#125;) &#125; 复制代码</code></pre><h2 id="25-AJAX">25.AJAX</h2><pre><code> const getJSON = function(url) &#123;   return new Promise((resolve, reject) =&gt; &#123;     const xhr = XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Mscrosoft.XMLHttp');     xhr.open('GET', url, false);     xhr.setRequestHeader('Accept', 'application/json');     xhr.onreadystatechange = function() &#123;       if (xhr.readyState !== 4) return;       if (xhr.status === 200 || xhr.status === 304) &#123;         resolve(xhr.responseText);       &#125; else &#123;         reject(new Error(xhr.responseText));       &#125;     &#125;     xhr.send();   &#125;) &#125; 复制代码</code></pre><h2 id="26-event模块">26.event模块</h2><p>实现node中回调函数的机制，node中回调函数其实是内部使用了<strong>观察者模式</strong>。</p><blockquote><p>观察者模式：定义了对象间一种一对多的依赖关系，当目标对象Subject发生改变时，所有依赖它的对象Observer都会得到通知。</p></blockquote><pre><code> function EventEmitter() &#123;   this.events = new Map(); &#125;  // 需要实现的一些方法： // addListener、removeListener、once、removeAllListeners、emit  // 模拟实现addlistener方法 const wrapCallback = (fn, once = false) =&gt; (&#123; callback: fn, once &#125;); EventEmitter.prototype.addListener = function(type, fn, once = false) &#123;   const hanlder = this.events.get(type);   if (!hanlder) &#123;     // 没有type绑定事件     this.events.set(type, wrapCallback(fn, once));   &#125; else if (hanlder &amp;&amp; typeof hanlder.callback === 'function') &#123;     // 目前type事件只有一个回调     this.events.set(type, [hanlder, wrapCallback(fn, once)]);   &#125; else &#123;     // 目前type事件数&gt;=2     hanlder.push(wrapCallback(fn, once));   &#125; &#125; // 模拟实现removeListener EventEmitter.prototype.removeListener = function(type, listener) &#123;   const hanlder = this.events.get(type);   if (!hanlder) return;   if (!Array.isArray(this.events)) &#123;     if (hanlder.callback === listener.callback) this.events.delete(type);     else return;   &#125;   for (let i = 0; i &lt; hanlder.length; i++) &#123;     const item = hanlder[i];     if (item.callback === listener.callback) &#123;       hanlder.splice(i, 1);       i--;       if (hanlder.length === 1) &#123;         this.events.set(type, hanlder[0]);       &#125;     &#125;   &#125; &#125; // 模拟实现once方法 EventEmitter.prototype.once = function(type, listener) &#123;   this.addListener(type, listener, true); &#125; // 模拟实现emit方法 EventEmitter.prototype.emit = function(type, ...args) &#123;   const hanlder = this.events.get(type);   if (!hanlder) return;   if (Array.isArray(hanlder)) &#123;     hanlder.forEach(item =&gt; &#123;       item.callback.apply(this, args);       if (item.once) &#123;         this.removeListener(type, item);       &#125;     &#125;)   &#125; else &#123;     hanlder.callback.apply(this, args);     if (hanlder.once) &#123;       this.events.delete(type);     &#125;   &#125;   return true; &#125; EventEmitter.prototype.removeAllListeners = function(type) &#123;   const hanlder = this.events.get(type);   if (!hanlder) return;   this.events.delete(type); &#125; 复制代码</code></pre><h2 id="27-图片懒加载">27.图片懒加载</h2><p>可以给img标签统一自定义属性<code>data-src='default.png'</code>，当检测到图片出现在窗口之后再补充<strong>src</strong>属性，此时才会进行图片资源加载。</p><pre><code> function lazyload() &#123;   const imgs = document.getElementsByTagName('img');   const len = imgs.length;   // 视口的高度   const viewHeight = document.documentElement.clientHeight;   // 滚动条高度   const scrollHeight = document.documentElement.scrollTop || document.body.scrollTop;   for (let i = 0; i &lt; len; i++) &#123;     const offsetHeight = imgs[i].offsetTop;     if (offsetHeight &lt; viewHeight + scrollHeight) &#123;       const src = imgs[i].dataset.src;       imgs[i].src = src;     &#125;   &#125; &#125;  // 可以使用节流优化一下 window.addEventListener('scroll', lazyload); 复制代码</code></pre><h2 id="28-滚动加载">28.滚动加载</h2><p>原理就是监听页面滚动事件，<strong>分析clientHeight</strong>、<strong>scrollTop</strong>、<strong>scrollHeight</strong>三者的属性关系。</p><pre><code> window.addEventListener('scroll', function() &#123;   const clientHeight = document.documentElement.clientHeight;   const scrollTop = document.documentElement.scrollTop;   const scrollHeight = document.documentElement.scrollHeight;   if (clientHeight + scrollTop &gt;= scrollHeight) &#123;     // 检测到滚动至页面底部，进行后续操作     // ...   &#125; &#125;, false); 复制代码</code></pre><p>一个Demo：<a href="https://github.com/SherrybabyOne/Demos/blob/master/Interview/JavaScript/%E6%BB%9A%E5%8A%A8%E5%8A%A0%E8%BD%BD.html">页面滚动加载的Demo</a></p><h2 id="29-渲染几万条数据不卡住页面">29.渲染几万条数据不卡住页面</h2><p>渲染大数据时，合理使用<strong>createDocumentFragment</strong>和<strong>requestAnimationFrame</strong>，将操作切分为一小段一小段执行。</p><pre><code> setTimeout(() =&gt; &#123;   // 插入十万条数据   const total = 100000;   // 一次插入的数据   const once = 20;   // 插入数据需要的次数   const loopCount = Math.ceil(total / once);   let countOfRender = 0;   const ul = document.querySelector('ul');   // 添加数据的方法   function add() &#123;     const fragment = document.createDocumentFragment();     for(let i = 0; i &lt; once; i++) &#123;       const li = document.createElement('li');       li.innerText = Math.floor(Math.random() * total);       fragment.appendChild(li);     &#125;     ul.appendChild(fragment);     countOfRender += 1;     loop();   &#125;   function loop() &#123;     if(countOfRender &lt; loopCount) &#123;       window.requestAnimationFrame(add);     &#125;   &#125;   loop(); &#125;, 0) 复制代码</code></pre><h2 id="30-打印出当前网页使用了多少种HTML元素">30.打印出当前网页使用了多少种HTML元素</h2><p>一行代码可以解决：</p><pre><code> const fn = () =&gt; &#123;   return [...new Set([...document.querySelectorAll('*')].map(el =&gt; el.tagName))].length; &#125; 复制代码</code></pre><p>值得注意的是：DOM操作返回的是<strong>类数组</strong>，需要转换为数组之后才可以调用数组的方法。</p><h2 id="31-将VirtualDom转化为真实DOM结构">31.将VirtualDom转化为真实DOM结构</h2><p>这是当前SPA应用的核心概念之一</p><pre><code> // vnode结构： // &#123; //   tag, //   attrs, //   children, // &#125;  //Virtual DOM =&gt; DOM function render(vnode, container) &#123;   container.appendChild(_render(vnode)); &#125; function _render(vnode) &#123;   // 如果是数字类型转化为字符串   if (typeof vnode === 'number') &#123;     vnode = String(vnode);   &#125;   // 字符串类型直接就是文本节点   if (typeof vnode === 'string') &#123;     return document.createTextNode(vnode);   &#125;   // 普通DOM   const dom = document.createElement(vnode.tag);   if (vnode.attrs) &#123;     // 遍历属性     Object.keys(vnode.attrs).forEach(key =&gt; &#123;       const value = vnode.attrs[key];       dom.setAttribute(key, value);     &#125;)   &#125;   // 子数组进行递归操作   vnode.children.forEach(child =&gt; render(child, dom));   return dom; &#125; 复制代码</code></pre><h2 id="32-字符串解析问题">32.字符串解析问题</h2><pre><code> var a = &#123;     b: 123,     c: '456',     e: '789', &#125; var str=`a&#123;a.b&#125;aa&#123;a.c&#125;aa &#123;a.d&#125;aaaa`; // =&gt; 'a123aa456aa &#123;a.d&#125;aaaa' 复制代码</code></pre><p>实现函数使得将str字符串中的<code>&#123;&#125;</code>内的变量替换，如果属性不存在保持原样（比如<code>&#123;a.d&#125;</code>）</p><p>类似于模版字符串，但有一点出入，实际上原理大差不差</p><pre><code> const fn1 = (str, obj) =&gt; &#123;     let res = '';     // 标志位，标志前面是否有&#123;     let flag = false;     let start;     for (let i = 0; i &lt; str.length; i++) &#123;         if (str[i] === '&#123;') &#123;             flag = true;             start = i + 1;             continue;         &#125;         if (!flag) res += str[i];         else &#123;             if (str[i] === '&#125;') &#123;                 flag = false;                 res += match(str.slice(start, i), obj);             &#125;         &#125;     &#125;     return res; &#125; // 对象匹配操作 const match = (str, obj) =&gt; &#123;     const keys = str.split('.').slice(1);     let index = 0;     let o = obj;     while (index &lt; keys.length) &#123;         const key = keys[index];         if (!o[key]) &#123;             return `&#123;$&#123;str&#125;&#125;`;         &#125; else &#123;             o = o[key];         &#125;         index++;     &#125;     return o; &#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Js </category>
          
      </categories>
      
      
        <tags>
            
            <tag> js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Antd库实现可编辑树组件</title>
      <link href="/blogs/2020/08/28/16efc21c.html/"/>
      <url>/blogs/2020/08/28/16efc21c.html/</url>
      
        <content type="html"><![CDATA[<h3 id="I-前言">I 前言</h3><hr><p><mark>Antd</mark>是基于Ant Design设计体系的React UI组件库，主要用于研发企业级中后台产品，在前端很多项目中都有使用。除了提供一些比较基础的例如<code>Button</code>、<code>Form</code>、<code>Input</code>、<code>Modal</code>、<code>List</code>…组件，还有<code>Tree</code>、<code>Upload</code>、<code>Table</code>这几个功能集成度比较高的复杂组件，其中<code>Tree</code>组件的应用场景挺多的，在一些涉及显示树形结构数据的功能中可以体现：目录结构展示、族谱关系图…，总之在需要呈现多个父子层级之间结构关系的场景中就可能用到这种Tree组件，Antd虽然官方提供了Tree组件但是它的功能比较有限，定位是主要负责对数据的展示工作，树数据的增删查改这些功能基本没有支持，但是Antd Tree的属性支持比较完善，我们可以基于Antd树来实现支持编辑功能的<code>EditableTree</code>组件。</p><p>源码：<a href="https://github.com/nojsja/react-nojsja/tree/master/components/EditableTree">nojsja/EditableTree</a>，克隆整个仓库下来后可以直接运行起来。</p><p>已经发布为npm组件，可以直接安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$: npm install editable-tree-antd</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$: yarn add editable-tree-antd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="预览">预览</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./editable_tree.png"  alt="editable_tree"></p><h3 id="II-功能分析">II 功能分析</h3><hr><ul class="contains-task-list"><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 非叶子节点的节点名不为空，节点值为空或数组</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 叶子节点的节点名可为空，节点值不可为空</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 点击树节点进入节点编辑状态，提交后实现节点数据更新</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 非叶子节点各层级支持临节点添加/子节点添加/节点删除/节点名和值编辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 叶子节点只支持当前节点删除和当前节点的节点名/节点值编辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 树的各层级的节点名和节点值可否编辑支持配置，默认可编辑</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 树的各层级的节点是否可删除支持配置，默认可删除</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 树的层级深度支持属性配置，子节点深度不能超过树的最大深度值，默认为50层子级</label></li><li class="task-list-item enabled"><label><input class="task-list-item-checkbox" checked=""type="checkbox"> 新增支持：将一段yaml字符串解析为多个树节点</label></li></ul><h3 id="III-实现解析">III 实现解析</h3><hr><p>基于React / Antd / Mobx</p><p><a href="https://ant.design/components/tree-cn/">Antd Tree文档</a></p><h4 id="文件结构">文件结构</h4><p>— index.js – 入口文件，数据初始化、组件生命周期控制、递归调用<code>TreeNode</code>进行数据渲染<br>— Tree.js – Tree类用于抽象化树形数据的增删查改操作，相当于<code>Model</code>层<br>— lang.js – 多语言文件<br>— TreeNode.jsx – 单层树节点组件，用于隔离每层节点状态显示和操作<br>------- TreeNodeDisplay.jsx – 非编辑状态下树数据的展示<br>------- TreeNodeNormalEditing.jsx – 普通节点处于编辑状态下时<br>------- TreeNodeYamlEditing.jsx – yaml节点处于编辑状态下时<br>------- TreeNodeActions.jsx – 该层级树节点的所有功能按钮组<br>— styles / editable-tree.css – 树样式<br>— styles / icon-font / *  – 图标依赖的iconfont文件</p><h4 id="实现原理">实现原理</h4><ul><li>先来看下Antd原生需要<code>Tree</code>数据格式：</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    title: &#x27;parent <span class="number">1</span>&#x27;,</span><br><span class="line">    key: &#x27;<span class="number">0</span><span class="number">-0</span>&#x27;,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;parent <span class="number">1</span><span class="number">-0</span>&#x27;,</span><br><span class="line">        key: &#x27;<span class="number">0</span><span class="number">-0</span><span class="number">-0</span>&#x27;,</span><br><span class="line">        disabled: <span class="literal">true</span>,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            title: &#x27;leaf&#x27;,</span><br><span class="line">            key: &#x27;<span class="number">0</span><span class="number">-0</span><span class="number">-0</span><span class="number">-0</span>&#x27;,</span><br><span class="line">            disableCheckbox: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            title: &#x27;leaf&#x27;,</span><br><span class="line">            key: &#x27;<span class="number">0</span><span class="number">-0</span><span class="number">-0</span><span class="number">-1</span>&#x27;,</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;parent <span class="number">1</span><span class="number">-1</span>&#x27;,</span><br><span class="line">        key: &#x27;<span class="number">0</span><span class="number">-0</span><span class="number">-1</span>&#x27;,</span><br><span class="line">        children: [&#123; title: &lt;span style=&#123;&#123; color: &#x27;#<span class="number">1890</span>ff&#x27; &#125;&#125;&gt;sss&lt;/span&gt;, key: &#x27;<span class="number">0</span><span class="number">-0</span><span class="number">-1</span><span class="number">-0</span>&#x27; &#125;]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li><p>每一层级节点除了需要基本的<code>title</code>(文字label)、<code>key</code>(节点唯一标识)、<code>children</code>(子结点列表)属性外，还有其它很多自定义参数比如配置节点是否选中等等，这里就不对其它功能配置项做细研究了，感兴趣可以查看官方文档。</p></li><li><p>在官方说明中<code>title</code>值其实不只是一个字符串，还可以是一个ReactNode，也就是说Antd官方为我们提供了一个树改造的后门，我们可以用自己的渲染逻辑来替换官方的<code>title</code>渲染逻辑，所以关键点就是分离这个<code>title</code>渲染为一个独立的React组件，在这个组件里我们独立管理每一层级的树节点数据展示，同时又向这个组件暴露操作整个树形数据的方法。另一方面Tree型数据一般都需要使用递归逻辑来进行节点渲染和数据增删查改，这里<code>TreeNode.js</code>就是递归渲染的Component对象，而增删查改逻辑我们把它分离到<code>Tree.js</code>Model里面进行管理，这样子思路就比较清晰了。</p></li></ul><h4 id="关键点说明：index-js">关键点说明：index.js</h4><blockquote><p>入口文件，用于：数据初始化、组件生命周期控制、递归调用<code>TreeNode</code>进行数据渲染、加载lang文件等等</p></blockquote><ul><li><p>在生命周期<code>componentDidMount</code>中我们初始化一个Tree Model，并设置初始化state数据。</p></li><li><p>在<code>componentWillReceiveProps</code>中我们更新这个Model和state以控制界面状态更新，注意使用的Js数据深比较函数<code>deepComparison</code>用来避免不必要的数据渲染，数据深比较时要使用与树显示相关的节点属性<code>裸数据</code>(见方法<code>getNudeTreeData</code>)，比如<code>nodeName</code>，<code>nodeValue</code>等属性，其它的无关属性比如<code>id</code>和<code>depth</code>需要忽略。</p></li><li><p><code>formatNodeData</code>主要功能是将我们传入的自定义树数据递归 “翻译” 成Antd Tree渲染需要的原生树数据。</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    nodeName: &#x27;出版者&#x27;,</span><br><span class="line">    id: &#x27;出版者&#x27;, <span class="comment">// unique id, required</span></span><br><span class="line">    nameEditable: <span class="literal">true</span>, <span class="comment">// is level editable (name), default true</span></span><br><span class="line">    valueEditable: <span class="literal">true</span>, <span class="comment">// is level editable (value), default true</span></span><br><span class="line">    nodeDeletable: <span class="literal">false</span>, <span class="comment">// is level deletable, default true</span></span><br><span class="line">    nodeValue: [</span><br><span class="line">      &#123;</span><br><span class="line">        nodeName: &#x27;出版者描述&#x27;,</span><br><span class="line">        isInEdit: <span class="literal">true</span>, <span class="comment">// is level in edit status</span></span><br><span class="line">        id: &#x27;出版者描述&#x27;,</span><br><span class="line">        nodeValue: [</span><br><span class="line">          &#123;</span><br><span class="line">            nodeName: &#x27;出版者名称&#x27;,</span><br><span class="line">            id: &#x27;出版者名称&#x27;,</span><br><span class="line">            nodeValue: &#x27;出版者A&#x27;,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            nodeName: &#x27;出版者地&#x27;,</span><br><span class="line">            id: &#x27;出版者地&#x27;,</span><br><span class="line">            valueEditable: <span class="literal">false</span>,</span><br><span class="line">            nodeValue: &#x27;出版地B1&#x27;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">];</span><br></pre></td></tr></table></figure><ul><li>代码逻辑：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditableTree</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">treeData</span>: [], <span class="comment">// Antd Tree 需要的结构化数据</span></span><br><span class="line">    <span class="attr">expandedKeys</span>: [], <span class="comment">// 将树的节点展开/折叠状态纳入控制</span></span><br><span class="line">    <span class="attr">maxLevel</span>: <span class="number">50</span>, ；<span class="comment">// 默认最大树深度</span></span><br><span class="line">    <span class="attr">enableYaml</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">lang</span>: <span class="string">&#x27;zh_CN&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  dataOrigin = []</span><br><span class="line">  treeModel = <span class="literal">null</span></span><br><span class="line">  key=getRandomString()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 组件挂载后初始化树数据，生成treeModel，更新state */</span></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data, maxLevel = <span class="number">50</span>, enableYaml, lang=<span class="string">&quot;zh_CN&quot;</span> &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">      <span class="built_in">this</span>.dataOrigin = data;</span><br><span class="line">      TreeClass.defaultTreeValueWrapper(<span class="built_in">this</span>.dataOrigin); <span class="comment">// 树节点添加默认值</span></span><br><span class="line">      TreeClass.levelDepthWrapper(<span class="built_in">this</span>.dataOrigin); <span class="comment">// 添加层级深度属性</span></span><br><span class="line">      <span class="keyword">const</span> formattedData = <span class="built_in">this</span>.formatTreeData(<span class="built_in">this</span>.dataOrigin); <span class="comment">// 生成格式化后的Antd Tree数据</span></span><br><span class="line">      <span class="built_in">this</span>.updateTreeModel(&#123; <span class="attr">data</span>: <span class="built_in">this</span>.dataOrigin, <span class="attr">key</span>: <span class="built_in">this</span>.key &#125;); <span class="comment">// 更新model</span></span><br><span class="line">      <span class="keyword">const</span> keys = TreeClass.getTreeKeys(<span class="built_in">this</span>.dataOrigin); <span class="comment">// 获取各个层级的key，默认展开所有层级</span></span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        <span class="attr">treeData</span>: formattedData,</span><br><span class="line">        <span class="attr">expandedKeys</span>: keys,</span><br><span class="line">        <span class="attr">enableYaml</span>: !!enableYaml,</span><br><span class="line">        maxLevel,</span><br><span class="line">        lang,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 组件props数据更新后更新treeModel和state */</span></span><br><span class="line">  <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data, maxLevel = <span class="number">50</span>, enableYaml, lang=<span class="string">&quot;zh_CN&quot;</span> &#125; = nextProps;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">enableYaml</span>: !!enableYaml, lang, maxLevel &#125;);</span><br><span class="line">    <span class="comment">// 深比较函数避免不必要的树更新</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !deepComparison(</span><br><span class="line">          TreeClass.getNudeTreeData(deepClone(<span class="built_in">this</span>.dataOrigin)),</span><br><span class="line">          TreeClass.getNudeTreeData(deepClone(data))</span><br><span class="line">        )</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="built_in">this</span>.dataOrigin = data;</span><br><span class="line">      TreeClass.defaultTreeValueWrapper(<span class="built_in">this</span>.dataOrigin);</span><br><span class="line">      TreeClass.levelDepthWrapper(<span class="built_in">this</span>.dataOrigin);</span><br><span class="line">      <span class="keyword">const</span> formattedData = <span class="built_in">this</span>.formatTreeData(<span class="built_in">this</span>.dataOrigin);</span><br><span class="line">      <span class="built_in">this</span>.updateTreeModel(&#123; <span class="attr">data</span>: <span class="built_in">this</span>.dataOrigin, <span class="attr">key</span>: <span class="built_in">this</span>.key &#125;);</span><br><span class="line">      <span class="keyword">const</span> keys = TreeClass.getTreeKeys(<span class="built_in">this</span>.dataOrigin);</span><br><span class="line">      <span class="built_in">this</span>.onDataChange(<span class="built_in">this</span>.dataOrigin); <span class="comment">// 触发onChange回调钩子</span></span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        <span class="attr">treeData</span>: formattedData,</span><br><span class="line">        <span class="attr">expandedKeys</span>: keys</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 修改节点 */</span></span><br><span class="line">  modifyNode = <span class="function">(<span class="params">key, treeNode</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> modifiedData = <span class="built_in">this</span>.treeModel.modifyNode(key, treeNode); <span class="comment">// 更新model</span></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">treeData</span>: <span class="built_in">this</span>.formatTreeData(modifiedData), <span class="comment">// 更新state,触发数据回调钩子</span></span><br><span class="line">    &#125;, <span class="function">() =&gt;</span> <span class="built_in">this</span>.onDataChange(<span class="built_in">this</span>.dataOrigin));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 以下省略的方法具有跟modifyNode相似的逻辑</span></span><br><span class="line"><span class="comment">   * 调用treeModel修改数据然后更新state</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 进入编辑模式 */</span></span><br><span class="line">  getInToEditable = <span class="function">(<span class="params">key, treeNode</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  <span class="comment">/* 添加一个兄弟节点 */</span></span><br><span class="line">  addSisterNode = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  <span class="comment">/* 添加一个子结点 */</span></span><br><span class="line">  addSubNode = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  <span class="comment">/* 移除一个节点 */</span></span><br><span class="line">  removeNode = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 递归生成树节点数据 */</span></span><br><span class="line">  formatNodeData = <span class="function">(<span class="params">treeData</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tree = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.key&#125;</span>_<span class="subst">$&#123;treeData.id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">if</span> (treeData.toString() === <span class="string">&#x27;[object Object]&#x27;</span> &amp;&amp; tree !== <span class="literal">null</span>) &#123;</span><br><span class="line">      tree.key = key;</span><br><span class="line">      treeData.key = key;</span><br><span class="line">      tree.title = <span class="comment">/* 关键点 */</span></span><br><span class="line">        (<span class="xml"><span class="tag">&lt;<span class="name">TreeNode</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">maxLevel</span>=<span class="string">&#123;this.maxLevel&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">focusKey</span>=<span class="string">&#123;this.state.focusKey&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">treeData</span>=<span class="string">&#123;treeData&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">enableYaml</span>=<span class="string">&#123;this.state.enableYaml&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">modifyNode</span>=<span class="string">&#123;this.modifyNode&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">addSisterNode</span>=<span class="string">&#123;this.addSisterNode&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">addExpandedKey</span>=<span class="string">&#123;this.addExpandedKey&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">getInToEditable</span>=<span class="string">&#123;this.getInToEditable&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">addSubNode</span>=<span class="string">&#123;this.addSubNode&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">addNodeFragment</span>=<span class="string">&#123;this.addNodeFragment&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">removeNode</span>=<span class="string">&#123;this.removeNode&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          <span class="attr">lang</span>=<span class="string">&#123;lang(this.state.lang)&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        /&gt;</span></span>);</span><br><span class="line">      <span class="keyword">if</span> (treeData.nodeValue <span class="keyword">instanceof</span> <span class="built_in">Array</span>) tree.children = treeData.nodeValue.map(<span class="function"><span class="params">d</span> =&gt;</span> <span class="built_in">this</span>.formatNodeData(d));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      tree = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 生成树数据 */</span></span><br><span class="line">  formatTreeData = <span class="function">(<span class="params">treeData</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tree = [];</span><br><span class="line">    <span class="keyword">if</span> (treeData <span class="keyword">instanceof</span> <span class="built_in">Array</span>) tree = treeData.map(<span class="function"><span class="params">treeNode</span> =&gt;</span> <span class="built_in">this</span>.formatNodeData(treeNode));</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 更新 tree model */</span></span><br><span class="line">  updateTreeModel = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.treeModel) &#123;</span><br><span class="line">      <span class="built_in">this</span>.treeModel.update(props);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> _lang = lang(<span class="built_in">this</span>.state.lang);</span><br><span class="line">      <span class="built_in">this</span>.treeModel = <span class="keyword">new</span> TreeClass(</span><br><span class="line">        props.data,</span><br><span class="line">        props.key,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">maxLevel</span>: <span class="built_in">this</span>.state.maxLevel,</span><br><span class="line">          <span class="attr">overLevelTips</span>: _lang.template_tree_max_level_tips,</span><br><span class="line">          <span class="attr">completeEditingNodeTips</span>: _lang.pleaseCompleteTheNodeBeingEdited,</span><br><span class="line">          <span class="attr">addSameLevelTips</span>: _lang.extendedMetadata_same_level_name_cannot_be_added,</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 树数据更新钩子，提供给上一层级调用 */</span></span><br><span class="line">  onDataChange = <span class="function">(<span class="params">modifiedData</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; onDataChange = <span class="function">() =&gt;</span> &#123;&#125; &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    onDataChange(modifiedData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; treeData &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;editable-tree-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123;</span></span><br><span class="line"><span class="xml">        (treeData &amp;&amp; treeData.length) ?</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Tree</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">showLine</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">onExpand</span>=<span class="string">&#123;this.onExpand&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">expandedKeys</span>=<span class="string">&#123;this.state.expandedKeys&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            // <span class="attr">defaultExpandedKeys</span>=<span class="string">&#123;this.state.expandedKeys&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">defaultExpandAll</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">treeData</span>=<span class="string">&#123;treeData&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          /&gt;</span></span></span><br><span class="line"><span class="xml">        : null</span></span><br><span class="line"><span class="xml">      &#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EditableTree.propTypes = &#123;</span><br><span class="line">  <span class="attr">data</span>: PropTypes.array.isRequired, <span class="comment">// tree data, required</span></span><br><span class="line">  <span class="attr">onDataChange</span>: PropTypes.func, <span class="comment">// data change callback, default none</span></span><br><span class="line">  <span class="attr">maxLevel</span>: PropTypes.number, <span class="comment">// tree max level, default 50</span></span><br><span class="line">  <span class="attr">lang</span>: PropTypes.string, <span class="comment">// lang - zh_CN/en_US, default zh_CN</span></span><br><span class="line">  <span class="attr">enableYaml</span>: PropTypes.bool <span class="comment">// enable it if you want to parse yaml string when adding a new node, default false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="关键点说明：Tree-js">关键点说明：Tree.js</h4><blockquote><p>Tree类用于抽象化树形数据的增删查改操作，相当于<code>Model</code>层</p></blockquote><p>逻辑不算复杂，很多都是递归树数据修改节点，具体代码不予赘述：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Tree</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">data, treeKey, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    maxLevel,</span></span></span><br><span class="line"><span class="params"><span class="function">    overLevelTips = <span class="string">&#x27;已经限制模板树的最大深度为：&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    addSameLevelTips = <span class="string">&#x27;同层级已经有同名节点被添加！&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    completeEditingNodeTips = <span class="string">&#x27;请完善当前正在编辑的节点数据！&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.treeData = data;</span><br><span class="line">    <span class="built_in">this</span>.treeKey = treeKey;</span><br><span class="line">    <span class="built_in">this</span>.maxLevel = maxLevel;</span><br><span class="line">    <span class="built_in">this</span>.overLevelTips = overLevelTips;</span><br><span class="line">    <span class="built_in">this</span>.completeEditingNodeTips = completeEditingNodeTips;</span><br><span class="line">    <span class="built_in">this</span>.addSameLevelTips = addSameLevelTips;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 为输入数据覆盖默认值 */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">defaultTreeValueWrapper</span>(<span class="params"></span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 查询是否有节点正在编辑 */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">findInEdit</span>(<span class="params">items</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 进入编辑模式 */</span></span><br><span class="line">  <span class="function"><span class="title">getInToEditable</span>(<span class="params">key, &#123; nodeName, nodeValue, id, isInEdit &#125; = &#123;&#125;</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 修改一个节点数据 */</span></span><br><span class="line">  <span class="function"><span class="title">modifyNode</span>(<span class="params">key, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    nodeName = <span class="string">&#x27;&#x27;</span>, nodeValue = <span class="string">&#x27;&#x27;</span>, nameEditable = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    valueEditable = <span class="literal">true</span>, nodeDeletable = <span class="literal">true</span>, isInEdit = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125; = &#123;&#125;</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 添加一个目标节点的兄弟结点 */</span></span><br><span class="line">  <span class="function"><span class="title">addSisterNode</span>(<span class="params">key, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    nodeName = <span class="string">&#x27;&#x27;</span>, nameEditable = <span class="literal">true</span>, valueEditable = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    nodeDeletable = <span class="literal">true</span>, isInEdit = <span class="literal">true</span>, nodeValue = <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125; = &#123;&#125;</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 添加一个目标节点的子结点 */</span></span><br><span class="line">  <span class="function"><span class="title">addSubNode</span>(<span class="params">key, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    nodeName = <span class="string">&#x27;&#x27;</span>, nameEditable = <span class="literal">true</span>, valueEditable = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    nodeDeletable = <span class="literal">true</span>, isInEdit = <span class="literal">true</span>, nodeValue = <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125; = &#123;&#125;</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 移除节点 */</span></span><br><span class="line">  <span class="function"><span class="title">removeNode</span>(<span class="params">key</span>)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取树数据 */</span></span><br><span class="line">  <span class="function"><span class="title">getTreeData</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> deepClone(<span class="built_in">this</span>.treeData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 更新树数据 */</span></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">&#123; data, key &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.treeData = data;</span><br><span class="line">    <span class="built_in">this</span>.treeKey = key;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="关键点说明：TreeNode-jsx">关键点说明：TreeNode.jsx</h4><blockquote><p>表示单个树节点的React组件，以下均为其子组件，用于展示各个状态下的树层级</p></blockquote><ul><li><p>TreeNodeDisplay.jsx – 非编辑状态下树数据的展示</p></li><li><p>TreeNodeNormalEditing.jsx – 普通节点处于编辑状态下时</p></li><li><p>TreeNodeYamlEditing.jsx – yaml节点处于编辑状态下时</p></li><li><p>TreeNodeActions.jsx – 该层级树节点的所有功能按钮组</p></li></ul><p>每个层级节点都可以添加子节点、添加同级节点、编辑节点名、编辑节点值、删除当前节点(一并删除子节点)，<code>nameEditable</code>属性控制节点名是否可编辑，<code>valueEditable</code>树形控制节点值是否可编辑，<code>nodeDeletable</code>属性控制节点是否可以删除，默认值都是为<code>true</code>。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./tree_add_sister.png"  alt="tree_add_sister"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./tree_add_sub.png"  alt="tree_add_sub"></p><p><code>isInEdit</code>属性表明当前节点是否处于编辑状态，处于编辑状态时显示输入框，否则显示文字，当点击文字时当前节点变成编辑状态。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./tree_in_edit.png"  alt="tree_in_edit"></p><p>简单的页面展示组件，具体实现见 <a href="https://github.com/nojsja/react-nojsja/blob/master/components/EditableTree/src/TreeNode.jsx">源码：TreeNode.jsx</a></p><h3 id="IV-遇到的问题-解决办法">IV 遇到的问题&amp;解决办法</h3><hr><h4 id="树数据更新渲染导致的节点折叠状态重置">树数据更新渲染导致的节点折叠状态重置</h4><ul><li><p>想象我们打开了树的中间某个层级进行节点名编辑，编辑完成后点击提交，树重新渲染刷新，然后之前编辑的节点又重新折叠起来了，我们需要重新打开那个层级看是否编辑成功，这种使用体验无疑是痛苦的。</p></li><li><p>造成树节点折叠状态重置的原因就是树的重新渲染，且这个折叠状态的控制数据并没有暴露到每个TreeNode上，所以在我们自己实现的TreeNode中无法独立控制树节点的折叠/展开。</p></li><li><p>查看官方文档，传入树的<code>expandedKeys</code>属性可以显式指定整颗树中需要展开的节点，<code>expandedKeys</code>即需要展开节点的key值数组，为了将每个树节点折叠状态变成受控状态，我们将<code>expandedKeys</code>存在state或mobx store中，并在树节点折叠状态改变后更新这个值。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; treeData &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;editable-tree-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123;</span></span><br><span class="line"><span class="xml">        (treeData &amp;&amp; treeData.length) ?</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Tree</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">showLine</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">onExpand</span>=<span class="string">&#123;this.onExpand&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">expandedKeys</span>=<span class="string">&#123;this.state.expandedKeys&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">treeData</span>=<span class="string">&#123;treeData&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          /&gt;</span></span></span><br><span class="line"><span class="xml">        : null</span></span><br><span class="line"><span class="xml">      &#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="Antd格子布局塌陷">Antd格子布局塌陷</h4><ul><li><p>在<code>TreeNode.jsx</code>组件中有一个比较严重的问题，如上文提到的<code>EditableTree</code>的某一层级处于编辑状态时，该层级中的文字展示组件<code>&lt;span&gt;</code>会变成输入组件<code>&lt;input&gt;</code>，我发现在编辑模式下Antd的<code>Row/Col</code>格子布局正常工作，在非编辑模式下由于节点内容从块元素<code>input</code>变成了内联元素<code>span</code>，格子布局塌陷了，这种情况下即使声明了Col占用的格子数量，内容依旧使用最小宽度展示，即文字占用的宽度。</p></li><li><p>推测原因是Antd的<code>Row/Col</code>格子布局自身的问题，没有深究，这边只是将<code>&lt;span&gt;</code>元素换成了<code>&lt;div&gt;</code>元素，并且在样式中声明<code>div</code>占用的最小宽度<code>min-width</code>，同时设置<code>max-width</code>和<code>overflow</code>避免文字元素超出边界。</p></li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="./tree_in_edit.png"  alt="tree_in_edit"></p><h3 id="V-结语">V 结语</h3><hr><p>其实Tree组件已经不止写过一次了，之前基于<code>Semantic UI</code>写过一次，不过因为<code>Semantic UI</code>没有Tree的基础实现，所以基本上是完全自己重写的，基本思路其实跟这篇文章写的大致相同，也是递归更新渲染节点，将各个节点的折叠状态放入state进行受控管理，不过这次实现的<code>EditableTree</code>最主要一点是分离了<code>treeModel</code>的数据管理逻辑，让界面操作层<code>TreeNode.jsx</code>、数据管理层<code>Tree.js</code>和控制层<code>index.jsx</code>完全分离开来，结构明了，后期即使想扩展功能也未尝不可。又是跟<code>Antd</code>斗智斗勇的一次😕…</p>]]></content>
      
      
      <categories>
          
          <category> Antd </category>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> antd </tag>
            
            <tag> tree </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Electron的smb客户端文件上传优化探索</title>
      <link href="/blogs/2020/08/16/1597e5d6.html/"/>
      <url>/blogs/2020/08/16/1597e5d6.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>文中实现的部分工具方法正处于早期/测试阶段，仍在持续优化中，仅供参考…</p></blockquote><h3 id="I-前言">I 前言</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_upload_now.jpg"  alt="RhinoDisk"></p><p>上一篇文章<a href="https://nojsja.gitee.io/blogs/2020/07/17/%E5%9F%BA%E4%BA%8EElectron%E7%9A%84smb%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">《基于Electron的smb客户端开发记录》</a>，大致描述了整个SMB客户端开发的核心功能、实现难点、项目打包这些内容，这篇文章呢单独把其中的<code>文件分片上传模块</code>拿出来进行分享，提及一些与Electron主进程、渲染进程和文件上传优化相关的功能点。</p><h3 id="II-Demo运行">II Demo运行</h3><hr><p>项目精简版 <a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">DEMO地址</a>，删除了smb处理的多余逻辑，使用文件复制模拟上传流程，可直接运行体验。</p><blockquote><p>demo运行时需要分别开启两个开发环境view -&gt; service，然后才能预览界面，由于没有后端，文件默认上传(复制)到electron数据目录(在Ubuntu上是<code>~/.config/FileSliceUpload/runtime/upload</code>)</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入view目录</span></span><br><span class="line">$: npm install</span><br><span class="line">$: npm start</span><br><span class="line"><span class="comment"># 进入service目录</span></span><br><span class="line">$: npm install</span><br><span class="line">$: npm start</span><br><span class="line"><span class="comment"># 一键打包脚本 - 查看帮助</span></span><br><span class="line">$: node build.js --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># 应用打包 - 为linux/mac/win平台打包</span></span><br><span class="line">$: node build.js build-linux</span><br><span class="line">$: node build.js build-mac</span><br><span class="line">$: node build.js build-win</span><br></pre></td></tr></table></figure><h3 id="III-Electron进程架构">III Electron进程架构</h3><hr><h4 id="主进程和渲染进程的区别">主进程和渲染进程的区别</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="electron1.png"  alt="electron"></p><p>Electron 运行 package.json 的 main 脚本的进程被称为主进程。在主进程中运行的脚本通过创建web页面来展示用户界面，一个 Electron 应用总是有且只有一个主进程。<br>主进程使用 BrowserWindow 实例创建页面，每个 BrowserWindow 实例都在自己的渲染进程里运行页面，当一个 BrowserWindow 实例被销毁后，相应的渲染进程也会被终止。<br>主进程管理所有的web页面和它们对应的渲染进程，每个渲染进程都是独立的，它只关心它所运行的 web 页面。</p><p>在普通的浏览器中，web页面通常在沙盒环境中运行，并且无法访问操作系统的原生资源。 然而 Electron 的用户在 Node.js 的 API 支持下可以在页面中和操作系统进行一些底层交互。<br>在页面中调用与 GUI 相关的原生 API 是不被允许的，因为在 web 页面里操作原生的 GUI 资源是非常危险的，而且容易造成资源泄露。 如果你想在 web 页面里使用 GUI 操作，其对应的渲染进程必须与主进程进行通讯，请求主进程进行相关的 GUI 操作。</p><h4 id="主进程和渲染进程之间的通信">主进程和渲染进程之间的通信</h4><blockquote><p>1/2-自带方法，3-外部扩展方法</p></blockquote><p><strong>1. 使用remote远程调用</strong></p><p>remote模块为渲染进程和主进程通信提供了一种简单方法，使用remote模块, 你可以调用main进程对象的方法, 而不必显式发送进程间消息。示例如下，代码通过remote远程调用主进程的BrowserWindows创建了一个渲染进程，并加载了一个网页地址：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 渲染进程中(web端代码) */</span></span><br><span class="line"><span class="keyword">const</span> &#123; BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>).remote</span><br><span class="line"><span class="keyword">let</span> win = <span class="keyword">new</span> BrowserWindow(&#123; <span class="attr">width</span>: <span class="number">800</span>, <span class="attr">height</span>: <span class="number">600</span> &#125;)</span><br><span class="line">win.loadURL(<span class="string">&#x27;https://github.com&#x27;</span>)</span><br></pre></td></tr></table></figure><p>注意：remote底层是基于ipc的同步进程通信(同步=阻塞页面)，都知道Node.js的最大特性就是异步调用，非阻塞IO，因此remote调用不适用于主进程和渲染进程频繁通信以及耗时请求的情况，否则会引起严重的程序性能问题。</p><p><strong>2. 使用ipc信号通信</strong></p><p>基于事件触发的ipc双向信号通信，渲染进程中的ipcRenderer可以监听一个事件通道，也能向主进程或其它渲染进程直接发送消息(需要知道其它渲染进程的webContentsId)，同理主进程中的ipcMain也能监听某个事件通道和向任意一个渲染进程发送消息。<br>Electron进程之间通信最常用的一系列方法，但是在向其它子进程发送消息之前需要知道目标进程的<code>webContentsId</code>或者能够直接拿到目标进程的实例，使用方式不太灵活。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 主进程 */</span></span><br><span class="line">ipcMain.on(channel, listener) <span class="comment">// 监听信道 - 异步触发</span></span><br><span class="line">ipcMain.once(channel, listener) <span class="comment">// 监听一次信道，监听器触发后即删除 - 异步触发</span></span><br><span class="line">ipcMain.handle(channel, listener) <span class="comment">// 为渲染进程的invoke函数设置对应信道的监听器</span></span><br><span class="line">ipcMain.handleOnce(channel, listener) <span class="comment">// 为渲染进程的invoke函数设置对应信道的监听器，触发后即删除监听</span></span><br><span class="line">browserWindow.webContents.send(channel, args); <span class="comment">// 显式地向某个渲染进程发送信息 - 异步触发</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 渲染进程 */</span></span><br><span class="line">ipcRenderer.on(channel, listener); <span class="comment">// 监听信道 - 异步触发</span></span><br><span class="line">ipcRenderer.once(channel, listener); <span class="comment">// 监听一次信道，监听器触发后即删除 - 异步触发</span></span><br><span class="line">ipcRenderer.sendSync(channel, args); <span class="comment">// 向主进程一个信道发送信息 - 同步触发</span></span><br><span class="line">ipcRenderer.invoke(channel, args); <span class="comment">// 向主进程一个信道发送信息 - 返回Promise对象等待触发</span></span><br><span class="line">ipcRenderer.sendTo(webContentsId, channel, ...args); <span class="comment">// 向某个渲染进程发送消息 - 异步触发</span></span><br><span class="line">ipcRenderer.sendToHost(channel, ...args) <span class="comment">// 向host页面的webview发送消息 - 异步触发</span></span><br></pre></td></tr></table></figure><p><strong>3. 使用<mark>electron-re</mark>进行多向通信</strong></p><p><a href="https://github.com/nojsja/electron-re">electron-re</a> 是之前开发的一个处理electron进程间通信的工具，基于自带的ipc信号通信进行了封装，已经发布为npm组件。主要功能是在Electron已有的<code>Main Process</code>主进程 和 <code>Renderer Process</code>渲染进程概念的基础上独立出一个单独的<mark>Service</mark>逻辑。Service即不需要显示界面的后台进程，它不参与UI交互，单独为主进程或其它渲染进程提供服务，它的底层实现为一个允许<code>node注入</code>和<code>remote调用</code>的渲染窗口进程。</p><p>比如在你看过一些Electron<code>最佳实践</code>中，耗费cpu的操作是不建议被放到主进程中处理的，这时候就可以将这部分耗费cpu的操作编写成一个单独的js文件，然后使用Service构造函数以这个js文件的地址<code>path</code>为参数构造一个Service实例，并通过<code>electron-re</code>提供的<code>MessageChannel</code>通信工具在主进程、渲染进程、service进程之间任意发送消息，可以参考以下示例代码：</p><ul><li>1）main process</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  BrowserService,</span><br><span class="line">  MessageChannel <span class="comment">// must required in main.js even if you don&#x27;t use it</span></span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> isInDev = process.env.NODE_ENV === <span class="string">&#x27;dev&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// after app is ready in main process</span></span><br><span class="line">app.whenReady().then(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> myService = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;path/to/app.service.js&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> myService2 = <span class="keyword">new</span> BrowserService(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;path/to/app2.service.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> myService.connected();</span><br><span class="line">    <span class="keyword">await</span> myService2.connected();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// open devtools in dev mode for debugging</span></span><br><span class="line">    <span class="keyword">if</span> (isInDev) myService.openDevTools();</span><br><span class="line">    <span class="comment">// send data to a service - like the build-in ipcMain.send</span></span><br><span class="line">    MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel1&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test1&#x27;</span> &#125;);</span><br><span class="line">    <span class="comment">// send data to a service and return a Promise - extension method</span></span><br><span class="line">    MessageChannel.invoke(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel2&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;test2&#x27;</span> &#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// listen a channel, same as ipcMain.on</span></span><br><span class="line">    MessageChannel.on(<span class="string">&#x27;channel3&#x27;</span>, <span class="function">(<span class="params">event, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handle a channel signal, same as ipcMain.handle</span></span><br><span class="line">    <span class="comment">// you can return data directly or return a Promise instance</span></span><br><span class="line">    MessageChannel.handle(<span class="string">&#x27;channel4&#x27;</span>, <span class="function">(<span class="params">event, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(response);</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">res</span>: <span class="string">&#x27;channel4-res&#x27;</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>2）app.service.js</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; MessageChannel &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// listen a channel, same as ipcRenderer.on</span></span><br><span class="line">MessageChannel.on(<span class="string">&#x27;channel1&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle a channel signal, just like ipcMain.handle</span></span><br><span class="line">MessageChannel.handle(<span class="string">&#x27;channel2&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">response</span>: <span class="string">&#x27;channel2-response&#x27;</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// send data to another service and return a promise , just like ipcRenderer.invoke</span></span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;app2&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel3&#x27;</span> &#125;).then(<span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// send data to a service - like the build-in ipcRenderer.send</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;channel4&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel4&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><ul><li>3）app2.service.js</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handle a channel signal, just like ipcMain.handle</span></span><br><span class="line">MessageChannel.handle(<span class="string">&#x27;channel3&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">response</span>: <span class="string">&#x27;channel3-response&#x27;</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// listen a channel, same as ipcRenderer.once</span></span><br><span class="line">MessageChannel.once(<span class="string">&#x27;channel4&#x27;</span>, <span class="function">(<span class="params">event, result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// send data to main process, just like ipcRenderer.send</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel3&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel3&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// send data to main process and return a Promise, just like ipcRenderer.invoke</span></span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;channel4&#x27;</span>, &#123; <span class="attr">value</span>: <span class="string">&#x27;channel4&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure><ul><li>4）renderer process window</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ipcRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; MessageChannel &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron-re&#x27;</span>);</span><br><span class="line"><span class="comment">// send data to a service</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;app&#x27;</span>, ...);</span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;app2&#x27;</span>, ...);</span><br><span class="line"><span class="comment">// send data to main process</span></span><br><span class="line">MessageChannel.send(<span class="string">&#x27;main&#x27;</span>, ...);</span><br><span class="line">MessageChannel.invoke(<span class="string">&#x27;main&#x27;</span>, ...);</span><br></pre></td></tr></table></figure><h3 id="IV-文件上传架构">IV 文件上传架构</h3><hr><p>文件上传主要逻辑控制部分是前端的JS脚本代码，位于主窗口所在的render渲染进程，负责用户获取系统目录文件、生成上传任务队列、动态展示上传任务列表详情、任务列表的增删查改等；主进程Electron端的Node.js代码主要负责响应render进程的控制命令进行文件上传任务队列数据的增删查改、上传任务在内存和磁盘的同步、文件系统的交互、系统原生组件调用等。</p><h4 id="文件上传源和上传目标">文件上传源和上传目标</h4><ul><li><p>在用户界面上使用<code>Input</code>组件获取到的FileList(HTML5 API，用于web端的简单文件操作)即为上传源；</p></li><li><p>上传目标地址是远端集群某个节点的smb服务，因为Node.js NPM生态对smb的支持有限，目前并未发现一个可以支持通过smb协议进行文件分片上传的npm库，所以考虑使用Node.js的FS API进行文件分段读取然后将分片数据逐步增量写入目标地址来模拟文件分片上传过程，从而实现在界面上单个大文件上传任务的启动、暂停、终止和续传等操作，所以这里的解决方案是使用Windows UNC命令连接后端共享后，可以像访问本地文件系统一样访问远程一个远程smb共享路径，比如文件路径<code>\\[host]\[sharename]\file1</code>上的file1在执行了unc连接后就可以通过Node.js FS API进行操作，跟操作本地文件完全一致。整个必须依赖smb协议的上传流程即精简为将本地拿到的文件数据复制到可以在本地访问的另一个smb共享路径这一流程，而这一切都得益于Windows <code>UNC</code>命令。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 使用unc命令连接远程smb共享 */</span></span><br><span class="line"><span class="function"><span class="title">_uncCommandConnect_Windows_NT</span>(<span class="params">&#123; host, username, pwd &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; isThirdUser, nickname, isLocalUser &#125; = <span class="built_in">global</span>.ipcMainProcess.userModel.info;</span><br><span class="line">    <span class="keyword">const</span> commandUse = <span class="string">`net use \\\\<span class="subst">$&#123;host&#125;</span>\\ipc$ &quot;<span class="subst">$&#123;pwd&#125;</span>&quot; /user:&quot;<span class="subst">$&#123;username&#125;</span>&quot;`</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.sudo.exec(commandUse).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">          <span class="attr">result</span>: <span class="built_in">global</span>.lang.upload.unc_connection_failed</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="上传流程概述">上传流程概述</h4><p>下图描述了整个前端部分的控制逻辑：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="shards_upload.jpg"  alt="upload"></p><ol><li>页面上使用<code>&lt;Input /&gt;</code>组件拿到FileList对象(Electron环境下拿到的File对象会额外附加一个<code>path</code>属性指明文件位于系统的绝对路径)</li><li>缓存拿到的FileList，等待点击上传按钮后开始读取FileList列表并生成自定义的File文件对象数组用于存储上传任务列表信息</li><li>页面调用init请求附带上选中的文件信息初始化文件上传任务</li><li>Node.js拿到init请求附带的文件信息后，将所有信息存入临时存放在内存中的文件上传列表中，并尝试打开待上传文件的文件描述符用于即将开始的文件切片分段上传工作，最后返回给页面上传任务ID，Node.js端完成初始化处理</li><li>页面拿到init请求成功的回调后，存储返回的上传任务ID，并将该文件加入文件待上传队列，在合适的时机开始上传，开始上传的时候向Node.js端发送upload请求，同时请求附带上任务ID和当前的分片索引值(表示需要上传第几个文件分片)</li><li>Node.js拿到upload请求后根据携带的任务ID读取内存中的上传任务信息，然后使用第二步打开的文件描述符和分片索引对本地磁盘中的目标文件进行分片切割，最后使用FS API将分片递增写入目标位置，即本地可直接访问的SMB共享路径</li><li>upload请求成功后页面判断是否已经上传完所有分片，如果完成则向Node.js发送complete请求，同时携带上任务ID</li><li>Node.js根据任务ID获取文件信息，关闭文件描述符，更新文件上传任务为上传完成状态</li><li>界面上传任务列表全部完成后，向后端发送sync请求，把当前任务上传列表同步到历史任务(磁盘存储)中，表明当前列表中所有任务已经完成</li><li>Node.js拿到sync请求后，把内存中存储的所有文件上传列表信息写入磁盘，同时释放内存占用，完成一次列表任务上传</li></ol><h4 id="Node-js实现的文件分片管理工厂">Node.js实现的文件分片管理工厂</h4><ul><li>文件初始化的时候调用<code>open</code>方法临时存储文件描述符和文件绝对路径的映射关系；</li><li>文件上传的时候调用<code>read</code>方法根据文件读取位置、读取容量大小进行分片切割；</li><li>文件上传完成的时候调用<code>close</code>关闭文件描述符；</li></ul><p>三个方法均通过文件绝对路径<code>path</code>参数建立关联：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * readFileBlock [读取文件块]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.readFileBlock = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fdStore = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> smallFileMap = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">/* 打开文件描述符 */</span></span><br><span class="line">    <span class="attr">open</span>: <span class="function">(<span class="params">path, size, minSize=<span class="number">1024</span>*<span class="number">2</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 小文件不打开文件描述符，直接读取写入</span></span><br><span class="line">          <span class="keyword">if</span> (size &lt;= minSize) &#123;</span><br><span class="line">            smallFileMap[path] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">fd</span>: <span class="literal">null</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 打开文件描述符，建议绝对路径和fd的映射关系</span></span><br><span class="line">          fs.open(path, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, fd</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="built_in">console</span>.trace(err);</span><br><span class="line">              resolve(&#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">601</span>,</span><br><span class="line">                <span class="attr">result</span>: err.toString()</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              fdStore[path] = fd;</span><br><span class="line">              resolve(&#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                  <span class="attr">fd</span>: fdStore[path]</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 读取文件块 */</span></span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">path, position, length</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> callback = <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">              <span class="attr">result</span>: err.toString()</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="attr">result</span>: data</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 小文件直接读取，大文件使用文件描述符和偏移量读取</span></span><br><span class="line">          <span class="keyword">if</span> (smallFileMap[path]) &#123;</span><br><span class="line">            fs.readFile(path, <span class="function">(<span class="params">err, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">              callback(err, buffer);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 空文件处理</span></span><br><span class="line">            <span class="keyword">if</span> (length === <span class="number">0</span>) <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">            fs.read(fdStore[path], Buffer.alloc(length), <span class="number">0</span>, length, position, <span class="function"><span class="keyword">function</span>(<span class="params">err, readByte, readResult</span>)</span>&#123;</span><br><span class="line">              callback(err, readResult);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 关闭文件描述符 */</span></span><br><span class="line">    <span class="attr">close</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (smallFileMap[path]) &#123;</span><br><span class="line">            <span class="keyword">delete</span> smallFileMap[path];</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.close(fdStore[path], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">              resolve(&#123;<span class="attr">code</span>: <span class="number">200</span>&#125;);</span><br><span class="line">              <span class="keyword">delete</span> fdStore[path];</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    fdStore</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="V-基于Electron的文件上传卡顿优化踩坑">V 基于Electron的文件上传卡顿优化踩坑</h3><hr><p>优化是一件头大的事儿，因为你需要先通过很多测试手法找到现有代码的性能瓶颈，然后编写优化解决方案。我觉得找到性能瓶颈这一点就比较难，因为是自己写的代码所以容易陷入一些先入为主的刻板思考模式。不过最最主要的一点还是你如果自己都弄不清楚你使用的技术栈的话，那就无从谈起优化，所以前面有很大篇幅分析了Electron进程方面的知识以及梳理了整个上传流程。</p><h4 id="使用Electron自带的Devtools进行性能分析">使用Electron自带的Devtools进行性能分析</h4><p>在文件上传过程中打开性能检测工具<code>Performance</code>进行录制，分析整个流程：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="upload_performance.jpg"  alt="upload_performance.jpg"></p><p>在文件上传过程中打开内存工具<code>Memory</code>进行快照截取分析一个时刻的内存占用情况：</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="upload_memory.jpg"  alt="upload_memory.jpg"></p><h4 id="第一次尝试解决问题：替换Antd-Table组件">第一次尝试解决问题：替换Antd Table组件</h4><p>在编写完成文件上传模块后，初步进行了压力测试，结果发现添加1000个文件上传任务到任务队列，且同时上传的文件上传任务数量为6时，上下滑动查看文件上传列表时出现了卡顿的情况，这种卡顿不局限于某个界面组件的卡顿，而且当前窗口的所有操作都卡了起来，初步怀疑是Antd Table组件引起的卡顿，因为Antd Table组件是个很复杂的高阶组件，在处理大量的数据时可能会有性能问题，遂我将Antd Table组件换成了原生的table组件，且Table列表只显示每个上传任务的任务名，其余的诸如上传进度这些都不予显示，从而想避开这个问题。令人吃惊的是测试结果是即使换用了原生Table组件，卡顿情况仍然毫无改善！</p><h4 id="第二次尝试解决问题：改造Electron主进程同步阻塞代码">第二次尝试解决问题：改造Electron主进程同步阻塞代码</h4><p>先看下chromium的架构图，每个渲染进程都有一个全局对象RenderProcess，用来管理与父浏览器进程的通信，同时维护着一份全局状态。浏览器进程为每个渲染进程维护一个RenderProcessHost对象，用来管理浏览器状态和与渲染进程的通信。浏览器进程和渲染进程使用Chromium的IPC系统进行通信。在chromium中，页面渲染时，UI进程需要和main process不断的进行IPC同步，若此时main process忙，则UIprocess就会在IPC时阻塞。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="chromium.jpg"  alt="upload_memory.jpg"></p><p>综上所述：如果主进程持续进行消耗CPU时间的任务或阻塞同步IO的任务的话，主进程就会在一定程度上阻塞，从而影响主进程和各个渲染进程之间的IPC通信，IPC通信有延迟或是受阻，自然渲染界面的UI绘制和更新就会呈现卡顿的状态。</p><p>我分析了一下Node.js端的文件任务管理的代码逻辑，把一些操作诸如获取文件大小、获取文件类型和删除文件这类的同步阻塞IO调用都换成了Node.js提倡的异步调用模式，即FS callback或Fs Promise链式调用。改动后发现卡顿情况改善不明显，遂进行了第三次尝试。</p><h4 id="第三次尝试解决问题：编写Node-js进程池分离上传任务管理逻辑">第三次尝试解决问题：编写Node.js进程池分离上传任务管理逻辑</h4><p>这次是大改😕</p><p><strong>1. 简单实现了node.js进程池</strong><br>源码：<a href="https://github.com/nojsja/javascript-learning/blob/master/file-slice-upload/service/app/services/child/libs/ChildProcessPool.class.js">ChildProcessPool.class.js</a>，主要逻辑是使用Node.js的<code>child_process</code>模块(具体使用请看<a href="http://nodejs.cn/api/child_process.html">文档</a>) 创建指定数量的多个子进程，外部通过进程池获取一个可用的进程，在进程中执行需要的代码逻辑，而在进程池内部其实就是按照顺序依次将已经创建的多个子进程中的某一个返回给外部调用即可，从而避免了其中某个进程被过度使用，省略代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildProcessPool</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; path, max=<span class="number">6</span>, cwd, env &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cwd = cwd || process.cwd();</span><br><span class="line">    <span class="built_in">this</span>.env = env || process.env;</span><br><span class="line">    <span class="built_in">this</span>.inspectStartIndex = <span class="number">5858</span>;</span><br><span class="line">    <span class="built_in">this</span>.callbacks = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.pidMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="built_in">this</span>.collaborationMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="built_in">this</span>.forked = [];</span><br><span class="line">    <span class="built_in">this</span>.forkedPath = path;</span><br><span class="line">    <span class="built_in">this</span>.forkIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.forkMaxIndex = max;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Received data from a child process */</span></span><br><span class="line">  dataRespond = <span class="function">(<span class="params">data, id</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Received data from all child processes */</span></span><br><span class="line">  dataRespondAll = <span class="function">(<span class="params">data, id</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Get a process instance from the pool */</span></span><br><span class="line">  <span class="function"><span class="title">getForkedFromPool</span>(<span class="params">id=<span class="string">&quot;default&quot;</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> forked;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.pidMap.get(id)) &#123;</span><br><span class="line">      <span class="comment">// create new process</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.forked.length &lt; <span class="built_in">this</span>.forkMaxIndex) &#123;</span><br><span class="line">        <span class="built_in">this</span>.inspectStartIndex ++;</span><br><span class="line">        forked = fork(</span><br><span class="line">          <span class="built_in">this</span>.forkedPath,</span><br><span class="line">          <span class="built_in">this</span>.env.NODE_ENV === <span class="string">&quot;development&quot;</span> ? [<span class="string">`--inspect=<span class="subst">$&#123;<span class="built_in">this</span>.inspectStartIndex&#125;</span>`</span>] : [],</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">cwd</span>: <span class="built_in">this</span>.cwd,</span><br><span class="line">            <span class="attr">env</span>: &#123; ...this.env, id &#125;,</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">this</span>.forked.push(forked);</span><br><span class="line">        forked.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> id = data.id;</span><br><span class="line">          <span class="keyword">delete</span> data.id;</span><br><span class="line">          <span class="keyword">delete</span> data.action;</span><br><span class="line">          <span class="built_in">this</span>.onMessage(&#123; data, id &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.forkIndex = <span class="built_in">this</span>.forkIndex % <span class="built_in">this</span>.forkMaxIndex;</span><br><span class="line">        forked = <span class="built_in">this</span>.forked[<span class="built_in">this</span>.forkIndex];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(id !== <span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">        <span class="built_in">this</span>.pidMap.set(id, forked.pid);</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.pidMap.values.length === <span class="number">1000</span>)</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&#x27;ChildProcessPool: The count of pidMap is over than 1000, suggest to use unique id!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.forkIndex += <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// use existing processes</span></span><br><span class="line">      forked = <span class="built_in">this</span>.forked.filter(<span class="function"><span class="params">f</span> =&gt;</span> f.pid === <span class="built_in">this</span>.pidMap.get(id))[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (!forked) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Get forked process from pool failed! the process pid: <span class="subst">$&#123;<span class="built_in">this</span>.pidMap.get(id)&#125;</span>.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> forked;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * onMessage [Received data from a process]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[Any]&#125;</span> </span>data [response data]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>id [process tmp id]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">onMessage</span>(<span class="params">&#123; data, id &#125;</span>)</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Send request to a process */</span></span><br><span class="line">  <span class="function"><span class="title">send</span>(<span class="params">taskName, params, givenId=<span class="string">&quot;default&quot;</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (givenId === <span class="string">&#x27;default&#x27;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;ChildProcessPool: Prohibit the use of this id value: [default] !&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> id = getRandomString();</span><br><span class="line">    <span class="keyword">const</span> forked = <span class="built_in">this</span>.getForkedFromPool(givenId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.callbacks[id] = resolve;</span><br><span class="line">      forked.send(&#123;<span class="attr">action</span>: taskName, params, id &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Send requests to all processes */</span></span><br><span class="line">  <span class="function"><span class="title">sendToAll</span>(<span class="params">taskName, params</span>)</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>1）使用<code>send</code>和<code>sendToAll</code>方法向子进程发送消息，前者是向某个进程发送，如果请求参数指定了id则表明需要明确使用之前与此id建立过映射的某个进程，并期望拿到此进程的回应结果；后者是向进程池中的所有进程发送信号，并期望拿到所有进程返回的结果(<mark>供调用者外部调用</mark>)。</p></li><li><p>2）其中<code>dataRespond</code>和<code>dataRespondAll</code>方法对应上面的两个信号发送方法的进程返回数据回调函数，前者拿到进程池中指定的某个进程的回调结果，后者拿到进程池中所有进程的回调结果(<mark>进程池内部方法，调用者无需关注</mark>)。</p></li><li><p>3）<code>getForkedFromPool</code>方法是从进程池中拿到一个进程，如果进程池还没有一个子进程或是已经创建的子进程数量小于设置的可创建子进程数最大值，那么会优先新创建一个子进程放入进程池，然后返回这个子进程以供调用(<mark>进程池内部方法，调用者无需关注</mark>)。</p></li><li><p>4）<code>getForkedFromPool</code>方法中值得注意的是这行代码：<code>this.env.NODE_ENV === &quot;development&quot; ? [`--inspect=$&#123;this.inspectStartIndex&#125;`] : []</code>，使用Node.js运行js脚本时加上<code>- -inspect=端口号</code> 参数可以开启所运行进程的远程调试端口，多进程程序状态追踪往往比较困难，所以采取这种方式后可以使用浏览器Devtools单独调试每个进程(具体可以在浏览器输入地址：<code>chrome://inspect/#devices</code>然后打开调试配置项，配置我们这边指定的调试端口号，最后点击蓝字<code>Open dedicated DevTools for Node</code>就能打开一个调试窗口，可以对代码进程断点调试、单步调试、步进步出、运行变量查看等操作，十分便利！)。<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="inspect.jpg"  alt="inject.jpg"></p></li></ul><p><strong>2. 分离子进程通信逻辑和业务逻辑</strong><br>另外被作为子进程执行文件载入的js文件中可以使用我封装的<a href="https://github.com/nojsja/javascript-learning/blob/master/file-slice-upload/service/app/services/child/libs/ProcessHost.class.js">ProcessHost.class.js</a>，我把它称为<code>进程事务管理中心</code>，主要功能是使用api诸如 - <code>ProcessHost.registry(taskName, func)</code>来注册多种<code>任务</code>，然后在主进程中可以直接使用进程池获取某个进程后向某个<code>任务</code>发送请求并取得<code>Promise</code>对象以拿到进程回调返回的数据，从而避免在我们的子进程执行文件中编写代码时过度关注进程之间数据的通信。<br>如果不使用<code>进程事务管理中心</code>的话我们就需要使用<code>process.send</code>来向一个进程发送消息并在另一个进程中使用<code>process.on('message', processor)</code>处理消息。需要注意的是如果注册的<code>task</code>任务是异步的则需要返回一个Promise对象而不是直接<code>return</code>数据，简略代码如下：</p><ul><li>1）registry用于子进程向事务中心注册自己的任务</li><li>2）unregistry用于取消任务注册</li><li>3）handleMessage处理进程接收到的消息并根据<code>action</code>参数调用某个任务</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessHost</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.tasks = &#123; &#125;;</span><br><span class="line">    <span class="built_in">this</span>.handleEvents();</span><br><span class="line">    process.on(<span class="string">&#x27;message&#x27;</span>, <span class="built_in">this</span>.handleMessage.bind(<span class="built_in">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* events listener */</span></span><br><span class="line">  <span class="function"><span class="title">handleEvents</span>(<span class="params"></span>)</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* received message */</span></span><br><span class="line">  <span class="function"><span class="title">handleMessage</span>(<span class="params">&#123; action, params, id &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.tasks[action]) &#123;</span><br><span class="line">      <span class="built_in">this</span>.tasks[action](params)</span><br><span class="line">      .then(<span class="function"><span class="params">rsp</span> =&gt;</span> &#123;</span><br><span class="line">        process.send(&#123; action, <span class="attr">error</span>: <span class="literal">null</span>, <span class="attr">result</span>: rsp || &#123;&#125;, id &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        process.send(&#123; action, error, <span class="attr">result</span>: error || &#123;&#125;, id &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      process.send(&#123;</span><br><span class="line">        action,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`ProcessHost: processor for action-[<span class="subst">$&#123;action&#125;</span>] is not found!`</span>),</span><br><span class="line">        <span class="attr">result</span>: <span class="literal">null</span>,</span><br><span class="line">        id,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* registry a task */</span></span><br><span class="line">  <span class="function"><span class="title">registry</span>(<span class="params">taskName, processor</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.tasks[taskName]) <span class="built_in">console</span>.warn(<span class="string">`ProcesHost: the task-<span class="subst">$&#123;taskName&#125;</span> is registered!`</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> processor !== <span class="string">&#x27;function&#x27;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;ProcessHost: the processor must be a function!&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>.tasks[taskName] = <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">Promise</span>.resolve(processor(params))</span><br><span class="line">          .then(<span class="function"><span class="params">rsp</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(rsp);</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* unregistry a task */</span></span><br><span class="line">  <span class="function"><span class="title">unregistry</span>(<span class="params">taskName</span>)</span> &#123;...&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* disconnect */</span></span><br><span class="line">  <span class="function"><span class="title">disconnect</span>(<span class="params"></span>)</span> &#123; process.disconnect(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* exit */</span></span><br><span class="line">  <span class="function"><span class="title">exit</span>(<span class="params"></span>)</span> &#123; process.exit(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">global</span>.processHost = <span class="built_in">global</span>.processHost || <span class="keyword">new</span> ProcessHost();</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">global</span>.processHost;</span><br></pre></td></tr></table></figure><p><strong>3. ChildProcessPool和ProcessHost的配合使用</strong><br>具体使用请查看上文完整<a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">demo</a><br>1）main.js (in main process)<br>主进程中引入进程池类，并创建进程池实例</p><ul><li>|——<code>path</code>参数为可执行文件路径</li><li>|——<code>max</code>指明进程池创建的最大子进程实例数量</li><li>|——<code>env</code>为传递给子进程的环境变量</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* main.js */</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> ChildProcessPool = <span class="built_in">require</span>(<span class="string">&#x27;path/to/ChildProcessPool.class&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">global</span>.ipcUploadProcess = <span class="keyword">new</span> ChildProcessPool(&#123;</span><br><span class="line">  <span class="attr">path</span>: path.join(app.getAppPath(), <span class="string">&#x27;app/services/child/upload.js&#x27;</span>),</span><br><span class="line">  <span class="attr">max</span>: <span class="number">3</span>, <span class="comment">// process instance</span></span><br><span class="line">  <span class="attr">env</span>: &#123; <span class="attr">lang</span>: <span class="built_in">global</span>.lang, <span class="attr">NODE_ENV</span>: nodeEnv &#125;</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>2）service.js (in main processs) 例子：使用进程池来发送<code>初始化分片上传</code>请求</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * init [初始化上传]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>host [主机名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>username [用户名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>file [文件描述对象]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>abspath [绝对路径]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>sharename [共享名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>fragsize [分片大小]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>prefix [目标上传地址前缀]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"> <span class="function"><span class="title">init</span>(<span class="params">&#123; username, host, file, abspath, sharename, fragsize, prefix = <span class="string">&#x27;&#x27;</span> &#125;</span>)</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> date = <span class="built_in">Date</span>.now();</span><br><span class="line">   <span class="keyword">const</span> uploadId = getStringMd5(date + file.name + file.type + file.size);</span><br><span class="line">   <span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.getUploadPrepath</span><br><span class="line">       .then(<span class="function">(<span class="params">pre</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">/* 看这里看这里！look here! */</span></span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">global</span>.ipcUploadProcess.send(</span><br><span class="line">           <span class="comment">/* 进程事务名 */</span></span><br><span class="line">           <span class="string">&#x27;init-works&#x27;</span>,</span><br><span class="line">           <span class="comment">/* 携带的参数 */</span></span><br><span class="line">           &#123;</span><br><span class="line">             username, host, sharename, pre, prefix, <span class="attr">size</span>: file.size, <span class="attr">name</span>: file.name, abspath, fragsize, <span class="attr">record</span>: </span><br><span class="line">             &#123;</span><br><span class="line">               host, <span class="comment">// 主机</span></span><br><span class="line">               <span class="attr">filename</span>: path.join(prefix, file.name), <span class="comment">// 文件名</span></span><br><span class="line">               size, <span class="comment">// 文件大小</span></span><br><span class="line">               fragsize, <span class="comment">// 分片大小</span></span><br><span class="line">               abspath, <span class="comment">// 绝对路径</span></span><br><span class="line">               <span class="attr">startime</span>: getTime(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()), <span class="comment">// 上传日期</span></span><br><span class="line">               <span class="attr">endtime</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 上传日期</span></span><br><span class="line">               uploadId, <span class="comment">// 任务id</span></span><br><span class="line">               <span class="attr">index</span>: <span class="number">0</span>,</span><br><span class="line">               <span class="attr">total</span>: <span class="built_in">Math</span>.ceil(size / fragsize),</span><br><span class="line">               <span class="attr">status</span>: <span class="string">&#x27;uploading&#x27;</span> <span class="comment">// 上传状态</span></span><br><span class="line">             &#125;</span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="comment">/* 指定一个进程调用id */</span></span><br><span class="line">           uploadId</span><br><span class="line">         )</span><br><span class="line">       &#125;)</span><br><span class="line">     .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">       resolve(&#123;</span><br><span class="line">         <span class="attr">code</span>: rsp.error ? <span class="number">600</span> : <span class="number">200</span>,</span><br><span class="line">         <span class="attr">result</span>: rsp.result,</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">       resolve(&#123;</span><br><span class="line">         <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">         <span class="attr">result</span>: err.toString()</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>3）child.js (in child process) 使用事务管理中心处理消息<br><code>child.js</code>即为创建进程池时传入的<code>path</code>参数所在的nodejs脚本代码，在此脚本中我们注册多个任务来处理从进程池发送过来的消息。<br>这段代码逻辑被单独分离到子进程中处理，其中：</p><ul><li>uploadStore - 主要用于在内存中维护整个文件上传列表，对上传任务列表进行增删查改操作(cpu耗时操作)</li><li>fileBlock - 利用FS API操作文件，比如打开某个文件的文件描述符、根据描述符和分片索引值读取一个文件的某一段Buffer数据、关闭文件描述符等等。虽然都是异步IO读写，对性能影响不大，不过为了整合nodejs端上传处理流程也将其一同纳入了子进程中管理，具体可以查看源码进行了解：<a href="https://github.com/nojsja/electron-react-template/blob/master/service/app/services/child/upload.js">源码</a></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fsPromise = fs.promises;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./child.utils&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; readFileBlock, uploadRecordStore, unlink &#125; = utils;</span><br><span class="line"><span class="keyword">const</span> ProcessHost = <span class="built_in">require</span>(<span class="string">&#x27;./libs/ProcessHost.class&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// read a file block from a path</span></span><br><span class="line"><span class="keyword">const</span> fileBlock = readFileBlock();</span><br><span class="line"><span class="comment">// maintain a shards upload queue</span></span><br><span class="line"><span class="keyword">const</span> uploadStore = uploadRecordStore();</span><br><span class="line"></span><br><span class="line"><span class="built_in">global</span>.lang = process.env.lang;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* *************** registry all tasks *************** */</span></span><br><span class="line"></span><br><span class="line">ProcessHost</span><br><span class="line">  .registry(<span class="string">&#x27;init-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> initWorks(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;upload-works&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uploadWorks(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> close(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-set&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    uploadStore.set(params);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">result</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-get&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uploadStore.get(params);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-get-all&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (uploadStore.getAll(params));</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-update&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    uploadStore.update(params);</span><br><span class="line">    <span class="keyword">return</span> (&#123;<span class="attr">result</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-remove&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    uploadStore.remove(params);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">result</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;record-reset&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    uploadStore.reset(params);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">result</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">  .registry(<span class="string">&#x27;unlink&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unlink(params);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* *************** upload logic *************** */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 上传初始化工作 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWorks</span>(<span class="params">&#123;username, host, sharename, pre, prefix, name, abspath, size, fragsize, record &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> remotePath = path.join(pre, prefix, name);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">reso</span>) =&gt;</span> fsPromise.unlink(remotePath).then(reso).catch(reso))</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> dirs = utils.getFileDirs([path.join(prefix, name)]);</span><br><span class="line">      <span class="keyword">return</span> utils.mkdirs(pre, dirs);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> fileBlock.open(abspath, size))</span><br><span class="line">    .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newRecord = &#123;</span><br><span class="line">          ...record,</span><br><span class="line">          size, <span class="comment">// 文件大小</span></span><br><span class="line">          remotePath,</span><br><span class="line">          username,</span><br><span class="line">          host,</span><br><span class="line">          sharename,</span><br><span class="line">          <span class="attr">startime</span>: utils.getTime(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()), <span class="comment">// 上传日期</span></span><br><span class="line">          <span class="attr">total</span>: <span class="built_in">Math</span>.ceil(size / fragsize),</span><br><span class="line">        &#125;;</span><br><span class="line">        uploadStore.set(newRecord);</span><br><span class="line">        <span class="keyword">return</span> newRecord;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(rsp.result);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">   .then(resolve)</span><br><span class="line">   .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    reject(error.toString());</span><br><span class="line">   &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="第四次尝试解决问题：重新审视渲染进程前端代码">第四次尝试解决问题：重新审视渲染进程前端代码</h4><ul><li>很遗憾，第三次优化对卡顿的改善依然不明显，我开始怀疑是否是前端代码直接影响的渲染进程卡顿，毕竟前端并非采用懒加载模式进行文件载入上传的(这一怀疑之前被我否定，因为前端代码完全沿用了之前浏览器端对象存储文件分片上传开发时的逻辑，而在对象存储文件上传中并未察觉到界面卡顿，属实奇怪)。摒弃了先入为主的思想，其实Electron跟浏览器环境还是有些不同，不能排除前端代码就没有问题。</li><li>在详细查看了可能耗费CPU计算的代码逻辑后，发现有一段关于刷新上传任务的函数<code>refreshTasks</code>，主要逻辑是遍历所有未经上传文件原始对象数组，然后选取固定某个数量的文件(数量取决于设置的同时上传任务个数)放入待上传文件列表中，我发现如果<code>待上传文件列表的文件数量 = 设置的同时上传任务个数</code> 的情况下就不用继续遍历剩下的文件原始对象数组了。就是少写了这个判断条件导致<code>refreshTasks</code>这个频繁操作的函数在每次执行时可能多执行数千遍for循环内层判断逻辑(具体执行次数呈O(n)次增长，n为当前任务列表任务数量)。</li><li>加上一行检测逻辑代码后，之前1000个上传任务增长到10000个左右都不会太卡了，虽然还有略微卡顿，但没有到不能使用的程度，后续还有优化空间！</li></ul><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="refreshTasks.jpg"  alt="refreshTasks"></p><h3 id="总结">总结</h3><hr><p>第一次把Electron技术应用到实际项目中，踩了挺多坑：render进程和主进程通信的问题、跨平台兼容的问题、多平台打包的问题、窗口管理的问题… 总之获得了很多经验，也整理出了一些通用解决方法。<br>Electron现在应用的项目还是挺多的，是前端同学跨足桌面软件开发领域的又一里程碑，不过需要转换一下思维模式，单纯写前端代码多是处理一些简单的界面逻辑和少量的数据，涉及到文件、系统操作、进程线程、原生交互方面的知识比较少，可以多了解一下计算机操作系统方面的知识、掌握代码设计模式和一些基本的算法优化方面的知识能让你更加胜任Electron桌面软件开发任务！</p>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upload </tag>
            
            <tag> smb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Electron的smb客户端开发记录</title>
      <link href="/blogs/2020/07/17/c1579944.html/"/>
      <url>/blogs/2020/07/17/c1579944.html/</url>
      
        <content type="html"><![CDATA[<h3 id="前言">前言</h3><hr><p>最近拿到客户需求，需要利用现有存储产品部分后台接口和原生smb协议来实现一个windows平台的smb客户端，主要功能需要包含：存储集群节点管理、集群用户登录、远程共享目录挂载、共享目录浏览、目录权限设置、文件上传管理，其中目录权限设置和目录浏览接口已经被提供，其余几个功能的electron代码和web端代码需要由我负责。考虑整个项目由前端同事来实现且数据存储量较小、数据关系不复杂，所以技术选型方面使用了支持跨平台的Electron框架和易用的的本地json数据库<a href="https://github.com/typicode/lowdb">lowdb</a>。</p><p>项目精简版[DEMO]展示(<a href="https://github.com/nojsja/electron-react-template">https://github.com/nojsja/electron-react-template</a>)</p><h3 id="功能需求">功能需求</h3><hr><h4 id="集群节点管理">集群节点管理</h4><ol><li>客户端需要支持多个节点(每个节点所属集群不同)的添加、删除操作</li><li>支持设置默认节点操作用于自动登录功能</li><li>添加节点的时候要进行ping逻辑判断目标节点是否可用</li><li>调用存储集群ID获取接口保证每个集群只有一个节点被添加到集群管理列表</li></ol><p>需求分析：节点IP列表、默认节点属性、节点用户登录信息均需要在本地json数据库存储管理，以便数据记录。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_node.jpg"  alt="RhinoDisk"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_node_conf.jpg"  alt="RhinoDisk"></p><h4 id="集群用户登录">集群用户登录</h4><ol><li>支持已登录过客户端的用户自动下拉提示</li><li>支持已记住密码的用户自动填充密码到输入框</li><li>如果设置了默认节点，且默认节点的当前用户密码已经记住，则启动客户端时自动执行登录，类似QQ登录面板</li></ol><p>需求分析：调用已有登录接口验证smb用户名和密码是否正确，然后拿到具有接口操作权限的access_token(注意直接走smb协议的操作无需使用token)，并且在本地json数据库存储用户名、密码、自动登录标识、用户节点登录记录等。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_login.jpg"  alt="RhinoDisk"></p><h4 id="远程共享目录挂载">远程共享目录挂载</h4><ol><li>windows资源管理器原生功能一样，将远程主机的smb共享挂载为本地的一个磁盘，方便用户使用windows资源管理器直接对文件和目录进行操作</li><li>选择挂载设备时需要弹出所有空闲的磁盘盘符，支持范围C-Z</li></ol><p>需求分析：同windows资源管理器原生功能一样，将远程主机的smb共享挂载为本地的一个磁盘，方便用户使用windows资源管理器直接对文件和目录进行操作，所有挂载信息包括空闲盘符、共享挂载状态 均需要使用windows cmd命令即时获取以防数据不一致的情况。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_share.jpg"  alt="RhinoDisk"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_share_mount.jpg"  alt="RhinoDisk"></p><h4 id="文件上传管理">文件上传管理</h4><ol><li>文件上传管理能够查看当前任务列表的任务详情，包含上传速度、上传时间、完成时间、文件大小、文件名称，勾选进行中的任务后能够进行暂停、重传、删除、续传等操作。</li><li>在任务列表的所有文件都被上传后会进行一次历史任务同步，把内存中的任务列表状态写入文件中。</li><li>任务历史记录中可以进行删除任务记录、恢复上传错误的历史任务(重传)等操作。</li><li>切换不同节点重新登录用户上传任务不受影响，在当前节点重新登录用户上传任务会被强制终止，退出客户端后上传任务会被强制终止，各个用户的上传任务列表均不相同互不干扰，所有被强制终止的任务都能从历史任务列表中中恢复。</li></ol><p>需求分析：当前任务列表即时存储于内存中，以便快速进行增删查改操作，任务历史记录使用json数据库进行本地存储；每次任务列表自动同步时将内存中的任务写入到本地json数据库里，并且任务列表数据从内存中释放。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_upload_now.jpg"  alt="RhinoDisk"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="smb_upload_record.jpg"  alt="RhinoDisk"></p><h3 id="实现难点">实现难点</h3><hr><h4 id="多语言功能实现">多语言功能实现</h4><p>总体逻辑是通过配置文件或参数声明引入某个语言目录下的所有语言配置文件即可，注意每次更改语言后将lang配置写入文件，下次启动应用时读取文件配置然后调用下面声明的方法加载语言文件即可。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="electron-lang.png"  alt="lang"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * global.lang -- 内存里保存的所有语言数据</span></span><br><span class="line"><span class="comment"> * global.LANG -- 语言数据标识(en_us, zh_cn, zh_tw)</span></span><br><span class="line"><span class="comment"> * session.lang -- 在session里保存一份语言数据标识，防止用户cookie丢失时语言设置失效(session 持久化)</span></span><br><span class="line"><span class="comment"> * cookie.lang -- 保存在客户端的语言数据标识，session.lang和cookie.lang保持同步</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> lang = (<span class="function"><span class="keyword">function</span> <span class="title">lang</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> defaultLang = <span class="string">&#x27;zh_CN&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ------------------- 获取统一的语言环境标识 ------------------- */</span></span><br><span class="line">  <span class="keyword">const</span> getLANG = <span class="function">(<span class="params">acceptLang</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 英语</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">&#x27;en-US&#x27;</span>, <span class="string">&#x27;en&#x27;</span>, <span class="string">&#x27;en-us&#x27;</span>, <span class="string">&#x27;en_us&#x27;</span>, <span class="string">&#x27;en_US&#x27;</span>].indexOf(acceptLang) !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;en_us&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 中文简体</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">&#x27;zh-CN&#x27;</span>, <span class="string">&#x27;zh&#x27;</span>, <span class="string">&#x27;zh-cn&#x27;</span>, <span class="string">&#x27;zh_cn&#x27;</span>, <span class="string">&#x27;zh_CN&#x27;</span>].indexOf(acceptLang) !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;zh_cn&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">if</span> ([<span class="string">&#x27;zh-TW&#x27;</span>, <span class="string">&#x27;zh-tw&#x27;</span>, <span class="string">&#x27;zh_tw&#x27;</span>, <span class="string">&#x27;zh_TW&#x27;</span>].indexOf(acceptLang) !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;zh_tw&#x27;</span>;</span><br><span class="line">    <span class="comment">// 默认中文简体</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;zh_cn&#x27;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ------------------- 加载语言文件 ------------------- */</span></span><br><span class="line">  <span class="keyword">const</span> setLang = <span class="function">(<span class="params">langEnv</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">global</span>.lang = <span class="built_in">global</span>.lang ? <span class="built_in">global</span>.lang : &#123;&#125;;</span><br><span class="line">    <span class="built_in">global</span>.LANG = langEnv;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取文件夹的语言配置文件写入全局配置</span></span><br><span class="line">    fs.readdir(path.join(app.getAppPath(), <span class="string">&#x27;app/lang&#x27;</span>, langEnv), <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">global</span>.lang[path.basename(file)] = <span class="built_in">require</span>(path.join(app.getAppPath(), <span class="string">&#x27;app/lang&#x27;</span>, langEnv, file));</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">acceptLang</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _lang = getLANG(acceptLang || defaultLang);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">global</span>.LANG &amp;&amp; <span class="built_in">global</span>.LANG == _lang) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置目前的语言环境</span></span><br><span class="line">    setLang(_lang);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = lang;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="托盘功能的实现">托盘功能的实现</h4><p>使用Electron的Tray创建托盘菜单，Menu.buildFromTemplate方法创建菜单子项以及对应的事件回调函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">contextMenu</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">global</span>.appTray = <span class="keyword">new</span> Tray(path.join(app.getAppPath(), os.type() === <span class="string">&#x27;Windows_NT&#x27;</span> ? <span class="string">`resources/icon_<span class="subst">$&#123;<span class="built_in">this</span>.envConf.work_env&#125;</span>.ico`</span> : <span class="string">&#x27;resources/mac_tray.png&#x27;</span>));</span><br><span class="line">    <span class="keyword">const</span> menu = Menu.buildFromTemplate( [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">label</span>: <span class="built_in">global</span>.lang.public.quit,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;normal&#x27;</span>,</span><br><span class="line">          <span class="attr">click</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.sendToWeb(<span class="string">&#x27;upload&#x27;</span>, &#123;<span class="attr">action</span>: <span class="string">&#x27;getUploadingTask&#x27;</span>&#125;);</span><br><span class="line">            ipcMainProcess.ipc.once(<span class="string">&#x27;upload-getUploadingTask&#x27;</span>, <span class="function">(<span class="params">event, rsp</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">                  <span class="built_in">global</span>.ipcMainWindow.sendToWeb(<span class="string">&#x27;shell&#x27;</span>, &#123; <span class="attr">action</span>: <span class="string">&#x27;upload-clear&#x27;</span> &#125;);</span><br><span class="line">                  .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">global</span>.appTray.destroy();</span><br><span class="line">                    app.quit();</span><br><span class="line">                  &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">global</span>.ipcMainProcess.notifySend(&#123;</span><br><span class="line">                      <span class="attr">body</span>: <span class="built_in">global</span>.lang.public[<span class="string">&#x27;data_write_failed_before_quit&#x27;</span>]</span><br><span class="line">                    &#125;);</span><br><span class="line">                  &#125;);</span><br><span class="line">                &#125;;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (rsp.result !== <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="keyword">const</span> buttonId = dialog.showMessageBoxSync(<span class="built_in">this</span>.windowoptions, &#123;</span><br><span class="line">                    <span class="attr">defaultId</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">buttons</span>: [<span class="string">&#x27;No&#x27;</span>, <span class="string">&#x27;Yes&#x27;</span>],</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">                    <span class="attr">title</span>: <span class="built_in">global</span>.lang.public.tips,</span><br><span class="line">                    <span class="attr">message</span>: <span class="built_in">global</span>.lang.upload.app_quit_tips</span><br><span class="line">                  &#125;);</span><br><span class="line">                  <span class="keyword">if</span> (buttonId === <span class="number">1</span>) quitApp();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  quitApp();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">global</span>.ipcMainProcess.notifySend(&#123;</span><br><span class="line">                  <span class="attr">body</span>: rsp.result</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">global</span>.appTray.on(<span class="string">&#x27;click&#x27;</span>, <span class="function">()=&gt;</span>&#123;    </span><br><span class="line">      <span class="built_in">this</span>.window.show();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">global</span>.appTray.setToolTip(<span class="string">&#x27;RninoDisk&#x27;</span>);</span><br><span class="line">    <span class="built_in">global</span>.appTray.setContextMenu(menu);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="Node执行操作系统命令">Node执行操作系统命令</h4><ol><li>通用的系统命令执行函数(日志输出阻塞版本)<br>使用Node.js的<code>child_process.exec</code>函数衍生 shell，然后在 shell 中执行 command，会在命令执行完成之后将所有信息输出到控制台。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> child = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [exec 执行一个命令，阻塞输出信息到控制台]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123; [String] &#125;</span>  </span>command    [命令]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123; [Array | String] &#125;</span>   </span>params  [参数数组]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123; [Object] &#125;</span>  </span>options [exec可定制的参数]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123; Promise &#125;</span>           </span>[返回Promise对象]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="built_in">exports</span>.exec = <span class="function">(<span class="params">_command, _params=[], _options=&#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> params = <span class="built_in">Array</span>.isArray(_params) ? _params.join(<span class="string">&#x27; &#x27;</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> options = (<span class="built_in">String</span>(_params) === <span class="string">&#x27;[object Object]&#x27;</span>) ? _params : (_options);</span><br><span class="line">  <span class="keyword">const</span> command = <span class="string">`<span class="subst">$&#123;_command&#125;</span> <span class="subst">$&#123;params&#125;</span>`</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(params, options, command);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    child.exec(command, options, <span class="function">(<span class="params">_err, _stdout, _stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (_err) &#123;</span><br><span class="line">        <span class="built_in">exports</span>.console_log(_err, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line">        resolve(&#123;<span class="attr">code</span>: <span class="number">1</span>, <span class="attr">result</span>: _err&#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_stderr &amp;&amp; _stderr.toString()) &#123;</span><br><span class="line">        <span class="built_in">exports</span>.console_log(_stderr, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line">        resolve(&#123;<span class="attr">code</span>: <span class="number">1</span>, <span class="attr">result</span>: _stderr&#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(_stdout);</span><br><span class="line">        resolve(&#123;<span class="attr">code</span>: <span class="number">0</span>, <span class="attr">result</span>: _stdout&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>通用的系统命令执行函数(日志同步输出版本)<br>使用Node.js的<code>child_process.exec</code>函数衍生 shell，然后在 shell 中执行 command，所有控制台日志会同步输出。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> child = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [execRealtime 执行一个命令，实时输出信息到控制台]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123; [String] &#125;</span>  </span>command    [命令]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123; [Array | String] &#125;</span>   </span>params  [参数数组]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123; [Object] &#125;</span>  </span>options [exec可定制的参数]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123; Promise &#125;</span>           </span>[返回Promise对象]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">exports</span>.execRealtime = <span class="function">(<span class="params">_command, _params=[], _options=&#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> params = <span class="built_in">Array</span>.isArray(_params) ? _params.join(<span class="string">&#x27; &#x27;</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> options = (<span class="built_in">String</span>(_params) === <span class="string">&#x27;[object Object]&#x27;</span>) ? _params : (_options);</span><br><span class="line">  <span class="keyword">const</span> command = <span class="string">`<span class="subst">$&#123;_command&#125;</span> <span class="subst">$&#123;params&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">&#x27;&#x27;</span>, error = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(params, options, command);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = child.exec(command, options);</span><br><span class="line">    </span><br><span class="line">    result.stdout.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">exports</span>.console_log(data, <span class="string">&#x27;white&#x27;</span>);</span><br><span class="line">      data += <span class="string">`<span class="subst">$&#123;data&#125;</span>`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    result.stderr.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">exports</span>.console_log(data, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line">      error += <span class="string">`<span class="subst">$&#123;data&#125;</span>`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    result.on(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;code, <span class="attr">result</span>: data, error&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="远程共享目录挂载-2">远程共享目录挂载</h4><ol><li>获取空闲盘符和已经挂载盘符</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * getSystemDriveLetter [获取系统已经挂载的磁盘]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return <span class="type">&#123;[Array]&#125;</span> </span>[盘符列表]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">getSystemDriveLetter</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.sudo.exec(<span class="string">&#x27;fsutil fsinfo drives&#x27;</span>, [], &#123; <span class="attr">encoding</span>: <span class="string">&#x27;buffer&#x27;</span> &#125;).then(<span class="function">(<span class="params">stdout</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> driverstr = stdout;</span><br><span class="line">        <span class="keyword">const</span> driverstrArr = driverstr.split(<span class="string">&#x27; &#x27;</span>).filter(<span class="function"><span class="params">s</span> =&gt;</span> s !== os.EOL).map(<span class="function"><span class="params">s</span> =&gt;</span> s.replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;&#x27;</span>));</span><br><span class="line">        <span class="keyword">const</span> allDrivers = [</span><br><span class="line">          <span class="string">&#x27;C:&#x27;</span>, <span class="string">&#x27;D:&#x27;</span>, <span class="string">&#x27;E:&#x27;</span>, <span class="string">&#x27;F:&#x27;</span>, <span class="string">&#x27;G:&#x27;</span>, <span class="string">&#x27;H:&#x27;</span>, <span class="string">&#x27;I:&#x27;</span>, <span class="string">&#x27;J:&#x27;</span>, <span class="string">&#x27;K:&#x27;</span>, <span class="string">&#x27;L:&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;M:&#x27;</span>, <span class="string">&#x27;N:&#x27;</span>, <span class="string">&#x27;O:&#x27;</span>, <span class="string">&#x27;P:&#x27;</span>, <span class="string">&#x27;Q:&#x27;</span>, <span class="string">&#x27;R:&#x27;</span>, <span class="string">&#x27;S:&#x27;</span>, <span class="string">&#x27;T:&#x27;</span>, <span class="string">&#x27;U:&#x27;</span>, <span class="string">&#x27;V:&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;W:&#x27;</span>, <span class="string">&#x27;X:&#x27;</span>, <span class="string">&#x27;Y:&#x27;</span>, <span class="string">&#x27;Z:&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">        driverstrArr.shift();</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">          <span class="attr">result</span>: &#123;</span><br><span class="line">            <span class="attr">mounted</span>: driverstrArr,</span><br><span class="line">            <span class="attr">available</span>: allDrivers.filter(<span class="function"><span class="params">d</span> =&gt;</span> !driverstrArr.includes(d.toLocaleUpperCase()))</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">          <span class="attr">result</span>: err,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>通过UNC命令对远程共享进行挂载</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 挂载共享 */</span></span><br><span class="line"><span class="function"><span class="title">_mountSystemDriver_Windows_NT</span>(<span class="params">&#123; host, driver, path, auto = <span class="literal">false</span> &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pwd = <span class="built_in">global</span>.ipcMainProcess.userModel.get(<span class="string">&#x27;last.pwd&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; isThirdUser, nickname, isLocalUser, username &#125; = <span class="built_in">global</span>.ipcMainProcess.userModel.info;</span><br><span class="line">    <span class="keyword">const</span> commandUseIPC = <span class="string">`net use \\\\<span class="subst">$&#123;host&#125;</span>\\ipc$ &quot;<span class="subst">$&#123;pwd&#125;</span>&quot; /user:&quot;<span class="subst">$&#123;username&#125;</span>&quot;`</span>;</span><br><span class="line">    <span class="keyword">const</span> commandMount = <span class="string">`net use <span class="subst">$&#123;driver&#125;</span> \\\\<span class="subst">$&#123;host&#125;</span>\\<span class="subst">$&#123;path&#125;</span> &quot;<span class="subst">$&#123;pwd&#125;</span>&quot; /user:&quot;<span class="subst">$&#123;username&#125;</span>&quot;`</span>;</span><br><span class="line">    <span class="keyword">const</span> commandUmount = <span class="string">`net use <span class="subst">$&#123;driver&#125;</span> /del /y`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取系统已经挂载的磁盘和空闲的磁盘</span></span><br><span class="line">      <span class="built_in">this</span>.getSystemDriveLetter()</span><br><span class="line">        .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rsp.result.mounted.includes(driver.toLocaleUpperCase())) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="built_in">global</span>.lang.node.driver_already_mount);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="built_in">global</span>.lang.node.get_system_mount_info_failed);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 尝试UNC连接</span></span><br><span class="line">        .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">this</span>.sudo.exec(commandUseIPC);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 执行挂载命令</span></span><br><span class="line">        .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">this</span>.sudo.exec(commandMount);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">this</span>.update(<span class="string">&#x27;mountPoint&#x27;</span>, &#123; username, host, path &#125;, &#123;</span><br><span class="line">            username, host, path, driver, auto</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;).then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">              username, host, driver</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.error(err, err.toString());</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="built_in">global</span>.lang.node.net_mount_failed_reason,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="文件上传管理-2">文件上传管理</h4><p>前端界面沿用之前的AWS对象存储文件上传管理逻辑<a href="https://nojsja.gitee.io/blogs/2020/03/07/%E5%9F%BA%E4%BA%8Es3%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%A4%9A%E6%96%87%E4%BB%B6%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E7%9A%84Javascript%E5%AE%9E%E7%8E%B0-%E4%B8%80/">基于s3对象存储多文件分片上传的Javascript实现(一)</a>，不同的地方是加入了<code>历史任务</code>功能用于持久化文件上传任务记录功能，失败的任务能在历史任务中重新启动。由于smb简单文件上传协议不支持文件分片管理功能，所以前端界面的上传进度获取和上传速度计算均是基于 Node.js 的 FS API实现，整体流程是：使用Windows UNC命令连接后端共享，然后可以像访问本地文件系统一样访问远程一个共享路径，比如<code>\\[host]\[sharename]\file1</code>，这样子文件上传就变成本地目录文件的复制、删除、重命名了。</p><p>下图为前端界面的上传逻辑示意图：<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="shards_upload.jpg"  alt="upload"></p><h5 id="上传流程描述">上传流程描述</h5><ol><li>页面上使用<code>&lt;Input /&gt;</code>组件拿到FileList对象(Electron环境下拿到的File对象会额外附加一个<code>path</code>属性指明文件位于系统的绝对路径)</li><li>缓存拿到的FileList，等待点击上传按钮后开始读取FileList列表并生成自定义的File文件对象数组用于存储上传任务列表信息<br>3）页面调用init请求附带上选中的文件信息初始化文件上传任务<br>4）Node.js拿到init请求附带的文件信息后，将所有信息存入临时存放在内存中的文件上传列表中，并尝试打开待上传文件的文件描述符用于即将开始的文件切片分段上传工作<br>5）页面拿到init请求成功的回调后，存储返回的上传任务ID，并将该文件加入文件待上传队列，在合适的时机开始上传，开始上传的时候向Node.js端发送upload请求，同时请求附带上任务ID和当前的分片索引值(表示需要上传第几个文件分片)<br>6）Node.js拿到upload请求后根据携带的任务ID读取内存中的上传任务信息，然后使用第二步打开的文件描述符和分片索引对本地磁盘中的目标文件进行分片切割，最后使用FS API将分片递增写入目标位置<br>7）upload请求成功后页面判断是否已经上传完所有分片，如果完成则向Node.js发送complete请求，同时携带上任务ID<br>8）Node.js根据任务ID获取文件信息，关闭文件描述符，更新文件上传状态<br>9）界面上传任务列表清空后，向后端发送sync请求，用于把当前任务同步到历史任务中，表明当前所有任务已经完成<br>10）Node.js拿到sync请求后，把内存中存储的所有文件上传列表信息写入磁盘，同时释放内存占用，完成一次列表任务上传</li></ol><h5 id="Node-js-Electron-端的部分关键代码">Node.js(Electron)端的部分关键代码</h5><ol><li>初始化一个上传任务</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * init [初始化上传]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>host [主机名]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>username [用户名]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>file [文件对象]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>abspath [文件绝对路径]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>sharename [远程smb共享名]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>fragsize [分片大小]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">init</span>(<span class="params">&#123; host, file, abspath, sharename, fragsize, prefix = <span class="string">&#x27;&#x27;</span> &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pre = <span class="string">`\\\\<span class="subst">$&#123;host&#125;</span>\\<span class="subst">$&#123;sharename&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">const</span> &#123; pwd, username &#125; = <span class="built_in">global</span>.ipcMainProcess.userModel.info;</span><br><span class="line">    <span class="keyword">const</span> uploadId = getStringMd5(date + file.name + file.type + file.size);</span><br><span class="line">    <span class="keyword">let</span> remotePath = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 使用UNC命令连接后端smb共享</span></span><br><span class="line">      <span class="built_in">this</span>.uncCommandConnect(&#123; host, username, pwd, sharename &#125;)</span><br><span class="line">        .then(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">reso</span>) =&gt;</span> &#123;</span><br><span class="line">          remotePath = path.join(pre, prefix, file.name);</span><br><span class="line">          fsPromise.unlink(path.join(pre, prefix, file.name)).then(reso).catch(reso);</span><br><span class="line">        &#125;))</span><br><span class="line">        .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 分析绝对文件路径名，然后自动创建所有需要创建的文件夹</span></span><br><span class="line">          <span class="keyword">const</span> dirs = getFileDirs([path.join(prefix, file.name)]);</span><br><span class="line">          <span class="keyword">return</span> mkdirs(pre, dirs);</span><br><span class="line">        &#125;)</span><br><span class="line">        .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 打开文件描述符</span></span><br><span class="line">          <span class="keyword">return</span> fileBlock.open(abspath)</span><br><span class="line">        &#125;)</span><br><span class="line">        .then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// 临时存储文件上传信息在内存中</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>._setUploadRecordsInMemory(&#123;</span><br><span class="line">              username,</span><br><span class="line">              host,</span><br><span class="line">              <span class="attr">filename</span>: path.join(prefix, file.name),</span><br><span class="line">              <span class="attr">size</span>: file.size,</span><br><span class="line">              fragsize,</span><br><span class="line">              sharename,</span><br><span class="line">              abspath,</span><br><span class="line">              remotePath,</span><br><span class="line">              <span class="attr">startime</span>: getTime(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()), <span class="comment">// 上传日期</span></span><br><span class="line">              <span class="attr">endtime</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">              uploadId,</span><br><span class="line">              <span class="attr">index</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="attr">total</span>: <span class="built_in">Math</span>.ceil(size / fragsize),</span><br><span class="line">              <span class="attr">status</span>: <span class="string">&#x27;uploading&#x27;</span> <span class="comment">// 上传状态</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(rsp);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;).then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">              uploadId,</span><br><span class="line">              size,</span><br><span class="line">              <span class="attr">total</span>: <span class="built_in">Math</span>.ceil(size / fragsize)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>上传文件</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * upload [上传文件]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>index [分片索引，0为起始值]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>uploadId [上传任务ID]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">upload</span>(<span class="params">&#123; uploadId, index &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件信息</span></span><br><span class="line">    <span class="keyword">const</span> record = <span class="built_in">this</span>._getUploadRecordsInMemory(uploadId);</span><br><span class="line">    <span class="keyword">if</span> (!record) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123; <span class="attr">code</span>: <span class="number">600</span>, <span class="attr">result</span>: lang.upload.readDataFailed &#125;);</span><br><span class="line">    <span class="keyword">if</span> (record.status !== <span class="string">&#x27;uploading&#x27;</span>) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123; <span class="attr">code</span>: <span class="number">600</span>, <span class="attr">result</span>: lang.upload.readDataFailed &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; host, filename, size, sharename, fragsize, abspath, username &#125; = record;</span><br><span class="line">    <span class="keyword">const</span> pwd = <span class="built_in">global</span>.ipcMainProcess.userModel.info.pwd;</span><br><span class="line">    <span class="keyword">const</span> pre = <span class="string">`\\\\<span class="subst">$&#123;host&#125;</span>\\<span class="subst">$&#123;sharename&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> position = fragsize * (index);</span><br><span class="line">    <span class="keyword">const</span> slicesize = ((fragsize * (index + <span class="number">1</span>)) &lt;= size) ? fragsize : (size - fragsize * index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (position &gt; size) &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">          <span class="attr">result</span>: lang.upload.upload_index_overflow</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 读取一个文件分片</span></span><br><span class="line">      fileBlock.read(abspath, position, slicesize)</span><br><span class="line">        .then(<span class="function"><span class="params">rsp</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (rsp.code === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// 递增写入文件</span></span><br><span class="line">            fs.appendFile(path.join(pre, filename), rsp.result, &#123; <span class="attr">encoding</span>: <span class="string">&#x27;binary&#x27;</span> &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="comment">// 排查错误原因</span></span><br><span class="line">                checkPermission(path.join(pre, filename, <span class="string">&#x27;..&#x27;</span>), <span class="string">&#x27;ew&#x27;</span>, <span class="function">(<span class="params">err2, isExit, canWrite</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (err2) &#123;</span><br><span class="line">                    resolve(&#123;</span><br><span class="line">                      <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">                      <span class="attr">result</span>: <span class="built_in">global</span>.lang.upload.writeDataFailed</span><br><span class="line">                    &#125;);</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isExit &amp;&amp; !canWrite) &#123;</span><br><span class="line">                    resolve(&#123;</span><br><span class="line">                      <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">                      <span class="attr">result</span>: <span class="built_in">global</span>.lang.upload.insufficientPermissionUpload</span><br><span class="line">                    &#125;);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    resolve(&#123;</span><br><span class="line">                      <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">                      <span class="attr">result</span>: <span class="built_in">global</span>.lang.upload.writeDataFailed</span><br><span class="line">                    &#125;);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 更新内存中的文件上传分片信息</span></span><br><span class="line">                <span class="built_in">this</span>._updateUploadRecordsInMemory(&#123; <span class="attr">index</span>: (index + <span class="number">1</span>) &#125;, uploadId);</span><br><span class="line">                resolve(&#123;</span><br><span class="line">                  <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">                  <span class="attr">result</span>: &#123; filename, uploadId, index, abspath, sharename &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (!<span class="built_in">this</span>._getUploadRecordsInMemory(uploadId) || <span class="built_in">this</span>._getUploadRecordsInMemory(uploadId).status === <span class="string">&#x27;error&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="built_in">console</span>.log(<span class="string">&#x27;--uploading-unlink&#x27;</span>, path.join(pre, filename));</span><br><span class="line">                  fs.unlinkSync(path.join(pre, filename));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                  <span class="built_in">console</span>.log(error);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(rsp);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>完成一个文件上传任务</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * upload [完成上传]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>uploadId [上传任务ID]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="title">complete</span>(<span class="params">&#123; uploadId &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件信息</span></span><br><span class="line">    <span class="keyword">const</span> record = <span class="built_in">this</span>._getUploadRecordsInMemory(uploadId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!record) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123; <span class="attr">code</span>: <span class="number">600</span>, <span class="attr">result</span>: lang.upload.readDataFailed &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; abspath &#125; = record;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 更新上传任务状态</span></span><br><span class="line">      <span class="built_in">this</span>._updateUploadRecordsInMemory(&#123; <span class="attr">status</span>: <span class="string">&#x27;break&#x27;</span>, <span class="attr">endtime</span>: getTime(<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()) &#125;, uploadId);</span><br><span class="line">      <span class="comment">// 关闭文件描述符</span></span><br><span class="line">      fileBlock.close(abspath).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">          <span class="attr">result</span>: uploadId</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">          <span class="attr">result</span>: err.toString()</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>文件分片读取管理工厂<br>文件初始化的时候调用<code>open</code>方法临时存储文件描述符和文件绝对路径的映射关系；文件上传的时候调用<code>read</code>方法根据文件读取位置、读取容量大小进行分片切割；文件上传完成的时候关闭文件描述符；</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * readFileBlock [读取文件块]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.readFileBlock = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fdStore = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> smallFileMap = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">/* 打开文件描述符 */</span></span><br><span class="line">    <span class="attr">open</span>: <span class="function">(<span class="params">path, size, minSize=<span class="number">1024</span>*<span class="number">2</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 小文件不打开文件描述符，直接读取写入</span></span><br><span class="line">          <span class="keyword">if</span> (size &lt;= minSize) &#123;</span><br><span class="line">            smallFileMap[path] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">fd</span>: <span class="literal">null</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 打开文件描述符，建议绝对路径和fd的映射关系</span></span><br><span class="line">          fs.open(path, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, fd</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="built_in">console</span>.trace(err);</span><br><span class="line">              resolve(&#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">601</span>,</span><br><span class="line">                <span class="attr">result</span>: err.toString()</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              fdStore[path] = fd;</span><br><span class="line">              resolve(&#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                  <span class="attr">fd</span>: fdStore[path]</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* 读取文件块 */</span></span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">path, position, length</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> callback = <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">              <span class="attr">result</span>: err.toString()</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="attr">result</span>: data</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 小文件直接读取，大文件使用文件描述符和偏移量读取</span></span><br><span class="line">          <span class="keyword">if</span> (smallFileMap[path]) &#123;</span><br><span class="line">            fs.readFile(path, <span class="function">(<span class="params">err, buffer</span>) =&gt;</span> &#123;</span><br><span class="line">              callback(err, buffer);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 空文件处理</span></span><br><span class="line">            <span class="keyword">if</span> (length === <span class="number">0</span>) <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">            fs.read(fdStore[path], Buffer.alloc(length), <span class="number">0</span>, length, position, <span class="function"><span class="keyword">function</span>(<span class="params">err, readByte, readResult</span>)</span>&#123;</span><br><span class="line">              callback(err, readResult);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 关闭文件描述符 */</span></span><br><span class="line">    <span class="attr">close</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (smallFileMap[path]) &#123;</span><br><span class="line">            <span class="keyword">delete</span> smallFileMap[path];</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.close(fdStore[path], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">              resolve(&#123;<span class="attr">code</span>: <span class="number">200</span>&#125;);</span><br><span class="line">              <span class="keyword">delete</span> fdStore[path];</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.trace(err);</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">result</span>: err.toString()</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    fdStore</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="windows安装包自动化打包配置">windows安装包自动化打包配置</h4><p>windows安装包使用electron nsis配置，注意使用<code>.ico</code>格式的应用图标以免打包失败，package.json中的<code>build.files</code>字段声明了需要打包的所有文件，<code>build.win</code>是windows平台的打包配置，<code>build.nsis</code>是nsis打包的详细配置，运行<code>npm run build-win</code>即可开始win平台的Electron App打包，由于整个打包流程包含web打包和electron打包，使用Node.js编写了通用打包脚本<a href="https://github.com/nojsja/electron-react-template/blob/master/build.js">项目build.js</a>、<a href="https://github.com/nojsja/electron-react-template/blob/master/server/build.js">electron build.js</a>对整个流程进行了整合，<code>项目build.js</code>兼顾web打包以及调用<code>electron build.js</code>负责Electron App打包，使用<code>node build.js --help</code>查看所有打包命令帮助信息。</p><p><strong>node build.js - -help</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">description: build <span class="built_in">command</span> <span class="keyword">for</span> RhinoDisk.</span><br><span class="line">    <span class="built_in">command</span>: node build.js [action] [config]</span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    |______ param: [--<span class="built_in">help</span> | -h ] =&gt; show usage info.</span><br><span class="line">    |______ param: [build-win   ] [--edit | --office] =&gt; build package <span class="keyword">for</span> windows, the default conf file is ./server/config.json.</span><br><span class="line">    |______ param: [build-linux ] [--edit | --office] =&gt; build package <span class="keyword">for</span> linux, the default conf file is ./server/config.json</span><br><span class="line">    |______ param: [build-mac   ] [--edit | --office] =&gt; build package <span class="keyword">for</span> mac, the default conf file is ./server/config.json</span><br><span class="line">    |______ param: [build-all   ] [--edit | --office] =&gt; build package <span class="keyword">for</span> all platform, the default conf file is ./server/config.json</span><br><span class="line">    |______ param: [clean-build ] =&gt; clean build directory after build</span><br><span class="line">    |</span><br><span class="line">    |______ example1: node build.js build-win</span><br><span class="line">    |______ example2: node build.js build-linux</span><br><span class="line">    |______ example3: node build.js build-mac</span><br><span class="line">    |______ example4: node build.js build-all</span><br><span class="line">    |______ example5: node build.js build-win --edit</span><br><span class="line">    |______ example6: node build.js build-win --office</span><br><span class="line">    |______ example7: node build.js --<span class="built_in">help</span></span><br><span class="line">    |______ example8: node build.js clean-build</span><br></pre></td></tr></table></figure><p><strong>package.json：</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;RhinoDisk&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;SMB management client&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&quot;build-win&quot;</span>: <span class="string">&quot;electron-builder --win&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;build&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;productName&quot;</span>: <span class="string">&quot;RhinoDisk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;appId&quot;</span>: <span class="string">&quot;org.datatom.rhinodisk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;asar&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;copyright&quot;</span>: <span class="string">&quot;CopyRight © 2011-2020 上海德拓信息技术股份有限公司&quot;</span>,</span><br><span class="line">    <span class="string">&quot;directories&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buildResources&quot;</span>: <span class="string">&quot;build&quot;</span>,</span><br><span class="line">      <span class="string">&quot;output&quot;</span>: <span class="string">&quot;build&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;package.json&quot;</span>,</span><br><span class="line">      <span class="string">&quot;config.json&quot;</span>,</span><br><span class="line">      <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;dist/&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/&quot;</span>,</span><br><span class="line">      <span class="string">&quot;node_modules/&quot;</span>,</span><br><span class="line">      <span class="string">&quot;resources/*.*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;win&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;icon&quot;</span>: <span class="string">&quot;build/iconx256.ico&quot;</span>,</span><br><span class="line">      <span class="string">&quot;target&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;target&quot;</span>: <span class="string">&quot;zip&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;target&quot;</span>: <span class="string">&quot;nsis&quot;</span>,</span><br><span class="line">          <span class="string">&quot;arch&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;x64&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;nsis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;oneClick&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;allowElevation&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;allowToChangeInstallationDirectory&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;installerIcon&quot;</span>: <span class="string">&quot;./build/iconx256.ico&quot;</span>,</span><br><span class="line">      <span class="string">&quot;uninstallerIcon&quot;</span>: <span class="string">&quot;./build/iconx256.ico&quot;</span>,</span><br><span class="line">      <span class="string">&quot;installerHeaderIcon&quot;</span>: <span class="string">&quot;./build/iconx256.ico&quot;</span>,</span><br><span class="line">      <span class="string">&quot;createDesktopShortcut&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;createStartMenuShortcut&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;deleteAppDataOnUninstall&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;shortcutName&quot;</span>: <span class="string">&quot;RhinoDisk&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="总结">总结</h3><hr><p>第一次把Electron技术应用到实际项目中，踩了挺多坑：render进程和主进程通信的问题、跨平台兼容的问题、多平台打包的问题、窗口管理的问题… 总之获得了很多经验，也整理出了一些通用解决方法。<br>Electron现在应用的项目还是挺多的，是前端同学跨足桌面软件开发领域的又一里程碑，不过需要转换一下思维模式，单纯写前端代码多是处理一些简单的界面逻辑和少量的数据，涉及到文件、系统操作、进程线程、原生交互方面的知识比较少，可以多了解一下计算机操作系统方面的知识、掌握代码设计模式和一些基本的算法优化方面的知识能让你更加胜任Electron桌面软件开发任务！</p>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> smb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端浏览器开发工具</title>
      <link href="/blogs/2020/04/16/a493952e.html/"/>
      <url>/blogs/2020/04/16/a493952e.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>author: nojsja</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="dev-tools.png"  alt="life is strange"></p><h3 id="目录">目录</h3><hr><ol><li>DevTools常用功能区域介绍</li><li>使用DevTools查看浏览器DOM元素</li><li>使用DevTools查看浏览器本地数据</li><li>使用DevTools在线编辑DOM样式</li><li>使用DevTools查看网络请求情况</li><li>使用DevTools查看控制台信息</li><li>使用DevTools在线调试代码</li></ol><h3 id="DevTools常用功能区域介绍">DevTools常用功能区域介绍</h3><hr><h4 id="查看器">查看器</h4><ul><li><p>快速定位元素</p></li><li><p>展示当前网页元素的渲染情况，只展示最终的渲染结构，如果使用了React等前端框架，则需要额外安装react-dev-tool来查看React组件的结构。</p></li><li><p>可以手动修改DOM结构和修改组件样式以及查看元素盒模型和其它信息</p></li><li><p>响应式设计模式</p></li></ul><h4 id="存储">存储</h4><ul><li>Cookie</li><li>SessionStorage</li><li>LocalStorage</li><li>Indexed DB</li></ul><h4 id="调试器">调试器</h4><ul><li>定位代码，断点调试</li><li>调试：暂停/继续、跨越、步进、步出</li></ul><h4 id="控制台">控制台</h4><ul><li>多行模式和单行模式</li><li>console命令</li></ul><h4 id="网络">网络</h4><ul><li>筛选请求类型</li><li>查看某个网络请求</li><li>构造极限情况-限流</li></ul><h4 id="样式编辑器">样式编辑器</h4><ul><li>查看盒模型属性</li><li>查看字体</li><li>定位和编辑元素样式表</li></ul><h4 id="性能">性能</h4><ul><li><p>内存占用</p></li><li><p>浏览器自身渲染过程和调用情况</p></li></ul><h3 id="使用DevTools查看浏览器DOM元素">使用DevTools查看浏览器DOM元素</h3><hr><ol><li>右键选择<code>检查元素</code>快速定位元素</li><li>通过控制台<code>选取页面中的元素</code>(Ctrl+Shift+C)来预览和选择元素</li><li>通过控制台<code>搜索HTML</code>使用querySelector语法搜索一个元素</li></ol><h3 id="使用DevTools查看浏览器本地数据">使用DevTools查看浏览器本地数据</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="dev-tools-storage.png"  alt="life is strange"></p><h4 id="Cookie">Cookie</h4><blockquote><p>HTTP Cookie（也叫Web Cookie或浏览器Cookie）是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态。Cookie使基于无状态的HTTP协议记录稳定的状态信息成为了可能，限制大小4K。</p></blockquote><p>Cookie主要用于以下三个方面：</p><ul><li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li><li>个性化设置（如用户自定义设置、主题等）</li><li>浏览器行为跟踪（如跟踪分析用户行为等）</li></ul><p>Cookie特点：</p><ol><li>不需要任何服务器资源。 Cookie 存储在客户端并在发送后由服务器读</li><li>使用较简单。Cookie 是一种基于文本的轻量结构，包含简单的键值对</li><li>数据持久性。虽然客户端计算机上 Cookie 的持续时间取决于客户端上的 Cookie 过期处理和用户干预，Cookie 通常是客户端上持续时间最长的数据保留形式</li></ol><h4 id="SessionStorage">SessionStorage</h4><blockquote><p>sessionStorage 用于临时保存同一窗口(或标签页)的数据，在关闭窗口或标签页之后将会删除这些数据。</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="dev-tools-storage2.png"  alt="life is strange"></p><h4 id="LocalStorage">LocalStorage</h4><blockquote><p>localStorage 用于长久保存整个网站的数据，保存的数据没有过期时间，直到手动去删除，限制大小5M</p></blockquote><h4 id="Indexed-DB">Indexed DB</h4><blockquote><p>通俗地说，IndexedDB 就是浏览器提供的本地数据库，它可以被网页脚本创建和操作。IndexedDB 允许储存大量数据，提供查找接口，还能建立索引。这些都是 LocalStorage 所不具备的。就数据库类型而言，IndexedDB 不属于关系型数据库（不支持 SQL 查询语句），更接近 NoSQL 数据库。</p></blockquote><p>特点：</p><ol><li><p>键值对储存。 IndexedDB 内部采用对象仓库（object store）存放数据。所有类型的数据都可以直接存入，包括 JavaScript 对象。对象仓库中，数据以&quot;键值对&quot;的形式保存，每一个数据记录都有对应的主键，主键是独一无二的，不能有重复，否则会抛出一个错误</p></li><li><p>异步。 IndexedDB 操作时不会锁死浏览器，用户依然可以进行其他操作，这与 LocalStorage 形成对比，后者的操作是同步的。异步设计是为了防止大量数据的读写，拖慢网页的表现</p></li><li><p>支持事务。 IndexedDB 支持事务（transaction），这意味着一系列操作步骤之中，只要有一步失败，整个事务就都取消，数据库回滚到事务发生之前的状态，不存在只改写一部分数据的情况</p></li><li><p>同源限制 IndexedDB 受到同源限制，每一个数据库对应创建它的域名。网页只能访问自身域名下的数据库，而不能访问跨域的数据库</p></li><li><p>储存空间大 IndexedDB 的储存空间比 LocalStorage 大得多，一般来说不少于 250MB，甚至没有上限</p></li><li><p>支持二进制储存。 IndexedDB 不仅可以储存字符串，还可以储存二进制数据（ArrayBuffer 对象和 Blob 对象）</p></li></ol><h3 id="使用DevTools在线编辑DOM样式">使用DevTools在线编辑DOM样式</h3><hr><ol><li>查看字体</li><li>定位和编辑元素样式表</li></ol><h3 id="使用DevTools查看网络请求情况">使用DevTools查看网络请求情况</h3><hr><ol><li>筛选请求类型</li><li>查看某个网络请求</li><li>构造极限情况-限流</li></ol><h3 id="使用DevTools查看控制台信息">使用DevTools查看控制台信息</h3><hr><h4 id="通过控制台打印数据">通过控制台打印数据</h4><ol><li><p>console.log 用于输出普通信息</p></li><li><p><a href="http://console.info">console.info</a> 用于输出提示性信息</p></li><li><p>console.error用于输出错误信息</p></li><li><p>console.warn用于输出警示信息</p></li><li><p>console.debug用于输出调试信息</p></li><li><p>console.dirxml打印dom对象结构</p></li></ol><h4 id="printf格式化输出数据">printf格式化输出数据</h4><ol><li><p>打印字符串<br>console.log(“他是%s”, “nojsja”);</p></li><li><p>打印数字<br>console.log(“%d年%d月%d日”,2011,3,26);</p></li><li><p>打印浮点数字<br>console.log(“圆周率是%f”,3.1415926);</p></li></ol><h4 id="打印一组数据">打印一组数据</h4><blockquote><p>bilibili控制台demo</p></blockquote><ol><li><p>console.group输出一组信息的开头</p></li><li><p>console.groupEnd结束一组输出信息</p></li></ol><h4 id="断言">断言</h4><blockquote><p>输入的表达式进行断言，只有表达式为false时，才输出相应的信息到控制台</p></blockquote><ol><li>console.assert(boolValue, info);</li></ol><h4 id="统计代码段执行次数">统计代码段执行次数</h4><blockquote><p>console.log打印的信息比较混乱，console.count可以用来单独统计某个代码块在一段时间内的执行次数</p></blockquote><ol><li>console.count(symbol)</li></ol><h4 id="统计一段代码的执行时间">统计一段代码的执行时间</h4><blockquote><p>通过传入参数确定定时器归属</p></blockquote><ol><li><p>console.time(symbol)开始统计</p></li><li><p>console.timeEnd(symbol)结束统计</p></li></ol><h3 id="打印堆栈信息">打印堆栈信息</h3><p>console.trace 堆栈跟踪相关的调试</p><h3 id="使用DevTools在线调试代码">使用DevTools在线调试代码</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="dev-tools-debug.png"  alt="life is strange"></p><ol><li>定位代码，断点调试</li><li>调试：暂停/继续、跨越、步进、步出</li></ol>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> browser </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于s3对象存储多文件分片上传的Javascript实现（二）</title>
      <link href="/blogs/2020/03/26/7507699.html/"/>
      <url>/blogs/2020/03/26/7507699.html/</url>
      
        <content type="html"><![CDATA[<h3 id="目录">目录</h3><hr><ol><li><p>概述</p></li><li><p>文件上传-Js向中间层Node发送分片数据</p></li><li><p>文件上传-中间层Node接收前端发送的分片数据</p></li><li><p>文件下载-中间层Node获取后端文件数据的两种处理</p></li><li><p>文件下载-Js下载中间层文件的两种不同方式</p></li></ol><h3 id="预览">预览</h3><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="upload.png"  alt="upload"></p><h3 id="概述">概述</h3><hr><p>Amazon S3 提供了一个简单 Web 服务接口，可用于随时在 Web 上的任何位置存储和检索任何数量的数据。此服务让所有开发人员都能访问同一个具备高扩展性、可靠性、安全性和快速价廉的数据存储基础设施， Amazon 用它来运行其全球的网站网络。此服务旨在为开发人员带来最大化的规模效益。<br>前一篇文章<a href="/blogs/2020/03/07/37469a41.html/">基于s3对象存储多文件分片上传的Javascript实现(一)</a>主要讲了前端Js多文件分片上传逻辑的实现，描述了浏览器端多文件分片异步上传状态管理方面的设计，这篇文章主要针对前端Coder文件操作的一些痛点，比如：前端分片是以怎样的数据形式发送到中间层的、中间层是怎样接收前端发送的分片数据的、文件下载时中间层怎样处理后端接口返回的大文件数据然后发送给前端、前端又是怎样拿到和下载中间层返回的文件数据的，主要包含这些方面。</p><h3 id="文件上传-Js向中间层Node发送分片数据">文件上传-Js向中间层Node发送分片数据</h3><hr><h4 id="创建Axios实例">创建Axios实例</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> XHR = axios.create(&#123;</span><br><span class="line">  <span class="attr">baseURl</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">30e3</span>,</span><br><span class="line">  <span class="attr">headers</span>: originHeaders,</span><br><span class="line">  <span class="function"><span class="title">validateStatus</span>(<span class="params">status</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> status &gt;= <span class="number">200</span> &amp;&amp; status &lt; <span class="number">300</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="使用文件分片构造表单数据">使用文件分片构造表单数据</h4><blockquote><p>fileShardsData为File.slice接口对文件截取得到的部分文件数据</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="keyword">new</span> FormData();</span><br><span class="line">formData.append(<span class="string">&#x27;file&#x27;</span>, fileShardsData, <span class="string">&#x27;file&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="发送分片">发送分片</h4><blockquote><p>注意设置请求头的请求数据类型</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XHR(&#123;</span><br><span class="line">  api,</span><br><span class="line">  method,</span><br><span class="line">  data,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="文件上传-中间层Node接收前端发送的分片数据">文件上传-中间层Node接收前端发送的分片数据</h3><blockquote><p>Express没有自带文件处理功能，需要使用第三方middleware</p></blockquote><p>环境：</p><ul><li>Express V4框架</li><li>Node.js V8</li></ul><h4 id="方法1：使用formidable中间件处理文件请求">方法1：使用formidable中间件处理文件请求</h4><ol><li>编写公用中间处理组件</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formidable = <span class="built_in">require</span>(<span class="string">&#x27;formidable&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * parseFile [使用formidable进行文件解析 - 性能一般]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [req obj]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>res [res obj]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.formidableParseFile = <span class="function">(<span class="params">req, res, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> form = <span class="keyword">new</span> formidable.IncomingForm();</span><br><span class="line">    form.parse(req, <span class="function">(<span class="params">err, fields, files</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (fs.existsSync(files.file.path)) &#123;</span><br><span class="line">        fs.readFile(files.file.path, <span class="function">(<span class="params">err, fileBuffer</span>) =&gt;</span> &#123;</span><br><span class="line">          fs.unlink(files.file.path, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(err);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(err);</span><br><span class="line">          &#125;</span><br><span class="line">          callback(<span class="literal">null</span>, fileBuffer);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line">    callback(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>挂载路由</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/object/object/upload&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;upload&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> random = <span class="built_in">Math</span>.random();</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 1`</span>);</span><br><span class="line">  formidableParseFile(req, res, <span class="function">(<span class="params">err, fileBuffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 1`</span>);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">result</span>: err.toString(),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.time(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 2`</span>);</span><br><span class="line">    commonRequestAuth(req.query, objectsresourceApi.object.uploadObject, req, fileBuffer).then(</span><br><span class="line">      <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.timeEnd(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 2`</span>);</span><br><span class="line">        res.json(&#123;</span><br><span class="line">          <span class="attr">code</span>: response.code,</span><br><span class="line">          <span class="attr">result</span>: &#123;</span><br><span class="line">            ...&#123; <span class="attr">etag</span>: response.headers ? response.headers.etag : <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            ...response.result</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="方法2：代码实现文件处理">方法2：代码实现文件处理</h4><ol><li>声明方法</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * parseFile [form-data原生文件解析 - 性能差]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [req obj]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>res [res obj]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.parseFile = <span class="function">(<span class="params">req, res, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  req.setEncoding(<span class="string">&#x27;binary&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;   <span class="comment">// 文件数据</span></span><br><span class="line">  <span class="keyword">let</span> fileName = <span class="string">&#x27;&#x27;</span>;  <span class="comment">// 文件名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 边界字符串</span></span><br><span class="line">  <span class="keyword">const</span> boundary = req.headers[<span class="string">&#x27;content-type&#x27;</span>].split(<span class="string">&#x27;; &#x27;</span>)[<span class="number">1</span>].replace(<span class="string">&#x27;boundary=&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    body += chunk;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 分隔键值对(\r\n)和键值(:)</span></span><br><span class="line">      <span class="keyword">const</span> file = querystring.parse(body, <span class="string">&#x27;\r\n&#x27;</span>, <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">      <span class="comment">//获取文件名</span></span><br><span class="line">      <span class="keyword">const</span> fileInfo = file[<span class="string">&#x27;Content-Disposition&#x27;</span>].split(<span class="string">&#x27;; &#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> (value <span class="keyword">in</span> fileInfo) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileInfo[value].indexOf(<span class="string">&quot;filename=&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">          fileName = fileInfo[value].substring(<span class="number">10</span>, fileInfo[value].length - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (fileName.indexOf(<span class="string">&#x27;\\&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&#x27;\\&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取图片类型(如：image/gif 或 image/png))</span></span><br><span class="line">      <span class="keyword">const</span> entireData = body.toString();</span><br><span class="line"></span><br><span class="line">      contentType = file[<span class="string">&#x27;Content-Type&#x27;</span>].substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//获取文件二进制数据开始位置，即contentType的结尾</span></span><br><span class="line">      <span class="keyword">const</span> upperBoundary = entireData.indexOf(contentType) + contentType.length;</span><br><span class="line">      <span class="keyword">const</span> shorterData = entireData.substring(upperBoundary);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 替换开始位置的空格</span></span><br><span class="line">      <span class="keyword">const</span> binaryDataAlmost = shorterData.replace(<span class="regexp">/^\s\s*/</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="regexp">/\s\s*$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 去除数据末尾的额外数据，即: &quot;--&quot;+ boundary + &quot;--&quot;</span></span><br><span class="line">      <span class="keyword">const</span> binaryData = binaryDataAlmost.substring(<span class="number">0</span>, binaryDataAlmost.indexOf(<span class="string">&#x27;--&#x27;</span> + boundary + <span class="string">&#x27;--&#x27;</span>));</span><br><span class="line"></span><br><span class="line">      callback(<span class="literal">null</span>, binaryData);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;form-data parse error!&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2"><li>挂载路由同上</li></ol><h3 id="文件下载-中间层Node获取后端文件数据的两种处理">文件下载-中间层Node获取后端文件数据的两种处理</h3><hr><blockquote><p>两种方式均使用Axios发送请求</p></blockquote><h4 id="小文件直传">小文件直传</h4><p>接收到接口数据后直接放入内存然后以文件的类型发送给前端</p><ol><li>请求header注意设置<code>resType: &quot;arraybuffer&quot;</code></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象详情信息</span></span><br><span class="line">router.post(<span class="string">&#x27;/resource/object/detailinfo/all&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  commonRequestAuth(&#123; ...req.body, ...&#123; <span class="attr">$no_timeout$</span>: <span class="literal">true</span> &#125;&#125;, objectsresourceApi.object.objectinfoAll, req).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    res.type(<span class="string">&#x27;file&#x27;</span>).send(response.result)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="大文件转存为静态资源">大文件转存为静态资源</h4><blockquote><p>Node.js支持文件流操作，包含可读流、可写流以及可读可写流，如果在处理大文件的时候直接把数据放入内存，就会出现中间层内存爆满的情况，这里先声明接口返回数据为可读流，然后通过本地静态资源路径创建可写流，最后为了避免由于可读流的数据写入可写流时由于读取速度和写入速度的差异问题导致的数据丢失情况，使用管道pipe连接可读流和可写流再进行数据传输。</p></blockquote><ol><li><p>Node Pipe管道的概念<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="node_pipe.png"  alt="node pipe"></p></li><li><p>请求header注意设置<code>resType: &quot;stream&quot;</code></p></li><li><p>创建本地可写流<br>使用fs.createWriteStream接口，参数为本地某个目录文件，文件可以不存在，目录需要实际存在</p></li><li><p>接口返回的是可读流，可以直接连接到管道<br>注意服务器是否支持以数据流方式返回二进制数据</p></li><li><p>可写流完成写入后向前端发送静态资源文件地址<br>监听可写流的finish事件可以异步处理文件完成写入事件</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象详情信息</span></span><br><span class="line">router.post(<span class="string">&#x27;/resource/object/detailinfo&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;download&#x27;</span>);</span><br><span class="line">  commonRequestAuth(&#123; ...req.body, ...&#123; <span class="attr">$no_timeout$</span>: <span class="literal">true</span> &#125;&#125;, objectsresourceApi.object.objectinfo, req).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;download callback&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> fileName = req.body.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">    <span class="keyword">const</span> fileSymbol = <span class="string">`<span class="subst">$&#123;fileName&#125;</span>-<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> filePath = path.join(_path.public, <span class="string">&#x27;download&#x27;</span>, fileSymbol);</span><br><span class="line">    <span class="keyword">const</span> ws = fs.createWriteStream(filePath);</span><br><span class="line">    response.result.pipe(ws);</span><br><span class="line">    ws.on(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;download finish&#x27;</span>);</span><br><span class="line">      res.header(&#123;</span><br><span class="line">        <span class="string">&#x27;Content-Disposition&#x27;</span>: fileName</span><br><span class="line">      &#125;);</span><br><span class="line">      res.json(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">result</span>: filePath.split(<span class="string">&#x27;node-express-react/public/public&#x27;</span>)[<span class="number">1</span>],</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;); </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="文件下载-Js下载中间层文件的两种不同方式">文件下载-Js下载中间层文件的两种不同方式</h3><hr><h4 id="小文件直接从接口拿到数据并生成DataURL触发下载">小文件直接从接口拿到数据并生成DataURL触发下载</h4><ol><li><p>请求header声明<code>responseType:arraybuffer</code><br>指名返回的数据是可直接使用的二进制流数据</p></li><li><p>接口数据返回后生成前端通用的大二进制块数据<code>Blob</code><br>new Blob(DataArray, { type: mimetype })，mimetype需要正确指定，比如jpeg格式的图片mimetype为image/jpeg</p></li><li><p>使用HTML5 FileReader接口读取二进制块<br>reader.readAsDataURL将二进制读取为base64编码的字符串数据，前端可以直接预览和下载此类DataURL</p></li><li><p>构造a标签并指名download属性下载DataURL<br>替代方法是使用window.open(dataUrl)</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">downloadObjectInMemory = <span class="function">(<span class="params">para, info</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iAxios = axios.create();</span><br><span class="line">    <span class="comment">// iAxios.defaults.timeout = 60 * 1000 * 60 * 10;</span></span><br><span class="line">    iAxios.defaults.timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/resource/object/detailinfo/all&#x27;</span>,</span><br><span class="line">      <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">data</span>: para,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> readAsDataUrl = <span class="function">(<span class="params">data, emptyData</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">      reader.readAsDataURL(data);</span><br><span class="line">      reader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> url = e.target.result;</span><br><span class="line">        <span class="keyword">const</span> a = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> filename = para.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">        a.href = url === <span class="string">&#x27;data:&#x27;</span> ? emptyData : url;</span><br><span class="line">        a.download = filename;</span><br><span class="line">        a.click();</span><br><span class="line">        <span class="built_in">window</span>.URL.revokeObjectURL(url);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> typename = mapMimeType(info.name).mime;</span><br><span class="line">    iAxios.request(options)</span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> blobData = <span class="keyword">new</span> Blob([res.data], &#123; <span class="attr">type</span>: typename &#125;);</span><br><span class="line">        readAsDataUrl(blobData, <span class="string">`data:<span class="subst">$&#123;typename&#125;</span>;base64,`</span>);</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="大文件通过接口返回的静态文件链接进行下载">大文件通过接口返回的静态文件链接进行下载</h4><p>步骤同上，只不过构造DataURL的过程取消，a标签可以直接使用接口返回的静态文件地质URL</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">downloadObjectWithURL = <span class="function">(<span class="params">para</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iAxios = axios.create();</span><br><span class="line">    <span class="comment">// iAxios.defaults.timeout = 60 * 1000 * 60 * 10;</span></span><br><span class="line">    iAxios.defaults.timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/resource/object/detailinfo&#x27;</span>,</span><br><span class="line">      <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">responseType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">data</span>: para,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> timer;</span><br><span class="line">    iAxios.request(options)</span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">        <span class="keyword">const</span> a = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> filename = para.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">        <span class="keyword">const</span> address = process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span> ? <span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.location.protocol&#125;</span>//10.0.6.206:3000<span class="subst">$&#123;res.data.result&#125;</span>`</span> : <span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.location.protocol&#125;</span>//<span class="subst">$&#123;<span class="built_in">window</span>.location.hostname&#125;</span>:3000<span class="subst">$&#123;res.data.result&#125;</span>`</span>;</span><br><span class="line">        a.href = address;</span><br><span class="line">        a.download = filename;</span><br><span class="line">        a.click();</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      openNotification(<span class="string">&#x27;info&#x27;</span>, <span class="literal">null</span>, <span class="built_in">this</span>.lang.lang.fileDownloadTips);</span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
          <category> Node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upload </tag>
            
            <tag> node </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>echarts图表-树形图开发记录</title>
      <link href="/blogs/2020/03/22/39caa941.html/"/>
      <url>/blogs/2020/03/22/39caa941.html/</url>
      
        <content type="html"><![CDATA[<h3 id="目录">目录</h3><ol><li><p>前言</p></li><li><p>树形图功能需求以及遇到的问题分析</p></li><li><p>问题I：V4版本label自定义效果设置不生效</p></li><li><p>问题II：tree图使用自定义图片加载显示不完全</p></li><li><p>问题III：tree图自定义节点选中效果和组件自带渲染效果冲突</p></li></ol><h3 id="前言">前言</h3><hr><p>Echarts树形图Tree可以用来展示树形数据结构各节点的层级关系，比如一个使用情况就是文件系统存在多个快照，每一级快照基于上一级生成，存在父级和子级关系对应关系，且Root根只有一个，即文件系统本身，完全适用于树形图的使用场景。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="snapshot.png"  alt="snapshot"></p><h3 id="树形图功能需求以及遇到的问题分析">树形图功能需求以及遇到的问题分析</h3><hr><ol><li>文件系统快照每一层级的节点支持单个选中，很多操作都是基于某一个快照节点的，比<br>如快照的恢复、删除、设置，考虑选中效果的区别使用label自定义富文本样式实现，但是会遇到渲染的时侯echarts一些自己的状态更新和我们我们自定义的选中状态的更新冲突问题，且V4版本echarts tree的富文本配置后也并未生效。</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="snapshot_select.png"  alt="snapshot_select"></p><ol start="2"><li>文件系统快照每一层级的节点标识(Symbol)可能不同，需要支持使用自定义图片，echarts的symbol是直接支持使用img-src和base64 img-str的，但是会遇到图片在某些时候不能完全被渲染(图片像是被设置了半透明)或直接完全不能被渲染出来的问题。</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-1.png"  alt="tree-1"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-2.png"  alt="tree-2"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-3.png"  alt="tree-3"></p><h3 id="问题I：V4版本label自定义效果设置不生效">问题I：V4版本label自定义效果设置不生效</h3><hr><p>series-tree.label.formatter</p><blockquote><p>标签内容格式器，支持字符串模板和回调函数两种形式，字符串模板与回调函数返回的字符串均支持用 \n 换行。</p></blockquote><h4 id="字符串模板的使用">字符串模板的使用</h4><ol><li>模板变量有：</li></ol><ul><li>{a}：系列名。</li><li>{b}：数据名。</li><li>{c}：数据值。</li><li>{d}：百分比。</li><li>{@xxx}：数据中名为’xxx’的维度的值，如{@product}表示名为’product’` 的维度的值。</li><li>{@[n]}：数据中维度n的值，如{@[3]}` 表示维度 3 的值，从 0 开始计数。</li></ul><ol start="2"><li><p>示例：<br>formatter: ‘{b}: {d}’</p></li><li><p>回调函数格式：<br>(params: Object|Array) =&gt; string，<br>参数 params 是 formatter 需要的单个数据集，格式如下：</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">componentType</span>: <span class="string">&#x27;series&#x27;</span>,</span><br><span class="line">    <span class="comment">// 系列类型</span></span><br><span class="line">    <span class="attr">seriesType</span>: string,</span><br><span class="line">    <span class="comment">// 系列在传入的 option.series 中的 index</span></span><br><span class="line">    <span class="attr">seriesIndex</span>: number,</span><br><span class="line">    <span class="comment">// 系列名称</span></span><br><span class="line">    <span class="attr">seriesName</span>: string,</span><br><span class="line">    <span class="comment">// 数据名，类目名</span></span><br><span class="line">    <span class="attr">name</span>: string,</span><br><span class="line">    <span class="comment">// 数据在传入的 data 数组中的 index</span></span><br><span class="line">    <span class="attr">dataIndex</span>: number,</span><br><span class="line">    <span class="comment">// 传入的原始数据项</span></span><br><span class="line">    <span class="attr">data</span>: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 传入的数据值。在多数系列下它和 data 相同。在一些系列下是 data 中的分量（如 map、radar 中）</span></span><br><span class="line">    <span class="attr">value</span>: number|<span class="built_in">Array</span>|<span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 坐标轴 encode 映射信息，</span></span><br><span class="line">    <span class="comment">// key 为坐标轴（如 &#x27;x&#x27; &#x27;y&#x27; &#x27;radius&#x27; &#x27;angle&#x27; 等）</span></span><br><span class="line">    <span class="comment">// value 必然为数组，不会为 null/undefied，表示 dimension index 。</span></span><br><span class="line">    <span class="comment">// 其内容如：</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     x: [2] // dimension index 为 2 的数据映射到 x 轴</span></span><br><span class="line">    <span class="comment">//     y: [0] // dimension index 为 0 的数据映射到 y 轴</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="attr">encode</span>: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 维度名列表</span></span><br><span class="line">    <span class="attr">dimensionNames</span>: <span class="built_in">Array</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    <span class="comment">// 数据的维度 index，如 0 或 1 或 2 ...</span></span><br><span class="line">    <span class="comment">// 仅在雷达图中使用。</span></span><br><span class="line">    dimensionIndex: number,</span><br><span class="line">    <span class="comment">// 数据图形的颜色</span></span><br><span class="line">    <span class="attr">color</span>: string,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="字符串模板不生效问题1">字符串模板不生效问题1</h4><p>直接将formatter自定义函数和富文本标识配置在<code>series[0].label</code>下，结果以上配置都无效，正确方法是在<code>series[0].label.normal</code>下配置富文本标识声明，而formatter需要定义在数据集data的各个数据项中，<code>normal</code>表示常规效果，与之对应的<code>emphasis</code>是鼠标划过高亮效果。<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-4.png"  alt="tree-4"></p><p>series-tree.label.rich支持的所有CSS属性：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  color , fontStyle , fontWeight , fontFamily , fontSize , align , verticalAlign , lineHeight , backgroundColor , borderColor , borderWidth , borderRadius , padding , shadowColor , shadowBlur , shadowOffsetX , shadowOffsetY , width , height , textBorderColor , textBorderWidth , textShadowColor , textShadowBlur , textShadowOffsetX , textShadowOffsetY</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>series-tree.data.label中配置label.formatter：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rawTreeData = &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;snapshotA&#x27;</span>,</span><br><span class="line">          <span class="attr">selected</span>: <span class="literal">false</span>, <span class="comment">// 自定义选择控制属性selected</span></span><br><span class="line">          <span class="attr">collapsed</span>: <span class="literal">false</span>, <span class="comment">// 覆盖组件自带的collapsed效果</span></span><br><span class="line">          <span class="attr">label</span>: &#123;</span><br><span class="line">            <span class="comment">// * 直接引用上层定义的formatter即可，复用函数对象</span></span><br><span class="line">            <span class="attr">formatter</span>: <span class="built_in">this</span>.echartsInitData.series[<span class="number">0</span>].label.normal.formatter,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            ...</span><br><span class="line">          ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-5.png"  alt="tree-5"></p><h3 id="问题II：tree图使用自定义图片加载显示不完全">问题II：tree图使用自定义图片加载显示不完全</h3><hr><h4 id="解决方案1-无效-：使用对象深比较函数避免多次渲染">解决方案1(无效)：使用对象深比较函数避免多次渲染</h4><blockquote><p>使用此方法在React生命周期componentDidUpdate里判断options是否发生改变，从而避免了echarts组件多次render的情况，但验证后发现避免了一些组件卡顿的情况，但也存在自定义tree 节点图片加载不完全的情况，此解决方案无效。</p></blockquote><ol><li>Js对象深比较函数deepComparison定义</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [deepComparison 深比较]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[any]&#125;</span> </span>data [any]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;[Boolean]&#125;</span>      </span>[是否相同]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deepComparison</span>(<span class="params">data1, data2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; hasOwnProperty &#125; = <span class="built_in">Object</span>.prototype;</span><br><span class="line">  <span class="comment">// 获取变量类型</span></span><br><span class="line">  <span class="keyword">const</span> getType = <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> d === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(d <span class="keyword">instanceof</span> <span class="built_in">Object</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (d <span class="keyword">instanceof</span> <span class="built_in">Date</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;date&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (d <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;regexp&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// object / array //</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d !== d) <span class="keyword">return</span> <span class="string">&#x27;nan&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">typeof</span> d).toLowerCase();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 基本类型比较</span></span><br><span class="line">  <span class="keyword">const</span> is = <span class="function">(<span class="params">d1, d2, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;nan&#x27;</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;date&#x27;</span> || type === <span class="string">&#x27;regexp&#x27;</span>) <span class="keyword">return</span> d1.toString() === d2.toString();</span><br><span class="line">    <span class="keyword">return</span> (d1 === d2);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 递归比较</span></span><br><span class="line">  <span class="keyword">const</span> compare = <span class="function">(<span class="params">d1, d2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> type1 = getType(d1);</span><br><span class="line">    <span class="keyword">const</span> type2 = getType(d2);</span><br><span class="line">    <span class="keyword">if</span> (type1 !== type2) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type1 === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> keys1 = <span class="built_in">Object</span>.keys(d1).filter(<span class="function"><span class="params">k</span> =&gt;</span> hasOwnProperty.call(d1, k));</span><br><span class="line">      <span class="keyword">const</span> keys2 = <span class="built_in">Object</span>.keys(d2).filter(<span class="function"><span class="params">k</span> =&gt;</span> hasOwnProperty.call(d2, k));</span><br><span class="line">      <span class="keyword">if</span> (keys1.length !== keys2.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys1.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          !keys2.includes(keys1[i]) ||</span><br><span class="line">          !compare(d1[keys1[i]], d2[keys1[i]])) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> is(d1, d2, type1);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> compare(data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.深度比较函数使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;update&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; treeData &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">  <span class="keyword">const</span> rawTreeData = toJS(treeData);</span><br><span class="line">  <span class="keyword">if</span> (!deepComparison(<span class="built_in">this</span>.echartsTreeData, rawTreeData)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;change&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>.echartsTreeData = rawTreeData;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    optionData.series[<span class="number">0</span>].data = [rawTreeData];</span><br><span class="line">    <span class="built_in">console</span>.log(optionData);</span><br><span class="line">    <span class="comment">// this.echartsElement.clear();</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解决方案2-无效-：使用base64字符串替换img-url">解决方案2(无效)：使用base64字符串替换img url</h4><blockquote><p>由于方案1无效，判断可能是由于图片异步加载引起的渲染问题，对小图片尝试直接使用base64硬编码在代码里，结果发现仍然无效。</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-6.png"  alt="tree-6"></p><h4 id="解决方案3-有效-：禁用动画加载">解决方案3(有效)：禁用动画加载</h4><blockquote><p>由解决方案2可知，问题原因排除img异步加载的问题，问题定位到echarts组件自身的渲bug，通过多次设置setOption方法的参数，发现设置动画取消可以避免由于echarts图自身的渲染过程引起的图片加载不全问题。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chartOption = &#123;</span><br><span class="line">  <span class="attr">animation</span>: <span class="literal">true</span>, <span class="comment">// 解决渲染不全的问题</span></span><br><span class="line">  <span class="attr">tooltip</span>: &#123;</span><br><span class="line">    <span class="attr">trigger</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="attr">triggerOn</span>: <span class="string">&#x27;mousemove&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">series</span>: [</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="解决方案4-有效-：组件渲染完成后重新手动渲染">解决方案4(有效)：组件渲染完成后重新手动渲染</h4><blockquote><p>echarts初始化后的组件可以挂载钩子函数和监听一些浏览器事件，其中有一个事件名为finished，表示echarts图表本次渲染完成。既然我们之前的最后一次渲染导致图片未完全加载，那么可以在最后这次渲染完成之后再读取echarts组件自带的options然后重新渲染一次，即可解决问题，需要注意的是，finished事件可能在短时间内被调用数次，在监听时注意使用函数防抖的思想让短时间内的多次finished事件回调只执行一次。</p></blockquote><ol><li>函数防抖声明<br>函数节流和函数防抖在浏览器渲染优化方面还是用得挺多：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>fn         [回调函数]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Time]&#125;</span>   </span>delayTime  [延迟时间(ms)]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;Boolean&#125;</span>  </span>isImediate [是否需要立即调用]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span>   </span>args       [回调函数传入参数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fnDebounce</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> fnObject = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> timer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">fn, delayTime, isImediate, args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 设置定时器方法</span></span><br><span class="line">    <span class="keyword">const</span> setTimer = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        fn(args);</span><br><span class="line">        <span class="comment">// 清除定时器</span></span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">        <span class="keyword">delete</span> (fnObject[fn]);</span><br><span class="line">      &#125;, delayTime);</span><br><span class="line"></span><br><span class="line">      fnObject[fn] = &#123;</span><br><span class="line">        delayTime,</span><br><span class="line">        timer,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 立即调用</span></span><br><span class="line">    <span class="keyword">if</span> (!delayTime || isImediate) <span class="keyword">return</span> fn(args);</span><br><span class="line">    <span class="comment">// 判断函数是否已经在调用中</span></span><br><span class="line">    <span class="keyword">if</span> (fnObject[fn]) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">      setTimer(fn, delayTime, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setTimer(fn, delayTime, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>finished事件监听和函数防抖的应用<br>其实在此基础上还能做的优化就是在组件第一次加载自定义symbol图片后就将<code>finished</code>事件监听取消掉，减少渲染次数。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FsPageSnapShotBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  echartsElement= <span class="literal">null</span></span><br><span class="line">  echartsTreeData = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化事件防抖</span></span><br><span class="line">  fnDebounce = fnDebounce();</span><br><span class="line"></span><br><span class="line">  pendingEventsTrigger = <span class="function">(<span class="params">nodeName</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; snapshot &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement = echarts.init(<span class="built_in">this</span>.refs.fsSnapShot);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(snapshot.echartsInitData);</span><br><span class="line">    <span class="comment">// finished事件监听</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;finished&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 延迟时间设置为200ms</span></span><br><span class="line">      <span class="built_in">this</span>.fnDebounce(<span class="built_in">this</span>.pendingEventsTrigger, <span class="number">200</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  resizeCharts = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.resize();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    echarts.dispose(<span class="built_in">this</span>.echartsElement);</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  onClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="问题III：tree图自定义节点选中效果和组件自带渲染效果冲突">问题III：tree图自定义节点选中效果和组件自带渲染效果冲突</h3><hr><p>节点选中效果原理是监听echarts的<code>dblclick</code>双击事件，双击后改变<code>options.series[0].data</code>数据项里的<code>selected</code>属性配置，然后label.formatter根据此属性能够应用富文本类名里声明的高亮或普通文本的类名。值得注意的是echarts渲染时自身已经对过长层级的tree数据做了渲染优化，导致过深层级的展开/折叠状态不被控制，每次重新渲染后会导致已经折叠的树层级展开或是已经展开的树层级折叠，非常影响用户操作，因此需要把树层级数据每一层的折叠纳入强制属性控制状态，即在<code>options.series[0].data</code>中额外声明<code>collapsed:[Boolean]</code>参数，同时禁用tree自带的折叠/展开控制。</p><h4 id="冲突1：在设置了echarts渲染动画延迟更新的情况下节点选中效果无效">冲突1：在设置了echarts渲染动画延迟更新的情况下节点选中效果无效</h4><p>如果直接通过dblclick双击事件触发函数设置某个节点选中状态的属性<code>selected:true</code>，那么表现为：<code>selected</code>状态不常驻，变成了类似<code>mouseover</code>的鼠标划过状态触发；</p><ol><li>动画延迟更新属性声明</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Tree的外层数据 */</span></span><br><span class="line">echartsInitData= &#123;</span><br><span class="line">    <span class="attr">tooltip</span>: &#123;</span><br><span class="line">      <span class="attr">trigger</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">      <span class="attr">triggerOn</span>: <span class="string">&#x27;mousemove&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        &#123;...&#125;,</span><br><span class="line">        <span class="attr">leaves</span>: &#123;...&#125;,</span><br><span class="line">        <span class="attr">expandAndCollapse</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">animationDuration</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">animationDelayUpdate</span>: <span class="number">300</span>, <span class="comment">// 动画延迟更新</span></span><br><span class="line">        <span class="attr">animationDurationUpdate</span>: <span class="number">400</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>冲突效果表现</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug1.gif"  alt="tree-bug1"></p><h4 id="冲突2：鼠标的悬浮操作导致选中效果无效">冲突2：鼠标的悬浮操作导致选中效果无效</h4><p>按照上述表现，我尝试在触发函数更新tree节点选中状态之前设置一个延迟，延迟时间大于tree组件的动画延迟更新设置时间(上面设置为了<code>300ms</code>)，结果发现：如果在双击tree节点的时候鼠标一直放在节点上的话，鼠标移开后，表现和上面一样，如果双击了tree节点之后马上把鼠标从该节点移开的话则选中状态正常(太不容易了！)，推测是我们触发echarts组件更新的时候，echarts自身的组件状态管理和我们自定义的组件更新函数(以上表现为设置tree节点数据的<code>selected</code>属性触发label.formatter的渲染效果变化)两者冲突。</p><ol><li>设置<code>selected</code>属性更改函数的延迟时间</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* React组件自定义方法-选中一个元素 */</span></span><br><span class="line">onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name &#125; = e.data;</span><br><span class="line">    <span class="built_in">this</span>.selectedNodeName = name;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.props.snapshot.chooseSnapShot(name);</span><br><span class="line">    &#125;, <span class="number">400</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>冲突效果表现<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug2.gif"  alt="tree-bug2"></li></ol><h4 id="解决方法">解决方法</h4><p>方法同于上面提到的<code>finished事件监听和函数防抖的应用</code>，在echarts组件最终渲染完成后增加一次额外渲染解决问题，但是也仍然会有<code>selected</code>状态稍稍延迟更新和<code>selected</code>状态闪烁一次的问题，不妨碍使用，但是应该有更优的解决办法尚待实现。</p><ol><li>代码概览</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FsPageSnapShotBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  echartsElement= <span class="literal">null</span></span><br><span class="line">  echartsTreeData = <span class="literal">null</span>;</span><br><span class="line">  selectedNodeName = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化事件防抖</span></span><br><span class="line">  dblclickFnDebounce = fnDebounce();</span><br><span class="line"></span><br><span class="line">  pendingEventsTrigger = <span class="function">(<span class="params">nodeName</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; snapshot &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement = echarts.init(<span class="built_in">this</span>.refs.fsSnapShot);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(snapshot.echartsInitData);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;dblclick&#x27;</span>, <span class="built_in">this</span>.onDoubleClickChart);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;click&#x27;</span>, <span class="built_in">this</span>.onClickChart);</span><br><span class="line">    <span class="comment">// finished事件监听</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;finished&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.selectedNodeName) &#123;</span><br><span class="line">        <span class="comment">// 防抖延迟时间设置为200ms</span></span><br><span class="line">        <span class="built_in">this</span>.dblclickFnDebounce(<span class="built_in">this</span>.pendingEventsTrigger, <span class="number">200</span>, <span class="literal">false</span>, <span class="built_in">this</span>.selectedNodeName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    snapshot.getSnapShotRequest();</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  resizeCharts = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.resize();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    echarts.dispose(<span class="built_in">this</span>.echartsElement);</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  onClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>效果演示<br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug-fix.gif"  alt="tree-bug-fix"></li></ol>]]></content>
      
      
      <categories>
          
          <category> Echarts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> echarts </tag>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于s3对象存储多文件分片上传的Javascript实现（一）</title>
      <link href="/blogs/2020/03/07/37469a41.html/"/>
      <url>/blogs/2020/03/07/37469a41.html/</url>
      
        <content type="html"><![CDATA[<h3 id="目录">目录</h3><ol><li><p>概述</p></li><li><p>浏览器文件操作限制</p></li><li><p>前端多文件分片上传的原理和实现</p></li></ol><h3 id="预览">预览</h3><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="upload.png"  alt="upload"></p><h3 id="概述">概述</h3><p>Amazon S3 提供了一个简单 Web 服务接口，可用于随时在 Web 上的任何位置存储和检索任何数量的数据。此服务让所有开发人员都能访问同一个具备高扩展性、可靠性、安全性和快速价廉的数据存储基础设施， Amazon 用它来运行其全球的网站网络。此服务旨在为开发人员带来最大化的规模效益。<br>本文主要针对兼容aws-s3接口的第三方存储服务，在不使用官方sdk的情况下直接使用Restful接口进行存储桶多文件分片上传，主要包含浏览器端的多文件分片上传逻辑的Javascript代码实现。</p><h3 id="浏览器文件操作限制">浏览器文件操作限制</h3><ul><li>HTML5新特性<code>input[type=file]</code>支持调用浏览器文件访问窗口来获取文件数据，实际上JS代码使用此特性访问本地文件系统后拿到的是一个指向文件的引用地址，且如果页面刷新了那么这个地址不可复用，JS代码并没有实际操作文件本身。前端上传数据时根据这个指向文件的地址把文件的一小块分片数据载入到内存并通过Ajax请求发送到中间件进行处理。</li><li>浏览器JS代码没有文件系统操作权限，不能任意存储和读取文件，因此不支持刷新浏览器后上传进度断点恢复，刷新之后断点恢复的前提是能拿到文件数据，但是JS代码没权限访问之前拿到的文件引用地址，并且存储之前上传过的文件分片数据这一做法也不合理。</li><li>相对于文件上传，文件下载则完全不可控，由于文件操作权限，所以整个下载文件操作都是由浏览器自带的的下载任务管理器控制的，没有浏览器接口能拿到这些下载任务进度，所以下载任务进度也是不能获取的。</li></ul><h3 id="前端多文件分片上传的原理和实现">前端多文件分片上传的原理和实现</h3><p><em>完整Github<a href="https://github.com/nojsja/javascript-learning/tree/master/file-slice-upload">源码</a></em></p><blockquote><p>使用了React16/Webpack4/Mobx状态管理库</p></blockquote><ul><li>支持批量文件分割并行上传</li><li>多文件操作：暂停/恢复/终止/续传/重传</li><li>自定义上传任务数目、单个分片大小</li></ul><h4 id="运行流程图">运行流程图</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="shards_upload.jpg"  alt="upload"></p><h4 id="主要流程">主要流程</h4><ol><li>cacheFile<br>前端通过input组件拿到所有文件地址并缓存起来。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [cacheFile 缓存即将注册的文件]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> @action</span><br><span class="line"> cacheFile = <span class="function">(<span class="params">files, bucket</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> symbolArr = <span class="built_in">this</span>.filesCache.map(<span class="function"><span class="params">file</span> =&gt;</span> <span class="built_in">this</span>.getSymbol(file));</span><br><span class="line">   <span class="keyword">const</span> filtedFiles = [];</span><br><span class="line">   <span class="keyword">let</span> uploadingFileFound = <span class="literal">false</span>;</span><br><span class="line">   files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (!symbolArr.includes(<span class="built_in">this</span>.getSymbol(file))) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.findIsUploading(<span class="built_in">this</span>.getSymbol(file), bucket)) &#123;</span><br><span class="line">         uploadingFileFound = <span class="literal">true</span>;</span><br><span class="line">         filtedFiles.push(file.name);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>.filesCache.push(file);</span><br><span class="line">         symbolArr.push(<span class="built_in">this</span>.getSymbol(file));</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">if</span> (!files.length) openNotification(<span class="string">&#x27;warning&#x27;</span>, <span class="literal">null</span>, <span class="built_in">this</span>.lang.lang.noFilCanBeUploaded);</span><br><span class="line">   <span class="keyword">if</span> (uploadingFileFound) openNotification(<span class="string">&#x27;warning&#x27;</span>, <span class="literal">null</span>, <span class="built_in">this</span>.lang.lang.uploadingFileReuploadTips + filtedFiles.join(<span class="string">&#x27;, &#x27;</span>));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>registry<br>根据上一步拿到的文件地址数组创建多个Mobx observable对象跟踪每个上传对象的基本识别信息，包括文件名、文件大小、类型、分片信息(分片大小和总分片数)、上传状态信息：uninitial(未初始化)/pending(准备)/uploading(上传中)/pause(暂停)/error(错误)/break(上传完成)、上传开始时间、上传完成时间，为了便于访问这些Mobx observable对象，建立一个weakMap存储file对象和observable对象的弱映射关系。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [registry 注册上传文件信息]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[Object]&#125;</span> </span>file [文件对象]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span> </span>uploadId [文件上传进程id]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[Object]&#125;</span> </span>state [文件初始化状态]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @action registry = <span class="function">(<span class="params">files, region, prefix</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fileObj = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.loading = <span class="literal">true</span>;</span><br><span class="line">    files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.files.includes(file)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.files.push(file);</span><br><span class="line">      fileObj = &#123;</span><br><span class="line">        <span class="attr">name</span>: file.webkitRelativePath || file.name,</span><br><span class="line">        <span class="attr">prefix</span>: prefix || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">size</span>: file.size,</span><br><span class="line">        <span class="attr">type</span>: file.type || mapMimeType((file.webkitRelativePath || file.name).split(<span class="string">&#x27;.&#x27;</span>).pop()).type,</span><br><span class="line">        <span class="attr">state</span>: <span class="string">&#x27;uninitial&#x27;</span>,</span><br><span class="line">        <span class="attr">creationTime</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">completionTime</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">index</span>: <span class="number">0</span>,</span><br><span class="line">        file,</span><br><span class="line">        <span class="attr">initialized</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">partEtags</span>: [],</span><br><span class="line">        region,</span><br><span class="line">        <span class="attr">blockSize</span>: <span class="built_in">this</span>.blockSize,</span><br><span class="line">        <span class="attr">total</span>: <span class="built_in">Math</span>.ceil(file.size / <span class="built_in">this</span>.blockSize),</span><br><span class="line">        <span class="attr">activePoint</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(),</span><br><span class="line">        <span class="attr">speed</span>: <span class="string">&#x27;0 MB/S&#x27;</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="built_in">encodeURIComponent</span>(<span class="keyword">new</span> <span class="built_in">Date</span>() + file.name + file.type + file.size),</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">const</span> obj = observable(fileObj);</span><br><span class="line">      <span class="built_in">this</span>.taskType.uninitial.push(obj);</span><br><span class="line">      <span class="built_in">this</span>.taskType.series.push(obj);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.fileStorage.get(region)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileStorage.set(region, [obj]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileStorage.get(region).push(obj);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// this.fileStorageMap.set(file, obj);</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.loading = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>startTasks<br>获取文件队列中可用于上传的文件对象，根据文件状态对其做初始化或切割文件上传的操作，同时实时修改对应的Mobx observable上传对象的元数据标识，包括当前上传文件的分片索引(单个文件上传进度=分片索引/总分片数目)、已上传完成的分片etag信息(由服务器返回，可用于完成分片上传时校验已上传的所有分片数据是否匹配)、当前上传对象4的上传状态(uninitial/pending/uploading/pause/eror/break)、当前上传对象的上传速度(速度=单个分片大小/单个分片上传所用时间)。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [startTasks 开启上传任务队列]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>region [桶名]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  startTasks = <span class="function">(<span class="params">region</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 根据空闲任务类型和空闲任务并发限制开启空闲任务</span></span><br><span class="line">    <span class="comment">// let storageObject;</span></span><br><span class="line">    <span class="built_in">this</span>.refreshTasks(region);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isUploadListEmpty(region)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> maxLength = <span class="built_in">this</span>.multiTaskCount - <span class="built_in">this</span>.taskType.uploading.length;</span><br><span class="line">    <span class="keyword">const</span> taskSeries = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; (maxLength) &amp;&amp; <span class="built_in">this</span>.taskType.series[i]; i += <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// const file = this.taskType.series.shift();</span></span><br><span class="line">      <span class="keyword">const</span> storageObject = <span class="built_in">this</span>.taskType.series[i];</span><br><span class="line">      <span class="keyword">if</span> (storageObject.state === <span class="string">&#x27;uploading&#x27;</span>) <span class="keyword">continue</span>; <span class="comment">// 上传中</span></span><br><span class="line">      <span class="keyword">if</span> (storageObject.state === <span class="string">&#x27;pause&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line">      taskSeries.push(storageObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> index;</span><br><span class="line">    taskSeries.forEach(<span class="function">(<span class="params">storageObject</span>) =&gt;</span> &#123;</span><br><span class="line">      index = <span class="built_in">this</span>.taskType.series.indexOf(storageObject);</span><br><span class="line">      index !== -<span class="number">1</span> &amp;&amp; <span class="built_in">this</span>.taskType.series.splice(index, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.taskType.uninitial.includes(storageObject)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.initRequest(storageObject).then(<span class="function">(<span class="params">&#123; err, init &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!err &amp;&amp; init) &#123;</span><br><span class="line">            <span class="built_in">this</span>.upload(storageObject);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.upload(storageObject);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="4"><li>refreshTasks<br>根据当前设置的并行上传任务数目和正在上传的任务数目及时从文件预备上传队列提取文件放入上传可调用文件队列。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 刷新任务列表 */</span></span><br><span class="line">  @action</span><br><span class="line">  refreshTasks = <span class="function">(<span class="params">region</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 统计空闲任务</span></span><br><span class="line">    <span class="keyword">const</span> storageObject = <span class="built_in">this</span>.fileStorage.get(region);</span><br><span class="line">    <span class="keyword">if</span> (!storageObject) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.taskType.series.length &gt;= <span class="built_in">this</span>.multiTaskCount) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; storageObject.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.taskType.series.length === <span class="built_in">this</span>.multiTaskCount) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        storageObject[i].index !== storageObject[i].total</span><br><span class="line">        &amp;&amp;</span><br><span class="line">        (storageObject[i].state === <span class="string">&#x27;pending&#x27;</span> || storageObject[i].state === <span class="string">&#x27;uninitial&#x27;</span>)</span><br><span class="line">        &amp;&amp;</span><br><span class="line">        !<span class="built_in">this</span>.taskType.series.includes(storageObject[i])</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskType.series.push(storageObject[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>upload &amp; update<br>根据当前文件对象的上传分片索引对文件进行切割并更新索引，然后把切割下来的数据通过Ajax请求发送给中间件处理，中间件发送到后台后返回得到的当前分片的etag信息，前端拿到etag信息并存储到当前上传对象分片etag信息数组里面。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [upload 分割文件发起上传请求]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>file    [description]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>_params [...]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.bucket [bucket name]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.object [object name]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.uploadId [upload id]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @action</span><br><span class="line">  upload = <span class="function">(<span class="params">storageObject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> params = &#123;</span><br><span class="line">      <span class="attr">bucket</span>: storageObject.region,</span><br><span class="line">      <span class="attr">object</span>: storageObject.name,</span><br><span class="line">      <span class="attr">prefix</span>: storageObject.prefix,</span><br><span class="line">      <span class="attr">uploadId</span>: storageObject.uploadId,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> single = <span class="literal">false</span>; <span class="comment">// 不分片</span></span><br><span class="line">    <span class="comment">/* 异常状态退出 */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.isValidUploadingTask(storageObject)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (storageObject.state === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.taskType.pending.splice(<span class="built_in">this</span>.taskType.pending.indexOf(storageObject), <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">this</span>.taskType.uploading.push(storageObject);</span><br><span class="line">      storageObject.state = <span class="string">&#x27;uploading&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> num = storageObject.index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num === <span class="number">0</span> &amp;&amp; storageObject.size &lt;= storageObject.blockSize) &#123;</span><br><span class="line">      <span class="comment">// 不用分片的情况</span></span><br><span class="line">      single = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num === storageObject.total) &#123;</span><br><span class="line">      <span class="comment">// 所有分片都已经发出</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nextSize = <span class="built_in">Math</span>.min((num + <span class="number">1</span>) * storageObject.blockSize, storageObject.size);</span><br><span class="line">    <span class="keyword">const</span> fileData = storageObject.file.slice(num * storageObject.blockSize, nextSize);</span><br><span class="line">    params = <span class="built_in">Object</span>.assign(params, &#123;</span><br><span class="line">      <span class="attr">partNumber</span>: num + <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    storageObject.activePoint = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.uploadRequest(&#123; params, <span class="attr">data</span>: fileData, single &#125;).then(<span class="function">(<span class="params">rsp</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (rsp.code !== <span class="number">200</span>) &#123;</span><br><span class="line">        openNotification(<span class="string">&#x27;error&#x27;</span>, <span class="literal">null</span>, (rsp.result.data ? rsp.result.data.Code : <span class="built_in">this</span>.lang.lang.uploadError));</span><br><span class="line">        <span class="built_in">this</span>.markError(storageObject);</span><br><span class="line">        <span class="built_in">this</span>.startTasks(params.bucket);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> &#123; completed, etags &#125; = <span class="built_in">this</span>.update(&#123;</span><br><span class="line">        <span class="attr">region</span>: params.bucket,</span><br><span class="line">        <span class="attr">etag</span>: rsp.result.etag,</span><br><span class="line">        <span class="attr">size</span>: fileData.size,</span><br><span class="line">        <span class="attr">id</span>: storageObject.id,</span><br><span class="line">        <span class="attr">index</span>: params.partNumber,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (completed) &#123;</span><br><span class="line">        (single ?</span><br><span class="line">          <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.complete(storageObject, params.bucket);</span><br><span class="line">          &#125; :</span><br><span class="line">          <span class="function">(<span class="params">partEtags</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.completeRequest(&#123;</span><br><span class="line">              <span class="attr">bucket</span>: params.bucket,</span><br><span class="line">              <span class="attr">uploadId</span>: params.uploadId,</span><br><span class="line">              <span class="attr">object</span>: params.object,</span><br><span class="line">              <span class="attr">prefix</span>: params.prefix,</span><br><span class="line">              partEtags,</span><br><span class="line">            &#125;, storageObject);</span><br><span class="line">          &#125;)(etags);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.upload(storageObject);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.markError(storageObject);</span><br><span class="line">      <span class="built_in">this</span>.startTasks(params.bucket);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;params.bucket&#125;</span>_<span class="subst">$&#123;params.object&#125;</span> upload error: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    storageObject.index += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="7"><li>complete<br>当最后一个分片上传请求完成返回后，我们就拿到了服务端返回的这个文件的所有分片etag信息，前端需要校验当前上传对象etag数组的长度是否匹配，数组内每个etag元素的索引和etag值是否匹配，校验完成后发送最后一个请求到后端进行校验和组装分片，最终完成一个文件的分片上传过程。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [completeRequest 完成所有分片数据上传]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>_params [...]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.bucket [bucket name]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.object [object name]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.uploadId [upload id]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span>   </span>_params.partEtags [upload id]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>file [文件对象]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @action completeRequest = <span class="function">(<span class="params">params, file</span>) =&gt;</span> &#123;</span><br><span class="line">    postDataPro(</span><br><span class="line">      &#123;</span><br><span class="line">        ...&#123;</span><br><span class="line">          ...params,</span><br><span class="line">          ...&#123;</span><br><span class="line">            <span class="attr">object</span>: params.prefix + params.object,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">partEtags</span>: &#123;</span><br><span class="line">          <span class="attr">CompleteMultipartUpload</span>: &#123;</span><br><span class="line">            <span class="attr">Part</span>: params.partEtags.map(<span class="function"><span class="params">info</span> =&gt;</span> (&#123;</span><br><span class="line">              <span class="attr">PartNumber</span>: info.number,</span><br><span class="line">              <span class="attr">ETag</span>: info.etag,</span><br><span class="line">            &#125;)),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      objectResourceApi.object.completeFragmentUpload</span><br><span class="line">    ).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.complete(file, params.bucket);</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.startTasks(params.bucket);</span><br><span class="line">      <span class="built_in">this</span>.markError(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [complete 完成上传]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[Object]&#125;</span> </span>file [文件对象]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span> </span>bucket [桶名]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @action</span><br><span class="line">  complete = <span class="function">(<span class="params">storageObject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="built_in">this</span>.taskType.uploading.indexOf(storageObject);</span><br><span class="line">    <span class="built_in">this</span>.taskType.uploading.splice(index, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">this</span>.taskType.break.push(storageObject);</span><br><span class="line">    storageObject.completionTime = (<span class="keyword">new</span> <span class="built_in">Date</span>().toTimeString()).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">    storageObject.state = <span class="string">&#x27;break&#x27;</span>;</span><br><span class="line">    storageObject.speed = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    storageObject.index = storageObject.total;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.startTasks(storageObject.region);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="其它操作">其它操作</h4><ol><li><p>暂停文件上传<br>将上传对象的状态从uploading置为pause，然后把该对象对应的文件从可调用上传文件队列移除。</p></li><li><p>开始暂停的上传任务<br>将上传对象的状态从pause置为pending，然后把该对象对应的文件放入可调用上传文件队列，等待下一次刷新文件上传任务队列。</p></li><li><p>续传上传错误的任务<br>将上传对象的状态从error置为pending，然后把该对象对应的文件放入可调用上传文件队列，保持文件的已上传分片索引记录，等待下一次刷新文件上传任务队列，直接调用上传函数进行切割并上传。</p></li><li><p>重传上传错误的任务<br>将上传对象的状态从error置为pending，然后把该对象对应的文件放入可调用上传文件队列，并将文件已上传分片索引记录置为初始状态，等待下一次刷新文件上传任务队列，从文件初始位置重新开始切割文件并上传。</p></li></ol><h4 id="一些关键代码">一些关键代码</h4><ol><li>一个分片上传完成后将后台返回的etag信息更新到本地的上传对象属性，并判断此文件是否上传完成。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [update 更新本地上传记录]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span> </span>region [桶名]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span> </span>etag [分片标志]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @action</span><br><span class="line">  update = <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    region, etag, size, id, index,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> target = <span class="built_in">this</span>.fileStorage.get(region);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; target.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (target[i].id === id) &#123;</span><br><span class="line">        target[i].speed = <span class="string">`<span class="subst">$&#123;(size <span class="regexp">/ 1024 /</span> <span class="number">1024</span> <span class="regexp">/ (((new Date() - target[i].activePoint) /</span> <span class="number">1000</span>))).toFixed(<span class="number">2</span>)&#125;</span> MB/S`</span>;</span><br><span class="line">        <span class="keyword">if</span> (target[i].speed === <span class="string">&#x27;0.00 MB/S&#x27;</span>) &#123;</span><br><span class="line">          target[i].speed = <span class="string">`<span class="subst">$&#123;formatSizeStr(size)&#125;</span>/S`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target[i].partEtags = target[i].partEtags.filter(<span class="function"><span class="params">etagItem</span> =&gt;</span> etagItem.number !== index);</span><br><span class="line">        target[i].partEtags.push(&#123;</span><br><span class="line">          <span class="attr">number</span>: index,</span><br><span class="line">          etag,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 最后一个分片恰好又暂停的情况</span></span><br><span class="line">        <span class="keyword">if</span> (index === target[i].total) &#123;</span><br><span class="line">          <span class="keyword">if</span> (target[i].state === <span class="string">&#x27;pause&#x27;</span>) &#123;</span><br><span class="line">            index -= <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断上传是否完成</span></span><br><span class="line">        <span class="keyword">if</span> (target[i].total === <span class="number">0</span> || target[i].partEtags.toJS().length === target[i].total) &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">completed</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">etags</span>: target[i].partEtags,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>在Node.js中间件使用ak/sk预签名算法调用 s3 restful 原生接口<br>之前预研的时候尝试根据aws s3-version4签名文档里面请求预签名算法在使用Node.js中间件进行实现，结果很容易出现签名的signature不一致报错的情况，所以最后在Node.js中间件采用了一个npm库<a href="https://github.com/mhart/aws4">aws4</a>，用里面的签名方法对前端传过来的<code>ak/sk</code>进行url预签名，这里给出中间件<code>Request</code>方法的编写逻辑：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * templateStrTranform [模板字符串转换，s3接口中可能存在一些动态url参数，比如bucket名和object名，此方法动态替换相关的字符串]</span></span><br><span class="line"><span class="comment">  * params1: &#123;bucket: testBucket, uid: testUid, bucketId: testID&#125;</span></span><br><span class="line"><span class="comment">  * params2: /admin/bucket?format=json&amp;bucket=&#123;bucket&#125;&amp;uid=&#123;uid&#125;&amp;bucket-id=&#123;bucketId&#125;</span></span><br><span class="line"><span class="comment">  * return: /admin/bucket?format=json&amp;bucket=testBucket&amp;uid=testUid&amp;bucket-id=testID</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>varObj [替换变量对象]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span> </span>templateStr [模板字符串]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return <span class="type">&#123;[String]&#125;</span> </span>result [模板字符串]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.templateStrTransform = <span class="function">(<span class="params">varObj, templateStr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> varObj !== <span class="string">&#x27;object&#x27;</span> || !templateStr) <span class="keyword">return</span> templateStr;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> attr <span class="keyword">in</span> varObj) &#123;</span><br><span class="line">    <span class="keyword">if</span> (varObj.hasOwnProperty(attr) &amp;&amp; (!<span class="built_in">Number</span>(attr) &amp;&amp; <span class="built_in">Number</span>(attr) !== <span class="number">0</span> )) &#123;</span><br><span class="line">      templateStr = templateStr.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`&#123;<span class="subst">$&#123;attr&#125;</span>&#125;`</span>, <span class="string">&#x27;g&#x27;</span>), varObj[attr]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> templateStr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * api对象实例：</span></span><br><span class="line"><span class="comment">    listFragmentUpload: &#123;</span></span><br><span class="line"><span class="comment">      url: &#x27;/&#123;bucket&#125;/&#123;object&#125;?uploadId=&#123;uploadId&#125;&#x27;, // 包含动态模板字符串</span></span><br><span class="line"><span class="comment">      method: &#x27;get&#x27;,</span></span><br><span class="line"><span class="comment">      port: &#x27;7480&#x27;,</span></span><br><span class="line"><span class="comment">      type: &#x27;xml&#x27;, // 表明需要将接口返回数据进行xml -&gt; json转换</span></span><br><span class="line"><span class="comment">      reqType: &#x27;xml&#x27;, // 表明提交参数是xml格式，需要进行 json -&gt; xml转换</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">commonApiConfig = <span class="function">(<span class="params">headers, api, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isEnvDev &amp;&amp; !isEnvMock) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">`http://10.0.9.149:<span class="subst">$&#123;api.port&#125;</span><span class="subst">$&#123;templateStrTransform(data, api.url)&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">data</span>: paramsObjectParse(data, api.url),</span><br><span class="line">      <span class="attr">host</span>: <span class="string">`http://10.0.9.149:<span class="subst">$&#123;api.port&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">hostname</span>: <span class="string">`http://10.0.9.149`</span>,</span><br><span class="line">      <span class="attr">ip</span>: <span class="string">&#x27;10.0.9.149&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(isEnvDev &amp;&amp; isEnvMock) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">`http://10.0.7.15/mock/63<span class="subst">$&#123;templateStrTransform(data, api.url)&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">data</span>: paramsObjectParse(data, api.url),</span><br><span class="line">      <span class="attr">host</span>: <span class="string">`http://10.0.9.154:<span class="subst">$&#123;api.port&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">hostname</span>: <span class="string">`http://10.0.9.154`</span>,</span><br><span class="line">      <span class="attr">ip</span>: <span class="string">&#x27;10.0.9.154&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">`http://127.0.0.1:<span class="subst">$&#123;api.port&#125;</span><span class="subst">$&#123;templateStrTransform(data, api.url)&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">data</span>: paramsObjectParse(data, api.url),</span><br><span class="line">      <span class="attr">host</span>: <span class="string">`http://127.0.0.1:<span class="subst">$&#123;api.port&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">hostname</span>: <span class="string">`http://127.0.0.1`</span>,</span><br><span class="line">      <span class="attr">ip</span>: <span class="string">`127.0.0.1`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * aws4RequestSign [调用asw4的sign方法签名一个url]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [Express.js框架路由函数的req对象]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>path [调用的s3服务的接口url]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>api [自定义的api对象]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Buffer|String]&#125;</span> </span>data [请求body携带的参数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tips: 这里aws4.sign方法依赖node process 中的ak/sk env设置</span></span><br><span class="line"><span class="comment"> *  但是也可以使用sign方法的第二个options参数直接传入ak/sk进行显式调用，具体请查看此框架的npm文档</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">aws4RequestSign = <span class="function">(<span class="params">req, path, api, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> aws4 = <span class="built_in">require</span>(<span class="string">&#x27;aws4&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> opts = &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">`<span class="subst">$&#123;(commonApiConfig(req.headers, api, data)).host&#125;</span>`</span>,</span><br><span class="line">    path,</span><br><span class="line">    <span class="attr">url</span>: (commonApiConfig(req.headers, api, data)).hostname,</span><br><span class="line">    <span class="attr">signQuery</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">service</span>: process.env.AWS_SERVICE,</span><br><span class="line">    <span class="attr">region</span>: process.env.AWS_REGION,</span><br><span class="line">    <span class="attr">method</span>: api.method.toUpperCase(),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">body</span>: req.body,</span><br><span class="line">    <span class="attr">data</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// assumes AWS credentials are available in process.env</span></span><br><span class="line">  aws4.sign(opts)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> opts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * commonRequestAuth [签名并调用一个url]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [Express.js框架路由函数的req对象]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>path [调用的s3服务的接口url]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>api [自定义的api对象]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Buffer|String]&#125;</span> </span>data [请求body携带的参数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">const</span> commonRequestAuth = <span class="function">(<span class="params">params, api, req, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> iAxios = axios.create();</span><br><span class="line">  iAxios.defaults.timeout = params[<span class="string">&#x27;$no_timeout$&#x27;</span>] ? <span class="number">0</span> : <span class="number">30e3</span>;</span><br><span class="line">  <span class="comment">// 使用params对象转换存在动态变量的url  </span></span><br><span class="line">  <span class="keyword">const</span> parsedUrl = templateStrTransform(params, api.url);</span><br><span class="line">  <span class="comment">// aws env set</span></span><br><span class="line">  awsEnvRegistry(&#123;</span><br><span class="line">    <span class="attr">key</span>: req.cookies.access_key,</span><br><span class="line">    <span class="attr">secret</span>: req.cookies.secret_key,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 签署请求头</span></span><br><span class="line">  <span class="keyword">const</span> postData = jsonToXml(data, api.reqType);</span><br><span class="line">  <span class="keyword">const</span> awsOpts = <span class="built_in">exports</span>.aws4RequestSign(req, parsedUrl, api, params);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    iAxios.request(&#123;</span><br><span class="line">      <span class="attr">baseURL</span>: awsOpts.host,</span><br><span class="line">      <span class="attr">url</span>: awsOpts.path,</span><br><span class="line">      <span class="attr">method</span>: awsOpts.method,</span><br><span class="line">      <span class="attr">headers</span>: getContentType(awsOpts.headers, api.reqType, postData, params._headers),</span><br><span class="line">      <span class="attr">data</span>: postData,</span><br><span class="line">      <span class="attr">responseType</span>: api.resType,</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置header返回</span></span><br><span class="line">      <span class="keyword">if</span> (api.type === <span class="string">&#x27;header&#x27;</span>) <span class="keyword">return</span> resolve(&#123;</span><br><span class="line">        <span class="attr">result</span>: response.headers,</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 转换xml</span></span><br><span class="line">      <span class="keyword">if</span> (api.type === <span class="string">&#x27;xml&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          xmlToJson(response.data, api.type, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">              <span class="attr">result</span>: data,</span><br><span class="line">              <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">              <span class="comment">// data: jsonArrayToString(data),</span></span><br><span class="line">              <span class="attr">headers</span>: response.headers,</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          resolve(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="built_in">global</span>.lang.xml_parse_error,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      resolve(&#123;</span><br><span class="line">        <span class="attr">result</span>: response.data,</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error.response.data);</span><br><span class="line">      xmlToJson(error.response.data, <span class="string">&#x27;xml&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">600</span>,</span><br><span class="line">          <span class="attr">result</span>: &#123; <span class="attr">headers</span>: error.config, <span class="attr">data</span>: data.Error ? data.Error : error.response.data&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="3"><li>在web端使用ak/sk预签名算法调用 s3 restful 原生接口<br>如果项目需要从web端直连后端s3服务调用接口的话，上面的签名方法就不能用了，其实很多时候直连可以带来更好的性能，比如文件上传/下载等等，不用在中间件做文件转存，其他的接口调用直连的话也不用中间层做request转发了。这里推荐一个能够进行s3请求预签名的axios插件<a href="https://github.com/jamesmbourne/aws4-axios">aws4-axios</a>，用法如下：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; aws4Interceptor &#125; <span class="keyword">from</span> <span class="string">&quot;aws4-axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = axios.create();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> interceptor = aws4Interceptor(&#123;</span><br><span class="line">  <span class="attr">region</span>: <span class="string">&quot;eu-west-2&quot;</span>,</span><br><span class="line">  <span class="attr">service</span>: <span class="string">&quot;execute-api&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">accessKeyId</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">secretAccessKey</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.interceptors.request.use(interceptor);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Requests made using Axios will now be signed</span></span><br><span class="line">client.get(<span class="string">&quot;https://example.com/foo&quot;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upload </tag>
            
            <tag> aws </tag>
            
            <tag> s3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker运行容器化的Tim和Wechat</title>
      <link href="/blogs/2019/11/14/85550904.html/"/>
      <url>/blogs/2019/11/14/85550904.html/</url>
      
        <content type="html"><![CDATA[<h3 id="Contents">Contents</h3><ul><li>安装docker</li><li>安装容器</li><li>容器管理</li></ul><h3 id="安装docker">安装docker</h3><blockquote><p>Docker Engine-Community 支持以下的 Ubuntu 版本：</p><ul><li>Xenial 16.04 (LTS)</li><li>Bionic 18.04 (LTS)</li><li>Cosmic 18.10</li><li>Disco 19.04</li><li>其他更新的版本……</li></ul><p>Docker Engine - Community 支持上 x86_64（或 amd64）armhf，arm64，s390x （IBM Z），和 ppc64le（IBM的Power）架构。</p><hr><h4 id="卸载旧版本">卸载旧版本</h4><p>Docker 的旧版本被称为 docker，<a href="http://docker.io">docker.io</a> 或 docker-engine 。如果已安装，请卸载它们：</p></blockquote><p><code>$ sudo apt-get remove docker docker-engine docker.io containerd runc</code></p><blockquote><p>当前称为 Docker Engine-Community 软件包 docker-ce 。</p><p>安装 Docker Engine-Community，以下介绍两种方式。</p><hr><h4 id="使用-Docker-仓库进行安装">使用 Docker 仓库进行安装</h4><p>在新主机上首次安装 Docker Engine-Community 之前，需要设置 Docker 仓库。之后，您可以从仓库安装和更新 Docker 。</p><h4 id="设置仓库">设置仓库</h4><p>更新 apt 包索引。</p></blockquote><p><code>$ sudo apt-get update</code></p><blockquote><p>安装 apt 依赖包，用于通过HTTPS来获取仓库:</p></blockquote><p><code>$ sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</code></p><blockquote><p>添加 Docker 的官方 GPG 密钥：</p></blockquote><p><code>$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></p><blockquote><p>9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88 通过搜索指纹的后8个字符，验证您现在是否拥有带有指纹的密钥。</p></blockquote><p><code>$ sudo apt-key fingerprint 0EBFCD88</code></p><blockquote><p>pub   rsa4096 2017-02-22 [SCEA]<br>      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88<br>uid           [ unknown] Docker Release (CE deb) <a href="mailto:docker@docker.com">docker@docker.com</a><br>sub   rsa4096 2017-02-22 [S]</p><p>使用以下指令设置稳定版仓库</p></blockquote><p><code>$ sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ ubuntu $(lsb_release -cs) stable&quot;</code></p><blockquote><h4 id="安装-Docker-Engine-Community">安装 Docker Engine-Community</h4><p>更新 apt 包索引。</p></blockquote><p><code>$ sudo apt-get update</code></p><blockquote><p>安装最新版本的 Docker Engine-Community 和 containerd ，或者转到下一步安装特定版本：</p></blockquote><p><code>$ sudo apt-get install docker-ce docker-ce-cli containerd.io</code></p><blockquote><p>要安装特定版本的 Docker Engine-Community，请在仓库中列出可用版本，然后选择一种安装。列出您的仓库中可用的版本：</p></blockquote><p><code>$ apt-cache madison docker-ce </code></p><blockquote><p>docker-ce | 5:18.09.1~3-0~ubuntu-xenial | <a href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a>  xenial/stable amd64 Packages<br>  docker-ce | 5:18.09.0~3-0~ubuntu-xenial | <a href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a>  xenial/stable amd64 Packages<br>  docker-ce | 18.06.1~ce~3-0~ubuntu       | <a href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a>  xenial/stable amd64 Packages<br>  docker-ce | 18.06.0~ce~3-0~ubuntu       | <a href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a>  xenial/stable amd64 Packages<br>  …</p><p>使用第二列中的版本字符串安装特定版本，例如 5:18.09.1~3-0~ubuntu-xenial。</p></blockquote><p><code>$ sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</code></p><blockquote><p>测试 Docker 是否安装成功，输入以下指令，打印出以下信息则安装成功:</p></blockquote><p><code>$ sudo docker run hello-world</code></p><blockquote><h4 id="安装-docker-compose">安装 docker-compose</h4></blockquote><p><code>$ sudo apt install docker-compose</code></p><blockquote><h4 id="切换docker源为国内的源">切换docker源为国内的源</h4></blockquote><p><code>$ sudo gedit /etc/docker/daemon.json</code></p><blockquote><p>写入配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="安装容器">安装容器</h3><ul><li>Tim =&gt; <code>sudo docker pull bestwu/qq</code></li><li>wechat =&gt; <code>sudo docker pull bestwu/wechat</code></li></ul><h3 id="容器管理">容器管理</h3><ol><li>获取audio的组ID<br><code>getent group audio | cut -d: -f3</code></li><li>容器启动文件<br>接下来创建一个yml文件，比如说这里创建 docker-tim.yml，添加如下内容：</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="attr">qq:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">bestwu/qq:office</span>    <span class="comment"># 后面这个 office 改成 latest ， 登录的就是QQ，否则是Tim</span></span><br><span class="line">   <span class="attr">container_name:</span> <span class="string">qq</span></span><br><span class="line">   <span class="attr">devices:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/dev/snd</span> <span class="comment">#声音</span></span><br><span class="line">   <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/tmp/.X11-unix:/tmp/.X11-unix</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$HOME/TencentFiles:/TencentFiles</span></span><br><span class="line">   <span class="attr">environment:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">DISPLAY=unix$DISPLAY</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">XMODIFIERS=@im=ibus</span> <span class="comment">#中文输入</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">QT_IM_MODULE=ibus</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">GTK_IM_MODULE=ibus</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">AUDIO_GID=29</span> <span class="comment"># 可选 (29 parrotsec) 主机audio gid 解决声音设备访问权限问题</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">GID=1000</span> <span class="comment"># 可选 默认1000 主机当前用户 gid 解决挂载目录访问权限问题</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">UID=1000</span> <span class="comment"># 可选 默认1000 主机当前用户 uid 解决挂载目录访问权限问题</span></span><br></pre></td></tr></table></figure><ol start="3"><li>容器启动命令<br><a href="http://xn--start-tim-zq3o4611b.sh">编写start-tim.sh</a>：</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 密码更改为自己的</span></span><br><span class="line"><span class="comment"># -d 指定为后台启动</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;yw020154&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">docker-compose</span> <span class="string">-f</span> <span class="string">docker-tim.yml</span> <span class="string">up</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure><ol start="4"><li>容器的常用操作</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动/停止/重启</span></span><br><span class="line">sudo docker start/stop/restart qq</span><br><span class="line"><span class="comment"># 终止容器进程</span></span><br><span class="line">sudo docker <span class="built_in">kill</span> qq</span><br><span class="line"><span class="comment"># 查看运行容器</span></span><br><span class="line">sudo docker ps</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> docker </tag>
            
            <tag> desktop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron+Mobx+React开发记录（二）</title>
      <link href="/blogs/2019/10/26/63567fa4.html/"/>
      <url>/blogs/2019/10/26/63567fa4.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Fly.jpg"  alt="Hello World"></p><h3 id="目录">目录</h3><ol><li>前言</li><li>webpack4图片打包的问题</li><li>webpack4样式表打包分离</li><li>应用构建工具electron-builder配置</li><li>应用构建工具electron-builder的问题</li></ol><h3 id="前言">前言</h3><hr><p><a href="/blogs/2019/10/14/5340937c.html/">前一篇文章</a>主要记录了开发环境的搭建和一些开发时遇到的问题，这篇文章主要说说自己在coding work之后进行应用打包时遇到的问题(webpack打包和electron打包)，<a href="https://github.com/nojsja/electronux">项目地址</a>。</p><h3 id="webpack4图片打包的问题">webpack4图片打包的问题</h3><hr><h4 id="jsx中声明的img-src不能被webpack识别和打包">jsx中声明的img:src不能被webpack识别和打包</h4><p>在jsx中使用图片时，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;install-item-image&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;showTerminalInfo(item.label)&#125;&#125;&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">Dimmer</span> <span class="attr">active</span>=<span class="string">&#123;loading&#125;</span> <span class="attr">inverted</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loader</span> <span class="attr">size</span>=<span class="string">&quot;tiny&quot;</span>&gt;</span>&#123; loadingLable &#125;<span class="tag">&lt;/<span class="name">Loader</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Dimmer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;error&quot;</span> <span class="attr">src</span>=<span class="string">&#123;item.url&#125;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里img:src使用了一个变量，但无论是变量还是字符串，webpack在打包的时候都不能根据我们引用的资源路径在dist目录下生成正确的资源引用路径结构，所以只能在我们需要引用图片的地方，手动require引入，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">const imgSrc = require(&#x27;path/to/img&#x27;);</span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;imgSrc&#125;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>那如果img:src真的是变量而且需要一次引入多个那怎么办，如果你说想用for循环引入可以不，这其实是不行的，因为webpack打包的时候是识别不了你for循环内定义的变量的。引入办法如下，可以用正则表达式对一个文件夹内的所有文件进行匹配引入，并且可以在项目任意位置引入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 匹配1：只匹配图片</span><br><span class="line">const requireContext = require.context(&#x27;resources/install&#x27;, true, /^\.\/.*\.(jpg|png)$/);</span><br><span class="line">// 匹配2：匹配所有文件</span><br><span class="line">const requireContext = require.context(&#x27;resources/install&#x27;, true, /.*/);</span><br><span class="line">requireContext.keys().map(requireContext);</span><br></pre></td></tr></table></figure><h4 id="生产环境和开发环境的publicPath配置">生产环境和开发环境的publicPath配置</h4><p>关于publicPath这里有一篇说得比较清楚的<a href="https://www.jianshu.com/p/cbe81be10d78">文章</a></p><blockquote><p>output.path ： 硬盘上的路径，也就是你打算把文件打包到你的哪个目录，与发布时的路径完全无关。</p></blockquote><blockquote><p>output.publicPath： 主要用来转换url中的相对路径的。如果你引用到包含url的资源，一定要配置output.publicPath，配置了此项，webpack在打包时才能根据配置动态修改uri中的相对值。比如果你将所有打包生成好的文件托管在服务器上，访问格式是<code>www.yourhost.com/dist/index.html</code>的话，那publicPath就需要指定为<code>/dist/</code>。</p></blockquote><ul><li><p>webpack-dev-server的publicPath默认是<code>/</code>，也就是在开发环境下webpack-dev-server在内存中生成的bundle.js文件路径是<code>/</code>，我们在浏览器中访问<code>localhost:3000/bundle.js</code>就能看见了，如果你在生产环境下的访问路径是<code>localhost:3000/dist/bundle.js</code>，就需要指定webpack-dev-server的publicPath为<code>/dist/</code>，这只是一个内存中虚拟的路径映射，目的是为了统一开发环境和生产环境的路径问题。</p></li><li><p>开发环境下：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">webpack.config.js</span><br><span class="line">...</span><br><span class="line">devtool: &#x27;source-map&#x27;,</span><br><span class="line">  entry: [</span><br><span class="line">    &#x27;react-hot-loader/patch&#x27;,</span><br><span class="line">    &#x27;webpack-dev-server/client?http://localhost:3000&#x27;,</span><br><span class="line">    &#x27;webpack/hot/only-dev-server&#x27;,</span><br><span class="line">    &#x27;./app/index&#x27;,</span><br><span class="line">  ],</span><br><span class="line">  mode: &#x27;development&#x27;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: &#x27;bundle.js&#x27;,</span><br><span class="line">    path: path.resolve(__dirname, &#x27;dist&#x27;),</span><br><span class="line">    publicPath: &#x27;/&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>生产环境下：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">webpack.prod.config.js</span><br><span class="line">...</span><br><span class="line">entry: [</span><br><span class="line">    &#x27;./app/index&#x27;,</span><br><span class="line">  ],</span><br><span class="line">  mode: &#x27;production&#x27;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: &#x27;bundle.js&#x27;,</span><br><span class="line">    path: path.resolve(__dirname, &#x27;dist&#x27;),</span><br><span class="line">    publicPath: &#x27;/&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="统一生产环境和开发环境的资源引用路径">统一生产环境和开发环境的资源引用路径</h4><p>可以在webpack.config文件中指定<code>resolve.alias</code>来将一个绝对路径重命名，然后在项目任意位置直接使用重命名路径就行了，不用在import的时候搞很多相对路径声明<code>../../../</code>，如下：</p><ul><li>声明：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">webpack.config.js</span><br><span class="line">...</span><br><span class="line">resolve: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      resources: path.resolve(__dirname, &#x27;resources&#x27;),</span><br><span class="line">      app: path.resolve(__dirname, &#x27;app&#x27;),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>使用：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;resources/install/albert.png&quot;</span>&#125;&gt;</span></span><br></pre></td></tr></table></figure><h3 id="webpack4样式表打包分离">webpack4样式表打包分离</h3><hr><h4 id="css属性backgroup-image-url-的路径统一">css属性<code>backgroup-image: url(...)</code>的路径统一</h4><p>我们在webpack.config中指定<code>resolve.alias</code>之后，如果你要在css属性中引用那个绝对路径的别名的话，需要在img:url字符前多加一个<code>~</code>路径转换符号，来让webpack为你自动替换路径，如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.router-left-background</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">~resources/public/gohome.jpg</span>); <span class="comment">/* The image used */</span></span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f6f6f6</span>; <span class="comment">/* Used if the image is unavailable */</span></span><br><span class="line">  <span class="attribute">background-position</span>: center; <span class="comment">/* Center the image */</span></span><br><span class="line">  <span class="attribute">background-repeat</span>: no-repeat; <span class="comment">/* Do not repeat the image */</span></span><br><span class="line">  <span class="attribute">background-size</span>: cover; <span class="comment">/* cover size */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="将样式表从bundle-js文件中分离">将样式表从bundle.js文件中分离</h4><p>如果项目比较大的话，直接将样式表压缩进bundle.js文件中会导致页面首页加载时间比较长，这里我们使用<code>extract-text-webpack-plugin</code>webpack插件分离样式表，然后在index.html引入样式表，这样页面加载的时候浏览器就会发送异步请求来同时加载bundle.js文件和css文件，极大地提高加载速度。</p><ul><li>index.html</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>electronux<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.scss.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;./&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>开发环境下webpack插件<code>extract-text-webpack-plugin</code>配置<br>这里的插件<code>publicPath</code>需要根据webpack-dev-server的<code>publicPath</code>配置(默认是<code>/</code>)，如果我们的样式表会加载外部文件(例如图片和字体文件)的话，那个实际资源请求路径就会根据这里的<code>publicPath</code>来计算得出。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">webpack.config.js</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> CleanWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;clean-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">&#x27;extract-text-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拆分样式文件</span></span><br><span class="line"><span class="keyword">const</span> extractSass = <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&#x27;style.scss.css&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> extractCss = <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&#x27;style.css&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        use: [<span class="string">&#x27;babel-loader&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: extractCss.extract(&#123;</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">use</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: extractSass.extract(&#123;</span><br><span class="line">          <span class="attr">use</span>: [&#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">          &#125;],</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>, <span class="comment">// 在开发环境使用 style-loader</span></span><br><span class="line">          <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">      ...</span><br><span class="line">    ],</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    extractSass,</span><br><span class="line">    extractCss,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>生产环境下webpack插件<code>extract-text-webpack-plugin</code>配置<br>生产环境下需要将<code>publicPath</code>设置为我们打包后生成的dist目录，不然css中引用的外部资源如图片等是不能生成到dist目录中的。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">webpack.prod.config.js</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      ...</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: extractCss.extract(&#123;</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">use</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">publicPath</span>: path.join(__dirname, <span class="string">&#x27;dist/&#x27;</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: extractSass.extract(&#123;</span><br><span class="line">          <span class="attr">use</span>: [&#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">          &#125;],</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>, <span class="comment">// 在开发环境使用 style-loader</span></span><br><span class="line">          <span class="attr">publicPath</span>: path.join(__dirname, <span class="string">&#x27;dist/&#x27;</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h3 id="应用构建工具electron-builder配置">应用构建工具electron-builder配置</h3><hr><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;appId&quot;</span>: <span class="string">&quot;com.nojsja.electronux&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;copyright&quot;</span>: <span class="string">&quot;nojsja&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;productName&quot;</span>: <span class="string">&quot;electronux&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;asar&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;directories&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;buildResources&quot;</span>: <span class="string">&quot;build-assets/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;output&quot;</span>: <span class="string">&quot;build/&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;files&quot;</span>: [<span class="string">&quot;package.json&quot;</span>, <span class="string">&quot;index.js&quot;</span>, <span class="string">&quot;dist/&quot;</span>, <span class="string">&quot;app/&quot;</span>, <span class="string">&quot;node_modules/&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;linux&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;resources&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;System&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;A System Management Tool Build For Manjaro Linux 17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;synopsis&quot;</span>: <span class="string">&quot;electronux&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: [<span class="string">&quot;zip&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>electron-builder打包主要解决两个问题，一是怎么打包前端界面代码目录<code>dist</code>下的资源(渲染进程代码)，二是怎么打包由根目录下的index.js文件引入的资源(主进程代码)。配置文件中<code>files</code>参数项配置的就是所有需要最终打包进我们应用的所有文件了。</p><ul><li>package.json – 整个应用程序的依赖配置文件</li><li>index.js – 主进程入口文件</li><li>dist – 渲染进程资源文件</li><li>app – 运行时引用的源代码和资源目录</li><li>node_modules – 运行时引用的第三方模块和资源目录</li></ul><p>配置说明详细见<a href="https://www.electron.build/configuration/configuration">官方文档</a></p><h3 id="应用构建工具electron-builder的问题">应用构建工具electron-builder的问题</h3><hr><h4 id="国内墙导致打包工具依赖下载失败">国内墙导致打包工具依赖下载失败</h4><p>运行electron-builder的时候会首先下载各个打包依赖，但是如果直接下载是会失败的(下载源文件存在github)。但我这边终端是用polipo配置了http-proxy的，下载的时候还是很慢，最后仍会导致下载失败，这个真的比较头痛，我索性将git仓库clone到自己搭建的vps虚拟机上(日本节点)，然后在服务器上运行一次打包命令，再把<code>~/.cache/electron-builder</code>、<code>~/.cache/electron</code>这两个打包工具生成的目录直接下载到本地对应的目录下，最后在本地运行打包命令的时候就不会再去下载依赖了。</p><h4 id="打包成AppImage后在运行时不能使用chmod更改文件权限的问题">打包成AppImage后在运行时不能使用chmod更改文件权限的问题</h4><p>先来看一段Linux上常见的AppImage打包应用的定义：</p><blockquote><p>AppImage不把Linux应用程序安装在文件系统相应的目录中，相反，它没有进行实际的安装，AppImage文件只是个压缩文件，在它运行时候<code>挂载</code>，用AppImage打包的程序，一个程序就是一个文件。</p></blockquote><p>在我的应用中需要执行一些shell脚本获取系统信息，但是这些脚本在第一次运行的时候是需要使用node.js中fs模块的<code>fs.chmod</code>方法对shell脚本进行赋予可执行权限的(chmod 755)，但是AppImage运行时是不允许动态更改文件属性的，所有挂载的Applmage文件都是只读的，无奈，我放弃了将应用打包成AppImage这种格式。<br>为了便于测试可以直接打包成zip文件，解压后就能运行，如果要安装到不同的发行版的话还能打包成<code>pacman</code>、<code>deb</code>、<code>rpm</code>、<code>tar.gz</code>等文件。</p><h4 id="arar加密打包时造成绝对路径查找失败">arar加密打包时造成绝对路径查找失败</h4><p>electron-builder的打包参数中有一个参数是<code>asar: true/false</code>，如果指定了为true的话打包后的压缩包内的源代码是会被arar加密的，这个对一些不开源的代码来说还是很有必要，但在我这个应用中应用在运行的时候会动态加载一些自定义的模块文件，如果你加载的路径用的是绝对路径的话，这个加载过程就会失败，因为如果启用了arar的话，我们资源目录下所有的源代码都只是一个加密的压缩包，此时你是不能通过系统的绝对路径来找到我们要引入的那个模块代码路径的，当然如果你手动解压arar压缩包的话就能看到所有源代码的目录结构了。</p><h4 id="外部引用资源-img-src-css-url-的相对路径和绝对路径">外部引用资源(img:src / css:url)的相对路径和绝对路径</h4><p>html demo:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;install-item-image&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;showTerminalInfo(item.label)&#125;&#125;&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">Dimmer</span> <span class="attr">active</span>=<span class="string">&#123;loading&#125;</span> <span class="attr">inverted</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loader</span> <span class="attr">size</span>=<span class="string">&quot;tiny&quot;</span>&gt;</span>&#123; loadingLable &#125;<span class="tag">&lt;/<span class="name">Loader</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Dimmer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;error&quot;</span> <span class="attr">src</span>=<span class="string">&#123;item.url&#125;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>css demo:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.router-left-background</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">~resources/public/gohome.jpg</span>); <span class="comment">/* The image used */</span></span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f6f6f6</span>; <span class="comment">/* Used if the image is unavailable */</span></span><br><span class="line">  <span class="attribute">background-position</span>: center; <span class="comment">/* Center the image */</span></span><br><span class="line">  <span class="attribute">background-repeat</span>: no-repeat; <span class="comment">/* Do not repeat the image */</span></span><br><span class="line">  <span class="attribute">background-size</span>: cover; <span class="comment">/* cover size */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们正确地通过webpack打包了前端界面的代码，在dist目录下生成了正确的资源目录结构，然后尝试使用<code>electron index.js</code>命令来模拟生产环境下应用的运行(使用file协议加载dist目录下的资源)，发现代码中所有的引用资源请求都会失败。这是因为electron在生产环境下是使用<code>file</code>协议来加载文件的，首先我们在在执行了<code>electron index.js</code>命令后，electron窗口会按照我们定义的路径结构去查找index.html文件，然后加载主窗口，这个过程没有问题，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.loadURL(url.format(&#123;</span><br><span class="line">  <span class="attr">pathname</span>: path.resolve(__dirname, <span class="string">&#x27;dist&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">  <span class="attr">protocol</span>: <span class="string">&#x27;file:&#x27;</span>,</span><br><span class="line">  <span class="attr">slashes</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>然后在这个index.html中的css图片请求和react组件的图片请求就是问题之处了，因为我们没有指定当前工作目录，file协议加载文件时就会直接从系统根目录开始根据资源目录结构查找了，实际上，我们的所有资源都是在<code>dist</code>文件夹下的，而不是系统根目录<code>/</code>，解决办法是在我们的index.html文件里面指定一个base标签，指明当前工作目录就行了，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>electronux<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.scss.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;style.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;./&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="使用node-js对shell脚本赋予可执行权限">使用node.js对shell脚本赋予可执行权限</h4><p>node.js的fs模块可以为文件赋予可执行权限，并且<code>fs.chmod</code>命令不用额外申请权限，估计是如果当前用户可以以root权限运行文件的话，node会自动为你获取权限。</p><ul><li>定义fsChmod模块递归为一个目录内的所有文件授予权限：</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chmod</span>(<span class="params">target, opstr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.statSync(target).isDirectory()) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = fs.readdirSync(target);</span><br><span class="line">    <span class="keyword">if</span> (files.length) &#123;</span><br><span class="line">      files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        chmod(path.join(target, file), opstr);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fs.chmodSync(target, opstr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fsChmod</span>(<span class="params">dir, opstr</span>) </span>&#123;</span><br><span class="line">  chmod(dir, opstr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = fsChmod;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>在fsChmod同级目录下定义shell授权模块<br>这样子的话会避开绝对路径查找的问题</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fsChmod = <span class="built_in">require</span>(<span class="string">&#x27;./fs-chmod&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fsChmodShell</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  fsChmod(path.join(__dirname, <span class="string">&#x27;../shell&#x27;</span>), <span class="number">0o711</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = fsChmodShell;</span><br></pre></td></tr></table></figure><ul><li>项目index.js中引入执行<br><strong>注意：</strong> 请尽量不要在项目文件中使用<code>__dirname</code>和<code>procoss.pwd()</code>來加载一个模块，例如<code>path.resolve(process.cwd(), 'path/to/file')</code>这样的绝对路径，而应该使用<code>app.getAppPath()</code>，相对应的获取运行时绝对路径命令更改为<code>path.resolve(app.getAppPath(), 'path/to/file')</code>(app是electron自带的属性)来获取运行时执行目录，<code>app.getAppPath()</code>一般是<code>package.json</code>所处的目录。因为在开发环境下我们的代码目录结构和electron-builder打包后生产环境下的的应用代码结构是不一样的，比如开发环境下，index.js文件位于项目根目录<code>/</code>下，shell文件夹(存放shell scripts)的路径是<code>/app/service/shell</code>，经过electron-builder打包后，index.js(实际上被编译成了一个可执行文件 )仍然位于根目录<code>/</code>下，但是shell文件夹位置却变成了<code>/resources/app/app/shell</code>，这样子如果在index.js文件中对shell文件夹进行绝对路径查询的话就会发生严重错误。electron-builder打包后的源代码会被放到资源目录<code>/resources/app</code>下，位于资源目录下的代码是可以进行运行时绝对路径查询(前提是没有开启<code>arar</code>源代码加密)和相对路径查询的。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fsChmodShell = <span class="built_in">require</span>(<span class="string">&#x27;./app/services/middleware/fs-chmod-shell.js&#x27;</span>);</span><br><span class="line">fsChmodShell();</span><br></pre></td></tr></table></figure><h3 id="感谢阅读，如有错误，还请指正：">感谢阅读，如有错误，还请指正：- )</h3>]]></content>
      
      
      <categories>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> es6 </tag>
            
            <tag> react </tag>
            
            <tag> mobx </tag>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron+Mobx+React开发记录（一）</title>
      <link href="/blogs/2019/10/14/5340937c.html/"/>
      <url>/blogs/2019/10/14/5340937c.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Fly.jpg"  alt="Hello World"></p><h3 id="目录">目录</h3><ol><li>前言</li><li>开发环境搭建</li><li>引入Webpack4.0前端打包工具</li><li>Electron代码结构和代码热更新</li><li>前端界面React + Mobx 代码结构和热更新</li><li>Linux桌面客户端开发遇到的问题</li></ol><h3 id="前言">前言</h3><hr><p>最近桌面系统从Ubuntu18.04切换到了Manjaro Linux 17，之前听说Manjaro的软件丰富，仓库更新及时，很多常用软件都能一键安装(比如QQ，微信)，同时也支持主流的Linux桌面环境：Gnome、KDE、Cinnamon、Mate、Deepin等等，安装了Gnome版本的Manjaro之后发现果然还不错。系统安装好后配置比较繁琐，就想给Manjaro写一个GUI客户端工具用于安装常用软件和作为简单的系统管理工具 - <a href="https://github.com/nojsja/electronux.git">electronux</a><br>作为一名正直的前端开发人员，理所应当地就准备使用Electron + Node.js + React + Mobx + Webpack + Shell 来进行开发啦 ~ 目前仍然在开发中，这篇文章用于记录自己的环境搭建过程、一些对Electron+React开发的理解以及谈谈自己遇到的一些Linux桌面软件开发时遇到的问题和解决办法。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx1.png"  alt="clean_detail.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx2.png"  alt="clean_search.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx3.png"  alt="electron_pssword.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx4.png"  alt="info_total.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx5.png"  alt="install_detail.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx6.png"  alt="install_list.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx7.png"  alt="install_permission.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx8.png"  alt="startup_list.png"></p><h3 id="开发环境搭建">开发环境搭建</h3><hr><h4 id="代码目录结构">代码目录结构</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">electronux  </span><br><span class="line">|---- [dir ] app ( 主代码目录 )</span><br><span class="line">|----------- [dir ] app/configure ( 应用配置更新 )</span><br><span class="line">|----------- [dir ] app/runtime ( 运行数据文件 )</span><br><span class="line">|</span><br><span class="line">|----------- [dir ] app/services ( 后台服务存放目录 )</span><br><span class="line">|------------------------ [dir ] app/services/middleware ( 一些中间处理件 )</span><br><span class="line">|------------------------ [dir ] app/services/shell ( shell脚本存放目录 )</span><br><span class="line">|------------------------ [dir ] app/services/main-serv ( 主进程服务 )</span><br><span class="line">|------------------------ [dir ] app/services/render-serv ( 渲染进程服务 )</span><br><span class="line">|</span><br><span class="line">|----------- [dir ] app/stores ( 前端状态管理文件目录 )</span><br><span class="line">|----------- [dir ] app/styles  ( 公用样式表文件 )</span><br><span class="line">|----------- [dir ] app/utils  ( 公用工具函数 )</span><br><span class="line">|</span><br><span class="line">|----------- [dir ] app/views  ( UI界面代码 )</span><br><span class="line">|------------------------ [dir ] app/views/module1  ( 界面模块1 )</span><br><span class="line">|------------------------ [dir ] app/views/module2  ( 界面模块2)</span><br><span class="line">|------------------------ [dir ] app/views/module3  ( 界面模块3 )</span><br><span class="line">|</span><br><span class="line">|----------- [file] app/App.js  ( 前端应用入口文件 )</span><br><span class="line">|----------- [file] app/index.js ( 前端应用热加载文件 )</span><br><span class="line">|</span><br><span class="line">|---- [dir ] dist ( 前端代码编译打包文件存放目录 )</span><br><span class="line">|---- [dir ] resources ( 前端静态资源存放目录 )</span><br><span class="line">|</span><br><span class="line">|---- [file] .babelrc ( babel配置文件 )</span><br><span class="line">|---- [file] .editorconfig (编辑器编码规范文件)</span><br><span class="line">|---- [file] .eslintrc ( 代码格式检查配置文件 )</span><br><span class="line">|---- [file] .gitignore ( git忽略追踪配置文件 )</span><br><span class="line">|---- [file] electron-builder.json ( electron-builder打包配置文件 )</span><br><span class="line">|---- [file] index.html  ( 应用渲染入口页面 )</span><br><span class="line">|---- [file] index.js ( 应用主进程入口文件 )</span><br><span class="line">|---- [file] package.json (前端模块和框架配置文件)</span><br><span class="line">|---- [file] webpack.config.js (webpack开发环境配置文件)</span><br><span class="line">|---- [file] webpack.prod.config.js  ( webpack生产环境配置文件 )</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="项目环境依赖配置文件">项目环境依赖配置文件</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;electronux&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;linux manager-software powered by electron &amp; react &amp; Mobx &quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;nojsja&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;yangwei020154@gmail.com&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;concurrently \&quot;npm run start-dev\&quot; \&quot;npm run start-electron\&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start-dev&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=development webpack-dev-server&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start-electron&quot;</span>: <span class="string">&quot;nodemon --exec &#x27;cross-env NODE_ENV=development electron --inspect=5858 index&#x27;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;start-production&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=production electron --inspect=5858 index&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build-all&quot;</span>: <span class="string">&quot;npm run dist &amp;&amp; npm run build&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dist&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=production webpack --config webpack.prod.config.js&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;electron-builder -l&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;electron&quot;</span>,</span><br><span class="line">    <span class="string">&quot;react&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mobx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;react-router&quot;</span>,</span><br><span class="line">    <span class="string">&quot;webpack4&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;nodemonConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ignore&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;resources/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;node_modules/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;dist/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;build/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/stores/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/styles/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/services/shell/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/configure/view.conf&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/views/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/App.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/main.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/index.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;electron-builder.yml&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;delay&quot;</span>: <span class="string">&quot;1000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;semantic-ui-css&quot;</span>: <span class="string">&quot;^2.4.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;semantic-ui-react&quot;</span>: <span class="string">&quot;^0.82.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mobx&quot;</span>: <span class="string">&quot;^4.4.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mobx-react&quot;</span>: <span class="string">&quot;^5.2.8&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;prop-types&quot;</span>: <span class="string">&quot;^15.6.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react&quot;</span>: <span class="string">&quot;^16.5.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-dom&quot;</span>: <span class="string">&quot;^16.5.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-hot-loader&quot;</span>: <span class="string">&quot;^4.3.8&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-router&quot;</span>: <span class="string">&quot;^4.3.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;react-router-dom&quot;</span>: <span class="string">&quot;^4.3.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;history&quot;</span>: <span class="string">&quot;^4.7.2&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;babel-core&quot;</span>: <span class="string">&quot;^6.26.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-eslint&quot;</span>: <span class="string">&quot;^10.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-loader&quot;</span>: <span class="string">&quot;^7.1.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-plugin-transform-decorators-legacy&quot;</span>: <span class="string">&quot;^1.3.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-preset-env&quot;</span>: <span class="string">&quot;^1.7.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-preset-es2015&quot;</span>: <span class="string">&quot;^6.24.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-preset-react&quot;</span>: <span class="string">&quot;^6.24.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-preset-stage-0&quot;</span>: <span class="string">&quot;^6.24.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;clean-webpack-plugin&quot;</span>: <span class="string">&quot;^0.1.19&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;concurrently&quot;</span>: <span class="string">&quot;^3.6.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cross-env&quot;</span>: <span class="string">&quot;^5.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;css-loader&quot;</span>: <span class="string">&quot;^0.28.11&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron&quot;</span>: <span class="string">&quot;^2.0.9&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;electron-builder&quot;</span>: <span class="string">&quot;^20.28.4&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint&quot;</span>: <span class="string">&quot;^5.6.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-config-airbnb&quot;</span>: <span class="string">&quot;^17.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-plugin-import&quot;</span>: <span class="string">&quot;^2.14.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-plugin-jsx-a11y&quot;</span>: <span class="string">&quot;^6.1.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-plugin-react&quot;</span>: <span class="string">&quot;^7.11.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;extract-text-webpack-plugin&quot;</span>: <span class="string">&quot;^4.0.0-beta.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;file-loader&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;html-loader&quot;</span>: <span class="string">&quot;^0.5.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;html-webpack-plugin&quot;</span>: <span class="string">&quot;^3.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;node-sass&quot;</span>: <span class="string">&quot;^4.9.4&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;nodemon&quot;</span>: <span class="string">&quot;^1.18.4&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sass-loader&quot;</span>: <span class="string">&quot;^7.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;source-map-support&quot;</span>: <span class="string">&quot;^0.5.9&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;style-loader&quot;</span>: <span class="string">&quot;^0.21.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url-loader&quot;</span>: <span class="string">&quot;^1.1.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;webpack&quot;</span>: <span class="string">&quot;^4.19.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;webpack-cli&quot;</span>: <span class="string">&quot;^2.1.5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;webpack-dev-server&quot;</span>: <span class="string">&quot;^3.1.8&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="引入Webpack4-0前端打包工具">引入Webpack4.0前端打包工具</h3><hr><h4 id="webpack开发环境配置文件">webpack开发环境配置文件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> CleanWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;clean-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">&#x27;extract-text-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拆分样式文件</span></span><br><span class="line"><span class="keyword">const</span> extractSass = <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&#x27;style.scss.css&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extractCss = <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&#x27;style.css&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">devtool</span>: <span class="string">&#x27;source-map&#x27;</span>,</span><br><span class="line">  <span class="attr">entry</span>: [</span><br><span class="line">    <span class="string">&#x27;react-hot-loader/patch&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webpack-dev-server/client?http://localhost:3000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webpack/hot/only-dev-server&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;./app/index&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.resolve(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="attr">resources</span>: path.resolve(__dirname, <span class="string">&#x27;resources&#x27;</span>),</span><br><span class="line">      <span class="attr">app</span>: path.resolve(__dirname, <span class="string">&#x27;app&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        use: [<span class="string">&#x27;babel-loader&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: extractCss.extract(&#123;</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">use</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        use: extractSass.extract(&#123;</span><br><span class="line">          <span class="attr">use</span>: [&#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">          &#125;],</span><br><span class="line">          <span class="attr">fallback</span>: <span class="string">&#x27;style-loader&#x27;</span>, <span class="comment">// 在开发环境使用 style-loader</span></span><br><span class="line">          <span class="attr">publicPath</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.html$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;html-loader&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif|svg|ico|woff|eot|ttf|woff2)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;file-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;[path][name].[ext]&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    extractSass,</span><br><span class="line">    extractCss,</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">&#x27;dist&#x27;</span>]),</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.NoEmitOnErrorsPlugin(),</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">historyApiFallback</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">target</span>: <span class="string">&#x27;electron-renderer&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Electron基本原理和代码热更新">Electron基本原理和代码热更新</h3><hr><blockquote><p>Electron 运行 package.json 的 main 脚本的进程被称为主进程。 在主进程中运行的脚本通过创建web页面来展示用户界面。 一个 Electron 应用总是有且只有一个主进程。<br>由于 Electron 使用了 Chromium 来展示 web 页面，所以 Chromium 的多进程架构也被使用到。 每个 Electron 中的 web 页面运行在它自己的渲染进程中。<br>在普通的浏览器中，web页面通常在一个沙盒环境中运行，不被允许去接触原生的资源。 然而 Electron 的用户在 Node.js 的 API 支持下可以在页面中和操作系统进行一些底层交互。<br>进程使用 BrowserWindow 实例创建页面。 每个 BrowserWindow 实例都在自己的渲染进程里运行页面。 当一个 BrowserWindow 实例被销毁后，相应的渲染进程也会被终止。<br>主进程管理所有的web页面和它们对应的渲染进程。 每个渲染进程都是独立的，它只关心它所运行的 web 页面。<br>在页面中调用与 GUI 相关的原生 API 是不被允许的，因为在 web 页面里操作原生的 GUI 资源是非常危险的，而且容易造成资源泄露。 如果你想在 web 页面里使用 GUI 操作，其对应的渲染进程必须与主进程进行通讯，请求主进程进行相关的 GUI 操作。</p></blockquote><h4 id="创建主进程">创建主进程</h4><p>在index.js文件中我们引入electron和所有的自定义模块文件，并根据开发环境或是生产环境来进行主进程窗口加载，开发环境下使用<code>http协议</code>加载由webpack-dev-server启动的http服务，生产环境下使用<code>file协议</code>加载本地由webpack打包好的前端bundle.js文件，所以开发环境下<code>npm start</code>指令其实主要是执行了两步操作，一是启动webpack-dev-server，此时已经可以通过外部浏览器访问到localhost:3000的http服务，只不过我们实际是用electron之中的chromium浏览器来加载的，它与node.js主进程共享同一个chrome v8引擎，所以理论上，在页面加载后，你同样可以在渲染进程中使用node.js API，比如用使用fs模块访问文件系统。</p><h4 id="主进程代码热更新">主进程代码热更新</h4><p>我用了nodemon工具实现了主进程代码热更新，如果不用nodemon工具那么 <code>npm start-electron</code>命令实际是执行<code>cross-env NODE_ENV=development electron index</code>，就是简单的用electron启动主进程文件，使用nodemon之后<code>npm start-electron</code>实际上是执行<code>nodemon --exec 'cross-env NODE_ENV=development electron index'</code>，最后在package.json文件中增加一个nodemonConfig字段用于指定哪些文件需要纳入nodemon监听即可。</p><p>=&gt; package.json中定义的启动脚本：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;concurrently \&quot;npm run start-dev\&quot; \&quot;npm run start-electron\&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start-dev&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=development webpack-dev-server&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start-electron&quot;</span>: <span class="string">&quot;nodemon --exec &#x27;cross-env NODE_ENV=development electron index&#x27;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;npm run dist &amp;&amp; npm run build-all&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dist&quot;</span>: <span class="string">&quot;cross-env NODE_ENV=production webpack  --config webpack.production.config.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;build-all&quot;</span>: <span class="string">&quot;build -lmw&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>=&gt; package.json中nodemonConfig字段</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;nodemonConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ignore&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;resources/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;node_modules/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;dist/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/stores/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/styles/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/services/shell/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/configure/view.conf&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/views/*&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/App.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/main.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;app/index.js&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;delay&quot;</span>: <span class="string">&quot;1000&quot;</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>=&gt; 项目启动文件index.js：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// 根据运行环境加载窗口 //</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadWindow</span>(<span class="params"><span class="built_in">window</span>, env</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (env === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// wait for webpack-dev-server start</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>.loadURL(url.format(&#123;</span><br><span class="line">        <span class="attr">pathname</span>: <span class="string">&#x27;localhost:3000&#x27;</span>,</span><br><span class="line">        <span class="attr">protocol</span>: <span class="string">&#x27;http:&#x27;</span>,</span><br><span class="line">        <span class="attr">slashes</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;));</span><br><span class="line">      <span class="comment">// window.webContents.openDevTools();</span></span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.loadURL(url.format(&#123;</span><br><span class="line">      <span class="attr">pathname</span>: path.join(path.resolve(__dirname, <span class="string">&#x27;./dist&#x27;</span>), <span class="string">&#x27;index.html&#x27;</span>),</span><br><span class="line">      <span class="attr">protocol</span>: <span class="string">&#x27;file:&#x27;</span>,</span><br><span class="line">      <span class="attr">slashes</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- main window ------------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; width, height &#125; = getAppConf();</span><br><span class="line">  win = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">    width,</span><br><span class="line">    height,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;electronux&#x27;</span>,</span><br><span class="line">    <span class="attr">autoHideMenuBar</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  win.on(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [_width, _height] = win.getContentSize();</span><br><span class="line">    viewConf.set(&#123;</span><br><span class="line">      <span class="attr">width</span>: _width,</span><br><span class="line">      <span class="attr">height</span>: _height,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  loadWindow(win, nodeEnv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- electron event ------------------- */</span></span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;ready&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (nodeEnv === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    sourceMapSupport.install();</span><br><span class="line">  &#125;</span><br><span class="line">  createWindow();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;window-all-closed&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.platform !== <span class="string">&#x27;darwin&#x27;</span>) &#123;</span><br><span class="line">    app.quit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;will-quit&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  viewConf.write().then(<span class="function">() =&gt;</span> <span class="number">0</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;App quit: view-conf write error !&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&#x27;activate&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (win === <span class="literal">null</span>) &#123;</span><br><span class="line">    createWindow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="前端界面React-Mobx-代码结构和热更新">前端界面React + Mobx 代码结构和热更新</h3><hr><h4 id="代码结构">代码结构</h4><ol><li>App.js前端入口文件<br>入口文件基本是整个前端应用的关键点，我们使用<code>mobx-react</code>包提供的Provider组件加载整个应用，并把各个应用模块(按功能划分)的mobx store示例作为props属性传入Provider，在各个组建中使用修饰器<code>@inject</code>就能直接使用store实例了，页面层次比较多的话最好使用React Router进行路由管理，值得注意的是React Router V4版本跟之前版本的理念和使用方式有很大区别，可以去官网查阅相关文档<a href="https://reacttraining.com/react-router/web/guides/quick-start">react-router4</a></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------- export global history ------------------- */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> history = createHistory();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stores = &#123;</span><br><span class="line">  <span class="attr">install</span>: <span class="keyword">new</span> InstallState(),</span><br><span class="line">  <span class="attr">startup</span>: <span class="keyword">new</span> StartupState(),</span><br><span class="line">  <span class="attr">info</span>: <span class="keyword">new</span> InfoState(),</span><br><span class="line">  <span class="attr">clean</span>: <span class="keyword">new</span> CleanState(),</span><br><span class="line">  <span class="attr">pub</span>: <span class="keyword">new</span> PublicState(),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">Provider</span> &#123;<span class="attr">...stores</span>&#125;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;history&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;HomePage&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- export provider ------------------- */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li>mobx store 存储<br>这是项目其中一个系统清理模块的mobx store，在store中被mobx监听的属性最好结构层次简单、只有单一的功能划分，不要把一个属性对象的嵌套写得太深。开发时我们把UI界面的数据抽象成store中的数据时可能会下意识地根据页面显示状态而把单个属性对象写得过于复杂，但其实页面显示状态只是逻辑的数据结构，我们在store中存储的时候应该尽量将这种逻辑数据结构<code>翻译</code>成扁平化的数据结构，然后再在各个属性对象之间建立映射关系。<br>并且使用了mobx之后请尽量依赖mobx的数据引用监听自动更新特性，多写<code>computed</code>、<code>autorun</code>来自动生成数据，使用<code>action</code>修饰一些需要更改store属性的方法。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Clean</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line">  <span class="comment">/* ------------------- observable ------------------- */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 所有检查项目 //</span></span><br><span class="line">  @observable items = &#123;</span><br><span class="line">    <span class="attr">appCache</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">appLog</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">trash</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">packageCache</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主界面加载 //</span></span><br><span class="line">  @observable loadingMain = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理路径 //</span></span><br><span class="line">  cleanPaths = &#123;</span><br><span class="line">    <span class="attr">appCache</span>: [<span class="string">`/home/<span class="subst">$&#123;<span class="built_in">this</span>.userinfo.username&#125;</span>/.cache`</span>],</span><br><span class="line">    <span class="attr">appLog</span>: [<span class="string">&#x27;/var/log/&#x27;</span>],</span><br><span class="line">    <span class="attr">trash</span>: [<span class="string">`/home/<span class="subst">$&#123;<span class="built_in">this</span>.userinfo.username&#125;</span>/.local/share/Trash/files`</span>],</span><br><span class="line">    <span class="attr">packageCache</span>: [<span class="string">&#x27;/var/cache/pacman/pkg&#x27;</span>],</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路径模块映射 //</span></span><br><span class="line">  @observable cleanPathMap = &#123;</span><br><span class="line">    <span class="attr">appCache</span>: [], <span class="comment">// &#x27;/var/log/pacman.log&#x27;</span></span><br><span class="line">    <span class="attr">appLog</span>: [],</span><br><span class="line">    <span class="attr">trash</span>: [],</span><br><span class="line">    <span class="attr">packageCache</span>: [],</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理内容 //</span></span><br><span class="line">  @observable cleanContents = observable.map(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理大小 //</span></span><br><span class="line">  cleanSizes = &#123;</span><br><span class="line">    <span class="comment">// &#x27;/var/log//pacman.log&#x27;: &#x27;10kb&#x27;,</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ---- 清理选项细节-数据对象逻辑树结构 ---- //</span></span><br><span class="line">  <span class="comment">// @observable cleanDetails = &#123;</span></span><br><span class="line">  <span class="comment">//   appCache: &#123;</span></span><br><span class="line">  <span class="comment">//     url: [`/home/$&#123;this.userinfo.username&#125;/.cache`], // 指定扫描路径多个</span></span><br><span class="line">  <span class="comment">//     contents: &#123; // 绝对路径</span></span><br><span class="line">  <span class="comment">//       // &#x27;/var/cache/pacman/pkg/zsh-5.6.2-1-x86_64.pkg.tar.xz&#x27;: false,</span></span><br><span class="line">  <span class="comment">//     &#125;,</span></span><br><span class="line">  <span class="comment">//     size: &#123;</span></span><br><span class="line">  <span class="comment">//       // &#x27;/var/cache/pacman/pkg/zsh-5.6.2-1-x86_64.pkg.tar.xz&#x27;: &#x27;10kb&#x27;,</span></span><br><span class="line">  <span class="comment">//     &#125;,</span></span><br><span class="line">  <span class="comment">//   &#125;,</span></span><br><span class="line">  <span class="comment">//   appLog: &#123;</span></span><br><span class="line">  <span class="comment">//     url: [&#x27;/var/log/&#x27;],</span></span><br><span class="line">  <span class="comment">//     contents: &#123;</span></span><br><span class="line">  <span class="comment">//       // &#x27;/var/log//pacman.log&#x27;: false,</span></span><br><span class="line">  <span class="comment">//     &#125;,</span></span><br><span class="line">  <span class="comment">//     size: &#123;</span></span><br><span class="line">  <span class="comment">//       // &#x27;/var/log//pacman.log&#x27;: &#x27;10kb&#x27;,</span></span><br><span class="line">  <span class="comment">//     &#125;,</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ------------------- static ------------------- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ------------------- computed ------------------- */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取所有被选中的detail item //</span></span><br><span class="line">  @computed <span class="keyword">get</span> <span class="title">allCheckedDetail</span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> a = [];</span><br><span class="line">    <span class="built_in">this</span>.cleanContents.forEach(<span class="function">(<span class="params">v, k</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (v) a.push(k);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理路径详细信息 //</span></span><br><span class="line">  @computed <span class="keyword">get</span> <span class="title">cleanDetail</span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> result = [];</span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="built_in">this</span>.cleanPathMap).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.items[item]) &#123;</span><br><span class="line">        <span class="keyword">const</span> oneResult = &#123;</span><br><span class="line">          <span class="attr">label</span>: item,</span><br><span class="line">          <span class="attr">contents</span>: [],</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">this</span>.cleanPathMap[item].forEach(<span class="function">(<span class="params">it</span>) =&gt;</span> &#123;</span><br><span class="line">          oneResult.contents.push(&#123;</span><br><span class="line">            <span class="attr">content</span>: it,</span><br><span class="line">            <span class="attr">size</span>: <span class="built_in">this</span>.cleanSizes[it] || <span class="number">0</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        result.push(oneResult);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Clean;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li><p>页面组件划分<br>在views目录下创建的各个目录都是一个单独的组件目录，组件目录下有一个组件入口文件和css样式表文件以及其它子组件，入口文件载入css文件和子组件，使用<code>@inject</code>修饰器后各个组件都可以独立访问mobx store实例，不必在父和子组件之间通过props进行逐级参数传递，但是如果一个子组件依赖父组件来加工原始数据的话也可以使用props传递参数。<br>使用了mobx之后，并不是说每个页面需要使用的数据都有必要纳入mobx store的管理，在我的代码中只是把<code>关键性数据</code>以及<code>关键性数据加工方法</code>存入了store中，每个组件拿到store传递下来的数据后一些页面状态可能需要依赖组件各自的数据处理函数进行数据二次加工，我觉得这样应该会减轻store实例的负载压力，非绝对中心化。比如在一个列表菜单组件中，这个组件的列表数据可以切换显示和隐藏，但是控制这个列表显示/隐藏的参数状态<code>visible</code>没有必要纳入store实例管理，相对的管理这个列表组件的store实例只是存储了列表数据的数组，以及一些必要的数据加工方法。</p></li><li><p>渲染进程和主进程ipc通信的问题<br>页面的每个渲染进程(ipcRender)，虽然说可以直接使用node.js原生模块和api，但是不建议在渲染进程中过度使用原生模块，一是因为一些node.js原生模块并没有考虑到进程安全的问题，第二个原因是渲染进程应该专注处理页面交互和数据处理问题，划清代码的功能区域，把和系统交互的问题交由主进程(ipcMain)处理，把网络数据请求也交由各自的service服务，减少不必要的模块和数据耦合。渲染进程通过ipc通信向主进程发送处理请求，主进程和service负责原始数据的获取和网络数据的传输，最后主进程通过ipc通信向对应的渲染进程返回处理结果，service拿到的网络数据也通过回调事件发送给渲染进程。项目中我把mobx store作为和主进程通信的桥梁，mobx store向主进程发送信号，同时也在接收到主进程的ipc通信事件后再把主进程发回来的数据更新到各个observer。总之主进程和service服务负责系统交互、原始数据获取和传输，渲染进程mobx store负责响应信号和事件进行业务数据更新，各个view子组件只负责页面渲染和用户交互。</p></li></ol><h4 id="前端代码热更新">前端代码热更新</h4><ol><li>webpack.config.js中启动webpack-dev-server的热更新功能</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">historyApiFallback</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><ol start="2"><li>使用<code>react-hot-loader</code>的AppContainer组件</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AppContainer &#125; <span class="keyword">from</span> <span class="string">&#x27;react-hot-loader&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;semantic-ui-css/semantic.min.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./styles/public.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">AppContainer</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">AppContainer</span>&gt;</span></span>,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="Linux桌面客户端开发遇到的问题">Linux桌面客户端开发遇到的问题</h3><hr><h4 id="使用node-js子进程child-process执行shell脚本时无法取得系统root权限">使用node.js子进程child_process执行shell脚本时无法取得系统root权限</h4><p>项目中有的脚本需要使用root权限，比如安装和卸载软件、扫描系统关键路径，node.js里执行shell脚本可以使用child_process模块(node.js子进程)，child_process有几个方法，<code>spawn</code>、<code>exec</code>、<code>execFile</code>、<code>fork</code>，它们都能创建子进程以执行指定文件或命令，具体的使用方法见<a href="http://nodejs.cn/api/child_process.html#child_process_asynchronous_process_creation">Node API</a>，如果我们的脚本或指令需要使用root权限那可就麻烦了，桌面应用又不是终端，不可能用着用着让用户去终端输入密码吧，况且只是在开发环境下能看到终端输出，应用打包安装运行起来后就是一个独立的应用程序了，根本没法输入终端密码，仔细查阅了Electron官网API发现electron官方并没有集成一个什么系统权限调用窗口之类的组件。没办法了，这种情况下手动写出了两种方法：</p><ol><li>调用获取系统权限的系统自带组件来执行自定义命令和脚本</li><li>封装一个弹窗组件来获取用户首次输入的密码，然后手动把密码记录到文件中，应用启动的时候从文件中读出密码，在使用child_process创建子进程的时候再监听子进程的输出事件和错误事件，然后把读取到的保存在内存中的密码以输入流(input stream)的形式发送给child_process创建的子进程，子进程读取到输入流传入的密码后就能继续执行了。</li></ol><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx9.png"  alt="electron_pssword.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="mobx10.png"  alt="install_permission.png"></p><p><strong>具体代码见</strong>：<a href="/blogs/img/article/mobx10.png">github/nojsja/electronux/app/utils/sudo-prompt.js</a></p><p><em>感谢阅读，文章中出现的错误之处还请多指正~</em></p><h3 id="未完待续">未完待续</h3>]]></content>
      
      
      <categories>
          
          <category> Mobx </category>
          
          <category> Electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> es6 </tag>
            
            <tag> react </tag>
            
            <tag> mobx </tag>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>polipo服务配置shadowsocks终端代理</title>
      <link href="/blogs/2019/10/01/c358676f.html/"/>
      <url>/blogs/2019/10/01/c358676f.html/</url>
      
        <content type="html"><![CDATA[<p>在linux系统中，一般配置好shadowsocks之后，浏览器设置好代理，浏览器就可以翻墙。但是由于ss使用的是<code>socks5</code>协议，而大部分终端都只支持<code>http</code>和<code>https</code>等协议，终端是无法直接通过ss来翻墙。通过polipo这个轻量级的缓存web代理程序来转换，可实现终端翻墙。</p><h4 id="安装shadowsocks">安装shadowsocks<a href="http://keliu.me/2018/12/08/ss/#%E5%AE%89%E8%A3%85shadowsocks"></a></h4><p>通过pip可以非常简单地安装。需要安装ss需要的依赖。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python-pip</span><br><span class="line">sudo apt-get install python-setuptools m2crypto</span><br><span class="line"></span><br><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure><h4 id="启动shadowsocks">启动shadowsocks<a href="http://keliu.me/2018/12/08/ss/#%E5%90%AF%E5%8A%A8shadowsocks"></a></h4><p>使用<code>sslocal</code>命令来启动shadowsocks。</p><p>一般在<code>/etc</code>目录下创建一个<code>shadowsocks.json</code>文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/shadowsocks.json</span><br></pre></td></tr></table></figure><p>保存如下形式的ss服务端信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;11.22.33.44&quot;,</span><br><span class="line">    &quot;server_port&quot;:6666,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;:&quot;123456&quot;,</span><br><span class="line">    &quot;timeout&quot;:300,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动ss。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sslocal -c /etc/shadowsocks.json</span><br></pre></td></tr></table></figure><p>可以设置开机自动启动服务，还有浏览器代理的配置，此处也都暂时不讲。</p><h4 id="安装配置polipo">安装配置polipo<a href="http://keliu.me/2018/12/08/ss/#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEpolipo"></a></h4><p>安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install polipo</span><br></pre></td></tr></table></figure><p>polio的配置文件在<code>/etc/polipo/config</code>目录。打开，编辑保存如下信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># This file only needs to list configuration variables that deviate</span><br><span class="line"># from the default values.  See /usr/share/doc/polipo/examples/config.sample</span><br><span class="line"># and &quot;polipo -v&quot; for variables you can tweak and further information.</span><br><span class="line"></span><br><span class="line">logSyslog = true</span><br><span class="line">logFile = /var/log/polipo/polipo.log</span><br><span class="line"></span><br><span class="line">proxyAddress = &quot;0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line">socksParentProxy = &quot;127.0.0.1:1080&quot;</span><br><span class="line">socksProxyType = socks5</span><br><span class="line">proxyPort = 8123</span><br><span class="line"></span><br><span class="line">chunkHighMark = 50331648</span><br><span class="line">objectHighMark = 16384</span><br><span class="line"></span><br><span class="line">serverMaxSlots = 64</span><br><span class="line">serverSlots = 16</span><br><span class="line">serverSlots1 = 32</span><br></pre></td></tr></table></figure><p>重新启动polipo服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/polipo restart</span><br></pre></td></tr></table></figure><h4 id="使用代理">使用代理<a href="http://keliu.me/2018/12/08/ss/#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86"></a></h4><p>polipo的默认端口号是 8123，<strong>每次使用</strong>代理前，<strong>必须</strong>进行如下操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=http://127.0.0.1:8123</span><br></pre></td></tr></table></figure><p>然后可以验证是否成功：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl www.google.com</span><br></pre></td></tr></table></figure><p><strong>取消代理</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset http_proxy</span><br></pre></td></tr></table></figure><p>如果想<strong>持久化</strong>运行，可以将<code> export http_proxy=http://127.0.0.1:8123</code>这个语句添加到<code> ~/.bashrc</code>文件内，并用<code>source ~/.bashrc</code>命令使之生效。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
            <tag> shadowsocks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>联想y7000安装ubuntu18.04显卡驱动解决方案</title>
      <link href="/blogs/2019/09/29/6edea707.html/"/>
      <url>/blogs/2019/09/29/6edea707.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Desktop3.png"  alt="Desktop"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Desktop2.png"  alt="Desktop"><br><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Desktop.png"  alt="Desktop"></p><h3 id="目录">目录</h3><ol><li><p>笔记本配置和操作系统版本</p></li><li><p>安装Ubuntu18.04-3后出现的异常</p></li><li><p>解决方案</p></li></ol><h3 id="笔记本配置">笔记本配置</h3><ul><li><p>CPU : Intel® Core™ i5-8300H CPU @ 2.30GHz × 8</p></li><li><p>GPU: Nvidia GeForce GTX 1050 Ti/PCIe/SSE2 和 Intel 集显</p></li><li><p>操作系统: Ubuntu 18.04.3 bionic</p></li><li><p>内核版本: Linux 5.0.0-27-generic</p></li><li><p>内存: 16G</p></li><li><p>分区:  GPT磁盘分区 + UEFI引导方案 ，创建<code>efi</code>系统分区和<code>/</code>根分区</p></li></ul><h3 id="安装Ubuntu18-04-3后出现的异常">安装Ubuntu18.04-3后出现的异常</h3><ul><li><p>开机卡死或登录卡死</p></li><li><p>登录后不能检测到无线网卡</p></li><li><p>屏幕亮度不可调节</p></li><li><p>HDMI外接屏幕不可用</p></li></ul><h3 id="解决方案">解决方案</h3><p>卡死的原因基本都是显卡驱动的原因，集成显卡勉强能用，但是不支持外接屏幕和亮度调节，屏幕滚动的时候也会<br>出现画面撕裂的情况，属于不能忍受的情况，当开机卡死的时候我们需要先强制让Ubuntu使用集成显卡，然后才能<br>进入系统，进入系统之后再禁用系统自带的Nvidia驱动，然后安装新的推荐使用的驱动即可，具体操作流程如下：</p><h4 id="1-强制使用集显">1.  强制使用集显</h4><p>在开机grub界面，按e，编辑启动 选项<br>修改参数<code>“quiet splash”</code>为<code>“quiet splash nomodeset”</code>，之后F10，重新启动正常进入Ubuntu系统<br>进入系统后让这个设置一直有效的方法是：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo gedit /etc/default/grub</span><br></pre></td></tr></table></figure><p>跟开机时一样的参数修改，完成后保存文件并关闭，输入以下指令使其生效：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo update-grub</span><br></pre></td></tr></table></figure><h4 id="2-重新安装Nvidia显卡驱动">2. 重新安装Nvidia显卡驱动</h4><p>禁用ubuntu默认显卡(集显)驱动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo vi /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><p>在文件最末尾添加如下参数加入黑名单：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blacklist vga16fb</span><br><span class="line">blacklist nouveau</span><br><span class="line">blacklist rivafb</span><br><span class="line">blacklist rivatv</span><br><span class="line">blacklist nvidiafb</span><br></pre></td></tr></table></figure><p>卸载干净所有安装过的nvidia驱动：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt-get remove  --purge nvidia-*</span><br></pre></td></tr></table></figure><p>查看驱动状态，无输出则说明已经被屏蔽掉</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: lsmod | grep nouveau</span><br></pre></td></tr></table></figure><p>添加驱动源：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo add-apt-repository ppa:graphics-drivers/ppa</span><br><span class="line">$: sudo apt-get update</span><br></pre></td></tr></table></figure><p>查看合适驱动版本：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu-drivers devices</span><br></pre></td></tr></table></figure><p>这里推荐直接使用<code>nvidia-driver-390</code>或<code>nvidia-driver-430</code>驱动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt-get install nvidia-driver-430 nvidia-settings nvidia-prime</span><br></pre></td></tr></table></figure><p>重启</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo update-initramfs -u</span><br><span class="line">$: sudo reboot</span><br></pre></td></tr></table></figure><p>重启时，在开机grub界面，按e，编辑启动 选项<br>修改参数<code>“quiet splash nomodeset”</code>为<code>“quiet splash acpi_osi=linux”</code>，之后F10，重新启动正常进入Ubuntu系统</p><p>开机后查看驱动安装状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo nvidia-smi</span><br></pre></td></tr></table></figure><p>编辑grab文件执行上一步相同的参数修改，最后更新：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo gedit /etc/default/grub</span><br><span class="line">$: sudo update-grub</span><br></pre></td></tr></table></figure><h4 id="3-解决无线网络不能使用的问题">3. 解决无线网络不能使用的问题</h4><p>原因： 联想自家的驱动和Ubuntu的驱动产生了冲突，禁用联想自带的驱动即可</p><p>将联想驱动加入黑名单:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo gedit /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><p>在文件中添加：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist ideapad_laptop</span><br></pre></td></tr></table></figure><p>即时生效：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo modprobe -r ideapad_laptop</span><br></pre></td></tr></table></figure><p><em>关于Ubuntu主题美化和其它问题解决请移步：<a href="https://www.jianshu.com/p/23b0d3015db8">Ubuntu 18.04 踩坑记录</a></em></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu18.04 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu18踩坑记录</title>
      <link href="/blogs/2019/06/12/81770652.html/"/>
      <url>/blogs/2019/06/12/81770652.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-1.jpg"  alt="welcome / home"></p><h4 id="目录">目录</h4><hr><ul><li>Wine应用启动后出现WineSystemTray 托盘的问题</li><li>中文环境下将Home目录下的文件夹切换为英文名</li><li>Ubuntu系发行版安装deepin wine QQ</li><li>续：安装QQ/微信</li><li>Ubuntu 18.04开机启动特别慢的问题</li><li>终端oh-my-zsh配置</li><li>禁用内核更新</li><li>终端常用等宽字体</li><li>crossover18破解</li><li>vim插件配置</li><li>Ubuntu18.04 定制Mac主题</li><li>Ubuntu18.04 自己定制 登录、锁屏界面的图片和样式</li><li>Ubuntu18.04 关于定制plymouth主题来更换开机动画</li><li>Ubuntu18.04 使用[Dash to dock]插件时同时出现两个dock的问题</li><li>Ubuntu18.04 添加软件源提示：没有Release文件，忽略源的问题</li><li>Ubuntu18.04 解决一些软件依赖不满足问题的问题</li><li>Ubuntu18.04 安装cinnamon桌面启动器</li><li>Linux分区过小导致后期容量不足解决方法</li><li>Shadowsocks-Qt5安装的问题</li><li>使用polipo开启终端代理(需要先开启shadowsocks代理)</li><li>将linux绿色解压版软件包或自定义脚本显示到应用菜单图标列表</li><li>自定义shadowsocks服务开机自启动脚本</li><li>Ubuntu20.04 使用 Whistle 代理浏览器请求时不支持 https 请求</li><li>Ubuntu18.04 设置shadowsocks全局pac自动代理对浏览器无效</li><li>购买 Crossover 下载安装后，使用注册码激活失败问题</li><li>Atom编辑器内存占用过大的问题</li><li>Grub2 主题安装</li><li>Ubuntu18.04 解决下载额外数据文件失败：ttf-mscorefonts-installer</li><li>Ubuntu18.04 WPS 提示字体缺失的解决方法</li><li>Ubuntu20.04 安装最新版微信开发者工具</li><li>Ubuntu20.04 使用deepin-screenshot截图后无法粘贴到输入框</li><li>Ubuntu18.04 更新Gnome版本</li><li>Win10 + Ubuntu18.04 双系统时间显示不对</li><li>Ubuntu18.04 安装系统时说明(双硬盘)</li><li>Ubuntu18.04 安装网易云音乐1.1.0后不能打开的解决方法</li><li>Ubuntu18.04 Crossover17安装QQ后乱码的解决方法</li><li>Ubuntu18.04 通过tweak安装gnome插件Blyr后设置插件报错</li><li>Ubuntu18.04 一直提示 “检测到系统程序出现问题”</li><li>Ubuntu20.04 使用系统播放器打开视频提示“安装h.264编码软件”</li><li>Ubuntu18.04 Gnome-Shell 插件</li><li>Ubuntu18.04 插件 [ Dash to dock ] 一些常用设置</li><li>Ubuntu18.04 主题</li><li>chrome实用插件整理</li><li>实用程序和命令</li><li>实用网站推荐</li></ul><h4 id="Wine应用启动后出现WineSystemTray托盘的问题">Wine应用启动后出现WineSystemTray托盘的问题</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-2.png"  alt="wine_tray.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-3.png"  alt="tray.png"></p><ol><li><p>操作系统Linux Mint18.3<br>右键点击面板(状态栏)，选择 - 向面板添加小程序，选择小程序 - 系统托盘，点击+号添加，之后Wine安装的应用和其它应用的图标就被系统托盘管理了。</p></li><li><p>操作系统Ubuntu 18.04<br>安装gnome-shell插件 <a href="https://extensions.gnome.org/extension/495/topicons/">TopIcons</a>, 要想从浏览器上安装这个TopIcons需要先安装浏览器gnome交互插件chrome-gnome-shell (<code>sudo apt install chrome-gnome-shell</code> )，使用deepin QQ的时候可能需要重新启动TopIcons才能显示顶部QQ图标，如果遇到图标无故隐藏的问题那么可以再安装插件<a href="https://extensions.gnome.org/extension/1160/dash-to-panel/">Dash to Panel</a>解决。</p></li></ol><h4 id="中文环境下将Home目录下的文件夹切换为英文名">中文环境下将Home目录下的文件夹切换为英文名</h4><hr><ol><li>设置英文语言环境</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: <span class="built_in">export</span> LANG=en_US(恢复-&gt; zh_CN)</span><br></pre></td></tr></table></figure><ol start="2"><li>更新目录</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: xdg-user-dirs-gtk-update</span><br></pre></td></tr></table></figure><ol start="3"><li>弹出提示框点击 [确认]</li><li>重启后会再次弹出提示框是否将英文文件夹改回中文，选择 [不再提示] 并 [取消] 修改</li></ol><h4 id="Ubuntu系发行版安装deepin-wine-QQ">Ubuntu系发行版安装deepin wine QQ</h4><hr><ol><li><p>安装deepin-wine环境：上<a href="https://gitee.com/wszqkzqk/deepin-wine-for-ubuntu">https://gitee.com/wszqkzqk/deepin-wine-for-ubuntu</a>页面下载zip包（或用git方式克隆），也可以<a href="https://pan.baidu.com/s/120C5aHuqtyxQyn_fGTxHKg">百度网盘</a>下载，解压到本地文件夹，在文件夹中打开终端，输入<code>sudo sh ./install.sh</code>一键安装，如果你安装了这些依赖，在第二步的时候仍然报依赖错误，那就手动解压deb包，把那些依赖声明删除就行了(解压deb的方法下文中有提到)。</p></li><li><p>安装deepin.com应用容器：在<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/">http://mirrors.aliyun.com/deepin/pool/non-free/d/</a>中下载想要的容器，点击deb安装即可，以下为推荐容器:</p></li></ol><ul><li>QQ：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.im/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.im/</a></li><li>TIM：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.office/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.office/</a></li><li>QQ轻聊版：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.im.light/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.qq.im.light/</a></li><li>微信：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.wechat/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.wechat/</a></li><li>Foxmail：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.foxmail/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.foxmail/</a></li><li>百度网盘：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.baidu.pan/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.com.baidu.pan/</a></li><li>360压缩：<a href="http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.cn.360.yasuo/">http://mirrors.aliyun.com/deepin/pool/non-free/d/deepin.cn.360.yasuo/</a></li><li>迅雷急速版:  <a href="https://pan.baidu.com/s/1cij1FhFeEn2sXdPtkJ3lSg">https://pan.baidu.com/s/1cij1FhFeEn2sXdPtkJ3lSg</a></li><li>Ubuntu系发行版包括Ubuntu、LinuxMint、ZorinOS等。</li></ul><h4 id="续：安装QQ-微信">续：安装QQ/微信</h4><hr><p>1.linux上的微信大部分都是网页版微信封装的: <a href="https://github.com/geeeeeeeeek/electronic-wechat">electronic-wechat</a>、<a href="https://github.com/trazyn/weweChat">weweChat</a>，网页版功能简单，每次登录都要扫码。而且现在腾讯好像开始禁用了微信网页版的登陆，如果发现不能登录网页版就只能使用crossover来安装windows版的微信。</p><p>2.￥140可以买个CrossOver18正版，一次激活，永久使用，然后愉快地安装QQ8.9，喜欢TIM的也能用TIM， 不过目前这个基于crossover的QQ有些bug，也不能记住密码。使用crossover18安装微信，安装包直接下载windows版本的就行，然后使用crossover创建windowsXP 64位容器，在容器中安装微信即可，不过可能安装时会出现<code>&quot;WeChatWin.dll 缺失问题&quot;</code>报错信息，需要执行下面命令安装额外的环境：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: apt-get install libldap-2.4-2:i386</span><br></pre></td></tr></table></figure><p>3.使用docker安装<a href="https://hub.docker.com/r/bestwu/qq">Tim</a> 和 <a href="https://hub.docker.com/r/bestwu/wechat">wechat</a>，<a href="https://www.runoob.com/docker/ubuntu-docker-install.html">docker环境安装教程</a></p><p>4.wine环境下(crossover/deepin)安装好微信后如果发现不能输入文字(其实可以输入和发送，只是文字透明的)，可以使用这个文件<a href="https://pan.baidu.com/s/1-ScZvkmR9oZPdiFurdKQdA">riched20.dll</a>(提取密码：rofj)替换掉微信所在容器下的C盘的<code>/windows/system32/riched20.dll</code>，容器路径一般在：<code>~/.cxoffice/[你的容器名]/drive_c/</code>。</p><p>5.wine环境下(crossover/deepin)如果运行微信时发现界面有一个黑框不能关闭，只需要在聊天输入框中键入中文“不”然后再删除即可让黑框消失(原因:微信会根据你输入的字作为关键字在你现有表情中找符合的表情并显示出来提示你可用,但并没有很好的兼容这个功能变成一个黑框了，所以手动消除黑框的办法只有打关键字然后删除)。</p><p>6.wine环境下(crossover/deepin)如果运行微信的时候不能发送图片，尝试安装 <code>sudo apt install libjpeg62:i386</code>，临时解决办法是把图片文件拖动到<code>收藏</code>，然后从收藏转发即可。</p><p>7.wine环境下(crossover/deepin)如果运行QQ发现收到的图片一直加载不出来(刚登录开始可以，过一会就不行了)，那么可以在QQ登录界面设置一下网络代理(http/socks)，注意本地代理情况下代理地址不能使用localhost/127.0.0.1此类的IP，使用0.0.0.0是可以的。</p><p>8.wine环境下如果发现微信/企业微信窗口边缘有阴影穿透情况时，点击任意一个联系人聊天界面，将窗口最大化后再恢复正常状态，窗口异常边框阴影便会消失。</p><h4 id="Ubuntu-18-04开机启动特别慢的问题">Ubuntu 18.04开机启动特别慢的问题</h4><hr><p>=&gt; 禁用不必要的开机服务：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出程序开机占用时间排行</span></span><br><span class="line">systemd-analyze blame</span><br><span class="line"><span class="comment"># 禁用plymouth</span></span><br><span class="line">sudo systemctl mask plymouth-start.service</span><br><span class="line">sudo systemctl mask plymouth-read-write.service</span><br></pre></td></tr></table></figure><h4 id="终端oh-my-zsh配置">终端oh-my-zsh配置</h4><hr><ol><li>主题</li></ol><ul><li>gnzh(已使用))</li><li>ys</li><li>avit</li><li>af-magic</li></ul><ol start="2"><li>插件</li></ol><ul><li>git =&gt; 自带git状态插件</li><li>svn =&gt; svn状态插件</li><li>colored-man-pages =&gt; man帮助信息高亮</li><li>zsh-syntax-highlighting =&gt; 命令高亮和错误提示</li><li>z =&gt; 自动记录路径快捷跳转</li><li>zsh-autosuggestions =&gt; 根据输入记录自动建议可选输入命令</li></ul><h4 id="禁用内核更新">禁用内核更新</h4><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看已安装内核</span></span><br><span class="line">$: dpkg --get-selections |grep linux-image</span><br><span class="line"><span class="comment"># 查看正在使用的内核</span></span><br><span class="line">$: uname -a</span><br><span class="line"><span class="comment"># 删除旧内核</span></span><br><span class="line">$: sudo apt-get remove</span><br><span class="line">$: linux-image-x.xx.x-xx-generic</span><br><span class="line">$: sudo apt-get remove  </span><br><span class="line">$: linux-image-extra-x.xx.x-xx-generic  </span><br><span class="line"><span class="comment"># 或用这个命令移除</span></span><br><span class="line">$: sudo dpkg --purge linux-image-x.x.x-xx-generic</span><br><span class="line"><span class="comment"># 禁止更新内核，需时间来验证</span></span><br><span class="line">$: sudo apt-mark hold linux-image-x.xx.x-xx-generic</span><br><span class="line">$: sudo apt-mark hold linux-image-extra-x.xx.x-xx-generic</span><br><span class="line"><span class="comment"># 如果需要恢复原来的设定的话即允许更新内核，执行如下命令即可：</span></span><br><span class="line">$: sudo apt-mark unhold linux-image-x.xx.x-xx-generic</span><br><span class="line">$: sudo apt-mark unhold linux-image-extra-x.xx.x-xx-generic</span><br></pre></td></tr></table></figure><h4 id="终端常用等宽字体">终端常用等宽字体</h4><hr><ul><li>AR PL UKai CN 12</li><li>Bitstream Vera Sans Mono 10</li><li>Courier 10 Pitch 11</li><li>DejaVu Sans Mono 10</li><li>FreeMono 11</li><li>Nimbus Mono L 12</li><li>TlwgMono 11</li></ul><h4 id="crossover18破解">crossover18破解</h4><hr><p>下载 <a href="https://pan.baidu.com/s/1BnT-cAKf-SBp-6J4CQoo-g">CrossoverPatch</a> <code>密码: ffp0</code>，解压后替换文件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  备份原文件</span></span><br><span class="line">$: cp ~/cxoffice/lib/wine/winewrapper.exe.so ~/cxoffice/lib/wine/winewrapper.exe.so-bak</span><br><span class="line"><span class="comment"># 替换文件</span></span><br><span class="line">$: cp CrossoverPatch/winewrapper.exe.so ~/cxoffice/lib/wine</span><br></pre></td></tr></table></figure><h4 id="vim插件配置">vim插件配置</h4><hr><ol><li><a href="https://github.com/VundleVim/Vundle.vim">Vundle</a> =&gt; 插件管理器，编辑.vimrc，然后执行命令<code>vim +PluginInstall</code>即可安装</li><li><a href="https://github.com/vim-airline/vim-airline">vim-airline</a> =&gt; 底部状态栏</li><li><a href="https://juejin.im/post/5a38c37f6fb9a0450909a151">其他配置</a></li></ol><h4 id="Ubuntu18-04-定制Mac主题">Ubuntu18.04 定制Mac主题</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-5.png"  alt="overview.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-6.png"  alt="desktop.png"></p><ol><li>安装gnome-tweak-tool 和 chrome-gnome-shell 插件 (<code>sudo aptitude install [name]</code>)</li><li>安装GTK3主题 =&gt; <a href="https://www.gnome-look.org/p/1167049/">X-Arc-Collection</a></li><li>使用tweak载入应用程序主题 =&gt; tweak – 外观 – 应用程序 – 选择X-Arc-Collection</li><li>安装gnome-shell 主题 =&gt; <a href="https://www.gnome-look.org/p/1167049/">macOS High Sierra</a></li><li>安装gnome-shell 插件 =&gt; <a href="https://extensions.gnome.org/extension/19/user-themes/">User Themes</a> ( 之后重启Gnome =&gt; [Alt + F2] &amp; [输入 r] &amp; [点击 Enter] )</li><li>使用tweak载入shell主题 =&gt; tweak – 外观 – shell – 选择Sierra shell主题</li><li>下载Mac图标主题 <a href="https://github.com/keeferrourke/la-capitaine-icon-theme/releases">la-capitaine-icon-theme</a> 或 <a href="https://www.pling.com/p/1305429/">McMojave-circle</a></li><li>图标文件夹移动到 ~/.icons目录下(没有则新建目录)</li><li>使用tweak载入icon主题 =&gt; tweak – 外观 – 图标 – 选择对应的图标主题</li><li>安装gnome-shell插件 =&gt; Dash to dock (将原生dock转变为可定制的浮动dock)</li><li>定制firefox主题 =&gt; <a href="https://github.com/vinceliuice/Mojave-gtk-theme">Majave-gtk-theme</a></li></ol><h4 id="Ubuntu18-04-自己定制-登录、锁屏界面的图片和样式">Ubuntu18.04 自己定制 登录、锁屏界面的图片和样式</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-7.png"  alt="lockscreen.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-8.png"  alt="loginscreen.png"></p><ol><li>安装脚本 =&gt; <a href="https://github.com/nojsja/maintenance/tree/master/code/shell/desktop/login-manager-config-ubuntu">github / nojsja / login-manager-config-ubuntu</a></li><li>说明=&gt; 脚本通过更改/usr/share/gnome-shell/theme/ubuntu.css文件中声明的样式来修改系统登录页面按钮布局和背景图片的地址，使用ImageMagick包的<code>convert -blur</code>命令制作了毛玻璃效果的登录背景图片，最后还生成了一个SetAsWallpaper脚本，可以在文件夹中的图片文件上右键点击选择运行这个脚本(它会自动把目标图片更改成桌面壁纸和毛玻璃效果化的登录背景图)，最后锁屏壁纸需要用户手动安装<code>gnome-tweak-tool</code>进行更改。</li><li>之前我想通过更改<code>/usr/share/gnome-shell/theme/gdm3.css</code>文件来修改样式，可是发现ubuntu18.04下总会有这样那样的问题。</li><li>注意=&gt; 不要贸然尝试更改系统主题的CSS样式文件，如果修改的文件有语法错误或是其它原因，很可能会造成系统开机后无法登入图形界面(出现这种情况可以插入U盘登录PE系统然后挂载原系统的硬盘，最后将错误文件改回即可)。</li></ol><h4 id="Ubuntu18-04-关于定制plymouth主题来更换开机动画">Ubuntu18.04 关于定制plymouth主题来更换开机动画</h4><hr><blockquote><p>其实我不建议去改开机动画，一个原因是ubuntu自己的开机动画就挺美观简洁的，第二个原因是这个东西如果改出问题了卡在开机画面到时候恢复起来比较麻烦，如果执意想去折腾的话，可以去<a href="https://www.gnome-look.org/browse/cat/108/">gnome-look</a>看看，这里提供一个苹果主题<a href="https://pan.baidu.com/s/1qv3GZ_BE-jj2HIpiI2X7yQ">darwin</a>，密码: <code>rc6u</code>。</p></blockquote><ol><li><p>解压下载的plymouth主题到 <code>/usr/share/plymouth/themes</code></p></li><li><p>执行安装</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo update-alternatives --install /usr/share/plymouth/themes/ default.plymouth default.plymouth /usr/share/plymouth/themes/[THEME]/[THEME].plymouth 100</span><br></pre></td></tr></table></figure><ol start="3"><li>更新配置，需要手动选择plymouth编号</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo update-alternatives --config default.plymouth</span><br><span class="line">$: sudo update-initramfs -u</span><br></pre></td></tr></table></figure><ol start="4"><li>手动更改错误路径参数</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo gedit /usr/share/plymouth/themes/default.plymouth</span><br></pre></td></tr></table></figure><p>替换<code>ImageDir</code>和<code>ScriptFile</code>为正确的plymouth文件存放路径，替换后：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ImageDir=/usr/share/plymouth/themes/[THEME]</span><br><span class="line">ScriptFile=/usr/share/plymouth/themes/[THEME]/[THEME].script</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-使用-Dash-to-dock-插件时同时出现两个dock的问题">Ubuntu18.04 使用[Dash to dock]插件时同时出现两个dock的问题</h4><hr><blockquote><p>解决方法是去tweak设置里关闭[Dash to dock]的开关，别担心，关闭后，[Dash to dock]仍然正常工作，但是再也不会同时出现两个dock栏的尴尬情况了。</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-9.png"  alt="dock-noise.png"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-10.png"  alt="dock-single.png"></p><h4 id="Ubuntu18-04-添加软件源提示：没有Release文件，忽略源的问题">Ubuntu18.04 添加软件源提示：没有Release文件，忽略源的问题</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-11.png"  alt="dock-tweak.png"></p><ol><li>打开 软件与更新</li><li>选择那个源点击编辑</li><li>更改 发行版 信息 (请在网页上查看这个源的仓库文件内的dists目录下有哪些发行版)</li></ol><h4 id="Ubuntu18-04-解决一些软件依赖不满足问题的问题">Ubuntu18.04 解决一些软件依赖不满足问题的问题</h4><hr><p>=&gt; 以Ubuntu18.04安装16.04版本网易云音乐为例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># gdebi安装包</span><br><span class="line">$: sudo gdebi netease-cloud-music_1.0.0_amd64_ubuntu16.04.deb</span><br><span class="line">$: Dependency is not satisfiable: libqt5libqgtk2</span><br><span class="line"># Ubuntu18.04报出依赖问题，原因是libqt5libqgtk2已经被新的库qt5-style-plugins替代，</span><br><span class="line"># 软件源里找不到这个库，当然我们也能手动安装libqt5libqgtk2，但是很可能会就此引出新的依赖问题</span><br></pre></td></tr></table></figure><p>=&gt; 方法：解压安装包修改依赖项并重新打包<br>=&gt; 步骤：</p><ol><li>deb包同级目录下创建文件夹</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: mkdir netease-cloud-music</span><br></pre></td></tr></table></figure><ol start="2"><li>解压安装包到这个文件夹中</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: dpkg -X netease-cloud-music_1.0.0_amd64_ubuntu16.04.deb netease-cloud-music</span><br></pre></td></tr></table></figure><ol start="3"><li>解压控制信息</li></ol> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: dpkg -e netease-cloud-music_1.0.0_amd64_ubuntu16.04.deb neteas-cloud-music/DEBIAN/</span><br></pre></td></tr></table></figure><ol start="4"><li>修改依赖文件(把libqt5libqgtk2修改为qt5-style-plugins)</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vim编辑文件</span><br><span class="line">$: vim neteas-cloud-music/DEBIAN/control</span><br><span class="line"># 使用vim正则对libqt5libqgtk2进行搜索替换</span><br><span class="line">:1,$s/libqt5libqgtk2/qt5-style-plugins/g</span><br><span class="line"># 或是手动查找Depends那一行中声明的libqt5libqgtk2进行替换替换即可</span><br></pre></td></tr></table></figure><ol start="5"><li>生成新的安装包</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: dpkg-deb -b neteas-cloud-music</span><br><span class="line">$: mv neteas-cloud-music.deb netease-cloud-music_1.0.0_amd64_ubuntu18.04.deb</span><br></pre></td></tr></table></figure><ol start="6"><li>安装</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 使用gdebi或dpkg进行安装即可</span><br><span class="line">$: sudo gdebi netease-cloud-music_1.0.0_amd64_ubuntu18.04.deb</span><br><span class="line">$: sudo dpkg -i netease-cloud-music_1.0.0_amd64_ubuntu18.04.deb</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-安装Cinnamon桌面启动器">Ubuntu18.04 安装Cinnamon桌面启动器</h4><hr><blockquote><p>cinnamon桌面也是基于gtk的，所以gonome下的一些gtk主题和icon主题也能直接使用，切换桌面后可以在设置界面直接切换主题。deepin桌面也能安装，美观度很好，但是卡死问题比较严重，不太推荐，Cinnamon相较而言安装后bug较少，可以正常使用。</p></blockquote><p>已知问题：</p><ul><li>Cinnamon桌面通知API可能有更改，常见的wine/crossover应用程序不能正常调用通知接口，QQ/Wehcat无法在通知栏提示消息，不太方便</li><li>输入法ibus不支持，无法正常使用，可以使用fcitx拼音和基于fcitx框架的sogou拼音</li><li>默认没有集成蓝牙管理器，需要安装<code>blueman</code>进行蓝牙管理</li><li>锁屏界面可能会非常卡顿</li><li>Cinnamon面板(等同gnome任务栏)默认安装了<code>系统托盘</code>，可以解决wine应用程序托盘菜单变成小窗口的bug，在面板通知区域正常显示</li><li>Cinnamon桌面动画性能也很低效，建议强制使用独立显卡</li></ul><p>安装步骤：</p><ol><li>添加仓库Key</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo add-apt-repository ppa:embrosyn/cinnamon  </span><br><span class="line">$: sudo apt update &amp;&amp; sudo apt install cinnamon</span><br></pre></td></tr></table></figure><ol start="2"><li>安装完成了注销后可以在登录界面点击设置按钮选择进入某个桌面环境</li><li>卸载cinnamon</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt-get install ppa-purge</span><br><span class="line">$: sudo ppa-purge ppa:embrosyn/cinnamon</span><br></pre></td></tr></table></figure><h4 id="Linux分区过小导致后期容量不足解决方法">Linux分区过小导致后期容量不足解决方法</h4><hr><p>=&gt; 之前安装ubuntu 18.04的时候/var 分区只给了 1.5G，结果现在不够用了</p><ul><li>方法1</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt-get clean</span><br><span class="line">$: sudo apt-get autoremove</span><br></pre></td></tr></table></figure><p>如果仍然空间不足，使用方法2。</p><ul><li>方法2<br>建立目录软链接解决(软链接和硬链接了解一下)：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以/var目录为例 将占用过大的文件夹移出</span></span><br><span class="line">$: mv /var/lib /opt</span><br><span class="line"><span class="comment"># 建立opt下的lib内目录的软链接到var目录</span></span><br><span class="line">$: sudo ln -s /opt/lib /var</span><br></pre></td></tr></table></figure><ul><li>方法3<br>如果/var没有单独分区，则系统默认共享使用/home目录，若此时提示/var空间不足，则说明/home空间不足，这种情况，建议重新安装系统，重新规划分区结构。一般来说，/var目录2G-4G为好，或者不分区，共享/home。</li></ul><h4 id="Shadowsocks-Qt5安装的问题">Shadowsocks-Qt5安装的问题</h4><hr><blockquote><p>shadowsocks的GUI版本，用Qt写的，还行，不过我喜欢用sslocal命令脚本来连接服务器，开机自启动，很方便。顺带写个安装流程，不过会遇到我上面提到的 <strong>软件源提示没有Release文件的问题</strong>，可以通过上面的方法解决，这里需要将shadowdocks-Qt5发行版信息更改为<code>artful</code>，改为其它发行版可能会遇到依赖问题，遇到依赖问题多尝试几个，还有两行配置文件都要改额。</p></blockquote><p>&gt; sudo add-apt-repository ppa:hzwhuang/ss-qt5<br>&gt; sudo apt update<br>&gt; sudo apt-get install shadowsocks-qt5</p><h4 id="使用polipo开启终端代理-需要先开启shadowsocks代理">使用polipo开启终端代理(需要先开启shadowsocks代理)</h4><hr><ul><li>安装脚本(适合于bash和zsh终端) =&gt; <a href="https://github.com/nojsja/maintenance/tree/master/code/shell/desktop/shadowsocks-terminal">github / nojsja / polipo-install-config.sh&quot;</a></li><li>使用方式<br>&gt; 说明：’ hp ’ == ’ http_proxy=http://localhost:8123 ’ for any command<br>&gt; 说明：’ gp ’ == ‘http.proxy=localhost:8123’ for git proxy config<br>&gt; 使用1：<code>hp curl ip.gs</code><br>&gt; 使用2：<code>git clone https://android.googlesource.com/tools/repo --config $gp</code></li><li>如果polipo启动报错的话(通过<code>systemctl status polipo</code>查看)，可能是你的垃圾清理软件删除了polipo的日志文件夹，你可以手动更改polipo配置文件(<code>/etc/polipo/config</code>)禁用日至记录功能</li></ul><h4 id="将linux绿色解压版软件包或自定义脚本显示到应用菜单图标列表">将linux绿色解压版软件包或自定义脚本显示到应用菜单图标列表</h4><hr><blockquote><p>很多软件只有解压版，虽然可以解压后发送快捷方式到桌面，但是没有图标，应用列表也看不了。</p></blockquote><p>=&gt; 安装脚本(测试环境ubuntu18.04) =&gt; <a href="https://github.com/nojsja/maintenance/tree/master/code/shell/desktop/application">github / nojsja / makeIconLink</a><br>=&gt; 使用方式</p><ul><li>安装之前：请先将需要作为图标的icon图片(比例1:1比较适合，分辨率最好大于64px % 64px)放入目标文件夹内</li><li>查看说明：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: bash makeIconLink --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><ul><li>安装指令：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: bash makeIconLink --dir /path/to/[exec-file] --target [exec-file-name] --icon [icon-file-name]</span><br></pre></td></tr></table></figure><ul><li>卸载指令：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: bash makeIconLink --uninstall [exec-file-name]</span><br></pre></td></tr></table></figure><h4 id="自定义shadowsocks服务开机自启动脚本">自定义shadowsocks服务开机自启动脚本</h4><hr><blockquote><p>使用systemd来管理shadowsocks服务，开机自启动，不用打开shadowsocks-qt5软件，FQ了无痕 ~</p></blockquote><p>=&gt; 我的服务脚本：<a href="https://github.com/nojsja/maintenance/blob/master/code/shell/desktop/startup.sh">startup.sh</a>、<a href="https://github.com/nojsja/maintenance/blob/master/code/shell/desktop/shadowsocks">shadowsocks</a><br>=&gt; 步骤：</p><ul><li>编写shadowsocks service脚本文件，比如shadow.service</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="comment"># 描述</span></span><br><span class="line">Description=Shadowsocks Service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line"><span class="comment"># 服务 start/stop 执行脚本(具体执行路径根据自己的目录更改)</span></span><br><span class="line">ExecStart=/bin/bash /home/nojsja/github/maintenance/code/shell/desktop/startup.sh start</span><br><span class="line">ExecStop=/bin/bash /home/nojsja/github/maintenance/code/shell/desktop/startup.sh stop</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># 一些简单的依赖信息</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>将服务配置文件放到<code>/etc/systemd/system</code>下<br>&gt; sudo cp shadow.service /etc/systemd/system</li><li>设置服务自启动<br>&gt; systemctl enable shadow</li><li>服务开启和关闭<br>&gt; systemctl start shadow<br>&gt; systemctl stop shadow</li></ul><h4 id="Ubuntu20-04-使用-Whistle-代理浏览器请求时不支持-https-请求">Ubuntu20.04 使用 Whistle 代理浏览器请求时不支持 https 请求</h4><ol><li>进入本地 whistle 配置页面: <a href="http://127.0.0.1:8899/#network">链接</a>，点击 <code>https</code>，在弹窗中勾选 <code>Capture TUNNEL CONNECTs</code>，然后点击 <code>Download RootCA</code> 下载证书。</li><li>将证书复制到系统目录，然后更新证书配置：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo cp rootCA.crt /usr/<span class="built_in">local</span>/share/ca-certificates/</span><br><span class="line">$: sudo update-ca-certificates</span><br></pre></td></tr></table></figure><ol start="3"><li>在需要使用 whistle 插件的浏览器中导入证书，以 chrome 为例：进入<code>设置-安全检查-安全-管理证书-授权机构</code>，最后点击按钮导入刚才下载的证书即可。</li></ol><h4 id="Ubuntu18-04设置shadowsocks全局pac自动代理对浏览器无效">Ubuntu18.04设置shadowsocks全局pac自动代理对浏览器无效</h4><hr><p>=&gt; 先来一个shadowsocks全局pac代理的步骤：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip需要先安装</span></span><br><span class="line">$: sudo apt-get install python-pip python-dev build-essential</span><br><span class="line">$: sudo pip install --upgrade pip</span><br><span class="line">$: sudo pip install --upgrade virtualenv</span><br><span class="line"><span class="comment"># 安装pac自动生成程序</span></span><br><span class="line">$: sudo pip install genpac</span><br><span class="line"><span class="comment"># 生成pac文件</span></span><br><span class="line">$: mkdir ~/shadowsocks</span><br><span class="line">$: <span class="built_in">cd</span> shadowsocks</span><br><span class="line"><span class="comment"># proxy配置中的地址和端口具体要看你的shadowsocks连接配置</span></span><br><span class="line">$: genpac --proxy=<span class="string">&quot;SOCKS5 127.0.0.1:1080&quot;</span> --gfwlist-proxy=<span class="string">&quot;SOCKS5 127.0.0.1:1080&quot;</span> -o autoproxy.pac --gfwlist-url=<span class="string">&quot;https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt&quot;</span></span><br></pre></td></tr></table></figure><p>以上操作会在~/shadowsocks目录下生成autoproxy.pac配置文件，到系统设置 -&gt; 网络 -&gt; 网络代理 -&gt; 自动 -&gt; 填入file:///path/to/autoproxy.pac(上面我们生成的pac文件路径)，如果要新增被代理网站的话就自己编辑pac文件，在里面的域名列表里面再添加新的域名就好了。<br>=&gt; 再写一个脚本<a href="https://github.com/nojsja/maintenance/tree/master/code/shell/desktop/shadowsocks/genpac">genpac-command</a>，可以用来添加用户过滤规则(user-rules.txt) 和在线更新autoproxy.pac代理文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># # 在脚本目录下执行</span></span><br><span class="line"><span class="comment"># 显示帮助信息</span></span><br><span class="line">$: bash genpac-command --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># 在线更新</span></span><br><span class="line">$: bash genpac-command --update-online</span><br><span class="line"><span class="comment"># 从本地user-rules.txt文件读取更新</span></span><br><span class="line">$: bash genpac-command --update-local</span><br><span class="line"><span class="comment"># 添加自定义规则</span></span><br><span class="line">$: bash genpac-command --add-rules opendesktop.org</span><br><span class="line"><span class="comment"># 添加多个自定义规则</span></span><br><span class="line">$: bash genpac-command --add-rules opendesktop.org atom.io</span><br><span class="line"><span class="comment"># 删除自定义规则</span></span><br><span class="line">$: bash genpac-command --del-rules opendesktop.org</span><br><span class="line"><span class="comment"># 删除多个自定义规则</span></span><br><span class="line">$: bash genpac-command --del-rules opendesktop.org atom.io</span><br></pre></td></tr></table></figure><p>=&gt; <strong>不过我遇到了代理pac文件配置好后，firefox和google浏览器仍然不能FQ的情况，仔细排查原因，我发现因为之前我不是用的pac全局代理，是通过浏览器的SwitchOmega插件来手动代理的，这个插件会接管浏览器的网络代理权限，我们需要到浏览器设置里面把网络代理设置为系统代理，以火狐浏览器为例：</strong></p><h4 id="购买-Crossover-下载安装后，使用注册码激活失败问题">购买 Crossover 下载安装后，使用注册码激活失败问题</h4><hr><p>原因是注册部分的源码出现bug，修改源码，然后重启应用重新激活即可：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$: sudo vim /opt/cxoffice/lib/python/demoutils.py</span><br><span class="line"><span class="comment"># 把第250行的代码修改如下：request = urllib_request.Request(URL, request_body.encode(&quot;utf-8&quot;), header);</span></span><br><span class="line"><span class="comment"># 把第253行代码修改如下：responseBuffer = response.read().decode(&quot;utf-8&quot;);</span></span><br></pre></td></tr></table></figure><h4 id="Atom编辑器内存占用过大的问题">Atom编辑器内存占用过大的问题</h4><hr><blockquote><p>Atom、Vscode、Sublime、Bracks都用过，Atom用着最爽，可定制化程度最高。但是有时候用着Atom电脑呼呼作响，查看系统占用，Atom内存占用达到过4、5个G，我的天！其实Atom出现内存泄漏的问题都不是Atom本身的问题，一定是你安装的哪个插件导致了内存泄漏，查看占用信息后定位到atom的插件，然后把它禁用就可以了，比如之前导致我出现这个问题的插件就是：ide-typescript，禁用之后现在基本一个Atom进程只占用200~400Mb左右，取决于你安装的其它插件。还有Atom要经常手动更新啊，仓库里面更新不了的，直接去Atom git仓库下载release正式版本，基本上一个大版本就要更新一次。</p></blockquote><h4 id="Grub2-主题安装">Grub2 主题安装</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-12.png"  alt="source.png"></p><blockquote><p>Grub2就是引导操作系统启动的东西，开机的时候如果是多系统，就会显示多系统的启动菜单，如图，这个启动菜单可以自定义主题。</p></blockquote><ol><li>解压下载的主题文件 =&gt; <a href="https://pan.baidu.com/s/1ioMub2JmHlIzHJbS2_2gRQ">Vimix</a>，得到Vimix文件夹(这里提供我用的一个主题，也可以自已去下载其它主题)</li><li>在/boot/grub里创建GRUB2主题目录themes<br>&gt; sudo mkdir -p /boot/grub/themes</li><li>将下载的Vimix文件夹整体复制到/boot/grub/themes文件夹下<br>&gt; sudo cp -r Vimix /boot/grub/themes</li><li>修改/etc/default/grub配置文件<br>&gt; sudo gedit /etc/default/grub<br>在文件最后添加：GRUB_THEME=“/boot/grub/themes/Vimix/theme.txt” 并保存</li><li>更新GRUB<br>&gt; sudo update-grub</li><li>重启即生效(如果重启卡住请强制关机后再启动)</li></ol><h4 id="Ubuntu18-04-解决下载额外数据文件失败：ttf-mscorefonts-installer">Ubuntu18.04 解决下载额外数据文件失败：ttf-mscorefonts-installer</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-13.png"  alt="firefox_proxy.png"></p><ol><li><a href="http://sourceforge.net/projects/corefonts/files/the%20fonts/final/">sourceforge</a>下载如图所示11个exe文件并放入一个文件夹，比如： /home/nojsja/Downloads/ttf-mscorefonts-installer</li><li>运行字体配置程序<br>&gt; sudo dpkg-reconfigure ttf-mscorefonts-installer</li><li>在配置窗口中输入刚才保存exe的路径确定即可，比如： /home/nojsja/Downloads/ttf-mscorefonts-installer</li></ol><h4 id="Ubuntu18-04-WPS-提示字体缺失的解决方法">Ubuntu18.04 WPS 提示字体缺失的解决方法</h4><hr><p>下载缺失的字体文件<a href="https://pan.baidu.com/s/10MushHhTXwfRIFkKGmwD7Q">fonts</a> (密码: 4jpo)，然后复制到Linux系统中的/usr/share/fonts文件夹中，再使用系统命令更新字体设置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成字体的索引信息</span></span><br><span class="line">$: sudo mkfontscale</span><br><span class="line">$: sudo mkfontdir</span><br><span class="line"><span class="comment"># 更新字体缓存</span></span><br><span class="line">$: sudo fc-cache</span><br></pre></td></tr></table></figure><h4 id="Ubuntu20-04-安装最新版微信开发者工具">Ubuntu20.04 安装最新版微信开发者工具</h4><hr><blockquote><p>注意：github上的相关移植项目均已经太过久远，无法运行，比如 <a href="https://github.com/cytle/wechat_web_devtools">wechat_web_devtools</a></p></blockquote><p>采用 crossover19 创建 windows 10 版本的容器安装即可。可以自己去微信开发者工具官网下载最新的工具版本，自行安装，亲测功能正常使用。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/ubuntu/wechat_devtools_install.png"  alt="wechat_devtools_install"></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="https://nojsja.gitee.io/static-resources/images/ubuntu/wechat_devtools.png"  alt="wechat_devtools"></p><h4 id="Ubuntu18-04-WPS-提示字体缺失的解决方法-2">Ubuntu18.04 WPS 提示字体缺失的解决方法</h4><hr><p>下载相关的字体包，链接: <a href="https://pan.baidu.com/s/13GYtPlhlX-sd2-H4DKHXdw">https://pan.baidu.com/s/13GYtPlhlX-sd2-H4DKHXdw</a>  密码: <code>2a36</code>。</p><p>解压后将所有字体复制到系统目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo cp *  /usr/share/fonts/</span><br></pre></td></tr></table></figure><p>重启 wps 即可生效</p><h4 id="Ubuntu20-04-使用deepin-screenshot截图后无法粘贴到输入框">Ubuntu20.04 使用deepin-screenshot截图后无法粘贴到输入框</h4><hr><ul><li>安装<code>xfce4-clipman</code>，每次使用深度截图时保证它开启</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt install xfce4-clipman</span><br></pre></td></tr></table></figure><ul><li>也可以使用另一款推荐的截图编辑管理软件<code>flameshot</code>替代</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt install flameshot</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-更新Gnome版本">Ubuntu18.04 更新Gnome版本</h4><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Upgrade</span></span><br><span class="line"><span class="comment">#If you were using the gnome3-team/gnome3-staging PPA, run the following before upgrading:</span></span><br><span class="line">$: sudo ppa-purge ppa:gnome3-team/gnome3-staging</span><br><span class="line">$: sudo ppa-purge ppa:gnome3-team/gnome3</span><br><span class="line">$: sudo apt install ubuntu-gnome-desktop^</span><br><span class="line"><span class="comment"># The included GUI update manager will offer you the latest release of Ubuntu GNOME. Access this via the terminal:</span></span><br><span class="line">$: update-manager -c</span><br><span class="line"><span class="comment"># Alternatively, run the following command:</span></span><br><span class="line">$: sudo do-release-upgrade</span><br></pre></td></tr></table></figure><h4 id="Win10-Ubuntu18-04-双系统时间显示不对">Win10 + Ubuntu18.04 双系统时间显示不对</h4><hr><blockquote><p>Ubuntu和Windows默认的时间管理方式不同，所以双系统发生时间错乱是正常的。Ubuntu默认时间是把BIOS时间当成GMT+0时间，也就是世界标准时，而我国在东八区(GMT+8)，所以如果你的Ubuntu位置是中国的话你系统显示的时间就是BIOS时间+8小时。假如现在是早上8点，那么你Ubuntu会显示8点，这时BIOS中的时间是0点。而当你切换到Windows系统时就会发生时间错乱，因为Windows会认为BIOS时间就是你的本地时间，结果就是Windows显示时间为0点……而假如你在Windows下同步时间，恢复显示为8点，这时BIOS时间也会被Windows改写成8点，再次进入Ubuntu时显示时间又变成了8+8=16点。</p></blockquote><ol><li>先在Ubuntu下更新一下时间<br>&gt; sudo apt-get install ntpdate<br>&gt; sudo ntpdate <a href="http://time.windows.com">time.windows.com</a></li><li>将时间更新到硬件上<br>&gt; sudo hwclock --localtime --systohc</li><li>关闭linux重新进入windows系统，发现时间正常了</li></ol><h4 id="Ubuntu18-04-安装系统时说明-双硬盘">Ubuntu18.04 安装系统时说明(双硬盘)</h4><hr><blockquote><p>主要分为 [ <em>GPT磁盘分区+UEFI引导方案</em> ] 和 [ <em>传统MBR磁盘分区 + LEGANCY引导方案</em> ]</p></blockquote><ol><li>方案一(兼容方案 gpt+uefi / mbr+legancy)<br>使用UEFI模式安装Ubuntu18.04时可以选择用 兼容bios启动方式 来安装系统(同时兼容传统启动方式和UEFI启动方式)，即不分配&quot;/boot “分区，分配一个大小为1GB左右的&quot;保留bios启动区域”(UEFI模式会自动挂载/boot和/boot/efi)，其它分区至少还需要一个根分区&quot;/&quot;，8G内存的情况下最好还是分配8G的swap交换分区，另外除了&quot;保留bios启动区域&quot;为主分区，其它分区均为逻辑分区，最后一步很重要 – 格式化每个分区，要不然安装很可能会出错！<a href="https://blog.csdn.net/jesse_mx/article/details/61425361">参考</a></li><li>方案二(gpt+uefi 已使用方案)<br>创建&quot;efi系统分区&quot;，同时不需要划分&quot;/boot&quot;分区(boot引导是grub由引导的，而efi显然是UEFI引导的)，其余至少还需要划分&quot;/“根分区，除了根分区所有分区都为逻辑分区，最后选择&quot;安装启动引导器的设备&quot;为刚才创建的&quot;efit系统分区”。</li><li>方案三(传统mbr+legancy方案)<br>传统的legancy + mbr的安装，至少划分&quot;/boot&quot;分区(主分区) 和 &quot;/“根分区，其余的分区按需划分，最后选择&quot;安装启动引导器的设备&quot;为创建的”/boot&quot;挂载点。</li></ol><h4 id="Ubuntu18-04-安装网易云音乐1-1-0后不能打开的解决方法">Ubuntu18.04 安装网易云音乐1.1.0后不能打开的解决方法</h4><hr><ul><li>使用root权限命令行后台启动并且屏蔽输出<br>&gt; sudo netease-cloud-music &gt; /dev/null 2&gt;&amp;1  &amp;</li><li>规避session-manager引起的bug<br>&gt; alias netease=‘unset SESSION_MANAGER &amp;&amp; netease-cloud-music’<br>&gt; netease &gt; /dev/null &amp;</li><li>别用那个鸡肋的客户端了，有bug也不更新，上这个酷酷的第三方客户端<a href="https://github.com/trazyn/ieaseMusic">ieaseMusic</a></li><li>这里还有个别人做的针对ubuntu18.04的<a href="https://github.com/innoob/netease-cloud-music">重新构建版本</a>，可以正常使用，也没有重复登录的bug</li></ul><h4 id="Ubuntu18-04-Crossover17安装QQ后乱码的解决方法">Ubuntu18.04 Crossover17安装QQ后乱码的解决方法</h4><hr><blockquote><p>原因：原来的ume-ui-gothic.ttf不支持很多简体中文字符</p></blockquote><p>使用其它字体文件替换到目录 /opt/cxoffice/share/wine/fonts 下的<a href="https://pan.baidu.com/s/13CDBKrvTAJOhrbuyLw96jA">ume-ui-gothic.ttf</a>字体文件 (同名)，记得将下好的文件重命名为ume-ui-gothic.ttf。</p><h4 id="Ubuntu18-04-通过tweak安装gnome插件Blyr后设置插件报错">Ubuntu18.04 通过tweak安装gnome插件Blyr后设置插件报错</h4><hr><p>=&gt; 错误信息：<code>Error: Requiring Clutter, version none: Typelib file for namespace 'Clutter' (any version) not found ...</code><br>=&gt; 原因分析：该插件需要的依赖Clutter尚未安装<br>=&gt; 解决方法：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">$: sudo apt-get install gir1.2-clutter-1.0 gir1.2-clutter-gst-3.0 gir1.2-gtkclutter-1.0</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-一直提示-“检测到系统程序出现问题”">Ubuntu18.04 一直提示 “检测到系统程序出现问题”</h4><hr><p>ubuntu18.04已经移除了gksu软件，所以使用替代命令</p><ol><li>添加alias命令</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: <span class="built_in">alias</span> gksu=<span class="string">&#x27;pkexec env DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY&#x27;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>编辑错误报告相关设置</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: gksu gedit /etc/default/apport</span><br><span class="line"><span class="comment"># 把`enable = 1`改为`enable = 0`</span></span><br></pre></td></tr></table></figure><h4 id="Ubuntu20-04-使用系统播放器打开视频提示“安装h-264编码软件”">Ubuntu20.04 使用系统播放器打开视频提示“安装h.264编码软件”</h4><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: sudo apt install libdvdnav4 libdvd-pkg gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly libdvd-pkg</span><br><span class="line">$: sudo apt install ubuntu-restricted-extras</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-Gnome-Shell-插件">Ubuntu18.04 Gnome-Shell 插件</h4><hr><ul><li><a href="https://extensions.gnome.org/extension/97/coverflow-alt-tab/">CoverFlow Alt-Tab</a> =&gt; 窗口Tab切换预览(★★★★☆)</li><li><a href="https://extensions.gnome.org/extension/19/user-themes/">User Themes(必要)</a> =&gt; 用户主题安装(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/307/dash-to-dock/">Dash To Dock</a> =&gt; dock栏(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1160/dash-to-panel/">Dash To Panel</a> =&gt; 将dock和顶栏显示在一起(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1236/noannoyance/">NoAnnoyance</a> =&gt; 禁用多余的pop提示信息，直接提升活动窗口(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/595/autohide-battery/">Autohide Battery</a> =&gt; 电池充满并连接电源时自动隐藏电池按钮(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/8/places-status-indicator/">Places Status Indicator</a> =&gt; 顶部任务栏显示磁盘和卷的快捷入口(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/7/removable-drive-menu/">Removable Drive Menu</a> =&gt; 顶部任务栏显示可移除的已挂载设备(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/826/suspend-button/">Suspend Button</a> =&gt; 顶部菜单栏显示休眠按钮(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/495/topicons/">TopIcons</a> =&gt; 顶部通知图标托盘(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1031/topicons/">TopIconsPlus</a> =&gt; 顶部通知图标托盘，自定义图标显示参数(★★★★☆)</li><li><a href="https://extensions.gnome.org/extension/1251/blyr/">Blyr</a> =&gt; 模糊应用预览背景图(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/358/activities-configurator/">Activities Configurator</a> =&gt; 配置左上角活动按钮(★★★★☆)</li><li><a href="https://extensions.gnome.org/extension/427/workspaces-to-dock/">Workspace to Dock</a> =&gt; 将工作区转换为悬浮dock(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1036/extensions/">Extensions</a> =&gt; 在通知栏添加快捷开启和关闭gnome-shell插件的功能(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/779/clipboard-indicator/">Clipboard Indicator</a> =&gt; 可视化剪贴板(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/906/sound-output-device-chooser/">Sound Input &amp; Output Device Chooser</a> =&gt; 声音输入和输入设备快速选择(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1236/noannoyance/">NoAnnoyance</a> =&gt; 取消“窗口已就绪”提示直接提升窗口(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1401/bluetooth-quick-connect/">Bluetooth quick connect</a> =&gt; 蓝牙设备快速连接和断开(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1403/remove-alttab-delay/">Remove Alt+Tab Delay</a> =&gt; 移除【Alt + Tab】的开启应用预览延迟(★★★★★)</li><li><a href="https://extensions.gnome.org/extension/1162/emoji-selector/">Emoji Selector</a> =&gt; 快速选择Emoji表情(★★★★)</li></ul><h4 id="Ubuntu18-04-插件-Dash-to-dock-一些常用设置">Ubuntu18.04 插件 [ Dash to dock ] 一些常用设置</h4><hr><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Use Custom Dock Indicator ( Optional )</span></span><br><span class="line">$: gsettings <span class="built_in">set</span> org.gnome.shell.extensions.dash-to-dock custom-theme-running-dots <span class="literal">false</span></span><br><span class="line">$: gsettings <span class="built_in">set</span> org.gnome.shell.extensions.dash-to-dock custom-theme-customize-running-dots <span class="literal">false</span></span><br><span class="line">_______________________________________________________________________________________________</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable Custom Dock Shrink ( Required for Good looking) (  Required )</span></span><br><span class="line">$: gsettings <span class="built_in">set</span> org.gnome.shell.extensions.dash-to-dock custom-theme-shrink <span class="literal">false</span></span><br><span class="line">_______________________________________________________________________________________________</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dock Transparency mode ( Optional )</span></span><br><span class="line">$: gsettings <span class="built_in">set</span> org.gnome.shell.extensions.dash-to-dock transparency-mode DEFAULT</span><br><span class="line">_______________________________________________________________________________________________</span><br><span class="line"></span><br><span class="line"><span class="comment"># Restore to Default</span></span><br><span class="line">$: dconf reset -f /org/gnome/shell/extensions/dash-to-dock/</span><br><span class="line">_______________________________________________________________________________________________</span><br></pre></td></tr></table></figure><h4 id="Ubuntu18-04-主题">Ubuntu18.04 主题</h4><hr><ul><li>GTK3主题(★★★★☆) =&gt; <a href="https://www.gnome-look.org/p/1167049/">X-Arc-Collection</a></li><li>GTK3主题(★★★★★) =&gt; <a href="https://www.gnome-look.org/p/1241688">McOS-themes</a></li><li>Gnome Shell主题(★★★★) =&gt; <a href="https://github.com/daniruiz/flat-remix">Flat-Remix</a></li><li>Gnome Shell主题(★★★☆) =&gt; <a href="https://www.gnome-look.org/p/1171095/">Human</a></li><li>Gnome Shell主题(★★★★★) =&gt; <a href="https://www.opendesktop.org/c/1460761561">macOS High Sierra</a></li><li>Gnome Shell主题(?) =&gt; <a href="https://www.gnome-look.org/p/1213208/">macOS High Sierra</a></li><li>Icon 主题(★★★★) =&gt; <a href="https://github.com/daniruiz/flat-remix/releases">flat-remix</a></li><li>Icon 主题(★★★★☆) =&gt; <a href="https://www.gnome-look.org/p/1012200/">Mac OS X Icon</a></li><li>Icon 主题(★★★★★) =&gt; <a href="https://github.com/keeferrourke/la-capitaine-icon-theme/releases">la-capitaine-icon-theme</a></li><li>Icon 主题(★★★★★) <a href="https://www.pling.com/p/1305429/">McMojave-circle</a></li><li>Icon 主题(★★★★☆) =&gt; <a href="https://github.com/zayronxio/Macos-sierra-CT">MacOS sierra ct</a></li><li>Cursor主题(★★★★☆) =&gt; <a href="https://krourke.org/projects/art/capitaine-cursors">Capitaine Cursors</a></li></ul><h4 id="chrome实用插件整理">chrome实用插件整理</h4><hr><ul><li><a href="https://chrome.google.com/webstore/detail/infinity-new-tabproductiv/dbfmnekepjoapopniengjbcpnbljalfg?utm_source=InfinityNewtab">infinity pro 标签页</a> =&gt; 主页标签管理器(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc?utm_source=InfinityNewtab">Octotree</a> =&gt; github仓库文件资源浏览树(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?utm_source=InfinityNewtab">Postman</a> =&gt; API测试和请求模拟器(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif?utm_source=InfinityNewtab">SwitchyOmega</a> =&gt; 大家都用的代理软件(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/evernote-web-clipper/pioclpoplcdbaefihamjohnefbikjilc?utm_source=InfinityNewtab">印象笔记剪藏</a> =&gt; 随时随地把网络资源保存到你的笔记本里(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/simpread-reader-view/ijllcpnolfcooahcekpamkbidhejabll?utm_source=InfinityNewtab">SimpRead</a> =&gt; 让浏览器支持纯净的阅读模式(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/full-page-screen-capture/fdpohaocaechififmbbbbbknoalclacl?utm_source=InfinityNewtab">Full Page Screen Capture</a> =&gt; 全屏截图(★★★★☆)</li><li><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?utm_source=InfinityNewtab">油猴tampermonkey</a> =&gt; 用户脚本管理器，一个用例是破解badu网盘的限速(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/checker-plus-for-gmail/oeopbcgkkoapgobdbedcemjljbihmemj?utm_source=InfinityNewtab">Checker Plus for Gmail</a> =&gt; Google邮件提示插件(★★★★☆)</li><li><a href="https://chrome.google.com/webstore/detail/vimium/dbepggeogbaibhgnhhndojpepiihcmeb?utm_source=InfinityNewtab">Vimium</a> =&gt; 让google浏览器支持vim模式(firefox也有)(★★★★★)</li><li><a href="https://chrome.google.com/webstore/detail/copy-as-markdown/dgoenpnkphkichnohepecnmpmihnabdg">拷贝为Markdown</a> =&gt; 将选中网页转化为markdown格式并发送到剪贴板(★★★★☆)</li><li><a href="https://darkreader.org/">Dark Reader</a> =&gt; 浏览器插件，全局暗黑模式，自动适配网页字体颜色(★★★★★)</li></ul><h4 id="实用程序和命令">实用程序和命令</h4><hr><ul><li><a href="https://github.com/tonsky/FiraCode/wiki/Linux-instructions#installing-with-a-package-manager">fonts-firacode编程字体</a> =&gt; 解决vscode字体间隙过小的问题<code>sudo apt install fonts-firacode</code></li><li><a href="https://vivaldi.com">vivaldi浏览器</a> =&gt; 可定制化程度高的个性化浏览器(★★★★★)</li><li>indicator-stickynotes =&gt; 桌面便签应用，添加<code>ppa:umang/indicator-stickynotes</code>安装(★★★★★)</li><li><a href="https://u.tools/">utools</a> =&gt; 新一代效率工具平台(★★★★★)</li><li><a href="https://github.com/nojsja/shadowsocks-electron">shadowsocks-electron</a> =&gt; 基于 Electron 平台的 shadowsocks GUI 客户端(★★★★☆)</li><li>vifm(命令工具) =&gt; 基于vim的命令行文件浏览和编辑工具(★★★★★)</li><li>Terminator =&gt; 默认gnome终端升级版(★★★★★)</li><li>Timeshift =&gt; 创建系统快照，增量备份(★★★★★)</li><li>ipython3(命令工具) =&gt; python交互解释器(★★★★★)</li><li>jupyter =&gt; 交互式数据分析和记录工具(★★★★☆)</li><li>pdb/ipdb(命令工具) =&gt; python调试器(★★★★☆)</li><li>trash-cli(命令工具) =&gt; 命令行回收站(★★★★★)</li><li>bat(命令工具) =&gt; cat升级版，支持语法高亮和git状态显示(★★★★★)</li><li>unar(命令工具) =&gt; zip解压工具，可用来解决压缩包解压后乱码的问题(★★★★★)</li><li>axel(命令工具) =&gt; 下载限速不存在的，如果存在那我就开100个下载线程 : )(★★★★☆)</li><li><a href="https://github.com/aria2/aria2">aria2(命令工具)</a> =&gt; 强大的命令行下载工具</li><li><a href="https://github.com/oguzhaninan/Stacer">stacer</a> =&gt; linux电脑管家(★★★★★)</li><li><a href="https://github.com/trazyn/ieaseMusic">ieaseMusic</a> =&gt; 网易云音乐第三方客户端，没有bug，不会退出后再打开就让重新登陆[注：网易云音乐官方已修复]，界面还很酷(★★★★★)</li><li>parallel(命令工具) =&gt; 利用系统的多核来并行执行你的程序(★★★★☆)</li><li>cheat(命令工具) =&gt; 类似man命令的功能，简洁高效(★★★★☆)</li><li>topgrade(命令工具) =&gt; 一个命令更新所有软件(★★★★)</li><li><a href="https://www.dbkoda.com/">dbKoda</a> =&gt; mongodb GUI工具(★★★★☆)</li><li><a href="https://www.mongodb.com/products/compass">mongodb compass</a> =&gt; mongodb GUI工具(★★★★)</li><li><a href="https://github.com/phw/peek">peek</a> =&gt; 屏幕录制工具，支持输出gif/webm/apng/webm格式的媒体文件(★★★★☆)</li><li>tmux =&gt; 终端管理器(★★★★)</li><li>深度终端(ubuntu商店下载) =&gt; 支持分屏，内置实用主题(★★★★☆)</li><li>深度截图(ubuntu商店下载) =&gt; 支持截图编辑(★★★★★)</li><li>shutter截图 =&gt; 功能丰富的截图和图标编辑软件，添加<code>ppa:linuxuprising/shutter</code>安装(★★★★☆)</li><li>flameshot =&gt; 支持Ubuntu20.04的截图编辑工具(★★★★★)</li><li><a href="https://webtorrent.io/desktop/">WebTorrent</a>、<a href="https://www.frostwire.com/">FrostWire</a> =&gt; bt下载工具，支持边下边播(★★★★)</li><li><a href="https://www.syntevo.com/smartgit/">SmartGit</a> =&gt; linux平台免费的GIT GUI工具(★★★★★)</li><li>FileZilla =&gt; ftp工具(★★★★★)</li><li><a href="https://github.com/Suremotoo/e-tools">e-tools</a> =&gt; coder常用小工具(★★★★)</li><li><a href="https://electronjs.org/apps/whatever">WhatEver</a> =&gt; linux第三方印象笔记客户端，基于网页版(★★★★)</li><li><a href="http://linux.wps.cn/">wps</a> =&gt; linux office for free made by KingSoftware(★★★★★)</li><li><a href="https://code.visualstudio.com/">vscode</a> =&gt; 轻量化编辑器，很快！ (★★★★★)</li><li>ndb =&gt; node.js/javascript 调试器(★★★★★)</li><li><a href="https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh">nvm</a> =&gt; nodejs版本管理器</li><li>albert (添加软件源 <code>ppa:noobslab/macbuntu</code> 安装 ) =&gt; 桌面全局搜索类似Mac系统的SpotLight(★★★★★)</li><li><a href="https://linux.cn/article-5460-1.html">lftp</a> =&gt; 一个基于命令行的文件传输软件，支持FTP，FTPS，HTTP，HTTPS，HFTP，FISH，以及SFTP等协议，也有许多高级特性比<br>如：多线程下载、断点续传</li><li><a href="http://jonls.dk/redshift/">redshift-gtk</a> 护眼模式，自带的色彩太黄了</li><li>apt-fast =&gt; 比apt更快的包管理器，添加<code>ppa:apt-fast/stable</code>安装(★★★★★)</li><li>nautilus action configure tool =&gt; 资源管理器右键菜单自定义，添加<code>ppa:daniel-marynicz/filemanager-actions</code>安装(★★★★★)</li><li>tig =&gt; 可交互的命令行git命令(★★★★★)</li><li>shellcheck =&gt; shell脚本语法检查(★★★★★)</li><li><a href="https://motrix.app/zh-CN/">Motrix</a> =&gt; 全平台下载工具，用于替代迅雷(★★★★★)</li><li><a href="https://github.com/jgraph/drawio-desktop/">Drawio</a> =&gt; 全平台绘图工具(流程图、类图、工程图…)，功能跟微软的visio相同(★★★★★)</li><li><a href="https://github.com/Winetricks/winetricks">winetricks</a> =&gt; wine环境的辅助工具，可用于生成wine基础环境、安装windows dll和字体等等(★★★★★)</li><li><a href="https://www.insynchq.com/">Insync</a> =&gt; 全平台同步工具，支持google云和onedrive(★★★★★)</li><li><a href="https://github.com/teejee2008/timeshift">Timeshift</a> =&gt; 创建系统增量备份计划(★★★★★)</li><li>dconf-editor =&gt; gnome桌面配置gui工具(★★★★)</li></ul><h4 id="实用网站推荐">实用网站推荐</h4><hr><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="Ubuntu18.04-14.png"  alt="Vimix.png"></p><ul><li><a href="https://wallpapershome.com/">Wallpaper</a>  =&gt; 高清桌面壁纸下载，支持多种分辨率(★★★★★)</li><li><a href="https://www.flaticon.com">flaticon</a> =&gt; 免费图标下载网站，支持svg和png两种格式</li><li><a href="https://electronjs.org/apps">Electron Apps</a> =&gt; 有很多Electron 框架写的跨平台应用(Linux/Mac/Windows)(★★★★☆)</li><li><a href="https://www.centos.bz/">Linux运维日志</a> =&gt; 服务搭建、Linux技术之类的(★★★★☆)</li><li><a href="https://www.ibm.com/developerworks/cn/">IBM Developer</a> =&gt; 技术文档类的参考(★★★★★)</li><li><a href="https://www.lulinux.com/archives/2513#awk">Linux常用命令</a>  =&gt;  常用命令速查(★★★★☆)</li><li><a href="https://www.kanbilibili.com/">bilibili工具网站</a> =&gt; 支持 视频/弹幕/封面 下载等骚操作(★★★★★)</li><li><a href="https://linux.cn/">Linux中国</a> =&gt; 没事儿就上去看看别人翻译转载的文章(★★★★☆)</li><li><a href="https://tinypng.com/">TinyPNG</a> =&gt; 免费的图片无损压缩网站(★★★★☆)</li><li><a href="https://www.iloveimg.com/zh-cn">iLoveIMG</a> =&gt; 在线图片编辑网站(★★★★★)</li><li><a href="https://en.savefrom.net/">savefrom</a> =&gt; 直接下载youtube视频(★★★★☆)</li><li><a href="https://www.lulinux.com/">撸Linux</a> =&gt; 好像还蛮有趣的额(★★★★☆)</li><li><a href="https://greasyfork.org/zh-CN/scripts">油猴脚本</a> =&gt; 你甚至可以用来破解百度云限速(★★★★★)</li></ul><p><em>注：以上内容部分是从网络搜集，希望解决广大Linuxer的问题所以做了部分整合.</em></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu18.04 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LinuxMint18日常软件安装配置</title>
      <link href="/blogs/2019/04/04/bf638b5c.html/"/>
      <url>/blogs/2019/04/04/bf638b5c.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="city.jpg"  alt="city"></p><blockquote><p>实装机器是linux mint18.3，理论上也适用于ubuntu</p></blockquote><h4 id="目录">目录</h4><ol><li>QQ 8.1 的 安装配置</li><li>微信的安装配置</li><li>印象笔记的安装配置</li><li>安装 Mac-os 主题</li><li>怎样自由上网(翻墙)</li><li>安装办公软件wps</li><li>实用工具推荐：tmux、stacer、oh-my-zsh、SmartGit、Docky</li><li>chrome实用插件整理</li></ol><h4 id="QQ-8-1-的-安装配置">QQ 8.1 的 安装配置</h4><hr><h5 id="方案一：-Wine-deepingCrossover-deepinQQ-8-1">方案一： Wine + deepingCrossover + deepinQQ 8.1</h5><blockquote><p>日常使用基本没有bug，能够保存密码自动登录</p></blockquote><ol><li><p>Wine安装<br>Wine(Wine Is Not Emulator)，Wine是一个在x86、x86-64上容许类Unix操作系统在X Window System下运行Microsoft Windows程式的软件。<br>跟着执行几个命令即可，安装可能有点慢，一个小时内能搞定吧。<a href="https://wiki.winehq.org/Ubuntu">–&gt;阅读安装步骤</a></p></li><li><p>deepinCrossover安装<br>如果是64位系统，先添加对32位库的支持：</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure><p>可能需要添加下列32位库：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install lib32z1 lib32ncurses5  </span><br></pre></td></tr></table></figure><p><a href="https://pan.baidu.com/disk/home?#/all?vmode=list&amp;path=%2F%E5%B7%A5%E5%85%B7%E5%92%8C%E8%BD%AF%E4%BB%B6%2Fcrossover-%E4%BB%A5%E5%8F%8Aqq%E5%AE%89%E8%A3%85">crossover下载地址</a>，到我的网盘下载crossover-15_15.0.3-1_all.deb、crossover-15_15.0.3-1_all-free.deb、deepin-crossover-helper_1.0deepin0_all.deb三个文件，在第一步的Wine安装完毕后按照以上下载说明的顺序依次安装三个deb包。</p><ol start="3"><li>deepinQQ 8.1安装<br>deepinCrossover安装好后，到刚才下载三个deb包的地址那儿继续下载第四个deb包:apps.com.qq.im_8.1.17255deepin11_i386.deb，下载好后安装即可正常使用QQ。</li></ol><h5 id="方案二：-绿色无需安装精简版QQ">方案二： 绿色无需安装精简版QQ</h5><blockquote><p>缺点；不能保存密码，每次登录都要输入密码，优点：安装步骤忽略为零</p></blockquote><ul><li>下载地址：<a href="https://pan.baidu.com/disk/home?#/all?vmode=list&amp;path=%2F%E5%B7%A5%E5%85%B7%E5%92%8C%E8%BD%AF%E4%BB%B6%2FQQ_Linux">QQ.AppImage</a>下载好后直接双击并允许可执行权限即可。</li></ul><h4 id="微信的安装配置">微信的安装配置</h4><hr><blockquote><p>微信官方没有客户端，都是第三方封装的网页版微信，够用了，发送文件都行</p></blockquote><h5 id="方案一：electron-wechat">方案一：electron-wechat</h5><p><a href="https://github.com/geeeeeeeeek/electronic-wechat/releases">下载地址</a>，到github找自己要安装的版本的tar包，下载好后，使用tar -xf 命令解压，在把解压目录内的 electronic-wechat 可执行程序 赋予可执行权限，相关命令是 sudo chmod 755 ./electronic-wechat，最后再建立两个软链接到 /usr/local/bin 和 /home/你的用户名/Desktop/ 目录即可，相关命令是： sudo ln -s path/to/electronic-wechat path/to/目标地址，这样做的目的是：让你可以从终端启动微信，并且在桌面建立了一个微信的快捷方式，直接点击即可运行微信。</p><h5 id="方案二：weweChat">方案二：weweChat</h5><p><a href="https://github.com/trazyn/weweChat/releases">下载地址</a>，到这个地址找wewechat的相关deb包下载安装即可，我用的就是这个版本，UI和上面那个有点差别，还不错的。</p><h4 id="印象笔记的安装配置">印象笔记的安装配置</h4><hr><blockquote><p>印象笔记官方也没有开发Linux版本，说是维护成本太大，但是开放了API让第三方程序或是网页可以直接调用，所以有了我们下面这个使用Electron技术封装的网页版印象笔记Whatever，跟网页版看着一样，只不过有了一层桌面软件的壳，值得一提的是 我觉得网页版印象笔记更好用，界面也更现代化，这儿提供一个<a href="https://electronjs.org/apps">Electron的应用中心</a>，里面很多第三方开发者的app，大部分可以Linux使用，自己找找，说不定有你喜欢的，最后附上Whatever的<a href="https://electronjs.org/apps/whatever">下载地址</a>，选择适合你的版本下载安装即可。</p></blockquote><h4 id="安装-Mac-os-主题">安装 Mac-os 主题</h4><hr><ul><li>安装到Linux Mint</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:noobslab/macbuntu</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install macbuntu-os-icons-lts-v7 macbuntu-os-ithemes-lts-v7</span><br></pre></td></tr></table></figure><ul><li>从Linux Mint卸载</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository -r ppa:noobslab/macbuntu</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt remove macbuntu-os-icons-lts-v7 macbuntu-os-ithemes-lts</span><br><span class="line">-v7</span><br></pre></td></tr></table></figure><p>安装好了要自己去设置界面切换啊～</p><h4 id="怎样自由上网-翻墙">怎样自由上网(翻墙)</h4><hr><ol><li>从vultr买外国云主机，最低$2.5一个月，基本上是所有服务商里面最便宜的了，配置也是最低<a href="https://my.vultr.com/">官方地址</a></li><li>登录自己的服务器</li><li>服务器一键安装shadowsocks服务 <a href="https://xyzardq.github.io/2017/03/07/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BAshadowsocks%E5%8F%8A%E4%BC%98%E5%8C%96/">参考地址</a></li><li>自己电脑安装Shadowsocks-Qt5，设置好服务器地址，端口和本地代理地址和端口</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:hzwhuang/ss-qt5</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install shadowsocks-qt5</span><br></pre></td></tr></table></figure><ol start="5"><li>chrome安装SwitchyOmega插件，很方便的代理插件，Firefox上也有相应的版本，安装好后设置ip和端口 映射到第四步Shadowsocks-Qt5里设置的本地ip和端口即可享受自由的上网生活，附上一篇<a href="http://www.cylong.com/blog/2017/04/09/chrome-SwitchyOmega/">教程</a></li></ol><h4 id="安装办公软件wps">安装办公软件wps</h4><hr><blockquote><p>Linux上最好用的办公软件，没有之一，无奈官方宣布暂时不更新了，linux mint自带的Liboffice不太好用，格式跟office不太兼容，<a href="http://linux.wps.cn/">wps官网下载直达</a></p></blockquote><h4 id="实用工具推荐">实用工具推荐</h4><hr><ol><li>tmux终端工具</li></ol><blockquote><p>Tmux 简单来说就是终端里的『窗口管理器』，强烈推荐。附上<br><a href="http://wdxtub.com/2016/03/30/tmux-guide/">使用教程</a></p></blockquote><ol start="2"><li>stacer系统管理工具</li></ol><blockquote><p>系统进程可视化管理和垃圾清理工具，就是相当于Linux上的电脑管家，还能查看系统占用，卸载软件包，配置开机启动，管理apt软件源等等，非常强大好用，附上<a href="https://sourceforge.net/projects/stacer/">下载地址</a></p></blockquote><ol start="3"><li>oh-my-zsh终端模拟器</li></ol><blockquote><p>支持插件、主题、自定义配置的强大的终端模拟器，用来替代自带的bash，附上<a href="http://yijiebuyi.com/blog/b9b5e1ebb719f22475c38c4819ab8151.html">安装教程</a></p></blockquote><ol start="4"><li>SmartGit仓库管理可视化工具</li></ol><blockquote><p>大名鼎鼎的分布式版本控制软件git的可视化工具，免费又强大，只是界面是英文的，不过我想你应该不太会介意</p></blockquote><ol start="5"><li>Docky</li></ol><blockquote><p>漂亮的dock工具栏，方便酷炫实用</p></blockquote><ol start="6"><li>Peek</li></ol><blockquote><p>强大的屏幕录制工具，支持输出gif/webm/apng/webm格式的媒体文件</p></blockquote><ol start="7"><li>Inkscape</li></ol><blockquote><p>跨平台免费强大的svg图片绘制工具</p></blockquote><h4 id="chrome实用插件整理">chrome实用插件整理</h4><hr><ol><li>infinity标签页</li></ol><blockquote><p>浏览器首页管理器，可以添加很多网站的快捷进入图标，方便美观</p></blockquote><ol start="2"><li>Octotree</li></ol><blockquote><p>让你在浏览github仓库时可以利用左侧的文件资源浏览树更方便地查看项目结构和页面跳转</p></blockquote><ol start="3"><li>Postman</li></ol><blockquote><p>api测试神器，很强大，甚至能发送带cookie的请求，各种请求、响应编辑功能也非常实用</p></blockquote><ol start="4"><li>SwitchyOmega</li></ol><blockquote><p>大家都用的代理软件，不说了</p></blockquote><ol start="5"><li>印象笔记剪藏</li></ol><blockquote><p>随时随地把网络资源保存到你的笔记本里</p></blockquote><ol start="6"><li>SimpRead - 简阅</li></ol><blockquote><p>让浏览器支持纯净的阅读模式</p></blockquote><ol start="7"><li>Full Page Screen Capture</li></ol><blockquote><p>全屏截图，真的是全屏，你的浏览器标签页有多长，它就能截多长</p></blockquote><ol start="8"><li>高效网页截图编辑插件</li></ol><blockquote><p>另一个好用的截图插件</p></blockquote><h4 id="感谢阅读">感谢阅读</h4><p>有时间还会继续更新本文</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> mint </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>proxychains终端代理</title>
      <link href="/blogs/2019/04/04/d04b08a2.html/"/>
      <url>/blogs/2019/04/04/d04b08a2.html/</url>
      
        <content type="html"><![CDATA[<h3 id="proxychains安装">proxychains安装</h3><p><code>sudo apt install proxychains</code></p><h3 id="编辑proxychains配置">编辑proxychains配置</h3><p><code>vim /etc/proxychains.conf</code></p><h3 id="将socks4-127-0-0-1-9095改为">将socks4 127.0.0.1 9095改为</h3><p><code>socks5 127.0.0.1 1080</code></p><p>ps: 默认的socks4 127.0.0.1 9095是tor代理，而socks5 127.0.0.1 1080是shadowsocks的代理，proxychains.conf文件说明了代理配置格式,如下,这里根据自己使用的代理来配置就行了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ProxyList format</span><br><span class="line"> 94 <span class="comment">#       type  ip  port  [user pass]</span></span><br><span class="line"> 95 <span class="comment">#       (values separated by &#x27;tab&#x27; or &#x27;blank&#x27;)</span></span><br><span class="line"> 96 <span class="comment">#</span></span><br><span class="line"> 97 <span class="comment">#       only numeric ipv4 addresses are valid</span></span><br><span class="line"> 98 <span class="comment">#</span></span><br><span class="line"> 99 <span class="comment">#</span></span><br><span class="line">100 <span class="comment">#        Examples:</span></span><br><span class="line">101 <span class="comment">#</span></span><br><span class="line">102 <span class="comment">#       socks5  192.168.67.78   1080    lamer   secret</span></span><br><span class="line">103 <span class="comment">#       http    192.168.89.3    8080    justu   hidden</span></span><br><span class="line">104 <span class="comment">#       socks4  192.168.1.49    1080</span></span><br><span class="line">105 <span class="comment">#       http    192.168.39.93   8080</span></span><br></pre></td></tr></table></figure><h3 id="使用方法">使用方法</h3><p>在需要代理的命令前加上 proxychains ，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains wget http://xxx.com/xxx.zip</span><br><span class="line">proxychains git <span class="built_in">clone</span> https://xxxxxxxxx.git</span><br></pre></td></tr></table></figure><p>npm设置http代理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设本地代理端口为8002</span></span><br><span class="line">npm config <span class="built_in">set</span> proxy http://127.0.0.1:1081</span><br><span class="line">npm config <span class="built_in">set</span> https-proxy http://127.0.0.1:1081</span><br><span class="line"></span><br><span class="line"><span class="comment"># 有用户密码的代理</span></span><br><span class="line">npm config <span class="built_in">set</span> proxy http://username:password@127.0.0.1:1081</span><br><span class="line">npm confit <span class="built_in">set</span> https-proxy http://username:password@127.0.0.1:1081</span><br></pre></td></tr></table></figure><p>npm设置socks5代理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设本地socks5代理端口为1081</span></span><br><span class="line"><span class="comment"># 首先安装转换工具</span></span><br><span class="line">npm install -g http-proxy-to-socks</span><br><span class="line"><span class="comment"># 然后使用这个工具监听8002端口,支持http代理，然后所有8002的http代理数据都将转换成socks的代理数据发送到1081上</span></span><br><span class="line">hpts -s 127.0.0.1:1081 -p 8002</span><br><span class="line"><span class="comment"># 最后设置npm代理为8080</span></span><br><span class="line">npm config <span class="built_in">set</span> proxy http://127.0.0.1:8002</span><br><span class="line">npm config <span class="built_in">set</span> https-proxy http://127.0.0.1:8002</span><br></pre></td></tr></table></figure><p>查看删除代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm config get</span><br><span class="line">  or</span><br><span class="line">npm config list</span><br><span class="line"></span><br><span class="line">npm config delete proxy</span><br><span class="line">  and</span><br><span class="line">npm config delete https-proxy</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
            <tag> shadowsocks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用Javascript实现一个可自定义样式的tootips组件</title>
      <link href="/blogs/2018/11/06/f7cb1494.html/"/>
      <url>/blogs/2018/11/06/f7cb1494.html/</url>
      
        <content type="html"><![CDATA[<h4 id="前言">前言</h4><blockquote><p>最近做的一个jQuery老项目经常会用tootips组件在一个html元素周围显示提示信息，虽然有现成的组件可以使用，但是很多tootips组件处理起来并不灵活，不能够自定义tootips样式和显示的内容及布局等等，而且tootips组件本身的样式可能会被目标组件的样式影响，所以想自己实现一个tootips组件：可以自定义显示内容，并且tootips的位置和布局完全不受页面元素影响。</p></blockquote><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tootip.png"  alt="tootip.png"></p><h4 id="预览图">预览图</h4><hr><p><a href="https://github.com/nojsja/javascript-learning/tree/master/code-challenge/es5-component/js-tooltips">=&gt; 源代码</a></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tootips.gif"  alt="animation.gif"></p><h4 id="代码实现">代码实现</h4><hr><h5 id="组件结构">组件结构</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> Tootips = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 工具函数 */</span></span><br><span class="line">  <span class="keyword">var</span> utils = &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [renderContainer 构造html]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>options   [自定义参数]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>type   [渲染类型 -&gt; text | html]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>target   [渲染字符串]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">renderContainer</span>(<span class="params">$selector, tootipKey</span>) </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [showTootips 操作页面属性显示一个元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>tootipKey [可能已经生成过一次tooptips组件了]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">showTootips</span>(<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [hideTooTips 操作页面属性隐藏一个元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">hideTooTips</span>(<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [eventListen 进行事件监听]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>trigger [触发事件监听类型]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">eventListen</span>(<span class="params">$selector, _trigger, $context</span>) </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [renderHtml 使用html字符串进行初始化]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>htmlstr   [html字符串]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>options   [自定义参数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">_$selector, _options</span>) </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line">   <span class="attr">init</span>: init,</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [trigger 手动触发元素的显示和隐藏]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="attr">trigger</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!utils.element.getData($selector, <span class="string">&#x27;isActivated&#x27;</span>)) &#123;</span><br><span class="line">      showTootips($selector, utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      hideTooTips($selector);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [getStatus 获取某个元素的状态]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="attr">status</span>: <span class="function"><span class="keyword">function</span> (<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">isActivated</span>: utils.element.getData($selector, <span class="string">&#x27;isActivated&#x27;</span>) ? <span class="literal">true</span> : <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">isInited</span>: utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>) ? <span class="literal">true</span> : <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">key</span>: utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>) || <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="工具函数封装">工具函数封装</h4><blockquote><p>主要用于简化dom操作，实现了一些类似jQuery的API；还封装了用于计算元素坐标的纯函数</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> utils = &#123;</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">      <span class="comment">// [symbol]: [Timer]</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">element</span>: &#123;</span><br><span class="line">     <span class="attr">jsonWrapper</span>: <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> jsonParseRule = <span class="regexp">/^\&#123;&quot;([\w\W])+\&#125;$/</span>;</span><br><span class="line">       <span class="keyword">if</span> (jsonParseRule.test(target)) <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(target);</span><br><span class="line">       <span class="keyword">return</span> (<span class="keyword">typeof</span> target === <span class="string">&#x27;object&#x27;</span> &amp;&amp; target !== <span class="literal">null</span>) ?</span><br><span class="line">         <span class="built_in">JSON</span>.stringify(target) :</span><br><span class="line">         target;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">elementWrapper</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (<span class="keyword">typeof</span> $element === <span class="string">&#x27;object&#x27;</span>) ? $element : <span class="built_in">document</span>.querySelector($element);</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">setAttr</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, key, value</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       (key) &amp;&amp; $element.setAttribute(key, <span class="built_in">this</span>.jsonWrapper(value));</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">setCss</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, styleKey, styleValue, important</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       $element.style.setProperty(styleKey, styleValue, important === <span class="string">&#x27;important&#x27;</span> ? important : <span class="literal">undefined</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">getAttr</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, key</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       <span class="keyword">return</span> (key) ? <span class="built_in">this</span>.jsonWrapper($element.getAttribute(key)) : <span class="literal">undefined</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">setData</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, key, value</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       (key) &amp;&amp; <span class="built_in">this</span>.setAttr($element, <span class="string">&#x27;data-&#x27;</span> + key, value);</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">getData</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, key</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       <span class="keyword">return</span> key ? <span class="built_in">this</span>.getAttr($element, <span class="string">&#x27;data-&#x27;</span> + key) : <span class="literal">undefined</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">addClass</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, className</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       <span class="keyword">var</span> classes = $element.className.split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">       <span class="keyword">if</span> (!classes.includes(className)) &#123;</span><br><span class="line">         classes.push(className);</span><br><span class="line">         $element.className = classes.join(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">removeClass</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, className</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       <span class="keyword">var</span> classes = $element.className.split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">       <span class="keyword">var</span> index = classes.indexOf(className);</span><br><span class="line">       <span class="keyword">if</span> (index !== -<span class="number">1</span>) &#123;</span><br><span class="line">         classes.splice(index, <span class="number">1</span>);</span><br><span class="line">         $element.className = classes.join(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">empty</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       $element.innerHTML = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">html</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$element, htmlStr</span>) </span>&#123;</span><br><span class="line">       $element = <span class="built_in">this</span>.elementWrapper($element);</span><br><span class="line">       $element.innerHTML = htmlStr;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">   <span class="comment">/* 根据宿主元素第一次计算横坐标和纵坐标 */</span></span><br><span class="line">   <span class="attr">renderX1</span>: <span class="function"><span class="keyword">function</span> (<span class="params">r, d</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;top&#x27;</span> || d === <span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x + r.width / <span class="number">2</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x - <span class="number">6</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x + r.width + <span class="number">6</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottomleft&#x27;</span> || d === <span class="string">&#x27;topleft&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottomright&#x27;</span> || d === <span class="string">&#x27;topright&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x + r.width + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">renderY1</span>: <span class="function"><span class="keyword">function</span> (<span class="params">r, d</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;top&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y - <span class="number">6</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;left&#x27;</span> || d === <span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y + r.height / <span class="number">2</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y + r.height + <span class="number">6</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottomleft&#x27;</span> || d === <span class="string">&#x27;bottomright&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y + r.height + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;topleft&#x27;</span> || d === <span class="string">&#x27;topright&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">/* 根据生成的tootips元素宽高第二次计算横坐标和纵坐标 */</span></span><br><span class="line">   <span class="attr">renderX2</span>: <span class="function"><span class="keyword">function</span> (<span class="params">r, d</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;top&#x27;</span> || d === <span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x - r.width / <span class="number">2</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;left&#x27;</span> || d === <span class="string">&#x27;bottomleft&#x27;</span> || d === <span class="string">&#x27;topleft&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x - r.width + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.x + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottomright&#x27;</span> || d === <span class="string">&#x27;topright&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> (r.x + r.widht + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">renderY2</span>: <span class="function"><span class="keyword">function</span> (<span class="params">r, d</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;top&#x27;</span> || d === <span class="string">&#x27;topleft&#x27;</span> || d === <span class="string">&#x27;topright&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y - r.height + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;left&#x27;</span> || d === <span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y - r.height / <span class="number">2</span> + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">     <span class="keyword">if</span> (d === <span class="string">&#x27;bottom&#x27;</span> || d === <span class="string">&#x27;bottomleft&#x27;</span> || d === <span class="string">&#x27;bottomright&#x27;</span>)</span><br><span class="line">       <span class="keyword">return</span> (r.y + <span class="string">&#x27;px&#x27;</span>);</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">/* 使用函数去抖防止调用混乱 */</span></span><br><span class="line">   <span class="attr">actionDebounce</span>: <span class="function"><span class="keyword">function</span>(<span class="params">symbol, action, params</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">     <span class="keyword">var</span> timer = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       action(params);</span><br><span class="line">       <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">       <span class="keyword">delete</span> that.actions[symbol];</span><br><span class="line">     &#125;, <span class="number">300</span>);</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">if</span> (!that.actions[symbol]) &#123;</span><br><span class="line">       that.actions[symbol] = timer;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="built_in">clearTimeout</span>(that.actions[symbol]);</span><br><span class="line">       that.actions[symbol] = timer;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h5 id="初始化一个元素">初始化一个元素</h5><blockquote><p>对一个html元素进行初始化，在元素上绑定数据和设置事件监听器</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [renderHtml 使用html字符串进行初始化]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>htmlstr   [html字符串]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>options   [自定义参数]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">_$selector, _options</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> $selector = utils.element.elementWrapper(_$selector),</span><br><span class="line">      trigger = _options[<span class="string">&#x27;trigger&#x27;</span>] ? _options[<span class="string">&#x27;trigger&#x27;</span>] : <span class="string">&#x27;mouseover&#x27;</span>, <span class="comment">// click | hover</span></span><br><span class="line">      $context = utils.element.elementWrapper(_options[<span class="string">&#x27;context&#x27;</span>]),</span><br><span class="line">      key = utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>);</span><br><span class="line">   </span><br><span class="line">   utils.element.setData($selector, <span class="string">&#x27;tootip-target&#x27;</span>, _options.value)</span><br><span class="line">     .setData($selector, <span class="string">&#x27;tootip-type&#x27;</span>, _options.type)</span><br><span class="line">     .setData($selector, <span class="string">&#x27;tootip-options&#x27;</span>, _options)</span><br><span class="line">     .setData($selector, <span class="string">&#x27;tootip-trigger&#x27;</span>, _options.trigger)</span><br><span class="line">     .setCss($selector, <span class="string">&#x27;cursor&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  (!key) &amp;&amp; eventListen($selector, trigger, $context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="根据传入属性创建tootips组件">根据传入属性创建tootips组件</h5><ul><li>使用<code>getBoundingClientRect()</code>方法获取目标组件的位置和宽高</li><li>tootips组件根据获取的位置和宽高进行窗口定位(<code>position: fixed</code>)</li><li>根据传入的属性设置tootips组件的样式</li><li>返回一个dom元素</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [renderContainer 构造html]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>options   [自定义参数]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>type   [渲染类型 -&gt; text | html]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>target   [渲染字符串]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">renderContainer</span>(<span class="params">$selector, tootipKey</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> type = utils.element.getData($selector, <span class="string">&#x27;tootip-type&#x27;</span>),</span><br><span class="line">      options = utils.element.getData($selector, <span class="string">&#x27;tootip-options&#x27;</span>),</span><br><span class="line">      trigger = utils.element.getData($selector, <span class="string">&#x27;tootip-trigger&#x27;</span>),</span><br><span class="line">      target = utils.element.getData($selector, <span class="string">&#x27;tootip-target&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 提取属性</span></span><br><span class="line">   <span class="keyword">var</span> randomKey = <span class="string">&#x27;_&#x27;</span> + <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>);</span><br><span class="line">   <span class="keyword">var</span> $wrapper = tootipKey ? utils.element.elementWrapper(<span class="string">&#x27;div[tootip-key=&#x27;</span>+tootipKey+<span class="string">&#x27;]&#x27;</span>) : <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">   <span class="keyword">var</span> cssStyle = options.style || &#123;&#125;;</span><br><span class="line">   <span class="keyword">var</span> styleSheet = options.css || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">   <span class="keyword">var</span> direction = options.direction || <span class="string">&#x27;top&#x27;</span>;</span><br><span class="line">   <span class="keyword">var</span> triangleArray = [<span class="string">&#x27;top&#x27;</span>, <span class="string">&#x27;left&#x27;</span>, <span class="string">&#x27;right&#x27;</span>,<span class="string">&#x27;bottom&#x27;</span>];</span><br><span class="line">   <span class="keyword">var</span> triangleClass = <span class="string">&#x27;triangle-&#x27;</span> +</span><br><span class="line">     triangleArray[triangleArray.length - <span class="number">1</span> - triangleArray.indexOf(direction)];</span><br><span class="line">   <span class="keyword">var</span> shadowClassMap = &#123;</span><br><span class="line">     <span class="attr">top</span>: <span class="string">&#x27;tootip-shadow-top-right&#x27;</span>,</span><br><span class="line">     <span class="attr">bottom</span>: <span class="string">&#x27;tootip-shadow-bottom-right&#x27;</span>,</span><br><span class="line">     <span class="attr">left</span>: <span class="string">&#x27;tootip-shadow-top-left&#x27;</span>,</span><br><span class="line">     <span class="attr">right</span>: <span class="string">&#x27;tootip-shadow-top-right&#x27;</span>,</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">var</span> rect = $selector.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">   utils.element.setCss($wrapper, <span class="string">&#x27;border&#x27;</span>, <span class="string">&#x27;solid 1px rgb(212, 212, 212)&#x27;</span>)</span><br><span class="line">    .setCss($wrapper, <span class="string">&#x27;position&#x27;</span>, <span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line">    .setCss($wrapper, <span class="string">&#x27;left&#x27;</span>, utils.renderX1(rect, direction))</span><br><span class="line">    .setCss($wrapper, <span class="string">&#x27;top&#x27;</span>, utils.renderY1(rect, direction))</span><br><span class="line">    .setAttr($wrapper, <span class="string">&#x27;tootip-key&#x27;</span>, tootipKey || randomKey)</span><br><span class="line">    .addClass($wrapper, triangleClass + <span class="string">&#x27; abnormal-tips-container &#x27;</span> + shadowClassMap[direction] + <span class="string">&#x27; &#x27;</span> + styleSheet);</span><br><span class="line">    utils.element.setAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>, tootipKey || randomKey);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 第一次创建dom结构</span></span><br><span class="line">   <span class="keyword">if</span> (!tootipKey &amp;&amp; trigger === <span class="string">&#x27;mouseover&#x27;</span>) &#123;</span><br><span class="line">     $wrapper.onmouseout = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       utils.actionDebounce(randomKey, hideTooTips, $selector);</span><br><span class="line">     &#125;;</span><br><span class="line">     $wrapper.onmouseover = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       utils.actionDebounce(randomKey, showTootips, $selector);</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">Object</span>.keys(cssStyle).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">attr</span>) </span>&#123;</span><br><span class="line">     utils.element.setCss($wrapper, attr, cssStyle[attr]);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   utils.element.html($wrapper, type === <span class="string">&#x27;html&#x27;</span> ? target : (<span class="string">&#x27;&lt;span&gt;&#x27;</span> + target +<span class="string">&#x27;&lt;/span&gt;&#x27;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> $wrapper;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><h5 id="绑定事件监听器">绑定事件监听器</h5><blockquote><p>对一个元素进行初始化后需要给tooltips组件绑定监听器(<code>click</code>或<code>mouse</code>事件)，让tootips组件能够响应鼠标的点击或是划过</p></blockquote><p>注意<code>utils.actionDebounce</code>方法运用了函数去抖的思想，防止在短时间内高频触发Tootip显示/隐藏时发生的调用混乱问题，多次调用时只响应最新的触发事件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [eventListen 进行事件监听]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>trigger [触发事件监听类型]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">eventListen</span>(<span class="params">$selector, _trigger, $context</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> trigger = (_trigger <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ? _trigger : [_trigger];</span><br><span class="line"></span><br><span class="line">   <span class="comment">// click事件监听</span></span><br><span class="line">   <span class="keyword">if</span>(trigger.includes(<span class="string">&#x27;click&#x27;</span>)) &#123;</span><br><span class="line">     ($context || $selector)</span><br><span class="line">       .onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (!utils.element.getData($selector, <span class="string">&#x27;isActivated&#x27;</span>)) &#123;</span><br><span class="line">           utils.actionDebounce(utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>), showTootips, $selector);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           utils.actionDebounce(utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>), hideTooTips, $selector);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125; </span><br><span class="line"></span><br><span class="line">   <span class="comment">// 鼠标事件监听</span></span><br><span class="line">   <span class="keyword">if</span>(trigger.includes(<span class="string">&#x27;mouseover&#x27;</span>)) &#123;</span><br><span class="line">     ($context || $selector)</span><br><span class="line">       .onmouseout = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         utils.actionDebounce(utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>), hideTooTips, $selector);</span><br><span class="line">       &#125;;</span><br><span class="line">     ($context || $selector)</span><br><span class="line">       .onmouseover = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         utils.actionDebounce(utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>), showTootips, $selector);</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>实现showTootips方法<br>在tootips组件中可以自定义显示html内容或text内容，tootips组件被添加到页面之前，tootips组件的宽度和高度是不可获取的，所以在show方法中需要对tootips元素进行二次定位，同样使用<code>getBoundingClientRect()</code>方法获取tootips元素坐标和宽高。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [showTootips 操作页面属性显示一个元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>tootipKey [可能已经生成过一次tooptips组件了]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">showTootips</span>(<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (utils.element.getData($selector, <span class="string">&#x27;isActivated&#x27;</span>)) <span class="keyword">return</span>;</span><br><span class="line">   <span class="keyword">var</span> tootipKey = utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>);</span><br><span class="line">   <span class="keyword">var</span> $dom = renderContainer($selector, tootipKey);</span><br><span class="line">   <span class="keyword">if</span> (!tootipKey) &#123;</span><br><span class="line">     <span class="built_in">document</span>.body.appendChild($dom);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    utils.element.removeClass($dom, <span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   utils.element.setData($selector, <span class="string">&#x27;isActivated&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> options = utils.element.getData($selector, <span class="string">&#x27;tootip-options&#x27;</span>);</span><br><span class="line">   <span class="keyword">var</span> rect = $dom.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">   utils.element</span><br><span class="line">     .setCss($dom, <span class="string">&#x27;top&#x27;</span>, utils.renderY2(rect, options.direction))</span><br><span class="line">     .setCss($dom, <span class="string">&#x27;left&#x27;</span>, utils.renderX2(rect, options.direction));</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><ul><li>实现hideTootips方法<br>hide方法的作用是将当前元素对应的tootips组件从页面移出，之前初始化的时候在目标元素和生成的tootips元素上设置了同一个<code>key</code>属性，现在可以根据<code>key</code>来移除每个目标元素对应的tootips元素。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * [hideTooTips 操作页面属性隐藏一个元素]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[$Object]&#125;</span> </span>$selector [一个页面元素]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">hideTooTips</span>(<span class="params">$selector</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> key = utils.element.getAttr($selector, <span class="string">&#x27;tootip-key&#x27;</span>);</span><br><span class="line">   <span class="keyword">var</span> $element = utils.element.elementWrapper(<span class="string">&#x27;div[tootip-key=&#x27;</span>+key+<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">   utils.element.addClass($element, <span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">   utils.element.setData($selector, <span class="string">&#x27;isActivated&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><h5 id="使用方式">使用方式</h5><blockquote><p>设置tootips方向、显示内容字符串(可以是html字符串)、触发方式(click / mouseover)、自定义css属性、自定义样式表。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Tootips.init((<span class="string">&#x27;#t1&#x27;</span>), &#123;</span><br><span class="line">  <span class="attr">trigger</span>: <span class="string">&#x27;mouseover&#x27;</span>, <span class="comment">// 触发方式</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;html&#x27;</span>, <span class="comment">// 内容显示类型</span></span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;&lt;h3&gt;header&lt;/h3&gt;&lt;p&gt;body&lt;/p&gt;&#x27;</span>, <span class="comment">// 内容显示值</span></span><br><span class="line">  <span class="attr">direction</span>: <span class="string">&#x27;top&#x27;</span>, <span class="comment">// 显示方向</span></span><br><span class="line">  <span class="attr">style</span>: &#123; <span class="comment">// tootips组件自定义样式</span></span><br><span class="line">    <span class="string">&#x27;font-size&#x27;</span>: <span class="string">&#x27;1rem&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;min-width&#x27;</span>: <span class="string">&#x27;5rem&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;padding&#x27;</span>: <span class="string">&#x27;5px 10px&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;border-radius&#x27;</span>: <span class="string">&#x27;5px&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">css</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// tootips组件自定义样式表</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="总结">总结</h4><hr><ul><li>tootips组件的坐标完全使用javasript来获取和设置</li><li>tootips组件的定位类型为<code>position: fixed</code>，不受页面布局影响</li><li><code>getBoundingClientRect()</code>方法可以获取目标元素的坐标、宽高等数据</li><li>tootips组件支持传入自定义样式</li><li>tootips组件支持显示含有html标签的字符串和普通字符串</li><li>tootips组件支持设置触发方式(<code>click</code> / <code>mouseover</code>)</li></ul><h5 id="感谢阅读">感谢阅读</h5>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简单实现一个Javascript动画处理类</title>
      <link href="/blogs/2018/11/05/3fd62b7c.html/"/>
      <url>/blogs/2018/11/05/3fd62b7c.html/</url>
      
        <content type="html"><![CDATA[<h4 id="目录">目录</h4><ol><li><p>预览图</p></li><li><p>代码实现</p></li><li><p>总结</p></li></ol><h4 id="预览图">预览图</h4><hr><blockquote><p>Gif预览图录制时帧数较低，实际浏览器上运行时会更流畅 ~</p></blockquote><p><a href="https://github.com/nojsja/javascript-learning/tree/master/js-animation">=&gt; 源代码</a></p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="animation.gif"  alt="animation.gif"></p><h4 id="代码实现">代码实现</h4><hr><h5 id="缓动函数">缓动函数</h5><blockquote><p>涉及一些数学原理，感兴趣的可以单独了解一下。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [tween 缓动算法]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[Number]&#125;</span>  </span>t [动画已经消耗的时间]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span>  </span>b [目标开始的位置]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[String]&#125;</span>  </span>c [目标开始位置和结束位置的距离]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;[Number]&#125;</span>  </span>d [动画总持续时间]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> tween = &#123;</span><br><span class="line">  <span class="attr">linear</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance*time/duration + start; &#125;,</span><br><span class="line">  <span class="attr">easeIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration ) * time + start; &#125;,</span><br><span class="line">  <span class="attr">strongEaseIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time, start, distance, duration</span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration ) * time * time * time * time + start; &#125;,</span><br><span class="line">  <span class="attr">strongEaseOut</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time, start, distance, duration</span>) </span>&#123; <span class="keyword">return</span> distance * ( ( time = time / duration - <span class="number">1</span>) * time * time * time * time + <span class="number">1</span> ) + start; &#125;,</span><br><span class="line">  <span class="attr">sinEaseIn</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> time, start, distance, duration </span>) </span>&#123; <span class="keyword">return</span> distance * ( time /= duration) * time * time + start; &#125;,</span><br><span class="line">  <span class="attr">sinEaseOut</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time,start,distance,duration</span>)</span>&#123; <span class="keyword">return</span> distance * ( ( time = time / duration - <span class="number">1</span>) * time * time + <span class="number">1</span> ) + start; &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="帧请求函数兼容写法">帧请求函数兼容写法</h5><blockquote><p>requestAnimationFrame是浏览器用于定时循环操作的一个接口，类似于setTimeout，主要用途是按帧对网页进行重绘。设置这个API的目的是为了让各种网页动画效果（DOM动画、Canvas动画、SVG动画、WebGL动画）能够有一个统一的刷新机制，从而节省系统资源，提高系统性能，改善视觉效果。代码中使用这个API，就是告诉浏览器希望执行一个动画，让浏览器在下一个动画帧安排一次网页重绘。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动画帧请求函数兼容写法</span></span><br><span class="line"><span class="built_in">window</span>.requestAnimationFrame = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span>  <span class="built_in">window</span>.requestAnimationFrame       ||</span><br><span class="line">          <span class="built_in">window</span>.webkitRequestAnimationFrame ||</span><br><span class="line">          <span class="built_in">window</span>.mozRequestAnimationFrame    ||</span><br><span class="line">          <span class="built_in">window</span>.oRequestAnimationFrame      ||</span><br><span class="line">          <span class="built_in">window</span>.msRequestAnimationFrame     ||</span><br><span class="line">          <span class="function"><span class="keyword">function</span>(<span class="params"> callback </span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">window</span>.setTimeout(callback, <span class="number">1000</span> / <span class="number">60</span>);</span><br><span class="line">          &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h5 id="编写Animation动画类">编写Animation动画类</h5><blockquote><p>使用了了ES5语法，为了直接兼容浏览器，ES6的语法会更简洁，代码零散度更低。</p></blockquote><ul><li>初始化执行动画的某个dom元素</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------- 动画控制类 ------------------- */</span></span><br><span class="line"><span class="keyword">var</span> Animation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.store = &#123; <span class="comment">// status store</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 初始化处理元素 ------------------- */</span></span><br><span class="line">Animation.prototype.setTarget = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.querySelector(selector);</span><br><span class="line">  <span class="keyword">if</span> (element) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector] = &#123;</span><br><span class="line">      <span class="attr">selector</span>: selector,</span><br><span class="line">      <span class="attr">element</span>: <span class="built_in">document</span>.querySelector(selector),</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;pending&#x27;</span>,</span><br><span class="line">      <span class="attr">queue</span>: [</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">timeStart</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">positionStart</span>: &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">positionEnd</span>: &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>动画调用主要函数<code>update</code>的编写</li></ul><blockquote><p>运用了设计模式中<code>享元模式</code>的思想来分离变化(<code>Animation.store属性</code>)和不变的部分。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [start 开始动画]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>selector [选择器]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>func     [缓动动画]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.start = <span class="function"><span class="keyword">function</span> (<span class="params">selector, func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> that = <span class="built_in">this</span>;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="built_in">this</span>.store[selector];</span><br><span class="line">  target.status = <span class="string">&#x27;running&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 帧调用函数</span></span><br><span class="line">  that.update(&#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;, selector);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [update 更新位置]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>selector [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.update =  <span class="function"><span class="keyword">function</span> (<span class="params">position, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="built_in">this</span>.store[selector],</span><br><span class="line">    that = <span class="built_in">this</span>,</span><br><span class="line">    timeUsed,</span><br><span class="line">    positionX, positionY;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!target || !target.queue.length) &#123;</span><br><span class="line">    target.status = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reset position</span></span><br><span class="line">  target.element.style.left = position.x + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  target.element.style.top = position.y + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// position</span></span><br><span class="line">  target.positionStart = &#123;</span><br><span class="line">    <span class="attr">x</span>: position.x,</span><br><span class="line">    <span class="attr">y</span>: position.y,</span><br><span class="line">  &#125;;</span><br><span class="line">  target.positionEnd = &#123;</span><br><span class="line">    <span class="attr">x</span>: position.x + target.queue[<span class="number">0</span>].x,</span><br><span class="line">    <span class="attr">y</span>: position.y + target.queue[<span class="number">0</span>].y,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// time</span></span><br><span class="line">  target.timeStart = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归调用</span></span><br><span class="line">  <span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span> (<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target.timeStart === <span class="literal">null</span>) target.timeStart = time;</span><br><span class="line">    timeUsed = time - target.timeStart;</span><br><span class="line">    <span class="comment">// 当前动画完成</span></span><br><span class="line">    <span class="keyword">if</span> (timeUsed &gt;= target.queue[<span class="number">0</span>].duration) &#123;</span><br><span class="line">      target.queue.shift();</span><br><span class="line">      <span class="comment">// 误差矫正</span></span><br><span class="line">      that.step(target.element, target.positionEnd.x, target.positionEnd.y);</span><br><span class="line">      target.status = <span class="string">&#x27;running&#x27;</span>;</span><br><span class="line">      <span class="comment">// var position = target.element.getBoundingClientRect();</span></span><br><span class="line">      <span class="keyword">var</span> position = &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="built_in">parseInt</span>(target.element.style.left),</span><br><span class="line">        <span class="attr">y</span>: <span class="built_in">parseInt</span>(target.element.style.top),</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// 下一个动画</span></span><br><span class="line">      that.update(position, selector);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算元素坐标</span></span><br><span class="line">    positionX = target.queue[<span class="number">0</span>].func(</span><br><span class="line">      timeUsed,</span><br><span class="line">      target.positionStart.x,</span><br><span class="line">      target.positionEnd.x - target.positionStart.x,</span><br><span class="line">      target.queue[<span class="number">0</span>].duration,</span><br><span class="line">    );</span><br><span class="line">    positionY = target.queue[<span class="number">0</span>].func(</span><br><span class="line">      timeUsed,</span><br><span class="line">      target.positionStart.y,</span><br><span class="line">      target.positionEnd.y - target.positionStart.y,</span><br><span class="line">      target.queue[<span class="number">0</span>].duration,</span><br><span class="line">    );</span><br><span class="line">    that.step(target.element, positionX, positionY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 递归帧函数调用</span></span><br><span class="line">    requestAnimationFrame(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  requestAnimationFrame(callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>其它一些方法(部分暂未实现)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [step dom操作]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[DOM]&#125;</span> </span>element [dom 元素]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Number]&#125;</span> </span>x        [x坐标]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Number]&#125;</span> </span>y        [y坐标]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.step = <span class="function"><span class="keyword">function</span> (<span class="params">element, x, y</span>) </span>&#123;</span><br><span class="line">  element.style.left = x + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">  element.style.top = y + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 暂停动画 ------------------- */</span></span><br><span class="line">Animation.prototype.pause = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 尚待实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 结束动画 ------------------- */</span></span><br><span class="line">Animation.prototype.stop = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 尚待实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [push 加入动画队列]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[String]&#125;</span> </span>selector [dom选择器]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>conf     [相对位置数据]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Animation.prototype.push = <span class="function"><span class="keyword">function</span> (<span class="params">selector, conf</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.push(&#123;</span><br><span class="line">      <span class="attr">x</span>: conf.x,</span><br><span class="line">      <span class="attr">y</span>: conf.y,</span><br><span class="line">      <span class="attr">duration</span>: conf.duration || <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">func</span>: tween[conf.func] || tween[<span class="string">&#x27;linear&#x27;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 动画出队列 ------------------- */</span></span><br><span class="line">Animation.prototype.pop = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.pop();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------- 清空动画队列 ------------------- */</span></span><br><span class="line">Animation.prototype.clear = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.store[selector]) &#123;</span><br><span class="line">    <span class="built_in">this</span>.store[selector].queue.length = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="Animation调用方式">Animation调用方式</h5><ol><li>初始化元素</li><li>插入多个动画数据(坐标相对值、动画执行时间、缓动方式)</li><li>开始执行动画</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anime = <span class="keyword">new</span> Animation();</span><br><span class="line">anime.setTarget(<span class="string">&#x27;#animationTarget&#x27;</span>);</span><br><span class="line"><span class="comment">// 右下角移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: <span class="number">50</span>, <span class="attr">y</span>: <span class="number">50</span>, <span class="attr">duration</span>: <span class="number">1000</span>, <span class="attr">func</span>: <span class="string">&#x27;easeIn&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// 右上角移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: -<span class="number">50</span>, <span class="attr">y</span>: -<span class="number">50</span>, <span class="attr">duration</span>: <span class="number">500</span>, <span class="attr">func</span>: <span class="string">&#x27;linear&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// 横向移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: <span class="number">50</span>, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">duration</span>: <span class="number">1000</span>, <span class="attr">func</span>: <span class="string">&#x27;easeIn&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// 纵向移动50px</span></span><br><span class="line">anime.push(<span class="string">&#x27;#animationTarget&#x27;</span>, &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">50</span>, <span class="attr">duration</span>: <span class="number">500</span>, <span class="attr">func</span>: <span class="string">&#x27;linear&#x27;</span> &#125;);</span><br><span class="line"><span class="comment">// 开始执行动画</span></span><br><span class="line">anime.start(<span class="string">&#x27;#animationTarget&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="总结">总结</h4><hr><p>JavaScript动画的性能比CSS动画低很多，平时实际做页面时应该尽量使用CSS3和Canvas来实现动画效果，但是一名合格的JSER，也应该对Js的动画实现原理熟知，知道怎样优化动画性能，以及运用适合的设计模式优化代码结构。</p><h5 id="感谢阅读">感谢阅读</h5>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> animation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用ES5实现ES6中的Promise</title>
      <link href="/blogs/2018/10/31/27676ad7.html/"/>
      <url>/blogs/2018/10/31/27676ad7.html/</url>
      
        <content type="html"><![CDATA[<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="lifeIsStrange.jpg"  alt="life is strange"></p><p><a href="https://github.com/nojsja/promise-nojsja">源代码 =&gt; github / nojsja / promise-self</a></p><h3 id="目录">目录</h3><ol><li>谈谈Promise</li><li>Promise分析和实现</li><li>总结</li></ol><h3 id="谈谈Promise">谈谈Promise</h3><hr><blockquote><p>Promise 对象是一个代理对象（代理一个值），被代理的值在Promise对象创建时可能是未知的。<br>它允许你为异步操作的成功和失败分别绑定相应的处理方法（handlers）。 这让异步方法可以像<br>同步方法那样返回值，但并不是立即返回最终执行结果，而是一个能代表未来出现的结果的promise对象。</p></blockquote><blockquote><p>pending 状态的 Promise 对象可能触发fulfilled 状态并传递一个值给相应的状态处理方法，<br>也可能触发失败状态（rejected）并传递失败信息。当其中任一种情况出现时，Promise 对象的<br>then 方法绑定的处理方法（handlers ）就会被调用（then方法包含两个参数：onfulfilled<br>和 onrejected，它们都是 Function 类型。当Promise状态为fulfilled时，调用 then 的<br>onfulfilled 方法，当Promise状态为rejected时，调用 then 的 onrejected 方法，<br>所以在异步操作的完成和绑定处理方法之间不存在竞争）。</p></blockquote><h4 id="一个-Promise有以下几种状态">一个 Promise有以下几种状态</h4><ul><li>pending: 初始状态，不是成功或失败状态。</li><li>fulfilled: 意味着操作成功完成。</li><li>rejected: 意味着操作失败。</li></ul><h4 id="Javascript事件循环">Javascript事件循环</h4><p>关于js线程和事件循环可以看<a href="https://zhuanlan.zhihu.com/p/33058983">这篇文章</a></p><ul><li>创建Promise时传入的函数的执行应该延迟到下一次事件循环中，而不应该在主线程执行栈中被调用。</li><li>Promise.then传入的onResolve, onReject函数的执行也应该延迟到下一次事件循环。</li></ul><p>具体表现可以看下一段代码，即使是promise对象中没有异步操作，控制台也会先打印b再打印a：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  resolve(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// result =&gt; b a</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Promise-all-iterable">Promise.all(iterable)</h4><p>这个方法返回一个新的promise对象，该promise对象当iterable参数对象里所有的promise对象<br>都成功的时候才会触发成功，一旦有任何一个iterable里面的promise对象失败则立即触发该promise<br>对象的失败。这个新的promise对象在触发成功状态以后，会把一个包含iterable里所有promise返回值<br>的数组作为成功回调的返回值，顺序跟iterable的顺序保持一致；如果这个新的promise对象触发了失败<br>状态，它会把iterable里第一个触发失败的promise对象的错误信息作为它的失败错误信息。Promise.all方法常被用于处理多个promise对象的状态集合。</p><h4 id="Promise-race-iterable">Promise.race(iterable)</h4><p>当iterable参数里的任意一个子promise被成功或失败后，父promise马上也会用子promise的成功返回<br>值或失败详情作为参数调用父promise绑定的相应句柄，并返回该promise对象。</p><h4 id="Promise-reject-value-Promise-resolve-value">Promise.reject(value) / Promise.resolve(value)</h4><p>返回一个状态为失败(成功)的Promise对象，并将给定的失败(成功)信息传递给对应的处理方法。<br>如果该值是thenable(即，带有then方法的对象)，返回的Promise对象的最终状态由then方法执行决定；<br>否则的话(该value为空，基本类型或者不带then方法的对象)，返回的Promise对象状态为fulfilled，<br>并且将该value传递给对应的then方法。通常而言，如果你不知道一个值是否是Promise对象，<br>使用Promise.resolve(value) 来返回一个Promise对象,这样就能将该value以Promise对象形式使用。</p><h3 id="Promise分析和实现">Promise分析和实现</h3><hr><h4 id="实现难点分析">实现难点分析</h4><p>在思考实现原理的时候，Promise.then这个方法花了我最长的时间，一个Promise对象可以使用then方法接收一个成功的回调函数和一个错误的回调函数，哪个回调函数的最终被执行取决于当前Promise对象的最终状态，可以使用promise.then(fn1, fn2).then(fn3, fn4).then(fn5, fn6)这种链式回调连接无数个异步方法。如果前一个then方法中的 success callback 或 fail callback 也返回了一个Promise对象的话，那么当前Promise对象的状态最终还是要取决于返回的这个Promise对象，就像发生了状态之间的传递一样。并且在这样的条件下，各个then方法链接的函数仍然能保持顺序依次执行。</p><h4 id="难点分析和解决">难点分析和解决</h4><p>通过以上对then方法的分析，我们可以看出，promise.then方法的状态都是独立的，promise.then的回调方法中可以再次返回一个Promise对象，我们姑且把这一过程称为父Promise和子Promise的状态传递和继承，所以在设计then方法时应当考虑then方法返回的其实应该是一个具有独立状态的Promise对象，只不过该Promise对象的状态还需要看then方法传入的两个回调函数是不是返回了另一个Promise对象，如果返回了，那么就要发生状态传递。我们可以用设计模式中观察者模式的思想来定义一个Promise对象，Promise对象可以有三种状态，成功和失败状态的变化会触发各自对应的观察者函数事件，所以每一个Promise.then方法其实就是在对一个Promise对象做状态事件注册，事件注册和状态改变这两个操作是相互独立的。那么如何把当前父Promise的对象状态和then函数中返回的Promise对象的状态联系起来呢？这个逻辑就是下面代码中的<code>analysisPromise</code>方法，它的作用就是分析一个回调的返回值，将当前Promise对象状态改变的方法<code>reject</code>和<code>resolve</code>递归传递下去，各个不同的调用栈对应各个不同的执行上下文，但是目的只有一个就是改变最初传入的那个Promise对象的状态。</p><ul><li>promise.then的设计</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [then 应该返回一个全新的Promise对象，不应该与当前Promise存在功能耦合]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>successFn [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span> </span>errorFn   [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">Promise</span>.prototype.then = <span class="function"><span class="keyword">function</span> (<span class="params">successCallback, errorCallback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> promise, x;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self.status === <span class="string">&#x27;fulfilled&#x27;</span>) &#123;</span><br><span class="line">    promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// delay to next event loop</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          x = successCallback(self.value);</span><br><span class="line">          analysisPromise(x, resolve, reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (self.status === <span class="string">&#x27;rejected&#x27;</span>) &#123;</span><br><span class="line">    promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// delay to next event loop</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          x = errorCallback(self.reason);</span><br><span class="line">          analysisPromise(x, resolve, reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (self.status === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">    promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 延迟到下一个事件循环</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        self.onFulfilledCallbacks.push(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            x = successCallback(self.value);</span><br><span class="line">            <span class="comment">// 分析返回值 然后更改 当前promise状态</span></span><br><span class="line">            analysisPromise(x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            reject(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        self.onRejectedCallbacks.push(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            x = errorCallback ? errorCallback(self.reason) : <span class="literal">undefined</span>;</span><br><span class="line">            <span class="comment">// 分析返回值 然后更改 当前promise状态</span></span><br><span class="line">            analysisPromise(x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            reject(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>analysisPromise方法的设计</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [analysisPromise 使用递归将状态控制权转移]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Any]&#125;</span> </span>x        [value]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Func]&#125;</span> </span>resolve [get into success state]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[Func]&#125;</span> </span>reject  [get into fail state]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> analysisPromise = <span class="function"><span class="keyword">function</span> (<span class="params">x, resolve, reject</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> then, y;</span><br><span class="line">  <span class="keyword">if</span> (x !== <span class="literal">undefined</span> &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>)) &#123;</span><br><span class="line">    then = x.then;</span><br><span class="line">    <span class="comment">// obj Promise</span></span><br><span class="line">    <span class="keyword">if</span> (then &amp;&amp; <span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      then.call(x, <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// callback return a promise</span></span><br><span class="line">        analysisPromise(value, resolve, reject);</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">// normal</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      resolve(x);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// normal</span></span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    resolve(x);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="其它部分的实现">其它部分的实现</h4><ul><li>catch方法<br>这边只是简单的捕获了一下错误然后调用回调函数即可。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.prototype.catch = <span class="function"><span class="keyword">function</span> (<span class="params">handleError</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.status === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.onRejectedCallbacks.push(handleError);</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.reason &amp;&amp; handleError(<span class="built_in">this</span>.reason);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>all方法<br>all方法首先判断可以通过promise.all([promise]).then这种形式调用，那么all也应该返回一个Promise对象，这个对象的成功状态取决于传入的各个promise的成功状态，失败状态只取决于其中一个传入的最先失败的的promise，所以应该遍历和分析所有传入的promise的状态情况，和设计then方法的时候一样需要考虑状态传递的问题，将各个promise产生的计算值存入一个数组，一旦有promise失败，马上返回失败信息，结束整个promise对象的状态监听。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all = <span class="function"><span class="keyword">function</span> (<span class="params">pArray</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rArray = [];</span><br><span class="line">  <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    pArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">pr, i</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pr <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">          pr.then(<span class="function"><span class="keyword">function</span> (<span class="params">value1</span>) </span>&#123;</span><br><span class="line">            analysisPromise(value1, <span class="function"><span class="keyword">function</span> (<span class="params">value2</span>) </span>&#123;</span><br><span class="line">              rArray[i] = value2;</span><br><span class="line">              <span class="keyword">if</span> (rArray.length === pArray.length) &#123;</span><br><span class="line">                resolve(rArray);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;, reject);</span><br><span class="line"></span><br><span class="line">          &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          rArray[i] = pr;</span><br><span class="line">          <span class="keyword">if</span> (rArray.length === pArray.length) &#123;</span><br><span class="line">            resolve(rArray);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>race方法<br>race方法就更简单了，考虑状态的传递之后，传入的任意一个promise的状态改变都会直接表现为整个promise对象的状态最终值。all方法和race方法，前者是状态协同，后者状态竞争。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race = <span class="function"><span class="keyword">function</span> (<span class="params">pArray</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rArray = [];</span><br><span class="line">  <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    pArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">pr, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pr <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">          pr.then(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">            analysisPromise(value, resolve, reject);</span><br><span class="line">          &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">            reject(error);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          rArray[i] = pr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>静态方法 Promise.resolve 和 Promise.reject<br>直接返回一个最终态为成功或失败的promise对象即可。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      resolve(value);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Promise</span>.reject = <span class="function"><span class="keyword">function</span> (<span class="params">reason</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      reject(reason);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="总结">总结</h3><hr><p>Promise实现的难点其实是怎样考虑那个状态传递的过程(<code>analysisPromise</code>方法的实现)，各种回调的设计容易让人混乱，需要考虑各个promise对象的<code>原子性</code>同时又要保持各个可能出现相互嵌套的promise对象之间的依赖和联系。如果结构设计地比较合理的话，<code>Promise.all</code>、<code>Promise.race</code>这两个方法是很容易被实现出来的，因为它们只是对多个promise对象的状态管理而已。</p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> promise </tag>
            
            <tag> es6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原生Js实现瀑布流效果</title>
      <link href="/blogs/2018/07/09/5587aa09.html/"/>
      <url>/blogs/2018/07/09/5587aa09.html/</url>
      
        <content type="html"><![CDATA[<h4 id="盗用的效果图">盗用的效果图</h4><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="waterfall-1.gif"  alt="preview"></p><h4 id="效果分析">效果分析</h4><p>瀑布流中图片的宽度都是固定的，但是高度需要设置为auto以使图片不变形，高度不固定。首先想到能不能用float属性让图片流动，想象中很美好，实际效果如下，可以看到因为第三个元素的高度问题，第二行元素流动时被第三个元素挡住，导致了布局错乱。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="waterfall-2.jpg"  alt="float"></p><p>看看百度图片是怎么实现图片布局的，如下图，可以看出百度用了讨巧的办法，图片跟我们这个瀑布流的图片的宽高设定正好相反，百度图片的列数同样固定，但是高度也固定，而宽度不固定，这样处理的话正好能避免上面那个float流动的问题，这个… 好吧 最后我们还是来说说怎样实现我们效果图中那样的瀑布流布局。</p><p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="waterfall-3.jpg"  alt="baidu"></p><h4 id="解决方法">解决方法</h4><ul><li>html结构如下，需要说明的是container元素是相对定位，每个item元素都是绝对定位，这样我们通过设置item元素的top和left值就能改变它们的位置了，图片的宽度是100%(这儿思考一下为什么img的父级需要设置box-sizing: border-box)。</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 页面结构 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;water-fall-container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;water-fall-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;url&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;water-fall-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;url&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>我把主要逻辑写成了构造函数的形式，这样一个页面中通过传入不同的参数就能创建多个瀑布流实例。构造函数中我们依次需要传入容器元素本身、子元素的选择器(.water-fall-item)、<br>每一列自定义的宽度(单位是px)、图片之间间隔的距离(实际上是padding-right 和 padding-bottom 的值，单位px)，通过这些指标我们首先能够计算出容器元素的宽度，<br>(容器宽度 / 列宽) === 总共的列数，最后在step函数里就是布局的代码了，step做的事儿就是遍历容器元素下的每个item元素，设置它们的宽度、高度、top值、left值以及padding值，<br>其中第一行元素top值固定为零，left值依次根据数组下标再乘以列宽，到了第二行之后的元素就省事儿了，直接设置当前元素的top值为 对应的那个上一排元素的top值+上一排元素的高度值(clientHeight)，而left值每一排都相同，因为列宽和列数是固定的。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [WaterFall 图片瀑布流构造函数]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;DomElement&#125;</span> </span>father   [瀑布流的容器元素]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>childClass   [瀑布流子元素类名选择器 如: .water-fall-item]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Number&#125;</span> </span>columnWidth  [设定每一列的宽度，单位: px]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;Number&#125;</span> </span>paddingWidth [设定图片之间的间隔距离， 单位: px]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaterFall</span>(<span class="params">father, childClass, columnWidth, paddingWidth</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.$container = father;  <span class="comment">// 容器</span></span><br><span class="line">  <span class="built_in">this</span>.childSelector = childClass;  <span class="comment">// 子代img选择器</span></span><br><span class="line">  <span class="built_in">this</span>.children = [];  <span class="comment">// 子代img</span></span><br><span class="line">  <span class="built_in">this</span>.columnWidth = columnWidth;  <span class="comment">// 单列宽度</span></span><br><span class="line">  <span class="built_in">this</span>.paddingWidth = paddingWidth + <span class="string">&#x27;px&#x27;</span>;  <span class="comment">// 图片之间的间隔距离</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.totalWidth = <span class="built_in">this</span>.$container.clientWidth;  <span class="comment">// 容器宽度</span></span><br><span class="line">  <span class="built_in">this</span>.columnNum = ~~(<span class="built_in">this</span>.totalWidth / <span class="built_in">this</span>.columnWidth);  <span class="comment">// 列数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用多次</span></span><br><span class="line">  <span class="built_in">this</span>.step = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.totalWidth = <span class="built_in">this</span>.$container.clientWidth;</span><br><span class="line">    <span class="built_in">this</span>.columnNum = ~~(<span class="built_in">this</span>.totalWidth / <span class="built_in">this</span>.columnWidth);</span><br><span class="line">    <span class="built_in">this</span>.children = <span class="built_in">this</span>.$container.querySelectorAll(<span class="built_in">this</span>.childSelector);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.children.length; i++) &#123;</span><br><span class="line">      <span class="built_in">this</span>.children[i].style.width = <span class="built_in">this</span>.columnWidth + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">      <span class="built_in">this</span>.children[i].style.height = <span class="string">&#x27;auto&#x27;</span>;</span><br><span class="line">      <span class="built_in">this</span>.children[i].style.paddingRight = <span class="built_in">this</span>.paddingWidth;</span><br><span class="line">      <span class="built_in">this</span>.children[i].style.paddingBottom = <span class="built_in">this</span>.paddingWidth;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 每行第一个设置左padding</span></span><br><span class="line">      <span class="keyword">if</span> (i % <span class="built_in">this</span>.columnNum === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.children[i].style.paddingLeft = <span class="built_in">this</span>.paddingWidth;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 第一行 和 其它行的不同处理</span></span><br><span class="line">      <span class="keyword">if</span> (i &lt; <span class="built_in">this</span>.columnNum) &#123;</span><br><span class="line">        <span class="built_in">this</span>.children[i].style.left = (i) * <span class="built_in">this</span>.columnWidth + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">        <span class="built_in">this</span>.children[i].style.top = (i) * <span class="number">0</span> + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.children[i].style.left = <span class="built_in">this</span>.children[i - <span class="built_in">this</span>.columnNum].style.left;</span><br><span class="line">        <span class="built_in">this</span>.children[i].style.top = +<span class="built_in">this</span>.children[i - <span class="built_in">this</span>.columnNum].style.top.replace(<span class="string">&#x27;px&#x27;</span>, <span class="string">&#x27;&#x27;</span>) +</span><br><span class="line">                                      <span class="built_in">this</span>.children[i - <span class="built_in">this</span>.columnNum].clientHeight + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>再看看从页面图片加载到生成瀑布流实例我是怎样处理的，前面部分先通过一组图片url地址将所有图片加载到页面上，中间设定参数后生成一个瀑布流实例，最后重点是<br>弄清楚我们需要在什么时候调用waterfall.step()函数来处理页面中item元素的重排。我可能用了个比价笨的办法：在所有图片加载完成之前 使用定时器 轮询每个图片的加载情况，并进行布局，所有图片加载完后就取消定时器。最后别忘记 窗口拖动后也要重新布局，在这儿我用了一个函数节流的思想，防止resize短时间内多次触发，改善页面性能，至于节流函数怎么写，大家可以看看相关概念然后自己实现一个，so easy !</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [waterFallInit 瀑布流初始化]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>wData [图片url的数组]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> waterFallInit = <span class="function"><span class="keyword">function</span> (<span class="params">wData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">  <span class="keyword">var</span> div, img, timer, $imgs, length, index = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 载入图片</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; wData.length; i++) &#123;</span><br><span class="line">    div = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">    img = <span class="built_in">document</span>.createElement(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    div.setAttribute(<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;water-fall-item&#x27;</span>);</span><br><span class="line">    img.setAttribute(<span class="string">&#x27;src&#x27;</span>, wData[i]);</span><br><span class="line">    div.appendChild(img);</span><br><span class="line">    fragment.appendChild(div);</span><br><span class="line">    <span class="keyword">if</span> (i === wData.length - <span class="number">1</span>) &#123;</span><br><span class="line">      domMap.$waterFall.appendChild(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个瀑布流实例</span></span><br><span class="line">  <span class="keyword">var</span> waterfall = <span class="keyword">new</span> WaterFall(domMap.$waterFall, <span class="string">&#x27;.water-fall-item&#x27;</span>, <span class="number">200</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 轮询所有图片的加载状态</span></span><br><span class="line">  timer = <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    index=<span class="number">0</span>;</span><br><span class="line">    $imgs = domMap.$waterFall.querySelectorAll(<span class="string">&#x27;.water-fall-item &gt; img&#x27;</span>);</span><br><span class="line">    length = $imgs.length;</span><br><span class="line">    <span class="comment">// 统计图片加载完成的数量</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; $imgs.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> ($imgs[i].complete) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++index === length) <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    waterfall.step();</span><br><span class="line">  &#125;, <span class="number">250</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 窗口拖动</span></span><br><span class="line">   <span class="built_in">window</span>.onresize =  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">     Utils.FnDelay(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       waterfall.step();</span><br><span class="line">     &#125;, <span class="number">800</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="感谢阅读">感谢阅读</h4><p><em>代码存放在github：<a href="https://github.com/nojsja/javascript-learning/tree/master/normal/water-fall-layout">nojsja</a></em></p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模仿RequireJs的用法写一个低配版的模块加载器</title>
      <link href="/blogs/2018/01/04/d2276f2f.html/"/>
      <url>/blogs/2018/01/04/d2276f2f.html/</url>
      
        <content type="html"><![CDATA[<h4 id="Contents">Contents</h4><ol><li>前言</li><li>回顾RequireJs的基本用法</li><li>实现原理</li><li>使用方法</li><li>总结</li></ol><h4 id="前言">前言</h4><hr><p>前段时间一直想用单页开发技术写一个自己的个人网站(使用es2015)，写了一部分之后，发现单页应用因为只有一个页面，所以第一次加载index.html时就要下载所有js文件，并且为了好管理各个部分的状态，需要划分页面的各个功能区为各个模块，es2015本身是不支持一些模块规范的(比如AMD、CMD、CommonJs等)，所以只能这样模拟实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// global</span></span><br><span class="line"><span class="keyword">var</span> spa = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;...&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// module blog</span></span><br><span class="line">spa.blog = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">do1</span>: do1,</span><br><span class="line">    <span class="attr">do2</span>: do2,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// module model</span></span><br><span class="line">spa.model = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;...&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// module shell</span></span><br><span class="line">spa.model = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;...&#125;)();</span><br></pre></td></tr></table></figure><p>并且各个模块之间又存在一些依赖关系，在index.html里面写script标签来载入模块时需要写很多个，同时也要根据依赖关系来确定书写顺序，页面逻辑混乱，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.utils.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.model.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.mock.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.chat.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.blog.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.action.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/javascripts/spa.shell.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>之前用过RequireJs(一个流行的JavaScript模块加载器)，它是用同构js的架构来写的，所以node.js环境下也能使用。我想自己可以尝试一下写一个低配版的js模块加载器 <a href="https://github.com/nojsja/requireJs-nojsja">requireJs-nojsja</a> 来应付一下我这个单页网站，当然只是大致模仿了主要功能。</p><h4 id="回顾RequireJs的基本用法">回顾RequireJs的基本用法</h4><hr><ol><li>配置模块信息</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">requirejs.config(&#123;</span><br><span class="line">    <span class="attr">baseUrl</span>: <span class="string">&#x27;/javascripts&#x27;</span>,  <span class="comment">// 配置根目录</span></span><br><span class="line">    <span class="attr">paths</span>: &#123;</span><br><span class="line">      <span class="attr">moduleA</span>: <span class="string">&#x27;a.js&#x27;</span>,</span><br><span class="line">      <span class="attr">moduleB</span>: <span class="string">&#x27;b.js&#x27;</span>,</span><br><span class="line">      <span class="attr">moduleC</span>: <span class="string">&#x27;c.js&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">shim</span>: &#123;  <span class="comment">// 配置不遵循amd规范的模块</span></span><br><span class="line">      <span class="attr">moduleC</span>: &#123;</span><br><span class="line">        <span class="attr">exports</span>: <span class="string">&#x27;log&#x27;</span>,</span><br><span class="line">        <span class="attr">deps</span>: [<span class="string">&#x27;moduleA&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>定义一个模块</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define(name, [<span class="string">&#x27;moduleA&#x27;</span>, <span class="string">&#x27;moduleB&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>)</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">do</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      a.doSomething();</span><br><span class="line">      b.doAnother();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li>引用一个模块</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引用模块</span></span><br><span class="line"><span class="built_in">require</span>([<span class="string">&#x27;moduleA&#x27;</span>, <span class="string">&#x27;moduleB&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  a.doSomething();</span><br><span class="line">  b.doAnother();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="实现原理">实现原理</h4><hr><ol><li>config方法确定各个模块的依赖关系</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 记录模块访问地址和模块的依赖等信息 */</span></span><br><span class="line">Require.config(&#123;</span><br><span class="line">  <span class="attr">baseUrl</span>: <span class="string">&#x27;/javascripts/&#x27;</span>,</span><br><span class="line">  <span class="attr">paths</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;moduleA&#x27;</span>: <span class="string">&#x27;./moduleA.js&#x27;</span>,  <span class="comment">// 相对于当前目录</span></span><br><span class="line">    <span class="string">&#x27;moduleB&#x27;</span>: <span class="string">&#x27;/javascripts/moduleB.js&#x27;</span>,  <span class="comment">// 不使用baseUrl</span></span><br><span class="line">    <span class="string">&#x27;moduleC&#x27;</span>: <span class="string">&#x27;moduleC.js&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;moduleD&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;moduleD.js&#x27;</span>,</span><br><span class="line">      <span class="attr">deps</span>: [<span class="string">&#x27;moduleE&#x27;</span>, <span class="string">&#x27;moduleF&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">shim</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;moduleH&#x27;</span>: &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;moduleH.js&#x27;</span>,</span><br><span class="line">      <span class="attr">exports</span>: <span class="string">&#x27;log&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>数据请求过程分析</li></ol><p>(1) config配置模块信息时并不会触发网络请求<br>(2) 在index.js主入口文件里使用require方法引用多个模块时，根据config配置文件构造一下所有模块的依赖分析树。按深度优先或是广度优先来遍历这个依赖树，将所有依赖按照依赖顺序放进一个数组，最后进行数组去重处理，因为会出现依赖重复的情况</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dependsTree = <span class="keyword">new</span> Tree(<span class="string">&#x27;dependsTree&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> dependsArray = [];</span><br><span class="line"><span class="keyword">var</span> dependsFlag = &#123;&#125;;  <span class="comment">// 解决循环依赖</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建树</span></span><br><span class="line">setDepends(depends, dependsTree);</span><br><span class="line"><span class="comment">// 得到依赖数组</span></span><br><span class="line">sortDepends(dependsArray, dependsTree);</span><br><span class="line"><span class="comment">// 数据去重</span></span><br><span class="line">arrayFilter(dependsArray);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> dependsArray;</span><br></pre></td></tr></table></figure><p>(3) 创建XHR对象异步下载数组里面的所有js文件，按照依赖顺序挨个解析js代码，解析完成后触发回调函数，回调函数里传入各个模块的引用</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ajax下载代码文件</span></span><br><span class="line">Utils.request(url, <span class="string">&#x27;get&#x27;</span>, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span>(<span class="params">responseText</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 暂时保存</span></span><br><span class="line">  _temp[module_name] = responseText;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件下载完成后eval解析代码</span></span><br><span class="line">array.map(<span class="function"><span class="keyword">function</span>(<span class="params">jsText</span>)</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">eval</span>(jsText);</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用回调函数</span></span><br><span class="line">callback.apply(<span class="literal">null</span>, [dep1, dep2, dep3]);</span><br></pre></td></tr></table></figure><h4 id="使用方法">使用方法</h4><hr><p>详细说明: github <a href="https://github.com/nojsja/requireJs-nojsja">README.md</a></p><h4 id="总结">总结</h4><hr><ol><li>下载js代码时我用了ajax来实现，所以对于跨域文件和CDN会有点问题，这个可以改成创建script标签，指定标签src，最后将document.head.appendChild(script)，这样来解决，其它的诸如使用XMLHttpRequest 2.0，iframe等也可以的，可以实验一下。</li><li>解析代码时我用了eval的方法，这个eval在JavaScript里面是众说纷纭，可以看看<a href="https://www.zhihu.com/question/20591877">这个</a>，如果是用了上面创建script标签的方法的话，就不用自己eval了。</li><li>发现一个bug，存在循环依赖时，代码会报错，还没去解决。RequireJs是这样处理的：模块a依赖b，同时b依赖a，这种情况下b的模块函数被调用时，被传入的a是undefined，所以需要自己在b里面手动require一下a。</li></ol>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> devtools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sass开发规范</title>
      <link href="/blogs/2017/10/21/be1a9446.html/"/>
      <url>/blogs/2017/10/21/be1a9446.html/</url>
      
        <content type="html"><![CDATA[<blockquote><p>author: nojsja</p></blockquote><h4 id="目录">目录</h4><hr><ol><li>sass语法</li><li>命名</li><li>书写顺序</li><li>代码嵌套</li><li>注释</li></ol><h4 id="sass语法">sass语法</h4><hr><blockquote><p>sass是一门编程语言，支持css语法以及一般编程语言中的函数、宏、变量和各种逻辑语法等等，sass文件最终会被编译成css文件。</p></blockquote><ol><li>变量</li><li>计算功能</li><li>继承</li><li>Mixin</li><li>函数</li><li>高级用法</li></ol><h5 id="变量">变量</h5><p>Sass允许使用变量，所有变量以$开头：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$blue</span>: <span class="number">#1875e7</span>;</span><br><span class="line">　<span class="selector-tag">div</span> &#123;</span><br><span class="line">　　　<span class="attribute">color</span>: <span class="variable">$blue</span>;</span><br><span class="line">　&#125;</span><br></pre></td></tr></table></figure><p>内嵌到字符串中的变量需要写在 ’ #{} ’ 中间：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$side</span>: left;</span><br><span class="line"><span class="selector-class">.rounded</span> &#123;</span><br><span class="line">　<span class="attribute">border</span>-#&#123;<span class="variable">$side</span>&#125;-radius: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="计算功能">计算功能</h5><p>Sass允许在代码中使用算式：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">　<span class="attribute">margin</span>: (<span class="number">14px</span>/<span class="number">2</span>);</span><br><span class="line">　<span class="attribute">top</span>: <span class="number">50px</span> + <span class="number">100px</span>;</span><br><span class="line">　<span class="attribute">right</span>: <span class="variable">$var</span> * <span class="number">10%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="继承">继承</h5><p>Sass允许一个选择器使用关键字 @extend 继承另一个选择器：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.class1</span> &#123;</span><br><span class="line">　　<span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class2</span> &#123;</span><br><span class="line">　 <span class="keyword">@extend</span> .class1;</span><br><span class="line">　 <span class="attribute">font-size</span>:<span class="number">120%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Mixin">Mixin</h5><p>Mixin是可以重用的代码块，使用 @mixin 关键字定义一个代码块：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@mixin</span> left &#123;</span><br><span class="line">　<span class="attribute">float</span>: left;</span><br><span class="line">　<span class="attribute">margin-left</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用 @include 调用这个mixin：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">　 <span class="keyword">@include</span> left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mixin还能制定参数和参数默认值：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@mixin</span> left(<span class="variable">$value</span>: <span class="number">10px</span>) &#123;</span><br><span class="line">　 <span class="attribute">float</span>: left;</span><br><span class="line">　 <span class="attribute">margin-right</span>: <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用的时候可以直接使用默认值或是加入参数值：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">　　　　<span class="keyword">@include</span> left(<span class="number">20px</span>);</span><br><span class="line">　　&#125;</span><br></pre></td></tr></table></figure><h5 id="函数">函数</h5><p>Sass允许用户使用 @function 关键字编写自己的函数，函数可以直接使用：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@function</span> double(<span class="variable">$n</span>) &#123;</span><br><span class="line">　 <span class="keyword">@return</span> <span class="variable">$n</span> * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#sidebar</span> &#123;</span><br><span class="line">　<span class="attribute">width</span>: double(<span class="number">5px</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="高级用法">高级用法</h5><ul><li>引入外部文件</li><li>使用条件语句</li><li>使用循环语句</li></ul><p>引入外部文件：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">&quot;../foo.css&quot;</span>;</span><br></pre></td></tr></table></figure><p>使用条件语句：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">　<span class="keyword">@if</span> <span class="number">1</span> + <span class="number">1</span> == <span class="number">2</span> &#123; <span class="attribute">border</span>: <span class="number">1px</span> solid; &#125;</span><br><span class="line">　<span class="keyword">@if</span> <span class="number">5</span> &lt; <span class="number">3</span> &#123; <span class="attribute">border</span>: <span class="number">2px</span> dotted; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@if</span> <span class="variable">$color</span> == <span class="string">&#x27;#fff&#x27;</span> &#123;</span><br><span class="line">　<span class="attribute">background-color</span>: <span class="number">#000</span>;</span><br><span class="line">&#125; <span class="keyword">@else</span> &#123;</span><br><span class="line">　<span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用循环语句，支持for和while循环：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@for</span> <span class="variable">$i</span> from <span class="number">1</span> to <span class="number">10</span> &#123;</span><br><span class="line">　　<span class="selector-class">.border-</span>#&#123;<span class="variable">$i</span>&#125; &#123;</span><br><span class="line">　　　　<span class="attribute">border</span>: #&#123;<span class="variable">$i</span>&#125;px solid blue;</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$i</span>: <span class="number">6</span>;</span><br><span class="line">　　<span class="keyword">@while</span> <span class="variable">$i</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">　　　　<span class="selector-class">.item-</span>#&#123;<span class="variable">$i</span>&#125; &#123; <span class="attribute">width</span>: <span class="number">2em</span> * <span class="variable">$i</span>; &#125;</span><br><span class="line">　　　　<span class="variable">$i</span>: <span class="variable">$i</span> - <span class="number">2</span>;</span><br><span class="line">　　&#125;</span><br></pre></td></tr></table></figure><h4 id="命名">命名</h4><hr><ol><li>ID命名</li><li>Class命名</li><li>父元素和子元素的命名规则</li></ol><h5 id="ID命名">ID命名</h5><p>统一采用驼峰命名法(camelCase)，第一个首字母小写，其它单词的首字母大写：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-id">#rootlistitem</span> &#123;...&#125;</span><br><span class="line"><span class="selector-id">#RootListItem</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-id">#rootListItem</span> &#123;...&#125;</span><br></pre></td></tr></table></figure><p>命名单词数最好不要超过3个：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-id">#rootListItemWrapper</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-id">#rootListWrapper</span> &#123;...&#125;</span><br></pre></td></tr></table></figure><h5 id="Class命名">Class命名</h5><p>类的命名统一使用连字符 ‘-’ 连接各个单词，命名中不允许出现大写字母：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* bad */</span><br><span class="line">.contentWrapper &#123;...&#125;</span><br><span class="line"></span><br><span class="line">/* good */</span><br><span class="line">.content-wrapper &#123;...&#125;</span><br></pre></td></tr></table></figure><p>类名最好使用三个及三个以下的单词，至多不超过四个：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.file-detail-list-item-wrapper</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* not-good */</span></span><br><span class="line"><span class="selector-class">.file-detail-list-wrapper</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-class">.file-detail-wrapper</span> &#123;...&#125;</span><br><span class="line"><span class="selector-class">.file-wrapper</span> &#123;...&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="父元素和子元素的命名规则">父元素和子元素的命名规则</h5><p>父元素和多级子元素的命名需要体现元素在页面的功能、样式、或结构：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.file-list-wrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.file-list-header</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.file-list-body</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.list-body-aside</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="selector-class">.body-aside-left</span> &#123;...&#125;</span><br><span class="line">      <span class="selector-class">.body-aside-right</span> &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.list-body-main</span> &#123;...&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.file-list-footer</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="书写顺序">书写顺序</h4><hr><p>内部属性书写顺序应该按照从上到下是 布局定位、盒模型属性、表现性属性和其它：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="comment">/* 布局定位 */</span></span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 盒模型属性 */</span></span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">3px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 表现性属性 */</span></span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Arial&#x27;</span>, sans-serif;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">word-break</span>: break-all;</span><br><span class="line">  <span class="attribute">word-wrap</span>: break-word;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#eee</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 其它 */</span></span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="代码缩进和嵌套">代码缩进和嵌套</h4><hr><ol><li>代码缩进</li><li>多层嵌套</li></ol><h5 id="代码缩进">代码缩进</h5><p>代码缩进统一使用两个空格，不要用四个空格和tab(编辑器内可以自定义tab输出的空格数，不用手打两个空格)</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>选择器与花括号之间要保留一个空格，属性名之后的冒号与属性值之间要保留一个空格，选择符号两边各保留一个空格</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.class</span>&gt;<span class="selector-tag">div</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>:fixed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-class">.class</span> &gt; <span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="多层嵌套">多层嵌套</h5><p>在Sass中你可以嵌套选择器，这可以使代码变得更模块化和可读，嵌套所有的选择器，但尽量避免嵌套没有任何内容的选择器(优先使用子选择器’ &gt; '，提高css查询性能)</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.content</span> &gt; <span class="selector-class">.news-article</span> &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.news-article</span> &#123;</span><br><span class="line">    &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="attribute">content</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.news-article</span> &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Sass中，当你嵌套你的选择器时也可以使用上下文媒体查询，你可以在任何给定的嵌套层次中使用媒体查询</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bad */</span></span><br><span class="line"><span class="selector-class">.content-page</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.main</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: whitesmoke;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.latest-news</span> &#123;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">      &gt; <span class="selector-class">.news-article</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">        &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">          <span class="attribute">font-size</span>: <span class="number">2rem</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.content</span> &#123;</span><br><span class="line">      <span class="attribute">margin-top</span>: <span class="number">2rem</span>;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.page-footer</span> &#123;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">641px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.content-page</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.main</span> &gt; <span class="selector-class">.latest-news</span> &gt; <span class="selector-class">.news-article</span> &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="number">3rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.page-footer</span> &#123;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* good */</span></span><br><span class="line"><span class="selector-class">.content-page</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">641px</span>) &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.main</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: whitesmoke;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.latest-news</span> &#123;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">      &gt; <span class="selector-class">.news-article</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">        &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">          <span class="attribute">font-size</span>: <span class="number">2rem</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">641px</span>) &#123;</span><br><span class="line">            <span class="attribute">font-size</span>: <span class="number">3rem</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &gt; <span class="selector-class">.content</span> &#123;</span><br><span class="line">      <span class="attribute">margin-top</span>: <span class="number">2rem</span>;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &gt; <span class="selector-class">.page-footer</span> &#123;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">641px</span>) &#123;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>嵌套顺序和选择器，以下是一个sass块应该具有的顺序：</p><ol><li>当前选择器的样式属性</li><li>当前选择器的伪类选择器 (:first-letter, :hover, :active)伪类元素 (:before and :after)</li><li>当前选择器的声明样式 (.selected, .active, .enlarged)</li><li>用Sass的上下文媒体查询</li><li>子选择器作为最后的部分</li></ol><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.product-teaser</span> &#123;</span><br><span class="line">  <span class="comment">/* 当前选择器的样式属性 */</span></span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: whitesmoke;</span><br><span class="line">  <span class="attribute">color</span>: grey;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 当前选择器的伪类选择器 */</span></span><br><span class="line">  &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &amp;:before &#123;</span><br><span class="line">    content: <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid grey;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &amp;:after &#123;</span><br><span class="line">    content: <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid grey;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 当前选择器的声明样式 */</span></span><br><span class="line">  &amp;<span class="selector-class">.active</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: pink;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 上下文媒体查询 */</span></span><br><span class="line">  <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">640px</span>) &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2em</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 子选择器 */</span></span><br><span class="line">  &gt; <span class="selector-class">.content</span> &gt; <span class="selector-class">.title</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 子选择器上下文媒体查询 */</span></span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">640px</span>) &#123;</span><br><span class="line">      <span class="attribute">letter-spacing</span>: <span class="number">0.2em</span>;</span><br><span class="line">      <span class="attribute">text-transform</span>: uppercase;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="注释">注释</h4><hr><blockquote><p>代码编辑器一般都可以自定义代码段(snippets)，通过编辑自定义代码段配置文件将快捷键绑定到一段自定义代码可以实现快捷插入代码段</p></blockquote><ol><li>组件注释</li><li>子组件注释</li><li>一般注释</li></ol><h5 id="组件注释">组件注释</h5><p>一个大组件需要使用组件注释，体现页面结构。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ==========================================================</span></span><br><span class="line"><span class="comment">父组件 file-list</span></span><br><span class="line"><span class="comment">============================================================= */</span></span><br><span class="line"><span class="selector-class">.file-list</span> &#123;...&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="子组件注释">子组件注释</h5><p>一个组件的子组件需要使用子组件注释，体现组件整体结构。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 子组件 file-list-item</span></span><br><span class="line"><span class="comment">============================================================= */</span></span><br><span class="line"><span class="selector-class">.file-list-item</span> &#123;...&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="一般注释">一般注释</h5><p>使用块注释和行注释都行，重要的是体现代码结构和代码简洁度</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 块注释 */</span></span><br><span class="line"><span class="selector-class">.class1</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 行注释</span></span><br><span class="line">  <span class="selector-class">.title</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.content</span> &#123;  <span class="comment">// 行注释2</span></span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Sass </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sass </tag>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
