<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="GicLYNNqJJ-XBSPlE8Pz-ZwGf2ElS_d_VRcEsQServ4"><meta name="google-site-verification" content="rn4dOdASKHwgOgBKFwN8nAB0OlnuC_pNB8qLDnMyPpc"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="baidu-site-verification" content="code-W4A0ktcwoi"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="nojsja 个人博客"><meta name="keyword" content=""><link rel="shortcut icon" href="/blogs/img/favicon.ico"><link href="/blogs/fonts/fontawesome-webfont.woff2?v=4.3.0" rel="preload" as="font" crossorigin><link href="https://www.google-analytics.com" rel="preconnect" crossorigin><link href="http://busuanzi.ibruce.info" rel="preconnect" crossorigin><link href="http://nojsja.gitee.io" rel="preconnect" crossorigin><title>echarts图表-树形图开发记录 - nojsja | Blog</title><link rel="canonical" href="https://nojsja.github.io/blogs/blogs/2020/03/22/39caa941.html/"><link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/blogs/css/dusign-light.css"><link rel="stylesheet" href="/blogs/css/github-markdown.min.css"><style>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media (max-width:767px){.markdown-body{padding:15px}}</style><link rel="stylesheet" href="/blogs/css/widget.css"><link rel="stylesheet" href="/blogs/css/fonts.googleapis.css"><link rel="stylesheet" href="/blogs/css/font-awesome.min.css"><script>function async(e,t,a,n){var c=document.head||document.getElementsByTagName("head")[0]||document.documentElement,d=document,r=a||"script",s=d.createElement(r),l=d.getElementsByTagName(r)[0];switch(n=["async","defer"].includes(n)?n:!!n,r){case"script":s.src=e,n&&(s[n]=!0);break;case"link":s.type="text/css",s.href=e,s.rel="stylesheet";break;default:s.src=e}t&&(s.readyState?s.onreadystatechange=function(e){"loaded"!=s.readyState&&"complete"!=s.readyState||(s.onreadystatechange=null,t(null,e)())}:s.onload=function(e){t(null,e)}),l.parentNode.insertBefore(s,c.firstChild)}</script><script>function sendXMLHttpRequest(e){var t=e.url,n=(e.method||"get").toUpperCase(),s=e.callback,a=!("async"in e)||!!e.async,c=null;t&&((c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).open(n,t,a),c.onreadystatechange=function(){4===this.readyState&&(s&&s(this.responseText),c.onreadystatechange=null)},c.send(null))}</script><script>var fnDebounce=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void(t=Date.now()):t=Date.now()}},fnThrottle=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void 0:t=Date.now()}}</script><script>"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype?"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}}):sendXMLHttpRequest({url:"/blogs/js/intersection-observer.js",async:!1,method:"get",callback:function(txt){eval(txt)}})</script><script src="/blogs/js/buttons.js" async defer></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/blogs/atom.xml" title="nojsja" type="application/atom+xml">
</head><body><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(https://nojsja.gitee.io/static-resources/images/hexo/article_header/article_header.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/blogs/tags/#echarts" title="echarts">echarts</a> <a class="tag" href="/blogs/tags/#react" title="react">react</a></div><h1>echarts图表-树形图开发记录</h1><h2 class="subheading">Echarts Tree</h2><span class="meta"><span class="post-description"><i class="fa fa-user" aria-hidden="true"></i> nojsja </span><span class="post-description"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-22</span></span><div class="blank_box"></div><span class="meta">字数：<span class="post-count">3.1k</span>丨 阅读时间：<span class="post-count">13</span> 分钟</span><div class="blank_box"></div></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/blogs/img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(/blogs/img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/blogs/">nojsja</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/blogs/">首页</a></li><li><a href="/blogs/about/">关于</a></li><li><a href="/blogs/archive/">时间轴</a></li><li><a href="/blogs/categories/">目录</a></li><li><a href="/blogs/tags/">标签</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout((function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")}),400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><style>.table-responsive{border:none!important}</style><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container markdown-body"><h3 id="目录">目录</h3><ol><li><p>前言</p></li><li><p>树形图功能需求以及遇到的问题分析</p></li><li><p>问题I：V4版本label自定义效果设置不生效</p></li><li><p>问题II：tree图使用自定义图片加载显示不完全</p></li><li><p>问题III：tree图自定义节点选中效果和组件自带渲染效果冲突</p></li></ol><h3 id="前言">前言</h3><hr><p>Echarts树形图Tree可以用来展示树形数据结构各节点的层级关系，比如一个使用情况就是文件系统存在多个快照，每一级快照基于上一级生成，存在父级和子级关系对应关系，且Root根只有一个，即文件系统本身，完全适用于树形图的使用场景。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="snapshot.png" alt="snapshot"></p><h3 id="树形图功能需求以及遇到的问题分析">树形图功能需求以及遇到的问题分析</h3><hr><ol><li>文件系统快照每一层级的节点支持单个选中，很多操作都是基于某一个快照节点的，比<br>如快照的恢复、删除、设置，考虑选中效果的区别使用label自定义富文本样式实现，但是会遇到渲染的时侯echarts一些自己的状态更新和我们我们自定义的选中状态的更新冲突问题，且V4版本echarts tree的富文本配置后也并未生效。</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="snapshot_select.png" alt="snapshot_select"></p><ol start="2"><li>文件系统快照每一层级的节点标识(Symbol)可能不同，需要支持使用自定义图片，echarts的symbol是直接支持使用img-src和base64 img-str的，但是会遇到图片在某些时候不能完全被渲染(图片像是被设置了半透明)或直接完全不能被渲染出来的问题。</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-1.png" alt="tree-1"><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-2.png" alt="tree-2"><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-3.png" alt="tree-3"></p><h3 id="问题I：V4版本label自定义效果设置不生效">问题I：V4版本label自定义效果设置不生效</h3><hr><p>series-tree.label.formatter</p><blockquote><p>标签内容格式器，支持字符串模板和回调函数两种形式，字符串模板与回调函数返回的字符串均支持用 \n 换行。</p></blockquote><h4 id="字符串模板的使用">字符串模板的使用</h4><ol><li>模板变量有：</li></ol><ul><li>{a}：系列名。</li><li>{b}：数据名。</li><li>{c}：数据值。</li><li>{d}：百分比。</li><li>{@xxx}：数据中名为’xxx’的维度的值，如{@product}表示名为’product’` 的维度的值。</li><li>{@[n]}：数据中维度n的值，如{@[3]}` 表示维度 3 的值，从 0 开始计数。</li></ul><ol start="2"><li><p>示例：<br>formatter: ‘{b}: {d}’</p></li><li><p>回调函数格式：<br>(params: Object|Array) =&gt; string，<br>参数 params 是 formatter 需要的单个数据集，格式如下：</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">componentType</span>: <span class="string">&#x27;series&#x27;</span>,</span><br><span class="line">    <span class="comment">// 系列类型</span></span><br><span class="line">    <span class="attr">seriesType</span>: string,</span><br><span class="line">    <span class="comment">// 系列在传入的 option.series 中的 index</span></span><br><span class="line">    <span class="attr">seriesIndex</span>: number,</span><br><span class="line">    <span class="comment">// 系列名称</span></span><br><span class="line">    <span class="attr">seriesName</span>: string,</span><br><span class="line">    <span class="comment">// 数据名，类目名</span></span><br><span class="line">    <span class="attr">name</span>: string,</span><br><span class="line">    <span class="comment">// 数据在传入的 data 数组中的 index</span></span><br><span class="line">    <span class="attr">dataIndex</span>: number,</span><br><span class="line">    <span class="comment">// 传入的原始数据项</span></span><br><span class="line">    <span class="attr">data</span>: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 传入的数据值。在多数系列下它和 data 相同。在一些系列下是 data 中的分量（如 map、radar 中）</span></span><br><span class="line">    <span class="attr">value</span>: number|<span class="built_in">Array</span>|<span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 坐标轴 encode 映射信息，</span></span><br><span class="line">    <span class="comment">// key 为坐标轴（如 &#x27;x&#x27; &#x27;y&#x27; &#x27;radius&#x27; &#x27;angle&#x27; 等）</span></span><br><span class="line">    <span class="comment">// value 必然为数组，不会为 null/undefied，表示 dimension index 。</span></span><br><span class="line">    <span class="comment">// 其内容如：</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     x: [2] // dimension index 为 2 的数据映射到 x 轴</span></span><br><span class="line">    <span class="comment">//     y: [0] // dimension index 为 0 的数据映射到 y 轴</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="attr">encode</span>: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="comment">// 维度名列表</span></span><br><span class="line">    <span class="attr">dimensionNames</span>: <span class="built_in">Array</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    <span class="comment">// 数据的维度 index，如 0 或 1 或 2 ...</span></span><br><span class="line">    <span class="comment">// 仅在雷达图中使用。</span></span><br><span class="line">    dimensionIndex: number,</span><br><span class="line">    <span class="comment">// 数据图形的颜色</span></span><br><span class="line">    <span class="attr">color</span>: string,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="字符串模板不生效问题1">字符串模板不生效问题1</h4><p>直接将formatter自定义函数和富文本标识配置在<code>series[0].label</code>下，结果以上配置都无效，正确方法是在<code>series[0].label.normal</code>下配置富文本标识声明，而formatter需要定义在数据集data的各个数据项中，<code>normal</code>表示常规效果，与之对应的<code>emphasis</code>是鼠标划过高亮效果。<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-4.png" alt="tree-4"></p><p>series-tree.label.rich支持的所有CSS属性：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  color , fontStyle , fontWeight , fontFamily , fontSize , align , verticalAlign , lineHeight , backgroundColor , borderColor , borderWidth , borderRadius , padding , shadowColor , shadowBlur , shadowOffsetX , shadowOffsetY , width , height , textBorderColor , textBorderWidth , textShadowColor , textShadowBlur , textShadowOffsetX , textShadowOffsetY</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>series-tree.data.label中配置label.formatter：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rawTreeData = &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;snapshotA&#x27;</span>,</span><br><span class="line">          <span class="attr">selected</span>: <span class="literal">false</span>, <span class="comment">// 自定义选择控制属性selected</span></span><br><span class="line">          <span class="attr">collapsed</span>: <span class="literal">false</span>, <span class="comment">// 覆盖组件自带的collapsed效果</span></span><br><span class="line">          <span class="attr">label</span>: &#123;</span><br><span class="line">            <span class="comment">// * 直接引用上层定义的formatter即可，复用函数对象</span></span><br><span class="line">            <span class="attr">formatter</span>: <span class="built_in">this</span>.echartsInitData.series[<span class="number">0</span>].label.normal.formatter,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            ...</span><br><span class="line">          ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-5.png" alt="tree-5"></p><h3 id="问题II：tree图使用自定义图片加载显示不完全">问题II：tree图使用自定义图片加载显示不完全</h3><hr><h4 id="解决方案1-无效-：使用对象深比较函数避免多次渲染">解决方案1(无效)：使用对象深比较函数避免多次渲染</h4><blockquote><p>使用此方法在React生命周期componentDidUpdate里判断options是否发生改变，从而避免了echarts组件多次render的情况，但验证后发现避免了一些组件卡顿的情况，但也存在自定义tree 节点图片加载不完全的情况，此解决方案无效。</p></blockquote><ol><li>Js对象深比较函数deepComparison定义</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [deepComparison 深比较]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param  <span class="type">&#123;[any]&#125;</span> </span>data [any]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;[Boolean]&#125;</span>      </span>[是否相同]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deepComparison</span>(<span class="params">data1, data2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; hasOwnProperty &#125; = <span class="built_in">Object</span>.prototype;</span><br><span class="line">  <span class="comment">// 获取变量类型</span></span><br><span class="line">  <span class="keyword">const</span> getType = <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> d === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(d <span class="keyword">instanceof</span> <span class="built_in">Object</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (d <span class="keyword">instanceof</span> <span class="built_in">Date</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;date&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (d <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;regexp&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// object / array //</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d !== d) <span class="keyword">return</span> <span class="string">&#x27;nan&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">typeof</span> d).toLowerCase();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 基本类型比较</span></span><br><span class="line">  <span class="keyword">const</span> is = <span class="function">(<span class="params">d1, d2, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;nan&#x27;</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;date&#x27;</span> || type === <span class="string">&#x27;regexp&#x27;</span>) <span class="keyword">return</span> d1.toString() === d2.toString();</span><br><span class="line">    <span class="keyword">return</span> (d1 === d2);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 递归比较</span></span><br><span class="line">  <span class="keyword">const</span> compare = <span class="function">(<span class="params">d1, d2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> type1 = getType(d1);</span><br><span class="line">    <span class="keyword">const</span> type2 = getType(d2);</span><br><span class="line">    <span class="keyword">if</span> (type1 !== type2) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type1 === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> keys1 = <span class="built_in">Object</span>.keys(d1).filter(<span class="function"><span class="params">k</span> =&gt;</span> hasOwnProperty.call(d1, k));</span><br><span class="line">      <span class="keyword">const</span> keys2 = <span class="built_in">Object</span>.keys(d2).filter(<span class="function"><span class="params">k</span> =&gt;</span> hasOwnProperty.call(d2, k));</span><br><span class="line">      <span class="keyword">if</span> (keys1.length !== keys2.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys1.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          !keys2.includes(keys1[i]) ||</span><br><span class="line">          !compare(d1[keys1[i]], d2[keys1[i]])) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> is(d1, d2, type1);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> compare(data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.深度比较函数使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;update&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; treeData &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">  <span class="keyword">const</span> rawTreeData = toJS(treeData);</span><br><span class="line">  <span class="keyword">if</span> (!deepComparison(<span class="built_in">this</span>.echartsTreeData, rawTreeData)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;change&#x27;</span>);</span><br><span class="line">    <span class="built_in">this</span>.echartsTreeData = rawTreeData;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    optionData.series[<span class="number">0</span>].data = [rawTreeData];</span><br><span class="line">    <span class="built_in">console</span>.log(optionData);</span><br><span class="line">    <span class="comment">// this.echartsElement.clear();</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解决方案2-无效-：使用base64字符串替换img-url">解决方案2(无效)：使用base64字符串替换img url</h4><blockquote><p>由于方案1无效，判断可能是由于图片异步加载引起的渲染问题，对小图片尝试直接使用base64硬编码在代码里，结果发现仍然无效。</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-6.png" alt="tree-6"></p><h4 id="解决方案3-有效-：禁用动画加载">解决方案3(有效)：禁用动画加载</h4><blockquote><p>由解决方案2可知，问题原因排除img异步加载的问题，问题定位到echarts组件自身的渲bug，通过多次设置setOption方法的参数，发现设置动画取消可以避免由于echarts图自身的渲染过程引起的图片加载不全问题。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chartOption = &#123;</span><br><span class="line">  <span class="attr">animation</span>: <span class="literal">true</span>, <span class="comment">// 解决渲染不全的问题</span></span><br><span class="line">  <span class="attr">tooltip</span>: &#123;</span><br><span class="line">    <span class="attr">trigger</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="attr">triggerOn</span>: <span class="string">&#x27;mousemove&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">series</span>: [</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="解决方案4-有效-：组件渲染完成后重新手动渲染">解决方案4(有效)：组件渲染完成后重新手动渲染</h4><blockquote><p>echarts初始化后的组件可以挂载钩子函数和监听一些浏览器事件，其中有一个事件名为finished，表示echarts图表本次渲染完成。既然我们之前的最后一次渲染导致图片未完全加载，那么可以在最后这次渲染完成之后再读取echarts组件自带的options然后重新渲染一次，即可解决问题，需要注意的是，finished事件可能在短时间内被调用数次，在监听时注意使用函数防抖的思想让短时间内的多次finished事件回调只执行一次。</p></blockquote><ol><li>函数防抖声明<br>函数节流和函数防抖在浏览器渲染优化方面还是用得挺多：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;Function&#125;</span> </span>fn         [回调函数]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[Time]&#125;</span>   </span>delayTime  [延迟时间(ms)]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;Boolean&#125;</span>  </span>isImediate [是否需要立即调用]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;[type]&#125;</span>   </span>args       [回调函数传入参数]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fnDebounce</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> fnObject = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> timer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">fn, delayTime, isImediate, args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 设置定时器方法</span></span><br><span class="line">    <span class="keyword">const</span> setTimer = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        fn(args);</span><br><span class="line">        <span class="comment">// 清除定时器</span></span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">        <span class="keyword">delete</span> (fnObject[fn]);</span><br><span class="line">      &#125;, delayTime);</span><br><span class="line"></span><br><span class="line">      fnObject[fn] = &#123;</span><br><span class="line">        delayTime,</span><br><span class="line">        timer,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 立即调用</span></span><br><span class="line">    <span class="keyword">if</span> (!delayTime || isImediate) <span class="keyword">return</span> fn(args);</span><br><span class="line">    <span class="comment">// 判断函数是否已经在调用中</span></span><br><span class="line">    <span class="keyword">if</span> (fnObject[fn]) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">      setTimer(fn, delayTime, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setTimer(fn, delayTime, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>finished事件监听和函数防抖的应用<br>其实在此基础上还能做的优化就是在组件第一次加载自定义symbol图片后就将<code>finished</code>事件监听取消掉，减少渲染次数。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FsPageSnapShotBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  echartsElement= <span class="literal">null</span></span><br><span class="line">  echartsTreeData = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化事件防抖</span></span><br><span class="line">  fnDebounce = fnDebounce();</span><br><span class="line"></span><br><span class="line">  pendingEventsTrigger = <span class="function">(<span class="params">nodeName</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; snapshot &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement = echarts.init(<span class="built_in">this</span>.refs.fsSnapShot);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(snapshot.echartsInitData);</span><br><span class="line">    <span class="comment">// finished事件监听</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;finished&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 延迟时间设置为200ms</span></span><br><span class="line">      <span class="built_in">this</span>.fnDebounce(<span class="built_in">this</span>.pendingEventsTrigger, <span class="number">200</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  resizeCharts = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.resize();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    echarts.dispose(<span class="built_in">this</span>.echartsElement);</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  onClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="问题III：tree图自定义节点选中效果和组件自带渲染效果冲突">问题III：tree图自定义节点选中效果和组件自带渲染效果冲突</h3><hr><p>节点选中效果原理是监听echarts的<code>dblclick</code>双击事件，双击后改变<code>options.series[0].data</code>数据项里的<code>selected</code>属性配置，然后label.formatter根据此属性能够应用富文本类名里声明的高亮或普通文本的类名。值得注意的是echarts渲染时自身已经对过长层级的tree数据做了渲染优化，导致过深层级的展开/折叠状态不被控制，每次重新渲染后会导致已经折叠的树层级展开或是已经展开的树层级折叠，非常影响用户操作，因此需要把树层级数据每一层的折叠纳入强制属性控制状态，即在<code>options.series[0].data</code>中额外声明<code>collapsed:[Boolean]</code>参数，同时禁用tree自带的折叠/展开控制。</p><h4 id="冲突1：在设置了echarts渲染动画延迟更新的情况下节点选中效果无效">冲突1：在设置了echarts渲染动画延迟更新的情况下节点选中效果无效</h4><p>如果直接通过dblclick双击事件触发函数设置某个节点选中状态的属性<code>selected:true</code>，那么表现为：<code>selected</code>状态不常驻，变成了类似<code>mouseover</code>的鼠标划过状态触发；</p><ol><li>动画延迟更新属性声明</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Tree的外层数据 */</span></span><br><span class="line">echartsInitData= &#123;</span><br><span class="line">    <span class="attr">tooltip</span>: &#123;</span><br><span class="line">      <span class="attr">trigger</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">      <span class="attr">triggerOn</span>: <span class="string">&#x27;mousemove&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        &#123;...&#125;,</span><br><span class="line">        <span class="attr">leaves</span>: &#123;...&#125;,</span><br><span class="line">        <span class="attr">expandAndCollapse</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">animationDuration</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">animationDelayUpdate</span>: <span class="number">300</span>, <span class="comment">// 动画延迟更新</span></span><br><span class="line">        <span class="attr">animationDurationUpdate</span>: <span class="number">400</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>冲突效果表现</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug1.gif" alt="tree-bug1"></p><h4 id="冲突2：鼠标的悬浮操作导致选中效果无效">冲突2：鼠标的悬浮操作导致选中效果无效</h4><p>按照上述表现，我尝试在触发函数更新tree节点选中状态之前设置一个延迟，延迟时间大于tree组件的动画延迟更新设置时间(上面设置为了<code>300ms</code>)，结果发现：如果在双击tree节点的时候鼠标一直放在节点上的话，鼠标移开后，表现和上面一样，如果双击了tree节点之后马上把鼠标从该节点移开的话则选中状态正常(太不容易了！)，推测是我们触发echarts组件更新的时候，echarts自身的组件状态管理和我们自定义的组件更新函数(以上表现为设置tree节点数据的<code>selected</code>属性触发label.formatter的渲染效果变化)两者冲突。</p><ol><li>设置<code>selected</code>属性更改函数的延迟时间</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* React组件自定义方法-选中一个元素 */</span></span><br><span class="line">onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name &#125; = e.data;</span><br><span class="line">    <span class="built_in">this</span>.selectedNodeName = name;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.props.snapshot.chooseSnapShot(name);</span><br><span class="line">    &#125;, <span class="number">400</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>冲突效果表现<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug2.gif" alt="tree-bug2"></li></ol><h4 id="解决方法">解决方法</h4><p>方法同于上面提到的<code>finished事件监听和函数防抖的应用</code>，在echarts组件最终渲染完成后增加一次额外渲染解决问题，但是也仍然会有<code>selected</code>状态稍稍延迟更新和<code>selected</code>状态闪烁一次的问题，不妨碍使用，但是应该有更优的解决办法尚待实现。</p><ol><li>代码概览</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FsPageSnapShotBody</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  echartsElement= <span class="literal">null</span></span><br><span class="line">  echartsTreeData = <span class="literal">null</span>;</span><br><span class="line">  selectedNodeName = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化事件防抖</span></span><br><span class="line">  dblclickFnDebounce = fnDebounce();</span><br><span class="line"></span><br><span class="line">  pendingEventsTrigger = <span class="function">(<span class="params">nodeName</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> optionData = <span class="built_in">this</span>.echartsElement.getOption();</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(optionData, <span class="literal">true</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; snapshot &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement = echarts.init(<span class="built_in">this</span>.refs.fsSnapShot);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.setOption(snapshot.echartsInitData);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;dblclick&#x27;</span>, <span class="built_in">this</span>.onDoubleClickChart);</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;click&#x27;</span>, <span class="built_in">this</span>.onClickChart);</span><br><span class="line">    <span class="comment">// finished事件监听</span></span><br><span class="line">    <span class="built_in">this</span>.echartsElement.on(<span class="string">&#x27;finished&#x27;</span>, <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.selectedNodeName) &#123;</span><br><span class="line">        <span class="comment">// 防抖延迟时间设置为200ms</span></span><br><span class="line">        <span class="built_in">this</span>.dblclickFnDebounce(<span class="built_in">this</span>.pendingEventsTrigger, <span class="number">200</span>, <span class="literal">false</span>, <span class="built_in">this</span>.selectedNodeName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    snapshot.getSnapShotRequest();</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidUpdate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  resizeCharts = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.echartsElement.resize();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    echarts.dispose(<span class="built_in">this</span>.echartsElement);</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="built_in">this</span>.resizeCharts);</span><br><span class="line">  &#125;</span><br><span class="line">  onClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  onDoubleClickChart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>效果演示<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="tree-bug-fix.gif" alt="tree-bug-fix"></li></ol><span class="meta" id="headerViewCountWrapper"><span id="<Your/Path/Name>" class="leancloud_visitors" data-flag-title="Your Article Title"><em class="post-meta-item-text">⇸⇸ 阅读量：</em> <i class="leancloud-visitors-count">[ loading ]</i>⇷⇷</span></span><script>document.querySelector("#headerViewCountWrapper > .leancloud_visitors").id=decodeURIComponent(window.location.pathname)</script><hr style="margin-top:5px"><ul class="pager"><li class="previous"><a href="/blogs/2020/03/26/7507699.html/" data-toggle="tooltip" data-placement="top" title="基于s3对象存储多文件分片上传的Javascript实现（二）">&larr; Previous Post</a></li><li class="next"><a href="/blogs/2020/03/07/37469a41.html/" data-toggle="tooltip" data-placement="top" title="基于s3对象存储多文件分片上传的Javascript实现（一）">Next Post &rarr;</a></li></ul><style type="text/css">.aplayer-container{text-align:center}.lds-roller-loading{display:inline-block;position:relative;width:80px;height:80px}.lds-roller-loading div{animation:lds-roller 1.2s cubic-bezier(.5,0,.5,1) infinite;transform-origin:40px 40px}.lds-roller-loading div:after{content:" ";display:block;position:absolute;width:7px;height:7px;border-radius:50%;background:#ff59ac;margin:-4px 0 0 -4px}.lds-roller-loading div:nth-child(1){animation-delay:-36ms}.lds-roller-loading div:nth-child(1):after{top:63px;left:63px}.lds-roller-loading div:nth-child(2){animation-delay:-72ms}.lds-roller-loading div:nth-child(2):after{top:68px;left:56px}.lds-roller-loading div:nth-child(3){animation-delay:-108ms}.lds-roller-loading div:nth-child(3):after{top:71px;left:48px}.lds-roller-loading div:nth-child(4){animation-delay:-144ms}.lds-roller-loading div:nth-child(4):after{top:72px;left:40px}.lds-roller-loading div:nth-child(5){animation-delay:-.18s}.lds-roller-loading div:nth-child(5):after{top:71px;left:32px}.lds-roller-loading div:nth-child(6){animation-delay:-216ms}.lds-roller-loading div:nth-child(6):after{top:68px;left:24px}.lds-roller-loading div:nth-child(7){animation-delay:-252ms}.lds-roller-loading div:nth-child(7):after{top:63px;left:17px}.lds-roller-loading div:nth-child(8){animation-delay:-288ms}.lds-roller-loading div:nth-child(8):after{top:56px;left:12px}@keyframes lds-roller{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.aplayer .aplayer-pic .aplayer-pause svg{top:0;left:0}.aplayer .aplayer-pic .aplayer-play svg{top:0;left:2px}</style><div class="aplayer-container"><div id="aplayer" class="lds-roller-loading" lazy-css-href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css" lazy-js-src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><script>(function(){var e,t=document.querySelector("#aplayer"),s=function(s,i){var r=[];s&&r.push(s),i&&r.push(i),r.forEach((function(s){async(s,(function(){/^.*.js$/.test(s)&&function(){e&&e.disconnect(),t.className="",t.innerHTML="";new APlayer({container:document.getElementById("aplayer"),theme:"#e9e9e9",audio:[{name:"存在信号",artist:"AcuticNotes",url:"http://nojsja.gitee.io/static-resources/audio/life-signal.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/life-signal.jpg"},{name:"遺サレタ場所／斜光",artist:"岡部啓一",url:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.jpg"}]})}()}),/^.*.css$/.test(s)?"link":"script")}))};if(window.IntersectionObserver)(e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var i=t.target.getAttribute("lazy-css-href"),r=t.target.getAttribute("lazy-js-src");s(i,r)}}))}))).observe(t);else{var i=t.getAttribute("lazy-css-href"),r=t.getAttribute("lazy-js-src");s(i,r)}}).bind(window)()</script><hr><div id="vcomments"></div><script>(function(){function e(){async("/blogs/js/Valine.min.js",(function(){new Valine({el:"#vcomments",appId:"wUKKBx8BRzGaNfhgdg2UKtub-MdYXbMMI",appKey:"MAwYM4KlW5YJ3q06qwnUScBr",visitor:!0})}))}if(window.IntersectionObserver){var n=new IntersectionObserver((function(i){i.forEach((function(i){i.isIntersecting&&(n.unobserve(i.target),n.disconnect(),e())}))}));n.observe(document.querySelector("#headerViewCountWrapper"))}else e()}).bind(window)()</script></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">目录</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%A0%91%E5%BD%A2%E5%9B%BE%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82%E4%BB%A5%E5%8F%8A%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">树形图功能需求以及遇到的问题分析</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%97%AE%E9%A2%98I%EF%BC%9AV4%E7%89%88%E6%9C%AClabel%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%88%E6%9E%9C%E8%AE%BE%E7%BD%AE%E4%B8%8D%E7%94%9F%E6%95%88"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">问题I：V4版本label自定义效果设置不生效</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A8%A1%E6%9D%BF%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">字符串模板的使用</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A8%A1%E6%9D%BF%E4%B8%8D%E7%94%9F%E6%95%88%E9%97%AE%E9%A2%981"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">字符串模板不生效问题1</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%97%AE%E9%A2%98II%EF%BC%9Atree%E5%9B%BE%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E6%98%BE%E7%A4%BA%E4%B8%8D%E5%AE%8C%E5%85%A8"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">问题II：tree图使用自定义图片加载显示不完全</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%881-%E6%97%A0%E6%95%88-%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%B7%B1%E6%AF%94%E8%BE%83%E5%87%BD%E6%95%B0%E9%81%BF%E5%85%8D%E5%A4%9A%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">解决方案1(无效)：使用对象深比较函数避免多次渲染</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%882-%E6%97%A0%E6%95%88-%EF%BC%9A%E4%BD%BF%E7%94%A8base64%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9B%BF%E6%8D%A2img-url"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">解决方案2(无效)：使用base64字符串替换img url</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%883-%E6%9C%89%E6%95%88-%EF%BC%9A%E7%A6%81%E7%94%A8%E5%8A%A8%E7%94%BB%E5%8A%A0%E8%BD%BD"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">解决方案3(有效)：禁用动画加载</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%884-%E6%9C%89%E6%95%88-%EF%BC%9A%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90%E5%90%8E%E9%87%8D%E6%96%B0%E6%89%8B%E5%8A%A8%E6%B8%B2%E6%9F%93"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">解决方案4(有效)：组件渲染完成后重新手动渲染</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%97%AE%E9%A2%98III%EF%BC%9Atree%E5%9B%BE%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%AD%E6%95%88%E6%9E%9C%E5%92%8C%E7%BB%84%E4%BB%B6%E8%87%AA%E5%B8%A6%E6%B8%B2%E6%9F%93%E6%95%88%E6%9E%9C%E5%86%B2%E7%AA%81"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">问题III：tree图自定义节点选中效果和组件自带渲染效果冲突</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%B2%E7%AA%811%EF%BC%9A%E5%9C%A8%E8%AE%BE%E7%BD%AE%E4%BA%86echarts%E6%B8%B2%E6%9F%93%E5%8A%A8%E7%94%BB%E5%BB%B6%E8%BF%9F%E6%9B%B4%E6%96%B0%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%AD%E6%95%88%E6%9E%9C%E6%97%A0%E6%95%88"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">冲突1：在设置了echarts渲染动画延迟更新的情况下节点选中效果无效</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%B2%E7%AA%812%EF%BC%9A%E9%BC%A0%E6%A0%87%E7%9A%84%E6%82%AC%E6%B5%AE%E6%93%8D%E4%BD%9C%E5%AF%BC%E8%87%B4%E9%80%89%E4%B8%AD%E6%95%88%E6%9E%9C%E6%97%A0%E6%95%88"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">冲突2：鼠标的悬浮操作导致选中效果无效</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">解决方法</span></a></li></ol></li></ol></div></aside></div></div></article><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",(function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")}))</script><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="/blogs/js/anchor.nojsja.js"></script><style>#websiteModal .modal-body{display:flex;align-items:center;justify-content:center;margin:auto;text-align:center;width:100%;height:100%}#websiteModal .modal-body img{max-width:100%;height:auto}</style><script>$(document).ready((function(){$(document).on("click","img",(function(o){if($(this).hasClass("click-disable"))o&&o.stopPropagation();else{o&&o.stopPropagation();var a=$(this).clone();$("#websiteModal").modal("show"),a.addClass("click-disable"),$("#websiteModal .modal-body").html(a)}})).on("click",".modal-body",(function(){$("#websiteModal").modal("hide")}))}))</script><div class="modal fade" id="websiteModal" tabindex="-1" role="dialog" aria-labelledby="websiteModalTitle" aria-hidden="true"><div class="modal-body"></div></div><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; nojsja 2021</p></div></div></div></footer><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script><script src="/blogs/js/widgets.js"></script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",(function(){var c=document.querySelector("nav");c&&FastClick.attach(c)}))</script><script type="text/javascript">var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/blogs/"+search_path;searchFunc(path,"local-search-input","local-search-result")</script><script src="/blogs/js/busuanzi.pure.mini.js" defer async></script><a id="rocket" href="#top"></a><script type="text/javascript" src="/blogs/js/totop.js" async></script><script>(function(){function t(t){return document.querySelectorAll(t)}if(window.hexoLoadingImages=window.hexoLoadingImages||{},window.IntersectionObserver){var e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var n=new Image,o="_img_"+Math.random();window.hexoLoadingImages[o]=n,n.onload=function(){t.target.src=t.target.getAttribute("data-src"),window.hexoLoadingImages[o]=null},n.onerror=function(){window.hexoLoadingImages[o]=null},t.target.src=t.target.getAttribute("data-loading"),n.src=t.target.getAttribute("data-src")}}))}));t("img[lazyload]").forEach((function(t){e.observe(t)}))}else t("img[lazyload]").forEach((function(t){t.src=t.getAttribute("data-src")}))}).bind(window)()</script></body></html>