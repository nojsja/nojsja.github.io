<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="GicLYNNqJJ-XBSPlE8Pz-ZwGf2ElS_d_VRcEsQServ4"><meta name="google-site-verification" content="rn4dOdASKHwgOgBKFwN8nAB0OlnuC_pNB8qLDnMyPpc"><meta name="baidu-site-verification" content="093lY4ziMu"><meta name="baidu-site-verification" content="code-W4A0ktcwoi"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="nojsja 个人博客"><meta name="keyword" content=""><link rel="shortcut icon" href="/img/favicon.ico"><link href="/fonts/fontawesome-webfont.woff2?v=4.3.0" rel="preload" as="font" crossorigin><link href="https://www.google-analytics.com" rel="preconnect" crossorigin><link href="http://busuanzi.ibruce.info" rel="preconnect" crossorigin><link href="http://nojsja.gitee.io" rel="preconnect" crossorigin><title>VSCode 架构学习笔记 - nojsja | Blog</title><link rel="canonical" href="https://nojsja.github.io/blogs/2023/07/09/9c53abdb.html/"><link href="https://cdn.usebootstrap.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/dusign-light.css"><link rel="stylesheet" href="/css/github-markdown.min.css"><style>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media (max-width:767px){.markdown-body{padding:15px}}</style><link rel="stylesheet" href="/css/widget.css"><link rel="stylesheet" href="/css/fonts.googleapis.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><script>function async(e,t,a,n){var c=document.head||document.getElementsByTagName("head")[0]||document.documentElement,d=document,r=a||"script",s=d.createElement(r),l=d.getElementsByTagName(r)[0];switch(n=["async","defer"].includes(n)?n:!!n,r){case"script":s.src=e,n&&(s[n]=!0);break;case"link":s.type="text/css",s.href=e,s.rel="stylesheet";break;default:s.src=e}t&&(s.readyState?s.onreadystatechange=function(e){"loaded"!=s.readyState&&"complete"!=s.readyState||(s.onreadystatechange=null,t(null,e)())}:s.onload=function(e){t(null,e)}),l.parentNode.insertBefore(s,c.firstChild)}</script><script>function sendXMLHttpRequest(e){var t=e.url,n=(e.method||"get").toUpperCase(),s=e.callback,a=!("async"in e)||!!e.async,c=null;t&&((c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).open(n,t,a),c.onreadystatechange=function(){4===this.readyState&&(s&&s(this.responseText),c.onreadystatechange=null)},c.send(null))}</script><script>var fnDebounce=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void(t=Date.now()):t=Date.now()}},fnThrottle=function(n,l){var t=null;return function(){return t?Date.now()-t>=l?(t=null,n.apply(this,[].slice.call(arguments))):void 0:t=Date.now()}}</script><script>"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype?"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}}):sendXMLHttpRequest({url:"/js/intersection-observer.js",async:!1,method:"get",callback:function(txt){eval(txt)}})</script><script src="/js/buttons.js" async defer></script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="nojsja" type="application/atom+xml">
</head><body><style type="text/css">header.intro-header{background-image:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.3)),url(https://nojsja.gitee.io/static-resources/images/hexo/article_header/article_header.jpg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#vscode" title="vscode">vscode</a></div><h1>VSCode 架构学习笔记</h1><h2 class="subheading">VSCode architecture learning notes</h2><span class="meta"><span class="post-description"><i class="fa fa-user" aria-hidden="true"></i> nojsja </span><span class="post-description"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-09</span></span><div class="blank_box"></div><span class="meta">字数：<span class="post-count">6.1k</span>丨 阅读时间：<span class="post-count">29</span> 分钟</span><div class="blank_box"></div></div></div></div></div></div><div class="waveWrapper"><div class="wave wave_before" style="background-image:url(/img/wave-light.png)"></div><div class="wave wave_after" style="background-image:url(/img/wave-light.png)"></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">nojsja</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">首页</a></li><li><a href="/archive/">时间轴</a></li><li><a href="/categories/">目录</a></li><li><a href="/about/">关于</a></li><li><a href="/tags/">标签</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout((function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")}),400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><style>.table-responsive{border:none!important}</style><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container markdown-body"><h1>VSCode 架构学习笔记</h1><blockquote><p>持续更新中</p></blockquote><h2 id="一、源码目录结构">一、源码目录结构</h2><h3 id="1-1-总览">1.1 总览</h3><p><strong>核心层</strong></p><ul><li>base: 提供通用服务和构建用户界面</li><li>platform: 注入服务和基础服务代码</li><li>editor: 微软 Monaco 编辑器，也可独立运行使用</li><li>wrokbench: 配合 Monaco 并且给 viewlets 提供框架：如：浏览器状态栏，菜单栏利用 electron 实现桌面程序</li></ul><p><strong>核心环境</strong></p><p>整个项目完全使用 typescript 实现，electron 中运行主进程和渲染进程，使用的 api 有所不同，所以在 core 中每个目录组织也是按照使用的 api 来安排，<br>运行的环境分为几类：</p><ul><li>common: 只使用 javascritp api 的代码，能在任何环境下运行。</li><li>browser: 浏览器 api, 如操作 dom; 可以调用 common。</li><li>node: 需要使用 node 的 api,比如文件 io 操作。</li><li>electron-brower: 渲染进程 api, 可以调用 common, brower, node, 依赖 <a href="https://link.zhihu.com/?target=https%3A//github.com/electron/electron/tree/master/docs%23modules-for-the-renderer-process-web-page" rel="external nofollow noreferrer">electron renderer-process API</a>。</li><li>electron-main: 主进程 api, 可以调用: common, node 依赖于 <a href="https://link.zhihu.com/?target=https%3A//github.com/electron/electron/tree/master/docs%23modules-for-the-main-process" rel="external nofollow noreferrer">electron main-process AP</a>。</li></ul><h3 id="1-2-目录解析">1.2 目录解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">├── build         <span class="comment"># gulp编译构建脚本</span></span><br><span class="line">├── extensions    <span class="comment"># 内置插件</span></span><br><span class="line">├── product.json  <span class="comment"># App meta信息</span></span><br><span class="line">├── resources     <span class="comment"># 平台相关静态资源</span></span><br><span class="line">├── scripts       <span class="comment"># 工具脚本，开发/测试</span></span><br><span class="line">├── src           <span class="comment"># 源码目录</span></span><br><span class="line">└── typings       <span class="comment"># 函数语法补全定义</span></span><br><span class="line">└── vs</span><br><span class="line">    ├── base        <span class="comment"># 通用工具/协议和UI库</span></span><br><span class="line">    │   ├── browser <span class="comment"># 基础UI组件，DOM操作</span></span><br><span class="line">    │   ├── common  <span class="comment"># diff描述，markdown解析器，worker协议，各种工具函数</span></span><br><span class="line">    │   ├── node    <span class="comment"># Node工具函数</span></span><br><span class="line">    │   ├── parts   <span class="comment"># IPC协议（Electron、Node），quickopen、tree组件</span></span><br><span class="line">    │   ├── <span class="built_in">test</span>    <span class="comment"># base单测用例</span></span><br><span class="line">    │   └── worker  <span class="comment"># Worker factory和main Worker（运行IDE Core：Monaco）</span></span><br><span class="line">    ├── code        <span class="comment"># VSCode应用主进程入口</span></span><br><span class="line">    ├── editor        <span class="comment"># IDE代码编辑器</span></span><br><span class="line">    |   ├── browser     <span class="comment"># 代码编辑器核心</span></span><br><span class="line">    |   ├── common      <span class="comment"># 代码编辑器核心</span></span><br><span class="line">    |   ├── contrib     <span class="comment"># vscode 与独立 IDE共享的代码</span></span><br><span class="line">    |   └── standalone  <span class="comment"># 独立 IDE 独有的代码</span></span><br><span class="line">    ├── platform      <span class="comment"># 支持注入服务和平台相关基础服务（文件、剪切板、窗体、状态栏）</span></span><br><span class="line">    ├── workbench     <span class="comment"># 工作区UI布局，功能主界面</span></span><br><span class="line">    │   ├── api              <span class="comment">#</span></span><br><span class="line">    │   ├── browser          <span class="comment">#</span></span><br><span class="line">    │   ├── common           <span class="comment">#</span></span><br><span class="line">    │   ├── contrib          <span class="comment">#</span></span><br><span class="line">    │   ├── electron-browser <span class="comment">#</span></span><br><span class="line">    │   ├── services         <span class="comment">#</span></span><br><span class="line">    │   └── <span class="built_in">test</span>             <span class="comment">#</span></span><br><span class="line">    ├── css.build.js  <span class="comment"># 用于插件构建的CSS loader</span></span><br><span class="line">    ├── css.js        <span class="comment"># CSS loader</span></span><br><span class="line">    ├── editor        <span class="comment"># 对接IDE Core（读取编辑/交互状态），提供命令、上下文菜单、hover、snippet等支持</span></span><br><span class="line">    ├── loader.js     <span class="comment"># AMD loader（用于异步加载AMD模块）</span></span><br><span class="line">    ├── nls.build.js  <span class="comment"># 用于插件构建的NLS loader</span></span><br><span class="line">    └── nls.js        <span class="comment"># NLS（National Language Support）多语言loader=</span></span><br></pre></td></tr></table></figure><h2 id="二、Electron-进程">二、Electron 进程</h2><p>VSCode 基于 Electron 开发，Electron 应用中的进程：</p><ul><li>1 个主进程：一个 Electron App 只会启动一个主进程，它会运行 package.json 的 main 字段指定的脚本。</li><li>N 个渲染进程：主进程代码可以调用 Chromium API 创建任意多个 web 页面，而 Chromium 本身是多进程架构，每个 web 页面都运行在属于它自己的渲染进程中。</li><li>Node.js 子进程：Electron 主进程中也可以使用 Node.js 子进程创建 API 创建多个 Node.js 子进程。</li></ul><h3 id="2-1-进程间通讯">2.1 进程间通讯</h3><p>Render 进程之间的通讯本质上和多个 Web 页面之间通讯没有差别，可以使用各种浏览器能力如 localStorage。Render 进程与 Main 进程之间也可以通过 API 互相通讯 (ipcRenderer/ipcMain)</p><h3 id="2-2-远程调用">2.2 远程调用</h3><p>普通 web 页面无法调用 native api，因此缺少一些能力。electron 的 web 页面所处的 Render 进程可以通过同步IPC通信将任务转发至运行在 NodeJS 环境的 Main 进程，从而实现 native API 调用。</p><p>这套架构大大扩展了 Electron app 相比 web app 的能力丰富度，但同时又保留了 web 快捷流畅的开发体验。</p><p>远程调用的相关内部逻辑也值得学习，可以看下 <code>electron/remote</code> 的实现源码，简单来讲就是 Electron 在 渲染进程 Clone 了一个和主进程 API 完全一致的对象，用户在渲染进程调用某个主进程同名 API 时会触发到主进程的同步 IPC 通信，主进程执行完成后再通过 IPC 将数据发送回来。</p><p>不过远程调用也有一些缺点，比如：同步 IPC 调用导致的线程阻塞，IPC 序列化/反序列化的性能损失等。</p><h2 id="三、VSCode多进程架构">三、VSCode多进程架构</h2><ul><li>主进程：VSCode 的入口进程，负责一些类似窗口管理、进程间通信、自动更新等全局任务</li><li>渲染进程：负责一个 Web 页面的渲染</li><li>插件宿主进程：每个插件的代码都会运行在一个独属于自己的 NodeJS 环境的宿主进程中，插件不允许访问 UI</li><li>Debug 进程：Debugger 相比普通插件做了特殊化</li><li>Search 进程：搜索是一类计算密集型的任务，单开进程保证软件整体体验与性能</li></ul><h2 id="四、Service-服务">四、Service 服务</h2><p>VSCode 中的所有基础功能都被视为服务 Service，比如：右键菜单 ContextMenuService、剪贴板 ClipboardService，大部分 Service 都继承自一个抽象类 - Disposable，而该抽象类继承自接口 IDisposable。</p><h3 id="4-1-Service-的底层基类">4.1 Service 的底层基类</h3><p><strong>Interface Disposable</strong></p><blockquote><p>src/vs/base/common/lifecycle.ts</p></blockquote><p>接口只有一个 dispose 方法，用于对象销毁时取消监听器或清理数据。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An object that performs a cleanup operation when `.dispose()` is called.</span></span><br><span class="line"><span class="comment">** Some examples of how disposables are used:</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* - An event listener that removes itself when `.dispose()` is called.</span></span><br><span class="line"><span class="comment">* - A resource such as a file system watcher that cleans up the resource when `.dispose()` is called.</span></span><br><span class="line"><span class="comment">* - The return value from registering a provider. When `.dispose()` is called, the provider is unregistered.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span>  <span class="keyword">interface</span>  <span class="title class_">IDisposable</span> &#123;</span><br><span class="line">    <span class="title function_">dispose</span>(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Abstract Class IDisposable</strong></p><blockquote><p>src/vs/base/common/lifecycle.ts</p></blockquote><p>抽象类对接口做了一些公用用方法和属性扩展：</p><ul><li>None：一个空的 disposable 对象</li><li>_store：管理多个 disposable 对象的存储空间，一个 Service 可能会存放多个 disposable 对象（<em>内部实现的 Emitter 事件触发器也属于 disposable，后面会专门说明 Emitter 的几种实现方式</em>），使用 Store 统一管理起来，当服务实例销毁时会自动调用这些 disposable 对象。_store 自身也是 disposable 的。</li><li>dispose：用于触发所有 disposable 对象的 dispose 方法。</li><li>_register：向 store 注册 disposables 对象。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Abstract base class for a &#123;<span class="doctag">@link</span> IDisposable disposable&#125; object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Subclasses can &#123;<span class="doctag">@linkcode</span> _register&#125; disposables that will be automatically cleaned up when this object is disposed of.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Disposable</span> <span class="keyword">implements</span> <span class="title class_">IDisposable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A disposable that does nothing when it is disposed of.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">TODO:</span> This should not be a static property.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="title class_">None</span> = <span class="title class_">Object</span>.<span class="property">freeze</span>&lt;<span class="title class_">IDisposable</span>&gt;(&#123; <span class="title function_">dispose</span>(<span class="params"></span>) &#123; &#125; &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> _store = <span class="keyword">new</span> <span class="title class_">DisposableStore</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">trackDisposable</span>(<span class="variable language_">this</span>);</span><br><span class="line">        <span class="title function_">setParentOfDisposable</span>(<span class="variable language_">this</span>.<span class="property">_store</span>, <span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">dispose</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title function_">markAsDisposed</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_store</span>.<span class="title function_">dispose</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds `o` to the collection of disposables managed by this object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> _register&lt;T <span class="keyword">extends</span> <span class="title class_">IDisposable</span>&gt;(<span class="attr">o</span>: T): T &#123;</span><br><span class="line">        <span class="keyword">if</span> ((o <span class="keyword">as</span> <span class="built_in">unknown</span> <span class="keyword">as</span> <span class="title class_">Disposable</span>) === <span class="variable language_">this</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Cannot register a disposable on itself!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_store</span>.<span class="title function_">add</span>(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-Service-依赖注入">4.2 Service 依赖注入</h3><p>依赖注入作为一个设计模式，前端开发者可能使用的不多，但在 VSCode 的源码中随处可见，所以这里简单介绍下。首先看依赖注入的定义：</p><blockquote><p>在软件工程中，依赖注入是一种为一类对象提供依赖的对象的设计模式。被依赖的对象称为 <code>Service</code>，注入则是指将被依赖的对象 <code>Service</code>传递给使用服务的对象(称为 <code>Client</code>)，从而客户 <code>Client</code>不需要主动去建立(new)依赖的服务 <code>Service</code>，也不需要通过工厂模式去获取依赖的服务 <code>Service</code>。</p></blockquote><p>在典型的依赖注入模式中，存在以下几类角色：</p><ul><li>被依赖和使用的对象，即 <code>Service</code></li><li>使用服务的客户对象，即 <code>Client</code></li><li>客户使用服务的接口定义，<code>Interface</code></li><li>注入器：负责建立服务对象并提供给 Client，通常也负责建立客户对象</li></ul><p>而依赖注入的实现有几种形态，其中常见的一种的构造函数式的依赖注入：Client 在其构造函数的参数中申明所依赖的 Service，如下 TypeScript 代码所示：</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params">serviceA: ServiceA, serviceB: ServiceB</span>) &#123;</span><br><span class="line">		<span class="comment">// 注入器在建立Client的时候，将依赖的 Service 通过构造函数参数传递给 Client</span></span><br><span class="line">		<span class="comment">// Client此时即可将依赖的服务保存在自身状态内：</span></span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">serviceA</span> = serviceA;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">serviceB</span> = serviceB;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过这种模式，Client 在使用的时候不需要去自己构造需要的 Service 对象，这样的好处之一就就是将对象的构造和行为分离，在引入接口后，Client 和 Service 的依赖关系只需要接口来定义，Client 在构造函数参数中主需要什么依赖的服务接口，结合注入器，能给客户对象更多的灵活性和解耦。</p><p>最后，在 VSCode 的源码中，大部分基础功能是被实现为服务对象，一个服务的定义分为两部分：</p><ul><li>服务的接口</li><li>服务的标识：通过 TypeScript 中的装饰器实现</li></ul><p>Client 在申明依赖的 Service 时，同样时在构造函数参数中申明，实例如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">		<span class="meta">@IModelService</span> modelService: IModelService,</span></span><br><span class="line"><span class="params">		<span class="meta">@optional</span>(IEditorService) editorService: IEditorService,</span></span><br><span class="line"><span class="params">	</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">modelService</span> = modelService;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">editorService</span> = editorService;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，申明的客户对象 <code>Client</code>，所依赖的 <code>Service</code>有 <code>IModelService</code>和 <code>IEditorService</code>，其中装饰器 <code>@IModelService</code>是 ModelService 的标识，后面的 <code>IModelService</code>只是 TypeScript 中的接口定义；<code>@optional(IEditorService)</code>是 EditorService 的标识，同时通过 <code>optional</code>的装饰申明为可选的依赖。</p><p>最后，在代码中实际使用 <code>Client</code>对象时，需要通过注入器提供的 <code>instantiationService</code>来实例化的到 Client 的实例：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myClient = instantiationService.<span class="title function_">createInstance</span>(<span class="title class_">Client</span>);</span><br></pre></td></tr></table></figure><h3 id="4-3-基本服务">4.3 基本服务</h3><h4 id="4-3-1-存储服务-IStorageMainService">4.3.1 存储服务 - IStorageMainService</h4><blockquote><p>src/vs/platform/storage/electron-main/storageMainService.ts</p></blockquote><h4 id="4-3-2-配置服务-IConfigurationService">4.3.2 配置服务 - IConfigurationService</h4><blockquote><p>src/vs/platform/configuration/common/configurationService.ts</p></blockquote><h4 id="4-3-3-状态服务-IStateService">4.3.3 状态服务 - IStateService</h4><blockquote><p>src/vs/platform/state/node/stateService.ts</p></blockquote><h4 id="4-3-4-生命周期服务-ILifecycleMainService">4.3.4 生命周期服务 - ILifecycleMainService</h4><blockquote><p>src/vs/platform/lifecycle/electron-main/lifecycleMainService.ts</p></blockquote><h3 id="4-4-窗口和视图-Webview-管理">4.4 窗口和视图(Webview)管理</h3><h4 id="4-4-1-浏览器窗口-ICodeWindow">4.4.1 浏览器窗口 - ICodeWindow</h4><blockquote><p>src/vs/platform/windows/electron-main/windowImpl.ts</p></blockquote><h4 id="4-4-2-窗口管理服务-IWindowsMainService">4.4.2 窗口管理服务 - IWindowsMainService</h4><blockquote><p>src/vs/platform/windows/electron-main/windowsMainService.ts</p></blockquote><h4 id="4-4-4-Webview-管理服务-IWebviewManagerService">4.4.4 Webview 管理服务 - IWebviewManagerService</h4><blockquote><p>src/vs/platform/webview/electron-main/webviewMainService.ts</p></blockquote><h2 id="五、服务实例化过程">五、服务实例化过程</h2><p>5.2 InstantiationService：负责实例化 Service 的 Service</p><p>负责实例化 Service 的模块也被封装为一个 Service 即 InstantiationService - 实例化服务。</p><blockquote><p>src/vs/platform/instantiation/common/instantiation.ts</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">IInstantiationService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">_serviceBrand</span>: <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Synchronously creates an instance that is denoted by the descriptor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    createInstance&lt;T&gt;(<span class="attr">descriptor</span>: descriptors.<span class="property">SyncDescriptor0</span>&lt;T&gt;): T;</span><br><span class="line">    createInstance&lt;<span class="title class_">Ctor</span> <span class="keyword">extends</span> <span class="keyword">new</span> (...<span class="attr">args</span>: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span>, R <span class="keyword">extends</span> <span class="title class_">InstanceType</span>&lt;<span class="title class_">Ctor</span>&gt;&gt;(<span class="attr">ctor</span>: <span class="title class_">Ctor</span>, ...<span class="attr">args</span>: <span class="title class_">GetLeadingNonServiceArgs</span>&lt;<span class="title class_">ConstructorParameters</span>&lt;<span class="title class_">Ctor</span>&gt;&gt;): R;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calls a function with a service accessor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    invokeFunction&lt;R, <span class="variable constant_">TS</span> <span class="keyword">extends</span> <span class="built_in">any</span>[] = []&gt;(<span class="attr">fn</span>: <span class="function">(<span class="params">accessor: ServicesAccessor, ...args: TS</span>) =&gt;</span> R, ...<span class="attr">args</span>: <span class="variable constant_">TS</span>): R;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a child of this service which inherits all current services</span></span><br><span class="line"><span class="comment">     * and adds/overwrites the given services.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">createChild</span>(<span class="attr">services</span>: <span class="title class_">ServiceCollection</span>): <span class="title class_">IInstantiationService</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实例化服务的逻辑稍稍复杂一点，大致解读一下关键点和主流程：</p><h4 id="5-2-1-ServiceCollection-服务集合">5.2.1 ServiceCollection 服务集合</h4><p>内部封装了 Map 用于存储 <strong>ServiceIdentifier</strong> 和 <strong>InstanceOrDescriptor</strong> 的映射关系。</p><p>ServiceIdentifier 即描述 Service 的标识符对象，对象上有一个 type 字段。其使用方式是作为 Service 构造函数<strong>参数的装饰器</strong>，TS 解析类定义时（非实例化阶段）会调用 ServiceIdentifier 内部逻辑来<strong>收集依赖关系</strong>，在类的实例化阶段会使用这些依赖信息来创建依赖图谱进行依赖分析，在 Service 实例化之前确保所有依赖服务已经被创建好了。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">storeServiceDependency</span>(<span class="params">id: <span class="built_in">Function</span>, target: <span class="built_in">Function</span>, index: <span class="built_in">number</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ((target <span class="keyword">as</span> <span class="built_in">any</span>)[_util.<span class="property">DI_TARGET</span>] === target) &#123;</span><br><span class="line">		(target <span class="keyword">as</span> <span class="built_in">any</span>)[_util.<span class="property">DI_DEPENDENCIES</span>].<span class="title function_">push</span>(&#123; id, index &#125;);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		(target <span class="keyword">as</span> <span class="built_in">any</span>)[_util.<span class="property">DI_DEPENDENCIES</span>] = [&#123; id, index &#125;];</span><br><span class="line">		(target <span class="keyword">as</span> <span class="built_in">any</span>)[_util.<span class="property">DI_TARGET</span>] = target;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DialogMainService</span> <span class="keyword">implements</span> <span class="title class_">IDialogMainService</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">		<span class="meta">@ILogService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> logService: ILogService,</span></span><br><span class="line"><span class="params">		<span class="meta">@IProductService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> productService: IProductService</span></span><br><span class="line"><span class="params">	</span>) &#123;</span><br><span class="line">	  ...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InstanceOrDescriptor 即 Service 实例或 Service 描述对象。因为有些服务是需要延迟创建的，因此只需要临时存储一下创建过程。</p><p>Service 实例不必多说，由 Service 类实例化而来。以下是一个 Service 描述对象的结构，包含实例化 Service 时用到的参数和构造器函数：</p><blockquote><p>src/vs/platform/instantiation/common/descriptors.ts</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">SyncDescriptor</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">ctor</span>: <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">staticArguments</span>: <span class="built_in">any</span>[];</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">supportsDelayedInstantiation</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ctor: <span class="keyword">new</span> (...args: <span class="built_in">any</span>[]) =&gt; T, staticArguments: <span class="built_in">any</span>[] = [], supportsDelayedInstantiation: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctor</span> = ctor;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">staticArguments</span> = staticArguments;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">supportsDelayedInstantiation</span> = supportsDelayedInstantiation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-2-Graph-服务依赖图谱">5.2.2 Graph 服务依赖图谱</h4><p>简单的图算法，图数据结构中包含多个图节点，每个节点拥有<strong>入度</strong>和<strong>出度</strong>分别表明依赖当前节点的前置节点和当前节点依赖的后置节点。</p><p>Graph 结构中可以执行这些操作：新建图节点、查找图节点、获取所有根节点（出度为0，不依赖后置节点）、检测是否存在环、移除图节点等。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">readonly</span> incoming = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Node</span>&lt;T&gt;&gt;();</span><br><span class="line">    <span class="keyword">readonly</span> outgoing = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Node</span>&lt;T&gt;&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="keyword">readonly</span> key: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">        <span class="keyword">readonly</span> data: T</span></span><br><span class="line"><span class="params">    </span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Graph</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> _nodes = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Node</span>&lt;T&gt;&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> _hashFn: (element: T) =&gt; <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">roots</span>(): <span class="title class_">Node</span>&lt;T&gt;[] &#123;...&#125;</span><br><span class="line">    <span class="title function_">insertEdge</span>(<span class="attr">from</span>: T, <span class="attr">to</span>: T): <span class="built_in">void</span> &#123;...&#125;</span><br><span class="line">    <span class="title function_">removeNode</span>(<span class="attr">data</span>: T): <span class="built_in">void</span> &#123;...&#125;</span><br><span class="line">    <span class="title function_">lookupOrInsertNode</span>(<span class="attr">data</span>: T): <span class="title class_">Node</span>&lt;T&gt; &#123;...&#125;</span><br><span class="line">    <span class="title function_">lookup</span>(<span class="attr">data</span>: T): <span class="title class_">Node</span>&lt;T&gt; | <span class="literal">undefined</span> &#123;...&#125;</span><br><span class="line">    <span class="title function_">isEmpty</span>(): <span class="built_in">boolean</span> &#123;...&#125;</span><br><span class="line">    <span class="title function_">toString</span>(): <span class="built_in">string</span> &#123;...&#125;</span><br><span class="line">    <span class="title function_">findCycleSlow</span>(<span class="params"></span>) &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="5-2-3-创建依赖服务">5.2.3 创建依赖服务</h4><p>创建一个服务实例时，会先收集该服务的所有依赖服务（ServiceIdentifier 实现依赖分析），然后根据这些依赖服务来创建服务依赖图谱。图谱创建之后，会先选出出度为的 0 的根节点（无其它依赖服务）进行创建，创建好后将根节点从图谱中删除，过程中使用 while 循环重复上述过程直到图谱中没有任何节点。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">private</span> _createAndCacheServiceInstance&lt;T&gt;(<span class="attr">id</span>: <span class="title class_">ServiceIdentifier</span>&lt;T&gt;, <span class="attr">desc</span>: <span class="title class_">SyncDescriptor</span>&lt;T&gt;, <span class="attr">_trace</span>: <span class="title class_">Trace</span>): T &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Triple</span> = &#123; <span class="attr">id</span>: <span class="title class_">ServiceIdentifier</span>&lt;<span class="built_in">any</span>&gt;; <span class="attr">desc</span>: <span class="title class_">SyncDescriptor</span>&lt;<span class="built_in">any</span>&gt;; <span class="attr">_trace</span>: <span class="title class_">Trace</span> &#125;;</span><br><span class="line">    <span class="keyword">const</span> graph = <span class="keyword">new</span> <span class="title class_">Graph</span>&lt;<span class="title class_">Triple</span>&gt;(<span class="function"><span class="params">data</span> =&gt;</span> data.<span class="property">id</span>.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cycleCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> stack = [&#123; id, desc, _trace &#125;];</span><br><span class="line">    <span class="keyword">while</span> (stack.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> item = stack.<span class="title function_">pop</span>()!;</span><br><span class="line">        graph.<span class="title function_">lookupOrInsertNode</span>(item);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// a weak but working heuristic for cycle checks</span></span><br><span class="line">        <span class="keyword">if</span> (cycleCount++ &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CyclicDependencyError</span>(graph);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check all dependencies for existence and if they need to be created first</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> dependency <span class="keyword">of</span> _util.<span class="title function_">getServiceDependencies</span>(item.<span class="property">desc</span>.<span class="property">ctor</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> instanceOrDesc = <span class="variable language_">this</span>.<span class="title function_">_getServiceInstanceOrDescriptor</span>(dependency.<span class="property">id</span>);</span><br><span class="line">            <span class="keyword">if</span> (!instanceOrDesc) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_throwIfStrict</span>(<span class="string">`[createInstance] <span class="subst">$&#123;id&#125;</span> depends on <span class="subst">$&#123;dependency.id&#125;</span> which is NOT registered.`</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// take note of all service dependencies</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_globalGraph</span>?.<span class="title function_">insertEdge</span>(<span class="title class_">String</span>(item.<span class="property">id</span>), <span class="title class_">String</span>(dependency.<span class="property">id</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (instanceOrDesc <span class="keyword">instanceof</span> <span class="title class_">SyncDescriptor</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> d = &#123; <span class="attr">id</span>: dependency.<span class="property">id</span>, <span class="attr">desc</span>: instanceOrDesc, <span class="attr">_trace</span>: item.<span class="property">_trace</span>.<span class="title function_">branch</span>(dependency.<span class="property">id</span>, <span class="literal">true</span>) &#125;;</span><br><span class="line">                graph.<span class="title function_">insertEdge</span>(item, d);</span><br><span class="line">                stack.<span class="title function_">push</span>(d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> roots = graph.<span class="title function_">roots</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if there is no more roots but still</span></span><br><span class="line">        <span class="comment">// nodes in the graph we have a cycle</span></span><br><span class="line">        <span class="keyword">if</span> (roots.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!graph.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CyclicDependencyError</span>(graph);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> &#123; data &#125; <span class="keyword">of</span> roots) &#123;</span><br><span class="line">            <span class="comment">// Repeat the check for this still being a service sync descriptor. That&#x27;s because</span></span><br><span class="line">            <span class="comment">// instantiating a dependency might have side-effect and recursively trigger instantiation</span></span><br><span class="line">            <span class="comment">// so that some dependencies are now fullfilled already.</span></span><br><span class="line">            <span class="keyword">const</span> instanceOrDesc = <span class="variable language_">this</span>.<span class="title function_">_getServiceInstanceOrDescriptor</span>(data.<span class="property">id</span>);</span><br><span class="line">            <span class="keyword">if</span> (instanceOrDesc <span class="keyword">instanceof</span> <span class="title class_">SyncDescriptor</span>) &#123;</span><br><span class="line">                <span class="comment">// create instance and overwrite the service collections</span></span><br><span class="line">                <span class="keyword">const</span> instance = <span class="variable language_">this</span>.<span class="title function_">_createServiceInstanceWithOwner</span>(data.<span class="property">id</span>, data.<span class="property">desc</span>.<span class="property">ctor</span>, data.<span class="property">desc</span>.<span class="property">staticArguments</span>, data.<span class="property">desc</span>.<span class="property">supportsDelayedInstantiation</span>, data.<span class="property">_trace</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_setServiceInstance</span>(data.<span class="property">id</span>, instance);</span><br><span class="line">            &#125;</span><br><span class="line">            graph.<span class="title function_">removeNode</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &lt;T&gt;<span class="variable language_">this</span>.<span class="title function_">_getServiceInstanceOrDescriptor</span>(id);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="5-2-4-创建服务实例">5.2.4 创建服务实例</h4><blockquote><p>src/vs/platform/instantiation/common/instantiationService.ts</p></blockquote><p>依赖服务都创建好后，可以开始创建 Service 实例了。Service 类有个参数叫 supportsDelayedInstantiation - 是否支持延迟实例化，这个参数将 Service 实例分为必须<strong>立即创建</strong>的服务和在实际使用或空闲时才创建的<strong>延迟服务</strong>。</p><p><strong>立即创建</strong>服务逻辑在 _createInstance 方法中：先获取当前服务的所有依赖服务（已实例化），然后将所有依赖服务和静态参数组装成数组并调用 Reflect.construct API 使用构造函数创建对象：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> _createInstance&lt;T&gt;(<span class="attr">ctor</span>: <span class="built_in">any</span>, <span class="attr">args</span>: <span class="built_in">any</span>[] = [], <span class="attr">_trace</span>: <span class="title class_">Trace</span>): T &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// arguments defined by service decorators</span></span><br><span class="line">  <span class="keyword">const</span> serviceDependencies = _util.<span class="title function_">getServiceDependencies</span>(ctor).<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">index</span> - b.<span class="property">index</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">serviceArgs</span>: <span class="built_in">any</span>[] = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> dependency <span class="keyword">of</span> serviceDependencies) &#123;</span><br><span class="line">   <span class="keyword">const</span> service = <span class="variable language_">this</span>.<span class="title function_">_getOrCreateServiceInstance</span>(dependency.<span class="property">id</span>, _trace);</span><br><span class="line">   <span class="keyword">if</span> (!service) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_throwIfStrict</span>(<span class="string">`[createInstance] <span class="subst">$&#123;ctor.name&#125;</span> depends on UNKNOWN service <span class="subst">$&#123;dependency.id&#125;</span>.`</span>, <span class="literal">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   serviceArgs.<span class="title function_">push</span>(service);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> firstServiceArgPos = serviceDependencies.<span class="property">length</span> &gt; <span class="number">0</span> ? serviceDependencies[<span class="number">0</span>].<span class="property">index</span> : args.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check for argument mismatches, adjust static args if needed</span></span><br><span class="line">  <span class="keyword">if</span> (args.<span class="property">length</span> !== firstServiceArgPos) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">`[createInstance] First service dependency of <span class="subst">$&#123;ctor.name&#125;</span> at position <span class="subst">$&#123;firstServiceArgPos + <span class="number">1</span>&#125;</span> conflicts with <span class="subst">$&#123;args.length&#125;</span> static arguments`</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> delta = firstServiceArgPos - args.<span class="property">length</span>;</span><br><span class="line">   <span class="keyword">if</span> (delta &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    args = args.<span class="title function_">concat</span>(<span class="keyword">new</span> <span class="title class_">Array</span>(delta));</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    args = args.<span class="title function_">slice</span>(<span class="number">0</span>, firstServiceArgPos);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now create the instance</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="property">construct</span>&lt;<span class="built_in">any</span>, T&gt;(ctor, args.<span class="title function_">concat</span>(serviceArgs));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>延迟创建</strong>服务的整体思路是先创建一个 <strong>IdleValue</strong> 空对象（内部通过 <strong>requestIdleCallback</strong> 在空闲时初始化构造函数）、创建事件监听器列表。返回一个 Proxy 代理对象，Proxy 对象监听目标 Service 对象 <code>get</code> 方法获取目标属性并返回 IdleValue 对象上相应的属性，如果此时 IdleValue 仍然没执行初始化构造函数逻辑，则会在此步中立即开始初始化构造函数。</p><p>Service 的一些特定异步回调函数比如 <code>onDidXXX / onWillXXX</code>等也是在 Proxy.get 监听方法中被添加到事件列表里，等待在构造函数初始化后被触发。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> _createServiceInstance&lt;T&gt;(<span class="attr">id</span>: <span class="title class_">ServiceIdentifier</span>&lt;T&gt;, <span class="attr">ctor</span>: <span class="built_in">any</span>, <span class="attr">args</span>: <span class="built_in">any</span>[] = [], <span class="attr">supportsDelayedInstantiation</span>: <span class="built_in">boolean</span>, <span class="attr">_trace</span>: <span class="title class_">Trace</span>): T &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsDelayedInstantiation) &#123;</span><br><span class="line">   <span class="comment">// eager instantiation</span></span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_createInstance</span>(ctor, args, _trace);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> child = <span class="keyword">new</span> <span class="title class_">InstantiationService</span>(<span class="literal">undefined</span>, <span class="variable language_">this</span>.<span class="property">_strict</span>, <span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">_enableTracing</span>);</span><br><span class="line">   child.<span class="property">_globalGraphImplicitDependency</span> = <span class="title class_">String</span>(id);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// return &quot;empty events&quot; when the service isn&#x27;t instantiated yet</span></span><br><span class="line">   <span class="keyword">const</span> earlyListeners = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">LinkedList</span>&lt;<span class="title class_">Parameters</span>&lt;<span class="title class_">Event</span>&lt;<span class="built_in">any</span>&gt;&gt;&gt;&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> idle = <span class="keyword">new</span> <span class="title class_">IdleValue</span>&lt;<span class="built_in">any</span>&gt;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = child.<span class="property">_createInstance</span>&lt;T&gt;(ctor, args, _trace);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [key, values] <span class="keyword">of</span> earlyListeners) &#123;</span><br><span class="line">     <span class="keyword">const</span> candidate = &lt;<span class="title class_">Event</span>&lt;<span class="built_in">any</span>&gt;&gt;(&lt;<span class="built_in">any</span>&gt;result)[key];</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> candidate === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> listener <span class="keyword">of</span> values) &#123;</span><br><span class="line">       candidate.<span class="title function_">apply</span>(result, listener);</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    earlyListeners.<span class="title function_">clear</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">return</span> &lt;T&gt;<span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="attr">target</span>: <span class="built_in">any</span>, <span class="attr">key</span>: <span class="title class_">PropertyKey</span>): <span class="built_in">any</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!idle.<span class="property">isInitialized</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; (key.<span class="title function_">startsWith</span>(<span class="string">&#x27;onDid&#x27;</span>) || key.<span class="title function_">startsWith</span>(<span class="string">&#x27;onWill&#x27;</span>))) &#123;</span><br><span class="line">       <span class="keyword">let</span> list = earlyListeners.<span class="title function_">get</span>(key);</span><br><span class="line">       <span class="keyword">if</span> (!list) &#123;</span><br><span class="line">        list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>();</span><br><span class="line">        earlyListeners.<span class="title function_">set</span>(key, list);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">const</span> <span class="attr">event</span>: <span class="title class_">Event</span>&lt;<span class="built_in">any</span>&gt; = <span class="function">(<span class="params">callback, thisArg, disposables</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> rm = list!.<span class="title function_">push</span>([callback, thisArg, disposables]);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">toDisposable</span>(rm);</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">return</span> event;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// value already exists</span></span><br><span class="line">     <span class="keyword">if</span> (key <span class="keyword">in</span> target) &#123;</span><br><span class="line">      <span class="keyword">return</span> target[key];</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// create value</span></span><br><span class="line">     <span class="keyword">const</span> obj = idle.<span class="property">value</span>;</span><br><span class="line">     <span class="keyword">let</span> prop = obj[key];</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> prop !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> prop;</span><br><span class="line">     &#125;</span><br><span class="line">     prop = prop.<span class="title function_">bind</span>(obj);</span><br><span class="line">     target[key] = prop;</span><br><span class="line">     <span class="keyword">return</span> prop;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="attr">_target</span>: T, <span class="attr">p</span>: <span class="title class_">PropertyKey</span>, <span class="attr">value</span>: <span class="built_in">any</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">     idle.<span class="property">value</span>[p] = value;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">getPrototypeOf</span>(<span class="params">_target: T</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> ctor.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="六、VSCode-应用入口">六、VSCode 应用入口</h2><h3 id="6-1-CodeMain">6.1 CodeMain</h3><blockquote><p>src/vs/code/electron-main/main.ts</p></blockquote><p>VSCode 至多只会启用一个 CodeMain 实例，它是整个 VSCode 应用的入口，它的入口方法是 main 方法，会调用 <code>startup</code> 方法启动应用。</p><p>CodeMain 的主要职责：</p><ul><li>调用 createServices 方法创建所有 <code>基础服务</code>和 <code>InstantiationService 实例化服务</code>。</li><li>调用 initServices 方法创建目录并初始化服务。</li><li>创建 mainProcessNodeIpcServer 主 IPC 服务器，如果此步骤出错，则表明已经有其它 VSCode 实例在运行了，立即结束当前进程。</li><li>通过 lifecycleMainService.onWillShutdown 方法监听应用退出事件用于关闭服务和清理数据。</li><li>开始创建 CodeApplication 服务并调用 startup() 初始化。</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CodeMain</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="title function_">main</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">startup</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">error</span>(error.<span class="property">message</span>);</span><br><span class="line">   app.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">startup</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the error handler early enough so that we are not getting the</span></span><br><span class="line">  <span class="comment">// default electron error dialog popping up</span></span><br><span class="line">  <span class="title function_">setUnexpectedErrorHandler</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create services</span></span><br><span class="line">  <span class="keyword">const</span> [instantiationService, instanceEnvironment, environmentMainService, configurationService, stateMainService, bufferLogService, productService, userDataProfilesMainService] = <span class="variable language_">this</span>.<span class="title function_">createServices</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">// Init services</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initServices</span>(environmentMainService, userDataProfilesMainService, configurationService, stateMainService, productService);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Startup</span></span><br><span class="line">    <span class="keyword">await</span> instantiationService.<span class="title function_">invokeFunction</span>(<span class="keyword">async</span> accessor =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> logService = accessor.<span class="title function_">get</span>(<span class="title class_">ILogService</span>);</span><br><span class="line">    <span class="keyword">const</span> lifecycleMainService = accessor.<span class="title function_">get</span>(<span class="title class_">ILifecycleMainService</span>);</span><br><span class="line">    <span class="keyword">const</span> fileService = accessor.<span class="title function_">get</span>(<span class="title class_">IFileService</span>);</span><br><span class="line">    <span class="keyword">const</span> loggerService = accessor.<span class="title function_">get</span>(<span class="title class_">ILoggerService</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mainProcessNodeIpcServer = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">claimInstance</span>(logService, environmentMainService, lifecycleMainService, instantiationService, productService, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write a lockfile to indicate an instance is running</span></span><br><span class="line">    <span class="title class_">FSPromises</span>.<span class="title function_">writeFile</span>(environmentMainService.<span class="property">mainLockfile</span>, <span class="title class_">String</span>(process.<span class="property">pid</span>)).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">     logService.<span class="title function_">warn</span>(<span class="string">`app#startup(): Error writing main lockfile: <span class="subst">$&#123;err.stack&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lifecycle</span></span><br><span class="line">    <span class="title function_">once</span>(lifecycleMainService.<span class="property">onWillShutdown</span>)(<span class="function"><span class="params">evt</span> =&gt;</span> &#123;</span><br><span class="line">     fileService.<span class="title function_">dispose</span>();</span><br><span class="line">     configurationService.<span class="title function_">dispose</span>();</span><br><span class="line">     evt.<span class="title function_">join</span>(<span class="string">&#x27;instanceLockfile&#x27;</span>, <span class="title class_">FSPromises</span>.<span class="title function_">unlink</span>(environmentMainService.<span class="property">mainLockfile</span>).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">/* ignored */</span> &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = instantiationService.<span class="title function_">createInstance</span>(<span class="title class_">CodeApplication</span>, mainProcessNodeIpcServer, instanceEnvironment);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance.<span class="title function_">startup</span>();</span><br><span class="line">   &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">   instantiationService.<span class="title function_">invokeFunction</span>(<span class="variable language_">this</span>.<span class="property">quit</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">createServices</span>(): [<span class="title class_">IInstantiationService</span>, <span class="title class_">IProcessEnvironment</span>, <span class="title class_">IEnvironmentMainService</span>, <span class="title class_">ConfigurationService</span>, <span class="title class_">StateService</span>, <span class="title class_">BufferLogger</span>, <span class="title class_">IProductService</span>, <span class="title class_">UserDataProfilesMainService</span>] &#123;</span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">new</span> <span class="title class_">ServiceCollection</span>();</span><br><span class="line">  <span class="keyword">const</span> disposables = <span class="keyword">new</span> <span class="title class_">DisposableStore</span>();</span><br><span class="line">  process.<span class="title function_">once</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">() =&gt;</span> disposables.<span class="title function_">dispose</span>());</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Files</span></span><br><span class="line">  <span class="keyword">const</span> fileService = <span class="keyword">new</span> <span class="title class_">FileService</span>(logService);</span><br><span class="line">  services.<span class="title function_">set</span>(<span class="title class_">IFileService</span>, fileService);</span><br><span class="line">  <span class="keyword">const</span> diskFileSystemProvider = <span class="keyword">new</span> <span class="title class_">DiskFileSystemProvider</span>(logService);</span><br><span class="line">  fileService.<span class="title function_">registerProvider</span>(<span class="title class_">Schemas</span>.<span class="property">file</span>, diskFileSystemProvider);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FileUserDataProvider for atomic read / write operations.</span></span><br><span class="line">  fileService.<span class="title function_">registerProvider</span>(<span class="title class_">Schemas</span>.<span class="property">vscodeUserData</span>, <span class="keyword">new</span> <span class="title class_">FileUserDataProvider</span>(<span class="title class_">Schemas</span>.<span class="property">file</span>, diskFileSystemProvider, <span class="title class_">Schemas</span>.<span class="property">vscodeUserData</span>, logService));</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  services.<span class="title function_">set</span>(<span class="title class_">ILifecycleMainService</span>, <span class="keyword">new</span> <span class="title class_">SyncDescriptor</span>(<span class="title class_">LifecycleMainService</span>, <span class="literal">undefined</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">new</span> <span class="title class_">InstantiationService</span>(services, <span class="literal">true</span>), instanceEnvironment, environmentMainService, configurationService, stateService, bufferLogger, productService, userDataProfilesMainService];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initServices</span>(<span class="attr">environmentMainService</span>: <span class="title class_">IEnvironmentMainService</span>, <span class="attr">userDataProfilesMainService</span>: <span class="title class_">UserDataProfilesMainService</span>, <span class="attr">configurationService</span>: <span class="title class_">ConfigurationService</span>, <span class="attr">stateService</span>: <span class="title class_">StateService</span>, <span class="attr">productService</span>: <span class="title class_">IProductService</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promises</span>.<span class="property">settled</span>&lt;<span class="built_in">unknown</span>&gt;([</span><br><span class="line">   <span class="comment">// Environment service (paths)</span></span><br><span class="line">   <span class="title class_">Promise</span>.<span class="property">all</span>&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;([</span><br><span class="line">    environmentMainService.<span class="property">extensionsPath</span>,</span><br><span class="line">    ...</span><br><span class="line">   ].<span class="title function_">map</span>(<span class="function"><span class="params">path</span> =&gt;</span> path ? <span class="title class_">FSPromises</span>.<span class="title function_">mkdir</span>(path, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;) : <span class="literal">undefined</span>)),</span><br><span class="line"></span><br><span class="line">   <span class="comment">// State service</span></span><br><span class="line">   stateService.<span class="title function_">init</span>(),</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Configuration service</span></span><br><span class="line">   configurationService.<span class="title function_">initialize</span>()</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize user data profiles after initializing the state</span></span><br><span class="line">  userDataProfilesMainService.<span class="title function_">init</span>();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">claimInstance</span>(<span class="attr">logService</span>: <span class="title class_">ILogService</span>, <span class="attr">environmentMainService</span>: <span class="title class_">IEnvironmentMainService</span>, <span class="attr">lifecycleMainService</span>: <span class="title class_">ILifecycleMainService</span>, <span class="attr">instantiationService</span>: <span class="title class_">IInstantiationService</span>, <span class="attr">productService</span>: <span class="title class_">IProductService</span>, <span class="attr">retry</span>: <span class="built_in">boolean</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">NodeIPCServer</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to setup a server for running. If that succeeds it means</span></span><br><span class="line">  <span class="comment">// we are the first instance to startup. Otherwise it is likely</span></span><br><span class="line">  <span class="comment">// that another instance is already running.</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">mainProcessNodeIpcServer</span>: <span class="title class_">NodeIPCServer</span>;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mainProcessNodeIpcServer;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">quit</span>(<span class="attr">accessor</span>: <span class="title class_">ServicesAccessor</span>, reason?: <span class="title class_">ExpectedError</span> | <span class="title class_">Error</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> logService = accessor.<span class="title function_">get</span>(<span class="title class_">ILogService</span>);</span><br><span class="line">  <span class="keyword">const</span> lifecycleMainService = accessor.<span class="title function_">get</span>(<span class="title class_">ILifecycleMainService</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reason) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  lifecycleMainService.<span class="title function_">kill</span>(exitCode);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Main Startup</span></span><br><span class="line"><span class="keyword">const</span> code = <span class="keyword">new</span> <span class="title class_">CodeMain</span>();</span><br><span class="line">code.<span class="title function_">main</span>();</span><br></pre></td></tr></table></figure><h3 id="6-2-CodeApplication">6.2 CodeApplication</h3><blockquote><p>src/vs/code/electron-main/app.ts</p></blockquote><p>CodeApplication 也只会被初始化一次，其主要职责是：</p><ul><li>配置 Electron Session 会话：<ul><li>使用 session.setPermissionRequestHandler/session.setPermissionCheckHandler 设置权限请求处理器。</li><li>使用 session.webRequest.onBeforeRequest 绑定请求拦截器，禁止非法访问。</li><li>使用 session.webRequest.onHeadersReceived 过滤非法 SVG 请求地址和 Content Type。</li><li>通过 session.setCodeCachePath 设置代码缓存路径并与 Chrome 缓存地址隔离。</li></ul></li><li>注册监听器 registerListeners：<ul><li>捕获进程 process 的 uncaughtException/unhandledRejection 事件，记录错误日志。</li><li>通过 lifecycleMainService.onWillShutdown 监听应用退出事件，用于关闭服务和清理数据。</li><li>使用 registerContextMenuListener 注册右键菜单事件监听器，通过异步事件异步菜单显示。</li><li>监听 MacOS <code>activate</code> 事件，用于激活应用。</li><li>监听 <code>web-contents-created</code> 事件拿到 webcontents，通过 contents.setWindowOpenHandler 来处理新窗口打开事件。</li><li>监听并拦截 <code>open-file</code> 事件，使用 windowsMainService 内置服务来打开文件。</li><li>监听 <code>new-window-for-tab</code> 事件，使用 windowsMainService 内置服务来打开新窗口。</li><li>通过主进程 IPC 通信监听各种 <code>vscode:xxx</code> 内部事件，比如：<code>vscode:reloadWindow</code>。</li></ul></li><li>调用 startup() 方法启动应用：<ul><li>创建 <code>ElectronIPCServer</code> 服务，并通过 lifecycleMainService.onWillShutdown 监听关闭事件。</li><li>创建 sharedProcess 共享进程服务。</li><li>初始化通道 initChannels（对通道还不太了解）。</li><li>初始化内部服务，比如：更新服务 IUpdateService、窗口服务 IWindowsMainService、对话框服务 IDialogMainService、键盘布局服务 IKeyboardLayoutMainService、菜单栏服务 IMenubarMainService、存储服务 IStorageMainService… 值得注意的是大部分服务都是延迟创建的，可以降低瞬时CPU和内存占用。</li><li>上一步中的所有服务集合将被当前 mainInstantiationService 的子服务实例 InstantiationService 管理。</li></ul></li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The main VS Code application. There will only ever be one instance,</span></span><br><span class="line"><span class="comment"> * even if the user starts many instances (e.g. from the command line).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CodeApplication</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Disposable</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="attr">windowsMainService</span>: <span class="title class_">IWindowsMainService</span> | <span class="literal">undefined</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="attr">nativeHostMainService</span>: <span class="title class_">INativeHostMainService</span> | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"> <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">private</span> <span class="keyword">readonly</span> mainProcessNodeIpcServer: NodeIPCServer,</span></span><br><span class="line"><span class="params">  <span class="keyword">private</span> <span class="keyword">readonly</span> userEnv: IProcessEnvironment,</span></span><br><span class="line"><span class="params">  <span class="meta">@IInstantiationService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> mainInstantiationService: IInstantiationService,</span></span><br><span class="line"><span class="params">  <span class="meta">@ILogService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> logService: ILogService,</span></span><br><span class="line"><span class="params">  <span class="meta">@ILoggerService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> loggerService: ILoggerService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IEnvironmentMainService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> environmentMainService: IEnvironmentMainService,</span></span><br><span class="line"><span class="params">  <span class="meta">@ILifecycleMainService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> lifecycleMainService: ILifecycleMainService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IConfigurationService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> configurationService: IConfigurationService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IStateService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> stateService: IStateService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IFileService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> fileService: IFileService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IProductService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> productService: IProductService,</span></span><br><span class="line"><span class="params">  <span class="meta">@IUserDataProfilesMainService</span> <span class="keyword">private</span> <span class="keyword">readonly</span> userDataProfilesMainService: IUserDataProfilesMainService,</span></span><br><span class="line"><span class="params"> </span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">configureSession</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">registerListeners</span>();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">configureSession</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isUrlFromWebview</span> = (<span class="params">requestingUrl: <span class="built_in">string</span> | <span class="literal">undefined</span></span>) =&gt; requestingUrl?.<span class="title function_">startsWith</span>(<span class="string">`<span class="subst">$&#123;Schemas.vscodeWebview&#125;</span>://`</span>);</span><br><span class="line">  <span class="keyword">const</span> allowedPermissionsInWebview = <span class="keyword">new</span> <span class="title class_">Set</span>([</span><br><span class="line">   <span class="string">&#x27;clipboard-read&#x27;</span>,</span><br><span class="line">   <span class="string">&#x27;clipboard-sanitized-write&#x27;</span>,</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  session.<span class="property">defaultSession</span>.<span class="title function_">setPermissionRequestHandler</span>(<span class="function">() =&gt;</span> &#123;...&#125;);</span><br><span class="line">  session.<span class="property">defaultSession</span>.<span class="title function_">setPermissionCheckHandler</span>(<span class="function">() =&gt;</span> &#123;...&#125;);</span><br><span class="line">  session.<span class="property">defaultSession</span>.<span class="property">webRequest</span>.<span class="title function_">onBeforeRequest</span>(<span class="function">(<span class="params">details, callback</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> uri = <span class="variable constant_">URI</span>.<span class="title function_">parse</span>(details.<span class="property">url</span>);</span><br><span class="line">   <span class="keyword">if</span> (uri.<span class="property">scheme</span> === <span class="title class_">Schemas</span>.<span class="property">vscodeWebview</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isAllowedWebviewRequest</span>(uri, details)) &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">logService</span>.<span class="title function_">error</span>(<span class="string">&#x27;Blocked vscode-webview request&#x27;</span>, details.<span class="property">url</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">callback</span>(&#123; <span class="attr">cancel</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="title function_">callback</span>(&#123; <span class="attr">cancel</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Configure SVG header content type properly</span></span><br><span class="line">  session.<span class="property">defaultSession</span>.<span class="property">webRequest</span>.<span class="title function_">onHeadersReceived</span>(<span class="function">(<span class="params">details, callback</span>) =&gt;</span> &#123;...&#125;);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//#region Code Cache</span></span><br><span class="line">  defaultSession.<span class="title function_">setCodeCachePath</span>(<span class="title function_">join</span>(<span class="variable language_">this</span>.<span class="property">environmentMainService</span>.<span class="property">codeCachePath</span>, <span class="string">&#x27;chrome&#x27;</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">registerListeners</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We handle uncaught exceptions here to prevent electron from opening a dialog to the user</span></span><br><span class="line">  process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function"><span class="params">error</span> =&gt;</span> &#123;...&#125;);</span><br><span class="line">  process.<span class="title function_">on</span>(<span class="string">&#x27;unhandledRejection&#x27;</span>, <span class="function">(<span class="params">reason: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="title function_">onUnexpectedError</span>(reason));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dispose on shutdown</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lifecycleMainService</span>.<span class="title function_">onWillShutdown</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">dispose</span>());</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// macOS dock activate</span></span><br><span class="line">  app.<span class="title function_">on</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="keyword">async</span> (event, hasVisibleWindows) =&gt; &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">logService</span>.<span class="title function_">trace</span>(<span class="string">&#x27;app#activate&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Mac only event: open new window when we get activated</span></span><br><span class="line">   <span class="keyword">if</span> (!hasVisibleWindows) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">windowsMainService</span>?.<span class="title function_">openEmptyWindow</span>(&#123; <span class="attr">context</span>: <span class="title class_">OpenContext</span>.<span class="property">DOCK</span> &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">on</span>(<span class="string">&#x27;web-contents-created&#x27;</span>, <span class="function">(<span class="params">event, contents</span>) =&gt;</span> &#123;...&#125;);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">on</span>(<span class="string">&#x27;new-window-for-tab&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">   <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">windowsMainService</span>?.<span class="title function_">openEmptyWindow</span>(&#123; <span class="attr">context</span>: <span class="title class_">OpenContext</span>.<span class="property">DESKTOP</span> &#125;); <span class="comment">//macOS native tab &quot;+&quot; button</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  validatedIpcMain.<span class="title function_">on</span>(<span class="string">&#x27;vscode:reloadWindow&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> event.<span class="property">sender</span>.<span class="title function_">reload</span>());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">async</span> <span class="title function_">startup</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Main process server (electron IPC based)</span></span><br><span class="line">  <span class="keyword">const</span> mainProcessElectronServer = <span class="keyword">new</span> <span class="title class_">ElectronIPCServer</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lifecycleMainService</span>.<span class="title function_">onWillShutdown</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (e.<span class="property">reason</span> === <span class="title class_">ShutdownReason</span>.<span class="property">KILL</span>) &#123;</span><br><span class="line">    mainProcessElectronServer.<span class="title function_">dispose</span>();</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shared process</span></span><br><span class="line">  <span class="keyword">const</span> &#123; sharedProcessReady, sharedProcessClient &#125; = <span class="variable language_">this</span>.<span class="title function_">setupSharedProcess</span>(machineId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Services</span></span><br><span class="line">  <span class="keyword">const</span> appInstantiationService = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initServices</span>(machineId, sharedProcessReady);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Init Channels</span></span><br><span class="line">  appInstantiationService.<span class="title function_">invokeFunction</span>(<span class="function"><span class="params">accessor</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">initChannels</span>(accessor, mainProcessElectronServer, sharedProcessClient));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Signal phase: ready - before opening first window</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lifecycleMainService</span>.<span class="property">phase</span> = <span class="title class_">LifecycleMainPhase</span>.<span class="property">Ready</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Open Windows</span></span><br><span class="line">  <span class="keyword">await</span> appInstantiationService.<span class="title function_">invokeFunction</span>(<span class="function"><span class="params">accessor</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">openFirstWindow</span>(accessor, initialProtocolUrls));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Signal phase: after window open</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lifecycleMainService</span>.<span class="property">phase</span> = <span class="title class_">LifecycleMainPhase</span>.<span class="property">AfterWindowOpen</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Post Open Windows Tasks</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">afterWindowOpen</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set lifecycle phase to `Eventually` after a short delay and when idle (min 2.5sec, max 5sec)</span></span><br><span class="line">  <span class="keyword">const</span> eventuallyPhaseScheduler = <span class="variable language_">this</span>.<span class="title function_">_register</span>(<span class="keyword">new</span> <span class="title class_">RunOnceScheduler</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">_register</span>(<span class="title function_">runWhenIdle</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">lifecycleMainService</span>.<span class="property">phase</span> = <span class="title class_">LifecycleMainPhase</span>.<span class="property">Eventually</span>, <span class="number">2500</span>));</span><br><span class="line">  &#125;, <span class="number">2500</span>));</span><br><span class="line">  eventuallyPhaseScheduler.<span class="title function_">schedule</span>();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">setupSharedProcess</span>(<span class="attr">machineId</span>: <span class="built_in">string</span>): &#123; <span class="attr">sharedProcessReady</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">MessagePortClient</span>&gt;; <span class="attr">sharedProcessClient</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">MessagePortClient</span>&gt; &#125; &#123;</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initServices</span>(<span class="attr">machineId</span>: <span class="built_in">string</span>, <span class="attr">sharedProcessReady</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">MessagePortClient</span>&gt;): <span class="title class_">Promise</span>&lt;<span class="title class_">IInstantiationService</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> services = <span class="keyword">new</span> <span class="title class_">ServiceCollection</span>();</span><br><span class="line">  <span class="comment">// Windows</span></span><br><span class="line"> services.<span class="title function_">set</span>(<span class="title class_">IWindowsMainService</span>, <span class="keyword">new</span> <span class="title class_">SyncDescriptor</span>(<span class="title class_">WindowsMainService</span>, [machineId, <span class="variable language_">this</span>.<span class="property">userEnv</span>], <span class="literal">false</span>));</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">mainInstantiationService</span>.<span class="title function_">createChild</span>(services);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">initChannels</span>(<span class="attr">accessor</span>: <span class="title class_">ServicesAccessor</span>, <span class="attr">mainProcessElectronServer</span>: <span class="title class_">ElectronIPCServer</span>, <span class="attr">sharedProcessClient</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">MessagePortClient</span>&gt;): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> launchChannel = <span class="title class_">ProxyChannel</span>.<span class="title function_">fromService</span>(accessor.<span class="title function_">get</span>(<span class="title class_">ILaunchMainService</span>), &#123; <span class="attr">disableMarshalling</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mainProcessNodeIpcServer</span>.<span class="title function_">registerChannel</span>(<span class="string">&#x27;launch&#x27;</span>, launchChannel);</span><br><span class="line">    ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">openFirstWindow</span>(<span class="attr">accessor</span>: <span class="title class_">ServicesAccessor</span>, <span class="attr">initialProtocolUrls</span>: <span class="title class_">IInitialProtocolUrls</span> | <span class="literal">undefined</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ICodeWindow</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> windowsMainService = <span class="variable language_">this</span>.<span class="property">windowsMainService</span> = accessor.<span class="title function_">get</span>(<span class="title class_">IWindowsMainService</span>);</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">// default: read paths from cli</span></span><br><span class="line">  <span class="keyword">return</span> windowsMainService.<span class="title function_">open</span>(&#123;</span><br><span class="line">   context,</span><br><span class="line">   <span class="attr">cli</span>: args,</span><br><span class="line">   <span class="attr">forceNewWindow</span>: args[<span class="string">&#x27;new-window&#x27;</span>] || (!hasCliArgs &amp;&amp; args[<span class="string">&#x27;unity-launch&#x27;</span>]),</span><br><span class="line">   <span class="attr">diffMode</span>: args.<span class="property">diff</span>,</span><br><span class="line">   <span class="attr">mergeMode</span>: args.<span class="property">merge</span>,</span><br><span class="line">   noRecentEntry,</span><br><span class="line">   waitMarkerFileURI,</span><br><span class="line">   <span class="attr">gotoLineMode</span>: args.<span class="property">goto</span>,</span><br><span class="line">   <span class="attr">initialStartup</span>: <span class="literal">true</span>,</span><br><span class="line">   remoteAuthority,</span><br><span class="line">   forceProfile,</span><br><span class="line">   forceTempProfile</span><br><span class="line">  &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">afterWindowOpen</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// Windows: mutex</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">installMutex</span>();</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span class="meta" id="headerViewCountWrapper"><span id="<Your/Path/Name>" class="leancloud_visitors" data-flag-title="Your Article Title"><em class="post-meta-item-text">⇸⇸ 阅读量：</em> <i class="leancloud-visitors-count">[ loading ]</i>⇷⇷</span></span><script>document.querySelector("#headerViewCountWrapper > .leancloud_visitors").id=decodeURIComponent(window.location.pathname)</script><hr style="margin-top:5px"><ul class="pager"><li class="next"><a href="/2023/05/23/de34e8cc.html/" data-toggle="tooltip" data-placement="top" title="使用 Jest 进行单元测试">Next Post &rarr;</a></li></ul><style type="text/css">.aplayer-container{text-align:center}.lds-roller-loading{display:inline-block;position:relative;width:80px;height:80px}.lds-roller-loading div{animation:lds-roller 1.2s cubic-bezier(.5,0,.5,1) infinite;transform-origin:40px 40px}.lds-roller-loading div:after{content:" ";display:block;position:absolute;width:7px;height:7px;border-radius:50%;background:#ff59ac;margin:-4px 0 0 -4px}.lds-roller-loading div:nth-child(1){animation-delay:-36ms}.lds-roller-loading div:nth-child(1):after{top:63px;left:63px}.lds-roller-loading div:nth-child(2){animation-delay:-72ms}.lds-roller-loading div:nth-child(2):after{top:68px;left:56px}.lds-roller-loading div:nth-child(3){animation-delay:-108ms}.lds-roller-loading div:nth-child(3):after{top:71px;left:48px}.lds-roller-loading div:nth-child(4){animation-delay:-144ms}.lds-roller-loading div:nth-child(4):after{top:72px;left:40px}.lds-roller-loading div:nth-child(5){animation-delay:-.18s}.lds-roller-loading div:nth-child(5):after{top:71px;left:32px}.lds-roller-loading div:nth-child(6){animation-delay:-216ms}.lds-roller-loading div:nth-child(6):after{top:68px;left:24px}.lds-roller-loading div:nth-child(7){animation-delay:-252ms}.lds-roller-loading div:nth-child(7):after{top:63px;left:17px}.lds-roller-loading div:nth-child(8){animation-delay:-288ms}.lds-roller-loading div:nth-child(8):after{top:56px;left:12px}@keyframes lds-roller{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.aplayer .aplayer-pic .aplayer-pause svg{top:0;left:0}.aplayer .aplayer-pic .aplayer-play svg{top:0;left:2px}</style><div class="aplayer-container"><div id="aplayer" class="lds-roller-loading" lazy-css-href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css" lazy-js-src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><script>(function(){var e,t=document.querySelector("#aplayer"),s=function(s,i){var r=[];s&&r.push(s),i&&r.push(i),r.forEach((function(s){async(s,(function(){/^.*.js$/.test(s)&&function(){e&&e.disconnect(),t.className="",t.innerHTML="";new APlayer({container:document.getElementById("aplayer"),theme:"#e9e9e9",audio:[{name:"存在信号",artist:"AcuticNotes",url:"http://nojsja.gitee.io/static-resources/audio/life-signal.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/life-signal.jpg"},{name:"遺サレタ場所／斜光",artist:"岡部啓一",url:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.mp3",cover:"http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.jpg"}]})}()}),/^.*.css$/.test(s)?"link":"script")}))};if(window.IntersectionObserver)(e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var i=t.target.getAttribute("lazy-css-href"),r=t.target.getAttribute("lazy-js-src");s(i,r)}}))}))).observe(t);else{var i=t.getAttribute("lazy-css-href"),r=t.getAttribute("lazy-js-src");s(i,r)}}).bind(window)()</script><hr><div id="vcomments"></div><script>(function(){function e(){async("/js/Valine.min.js",(function(){new Valine({el:"#vcomments",appId:"wUKKBx8BRzGaNfhgdg2UKtub-MdYXbMMI",appKey:"MAwYM4KlW5YJ3q06qwnUScBr",visitor:!0})}))}if(window.IntersectionObserver){var n=new IntersectionObserver((function(i){i.forEach((function(i){i.isIntersecting&&(n.unobserve(i.target),n.disconnect(),e())}))}));n.observe(document.querySelector("#headerViewCountWrapper"))}else e()}).bind(window)()</script></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">VSCode 架构学习笔记</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%80%E3%80%81%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">一、源码目录结构</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-1-%E6%80%BB%E8%A7%88"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">1.1 总览</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#1-2-%E7%9B%AE%E5%BD%95%E8%A7%A3%E6%9E%90"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">1.2 目录解析</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%8C%E3%80%81Electron-%E8%BF%9B%E7%A8%8B"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">二、Electron 进程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">2.1 进程间通讯</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-2-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">2.2 远程调用</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%89%E3%80%81VSCode%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">三、VSCode多进程架构</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%9B%9B%E3%80%81Service-%E6%9C%8D%E5%8A%A1"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">四、Service 服务</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-1-Service-%E7%9A%84%E5%BA%95%E5%B1%82%E5%9F%BA%E7%B1%BB"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">4.1 Service 的底层基类</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-2-Service-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">4.2 Service 依赖注入</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-3-%E5%9F%BA%E6%9C%AC%E6%9C%8D%E5%8A%A1"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">4.3 基本服务</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-3-1-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1-IStorageMainService"><span class="toc-nav-number">1.4.3.1.</span> <span class="toc-nav-text">4.3.1 存储服务 - IStorageMainService</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-3-2-%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1-IConfigurationService"><span class="toc-nav-number">1.4.3.2.</span> <span class="toc-nav-text">4.3.2 配置服务 - IConfigurationService</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-3-3-%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1-IStateService"><span class="toc-nav-number">1.4.3.3.</span> <span class="toc-nav-text">4.3.3 状态服务 - IStateService</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-3-4-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%9C%8D%E5%8A%A1-ILifecycleMainService"><span class="toc-nav-number">1.4.3.4.</span> <span class="toc-nav-text">4.3.4 生命周期服务 - ILifecycleMainService</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#4-4-%E7%AA%97%E5%8F%A3%E5%92%8C%E8%A7%86%E5%9B%BE-Webview-%E7%AE%A1%E7%90%86"><span class="toc-nav-number">1.4.4.</span> <span class="toc-nav-text">4.4 窗口和视图(Webview)管理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-4-1-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AA%97%E5%8F%A3-ICodeWindow"><span class="toc-nav-number">1.4.4.1.</span> <span class="toc-nav-text">4.4.1 浏览器窗口 - ICodeWindow</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-4-2-%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1-IWindowsMainService"><span class="toc-nav-number">1.4.4.2.</span> <span class="toc-nav-text">4.4.2 窗口管理服务 - IWindowsMainService</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-4-4-Webview-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1-IWebviewManagerService"><span class="toc-nav-number">1.4.4.3.</span> <span class="toc-nav-text">4.4.4 Webview 管理服务 - IWebviewManagerService</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%94%E3%80%81%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">五、服务实例化过程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#5-2-1-ServiceCollection-%E6%9C%8D%E5%8A%A1%E9%9B%86%E5%90%88"><span class="toc-nav-number">1.5.0.1.</span> <span class="toc-nav-text">5.2.1 ServiceCollection 服务集合</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#5-2-2-Graph-%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96%E5%9B%BE%E8%B0%B1"><span class="toc-nav-number">1.5.0.2.</span> <span class="toc-nav-text">5.2.2 Graph 服务依赖图谱</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#5-2-3-%E5%88%9B%E5%BB%BA%E4%BE%9D%E8%B5%96%E6%9C%8D%E5%8A%A1"><span class="toc-nav-number">1.5.0.3.</span> <span class="toc-nav-text">5.2.3 创建依赖服务</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#5-2-4-%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B"><span class="toc-nav-number">1.5.0.4.</span> <span class="toc-nav-text">5.2.4 创建服务实例</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%AD%E3%80%81VSCode-%E5%BA%94%E7%94%A8%E5%85%A5%E5%8F%A3"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">六、VSCode 应用入口</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-1-CodeMain"><span class="toc-nav-number">1.6.1.</span> <span class="toc-nav-text">6.1 CodeMain</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#6-2-CodeApplication"><span class="toc-nav-number">1.6.2.</span> <span class="toc-nav-text">6.2 CodeApplication</span></a></li></ol></li></ol></div></aside></div></div></article><script>async("https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js",(function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")}))</script><script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="/js/anchor.nojsja.js"></script><style>#websiteModal .modal-body{display:flex;align-items:center;justify-content:center;margin:auto;text-align:center;width:100%;height:100%}#websiteModal .modal-body img{max-width:100%;height:auto}</style><script>$(document).ready((function(){$(document).on("click","img",(function(o){if($(this).hasClass("click-disable"))o&&o.stopPropagation();else{o&&o.stopPropagation();var a=$(this).clone();$("#websiteModal").modal("show"),a.addClass("click-disable"),$("#websiteModal .modal-body").html(a)}})).on("click",".modal-body",(function(){$("#websiteModal").modal("hide")}))}))</script><div class="modal fade" id="websiteModal" tabindex="-1" role="dialog" aria-labelledby="websiteModalTitle" aria-hidden="true"><div class="modal-body"></div></div><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/nojsja"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; nojsja 2023</p></div></div></div></footer><script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.usebootstrap.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/widgets.js"></script><script>async("https://nojsja.gitee.io/static-resources/libs/fastclick/1.0.6/fastclick.min.js",(function(){var t=document.querySelector("nav");t&&FastClick.attach(t)}))</script><script type="text/javascript">var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;searchFunc(path,"local-search-input","local-search-result")</script><script src="/js/busuanzi.pure.mini.js" defer async></script><a id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js" async></script><script>(function(){function t(t){return document.querySelectorAll(t)}if(window.hexoLoadingImages=window.hexoLoadingImages||{},window.IntersectionObserver){var e=new IntersectionObserver((function(t){t.forEach((function(t){if(t.isIntersecting){e.unobserve(t.target);var n=new Image,o="_img_"+Math.random();window.hexoLoadingImages[o]=n,n.onload=function(){t.target.src=t.target.getAttribute("data-src"),window.hexoLoadingImages[o]=null},n.onerror=function(){window.hexoLoadingImages[o]=null},t.target.src=t.target.getAttribute("data-loading"),n.src=t.target.getAttribute("data-src")}}))}));t("img[lazyload]").forEach((function(t){e.observe(t)}))}else t("img[lazyload]").forEach((function(t){t.src=t.getAttribute("data-src")}))}).bind(window)()</script></body></html>